# ğŸš€ Production Deployment Agent
#
# Deploys all workers to Cloudflare production environment with safety checks.
# Requires manual approval before deployment.
#
# ARCHITECTURE: This monorepo contains TWO separate systems:
#   - Legacy (AudienceHero): user-application + data-service
#   - Foundry MVP: foundry-dashboard + foundry-engine
#
# CRITICAL: These systems use SEPARATE Cloudflare resources (D1, R2, Vectorize)
#           and must NEVER share databases or other infrastructure.
#
# Database IDs:
#   Legacy Prod:  b2c606e3-d4b4-45b6-b0c1-d9fb77791750 (audience-hero-production)
#   Foundry Prod: bd287f3f-8147-49b5-9cae-466c60a975c6 (foundry-global)

name: ğŸš€ Production Deployment Agent

on:
  push:
    branches: ["main"]
  workflow_dispatch: # Manual trigger button in GitHub UI

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. THE GUARDIAN: Resource Isolation Check
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  resource-isolation-check:
    name: ğŸ›¡ï¸ Resource Isolation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ” Check Legacy configs don't use Foundry resources
        run: |
          echo "Checking Legacy wrangler configs for Foundry resource contamination..."

          FOUNDRY_PATTERNS="foundry-global|foundry-media|foundry-embeddings|e35604ee|bd287f3f"

          if grep -E "$FOUNDRY_PATTERNS" apps/user-application/wrangler.jsonc; then
            echo "âŒ FATAL: user-application contains Foundry resources!"
            exit 1
          fi

          if grep -E "$FOUNDRY_PATTERNS" apps/data-service/wrangler.jsonc; then
            echo "âŒ FATAL: data-service contains Foundry resources!"
            exit 1
          fi

          echo "âœ… Legacy configs are clean"

      - name: ğŸ” Check Foundry configs don't use Legacy resources
        run: |
          echo "Checking Foundry wrangler configs for Legacy resource contamination..."

          LEGACY_PATTERNS="audience-hero|smart-eval-bucket|saas-knowledge-index|075a005c|b2c606e3"

          if grep -E "$LEGACY_PATTERNS" apps/foundry-dashboard/wrangler.jsonc; then
            echo "âŒ FATAL: foundry-dashboard contains Legacy resources!"
            exit 1
          fi

          if grep -E "$LEGACY_PATTERNS" apps/foundry-engine/wrangler.jsonc; then
            echo "âŒ FATAL: foundry-engine contains Legacy resources!"
            exit 1
          fi

          echo "âœ… Foundry configs are clean"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. THE AUDITOR: Code Quality Gate
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  quality-gate:
    name: ğŸ›¡ï¸ Quality Gate
    needs: resource-isolation-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ—ï¸ Build shared packages
        run: pnpm run build-package

      - name: ğŸ›¡ï¸ Type Check (Foundry - excludes test files)
        run: pnpm run foundry:typecheck:build

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. THE LEGACY DEPLOYER (hero.williamjshaw.ca)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deploy-legacy-frontend:
    name: ğŸš€ Legacy Frontend (user-application)
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install
      - run: pnpm run build-package
      - name: ğŸš€ Deploy to Cloudflare
        run: pnpm --filter user-application run production:deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  deploy-legacy-backend:
    name: ğŸš€ Legacy Backend (data-service)
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install
      - run: pnpm run build-package
      - name: ğŸš€ Deploy to Cloudflare
        run: pnpm --filter data-service run production:deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. THE FOUNDRY DEPLOYER (foundry.williamjshaw.ca)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deploy-foundry-frontend:
    name: ğŸš€ Foundry Frontend (dashboard)
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install
      - name: ğŸš€ Deploy to Cloudflare
        run: pnpm --filter foundry-dashboard run production:deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  deploy-foundry-backend:
    name: ğŸš€ Foundry Backend (engine)
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install
      - name: ğŸš€ Deploy to Cloudflare
        run: pnpm --filter foundry-engine run deploy:production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5. THE VERIFIER: Post-Deployment Health Check
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  verify-deployments:
    name: âœ… Verify Deployments
    needs:
      - deploy-legacy-frontend
      - deploy-legacy-backend
      - deploy-foundry-frontend
      - deploy-foundry-backend
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ¥ Health Check - Legacy
        run: |
          curl -sf https://hero.williamjshaw.ca > /dev/null && echo "âœ… hero.williamjshaw.ca is up" || echo "âš ï¸ hero.williamjshaw.ca may be starting"

      - name: ğŸ¥ Health Check - Foundry
        run: |
          curl -sf https://foundry.williamjshaw.ca > /dev/null && echo "âœ… foundry.williamjshaw.ca is up" || echo "âš ï¸ foundry.williamjshaw.ca may be starting"

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸš€ PRODUCTION DEPLOYMENT COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  Legacy System:"
          echo "    â€¢ Frontend: https://hero.williamjshaw.ca"
          echo "    â€¢ Backend:  data-service-production"
          echo "    â€¢ Database: audience-hero-production (b2c606e3)"
          echo ""
          echo "  Foundry MVP:"
          echo "    â€¢ Frontend: https://foundry.williamjshaw.ca"
          echo "    â€¢ Backend:  foundry-engine-production"
          echo "    â€¢ Database: foundry-global (bd287f3f)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
