WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.066 --> 00:00:00.386
All right,

00:00:00.386 --> 00:00:02.266
welcome to the full stack on cloudflare course.

00:00:02.266 --> 00:00:04.506
My name is Matthew Sessions and before we dive too

00:00:04.506 --> 00:00:05.266
deep into the content,

00:00:05.506 --> 00:00:07.346
I want to share a little bit about my background

00:00:07.346 --> 00:00:09.186
and why I created this course in the first place.

00:00:09.506 --> 00:00:11.946
So for the past six years I have been a

00:00:11.946 --> 00:00:13.266
professional software engineer.

00:00:13.496 --> 00:00:15.446
and I started my career focusing really,

00:00:15.446 --> 00:00:16.886
really deep on the back end side of things.

00:00:16.886 --> 00:00:18.646
I built out big data solutions,

00:00:18.646 --> 00:00:19.726
ETL jobs,

00:00:19.726 --> 00:00:21.446
built real time streaming applications

00:00:21.766 --> 00:00:24.326
and I did a lot of API like level work.

00:00:24.326 --> 00:00:24.726
Now,

00:00:24.966 --> 00:00:26.926
towards the end of my time at a big tech company,

00:00:26.926 --> 00:00:29.526
I started to dive deeper into the user facing

00:00:29.526 --> 00:00:29.806
stuff.

00:00:29.806 --> 00:00:32.006
So I started building GraphQL APIs that would

00:00:32.006 --> 00:00:34.486
interface with data that was spit out by our

00:00:34.486 --> 00:00:35.286
backend services.

00:00:35.526 --> 00:00:36.566
And then I started building

00:00:36.636 --> 00:00:38.316
react applications that were basically,

00:00:38.316 --> 00:00:38.596
you know,

00:00:38.596 --> 00:00:41.716
the interface to the entire data ecosystem that we

00:00:41.716 --> 00:00:42.996
built out and it was user facing,

00:00:42.996 --> 00:00:44.436
so users were using these applications.

00:00:44.436 --> 00:00:46.636
So I kind of worked not from the front end to the

00:00:46.636 --> 00:00:46.796
back,

00:00:46.796 --> 00:00:47.876
I worked from the back end to the front.

00:00:47.876 --> 00:00:48.716
And because of that,

00:00:48.896 --> 00:00:51.136
when I look at software and when I look at like

00:00:51.136 --> 00:00:52.136
building different solutions,

00:00:52.136 --> 00:00:54.816
I think of it from a data perspective and in a

00:00:54.816 --> 00:00:57.016
system perspective and then I map that to an

00:00:57.016 --> 00:00:57.296
experience

00:00:58.178 --> 00:00:59.098
and you know,

00:00:59.098 --> 00:01:01.018
I feel like I've gotten pretty good at building

00:01:01.018 --> 00:01:01.298
things,

00:01:01.298 --> 00:01:02.058
building things quickly,

00:01:02.058 --> 00:01:03.658
but also building things in a way where they're

00:01:03.658 --> 00:01:04.498
like maintainable,

00:01:04.498 --> 00:01:05.898
scalable from you know,

00:01:05.898 --> 00:01:07.098
a usage based perspective,

00:01:07.098 --> 00:01:09.058
but also from a maintainability perspective.

00:01:09.378 --> 00:01:09.938
and then,

00:01:10.178 --> 00:01:10.738
you know,

00:01:10.818 --> 00:01:13.738
after like five years of working at an enterprise

00:01:13.738 --> 00:01:13.898
level,

00:01:13.898 --> 00:01:15.618
I decided I was going to quit my job and I'm going

00:01:15.618 --> 00:01:17.098
to go like full in on doing,

00:01:17.098 --> 00:01:17.498
you know,

00:01:17.498 --> 00:01:18.098
contract work,

00:01:18.098 --> 00:01:19.618
consulting work and then you know,

00:01:19.618 --> 00:01:21.058
making a little bit of content here and there.

00:01:21.058 --> 00:01:22.658
So I started back Pine Labs,

00:01:22.678 --> 00:01:25.038
I started picking up different like contracts for

00:01:25.038 --> 00:01:26.638
midsize companies that are trying to build out

00:01:26.638 --> 00:01:27.478
software solutions.

00:01:27.494 --> 00:01:29.484
But I'm also a normal developer and you know,

00:01:29.484 --> 00:01:30.764
a normal typical developer,

00:01:30.764 --> 00:01:32.284
especially somebody that's working in the web

00:01:32.284 --> 00:01:32.564
space.

00:01:32.724 --> 00:01:34.484
You have a bunch of side projects and you want to

00:01:34.484 --> 00:01:36.004
build a whole bunch of stuff and you want to be

00:01:36.004 --> 00:01:37.444
able to host it and you want to host it cheap and

00:01:37.444 --> 00:01:38.644
you want to showcase what you're doing.

00:01:38.644 --> 00:01:39.004
You know,

00:01:39.004 --> 00:01:40.484
you want to like prove out different concepts.

00:01:40.484 --> 00:01:40.884
So like,

00:01:41.044 --> 00:01:42.404
I'm always doing like two things at once.

00:01:42.404 --> 00:01:44.084
I'm building out these things that I really enjoy

00:01:44.084 --> 00:01:44.644
working on,

00:01:44.724 --> 00:01:45.224
for myself.

00:01:45.224 --> 00:01:47.624
And then I'm also picking up contract jobs and

00:01:47.624 --> 00:01:49.104
building a business on top of like,

00:01:49.104 --> 00:01:49.344
you know,

00:01:49.344 --> 00:01:50.744
building out solutions for companies.

00:01:51.564 --> 00:01:53.604
Now throughout like the process of Building my own

00:01:53.604 --> 00:01:54.844
stuff and also building for companies,

00:01:54.924 --> 00:01:56.284
companies that like are mid sized,

00:01:56.284 --> 00:01:56.644
you know,

00:01:56.644 --> 00:01:56.924
doing

00:01:57.244 --> 00:01:59.764
between 500,000 to a couple million dollars in

00:01:59.764 --> 00:02:00.604
revenue every year.

00:02:00.604 --> 00:02:01.524
Not like you know,

00:02:01.524 --> 00:02:03.164
massive billion billion dollar companies.

00:02:03.404 --> 00:02:05.644
I try to find tooling and

00:02:05.844 --> 00:02:08.124
like a deployment infrastructure that is really

00:02:08.124 --> 00:02:09.364
suitable for their needs.

00:02:09.624 --> 00:02:11.464
and that's ultimately how I discovered Cloudflare.

00:02:11.464 --> 00:02:13.504
I discovered cloudflare because like I1 was like

00:02:13.504 --> 00:02:15.184
working on a bunch of stuff for like my indie

00:02:15.184 --> 00:02:17.904
projects and I wanted cheap hosting but then I

00:02:17.904 --> 00:02:19.624
also wanted something that was like really easy to

00:02:19.624 --> 00:02:20.204
work with for,

00:02:20.434 --> 00:02:20.994
for these

00:02:21.114 --> 00:02:23.014
companies so I could build stuff,

00:02:23.014 --> 00:02:23.814
train a team,

00:02:23.974 --> 00:02:25.174
pass it off to the team,

00:02:25.174 --> 00:02:25.534
you know,

00:02:25.534 --> 00:02:26.729
once like my work is done.

00:02:26.746 --> 00:02:28.346
And I've noticed there's a lot of like web

00:02:28.346 --> 00:02:28.746
developers,

00:02:28.746 --> 00:02:29.986
people that are like more front end,

00:02:29.986 --> 00:02:30.906
a little bit back end,

00:02:31.246 --> 00:02:31.886
focused

00:02:32.206 --> 00:02:34.526
where if you like are going to build a whole bunch

00:02:34.526 --> 00:02:35.086
of like

00:02:35.566 --> 00:02:35.966
services

00:02:36.366 --> 00:02:38.366
on top of different products on top of aws,

00:02:38.526 --> 00:02:39.086
it's really,

00:02:39.086 --> 00:02:40.286
really hard to transfer that knowledge.

00:02:40.286 --> 00:02:42.126
There's just like a really steep learning curve

00:02:42.126 --> 00:02:43.846
where if you're not doing it at an enterprise

00:02:43.846 --> 00:02:45.966
level you're probably not going to go deep enough

00:02:45.966 --> 00:02:48.526
into AWS for like hosting your projects and also

00:02:48.526 --> 00:02:50.206
for side projects it's really expensive.

00:02:50.916 --> 00:02:53.676
Now like the alternatives is to roll your own vpss

00:02:53.676 --> 00:02:55.036
and like you could always go that route but

00:02:55.036 --> 00:02:57.396
there's also a lot of complexity there or use

00:02:57.396 --> 00:03:00.081
managed hosting providers like Netlify or Vercel.

00:03:00.398 --> 00:03:02.038
Providers like Netlify and Vercel are really

00:03:02.038 --> 00:03:02.278
great.

00:03:02.278 --> 00:03:04.238
Honestly pricing in my opinion is fine.

00:03:04.318 --> 00:03:04.878
They're really,

00:03:04.878 --> 00:03:06.278
really easy to build on top of.

00:03:06.278 --> 00:03:07.918
But what I've noticed is

00:03:08.318 --> 00:03:10.118
most developers or like you know,

00:03:10.118 --> 00:03:11.198
people building indie product,

00:03:12.078 --> 00:03:13.998
they'll kind of like spin up a next JS app,

00:03:14.078 --> 00:03:15.198
they'll have a database,

00:03:15.478 --> 00:03:17.198
they'll do a bunch of crud operations and it's

00:03:17.198 --> 00:03:17.358
very,

00:03:17.358 --> 00:03:18.170
very simple in nature.

00:03:18.212 --> 00:03:20.292
Now the second the project grows and they're

00:03:20.292 --> 00:03:21.972
trying to like accommodate different like more use

00:03:21.972 --> 00:03:22.292
cases,

00:03:22.292 --> 00:03:23.732
especially in the world of AI,

00:03:23.892 --> 00:03:25.172
they're finding like oh this,

00:03:25.172 --> 00:03:26.932
this model of like ui,

00:03:27.012 --> 00:03:27.572
API,

00:03:27.572 --> 00:03:27.892
call,

00:03:28.292 --> 00:03:29.252
go to database,

00:03:29.252 --> 00:03:31.572
get data isn't like the only thing that they're

00:03:31.572 --> 00:03:31.772
doing.

00:03:31.772 --> 00:03:33.412
All of a sudden they're having to run like,

00:03:33.412 --> 00:03:35.492
they're having to manage long running tasks on the

00:03:35.492 --> 00:03:35.892
background,

00:03:36.292 --> 00:03:37.732
they're having to like do a whole bunch of

00:03:37.732 --> 00:03:39.092
different like really smart

00:03:39.542 --> 00:03:41.712
connected workflows where it's really task based.

00:03:41.889 --> 00:03:44.329
And for developers that build their projects on

00:03:44.329 --> 00:03:45.649
top of like these managed services,

00:03:45.729 --> 00:03:47.889
what happens is like oh well Vercel doesn't solve

00:03:47.889 --> 00:03:48.409
my need here.

00:03:48.409 --> 00:03:49.809
So here's another managed service.

00:03:49.809 --> 00:03:51.409
I'm going to go pay like $10 a month and I'm going

00:03:51.409 --> 00:03:52.289
to use this

00:03:52.429 --> 00:03:55.249
trigger.dev to manage my background tasks or you

00:03:55.249 --> 00:03:55.369
know,

00:03:55.369 --> 00:03:56.049
I'm going to go grab,

00:03:56.049 --> 00:03:57.529
I'm going to use up stash and I'm going to use

00:03:57.529 --> 00:03:59.569
their like really cheap Redis cluster because you

00:03:59.569 --> 00:03:59.689
know,

00:03:59.689 --> 00:04:01.169
I need a better caching solution that,

00:04:01.169 --> 00:04:03.449
that like Vercel isn't covering or Netlify isn't

00:04:03.449 --> 00:04:03.849
covering.

00:04:04.249 --> 00:04:05.169
And then you know,

00:04:05.169 --> 00:04:06.529
after like a year of working on it,

00:04:06.529 --> 00:04:08.089
all of a sudden the code base is just one,

00:04:08.089 --> 00:04:08.649
you know,

00:04:09.049 --> 00:04:11.529
one big Next JS app with a whole bunch of files

00:04:11.609 --> 00:04:13.849
that kind of ship a little bit of code to a whole

00:04:13.849 --> 00:04:15.969
bunch of different like dependent services and it

00:04:15.969 --> 00:04:17.929
becomes really hard to manage and also like it's

00:04:17.929 --> 00:04:18.569
really hard to

00:04:18.889 --> 00:04:20.809
scale it in terms of volume because a lot of these

00:04:20.809 --> 00:04:22.129
like managed providers,

00:04:22.129 --> 00:04:23.769
once you actually hit a critical number of users

00:04:23.769 --> 00:04:24.728
they become very expensive.

00:04:24.728 --> 00:04:25.489
But you know,

00:04:25.489 --> 00:04:26.289
also like you're,

00:04:26.289 --> 00:04:28.089
you're reaching for a lot of different solutions.

00:04:28.409 --> 00:04:30.929
And to me Cloudflare sits like right in the middle

00:04:30.929 --> 00:04:33.529
of AWS and Vercel where you

00:04:33.849 --> 00:04:36.049
have like a whole bunch of different products that

00:04:36.049 --> 00:04:37.769
you can develop on to solve different types of

00:04:37.769 --> 00:04:38.169
problems.

00:04:38.679 --> 00:04:38.919
But

00:04:39.299 --> 00:04:39.719
the development

00:04:40.039 --> 00:04:42.199
experience in my opinion is closer to

00:04:42.519 --> 00:04:42.919
like

00:04:43.009 --> 00:04:44.489
a Vercel where you know,

00:04:44.489 --> 00:04:46.649
it's not as easy to develop on as Vercel but there

00:04:46.649 --> 00:04:48.129
is still a lot of like ease of use.

00:04:48.449 --> 00:04:50.369
but you're just not overwhelmed by having

00:04:50.609 --> 00:04:52.569
thousands and thousands of different services like

00:04:52.569 --> 00:04:53.632
AWS to choose from.

00:04:53.632 --> 00:04:55.520
And then there's obviously like the pricing

00:04:55.520 --> 00:04:55.920
factor.

00:04:55.920 --> 00:04:57.240
So there's the ease of use and then there's a

00:04:57.240 --> 00:04:58.920
pricing and I feel like Cloudflare,

00:04:58.920 --> 00:05:01.360
if you look at like how much a request costs,

00:05:01.360 --> 00:05:03.560
how much they charge for like the duration of your

00:05:03.560 --> 00:05:04.000
request,

00:05:04.300 --> 00:05:05.180
if you do the math,

00:05:05.180 --> 00:05:05.660
it's really,

00:05:05.660 --> 00:05:05.940
really,

00:05:05.940 --> 00:05:08.220
really hard to beat the price of Cloudflare.

00:05:08.440 --> 00:05:09.020
Now none

00:05:09.100 --> 00:05:11.020
of the managed services can get close to the price

00:05:11.180 --> 00:05:13.820
and the only way you can like justify saying oh,

00:05:13.820 --> 00:05:16.300
AWS is cheaper is if like you have

00:05:16.620 --> 00:05:18.740
millions and millions and millions upon requests

00:05:18.740 --> 00:05:21.180
and you're handling them on just like solid

00:05:21.580 --> 00:05:23.880
EC2 instances that are deployed on top of

00:05:23.880 --> 00:05:26.550
on top of AWS and you're optimizing your use case

00:05:26.550 --> 00:05:27.390
for handling that

00:05:27.710 --> 00:05:29.070
for the vast majority of

00:05:29.730 --> 00:05:31.510
problems that like developers are solving from

00:05:31.510 --> 00:05:32.830
like the indie stuff

00:05:33.250 --> 00:05:34.930
all the way to like you know,

00:05:34.930 --> 00:05:36.050
past mid sized companies,

00:05:36.050 --> 00:05:37.930
like companies that are actually doing Serious

00:05:37.930 --> 00:05:38.370
scale,

00:05:38.450 --> 00:05:40.850
but not quite like these juggernauts of companies

00:05:40.850 --> 00:05:43.250
like Facebook and Amazon and whatnot.

00:05:44.770 --> 00:05:46.330
Cloudflare is a perfect solution.

00:05:46.330 --> 00:05:46.570
Like,

00:05:46.570 --> 00:05:47.530
I honestly think they're,

00:05:47.530 --> 00:05:48.610
they're probably,

00:05:48.610 --> 00:05:51.010
they should be a go to hosting provider for

00:05:51.730 --> 00:05:53.490
probably 80% of

00:05:53.580 --> 00:05:55.530
web services that are built or maybe even more

00:05:55.530 --> 00:05:57.970
because really like the tail end is are these

00:05:58.210 --> 00:06:00.010
large companies that are solving like data

00:06:00.010 --> 00:06:00.360
problems,

00:06:00.360 --> 00:06:02.070
you and I just really can't even like wrap our

00:06:02.070 --> 00:06:03.390
heads around unless we're really,

00:06:03.390 --> 00:06:03.630
really,

00:06:03.630 --> 00:06:04.270
really deep into.

00:06:05.770 --> 00:06:07.330
So that's kind of why I wanted to create this

00:06:07.330 --> 00:06:08.530
course is I think that,

00:06:08.530 --> 00:06:09.050
you know,

00:06:09.050 --> 00:06:10.250
people that are learning to develop,

00:06:10.410 --> 00:06:12.450
they can learn really good development principles

00:06:12.450 --> 00:06:13.690
by shipping code to

00:06:14.010 --> 00:06:15.810
Cloudflare because you have a lot of compute

00:06:15.810 --> 00:06:17.330
primitives you can build upon and we'll talk about

00:06:17.330 --> 00:06:18.040
them in just a minute.

00:06:18.659 --> 00:06:21.179
But also as projects grow and you know,

00:06:21.179 --> 00:06:22.899
they turn into businesses and they're actually

00:06:22.899 --> 00:06:23.779
making serious money,

00:06:23.859 --> 00:06:24.979
they can scale for a very,

00:06:24.979 --> 00:06:25.779
very long time,

00:06:25.779 --> 00:06:26.739
if not forever,

00:06:27.169 --> 00:06:28.529
to kind of meet those needs.

00:06:30.299 --> 00:06:32.859
Now probably the one downside of Cloudflare is,

00:06:33.069 --> 00:06:34.515
I don't necessarily agree with it,

00:06:34.515 --> 00:06:36.035
but a lot of people out there are like,

00:06:36.035 --> 00:06:36.235
oh,

00:06:36.235 --> 00:06:37.435
the documentation's too hard.

00:06:37.435 --> 00:06:38.715
There's not enough examples online.

00:06:38.795 --> 00:06:40.435
I don't really know how to like get started with

00:06:40.435 --> 00:06:40.555
it.

00:06:40.555 --> 00:06:42.075
And that's ultimately where this course came from.

00:06:42.155 --> 00:06:44.034
I personally feel like the documentation is pretty

00:06:44.034 --> 00:06:44.315
good.

00:06:44.635 --> 00:06:44.745
I

00:06:44.775 --> 00:06:46.495
can read through the documentation and I can

00:06:46.495 --> 00:06:48.615
understand like how to use a product and then ship

00:06:48.615 --> 00:06:48.895
very,

00:06:48.895 --> 00:06:50.935
very quickly just by skimming the documentation.

00:06:50.935 --> 00:06:53.775
But I do know if you aren't really deep in this

00:06:53.775 --> 00:06:54.015
space,

00:06:54.265 --> 00:06:55.015
and if you haven't like,

00:06:55.015 --> 00:06:56.415
you don't have a lot of like repetitions building

00:06:56.415 --> 00:06:57.215
on top of Cloudflare,

00:06:57.215 --> 00:06:57.695
it can be very,

00:06:57.695 --> 00:06:58.295
very daunting.

00:06:58.295 --> 00:06:58.655
So

00:06:59.085 --> 00:07:00.925
what this course is going to do is it's going to

00:07:00.925 --> 00:07:04.245
be geared towards like one showing how to build a

00:07:04.245 --> 00:07:05.005
SaaS product

00:07:05.405 --> 00:07:06.605
as a series of services,

00:07:06.685 --> 00:07:08.925
like layers of compute responsibilities.

00:07:09.565 --> 00:07:11.365
And it's going to show how to take these concepts

00:07:11.365 --> 00:07:12.925
and these services and these systems that we're

00:07:12.925 --> 00:07:13.635
building and

00:07:13.635 --> 00:07:14.405
we're going to,

00:07:14.405 --> 00:07:16.725
and it's basically going to show how to deploy

00:07:16.725 --> 00:07:18.245
them and run them on Cloudflare.

00:07:18.645 --> 00:07:21.125
Now this isn't like a Learn Framework X,

00:07:21.125 --> 00:07:23.725
this isn't a Learn Next or Learn Tensex Start or

00:07:23.725 --> 00:07:25.365
Learn Learn Nuxt course.

00:07:25.735 --> 00:07:28.575
This also isn't an intro into building like a full

00:07:28.575 --> 00:07:29.255
stack app.

00:07:29.895 --> 00:07:33.615
This is much more like a overview and a deep dive

00:07:33.615 --> 00:07:35.735
into how to build like SaaS services.

00:07:36.695 --> 00:07:37.415
So the content,

00:07:37.415 --> 00:07:39.095
even though it's like 11 hours long,

00:07:39.255 --> 00:07:40.415
is going to move pretty quick.

00:07:40.415 --> 00:07:42.095
We're not going to be typing side by side,

00:07:42.095 --> 00:07:42.855
line by line.

00:07:42.855 --> 00:07:44.375
I'm going to have a whole bunch of like,

00:07:44.375 --> 00:07:46.455
code that I move over into the project,

00:07:46.535 --> 00:07:47.975
we go over what it does,

00:07:48.135 --> 00:07:49.415
and then we're going to like,

00:07:49.415 --> 00:07:49.935
talk about,

00:07:49.935 --> 00:07:50.335
you know,

00:07:50.335 --> 00:07:51.055
why we're doing it,

00:07:51.055 --> 00:07:51.455
the certain,

00:07:51.455 --> 00:07:51.695
like,

00:07:51.695 --> 00:07:52.295
why we're coding,

00:07:52.295 --> 00:07:53.135
the way we're coding,

00:07:53.135 --> 00:07:53.495
why,

00:07:53.575 --> 00:07:55.575
why we're implementing things in a specific way.

00:07:55.655 --> 00:07:57.175
And then we're going to be showing how to use

00:07:57.555 --> 00:07:57.835
compute,

00:07:57.835 --> 00:07:59.375
primitives on top of Cloudflare.

00:07:59.775 --> 00:08:00.695
And because of that,

00:08:00.695 --> 00:08:03.055
we're able to cover a lot in 11 hours.

00:08:03.055 --> 00:08:05.215
I think if you compare it to most 11 hour courses,

00:08:05.295 --> 00:08:08.375
it's probably going to cover like 70% more than

00:08:08.375 --> 00:08:09.335
what it typically would.

00:08:09.335 --> 00:08:10.495
But just be prepared,

00:08:10.495 --> 00:08:11.335
like these things,

00:08:11.335 --> 00:08:11.575
like,

00:08:11.575 --> 00:08:12.415
we might be moving really,

00:08:12.415 --> 00:08:13.055
really quickly.

00:08:13.295 --> 00:08:14.095
and you just need to know,

00:08:14.095 --> 00:08:14.295
like,

00:08:14.295 --> 00:08:15.135
if you aren't,

00:08:15.295 --> 00:08:15.815
you know,

00:08:15.815 --> 00:08:18.095
like super familiar with a specific technology

00:08:18.175 --> 00:08:18.895
that we're using,

00:08:19.135 --> 00:08:19.815
that's okay.

00:08:19.815 --> 00:08:21.255
We're going to talk about why we're using it,

00:08:21.255 --> 00:08:22.015
how we're using it,

00:08:22.415 --> 00:08:22.775
how,

00:08:22.775 --> 00:08:23.415
how we're using it,

00:08:23.415 --> 00:08:23.975
and then you can,

00:08:23.975 --> 00:08:24.295
you know,

00:08:24.295 --> 00:08:25.375
link off on your own time,

00:08:25.715 --> 00:08:27.555
read about it and understand like that specific

00:08:27.555 --> 00:08:28.355
technology later.

00:08:28.355 --> 00:08:29.875
But what we're trying to do is we're trying to

00:08:29.875 --> 00:08:29.995
like,

00:08:29.995 --> 00:08:32.155
gain a holistic understanding of a service because

00:08:32.155 --> 00:08:32.915
by the end of this,

00:08:32.915 --> 00:08:34.755
you're going to see how everything comes together

00:08:34.915 --> 00:08:34.937
and

00:08:35.251 --> 00:08:37.171
And it's going to empower you to be able to build

00:08:37.171 --> 00:08:39.091
your own services in the future if you want to,

00:08:39.091 --> 00:08:39.211
like,

00:08:39.211 --> 00:08:40.291
go out and do your own project.

00:08:40.451 --> 00:08:41.971
So I really believe in the content,

00:08:41.971 --> 00:08:43.651
I really believe in the content on this course.

00:08:43.741 --> 00:08:44.861
I think that it's going to be very,

00:08:44.861 --> 00:08:45.501
very useful.

00:08:45.501 --> 00:08:46.181
So I'd say just,

00:08:46.181 --> 00:08:47.021
just stick with it,

00:08:47.180 --> 00:08:47.981
get through the end,

00:08:47.981 --> 00:08:49.981
and by the end you're going to have a really,

00:08:49.981 --> 00:08:51.581
really good understanding of how to develop,

00:08:51.771 --> 00:08:53.201
how to ship to Cloudflare,

00:08:53.201 --> 00:08:55.241
how to use these services and how to solve

00:08:55.241 --> 00:08:55.601
problems,

00:08:55.601 --> 00:08:56.841
which is the most important thing.

00:08:57.009 --> 00:08:58.105
So enough of my rambling,

00:08:58.105 --> 00:09:00.465
let's kind of get into exactly what this course is

00:09:00.465 --> 00:09:01.225
going to entail.

00:09:01.225 --> 00:09:03.505
So the end product of this course is going to be

00:09:03.505 --> 00:09:06.065
this really simple UI where you have a dashboard.

00:09:06.065 --> 00:09:07.465
And essentially what this UI is,

00:09:07.465 --> 00:09:08.265
is it is a,

00:09:08.335 --> 00:09:11.225
dashboard to track link clicks for some type of

00:09:11.225 --> 00:09:11.545
like,

00:09:11.625 --> 00:09:14.145
smart routing system for short links.

00:09:14.145 --> 00:09:14.495
So

00:09:14.585 --> 00:09:15.025
if you,

00:09:15.025 --> 00:09:15.705
if you've seen,

00:09:15.710 --> 00:09:16.819
if you've seen like Bitly,

00:09:16.819 --> 00:09:18.259
that's been around for a long time,

00:09:18.259 --> 00:09:18.859
it's just a short,

00:09:18.859 --> 00:09:19.619
a link shortening,

00:09:19.619 --> 00:09:20.979
which is basically just redirecting.

00:09:20.979 --> 00:09:22.379
But it has a few caveats.

00:09:22.459 --> 00:09:22.859
Now,

00:09:23.249 --> 00:09:24.649
if you come through this process,

00:09:24.649 --> 00:09:26.369
like you can go ahead and you can create a link,

00:09:26.369 --> 00:09:28.049
you can pass in a link and you can create

00:09:28.119 --> 00:09:29.419
like this short link.

00:09:29.419 --> 00:09:31.739
And essentially what happens here is you can say,

00:09:31.739 --> 00:09:32.059
okay,

00:09:32.059 --> 00:09:34.059
so like this link is going to redirect to this

00:09:34.059 --> 00:09:34.619
URL,

00:09:34.619 --> 00:09:38.659
but if I want to say everybody in Albania

00:09:38.979 --> 00:09:40.179
is going to go to,

00:09:40.179 --> 00:09:42.659
let's say they're going to go to the Cloudflare

00:09:42.659 --> 00:09:43.379
documentation.

00:09:44.659 --> 00:09:46.339
So these are just like really simple basic CRUD

00:09:46.339 --> 00:09:46.899
operations.

00:09:47.739 --> 00:09:48.539
then you have,

00:09:48.539 --> 00:09:49.619
whenever you create a link,

00:09:49.619 --> 00:09:50.939
you can go ahead and you can see it here,

00:09:51.099 --> 00:09:52.059
you can click on it,

00:09:52.359 --> 00:09:54.279
you can edit stuff and whatnot.

00:09:54.519 --> 00:09:55.559
But what makes this really,

00:09:55.559 --> 00:09:57.679
really special is like we're going to be building

00:09:57.679 --> 00:10:00.286
out a back end implementation on top of this.

00:10:00.374 --> 00:10:02.904
That does more than just link redirects.

00:10:02.904 --> 00:10:05.114
so we have this geo based one where we're going to

00:10:05.114 --> 00:10:05.994
be able to say like,

00:10:05.994 --> 00:10:06.314
oh,

00:10:06.314 --> 00:10:08.354
links in this destination should go to this URL.

00:10:08.354 --> 00:10:10.354
But we're also going to build out some logic where

00:10:10.354 --> 00:10:11.313
when links are clicked,

00:10:11.313 --> 00:10:13.434
we're going to have a series of services that run

00:10:13.514 --> 00:10:13.914
and

00:10:14.344 --> 00:10:16.734
they kind of process like the end destination

00:10:17.054 --> 00:10:19.134
and they use AI to like.

00:10:19.214 --> 00:10:19.494
Well,

00:10:19.494 --> 00:10:21.294
they use browser rendering to render the page in

00:10:21.294 --> 00:10:21.854
the background

00:10:22.264 --> 00:10:24.134
and to view the contents of the page and then to

00:10:24.134 --> 00:10:24.974
like tag like hey,

00:10:24.974 --> 00:10:26.374
is this product unavailable or not?

00:10:26.374 --> 00:10:27.934
Or is this page healthy and whatnot.

00:10:27.934 --> 00:10:28.254
So

00:10:28.374 --> 00:10:30.654
there's like this extra layer to it where there's

00:10:30.654 --> 00:10:32.214
like the smart component that's running in the

00:10:32.214 --> 00:10:33.894
background feeding into the system.

00:10:34.304 --> 00:10:36.384
Now obviously we're also going to have

00:10:37.264 --> 00:10:37.864
a little bit,

00:10:37.864 --> 00:10:39.104
a little section about payments.

00:10:39.104 --> 00:10:40.784
So like how to like integrate payments into the

00:10:40.784 --> 00:10:41.464
SaaS application,

00:10:41.464 --> 00:10:42.944
how that fits into our data model.

00:10:43.104 --> 00:10:43.504
And

00:10:43.904 --> 00:10:45.504
we are also going to have like auth,

00:10:45.504 --> 00:10:46.104
we're going to roll,

00:10:46.104 --> 00:10:47.984
we're going to roll our own auth using better Auth

00:10:47.984 --> 00:10:48.234
as well.

00:10:48.384 --> 00:10:48.544
Well,

00:10:48.544 --> 00:10:50.034
so like we're going to go end to end with it.

00:10:50.034 --> 00:10:52.144
but the main focus isn't going to be payments or

00:10:52.144 --> 00:10:52.784
authentication,

00:10:52.784 --> 00:10:55.184
it's going to be how do we build like the entire

00:10:55.184 --> 00:10:55.504
system.

00:10:55.934 --> 00:10:57.124
and to kind of make that a little bit more

00:10:57.124 --> 00:10:57.464
concrete,

00:10:57.464 --> 00:10:59.970
we can go ahead and look at the starter repo.

00:10:59.970 --> 00:11:01.290
So ultimately what you're going to do is you're

00:11:01.290 --> 00:11:02.769
going to fork this and I'm going to have links in

00:11:02.769 --> 00:11:03.880
it and the next video is going to go

00:11:03.880 --> 00:11:04.890
through this entire process.

00:11:04.890 --> 00:11:05.290
But,

00:11:05.700 --> 00:11:07.720
essentially you're going to notice that if you

00:11:07.720 --> 00:11:09.160
look at this application and you're,

00:11:09.160 --> 00:11:10.960
let's say you're used to working in Next js,

00:11:11.040 --> 00:11:12.880
the structure of this project looks different.

00:11:12.880 --> 00:11:14.880
You don't just have a source and a whole bunch of

00:11:14.880 --> 00:11:16.240
different configuration files here.

00:11:16.300 --> 00:11:16.460
You can,

00:11:16.610 --> 00:11:18.890
you have this folder called Apps and you also have

00:11:18.890 --> 00:11:19.810
a data ops.

00:11:19.980 --> 00:11:22.110
this is because we're working in a mono repo and

00:11:22.110 --> 00:11:22.790
the reason we're

00:11:23.670 --> 00:11:25.710
working in a monorepo is because we need to

00:11:25.710 --> 00:11:26.230
segment

00:11:26.550 --> 00:11:29.430
the user facing stuff with the deeper backend

00:11:29.430 --> 00:11:29.820
stuff.

00:11:29.820 --> 00:11:31.210
and all of these things are going to be hosted on

00:11:31.210 --> 00:11:32.890
cloudflare but they're going to have different

00:11:32.890 --> 00:11:33.650
responsibilities

00:11:33.805 --> 00:11:35.894
now just the TLDR of a monorepo.

00:11:35.894 --> 00:11:37.174
So essentially you can have

00:11:37.494 --> 00:11:38.534
inside of apps,

00:11:38.534 --> 00:11:40.814
you can have like your Next JS app or your React

00:11:40.814 --> 00:11:41.654
app or your

00:11:42.164 --> 00:11:43.084
backend application.

00:11:43.084 --> 00:11:44.764
And in this situation we have our User

00:11:44.764 --> 00:11:45.204
application,

00:11:45.204 --> 00:11:47.764
which is this UI that you saw right here.

00:11:48.244 --> 00:11:49.684
And then it is also

00:11:50.514 --> 00:11:51.834
the TRPC backend.

00:11:51.834 --> 00:11:53.074
So like a really lightweight

00:11:53.304 --> 00:11:55.304
backend that interfaces with the database.

00:11:55.544 --> 00:11:57.503
And then we have another service that is

00:11:57.503 --> 00:11:59.584
responsible for like all of the deeper data

00:11:59.584 --> 00:12:00.144
operations.

00:12:00.144 --> 00:12:01.904
So there's kind of two services being deployed.

00:12:01.904 --> 00:12:03.984
But if your SaaS application grows and grows and

00:12:03.984 --> 00:12:04.224
grows,

00:12:04.224 --> 00:12:06.544
you can kind of segment responsibility based upon

00:12:06.544 --> 00:12:08.384
services inside of this apps folder.

00:12:08.384 --> 00:12:11.064
And then we have a Data Ops package which

00:12:11.394 --> 00:12:14.484
is basically a way of taking our TypeScript code

00:12:14.564 --> 00:12:16.804
that we want to share across all of our different

00:12:16.804 --> 00:12:18.164
apps or some of our apps,

00:12:18.564 --> 00:12:19.604
generalizing it,

00:12:19.604 --> 00:12:22.484
packaging it and then being able to use it inside

00:12:22.484 --> 00:12:23.604
of these applications.

00:12:24.384 --> 00:12:25.904
so enough about this,

00:12:26.224 --> 00:12:28.104
I just want to kind of like go over the

00:12:28.104 --> 00:12:29.584
responsibilities of these services now.

00:12:29.584 --> 00:12:31.384
I do think this is a very important section so I

00:12:31.384 --> 00:12:31.824
wouldn't like,

00:12:31.824 --> 00:12:34.224
I wouldn't skip to where we get into the code.

00:12:34.224 --> 00:12:36.104
I want to drill in the point of like the

00:12:36.104 --> 00:12:37.264
responsibility of services.

00:12:37.988 --> 00:12:38.988
So like we just mentioned,

00:12:38.988 --> 00:12:41.708
we have two services and we have a Data Ops

00:12:41.708 --> 00:12:42.148
package.

00:12:42.228 --> 00:12:45.108
So this is a monorepo setup and we're using PMPM

00:12:45.188 --> 00:12:46.788
to a POPM workspace.

00:12:46.788 --> 00:12:48.108
Not just a little bit different than just like

00:12:48.108 --> 00:12:48.908
PNPM install.

00:12:48.908 --> 00:12:51.428
It's a workspace where we're able to basically say

00:12:51.428 --> 00:12:52.708
at the root level of our project

00:12:53.028 --> 00:12:55.228
we're able to specify what our services and what

00:12:55.228 --> 00:12:55.948
our package is.

00:12:55.948 --> 00:12:56.308
Now

00:12:56.768 --> 00:12:57.608
if you're,

00:12:57.608 --> 00:12:59.848
if you've built stuff before using Next JS but you

00:12:59.848 --> 00:13:01.968
haven't like built out a dedicated backend,

00:13:02.298 --> 00:13:04.018
this setup is going to be a little bit new to you.

00:13:04.018 --> 00:13:05.658
But that's okay because I actually think you're

00:13:05.658 --> 00:13:06.498
going to like it more.

00:13:06.498 --> 00:13:08.528
So what we're doing here is we

00:13:08.598 --> 00:13:11.158
have a user application and this user application

00:13:11.158 --> 00:13:12.838
is going to be using some technologies that we're

00:13:12.838 --> 00:13:13.368
familiar with.

00:13:13.368 --> 00:13:13.798
react,

00:13:14.028 --> 00:13:16.258
Tanstack using Tanstack Query and Router,

00:13:16.338 --> 00:13:17.857
using shadcn for styling,

00:13:18.178 --> 00:13:20.658
TRPC for having like type safe interactions

00:13:20.658 --> 00:13:22.818
between the front end and the back end and then

00:13:22.818 --> 00:13:25.178
HONO for some like API routing and whatnot as

00:13:25.178 --> 00:13:25.378
well.

00:13:25.378 --> 00:13:25.698
So

00:13:25.938 --> 00:13:26.938
is the tech but what

00:13:27.198 --> 00:13:28.558
we really want to focus on are what are the

00:13:28.558 --> 00:13:29.118
responsibilities.

00:13:29.198 --> 00:13:31.718
So in my opinion the responsibilities of the user

00:13:31.718 --> 00:13:34.638
facing application should literally be routing,

00:13:35.118 --> 00:13:36.798
auth and CRUD operations.

00:13:36.878 --> 00:13:37.598
It should be very,

00:13:37.598 --> 00:13:38.158
very simple.

00:13:38.158 --> 00:13:40.758
You shouldn't bake in lots and lots of like data

00:13:40.758 --> 00:13:43.478
operations and long running tasks inside of your

00:13:43.478 --> 00:13:44.478
full stack framework.

00:13:44.478 --> 00:13:46.918
I think that a dedicated data service is the best

00:13:46.918 --> 00:13:47.918
way to scale a project,

00:13:48.098 --> 00:13:50.178
by Basically splitting up those responsibilities.

00:13:50.258 --> 00:13:52.898
So in our data service we're going to have similar

00:13:52.898 --> 00:13:55.458
technology like it's Hono is going to be used in

00:13:55.938 --> 00:13:56.898
both of these applications

00:13:57.008 --> 00:13:58.288
and we're going to be using

00:13:58.408 --> 00:13:59.768
Cloudflare queues for

00:14:00.088 --> 00:14:00.648
basically

00:14:00.968 --> 00:14:01.608
getting data,

00:14:01.608 --> 00:14:03.448
putting it on a queue and then kind of processing

00:14:03.448 --> 00:14:04.408
it later into the future.

00:14:04.728 --> 00:14:06.088
Durable objects for

00:14:06.098 --> 00:14:07.088
managing scheduling,

00:14:07.088 --> 00:14:08.568
also managing websockets

00:14:08.888 --> 00:14:09.767
workflows,

00:14:09.798 --> 00:14:12.508
for running sequential jobs like jobs that require

00:14:12.508 --> 00:14:14.628
multiple steps and having some like

00:14:15.148 --> 00:14:16.578
guarantees with each step.

00:14:18.376 --> 00:14:19.896
we're going to be using browser rendering.

00:14:19.896 --> 00:14:21.536
On the back end we're going to be using

00:14:21.536 --> 00:14:24.376
Cloudflare's built in AI offering for AI inference

00:14:24.376 --> 00:14:25.856
and then we're also going to have web sockets.

00:14:25.856 --> 00:14:27.216
But the most important thing here is the

00:14:27.216 --> 00:14:27.736
responsibility.

00:14:27.736 --> 00:14:29.576
So the responsibilities of the backend service is

00:14:29.816 --> 00:14:30.776
data processing

00:14:31.256 --> 00:14:34.016
long running tasks and our link redirect.

00:14:34.016 --> 00:14:36.016
So the link redirect component of actually routing

00:14:36.016 --> 00:14:37.896
the user to the right spot are going to be

00:14:37.896 --> 00:14:39.496
responsible by the data service.

00:14:39.576 --> 00:14:41.416
And on the back end side of things

00:14:41.756 --> 00:14:43.596
we're going to be using or on the data ops side of

00:14:43.596 --> 00:14:44.876
things we're going to be using Drizzle

00:14:45.386 --> 00:14:45.626
for

00:14:45.826 --> 00:14:47.366
having like type safe

00:14:47.526 --> 00:14:48.726
interactions with our database.

00:14:49.046 --> 00:14:51.046
We're going to be using ZOD for having

00:14:51.526 --> 00:14:52.966
secure types in our

00:14:53.006 --> 00:14:55.866
throughout our code base and then PNPM workspace

00:14:55.866 --> 00:14:58.186
to kind of package the code so we can share it

00:14:58.186 --> 00:14:59.066
across our services.

00:14:59.226 --> 00:15:02.266
Now the responsibilities of data auth are our data

00:15:02.266 --> 00:15:03.546
ops are schema management,

00:15:04.066 --> 00:15:04.726
our database,

00:15:04.726 --> 00:15:05.766
our database queries.

00:15:05.846 --> 00:15:08.286
So we're going to be writing out like actual

00:15:08.286 --> 00:15:08.806
queries

00:15:09.696 --> 00:15:10.376
under functions.

00:15:10.376 --> 00:15:12.016
We're going to be exporting those functions so we

00:15:12.016 --> 00:15:14.776
could use them in both user applications and the

00:15:14.776 --> 00:15:15.376
data service.

00:15:16.026 --> 00:15:18.346
it's going to be responsible for like our types

00:15:18.346 --> 00:15:19.706
and our ZOD schemas.

00:15:19.866 --> 00:15:22.146
And then the main focus is this is where our

00:15:22.146 --> 00:15:23.464
reusable code goes.

00:15:23.464 --> 00:15:25.764
So with that being said let's just look at how

00:15:25.764 --> 00:15:27.524
like a normal data flow would go.

00:15:27.524 --> 00:15:27.924
So

00:15:28.114 --> 00:15:30.924
if the user loads our web page it's going to go to

00:15:30.924 --> 00:15:32.564
our user application and

00:15:33.064 --> 00:15:35.144
a lot of these like client components

00:15:35.214 --> 00:15:36.564
are rendered into the,

00:15:36.564 --> 00:15:38.564
are loaded into the browser.

00:15:38.724 --> 00:15:41.644
The UI loads and then some data is fetched to our

00:15:41.644 --> 00:15:42.604
TRPC backend.

00:15:42.604 --> 00:15:45.164
So the user application actually consists of a

00:15:45.164 --> 00:15:46.604
front end and a back end.

00:15:46.604 --> 00:15:47.444
There's both here,

00:15:47.514 --> 00:15:49.724
and then the layer in between is we're going to

00:15:49.724 --> 00:15:50.124
have auth.

00:15:50.284 --> 00:15:53.044
So it's very isolated in the responsibilities

00:15:53.044 --> 00:15:53.374
here.

00:15:53.374 --> 00:15:54.974
basically we're saying the requests that are going

00:15:54.974 --> 00:15:56.854
to the backend we're going to build out auth,

00:15:56.934 --> 00:15:58.854
so this layer can secure,

00:15:59.094 --> 00:16:00.974
can ensure that users can only see what they're

00:16:00.974 --> 00:16:01.574
supposed to see.

00:16:02.014 --> 00:16:03.254
Now from there our,

00:16:03.254 --> 00:16:05.734
our TRPC routes or backend inside of our user

00:16:05.734 --> 00:16:08.014
application are going to do basic crud operations.

00:16:08.014 --> 00:16:09.134
Managing the

00:16:09.284 --> 00:16:10.014
creation of links,

00:16:10.014 --> 00:16:10.734
updating the links,

00:16:10.734 --> 00:16:11.454
deleting the links,

00:16:11.454 --> 00:16:13.094
seeing all of the analytics and whatnot.

00:16:13.094 --> 00:16:14.854
So that's the interactions that it has with the

00:16:14.854 --> 00:16:15.214
database.

00:16:15.214 --> 00:16:16.454
And then in some situations,

00:16:16.454 --> 00:16:17.493
like with WebSockets,

00:16:17.734 --> 00:16:20.334
it'll be responsible for validating the request

00:16:20.334 --> 00:16:23.334
and then proxying the request to our data service.

00:16:23.494 --> 00:16:24.854
Now our data service

00:16:25.174 --> 00:16:26.134
is going to have

00:16:26.844 --> 00:16:28.364
these different compute primitives,

00:16:28.684 --> 00:16:29.964
but it's going to

00:16:30.444 --> 00:16:32.844
be triggered by specific cloudflare trigger.

00:16:32.844 --> 00:16:35.204
So like a trigger would be an API request,

00:16:35.204 --> 00:16:37.244
an API request to our backend service,

00:16:37.404 --> 00:16:38.724
maybe a cron schedule,

00:16:38.724 --> 00:16:41.564
like some type of cron job that says every five

00:16:41.564 --> 00:16:43.324
hours wake up the code and run something,

00:16:43.504 --> 00:16:44.364
and then a queue event.

00:16:44.444 --> 00:16:45.964
So when data is on a queue,

00:16:46.124 --> 00:16:48.644
you can have a dedicated service that is listening

00:16:48.644 --> 00:16:50.884
to that queue and then processing the data there.

00:16:50.884 --> 00:16:52.364
And then all of these

00:16:52.524 --> 00:16:54.244
triggers are going to interface with different

00:16:54.244 --> 00:16:56.204
like resources and durable objects,

00:16:56.204 --> 00:16:56.604
workflows,

00:16:56.604 --> 00:16:56.884
queues.

00:16:56.884 --> 00:16:58.164
And then there's other things as well,

00:16:58.164 --> 00:16:58.484
like

00:16:58.704 --> 00:17:00.464
AI browser rendering and whatnot.

00:17:00.464 --> 00:17:02.264
So this is kind of like how the data flow goes.

00:17:02.264 --> 00:17:02.664
You can,

00:17:02.664 --> 00:17:03.944
you can basically say like,

00:17:03.944 --> 00:17:06.024
is this operation something that should be pushed

00:17:06.024 --> 00:17:07.664
to the back end because it's like some type of

00:17:07.664 --> 00:17:08.384
data operation?

00:17:08.384 --> 00:17:10.984
Or is this just like a user triggered,

00:17:11.004 --> 00:17:12.444
is this like a user triggered

00:17:12.844 --> 00:17:12.904
crud,

00:17:13.104 --> 00:17:15.304
operation that is going to live inside of the user

00:17:15.304 --> 00:17:15.904
application?

00:17:16.784 --> 00:17:18.144
So now before we get started,

00:17:18.224 --> 00:17:20.064
I pointed out this repo right here,

00:17:20.064 --> 00:17:21.104
which is our

00:17:21.664 --> 00:17:22.624
starter template.

00:17:22.954 --> 00:17:24.434
And essentially you're just going to go ahead and

00:17:24.434 --> 00:17:25.754
fork it and you'll,

00:17:25.754 --> 00:17:27.594
you can fork this code and you can like start

00:17:27.594 --> 00:17:28.554
building based upon

00:17:28.774 --> 00:17:30.094
the fork version of this code.

00:17:30.094 --> 00:17:31.334
The next video is going to talk about this,

00:17:31.334 --> 00:17:33.734
but if at any point in this video you get stuck or

00:17:33.734 --> 00:17:34.254
throughout this course,

00:17:34.254 --> 00:17:35.014
if you get stuck,

00:17:35.254 --> 00:17:37.094
I'm going to also link in this video.

00:17:37.254 --> 00:17:38.294
This repo right here,

00:17:38.294 --> 00:17:40.894
this is my starter repo that I forked and the

00:17:40.894 --> 00:17:42.334
exact code that I went through throughout the

00:17:42.334 --> 00:17:43.734
entire course to actually

00:17:44.574 --> 00:17:46.414
to actually like build things out.

00:17:46.414 --> 00:17:48.294
So this is in its final state,

00:17:48.294 --> 00:17:49.694
the application is fully built.

00:17:49.694 --> 00:17:50.814
So if you ever get stuck,

00:17:50.894 --> 00:17:52.774
you can just come over to the apps,

00:17:52.774 --> 00:17:53.054
you know,

00:17:53.054 --> 00:17:53.334
find,

00:17:53.334 --> 00:17:54.794
find the COD that you're working on.

00:17:54.874 --> 00:17:56.394
You can compare against mine and be like,

00:17:56.394 --> 00:17:56.594
oh,

00:17:56.594 --> 00:17:57.034
that's why,

00:17:57.114 --> 00:17:57.754
another thing,

00:17:57.754 --> 00:17:58.634
if you get stuck,

00:17:58.634 --> 00:18:01.074
I would really encourage you to be using like

00:18:01.074 --> 00:18:02.554
cloud code or cursor,

00:18:02.564 --> 00:18:04.524
agents just to basically chat with like,

00:18:04.524 --> 00:18:04.884
hey,

00:18:04.884 --> 00:18:06.004
I'm watching a course.

00:18:06.164 --> 00:18:06.764
I was,

00:18:06.764 --> 00:18:09.283
I got to this section and I'm having this issue

00:18:09.283 --> 00:18:11.484
and I can't figure out it's not covered in the

00:18:11.484 --> 00:18:11.764
course.

00:18:12.004 --> 00:18:12.404
Why,

00:18:12.644 --> 00:18:13.284
what's the case?

00:18:13.284 --> 00:18:14.044
And then see if like,

00:18:14.044 --> 00:18:15.084
your agent can also solve it.

00:18:15.084 --> 00:18:15.644
Because that's like,

00:18:15.644 --> 00:18:16.484
honestly such a great,

00:18:16.564 --> 00:18:18.284
a great use case where you can learn these

00:18:18.284 --> 00:18:19.004
concepts from like,

00:18:19.004 --> 00:18:19.844
seeing them in practice.

00:18:19.844 --> 00:18:20.764
But then when you get stuck,

00:18:20.764 --> 00:18:21.044
you know,

00:18:21.044 --> 00:18:21.404
you can like,

00:18:21.404 --> 00:18:23.124
ask those questions and get feedback about like,

00:18:23.124 --> 00:18:23.724
what you're coding.

00:18:23.724 --> 00:18:24.524
And maybe you have a typo,

00:18:24.524 --> 00:18:25.704
like maybe it's something simple as like,

00:18:25.704 --> 00:18:25.764
oh,

00:18:25.764 --> 00:18:27.078
I'm using the wrong type here or something.

00:18:27.078 --> 00:18:27.360
But yeah,

00:18:27.360 --> 00:18:27.520
that,

00:18:27.520 --> 00:18:28.280
that this is really important.

00:18:28.280 --> 00:18:28.920
So just like,

00:18:28.920 --> 00:18:29.440
keep in mind,

00:18:29.440 --> 00:18:30.280
if you ever get stuck,

00:18:30.280 --> 00:18:32.280
you can just reference this repo right here.

00:18:32.760 --> 00:18:34.800
Now the last thing that I want to mention is this

00:18:34.800 --> 00:18:35.160
course,

00:18:35.280 --> 00:18:37.200
is geared towards just kind of like having a bunch

00:18:37.200 --> 00:18:37.840
of sections.

00:18:37.840 --> 00:18:38.240
So,

00:18:38.339 --> 00:18:40.820
every single section builds upon itself and

00:18:41.400 --> 00:18:43.400
section contains a video where we talk about like,

00:18:43.400 --> 00:18:44.000
what we're building.

00:18:44.160 --> 00:18:44.920
You see the code,

00:18:44.920 --> 00:18:45.600
you see what I'm doing.

00:18:45.600 --> 00:18:47.920
I explain in detail everything that's going on.

00:18:48.160 --> 00:18:49.150
And then I,

00:18:49.160 --> 00:18:51.270
under most sections where there's actual like,

00:18:51.270 --> 00:18:52.150
code being done,

00:18:52.470 --> 00:18:53.430
I have like,

00:18:53.840 --> 00:18:54.370
the actual like,

00:18:54.370 --> 00:18:55.330
code that's being used.

00:18:55.330 --> 00:18:55.850
So there's,

00:18:55.850 --> 00:18:56.650
there's two things here.

00:18:56.650 --> 00:18:57.730
There's one at the top,

00:18:57.730 --> 00:18:57.970
right?

00:18:57.970 --> 00:18:59.490
You're going to see follow along,

00:18:59.490 --> 00:19:01.330
basically meaning watch the video,

00:19:01.730 --> 00:19:03.850
look at what I'm doing and try to mirror exactly

00:19:03.850 --> 00:19:04.370
what I'm doing.

00:19:04.370 --> 00:19:06.370
And then make sure you bring in the code,

00:19:06.660 --> 00:19:07.020
that,

00:19:07.020 --> 00:19:09.260
that I have actually like put into the code base.

00:19:09.260 --> 00:19:11.140
Bring that over to your own project because you're

00:19:11.140 --> 00:19:12.660
going to want to make sure you keep up to speed

00:19:12.660 --> 00:19:15.060
with the video so your project stays in the same

00:19:15.060 --> 00:19:16.020
state as my project.

00:19:17.388 --> 00:19:17.908
Now there are,

00:19:17.908 --> 00:19:19.068
there are some videos,

00:19:19.298 --> 00:19:21.138
like understanding the worker runtime,

00:19:21.138 --> 00:19:22.618
where they're more conceptual in nature,

00:19:22.618 --> 00:19:24.338
where I'm trying to convey a concept,

00:19:24.368 --> 00:19:26.238
and I'm going into great detail to just kind of

00:19:26.238 --> 00:19:28.318
like draw diagrams and go over things.

00:19:28.318 --> 00:19:29.797
You're going to notice it just says just watch.

00:19:29.797 --> 00:19:30.478
So sit back,

00:19:30.688 --> 00:19:32.238
think critically about what I'm saying.

00:19:32.238 --> 00:19:32.758
And then like,

00:19:32.758 --> 00:19:34.198
these are really going to help you if you,

00:19:34.198 --> 00:19:35.998
if you follow along with the code stuff.

00:19:35.998 --> 00:19:38.158
And then you also watch these lectures where I'm

00:19:38.158 --> 00:19:38.598
trying to like,

00:19:38.598 --> 00:19:39.438
convey a concept.

00:19:39.598 --> 00:19:41.638
You should have a really good understanding of

00:19:41.638 --> 00:19:43.878
Cloudflare and how to build systems by the end of

00:19:43.878 --> 00:19:44.318
this course.

00:19:44.382 --> 00:19:45.702
And then just the last thing,

00:19:45.702 --> 00:19:47.262
I just want to show an example of what this would

00:19:47.262 --> 00:19:47.662
look like.

00:19:47.662 --> 00:19:48.062
So,

00:19:48.212 --> 00:19:48.542
throughout,

00:19:48.542 --> 00:19:49.262
like this video,

00:19:49.582 --> 00:19:51.262
these are like some of the code snippets that

00:19:51.262 --> 00:19:52.382
we're going to bring into our code.

00:19:52.382 --> 00:19:54.702
So this is one where we are creating these tables

00:19:54.702 --> 00:19:55.452
in our database.

00:19:55.452 --> 00:19:55.942
and you're like,

00:19:55.942 --> 00:19:56.102
well,

00:19:56.102 --> 00:19:58.341
I don't want to type out line by line all of these

00:19:58.341 --> 00:19:58.542
things.

00:19:58.542 --> 00:19:59.182
That's fine.

00:19:59.182 --> 00:20:00.942
Whenever it's a scenario like this,

00:20:01.022 --> 00:20:03.502
I always put the code snippets in the inside of

00:20:03.502 --> 00:20:03.752
the,

00:20:03.752 --> 00:20:04.602
learning material,

00:20:04.682 --> 00:20:06.922
so you could just copy it over and then move it to

00:20:06.922 --> 00:20:07.882
wherever it needs to be.

00:20:07.882 --> 00:20:08.282
So

00:20:08.772 --> 00:20:10.352
I think that's enough of rambling here.

00:20:10.942 --> 00:20:12.822
at this point I think that we can dive into the

00:20:12.822 --> 00:20:13.982
code and we can really get started.

00:20:14.142 --> 00:20:14.856
So let's do it.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.048 --> 00:00:00.288
All right,

00:00:00.288 --> 00:00:01.368
to get this project started,

00:00:01.368 --> 00:00:03.048
you're going to want to head over to the starter

00:00:03.048 --> 00:00:05.408
repo that contains all the starter code for this

00:00:05.408 --> 00:00:05.728
course.

00:00:06.048 --> 00:00:07.328
And what we're going to do is we're going to go

00:00:07.328 --> 00:00:09.488
ahead and fork it into your own GitHub account.

00:00:09.488 --> 00:00:10.768
So if you don't have a GitHub account,

00:00:10.768 --> 00:00:12.288
take this time to go create one.

00:00:12.448 --> 00:00:14.248
It's really important to have a GitHub account for

00:00:14.248 --> 00:00:16.448
this course because towards the end we're actually

00:00:16.448 --> 00:00:17.968
going to go through the process of building

00:00:17.968 --> 00:00:19.968
deployment pipelines that do automated

00:00:19.968 --> 00:00:20.448
deployments,

00:00:20.448 --> 00:00:21.648
and that's powered by GitHub.

00:00:21.648 --> 00:00:21.818
So.

00:00:21.968 --> 00:00:22.208
So,

00:00:22.558 --> 00:00:23.768
just make sure you have a GitHub account.

00:00:23.768 --> 00:00:25.368
You could just obviously clone the project,

00:00:25.688 --> 00:00:27.208
but then you're not going to be able to push

00:00:27.208 --> 00:00:27.808
changes to it,

00:00:27.808 --> 00:00:29.408
and then you're obviously not going to be able to

00:00:29.408 --> 00:00:31.048
connect your GitHub account to your Cloudflare

00:00:31.048 --> 00:00:31.368
account.

00:00:31.688 --> 00:00:32.888
So once you have this,

00:00:33.208 --> 00:00:34.488
once you have this repo

00:00:34.506 --> 00:00:35.173
forked,

00:00:35.235 --> 00:00:37.155
copy the link to the actual,

00:00:37.395 --> 00:00:38.835
the git link to the repo,

00:00:39.075 --> 00:00:41.035
and then you can head over to a terminal and say

00:00:41.035 --> 00:00:41.715
git clone

00:00:42.755 --> 00:00:45.195
and pass in that repo name and then you can CD

00:00:45.195 --> 00:00:46.115
into the repo.

00:00:46.415 --> 00:00:47.575
Now if you use GitHub Desktop,

00:00:47.575 --> 00:00:48.295
that's totally fine.

00:00:48.295 --> 00:00:49.375
You can just go through that process.

00:00:49.375 --> 00:00:50.815
And if you've never used Git before,

00:00:51.055 --> 00:00:52.295
I'll link a few videos,

00:00:52.295 --> 00:00:53.415
just to kind of get you started.

00:00:53.495 --> 00:00:55.415
But this course is definitely not going to go into

00:00:55.415 --> 00:00:57.175
like the nitty gritties of how to use git.

00:00:57.555 --> 00:00:59.495
and from there we're going to open up Cursor.

00:01:00.135 --> 00:01:01.655
You can use whatever IDE you want,

00:01:01.655 --> 00:01:03.055
but for this course I'm going to go ahead and use

00:01:03.055 --> 00:01:03.455
Cursor,

00:01:03.455 --> 00:01:04.738
because I know a lot of folks use it.

00:01:04.837 --> 00:01:05.077
All right,

00:01:05.077 --> 00:01:05.237
now,

00:01:05.237 --> 00:01:06.797
before we dive too deep into the code,

00:01:06.797 --> 00:01:08.877
let's go ahead and understand the file structure

00:01:08.877 --> 00:01:09.557
of this project.

00:01:09.797 --> 00:01:10.037
Now,

00:01:10.037 --> 00:01:10.677
right off the bat,

00:01:10.677 --> 00:01:13.077
you might notice we don't have a source folder at

00:01:13.077 --> 00:01:14.517
the root level of this repo.

00:01:14.597 --> 00:01:16.837
And the reason we don't have a source folder at

00:01:16.837 --> 00:01:18.957
the root level of this repo is because this is a

00:01:18.957 --> 00:01:20.197
mono repo setup.

00:01:20.357 --> 00:01:22.557
What that means is essentially we have multiple

00:01:22.557 --> 00:01:24.037
different applications or services

00:01:24.517 --> 00:01:27.317
that are packaged inside of a single repository.

00:01:27.897 --> 00:01:28.577
As you can see here.

00:01:28.577 --> 00:01:29.377
Inside of Apps,

00:01:29.377 --> 00:01:31.377
we have two different services inside of here,

00:01:31.377 --> 00:01:33.417
and each one of these services have their own

00:01:33.737 --> 00:01:35.897
source folder that contains all the source code.

00:01:35.897 --> 00:01:38.857
But then we also have a packages folder which

00:01:38.857 --> 00:01:40.497
contains a Data Ops package.

00:01:40.497 --> 00:01:41.337
Just one for now.

00:01:41.347 --> 00:01:43.797
which contains reusable code like Zod,

00:01:43.797 --> 00:01:44.957
schema definitions,

00:01:45.177 --> 00:01:46.197
database queries,

00:01:46.597 --> 00:01:48.957
generic functions that can be used across backend

00:01:48.957 --> 00:01:50.117
services and front end services.

00:01:50.557 --> 00:01:52.997
we put all that logic inside of a package and then

00:01:52.997 --> 00:01:55.637
we can easily use it across our monorepo,

00:01:55.637 --> 00:01:57.517
the different apps inside of our monorepo.

00:01:57.867 --> 00:01:59.547
it's a little bit tedious to set up at the very

00:01:59.547 --> 00:02:00.027
beginning,

00:02:00.027 --> 00:02:02.187
which is kind of why I have this set up for you

00:02:02.267 --> 00:02:02.867
right now.

00:02:02.867 --> 00:02:06.147
But as your project grows and as it becomes more

00:02:06.147 --> 00:02:07.667
complex and you add tons of different features,

00:02:07.667 --> 00:02:10.027
this setup is really nice because you can define

00:02:10.107 --> 00:02:12.787
concepts in a very concrete way and then those

00:02:12.787 --> 00:02:14.627
concepts can scale across multiple different

00:02:14.627 --> 00:02:16.307
services inside of your application.

00:02:16.307 --> 00:02:18.507
And this pattern works so well with cloudflare.

00:02:18.507 --> 00:02:19.887
it really is a great pattern to follow.

00:02:19.967 --> 00:02:20.767
So that's,

00:02:20.767 --> 00:02:21.707
that's our setup.

00:02:21.707 --> 00:02:22.667
essentially just think

00:02:23.147 --> 00:02:25.667
multiple different applications inside of our apps

00:02:25.667 --> 00:02:27.987
folder and then we have reusable code inside of

00:02:27.987 --> 00:02:29.147
our packages folder.

00:02:29.227 --> 00:02:30.867
Now the very first thing that we're going to do is

00:02:30.867 --> 00:02:33.067
we're going to take a look at the package JSON

00:02:33.067 --> 00:02:33.547
file.

00:02:33.767 --> 00:02:35.087
we have some different scripts here.

00:02:35.167 --> 00:02:35.567
Now

00:02:36.047 --> 00:02:39.237
these scripts are using PNPM commands to basically

00:02:39.507 --> 00:02:42.987
run the dev command to dev our front end or to

00:02:42.987 --> 00:02:43.827
build our package.

00:02:43.867 --> 00:02:44.587
but to get started,

00:02:44.587 --> 00:02:46.307
the very first thing that we want to do is we're

00:02:46.307 --> 00:02:47.347
going to want to open a terminal

00:02:47.787 --> 00:02:50.427
and we're just going to say PNPM I and that's

00:02:50.427 --> 00:02:51.987
going to go ahead and it's going to install all

00:02:51.987 --> 00:02:54.667
the dependencies across our entire application.

00:02:55.317 --> 00:02:55.877
it should,

00:02:55.957 --> 00:02:57.997
it should install all the dependencies inside of

00:02:57.997 --> 00:03:00.597
the user application and the data service and our

00:03:00.597 --> 00:03:01.477
package right here.

00:03:01.717 --> 00:03:02.517
When that's done,

00:03:02.517 --> 00:03:04.037
what we're going to want to do is you're going to

00:03:04.037 --> 00:03:06.117
want to run this command I have this command which

00:03:06.117 --> 00:03:07.077
is basically saying

00:03:07.287 --> 00:03:10.407
it's going to build the source code inside of our

00:03:10.567 --> 00:03:11.727
data ops package.

00:03:11.727 --> 00:03:12.087
So

00:03:12.417 --> 00:03:14.537
inside of our data ops package here you can see

00:03:14.537 --> 00:03:16.777
that we have this R package JSON.

00:03:16.777 --> 00:03:18.337
We have a bunch of different scripts that we're

00:03:18.337 --> 00:03:19.537
going to go through later in this course.

00:03:19.537 --> 00:03:21.457
But the main one is we need to build,

00:03:21.457 --> 00:03:23.137
which is going to take the TypeScript and it's

00:03:23.137 --> 00:03:24.977
going to bundle it into JavaScript and it's going

00:03:24.977 --> 00:03:27.137
to stick it in a dist folder and it's going to

00:03:27.137 --> 00:03:29.377
make it usable across our applications.

00:03:29.537 --> 00:03:30.817
So I'm going to say

00:03:31.857 --> 00:03:32.817
pnpm

00:03:33.137 --> 00:03:33.537
run

00:03:34.097 --> 00:03:37.377
build package and this is at the root level of the

00:03:37.377 --> 00:03:39.417
mono repo that's going to go through the build

00:03:39.417 --> 00:03:39.777
process,

00:03:39.857 --> 00:03:40.847
it's going to build it,

00:03:40.847 --> 00:03:42.527
and then that code is going to be ready to go

00:03:42.527 --> 00:03:43.807
across all of our

00:03:44.577 --> 00:03:46.807
across all of our applications inside of our apps

00:03:46.807 --> 00:03:47.207
folder.

00:03:47.207 --> 00:03:49.127
So the next thing that we're going to do is we

00:03:49.127 --> 00:03:49.367
can,

00:03:49.367 --> 00:03:51.167
we're going to run our front end service.

00:03:51.407 --> 00:03:53.647
Now we can essentially what I do,

00:03:53.647 --> 00:03:55.327
what I have here is I have a few different helper

00:03:55.327 --> 00:03:56.847
scripts and we're going to extend the scripts that

00:03:56.847 --> 00:03:59.567
we put in at the root package of our mono repo.

00:03:59.567 --> 00:04:01.167
But the first one that we're going to look at is

00:04:01.637 --> 00:04:02.567
dev front end.

00:04:02.567 --> 00:04:04.567
So what this is doing is this is basically saying

00:04:04.807 --> 00:04:06.087
PNPM filter

00:04:06.457 --> 00:04:07.217
user application.

00:04:07.217 --> 00:04:09.457
So it's going to go find the user application and

00:04:09.457 --> 00:04:11.097
the user application is defined

00:04:11.497 --> 00:04:14.017
inside of the package JSON for the user

00:04:14.017 --> 00:04:14.537
application.

00:04:14.537 --> 00:04:16.457
You can see the name is user application.

00:04:16.857 --> 00:04:17.257
The

00:04:18.213 --> 00:04:20.493
and then it's going to run the dev script for

00:04:20.493 --> 00:04:20.733
that.

00:04:20.733 --> 00:04:23.253
So this is if we're running at the root level of

00:04:23.253 --> 00:04:23.573
our

00:04:24.293 --> 00:04:26.853
monorepo we can say pnpm

00:04:28.373 --> 00:04:28.773
run

00:04:29.253 --> 00:04:30.293
dev front end.

00:04:30.373 --> 00:04:31.933
And what that's going to do is that's going to

00:04:31.933 --> 00:04:33.973
start up our front end application running on

00:04:34.363 --> 00:04:35.083
Port 3000.

00:04:35.243 --> 00:04:36.923
Now another pattern,

00:04:36.923 --> 00:04:38.883
which it really just depends on how I'm building

00:04:38.883 --> 00:04:40.443
at the time is you can also

00:04:40.763 --> 00:04:41.323
CD

00:04:41.883 --> 00:04:42.283
into

00:04:42.763 --> 00:04:45.363
your application that you want to run and you can

00:04:45.363 --> 00:04:47.803
run this as like it's isolated application.

00:04:47.803 --> 00:04:48.603
So you can open

00:04:48.923 --> 00:04:51.163
user application inside of its own ide.

00:04:51.323 --> 00:04:53.203
You can forget about all of the other apps,

00:04:53.203 --> 00:04:55.163
all the other packages and you can just worry

00:04:55.163 --> 00:04:55.963
about building like

00:04:56.363 --> 00:04:58.173
one sub app at a time.

00:04:58.343 --> 00:05:00.343
and depending on what I'm working on or how I'm

00:05:00.343 --> 00:05:00.583
building,

00:05:00.583 --> 00:05:02.423
I kind of fall between both patterns.

00:05:02.423 --> 00:05:04.743
Sometimes I run the code at the root of the

00:05:04.743 --> 00:05:06.923
monorepo and then sometimes I'm really just

00:05:06.923 --> 00:05:09.243
focused on like one feature inside of the ui.

00:05:09.243 --> 00:05:11.003
And I don't want to worry about the mono repo.

00:05:11.003 --> 00:05:12.923
So we're going to bounce back and forth with this

00:05:12.923 --> 00:05:13.363
pattern.

00:05:13.423 --> 00:05:16.243
and what we're going to do is we're inside of our

00:05:16.243 --> 00:05:18.203
user application now and then we're just going to

00:05:18.203 --> 00:05:19.723
say pnpm run dev.

00:05:19.723 --> 00:05:21.563
We don't need to run that specific,

00:05:22.323 --> 00:05:23.763
we don't need to run that specific

00:05:24.403 --> 00:05:25.843
mono repo command.

00:05:26.003 --> 00:05:27.843
So we can go ahead and we can open our

00:05:28.066 --> 00:05:28.946
port 3,000.

00:05:29.149 --> 00:05:30.189
So we'll do that right here.

00:05:31.149 --> 00:05:33.829
And you can see we have this really just kind of

00:05:33.829 --> 00:05:34.989
like boilerplate ui.

00:05:34.989 --> 00:05:37.349
This is the landing page for our application.

00:05:37.349 --> 00:05:39.949
Most of the content is AI generated so don't pay

00:05:39.949 --> 00:05:40.909
too much attention to it.

00:05:40.909 --> 00:05:41.229
But

00:05:41.579 --> 00:05:43.708
this is just the marketing page and throughout

00:05:43.708 --> 00:05:45.509
this course at the very end we're going to add

00:05:45.509 --> 00:05:45.869
auth,

00:05:45.979 --> 00:05:47.069
we're going to add payments,

00:05:47.069 --> 00:05:48.509
we're going to go through that entire process.

00:05:48.589 --> 00:05:51.029
But right now this is all just kind of boilerplate

00:05:51.029 --> 00:05:53.189
hard coded stuff so we can click get started for

00:05:53.189 --> 00:05:53.469
free.

00:05:53.629 --> 00:05:54.573
What that's going to do is it's

00:05:54.739 --> 00:05:56.819
going to take us to the app page which is going to

00:05:56.819 --> 00:05:57.779
be the dashboard,

00:05:57.809 --> 00:05:58.902
that we're going to be building out.

00:05:59.135 --> 00:06:00.335
So sometimes,

00:06:00.335 --> 00:06:01.285
sometimes you get

00:06:01.288 --> 00:06:02.648
to go ahead and reload that guy.

00:06:02.882 --> 00:06:03.515
Okay,

00:06:03.515 --> 00:06:06.195
so this is the dashboard and all of this data that

00:06:06.195 --> 00:06:07.355
we have here is dummy data.

00:06:07.405 --> 00:06:09.575
but ultimately throughout this course what we're

00:06:09.575 --> 00:06:11.415
going to do is we're going to build out the data

00:06:11.415 --> 00:06:14.055
backend that's going to create all these analytics

00:06:14.055 --> 00:06:14.935
for us and then we're,

00:06:14.935 --> 00:06:17.205
we'll be able to surface them inside of our ui.

00:06:17.205 --> 00:06:18.225
we also have this,

00:06:18.225 --> 00:06:20.565
these region maps and essentially what happens is

00:06:20.565 --> 00:06:22.725
like when users click on links across the world

00:06:22.725 --> 00:06:24.445
we're going to be able to capture that data in

00:06:24.445 --> 00:06:26.285
real time and we're going to use web sockets to

00:06:26.285 --> 00:06:26.885
populate,

00:06:27.285 --> 00:06:28.925
we're going to use websockets to populate where

00:06:28.925 --> 00:06:30.925
those users are interactively on this map.

00:06:30.925 --> 00:06:33.085
So we're going to make use of like pretty cool

00:06:33.085 --> 00:06:33.975
feature in my opinion.

00:06:34.365 --> 00:06:36.365
and then just some obviously like other

00:06:36.795 --> 00:06:39.035
different analytics and different usability things

00:06:39.035 --> 00:06:40.635
inside of our application.

00:06:41.125 --> 00:06:42.705
we'll have the ability to look at links.

00:06:42.705 --> 00:06:44.185
You can obviously create a link,

00:06:44.805 --> 00:06:45.885
you can go view the links,

00:06:45.885 --> 00:06:48.285
you can edit different like routing logic for the

00:06:48.285 --> 00:06:50.165
link so you can say you want,

00:06:50.865 --> 00:06:54.425
everybody in Albania to route to a specific URL.

00:06:54.465 --> 00:06:56.345
this is all dummy data right now but we're going

00:06:56.345 --> 00:06:58.065
to be building all of this out throughout this

00:06:58.065 --> 00:06:58.345
course.

00:06:58.425 --> 00:06:58.825
So

00:06:59.144 --> 00:07:00.905
now that you have this front end working,

00:07:01.105 --> 00:07:03.265
what we're going to want to do is right off the

00:07:03.265 --> 00:07:04.425
bat we're going to want to deploy.

00:07:04.425 --> 00:07:06.985
I want us to be able to be very familiar with the

00:07:06.985 --> 00:07:07.945
cloudflare dashboard,

00:07:07.945 --> 00:07:10.215
the deployment process before we dive into,

00:07:10.605 --> 00:07:12.565
into any of the code at all because that's kind

00:07:12.565 --> 00:07:12.765
of,

00:07:12.765 --> 00:07:13.165
we're gonna,

00:07:13.165 --> 00:07:15.005
that's gonna be like the foundation for this

00:07:15.005 --> 00:07:17.085
course because we're gonna deploy so many times by

00:07:17.085 --> 00:07:17.685
the end of this course.

00:07:17.685 --> 00:07:19.725
I really hope that you have the ability to just

00:07:19.965 --> 00:07:20.325
really,

00:07:20.325 --> 00:07:22.365
really understand the deployment process because I

00:07:22.365 --> 00:07:24.105
think that's what really trips people up,

00:07:24.105 --> 00:07:25.645
when they're learning how to develop on a new

00:07:25.645 --> 00:07:27.445
platform is how do I ship my code,

00:07:27.445 --> 00:07:27.845
you know,

00:07:27.845 --> 00:07:29.565
and by the end of this course you're gonna have no

00:07:29.565 --> 00:07:30.125
issue with that,

00:07:30.125 --> 00:07:31.266
so let's go ahead and try to do that.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.000 --> 00:00:01.590
so deploying to Cloudflare is actually pretty

00:00:01.590 --> 00:00:02.190
straightforward.

00:00:02.190 --> 00:00:03.990
All you have to do is create a free Cloudflare

00:00:03.990 --> 00:00:05.470
account and you'll be taken to this page.

00:00:05.790 --> 00:00:07.270
Now there's a ton of different features that

00:00:07.270 --> 00:00:09.150
Cloudflare has to offer as they've been around for

00:00:09.150 --> 00:00:09.350
many,

00:00:09.350 --> 00:00:11.710
many years and they've really been known for their

00:00:11.710 --> 00:00:12.350
DNS,

00:00:12.510 --> 00:00:14.230
CDN and security features.

00:00:14.230 --> 00:00:16.510
But within the last five years their worker

00:00:16.510 --> 00:00:18.870
platform for COMPUTE has actually really been

00:00:18.870 --> 00:00:20.950
taken off and that's what we're going to be

00:00:20.950 --> 00:00:23.190
spending most of our time in is this section down

00:00:23.190 --> 00:00:23.430
here.

00:00:23.430 --> 00:00:25.430
So if you scroll down here you'll see we have

00:00:25.430 --> 00:00:26.500
COMPUTE work workers

00:00:26.581 --> 00:00:28.002
and under here we have a whole bunch of different

00:00:28.242 --> 00:00:28.642
products.

00:00:29.652 --> 00:00:31.332
the main thing that we're going to focus on right

00:00:31.332 --> 00:00:32.772
now is workers and pages.

00:00:33.092 --> 00:00:34.852
Now there's a lot of different ways to deploy and

00:00:34.852 --> 00:00:36.332
we're going to be going through many of them in

00:00:36.332 --> 00:00:36.772
this course.

00:00:36.772 --> 00:00:38.652
But to get started we're going to be using the

00:00:38.652 --> 00:00:39.131
CLI.

00:00:39.278 --> 00:00:41.878
So let's head back to our repo and let's navigate

00:00:41.878 --> 00:00:43.118
over to the apps

00:00:43.518 --> 00:00:44.558
user application.

00:00:44.558 --> 00:00:46.638
This is the UI application that we just barely

00:00:46.638 --> 00:00:47.038
ran.

00:00:47.198 --> 00:00:49.078
And let's head over to the very bottom where we

00:00:49.078 --> 00:00:50.718
see Wrangler JSON C.

00:00:51.118 --> 00:00:51.398
Now,

00:00:51.398 --> 00:00:54.118
this file is the configuration that instructs

00:00:54.118 --> 00:00:56.718
Cloudflare on how to deploy our code.

00:00:56.958 --> 00:00:57.638
It tells our,

00:00:57.638 --> 00:00:59.798
it tells Cloudflare exactly where the entry point

00:00:59.798 --> 00:01:00.878
for our application is.

00:01:01.448 --> 00:01:03.848
It gives our application a name that Cloudflare

00:01:03.848 --> 00:01:06.168
will use internally to basically keep track of the

00:01:06.168 --> 00:01:07.448
uniqueness of the application.

00:01:07.768 --> 00:01:09.088
And then we have a whole bunch of other

00:01:09.088 --> 00:01:09.848
configurations.

00:01:10.258 --> 00:01:12.538
this is a very small Wrangler file,

00:01:12.538 --> 00:01:12.818
but,

00:01:12.978 --> 00:01:13.418
you know,

00:01:13.418 --> 00:01:15.298
as we build out more and more features and we're

00:01:15.298 --> 00:01:16.418
using more and more resources,

00:01:16.498 --> 00:01:18.138
we're going to see that this file actually gets

00:01:18.138 --> 00:01:18.658
very large.

00:01:18.818 --> 00:01:19.218
So,

00:01:19.758 --> 00:01:22.038
there's really a lot of complexity around the

00:01:22.038 --> 00:01:23.518
Wrangler JSON C file.

00:01:23.518 --> 00:01:25.278
There's so many different features that Cloudflare

00:01:25.278 --> 00:01:25.718
has to offer,

00:01:25.718 --> 00:01:27.838
and they're all dictated by what we specify in

00:01:27.838 --> 00:01:28.358
this file.

00:01:28.358 --> 00:01:29.638
So throughout this course,

00:01:29.638 --> 00:01:30.708
we're going to go figure out

00:01:31.098 --> 00:01:33.178
deep into the different offerings and how to use

00:01:33.178 --> 00:01:35.058
the Wrangler JSON C file.

00:01:35.058 --> 00:01:36.618
And hopefully by the end of the course you'll be

00:01:36.618 --> 00:01:38.378
able to go through the documentation when you're

00:01:38.378 --> 00:01:40.258
building out new things or using new Cloudflare

00:01:40.258 --> 00:01:40.498
products,

00:01:40.498 --> 00:01:43.218
and you'll be able to seamlessly learn and be able

00:01:43.218 --> 00:01:43.658
to use,

00:01:43.658 --> 00:01:45.458
different features without really having to like,

00:01:45.458 --> 00:01:47.498
dive too deep into the documentation and try too

00:01:47.498 --> 00:01:47.778
hard.

00:01:47.858 --> 00:01:49.218
So just note,

00:01:49.298 --> 00:01:51.338
for the purposes of this deployment,

00:01:51.338 --> 00:01:53.338
for our very first deployment is this file

00:01:53.338 --> 00:01:54.818
instructs Cloudflare on

00:01:55.298 --> 00:01:56.338
what our code is,

00:01:56.338 --> 00:01:57.378
how to use it and,

00:01:57.448 --> 00:01:58.408
and then how to deploy it.

00:01:58.888 --> 00:01:59.128
Now,

00:01:59.128 --> 00:02:01.328
if we head over to our package JSON file,

00:02:01.328 --> 00:02:03.048
what we're going to notice is we have a,

00:02:03.678 --> 00:02:06.608
we have a deploy script that's running NPM run

00:02:06.608 --> 00:02:06.888
build,

00:02:06.888 --> 00:02:07.768
it's building our project,

00:02:07.848 --> 00:02:09.528
it's compiling it and

00:02:09.758 --> 00:02:11.968
bundling it in a way that is understandable by a

00:02:11.968 --> 00:02:12.848
Cloudflare worker.

00:02:13.168 --> 00:02:15.568
And then it is running Wrangler Deploy,

00:02:15.678 --> 00:02:16.468
this Wrangler

00:02:17.108 --> 00:02:17.828
dependency

00:02:18.388 --> 00:02:20.388
as what we will be able to see it at the very

00:02:20.388 --> 00:02:21.268
bottom of our

00:02:21.938 --> 00:02:22.769
dev dependencies.

00:02:22.769 --> 00:02:24.868
This is Cloudflare CLI tool that manages

00:02:24.868 --> 00:02:27.028
Cloudflare resources and deployments.

00:02:27.668 --> 00:02:28.548
This is the,

00:02:28.548 --> 00:02:29.748
this is honestly a very,

00:02:29.748 --> 00:02:30.228
very important

00:02:30.498 --> 00:02:33.138
CLI tool when you're working in Cloudflare and as

00:02:33.138 --> 00:02:35.178
you're using more and more different features,

00:02:35.178 --> 00:02:36.418
you'll learn what you can do.

00:02:36.418 --> 00:02:36.738
But

00:02:37.378 --> 00:02:39.418
90% of the time the only thing that you use

00:02:39.418 --> 00:02:40.978
Wrangler for is for

00:02:41.179 --> 00:02:42.539
just deploying your application.

00:02:42.699 --> 00:02:44.379
So what we're going to do is we're going to make

00:02:44.379 --> 00:02:47.019
sure we're in our User Application folder.

00:02:47.019 --> 00:02:48.299
So we'll head over to Apps

00:02:48.859 --> 00:02:49.880
User Application

00:02:50.900 --> 00:02:52.980
and then we're going to run pnpm,

00:02:53.220 --> 00:02:53.620
run

00:02:54.020 --> 00:02:54.660
deploy,

00:02:54.740 --> 00:02:56.684
which is this command right here.

00:02:56.922 --> 00:02:58.812
And we're going to notice that our application is

00:02:58.812 --> 00:02:59.132
building,

00:02:59.212 --> 00:03:01.652
it's creating a bundle of our entire front end

00:03:01.652 --> 00:03:02.252
application.

00:03:02.834 --> 00:03:04.274
And then what it's done is

00:03:04.594 --> 00:03:05.634
for your first time,

00:03:05.794 --> 00:03:06.694
what happens is it

00:03:06.694 --> 00:03:08.430
opens up a Chrome browser.

00:03:08.430 --> 00:03:09.690
Let me pull this on over right here.

00:03:09.690 --> 00:03:12.025
It opens up a browser that basically asks for your

00:03:12.025 --> 00:03:12.466
permission.

00:03:12.626 --> 00:03:13.202
So this

00:03:13.202 --> 00:03:13.292
browser.

00:03:13.292 --> 00:03:14.572
You're going to go ahead and you're going to say

00:03:14.572 --> 00:03:14.892
allow.

00:03:15.132 --> 00:03:16.252
This gives,

00:03:16.262 --> 00:03:18.322
the Wrangler CLI access to your cloudflare

00:03:18.322 --> 00:03:18.602
account.

00:03:19.102 --> 00:03:20.222
Now if we head back over here,

00:03:20.222 --> 00:03:21.742
we're going to see it's going to complete the

00:03:21.742 --> 00:03:23.982
build and right now it's taking all of these files

00:03:23.982 --> 00:03:26.142
that got bundled and it's uploading it to

00:03:26.142 --> 00:03:27.102
cloudflare servers.

00:03:27.102 --> 00:03:28.622
It's uploading the static files,

00:03:28.622 --> 00:03:29.382
the JS files,

00:03:29.382 --> 00:03:30.102
the HTML,

00:03:30.102 --> 00:03:30.742
the styles,

00:03:30.742 --> 00:03:31.582
it's uploading that

00:03:32.702 --> 00:03:35.342
to their cdn to servers all around the world so it

00:03:35.342 --> 00:03:37.182
can be served really quickly to users.

00:03:37.262 --> 00:03:39.422
And it's also uploading that server side code.

00:03:39.952 --> 00:03:42.266
so the worker runtime will be able to handle our

00:03:42.266 --> 00:03:44.146
HTTP requests in our application.

00:03:44.926 --> 00:03:47.206
So what you're going to notice here is it gave us

00:03:47.206 --> 00:03:48.046
this URL.

00:03:48.856 --> 00:03:52.496
this URL is basically you have like a email or a

00:03:52.496 --> 00:03:54.536
name that you signed up with cloudflare Workers

00:03:54.616 --> 00:03:54.936
Dev.

00:03:54.936 --> 00:03:56.456
And then you can see User Application,

00:03:56.456 --> 00:03:57.466
which is the name of our

00:03:57.466 --> 00:03:57.816
service.

00:03:58.056 --> 00:03:59.976
So we're going to go ahead and we're going to open

00:03:59.976 --> 00:04:00.376
this guy,

00:04:00.376 --> 00:04:02.096
I'm going to copy this and head back over to that

00:04:02.096 --> 00:04:02.936
browser window

00:04:03.388 --> 00:04:05.816
and you can see that we are actually able to view

00:04:05.816 --> 00:04:07.776
our deployed version of our website.

00:04:08.376 --> 00:04:10.576
we can head on over to the dashboard,

00:04:10.576 --> 00:04:12.336
you can see it's interactive and everything's

00:04:12.336 --> 00:04:13.176
working as expected.

00:04:13.336 --> 00:04:15.136
So deployment really is that simple.

00:04:15.136 --> 00:04:16.216
I know I explained a lot,

00:04:16.216 --> 00:04:18.416
but the takeaway is you can run npm,

00:04:18.416 --> 00:04:19.056
run Deploy,

00:04:19.056 --> 00:04:21.376
that's calling the Wrangler Deploy command and

00:04:21.376 --> 00:04:23.456
it's uploading all of your static assets and your

00:04:23.456 --> 00:04:25.456
server side code up to Cloudflare servers,

00:04:25.456 --> 00:04:28.376
so it's able to be used by the worker runtime.

00:04:28.726 --> 00:04:30.796
one other thing to note is if we head back over

00:04:30.796 --> 00:04:33.316
Here to our workers and pages in the Cloudflare

00:04:33.316 --> 00:04:33.916
Dashboard,

00:04:33.996 --> 00:04:35.916
you'll be able to see the entry of this

00:04:35.916 --> 00:04:38.076
application and you can click on it and there's a

00:04:38.076 --> 00:04:38.876
whole bunch of stuff here.

00:04:39.576 --> 00:04:41.176
See deployments when they occurred.

00:04:41.496 --> 00:04:43.296
you can look at metrics about usage.

00:04:43.296 --> 00:04:44.936
So whenever you get requests,

00:04:44.936 --> 00:04:46.416
you can see the analytics here,

00:04:46.416 --> 00:04:47.416
sub requests.

00:04:47.416 --> 00:04:49.136
you'll be able to see error traces.

00:04:49.906 --> 00:04:52.346
since we have enabled inside of our Wrangler

00:04:52.346 --> 00:04:52.866
config,

00:04:53.845 --> 00:04:55.965
since we have observability enabled,

00:04:55.965 --> 00:04:58.245
we'll be able to see logs come in.

00:04:58.245 --> 00:04:59.486
whenever we get requests,

00:04:59.710 --> 00:05:01.070
we'll be able to see bindings.

00:05:01.150 --> 00:05:02.230
we'll touch on this later.

00:05:02.710 --> 00:05:05.350
But essentially we have an asset binding which is

00:05:05.350 --> 00:05:05.670
the,

00:05:05.810 --> 00:05:06.790
static files,

00:05:06.790 --> 00:05:07.710
the JavaScript files,

00:05:07.710 --> 00:05:09.110
the HTML files for,

00:05:09.190 --> 00:05:10.676
from the bundle of our application.

00:05:10.676 --> 00:05:11.978
And then we have settings.

00:05:11.978 --> 00:05:14.298
And we're going to go very deep into a lot of

00:05:14.298 --> 00:05:15.658
these different things throughout the course.

00:05:15.658 --> 00:05:17.618
But just know that this is the interface that we

00:05:17.618 --> 00:05:17.978
can be,

00:05:17.978 --> 00:05:19.058
that we can interface with,

00:05:19.058 --> 00:05:22.158
if you enjoy using or if you want to use a UI

00:05:22.158 --> 00:05:23.078
provided by Cloudflare.

00:05:23.078 --> 00:05:24.798
Now all of this stuff can also be managed through

00:05:24.798 --> 00:05:25.758
the Wrangler cli,

00:05:25.758 --> 00:05:26.638
which we just looked at.

00:05:26.638 --> 00:05:26.998
But,

00:05:27.858 --> 00:05:29.538
very often you just kind of come over to the

00:05:29.538 --> 00:05:29.898
Dashboard,

00:05:29.898 --> 00:05:31.658
find your application and you can manage stuff

00:05:31.658 --> 00:05:31.848
here.

00:05:31.988 --> 00:05:32.948
another thing to note,

00:05:32.948 --> 00:05:33.828
domains and routes.

00:05:33.908 --> 00:05:36.108
So we'll be able to hook up our own domain,

00:05:36.108 --> 00:05:37.628
which we'll be doing towards the end of the

00:05:37.628 --> 00:05:37.908
course,

00:05:38.108 --> 00:05:38.668
as well.

00:05:38.668 --> 00:05:40.228
So this is the deployment process.

00:05:40.228 --> 00:05:41.148
You're going to become very,

00:05:41.148 --> 00:05:42.908
very familiar with this throughout the entire

00:05:42.908 --> 00:05:43.227
course.

00:05:43.227 --> 00:05:44.988
But at this point you should have

00:05:45.468 --> 00:05:47.228
a deployed version of your application

00:05:47.628 --> 00:05:49.548
ready to go and usable.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.000 --> 00:00:00.124
Now,

00:00:00.124 --> 00:00:01.684
before we start actively building out this

00:00:01.684 --> 00:00:01.964
project,

00:00:01.964 --> 00:00:03.764
I think it's really important to understand some

00:00:03.764 --> 00:00:05.804
key concepts about the worker runtime.

00:00:05.884 --> 00:00:07.364
The worker runtime is very unique.

00:00:07.364 --> 00:00:09.164
If you're going to compare it to other compute

00:00:09.164 --> 00:00:09.764
platforms,

00:00:09.764 --> 00:00:12.404
the main reason is because it runs entirely on VA

00:00:12.404 --> 00:00:12.905
isolates.

00:00:13.819 --> 00:00:15.819
Vite ISOs were originally created by a team in

00:00:15.819 --> 00:00:17.939
Google with the goal of building a lightweight

00:00:17.939 --> 00:00:20.339
performant JavaScript runtime that allows them to

00:00:20.339 --> 00:00:22.859
isolate code to run in individual tabs on a

00:00:22.859 --> 00:00:23.339
browser.

00:00:23.419 --> 00:00:25.619
This helped them increase security and also made

00:00:25.619 --> 00:00:26.110
the browser a

00:00:26.110 --> 00:00:27.423
A much more performant application.

00:00:27.932 --> 00:00:28.052
Now,

00:00:28.052 --> 00:00:30.332
considering the v8 runtime was originally intended

00:00:30.332 --> 00:00:32.532
to help speed up the performance of a browser,

00:00:32.532 --> 00:00:33.612
you might be wondering,

00:00:33.852 --> 00:00:35.652
why would I actually want to run this on the

00:00:35.652 --> 00:00:36.092
server?

00:00:36.252 --> 00:00:37.612
And in order to understand this,

00:00:37.612 --> 00:00:39.652
we kind of have to take a step back and look at

00:00:39.652 --> 00:00:41.412
how web applications have been deployed really

00:00:41.412 --> 00:00:42.422
since the beginning of the Internet.

00:00:43.242 --> 00:00:45.322
Now traditionally software engineers would build

00:00:45.322 --> 00:00:47.162
their application and they would deploy it to a

00:00:47.162 --> 00:00:47.802
single server.

00:00:47.802 --> 00:00:49.482
And this single server would be,

00:00:49.482 --> 00:00:51.762
that would be running some type of HTTP handler

00:00:51.762 --> 00:00:53.722
and then it would receive requests from the

00:00:53.722 --> 00:00:54.082
Internet.

00:00:54.082 --> 00:00:55.402
That's what this little guy is right here.

00:00:55.812 --> 00:00:56.862
it would take that request,

00:00:56.862 --> 00:00:57.502
it would process,

00:00:57.502 --> 00:00:59.062
it would respond to the user.

00:00:59.142 --> 00:00:59.542
And

00:00:59.932 --> 00:01:01.822
then if you wanted to handle lots and lots and

00:01:01.822 --> 00:01:02.542
lots of requests,

00:01:02.542 --> 00:01:04.262
you would have a beefier server,

00:01:04.262 --> 00:01:05.222
you'd have more cores,

00:01:05.222 --> 00:01:07.342
you would be able to handle more processing at the

00:01:07.342 --> 00:01:08.062
exact same time.

00:01:08.592 --> 00:01:09.272
and this model,

00:01:09.272 --> 00:01:09.592
you know,

00:01:09.592 --> 00:01:10.752
it works to a certain extent,

00:01:10.752 --> 00:01:13.192
but eventually you either get too many requests

00:01:13.192 --> 00:01:14.312
that might overwhelm the server.

00:01:14.312 --> 00:01:15.662
If like you have a ton of users,

00:01:15.762 --> 00:01:16.522
or you know,

00:01:16.522 --> 00:01:18.482
maybe you have a server issue or a network issue,

00:01:18.482 --> 00:01:20.042
or there's something at the data center that,

00:01:20.042 --> 00:01:21.442
where the server is deployed at,

00:01:21.442 --> 00:01:22.082
where there's,

00:01:22.082 --> 00:01:22.722
there's a problem.

00:01:22.882 --> 00:01:25.642
And then during that period of time your server is

00:01:25.642 --> 00:01:28.042
not able to respond to requests and it has

00:01:28.042 --> 00:01:28.642
downtime.

00:01:28.642 --> 00:01:29.042
So

00:01:29.362 --> 00:01:31.642
a very common pattern which essentially all

00:01:31.642 --> 00:01:33.922
production ready applications are following is

00:01:33.922 --> 00:01:34.322
they

00:01:35.032 --> 00:01:36.952
deploy their service to multiple servers

00:01:37.352 --> 00:01:39.112
that act as a distributed system.

00:01:39.112 --> 00:01:40.792
And in the middle or right before,

00:01:41.552 --> 00:01:42.272
those requests,

00:01:42.272 --> 00:01:44.392
there's another service called a load balancer or

00:01:44.392 --> 00:01:45.072
a proxy.

00:01:45.152 --> 00:01:47.592
And essentially it receives these requests and

00:01:47.592 --> 00:01:48.452
then it routes it,

00:01:48.612 --> 00:01:50.852
usually in a smart way to like the nearest server

00:01:50.852 --> 00:01:51.532
from the user.

00:01:51.532 --> 00:01:52.772
And then if this,

00:01:52.772 --> 00:01:53.132
you know,

00:01:53.132 --> 00:01:54.692
server server number three goes down,

00:01:55.012 --> 00:01:57.012
the load balancer is able to detect that pretty

00:01:57.012 --> 00:01:58.932
early on and it's able to route those requests to

00:01:58.932 --> 00:01:59.652
other servers.

00:01:59.652 --> 00:02:01.292
Now this model works really,

00:02:01.292 --> 00:02:01.692
really well.

00:02:01.692 --> 00:02:02.322
You can be built,

00:02:02.392 --> 00:02:02.712
build very,

00:02:02.712 --> 00:02:04.472
very scalable web applications.

00:02:04.632 --> 00:02:05.772
but the downside is,

00:02:05.772 --> 00:02:07.252
is it can be really expensive,

00:02:07.652 --> 00:02:09.332
especially if you don't have a ton of traffic.

00:02:09.332 --> 00:02:09.572
You know,

00:02:09.572 --> 00:02:10.532
if you're not handling

00:02:11.012 --> 00:02:12.892
hundreds of millions of requests every single

00:02:12.892 --> 00:02:13.172
month,

00:02:13.172 --> 00:02:14.492
you might really like this.

00:02:14.492 --> 00:02:16.332
This model might not make a whole lot of sense

00:02:16.332 --> 00:02:18.332
because you're paying so much for every single

00:02:18.332 --> 00:02:19.932
server to be running all the time.

00:02:19.932 --> 00:02:20.292
And

00:02:20.572 --> 00:02:21.072
for your,

00:02:21.392 --> 00:02:22.952
for your service to be considered actually

00:02:22.952 --> 00:02:24.152
resilient production ready,

00:02:24.152 --> 00:02:26.192
you probably need at least three servers.

00:02:26.192 --> 00:02:27.332
even if you don't even,

00:02:27.332 --> 00:02:28.772
you don't necessarily need to hand.

00:02:29.012 --> 00:02:30.372
Even if you don't have enough traffic

00:02:30.652 --> 00:02:32.652
to warrant those three servers for your

00:02:32.652 --> 00:02:34.252
application to be considered production ready,

00:02:34.252 --> 00:02:35.212
that's kind of required.

00:02:35.868 --> 00:02:38.028
so that's where this concept of serverless compute

00:02:38.028 --> 00:02:38.468
comes in.

00:02:38.468 --> 00:02:38.868
You know,

00:02:38.868 --> 00:02:42.108
serverless compute isn't necessarily a compute

00:02:42.108 --> 00:02:42.748
without a server,

00:02:42.748 --> 00:02:44.668
because obviously you need a server to handle

00:02:44.668 --> 00:02:45.708
requests and to actually

00:02:46.188 --> 00:02:47.508
deploy and run your code.

00:02:47.508 --> 00:02:49.428
But essentially what they did is they said,

00:02:49.428 --> 00:02:52.148
and I think this was made popular by AWS Lambda,

00:02:52.148 --> 00:02:53.708
but I don't think they were the first provider of

00:02:53.708 --> 00:02:54.668
serverless compute.

00:02:54.908 --> 00:02:56.068
But essentially what they said is,

00:02:56.068 --> 00:02:58.828
what if we took the logic of receiving these

00:02:58.828 --> 00:03:01.108
requests from the Internet or from some service,

00:03:01.108 --> 00:03:01.697
and then

00:03:01.931 --> 00:03:04.211
what if we built out a layer of being able to

00:03:04.211 --> 00:03:04.731
determine

00:03:05.051 --> 00:03:07.131
when we should take code and when we should turn

00:03:07.131 --> 00:03:09.371
servers on and when we should execute requests.

00:03:09.451 --> 00:03:11.291
So essentially they built this serverless

00:03:11.291 --> 00:03:13.131
scheduler and then what they would do is their

00:03:13.131 --> 00:03:15.451
service would receive a request and based upon

00:03:15.451 --> 00:03:15.771
the,

00:03:16.090 --> 00:03:17.771
based upon the URL or the,

00:03:17.771 --> 00:03:19.691
the host that was trying to access it,

00:03:19.771 --> 00:03:21.291
it would know where it should route to.

00:03:21.291 --> 00:03:23.371
So it would know that it needs to go to your,

00:03:23.611 --> 00:03:25.691
needs to take your code and it needs to put it on

00:03:25.691 --> 00:03:27.131
a server and needs to execute,

00:03:27.531 --> 00:03:28.131
the request.

00:03:28.131 --> 00:03:30.451
And then once it's no longer receiving requests,

00:03:30.451 --> 00:03:31.371
the server can bas

00:03:31.671 --> 00:03:31.991
go away,

00:03:31.991 --> 00:03:33.351
and then you're not going to be billed for that

00:03:33.351 --> 00:03:34.991
time when you're not getting any requests.

00:03:34.991 --> 00:03:35.351
So

00:03:35.751 --> 00:03:37.591
essentially they were able to build a scheduling

00:03:37.591 --> 00:03:38.071
like a.

00:03:38.311 --> 00:03:40.031
So essentially they were able to build a layer

00:03:40.031 --> 00:03:42.231
that could orchestrate the management of servers

00:03:42.551 --> 00:03:43.911
at a request basis,

00:03:44.471 --> 00:03:46.671
which makes it so you don't need to follow this

00:03:46.671 --> 00:03:48.371
model of always having these servers on.

00:03:48.371 --> 00:03:49.891
there was some considerations here.

00:03:49.891 --> 00:03:50.131
You,

00:03:50.131 --> 00:03:51.771
you took a performance hit because this is,

00:03:51.771 --> 00:03:52.691
in my opinion,

00:03:52.851 --> 00:03:55.131
the most performant way to run an application is

00:03:55.131 --> 00:03:56.371
to have servers always on,

00:03:56.371 --> 00:03:57.371
close to the user,

00:03:57.371 --> 00:03:58.571
ready to receive a request.

00:03:58.571 --> 00:04:00.251
I don't think serverless is ever going to

00:04:00.251 --> 00:04:02.131
necessarily beat this model,

00:04:02.131 --> 00:04:04.671
but in terms of price and efficiency,

00:04:05.391 --> 00:04:07.911
the serverless route worked for a lot of

00:04:07.911 --> 00:04:08.511
applications.

00:04:08.551 --> 00:04:10.751
because the complexity of managing where the

00:04:10.751 --> 00:04:13.151
requests go and when servers should be turned on

00:04:13.151 --> 00:04:14.791
was taken care of by the provider.

00:04:15.111 --> 00:04:15.911
In this example,

00:04:15.911 --> 00:04:16.969
AWS Lambda.

00:04:17.965 --> 00:04:20.885
Now behind the scenes AWS Lambda is doing a lot of

00:04:20.885 --> 00:04:21.565
different things.

00:04:21.885 --> 00:04:24.525
You are going to write your code and you're going

00:04:24.525 --> 00:04:27.045
to handle requests based upon the code that you

00:04:27.045 --> 00:04:27.565
define.

00:04:27.805 --> 00:04:30.285
But in order for a request to make it to your

00:04:30.285 --> 00:04:30.525
code,

00:04:30.525 --> 00:04:32.645
there's a whole bunch of stuff that goes on in the

00:04:32.645 --> 00:04:33.285
serverless world.

00:04:33.285 --> 00:04:34.125
And this is going to be,

00:04:34.125 --> 00:04:35.245
this is applicable to

00:04:36.025 --> 00:04:37.305
the worker runtime,

00:04:37.305 --> 00:04:39.305
this is applicable to aws,

00:04:39.305 --> 00:04:41.825
this is also applicable to Netlify and Vercel.

00:04:41.825 --> 00:04:43.305
And really anywhere you're going to ship to

00:04:43.305 --> 00:04:44.425
serverless Compute,

00:04:44.745 --> 00:04:45.535
essentially you have,

00:04:45.685 --> 00:04:48.165
have under AWS Lambda there's a series of steps

00:04:48.165 --> 00:04:48.485
that happen.

00:04:48.485 --> 00:04:49.845
If it receives a request

00:04:50.325 --> 00:04:51.285
for the very first time,

00:04:51.285 --> 00:04:53.485
you have some request routing logic that

00:04:53.485 --> 00:04:53.925
determines,

00:04:53.925 --> 00:04:54.365
you know,

00:04:54.365 --> 00:04:54.725
like

00:04:55.455 --> 00:04:56.735
where that request should go,

00:04:56.895 --> 00:04:57.455
what region,

00:04:57.455 --> 00:04:58.385
what data center.

00:04:58.385 --> 00:05:00.455
then you have a Lambda scheduler that's going to

00:05:00.614 --> 00:05:03.295
determine if it needs to provision servers for

00:05:03.295 --> 00:05:04.535
that specific requests.

00:05:04.545 --> 00:05:07.365
it can determine if there's going if your code is

00:05:07.365 --> 00:05:09.365
already warm or if your code has already been

00:05:09.365 --> 00:05:11.445
loaded and is actively on a server right now,

00:05:11.445 --> 00:05:13.885
or if it has to go provision a new server for you.

00:05:13.885 --> 00:05:16.275
So there's this layer of basically server managed

00:05:16.745 --> 00:05:17.825
at the request layer.

00:05:17.825 --> 00:05:19.465
And this can actually take quite some time.

00:05:19.465 --> 00:05:20.665
If you look online,

00:05:20.665 --> 00:05:22.385
their docs say cold start.

00:05:22.385 --> 00:05:24.345
So like the slowest that you would expect would be

00:05:24.585 --> 00:05:27.145
50 to 150 milliseconds for that to start up.

00:05:27.175 --> 00:05:28.625
and then you have the runtime boot.

00:05:28.625 --> 00:05:30.545
So because this is actually like running a

00:05:30.545 --> 00:05:31.065
traditional

00:05:31.135 --> 00:05:33.745
is running on a runtime that's more akin to an

00:05:33.745 --> 00:05:34.825
actual beefy server.

00:05:34.825 --> 00:05:35.847
Like what we see over here,

00:05:35.847 --> 00:05:37.195
what happens is that

00:05:38.075 --> 00:05:40.115
runtime or that environment has to get ready and

00:05:40.115 --> 00:05:41.995
it's like a very lightweight version of what you'd

00:05:41.995 --> 00:05:43.515
be running on one of these servers.

00:05:44.125 --> 00:05:46.085
But it still takes quite some time to spin up.

00:05:46.085 --> 00:05:48.045
So you have to instantiate the environment.

00:05:48.465 --> 00:05:50.485
you have to load all of your environment variables

00:05:50.485 --> 00:05:51.165
and it has to be,

00:05:51.165 --> 00:05:53.245
your code has to basically the environment has to

00:05:53.245 --> 00:05:55.325
be in a state that's ready for your code to run.

00:05:55.485 --> 00:05:56.525
This process can take

00:05:57.085 --> 00:05:58.288
20 to 80 milliseconds.

00:05:58.468 --> 00:05:59.828
and then once that's done,

00:06:00.308 --> 00:06:02.228
Lambda is going to have to basically go say okay,

00:06:02.228 --> 00:06:04.428
like where we need to get their code and we have

00:06:04.428 --> 00:06:06.748
to put it in this environment so we can run it.

00:06:06.748 --> 00:06:08.668
So typically what it's going to do is it's going

00:06:08.668 --> 00:06:10.468
to pull that code from S3.

00:06:10.668 --> 00:06:11.808
I think that's how Lambda does it.

00:06:11.808 --> 00:06:14.448
And then they bring it in into memory and it gets

00:06:14.448 --> 00:06:17.528
instantiated and then once that process is done

00:06:17.768 --> 00:06:20.048
now your code is ready to be invoked so the

00:06:20.048 --> 00:06:22.728
handler that you define to process that request is

00:06:22.728 --> 00:06:23.848
finally invoked.

00:06:24.168 --> 00:06:24.998
Now this is

00:06:24.998 --> 00:06:26.338
the worst case scenario because,

00:06:26.338 --> 00:06:28.128
this step is going to take quite some time.

00:06:28.368 --> 00:06:30.128
This step is going to take quite some time.

00:06:30.368 --> 00:06:32.288
This step is going to take quite some time.

00:06:32.368 --> 00:06:34.048
And then you finally handle,

00:06:34.628 --> 00:06:36.708
the actual request that comes in.

00:06:37.108 --> 00:06:37.508
Now,

00:06:37.538 --> 00:06:39.528
in a scenario where you just got a request and

00:06:39.528 --> 00:06:41.528
then another request is made and this process has

00:06:41.528 --> 00:06:42.328
already been done,

00:06:42.358 --> 00:06:43.708
the router is basically going to say,

00:06:43.708 --> 00:06:44.148
okay,

00:06:44.148 --> 00:06:46.908
let's just go pass that request off to the handler

00:06:46.908 --> 00:06:47.988
and then it's going to be pretty quick.

00:06:47.988 --> 00:06:49.828
But cold starts have been a problem and companies

00:06:49.828 --> 00:06:52.468
like Vercel have innovated a lot on top of AWS

00:06:52.468 --> 00:06:54.908
Lambda to help with the performance and also price

00:06:54.908 --> 00:06:55.228
control.

00:06:55.228 --> 00:06:55.506
Here.

00:06:56.258 --> 00:06:58.098
Now when you run your code on Cloudflare workers,

00:06:58.178 --> 00:07:00.338
there's a very similar flow that happens before

00:07:00.338 --> 00:07:01.538
your code is executed.

00:07:01.538 --> 00:07:03.778
It's just considerably more efficient and really,

00:07:03.778 --> 00:07:04.458
really snappy.

00:07:04.458 --> 00:07:06.178
So we can kind of go through that process right

00:07:06.178 --> 00:07:06.418
now.

00:07:06.418 --> 00:07:08.578
So essentially there's a request routing layer

00:07:08.738 --> 00:07:11.218
which determines where that request should go.

00:07:11.408 --> 00:07:14.388
and then there's an isolate selections or creation

00:07:14.388 --> 00:07:14.828
layer.

00:07:14.828 --> 00:07:16.948
So essentially what happens here is the worker

00:07:16.948 --> 00:07:17.588
runtime says,

00:07:17.588 --> 00:07:17.988
hey,

00:07:18.258 --> 00:07:19.138
I got this request.

00:07:19.138 --> 00:07:21.458
I want to go see if the code that's supposed to

00:07:21.458 --> 00:07:24.218
run this request is already living on some isolate

00:07:24.218 --> 00:07:25.218
out there that I can use.

00:07:25.378 --> 00:07:26.378
And if it's not there,

00:07:26.378 --> 00:07:27.978
it's going to go create that isolate.

00:07:27.978 --> 00:07:31.178
Now this isolate creation step is very similar to

00:07:31.178 --> 00:07:32.738
what you're going to see here during the lambda

00:07:32.738 --> 00:07:33.998
scheduler in the bootstrap,

00:07:33.998 --> 00:07:34.318
the run,

00:07:34.318 --> 00:07:36.878
the runtime bootstrap from AWS Lambda.

00:07:36.958 --> 00:07:39.238
But the only difference is the way that it's

00:07:39.238 --> 00:07:41.358
designed is it's incredibly snappy because it's

00:07:41.358 --> 00:07:43.078
very similar to a browser where it's able to get

00:07:43.078 --> 00:07:44.838
that code and just get it instantiated running

00:07:44.838 --> 00:07:45.038
really,

00:07:45.038 --> 00:07:45.598
really quickly.

00:07:45.598 --> 00:07:47.158
So the creation process,

00:07:47.158 --> 00:07:48.558
if you look on Cloudflare's docs,

00:07:48.558 --> 00:07:49.438
they say it takes about

00:07:49.898 --> 00:07:51.018
milliseconds for that to happen,

00:07:51.018 --> 00:07:52.298
which is insanely fast.

00:07:52.298 --> 00:07:54.058
It's not going to be noticeable by the user.

00:07:54.058 --> 00:07:54.288
And

00:07:54.288 --> 00:07:56.278
when they say virtually no cold starts with a

00:07:56.278 --> 00:07:58.438
caveat of 5 milliseconds when there is a cold

00:07:58.438 --> 00:07:58.638
start.

00:07:58.638 --> 00:07:59.318
That's what they mean.

00:07:59.318 --> 00:07:59.758
Like it's,

00:07:59.758 --> 00:08:00.638
it's very snappy.

00:08:01.548 --> 00:08:02.308
and you know,

00:08:02.308 --> 00:08:03.908
if there is an isolate already running,

00:08:03.908 --> 00:08:06.028
it selects that and then you kind of bypass that

00:08:06.028 --> 00:08:06.828
creation process.

00:08:07.338 --> 00:08:08.938
and then the step right before

00:08:09.258 --> 00:08:10.618
your code runs is

00:08:10.938 --> 00:08:12.218
the request object

00:08:12.698 --> 00:08:13.338
construction.

00:08:13.338 --> 00:08:16.098
So essentially Cloudflare has to get the data that

00:08:16.098 --> 00:08:18.058
is sent in a format and in a,

00:08:18.058 --> 00:08:18.538
in a

00:08:18.998 --> 00:08:21.678
standard request format that is understandable by

00:08:21.678 --> 00:08:22.238
your worker.

00:08:22.238 --> 00:08:24.518
And then that's kind of what you receive inside of

00:08:24.518 --> 00:08:26.638
your worker code when you're building and you're

00:08:26.638 --> 00:08:26.828
actually

00:08:26.888 --> 00:08:28.478
building on top of the worker runtime.

00:08:28.478 --> 00:08:31.398
So it gets that object ready and then it passes it

00:08:31.398 --> 00:08:33.918
to your worker which contains your business logic,

00:08:33.918 --> 00:08:34.998
your application code,

00:08:34.998 --> 00:08:36.038
and then it executes.

00:08:36.038 --> 00:08:37.438
So the flow is very similar.

00:08:37.438 --> 00:08:38.958
It's just so much faster,

00:08:39.008 --> 00:08:39.798
in terms of

00:08:40.198 --> 00:08:41.678
performance and efficiency.

00:08:41.678 --> 00:08:43.678
And it's much cheaper to run this type of

00:08:43.678 --> 00:08:45.358
environment because you're not running like a

00:08:45.358 --> 00:08:45.598
really,

00:08:45.598 --> 00:08:46.358
really fat,

00:08:47.268 --> 00:08:49.878
node based image or a Firecra record based

00:08:50.538 --> 00:08:50.915
vm.

00:08:51.058 --> 00:08:52.936
You're running a runtime that's very lightweight.

00:08:52.936 --> 00:08:54.086
there's some limitations there,

00:08:54.086 --> 00:08:56.286
but it's also really fast to build on top of

00:08:56.360 --> 00:08:58.386
Now there's also pricing considerations when

00:08:58.386 --> 00:09:00.986
you're going to deploy onto a serverless runtime.

00:09:00.986 --> 00:09:02.426
And this is where I think Cloudflare really,

00:09:02.426 --> 00:09:02.986
really shines.

00:09:02.986 --> 00:09:05.306
They made a bet early on that has really worked

00:09:05.306 --> 00:09:06.906
out for them and we'll kind of go over why.

00:09:07.066 --> 00:09:09.226
So if we look at AWS Lambda,

00:09:09.226 --> 00:09:10.546
you're going to be billed for the number of

00:09:10.546 --> 00:09:13.666
requests that you receive plus the amount of time

00:09:13.666 --> 00:09:14.426
that your code

00:09:14.906 --> 00:09:15.786
spent running.

00:09:15.946 --> 00:09:17.466
So an example of this is going to be,

00:09:17.466 --> 00:09:20.066
let's say your service or your handler gets a

00:09:20.066 --> 00:09:20.506
request

00:09:20.986 --> 00:09:23.466
and from the time it gets a request to the time it

00:09:23.466 --> 00:09:24.266
fulfills that requ

00:09:24.566 --> 00:09:26.726
it takes one second or 100 milliseconds.

00:09:27.176 --> 00:09:28.886
let's say during that time your,

00:09:28.886 --> 00:09:31.126
your code processes the request and it reaches out

00:09:31.126 --> 00:09:33.006
to OpenAI to do some,

00:09:33.086 --> 00:09:34.606
to do some text generation.

00:09:35.086 --> 00:09:37.486
That text generation takes 800 milliseconds to

00:09:37.486 --> 00:09:37.966
resolve.

00:09:37.966 --> 00:09:39.566
Then your server gets the response,

00:09:39.856 --> 00:09:41.736
does a little bit more processing and then it

00:09:41.736 --> 00:09:43.816
returns the response back to the user.

00:09:43.816 --> 00:09:45.896
So this entire operation takes

00:09:46.216 --> 00:09:47.976
1 second or 100 milliseconds.

00:09:48.056 --> 00:09:50.136
Your build for the entire duration

00:09:50.496 --> 00:09:51.216
of this request.

00:09:51.796 --> 00:09:52.916
now there's,

00:09:52.916 --> 00:09:54.996
there's some companies like Vercel,

00:09:54.996 --> 00:09:56.796
they've recently come out with solutions where

00:09:56.796 --> 00:09:59.876
they're able to do some type of like compute based

00:10:00.036 --> 00:10:02.196
billing instead of like entire duration based

00:10:02.196 --> 00:10:02.676
billing.

00:10:02.916 --> 00:10:04.836
And I'm not entirely sure what they're doing

00:10:04.836 --> 00:10:06.276
behind the scenes to make that happen.

00:10:06.356 --> 00:10:08.556
But if you're just looking at AWS Lambda,

00:10:08.556 --> 00:10:10.996
this is the typical like pricing model and then a

00:10:10.996 --> 00:10:13.196
lot of other providers that have built on top of

00:10:13.196 --> 00:10:14.116
AWS Lambda,

00:10:14.116 --> 00:10:15.916
now this actually might change in the next few

00:10:15.916 --> 00:10:16.596
years because

00:10:16.916 --> 00:10:19.436
so many applications are spending 15 seconds

00:10:19.436 --> 00:10:21.556
waiting for a AI prompt,

00:10:21.776 --> 00:10:24.336
an AI generation to resolve and it's just like

00:10:24.336 --> 00:10:25.496
ballooning prices.

00:10:25.496 --> 00:10:27.296
So this is something that I feel like in the

00:10:27.296 --> 00:10:28.616
serverless world has to change.

00:10:28.616 --> 00:10:29.336
But you know,

00:10:29.336 --> 00:10:31.096
five years ago when Cloudflare came out with the

00:10:31.096 --> 00:10:33.096
workers and they had their pricing model they kind

00:10:33.096 --> 00:10:35.296
of designed for AI before AI was a big deal.

00:10:35.836 --> 00:10:37.715
and the reason why is like let's take that same

00:10:37.715 --> 00:10:38.746
request that's going to take

00:10:38.806 --> 00:10:41.156
1000 milliseconds or 1 second to fulfill.

00:10:41.316 --> 00:10:43.756
And then 800 milliseconds is just waiting for an

00:10:43.756 --> 00:10:44.756
API to respond.

00:10:44.916 --> 00:10:47.636
You're only billed for the active CPU time.

00:10:47.716 --> 00:10:48.376
So you,

00:10:48.446 --> 00:10:49.886
any IO related operation,

00:10:49.886 --> 00:10:51.126
reaching out to a database,

00:10:51.126 --> 00:10:52.926
reaching out to an API provider,

00:10:53.016 --> 00:10:55.833
sticking data in storage or R2 or object storage,

00:10:55.833 --> 00:10:58.482
really any operation that isn't just running

00:10:58.482 --> 00:10:59.922
actual code on that server,

00:10:59.922 --> 00:11:03.042
like crunching data on the CPU you're not built

00:11:03.042 --> 00:11:03.322
for.

00:11:03.322 --> 00:11:06.442
So typically a request like that takes one second

00:11:06.442 --> 00:11:07.122
to fulfill,

00:11:07.122 --> 00:11:08.962
especially if it's just reaching out to APIs and

00:11:08.962 --> 00:11:09.562
databases.

00:11:09.722 --> 00:11:10.162
You see,

00:11:10.162 --> 00:11:12.472
it's like 8 milliseconds or 9 milliseconds in

00:11:12.472 --> 00:11:14.072
compute time and you're only billed for that.

00:11:14.072 --> 00:11:15.232
So you're built for the request,

00:11:15.232 --> 00:11:17.472
which is way cheaper than any other serverless

00:11:18.532 --> 00:11:19.172
that I've seen.

00:11:19.172 --> 00:11:20.932
And then you're only billed for the CPU time,

00:11:20.932 --> 00:11:21.572
which is crazy.

00:11:21.572 --> 00:11:22.572
So like the pricing,

00:11:22.572 --> 00:11:24.492
you're able to really control pricing with this

00:11:24.492 --> 00:11:24.892
model.

00:11:24.892 --> 00:11:26.132
Especially in a world where

00:11:26.451 --> 00:11:28.172
so much of what we do is just integrating with

00:11:28.172 --> 00:11:30.070
other services and we need just a lightweight.

00:11:30.070 --> 00:11:31.867
We need a lightweight application that is just

00:11:31.867 --> 00:11:33.267
going to kind of get a request,

00:11:33.347 --> 00:11:34.707
go reach out to a database,

00:11:34.707 --> 00:11:36.227
stick some data in R2,

00:11:36.227 --> 00:11:36.787
pull some,

00:11:36.787 --> 00:11:38.867
pull an image from Object Storage.

00:11:38.867 --> 00:11:40.787
Just these typical operations that we're doing

00:11:41.307 --> 00:11:43.587
within our code is just so cheap to do on

00:11:43.587 --> 00:11:44.187
cloudflare.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.672 --> 00:00:00.792
Now,

00:00:00.792 --> 00:00:01.272
in my opinion,

00:00:01.272 --> 00:00:03.432
if you're a full stack developer that primarily

00:00:03.432 --> 00:00:05.552
works within the JavaScript or TypeScript

00:00:05.552 --> 00:00:06.192
ecosystem,

00:00:06.192 --> 00:00:07.552
if you want to be efficient,

00:00:07.552 --> 00:00:09.592
you have to really understand how your project or

00:00:09.592 --> 00:00:11.552
framework is bundled and how it's run.

00:00:11.962 --> 00:00:14.412
the JavaScript ecosystem has done a great job at

00:00:14.412 --> 00:00:16.532
kind of abstracting a lot of that complexity away

00:00:16.532 --> 00:00:16.972
from us,

00:00:16.972 --> 00:00:18.852
but in turn what's happened is it's created a

00:00:18.852 --> 00:00:21.132
whole bunch of developers that don't really know

00:00:21.132 --> 00:00:22.292
what's going on behind the scenes.

00:00:22.662 --> 00:00:23.422
And because of that,

00:00:23.422 --> 00:00:25.662
they don't really know how to debug problems when

00:00:25.662 --> 00:00:26.222
they hit like,

00:00:26.222 --> 00:00:27.222
Edge cases and stuff.

00:00:27.222 --> 00:00:29.462
And running on Cloudflare because it's not like

00:00:29.462 --> 00:00:30.582
your common node,

00:00:30.722 --> 00:00:31.282
based environment,

00:00:31.682 --> 00:00:34.442
you do come across issues more often than if

00:00:34.442 --> 00:00:36.002
you're just like shipping something to Vercel

00:00:36.002 --> 00:00:37.682
because they've taken care of like,

00:00:37.682 --> 00:00:39.122
so much of that complexity for us.

00:00:39.122 --> 00:00:41.042
But I do think it's really important to understand

00:00:41.042 --> 00:00:41.682
these things.

00:00:41.682 --> 00:00:44.442
So what I'm going to try to attempt to kind of

00:00:44.442 --> 00:00:46.002
convey within this section is

00:00:46.322 --> 00:00:48.562
how to think about bundling of projects and how

00:00:48.562 --> 00:00:49.762
that relates to Cloudflare.

00:00:49.842 --> 00:00:50.242
So

00:00:50.712 --> 00:00:51.352
at its core,

00:00:51.352 --> 00:00:54.192
a Cloudflare worker is just an object that has a

00:00:54.192 --> 00:00:54.952
fetch handler,

00:00:55.112 --> 00:00:58.392
and that fetch handler can take in a HTTP request

00:00:58.552 --> 00:01:00.792
and then you get that request and you process it.

00:01:00.952 --> 00:01:03.192
This is a really good example that Cloudflare has

00:01:03.192 --> 00:01:05.512
on their playground because it basically looks at

00:01:05.512 --> 00:01:06.192
a path and it says,

00:01:06.192 --> 00:01:07.072
if it's API,

00:01:07.072 --> 00:01:08.472
let's just return some JSON.

00:01:08.632 --> 00:01:10.152
And if it's the homepage,

00:01:10.312 --> 00:01:12.752
let's return some like a welcome HTML.

00:01:12.752 --> 00:01:14.464
So this is the welcome page that you see here.

00:01:14.464 --> 00:01:16.175
It's a styled HTML page.

00:01:16.335 --> 00:01:18.415
And then if we head over to API,

00:01:18.783 --> 00:01:19.983
you're going to get that API.

00:01:20.143 --> 00:01:21.623
Now when you see something like this,

00:01:21.623 --> 00:01:22.263
you might be like,

00:01:22.263 --> 00:01:22.543
okay,

00:01:22.543 --> 00:01:24.023
that's great if I want to build like a super,

00:01:24.023 --> 00:01:25.183
super simple API.

00:01:25.183 --> 00:01:25.703
But like,

00:01:25.703 --> 00:01:27.463
how does this relate to my next JS project?

00:01:27.463 --> 00:01:29.303
Or how does this relate to my Sveltekill Pro,

00:01:29.303 --> 00:01:30.543
my Sveltekit project?

00:01:31.503 --> 00:01:31.943
you know,

00:01:31.943 --> 00:01:32.223
like,

00:01:32.623 --> 00:01:34.663
it might not seem super obvious if you're not

00:01:34.663 --> 00:01:36.583
really familiar with how these applications are

00:01:36.583 --> 00:01:38.383
bundled and shipped and like actually run.

00:01:38.383 --> 00:01:38.783
But,

00:01:39.023 --> 00:01:39.303
like,

00:01:39.303 --> 00:01:41.423
this is really all you need in order to deliver

00:01:41.823 --> 00:01:43.143
really any type of application.

00:01:43.143 --> 00:01:45.623
It's just a fetch handler that is able to dictate

00:01:45.623 --> 00:01:46.143
routing.

00:01:46.143 --> 00:01:47.583
Now Hono is

00:01:48.723 --> 00:01:49.203
it's a

00:01:49.583 --> 00:01:51.863
really lightweight framework that I think was

00:01:51.863 --> 00:01:54.553
primarily built to work on Cloudflare's,

00:01:54.553 --> 00:01:55.363
worker runtime,

00:01:55.363 --> 00:01:56.763
but it can work cross platform.

00:01:56.763 --> 00:01:58.843
It really isn't limited to just Cloudflare and

00:01:58.923 --> 00:02:01.123
it's kind of an express alternative that is really

00:02:01.123 --> 00:02:02.603
lightweight and super easy to use.

00:02:02.673 --> 00:02:03.483
and you can see here,

00:02:03.483 --> 00:02:05.603
essentially you have like an app that you're

00:02:05.603 --> 00:02:08.403
defining and then this is saying API and then it's

00:02:08.403 --> 00:02:10.283
going to return some JSON Cloudflare and then you

00:02:10.283 --> 00:02:12.163
could create as many routes as you want and

00:02:12.163 --> 00:02:14.403
specify which paths they are and you could even

00:02:14.403 --> 00:02:14.723
return

00:02:15.783 --> 00:02:16.463
HTML.

00:02:16.463 --> 00:02:16.783
You know,

00:02:16.783 --> 00:02:18.543
you could build a really lightweight framework on

00:02:18.543 --> 00:02:19.223
top of Hono,

00:02:19.223 --> 00:02:20.203
which I've a few people do,

00:02:20.203 --> 00:02:21.123
which is kind of cool.

00:02:21.493 --> 00:02:23.283
but it's not something that's really beefy and

00:02:23.283 --> 00:02:25.643
robust like Next JS or Tanstack Start or

00:02:25.643 --> 00:02:26.313
Sveltekit.

00:02:26.803 --> 00:02:29.523
now if you look at this and then you look at the

00:02:29.603 --> 00:02:30.963
actual worker entry point,

00:02:30.963 --> 00:02:31.763
it looks different.

00:02:32.403 --> 00:02:33.523
But at the end of the day,

00:02:33.523 --> 00:02:34.323
if you're looking,

00:02:34.483 --> 00:02:35.843
if you take a look at App,

00:02:36.243 --> 00:02:37.603
app is just an object

00:02:37.923 --> 00:02:39.683
that has a fetch handler here,

00:02:40.003 --> 00:02:42.563
and a fetch handler is all you need to actually be

00:02:42.563 --> 00:02:44.403
able to run server side code on the Cloudflare

00:02:44.403 --> 00:02:44.963
runtime.

00:02:45.343 --> 00:02:47.583
So let's take a look at how that relates to other

00:02:47.583 --> 00:02:48.143
frameworks.

00:02:48.143 --> 00:02:49.183
But in order to do that,

00:02:49.183 --> 00:02:51.023
we also have to understand bundling.

00:02:52.018 --> 00:02:54.178
Before React there was a typical development

00:02:54.338 --> 00:02:57.098
process where you would basically have all of your

00:02:57.098 --> 00:02:58.458
application logic on a server.

00:02:58.458 --> 00:03:00.018
You'd have HTML templates,

00:03:00.018 --> 00:03:01.458
you'd have some styling stuff,

00:03:01.818 --> 00:03:03.817
all within like a server based application,

00:03:03.817 --> 00:03:04.778
typically php,

00:03:04.778 --> 00:03:07.698
and then that server would deliver server rendered

00:03:07.698 --> 00:03:08.778
content to the client.

00:03:09.098 --> 00:03:10.898
Then React came out and there was some other

00:03:10.898 --> 00:03:11.658
frameworks before that,

00:03:11.658 --> 00:03:14.178
but React really like pioneered this like single

00:03:14.178 --> 00:03:15.338
page application model.

00:03:15.688 --> 00:03:17.568
when React came out essentially there was this

00:03:17.568 --> 00:03:19.568
like distinction between your front end and your

00:03:19.568 --> 00:03:20.008
back end.

00:03:20.088 --> 00:03:21.288
you would build a,

00:03:21.688 --> 00:03:24.008
you'd build a React application that took care of

00:03:24.008 --> 00:03:25.448
like routing locally,

00:03:26.018 --> 00:03:28.738
and that was all self contained like in the

00:03:28.738 --> 00:03:29.298
browser.

00:03:29.298 --> 00:03:31.418
Now the development process was typically you

00:03:31.418 --> 00:03:32.658
would build out your

00:03:32.758 --> 00:03:34.098
single page React application.

00:03:34.258 --> 00:03:37.178
You would run a build command which took all of

00:03:37.178 --> 00:03:39.178
that code and it would bundle it so it would

00:03:39.178 --> 00:03:41.778
create a bunch of JavaScript files and a bunch of

00:03:41.778 --> 00:03:44.098
styled CSS files and then it would also take that

00:03:44.098 --> 00:03:46.878
some HTML files and it would kind of put them in

00:03:46.878 --> 00:03:49.118
distinct folders and in distinct files and then

00:03:49.118 --> 00:03:51.798
they would be uploaded to a cdn and then you'd

00:03:51.798 --> 00:03:52.738
have some type of network,

00:03:52.978 --> 00:03:55.698
mechanism that when a user makes a request,

00:03:55.698 --> 00:03:57.218
it goes to a cdn,

00:03:57.378 --> 00:03:58.578
it gets those files,

00:03:58.738 --> 00:04:01.658
it loads them on the browser and the application

00:04:01.658 --> 00:04:02.177
renders.

00:04:02.177 --> 00:04:03.898
And then when the application renders it says

00:04:03.898 --> 00:04:04.178
okay,

00:04:04.178 --> 00:04:04.898
I need some data.

00:04:05.038 --> 00:04:08.078
that's when it goes to the API that you build to

00:04:08.078 --> 00:04:08.678
get data.

00:04:08.738 --> 00:04:11.538
and the API was a very distinct separate entity

00:04:11.858 --> 00:04:12.778
when you were developing.

00:04:12.778 --> 00:04:15.298
So you have your API code that gets deployed to a

00:04:15.298 --> 00:04:15.618
server.

00:04:15.698 --> 00:04:17.378
so there was kind of like a very clear distinction

00:04:17.378 --> 00:04:18.498
between these two and

00:04:18.818 --> 00:04:19.738
you very like,

00:04:19.738 --> 00:04:21.978
I think it was very rare for people to be writing

00:04:21.978 --> 00:04:24.218
code and not know that it was server,

00:04:24.218 --> 00:04:26.618
like not know if it was server side code or client

00:04:26.618 --> 00:04:27.218
side code.

00:04:27.218 --> 00:04:29.618
Now next JS and a few of these other popular

00:04:29.898 --> 00:04:31.998
Full Stack frameworks have kind of flipped this

00:04:31.998 --> 00:04:33.158
model on the head because

00:04:33.558 --> 00:04:35.478
you're building within a single project

00:04:35.798 --> 00:04:36.158
and,

00:04:36.158 --> 00:04:36.798
and you're building,

00:04:36.798 --> 00:04:37.198
you know,

00:04:37.198 --> 00:04:38.478
like you're creating React components.

00:04:38.478 --> 00:04:39.958
But sometimes those react components

00:04:40.608 --> 00:04:42.288
run on the server and get delivered to the client,

00:04:42.288 --> 00:04:43.648
or sometimes they're client only.

00:04:43.648 --> 00:04:45.728
And then you have like database calls and API

00:04:45.728 --> 00:04:46.088
calls.

00:04:46.088 --> 00:04:46.368
And

00:04:46.638 --> 00:04:48.788
there's just this level of abstraction that came

00:04:48.788 --> 00:04:50.988
with these frameworks that provide a really great

00:04:50.988 --> 00:04:51.788
developer experience.

00:04:52.408 --> 00:04:54.288
but because of that I do think there's a lot of

00:04:54.288 --> 00:04:56.568
developers that kind of miss this idea of,

00:04:56.888 --> 00:04:57.448
you know,

00:04:57.448 --> 00:04:57.848
where

00:04:58.168 --> 00:05:00.008
when am I actually writing server code?

00:05:00.088 --> 00:05:03.128
How do I not actually leak database secrets to a

00:05:03.128 --> 00:05:04.008
client and then

00:05:04.408 --> 00:05:06.688
on top of that they don't really understand like

00:05:06.688 --> 00:05:08.488
what's happening with the bundle because the

00:05:08.878 --> 00:05:09.678
client side bundle,

00:05:09.678 --> 00:05:11.438
where you have a whole bunch of these static files

00:05:11.438 --> 00:05:13.678
that get uploaded to a CDN is still,

00:05:14.238 --> 00:05:17.078
is still the path that these Full Stack frameworks

00:05:17.078 --> 00:05:17.358
take.

00:05:17.438 --> 00:05:17.698
But

00:05:17.738 --> 00:05:19.978
they also have a separate bundle specifically for

00:05:19.978 --> 00:05:20.858
server side code.

00:05:20.858 --> 00:05:23.578
So this layer right here where static assets are

00:05:23.578 --> 00:05:26.698
being loaded onto a CDN so they can be cached and

00:05:26.698 --> 00:05:26.978
then

00:05:27.298 --> 00:05:28.778
be reached by a user really,

00:05:28.778 --> 00:05:29.458
really quickly.

00:05:29.698 --> 00:05:31.298
And then the code that's actually going on a

00:05:31.298 --> 00:05:33.138
server and being executed are,

00:05:33.138 --> 00:05:33.778
are still,

00:05:33.858 --> 00:05:34.218
they're,

00:05:34.218 --> 00:05:34.529
they're still,

00:05:34.565 --> 00:05:35.885
they're still at play in this model.

00:05:35.885 --> 00:05:36.805
It's still like this,

00:05:36.805 --> 00:05:38.045
this pattern really hasn't changed.

00:05:38.045 --> 00:05:38.905
It's just the

00:05:38.905 --> 00:05:41.145
bundling process kind of takes care of the server

00:05:41.465 --> 00:05:41.865
and

00:05:42.185 --> 00:05:45.065
the static assets at the exact same time.

00:05:45.225 --> 00:05:47.465
So let's go ahead and look at a next application

00:05:47.465 --> 00:05:49.464
and then kind of like make a distinction between

00:05:49.464 --> 00:05:49.865
these

00:05:50.585 --> 00:05:53.505
and then make a distinction between static assets

00:05:53.505 --> 00:05:54.665
and actual server side code.

00:05:54.876 --> 00:05:56.996
you run your build command with Next js,

00:05:56.996 --> 00:05:59.276
it's going to dump a whole bunch of different

00:05:59.356 --> 00:06:01.566
files inside of these output

00:06:02.056 --> 00:06:03.336
inside of these output folders.

00:06:03.336 --> 00:06:05.376
So typically if you're looking at like a standard

00:06:05.376 --> 00:06:06.136
React application,

00:06:06.136 --> 00:06:07.896
it's going to go inside of a dist folder.

00:06:07.896 --> 00:06:08.216
But

00:06:08.776 --> 00:06:08.806
Next

00:06:08.956 --> 00:06:12.276
JS and especially Next with Open Next as the

00:06:12.276 --> 00:06:14.316
deployment adapter is going to have a very

00:06:14.316 --> 00:06:16.796
specific folder convention for where those files

00:06:16.796 --> 00:06:17.116
go.

00:06:17.436 --> 00:06:17.706
But,

00:06:17.776 --> 00:06:19.496
but this is something you typically don't think

00:06:19.496 --> 00:06:19.736
about.

00:06:19.736 --> 00:06:20.896
You very seldomly

00:06:21.376 --> 00:06:23.056
you're going to go look through these files.

00:06:23.056 --> 00:06:24.976
But it's kind of important to know what's going on

00:06:24.976 --> 00:06:25.296
here.

00:06:25.296 --> 00:06:27.776
So during that build process it's taken all the

00:06:27.776 --> 00:06:29.416
client side code and it's bundled it.

00:06:29.416 --> 00:06:29.926
So it

00:06:30.076 --> 00:06:32.796
should be really lightweight and efficient for

00:06:33.116 --> 00:06:35.596
a CDN to deliver it to a client and then for the

00:06:35.596 --> 00:06:37.116
browser to render it really quickly.

00:06:37.116 --> 00:06:39.236
But it's also taken all of your server side logic

00:06:39.236 --> 00:06:41.036
and it's put it behind a fetch handler.

00:06:41.036 --> 00:06:43.436
So the server side logic can render HTML on the

00:06:43.436 --> 00:06:45.236
server to deliver it to the client for SEO

00:06:45.236 --> 00:06:45.836
purposes,

00:06:45.896 --> 00:06:46.256
it can

00:06:46.736 --> 00:06:48.776
wrangle some data behind a database and return

00:06:48.776 --> 00:06:49.296
JSON.

00:06:49.616 --> 00:06:52.056
Next also has server functions which is just kind

00:06:52.056 --> 00:06:55.136
of a abstraction on top of a traditional API

00:06:55.136 --> 00:06:55.536
request.

00:06:55.536 --> 00:06:57.056
So all of that is also bundled

00:06:57.496 --> 00:06:58.936
as part of a server build.

00:06:59.016 --> 00:07:01.176
So if we take a look at the

00:07:02.266 --> 00:07:03.226
at the build

00:07:03.926 --> 00:07:05.046
at the build manifest,

00:07:05.046 --> 00:07:06.326
you're going to see that there's a whole bunch of

00:07:06.326 --> 00:07:08.606
these JavaScript files and these JavaScript files

00:07:08.606 --> 00:07:09.486
are put into chunks.

00:07:09.486 --> 00:07:12.846
So it kind of efficiently took isolated JavaScript

00:07:12.846 --> 00:07:13.206
that

00:07:13.716 --> 00:07:15.796
that is used probably for pages or specific

00:07:15.796 --> 00:07:19.156
components and it put them in small JS files that

00:07:19.156 --> 00:07:20.076
we can actually go see.

00:07:20.076 --> 00:07:21.716
If we head over to static and we go to chunks,

00:07:21.716 --> 00:07:23.236
you can see there's these nonsensical

00:07:23.636 --> 00:07:25.956
JavaScript bundles that are going to be used by

00:07:25.956 --> 00:07:26.276
our

00:07:26.366 --> 00:07:28.536
browser when our page loads for the very first

00:07:28.536 --> 00:07:30.296
time and then it's going to try to cache them on

00:07:30.296 --> 00:07:31.016
the browser side.

00:07:31.416 --> 00:07:32.376
Now because this is

00:07:32.406 --> 00:07:34.536
Next JS and you have the server side component

00:07:34.696 --> 00:07:35.016
open.

00:07:35.016 --> 00:07:37.816
Next is actually the deployment adapter here that

00:07:38.316 --> 00:07:41.116
gets the server side code in a compatible format

00:07:41.196 --> 00:07:41.596
for

00:07:42.236 --> 00:07:43.516
specifically for next year.

00:07:43.516 --> 00:07:45.556
So you can see you have this worker inside of this

00:07:45.556 --> 00:07:45.996
Open Next

00:07:46.296 --> 00:07:48.776
this was dynamically created at build time.

00:07:49.016 --> 00:07:51.416
Is this fetch handler that basic that is

00:07:51.416 --> 00:07:53.896
cloudflare compatible and it is going to be very

00:07:53.896 --> 00:07:54.456
usable,

00:07:54.666 --> 00:07:55.916
or it's going to be very understandable by

00:07:55.916 --> 00:07:58.236
cloudflare and then it's going to contain and

00:07:58.316 --> 00:08:00.516
manage all of the actual like server side logic

00:08:00.516 --> 00:08:01.276
for our

00:08:02.406 --> 00:08:03.926
for our server side code inside of our next

00:08:03.926 --> 00:08:04.406
application.

00:08:04.406 --> 00:08:06.246
And this is going to be essentially the process

00:08:06.326 --> 00:08:09.086
that is followed for all of these full Stack

00:08:09.086 --> 00:08:09.526
frameworks.

00:08:09.526 --> 00:08:11.446
There's typically a adapter,

00:08:11.886 --> 00:08:13.486
or some type of plugin,

00:08:13.726 --> 00:08:14.646
sometimes with vite,

00:08:14.646 --> 00:08:17.446
sometimes it's a dedicated adapter to compile your

00:08:17.446 --> 00:08:19.286
server side code to make it compatible with

00:08:19.286 --> 00:08:19.966
Cloudflare.

00:08:20.046 --> 00:08:22.446
So one thing that I really want to drill in here,

00:08:22.486 --> 00:08:23.706
is if you deploy this

00:08:24.426 --> 00:08:24.906
code

00:08:25.284 --> 00:08:26.718
and then we head over to

00:08:27.118 --> 00:08:27.998
Cloudflare.

00:08:27.998 --> 00:08:29.838
So I'm going to go ahead and open up the

00:08:29.838 --> 00:08:30.728
Cloudflare dashboard

00:08:31.116 --> 00:08:33.716
and I'm going to go look at this as my next

00:08:33.716 --> 00:08:34.396
application,

00:08:34.567 --> 00:08:35.675
head over to the logs

00:08:35.675 --> 00:08:38.012
and then we're going to turn real time logs on and

00:08:38.012 --> 00:08:38.852
then this is going to,

00:08:38.852 --> 00:08:40.012
when this is done deploying,

00:08:40.012 --> 00:08:42.812
this is going to give us an actual URL that we can

00:08:42.812 --> 00:08:43.364
use to hit it.

00:08:44.194 --> 00:08:45.915
so we're going to go ahead and open this URL.

00:08:47.457 --> 00:08:48.897
I'm going to put it in here

00:08:49.537 --> 00:08:51.057
and then let's open our,

00:08:51.457 --> 00:08:53.737
let's open this console and let's go to the

00:08:53.737 --> 00:08:54.417
network tab.

00:08:54.417 --> 00:08:54.857
Okay.

00:08:54.857 --> 00:08:57.777
Let's make sure our real time logs are coming in.

00:08:58.017 --> 00:08:59.697
Now I'm going to load this page and what you're

00:08:59.697 --> 00:09:01.337
going to notice is there's a whole bunch of

00:09:01.337 --> 00:09:03.577
requests that actually are made and these are the

00:09:03.577 --> 00:09:04.977
requests to go grab those

00:09:05.057 --> 00:09:06.397
static JavaScript bundles.

00:09:06.397 --> 00:09:08.917
So this is actually being cached on Cloudflare

00:09:08.917 --> 00:09:09.517
CDN.

00:09:09.697 --> 00:09:09.977
It's really,

00:09:09.977 --> 00:09:10.337
really quick.

00:09:10.337 --> 00:09:12.657
If you look at like the actual travel time for

00:09:12.657 --> 00:09:13.017
this stuff,

00:09:13.017 --> 00:09:13.377
it's really,

00:09:13.377 --> 00:09:15.177
really fast because it's getting pulled from a

00:09:15.177 --> 00:09:16.017
server that's really,

00:09:16.017 --> 00:09:16.897
really close to me,

00:09:16.897 --> 00:09:18.177
that's managed by Cloudflare.

00:09:18.417 --> 00:09:20.697
Now if we go ahead and we look at the actual.

00:09:20.697 --> 00:09:21.377
Looks like their

00:09:21.597 --> 00:09:22.957
time logs aren't working right now.

00:09:22.957 --> 00:09:25.676
But if you look at the actual real time log for

00:09:25.676 --> 00:09:25.917
this,

00:09:25.917 --> 00:09:28.117
you're going to see there's only one request

00:09:28.197 --> 00:09:29.077
that's being made.

00:09:29.397 --> 00:09:31.957
You're not seeing a request to the homepage

00:09:32.277 --> 00:09:33.477
and then also to

00:09:33.626 --> 00:09:33.977
the

00:09:34.717 --> 00:09:35.197
random

00:09:36.097 --> 00:09:40.017
the random SVG files and the random image files

00:09:40.017 --> 00:09:43.097
and the random JavaScript bundles because these

00:09:43.097 --> 00:09:44.977
are all part of the same domain host,

00:09:45.057 --> 00:09:46.937
but it's actually being pulled from different

00:09:46.937 --> 00:09:47.417
servers.

00:09:47.417 --> 00:09:47.777
So

00:09:48.177 --> 00:09:49.577
when you're looking at Cloudflare,

00:09:49.577 --> 00:09:51.017
when you're looking at like the requests that you

00:09:51.017 --> 00:09:51.297
receive,

00:09:51.297 --> 00:09:53.497
your build per request now it's very cheap.

00:09:53.497 --> 00:09:54.257
After you have,

00:09:54.257 --> 00:09:55.977
if you're on the Pay tier after 10 million

00:09:55.977 --> 00:09:56.737
requests,

00:09:56.897 --> 00:09:58.737
it's $0.3 per million request.

00:09:58.737 --> 00:09:59.047
So it's

00:09:59.047 --> 00:09:59.237
a very,

00:09:59.237 --> 00:10:00.117
very generous in terms,

00:10:00.117 --> 00:10:01.557
it's very generous in terms of pricing.

00:10:01.557 --> 00:10:01.877
But

00:10:02.357 --> 00:10:02.607
you know,

00:10:02.677 --> 00:10:02.877
you know,

00:10:02.877 --> 00:10:03.637
like if you look,

00:10:03.637 --> 00:10:05.917
imagine if every single one of these requests

00:10:05.917 --> 00:10:07.637
reached out and invoked the worker.

00:10:07.637 --> 00:10:07.997
You know,

00:10:07.997 --> 00:10:10.117
like every single page load would be like 25

00:10:10.117 --> 00:10:11.077
different requests.

00:10:11.237 --> 00:10:12.957
But that's actually not how the billing works

00:10:12.957 --> 00:10:14.277
because it's not going to the worker,

00:10:14.277 --> 00:10:15.637
it's going to the cdn.

00:10:15.637 --> 00:10:16.507
It's going to manage,

00:10:16.697 --> 00:10:18.817
servers by cloudflare to get those static assets

00:10:18.817 --> 00:10:19.737
delivered really,

00:10:19.737 --> 00:10:20.457
really quickly.

00:10:20.537 --> 00:10:23.017
So configuring your project and typically if

00:10:23.017 --> 00:10:23.897
you're using a framework,

00:10:23.897 --> 00:10:25.457
you're going to be using a template that already

00:10:25.457 --> 00:10:26.617
has that bundle,

00:10:26.687 --> 00:10:28.317
and the build process taken care of for you.

00:10:28.317 --> 00:10:30.637
So it's set up in a way where when you deploy,

00:10:31.197 --> 00:10:31.677
it's

00:10:32.297 --> 00:10:32.857
instructing

00:10:32.967 --> 00:10:35.717
Cloudflare on which files are the static assets

00:10:35.717 --> 00:10:38.077
that go to the CDN and then what your server side

00:10:38.077 --> 00:10:41.277
entry point is to actually invoke your worker.

00:10:41.357 --> 00:10:43.357
So this is pretty important to know because you

00:10:43.357 --> 00:10:46.357
technically could serve assets via a worker if you

00:10:46.357 --> 00:10:46.957
wanted to.

00:10:47.307 --> 00:10:48.477
it's just if you're having like,

00:10:48.477 --> 00:10:50.037
if you a lot of these full stack frameworks,

00:10:50.037 --> 00:10:51.357
if you look at this network tab,

00:10:51.357 --> 00:10:53.157
it could make like hundreds of requests to grab

00:10:53.157 --> 00:10:53.757
all these assets.

00:10:53.757 --> 00:10:56.277
And you don't necessarily want a worker to be

00:10:56.277 --> 00:10:57.877
invoked every single time because it's not the

00:10:57.877 --> 00:10:58.317
most efficient,

00:10:58.317 --> 00:10:59.997
it's not an efficient way of doing it because that

00:10:59.997 --> 00:11:00.757
data doesn't change.

00:11:00.917 --> 00:11:02.517
You might as well put it on a cdn,

00:11:02.517 --> 00:11:03.777
let the CDN and cache it.

00:11:03.777 --> 00:11:05.927
Data transfer is very cheap at that layer.

00:11:05.927 --> 00:11:06.217
with.

00:11:06.537 --> 00:11:07.897
For most projects that you're going to be

00:11:07.897 --> 00:11:08.977
deploying on the Cloudflare,

00:11:08.977 --> 00:11:10.537
you're not really even considering that as part of

00:11:10.537 --> 00:11:12.697
your price as you become more of an enterprise

00:11:12.697 --> 00:11:13.137
customer,

00:11:13.137 --> 00:11:14.777
there is prices associated with that.

00:11:14.777 --> 00:11:16.537
But it's very cheap to do that.

00:11:16.547 --> 00:11:18.527
whereas like the server side logic is still cheap,

00:11:18.527 --> 00:11:18.807
but

00:11:19.207 --> 00:11:21.247
it isn't as it is a little bit more

00:11:21.247 --> 00:11:22.327
computationally expensive.

00:11:22.457 --> 00:11:24.057
and this is actually what we're built on.

00:11:24.057 --> 00:11:25.977
So this is just a really important point to note

00:11:25.977 --> 00:11:28.297
is there's a clear distinction between our,

00:11:28.467 --> 00:11:29.287
static assets

00:11:29.907 --> 00:11:30.867
that get bundled,

00:11:30.877 --> 00:11:33.767
and then uploaded to Cloudflare CDN and our server

00:11:33.767 --> 00:11:36.047
side code that gets uploaded into the worker

00:11:36.047 --> 00:11:38.607
runtime environment so our workers can be invoked

00:11:38.607 --> 00:11:40.273
and actually handle business logic on the server.

00:11:40.292 --> 00:11:41.812
Now that we understand a little bit more about the

00:11:41.812 --> 00:11:42.612
bundling process,

00:11:42.722 --> 00:11:44.132
and different caveats

00:11:44.452 --> 00:11:45.892
when deploying to Cloudflare,

00:11:46.132 --> 00:11:48.332
I think it's also important to understand how to

00:11:48.332 --> 00:11:50.572
manage environment variables because this is

00:11:50.572 --> 00:11:52.771
really the thing that is the most different in the

00:11:52.771 --> 00:11:53.652
Cloudflare environment

00:11:54.052 --> 00:11:56.652
versus node based applications or really any other

00:11:56.652 --> 00:11:57.462
like JavaScript,

00:11:57.462 --> 00:11:58.892
application that you build that server side.

00:11:59.132 --> 00:11:59.532
So

00:11:59.972 --> 00:12:02.572
if you look at like really any docs online and

00:12:02.572 --> 00:12:04.372
this is the source of so much confusion for

00:12:04.372 --> 00:12:04.692
people,

00:12:05.142 --> 00:12:06.182
if you're creating a client,

00:12:06.182 --> 00:12:08.342
whether it be a connection to a database or

00:12:08.342 --> 00:12:09.702
through an API provider,

00:12:09.862 --> 00:12:11.942
you'll probably see that there will be some type

00:12:11.942 --> 00:12:12.742
of like handler

00:12:12.822 --> 00:12:13.282
that is

00:12:13.682 --> 00:12:15.842
defined kind of globally within the project.

00:12:15.842 --> 00:12:16.242
It's,

00:12:16.242 --> 00:12:17.922
it's built during build time

00:12:18.222 --> 00:12:20.222
that are basically during build time

00:12:20.702 --> 00:12:22.862
this code is going to be compiled and then during

00:12:22.862 --> 00:12:24.942
runtime it's able to grab the process

00:12:25.422 --> 00:12:26.142
EMV,

00:12:27.302 --> 00:12:28.102
like GitHub,

00:12:28.182 --> 00:12:30.422
client ID or API secret or

00:12:30.942 --> 00:12:31.222
secret.

00:12:31.302 --> 00:12:33.182
So this is a very common pattern.

00:12:33.182 --> 00:12:33.402
And,

00:12:33.552 --> 00:12:34.832
and if you go this route,

00:12:34.832 --> 00:12:36.032
if you just kind of like take

00:12:36.512 --> 00:12:38.472
some documentation you see online for a

00:12:38.472 --> 00:12:40.592
traditional node based environment and then you

00:12:40.592 --> 00:12:41.792
put this in your code base,

00:12:41.792 --> 00:12:43.152
it most likely is going to fail.

00:12:43.152 --> 00:12:45.312
And the reason it's going to fail is you don't

00:12:45.312 --> 00:12:47.312
have access to process in the node based

00:12:47.312 --> 00:12:47.632
environment.

00:12:47.632 --> 00:12:49.152
This is a very node specific thing.

00:12:49.152 --> 00:12:49.952
Even though other

00:12:50.632 --> 00:12:52.432
other frameworks and even Cloudflare,

00:12:52.432 --> 00:12:54.592
with a caveat with like an exception that we'll go

00:12:54.592 --> 00:12:54.872
through,

00:12:55.192 --> 00:12:55.982
use this process

00:12:56.302 --> 00:12:57.342
EMB convention,

00:12:57.342 --> 00:12:59.262
this is actually not the best way to do it within

00:12:59.262 --> 00:13:00.582
the Cloudflare ecosystem.

00:13:00.582 --> 00:13:00.942
So

00:13:01.392 --> 00:13:03.312
typically with the node based application you'd

00:13:03.312 --> 00:13:05.652
create a do EMV file and you go ahead and put

00:13:05.652 --> 00:13:07.732
those secrets in and then when you deploy you put

00:13:07.732 --> 00:13:09.492
those secrets and whatever your deployment

00:13:09.492 --> 00:13:10.042
provider

00:13:10.312 --> 00:13:11.672
is using for secret management.

00:13:11.992 --> 00:13:14.472
And then when the application is deployed it's

00:13:14.472 --> 00:13:14.952
basically

00:13:15.272 --> 00:13:17.112
running a command that's like export

00:13:18.952 --> 00:13:19.352
var

00:13:19.911 --> 00:13:21.032
equals value.

00:13:21.192 --> 00:13:22.792
That's kind of like what it's going to look like

00:13:22.792 --> 00:13:23.832
and then it's going to be

00:13:24.232 --> 00:13:25.432
available in that

00:13:26.072 --> 00:13:26.082
actual

00:13:26.332 --> 00:13:27.852
like process emb call.

00:13:28.012 --> 00:13:30.092
Now with Cloudflare we do it a little bit

00:13:30.092 --> 00:13:30.452
differently.

00:13:30.452 --> 00:13:31.212
We create a,

00:13:31.572 --> 00:13:34.652
for development purposes we create a dev.vars

00:13:34.652 --> 00:13:35.732
folder or file

00:13:36.052 --> 00:13:37.492
and from there you can

00:13:37.812 --> 00:13:40.252
define secrets and other variables that you want

00:13:40.252 --> 00:13:40.612
to use

00:13:40.722 --> 00:13:41.652
inside of your application.

00:13:41.652 --> 00:13:43.812
I think it's mostly only makes sense to put

00:13:43.812 --> 00:13:45.892
secrets in here but I do see sometimes people put

00:13:45.892 --> 00:13:47.752
like static variables as well.

00:13:48.232 --> 00:13:48.792
And then

00:13:49.272 --> 00:13:51.072
almost all these applications they should be set

00:13:51.072 --> 00:13:53.272
up to basically Have a command where you say npm

00:13:53.432 --> 00:13:56.632
run CF Cloudflare type gen

00:13:58.022 --> 00:14:00.822
and then when you run that it's going to take

00:14:00.822 --> 00:14:02.982
those vars and it's going to put it in an

00:14:02.982 --> 00:14:03.622
interface.

00:14:03.672 --> 00:14:05.862
and this interface is going to be type safe within

00:14:05.862 --> 00:14:06.462
your code.

00:14:06.462 --> 00:14:08.702
So this is a Hono application.

00:14:08.702 --> 00:14:10.062
So in our Honor application,

00:14:10.062 --> 00:14:11.582
if we wanted to get that var,

00:14:12.142 --> 00:14:12.203
what

00:14:12.233 --> 00:14:14.553
Now what we could do is we could basically say C

00:14:14.553 --> 00:14:17.873
for context.emv.my VAR.

00:14:17.873 --> 00:14:19.353
And you see that that's going to show up.

00:14:19.353 --> 00:14:20.473
So we could basically say

00:14:20.793 --> 00:14:22.833
my VAR equals C emv.

00:14:22.833 --> 00:14:24.593
And this is how you can basically inject secrets

00:14:24.593 --> 00:14:25.193
into your code.

00:14:25.193 --> 00:14:26.633
Now the difference here is

00:14:27.233 --> 00:14:27.473
you

00:14:27.793 --> 00:14:30.033
have access to them during runtime,

00:14:30.193 --> 00:14:32.873
so you're able to like when you handle an API

00:14:32.873 --> 00:14:33.193
request,

00:14:33.193 --> 00:14:34.593
you're able to grab those variables,

00:14:34.593 --> 00:14:34.913
those

00:14:34.923 --> 00:14:36.613
variables and those secrets like this.

00:14:36.613 --> 00:14:37.013
Now

00:14:37.503 --> 00:14:40.623
I do like to typically move that logic out and

00:14:40.783 --> 00:14:42.143
throughout the course we're going to go into

00:14:42.143 --> 00:14:43.823
patterns to kind of make it so like,

00:14:44.143 --> 00:14:44.623
you know,

00:14:44.623 --> 00:14:46.263
you don't have a whole bunch of boilerplate every

00:14:46.263 --> 00:14:47.823
single time you do something where you extract

00:14:47.823 --> 00:14:49.503
variables and you put them into your

00:14:49.583 --> 00:14:51.063
like different functions and stuff.

00:14:51.063 --> 00:14:53.023
But essentially what you do is if this was a

00:14:53.023 --> 00:14:53.703
database secret,

00:14:53.703 --> 00:14:54.383
you could also

00:14:54.993 --> 00:14:57.033
instantiate or create your database client at this

00:14:57.033 --> 00:14:57.553
level too.

00:14:57.553 --> 00:14:59.153
And I like to kind of move that stuff out.

00:14:59.153 --> 00:15:02.233
But the main point to drive home in is you don't

00:15:02.233 --> 00:15:04.833
want to like set this up globally within your

00:15:04.833 --> 00:15:06.433
application because you're not going to be able to

00:15:06.433 --> 00:15:08.433
access this with the process emv.

00:15:08.833 --> 00:15:09.172
Now

00:15:09.172 --> 00:15:09.552
different,

00:15:10.182 --> 00:15:12.542
different full Stack frameworks handle these

00:15:12.542 --> 00:15:15.102
environments variables differently depending on

00:15:15.102 --> 00:15:15.942
how they're built.

00:15:15.942 --> 00:15:16.342
So

00:15:16.812 --> 00:15:17.212
the

00:15:18.332 --> 00:15:20.012
next JS way of doing it

00:15:20.492 --> 00:15:23.012
is basically you don't have like access to this

00:15:23.012 --> 00:15:25.252
context that gets passed in to all of the

00:15:25.252 --> 00:15:25.982
different like

00:15:25.982 --> 00:15:27.352
server side actions and

00:15:27.672 --> 00:15:29.592
to your server side routes and stuff.

00:15:29.752 --> 00:15:31.832
But what you do have is you have the

00:15:32.262 --> 00:15:34.012
They do give you this Cloudflare

00:15:34.442 --> 00:15:36.042
this is a specific one for pages,

00:15:36.042 --> 00:15:37.642
but they have also something very simple,

00:15:37.802 --> 00:15:39.162
similar for workers as well,

00:15:39.162 --> 00:15:41.282
where you're able to grab the context of the

00:15:41.282 --> 00:15:42.842
request through a helper function.

00:15:42.842 --> 00:15:43.722
So you can basically

00:15:44.332 --> 00:15:44.892
grab your

00:15:44.992 --> 00:15:45.452
context,

00:15:45.452 --> 00:15:47.372
you can grab the EMV and then you can get your

00:15:47.372 --> 00:15:49.192
environment variables for Cloudflare.

00:15:49.772 --> 00:15:51.692
Now the one caveat here is

00:15:52.152 --> 00:15:53.512
right now Tanstack Start.

00:15:53.512 --> 00:15:55.592
So Tanstack Start is built on Nitro.

00:15:55.592 --> 00:15:56.152
It's a

00:15:56.992 --> 00:15:58.872
It's Basically like something that's somewhat

00:15:58.872 --> 00:16:01.752
similar to Vite where it takes care of like a

00:16:01.752 --> 00:16:04.192
whole bunch of the generic JavaScript based

00:16:04.272 --> 00:16:04.892
server,

00:16:04.892 --> 00:16:05.552
functionality.

00:16:05.552 --> 00:16:08.472
So you can build a framework on top of Vite and it

00:16:08.472 --> 00:16:10.312
takes care of like a whole bunch of bundling

00:16:10.312 --> 00:16:10.672
stuff.

00:16:10.672 --> 00:16:12.712
So they have all of these like runtimes that they

00:16:12.712 --> 00:16:13.712
support and they have

00:16:14.002 --> 00:16:15.962
a whole bundling convention on how they can

00:16:15.962 --> 00:16:18.722
actually take like your Nitro based framework,

00:16:18.892 --> 00:16:21.142
that you kind of built with your own flavor and

00:16:21.142 --> 00:16:22.982
then bundle in a way that's understandable by

00:16:22.982 --> 00:16:23.702
cloud provider.

00:16:23.702 --> 00:16:25.182
So there's this configuration.

00:16:25.182 --> 00:16:27.582
Now Nitro is actually like the one

00:16:27.732 --> 00:16:30.442
example that I've seen where you still grab it

00:16:30.442 --> 00:16:31.642
through like process

00:16:32.042 --> 00:16:32.602
emv.

00:16:32.602 --> 00:16:34.402
The only thing is you need to grab it up from

00:16:34.402 --> 00:16:35.402
process EMV

00:16:35.722 --> 00:16:37.242
during the server side runtime.

00:16:37.302 --> 00:16:38.782
so that's like the main caveat here.

00:16:38.782 --> 00:16:40.342
So like sometimes this is actually still

00:16:40.872 --> 00:16:42.312
the convention but that's just because

00:16:42.952 --> 00:16:44.072
Nitro has

00:16:44.632 --> 00:16:47.432
compiled the code in a way where that those

00:16:47.432 --> 00:16:49.352
environment variables for cloudflare are actually

00:16:49.352 --> 00:16:51.352
available through the process emv.

00:16:51.512 --> 00:16:54.072
Now this can be really confusing because like so

00:16:54.072 --> 00:16:55.712
many different frameworks have so many different

00:16:55.712 --> 00:16:56.712
tools that are

00:16:57.652 --> 00:17:00.212
adapting the framework for a specific runtime

00:17:00.212 --> 00:17:01.772
where you kind of have to learn like the runtime

00:17:01.772 --> 00:17:03.412
specific way of doing something and it can be

00:17:03.412 --> 00:17:03.772
tedious.

00:17:03.772 --> 00:17:06.572
But I do think the future is much more bright than

00:17:06.572 --> 00:17:08.932
it has been and the reason why is because of Vite

00:17:09.332 --> 00:17:09.547
now.

00:17:10.061 --> 00:17:11.741
Now you might have noticed a lot of Full Stack

00:17:11.741 --> 00:17:14.301
frameworks are actually moving all of their build

00:17:14.301 --> 00:17:15.581
tooling over to Vite,

00:17:15.581 --> 00:17:17.821
because Vite has a whole bunch of different like

00:17:18.031 --> 00:17:18.821
server logic,

00:17:18.821 --> 00:17:19.901
dev server logic,

00:17:20.381 --> 00:17:20.411
standardization,

00:17:20.961 --> 00:17:22.121
of how they bundle stuff.

00:17:22.121 --> 00:17:24.121
They've done a great job at just taking the best

00:17:24.121 --> 00:17:25.201
practices across

00:17:25.601 --> 00:17:26.401
a lot of different

00:17:26.811 --> 00:17:29.191
deployment providers and then also Full Stack

00:17:29.191 --> 00:17:29.751
frameworks.

00:17:29.751 --> 00:17:31.231
And they've tried to build something that's like

00:17:31.231 --> 00:17:31.791
very generic,

00:17:31.791 --> 00:17:33.431
that can work for a lot of different use cases.

00:17:33.511 --> 00:17:35.871
So Vite is a really great build tool and I just

00:17:35.871 --> 00:17:37.351
think it's becoming more and more popular.

00:17:37.731 --> 00:17:39.571
More and more frameworks are continuously adopting

00:17:39.571 --> 00:17:39.811
it.

00:17:39.811 --> 00:17:40.331
Like right now,

00:17:40.331 --> 00:17:42.131
tanstextart is in the process of

00:17:42.531 --> 00:17:44.451
moving everything completely over to Vite,

00:17:44.451 --> 00:17:45.251
which is pretty cool.

00:17:45.251 --> 00:17:48.811
Now Vite has an environment API of like the way

00:17:48.811 --> 00:17:50.611
that they say you should be managing environment

00:17:50.691 --> 00:17:51.321
variables,

00:17:51.321 --> 00:17:53.071
server side and then also client side.

00:17:53.391 --> 00:17:53.790
And

00:17:54.201 --> 00:17:57.231
when Full Stack frameworks are using Vite as their

00:17:57.231 --> 00:17:57.911
build tool,

00:17:58.231 --> 00:17:59.951
essentially what Vite is saying is like,

00:17:59.951 --> 00:18:01.991
you should conform to this environment API.

00:18:01.991 --> 00:18:04.551
That way we can take care of the cross platform,

00:18:04.621 --> 00:18:06.821
bundling for you and that should just work across

00:18:06.821 --> 00:18:07.301
the board.

00:18:07.381 --> 00:18:08.661
So this is still like,

00:18:08.881 --> 00:18:09.121
you know,

00:18:09.121 --> 00:18:11.481
a continuous process and there's still a lot of

00:18:11.481 --> 00:18:12.521
like progress to be made.

00:18:12.521 --> 00:18:14.441
But more and more tooling I've seen over,

00:18:14.441 --> 00:18:15.521
even just last year,

00:18:15.761 --> 00:18:18.241
it's become so much easier to deploy to cloudflare

00:18:18.241 --> 00:18:19.441
just because of Vite.

00:18:19.521 --> 00:18:19.921
And

00:18:20.151 --> 00:18:22.101
cloudflare is also investing in Vite as well.

00:18:22.101 --> 00:18:22.271
They've

00:18:22.541 --> 00:18:25.021
they built a specific Vite plugin for cloudflare

00:18:25.021 --> 00:18:25.341
services.

00:18:25.421 --> 00:18:27.621
Now right now they don't support all of the

00:18:27.621 --> 00:18:28.461
frameworks but

00:18:28.711 --> 00:18:30.301
they are working with a lot of other like

00:18:30.301 --> 00:18:31.701
framework maintainers to make sure

00:18:31.811 --> 00:18:32.881
the cloudflare Vite

00:18:33.161 --> 00:18:34.361
plugin is going to work with

00:18:34.651 --> 00:18:36.891
different frameworks as long as they're being

00:18:36.891 --> 00:18:37.931
bundled with Vite.

00:18:38.011 --> 00:18:40.851
So there's a lot of really great work happening in

00:18:40.851 --> 00:18:41.131
the space.

00:18:41.131 --> 00:18:42.811
So I do think it's worth keeping an eye out.

00:18:42.811 --> 00:18:43.811
And if a framework's like,

00:18:43.811 --> 00:18:44.051
yeah,

00:18:44.051 --> 00:18:45.811
we're moving over to like the newest version of

00:18:45.811 --> 00:18:47.651
Vite and we're investing heavily in that being our

00:18:47.651 --> 00:18:48.331
only build tool.

00:18:48.571 --> 00:18:50.571
I think that framework has a good future because I

00:18:50.571 --> 00:18:52.211
do think personally Vite's going to have a very

00:18:52.211 --> 00:18:52.635
good future.

00:18:52.809 --> 00:18:54.209
Now the last thing that I want to touch on with

00:18:54.209 --> 00:18:55.969
environment variables is how we can actually

00:18:55.969 --> 00:18:58.009
access them and manage them when we deploy.

00:18:58.009 --> 00:19:00.689
So in production now what we did here is inside of

00:19:00.689 --> 00:19:03.809
this dev vars file which we should put in our git,

00:19:03.809 --> 00:19:05.449
ignore and never commit it to GitHub.

00:19:05.699 --> 00:19:07.449
we specified like this random secret,

00:19:07.449 --> 00:19:08.169
this test secret.

00:19:08.169 --> 00:19:09.569
Then we ran CF type gen,

00:19:09.929 --> 00:19:11.689
that became available through our

00:19:12.089 --> 00:19:14.529
environment here and then we're able to access it

00:19:14.529 --> 00:19:15.519
in a type safe way

00:19:15.519 --> 00:19:16.249
within our code.

00:19:16.249 --> 00:19:17.649
Now this is locally,

00:19:17.649 --> 00:19:19.369
this is going to work locally as we're developing,

00:19:19.369 --> 00:19:19.689
but

00:19:20.229 --> 00:19:21.509
we do if we actually want to

00:19:22.099 --> 00:19:24.259
have access to these when we deploy.

00:19:24.339 --> 00:19:26.859
So there's two core ways of managing secrets and

00:19:26.859 --> 00:19:28.179
we're going to go through both of them really,

00:19:28.179 --> 00:19:28.739
really quick.

00:19:28.739 --> 00:19:30.259
So the very first one,

00:19:30.259 --> 00:19:32.699
and this has been the way for like the last year

00:19:32.699 --> 00:19:33.979
that I've been developing on cloudflare,

00:19:33.979 --> 00:19:36.179
this has been like the core way of doing it is

00:19:36.819 --> 00:19:37.379
you can,

00:19:37.379 --> 00:19:39.659
you basically can come over here to Variables and

00:19:39.659 --> 00:19:40.057
Secrets,

00:19:40.092 --> 00:19:40.492
you

00:19:40.812 --> 00:19:42.732
can select secret and then you can say

00:19:44.092 --> 00:19:45.382
my variable,

00:19:46.412 --> 00:19:47.892
you have to give it the exact same name that you

00:19:47.892 --> 00:19:48.892
do inside of here.

00:19:48.892 --> 00:19:51.452
And honestly you could just like they have this

00:19:51.452 --> 00:19:52.172
nifty wave,

00:19:52.172 --> 00:19:53.852
you could just paste it in here and it

00:19:54.412 --> 00:19:55.452
should be able to

00:19:56.104 --> 00:19:57.824
should be able to grab the key and the value and

00:19:57.824 --> 00:19:58.984
then just make sure it's a secret.

00:19:58.984 --> 00:19:59.864
If it's text

00:20:00.504 --> 00:20:00.944
it'll,

00:20:00.944 --> 00:20:02.014
you'll be able to read it,

00:20:02.694 --> 00:20:03.694
inside of the ui.

00:20:03.694 --> 00:20:04.454
But if it's a secret,

00:20:04.534 --> 00:20:05.774
this is kind of a one time thing.

00:20:05.774 --> 00:20:07.254
You'll never be able to see the secret again.

00:20:07.414 --> 00:20:08.454
And when you do that,

00:20:08.774 --> 00:20:09.174
this

00:20:09.774 --> 00:20:10.294
and when you do that,

00:20:10.294 --> 00:20:11.294
when you save and deploy,

00:20:11.374 --> 00:20:13.614
your application will now have access to that

00:20:14.094 --> 00:20:14.734
variable.

00:20:14.734 --> 00:20:16.934
Now you could also manage these secrets through

00:20:16.934 --> 00:20:18.014
the Wrangler cli.

00:20:18.174 --> 00:20:20.214
They have a command where you can give it a key

00:20:20.214 --> 00:20:21.934
and a value and it will upload it as well.

00:20:21.934 --> 00:20:24.414
But I don't really follow that pattern.

00:20:24.414 --> 00:20:26.414
I do like to kind of manage the secrets through

00:20:26.414 --> 00:20:27.014
the ui.

00:20:27.014 --> 00:20:27.374
Now

00:20:27.934 --> 00:20:29.214
the thing to note here is

00:20:29.534 --> 00:20:30.094
this is

00:20:30.164 --> 00:20:32.194
a secret that's only available for this

00:20:32.194 --> 00:20:32.754
application.

00:20:33.074 --> 00:20:33.474
And

00:20:34.164 --> 00:20:36.724
a lot of times you'll have like a database key or

00:20:36.724 --> 00:20:39.564
an API key that's going to be used across multiple

00:20:39.564 --> 00:20:40.164
different services.

00:20:40.244 --> 00:20:43.314
And it could be kind of tedious to upload that

00:20:43.314 --> 00:20:44.834
secret to every single service,

00:20:44.914 --> 00:20:46.914
especially if you have like dozens of services,

00:20:46.914 --> 00:20:47.634
if it's a much,

00:20:47.634 --> 00:20:48.314
much bigger

00:20:48.794 --> 00:20:49.914
solution that you're building.

00:20:50.154 --> 00:20:51.394
So cloudflare recently,

00:20:51.394 --> 00:20:52.474
within the last few months,

00:20:52.474 --> 00:20:54.674
they actually created this product called Secret

00:20:54.674 --> 00:20:55.274
Store.

00:20:55.514 --> 00:20:57.834
Now with Secret Store it's very similar process.

00:20:57.954 --> 00:20:59.294
you provide a secret name,

00:20:59.454 --> 00:21:01.294
you give it access to a permission scope.

00:21:01.294 --> 00:21:02.614
With right now it seems that they only have

00:21:02.614 --> 00:21:03.214
workers available.

00:21:03.614 --> 00:21:04.654
You give it the value

00:21:05.114 --> 00:21:05.674
then you save.

00:21:05.674 --> 00:21:06.754
And when you save all the,

00:21:06.904 --> 00:21:09.224
all of your applications technically will have

00:21:09.224 --> 00:21:09.984
access to that.

00:21:09.984 --> 00:21:11.304
All of your worker applications.

00:21:11.384 --> 00:21:13.944
Now in order for your worker to be able to

00:21:13.944 --> 00:21:15.994
actually like pick up and use that

00:21:15.994 --> 00:21:16.264
secret,

00:21:16.744 --> 00:21:18.744
what you're going to want to do is you're going to

00:21:18.744 --> 00:21:19.304
want to say

00:21:19.354 --> 00:21:20.354
Inside of your

00:21:21.314 --> 00:21:22.754
wrangler JSON C,

00:21:23.554 --> 00:21:26.274
you'll have this additional configuration that you

00:21:26.274 --> 00:21:29.074
can say Secret Store and then you pass in the

00:21:29.154 --> 00:21:29.954
binding name.

00:21:30.114 --> 00:21:32.234
So you'll be able to access the secret by saying

00:21:32.234 --> 00:21:32.594
like

00:21:33.134 --> 00:21:34.134
that binding name.

00:21:34.134 --> 00:21:34.654
And then

00:21:35.384 --> 00:21:36.664
you'll be able to say like

00:21:37.304 --> 00:21:37.354
secret

00:21:37.564 --> 00:21:37.964
name.

00:21:38.174 --> 00:21:40.504
this is what you put inside of here.

00:21:41.704 --> 00:21:43.744
And then when you create it it will give you an

00:21:43.744 --> 00:21:43.984
id.

00:21:43.984 --> 00:21:45.464
So I guess I will just like say

00:21:46.024 --> 00:21:46.424
test

00:21:47.224 --> 00:21:47.624
key

00:21:48.065 --> 00:21:48.465
value.

00:21:49.504 --> 00:21:50.575
I'm going to hit save.

00:21:50.575 --> 00:21:51.133
Okay,

00:21:51.133 --> 00:21:51.933
so this is.

00:21:51.933 --> 00:21:53.253
So I gave it the test key name.

00:21:53.253 --> 00:21:54.773
I probably should have made this lowercase.

00:21:54.773 --> 00:21:56.693
But when this is done pending

00:21:57.063 --> 00:21:58.143
we'll have access to it.

00:21:58.143 --> 00:21:59.463
But basically you would put in

00:22:00.133 --> 00:22:01.573
the secret name would be like this.

00:22:04.345 --> 00:22:05.945
And then when we run CF type gen

00:22:10.942 --> 00:22:13.101
we're going to see in our code base will now

00:22:13.901 --> 00:22:14.301
const.

00:22:14.861 --> 00:22:15.581
Test key

00:22:15.981 --> 00:22:17.581
should now have access to

00:22:18.221 --> 00:22:18.621
this

00:22:18.801 --> 00:22:20.241
test API key which

00:22:21.021 --> 00:22:21.661
we defined

00:22:21.981 --> 00:22:22.621
right here.

00:22:22.781 --> 00:22:23.181
So

00:22:23.551 --> 00:22:24.191
this is the,

00:22:24.191 --> 00:22:25.311
this is the best way of doing it.

00:22:25.311 --> 00:22:27.711
If you want to kind of define like one key one

00:22:27.711 --> 00:22:29.951
time inside of the UI and then have it available

00:22:30.031 --> 00:22:31.871
across all the workers in your account,

00:22:32.111 --> 00:22:33.031
you can go this route.

00:22:33.031 --> 00:22:33.711
If you really just.

00:22:33.711 --> 00:22:35.511
It's kind of like a one off thing where it's only

00:22:35.511 --> 00:22:36.591
applicable to one worker.

00:22:36.751 --> 00:22:38.271
You can do that inside of the worker

00:22:38.271 --> 00:22:38.872
configuration.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.023 --> 00:00:00.303
All right,

00:00:00.303 --> 00:00:02.303
so now that we understand how to use bindings to

00:00:02.303 --> 00:00:03.703
access secrets and variables,

00:00:03.703 --> 00:00:06.263
let's talk about binding resources to our actual

00:00:06.263 --> 00:00:07.303
worker application.

00:00:07.783 --> 00:00:09.983
a good example of this would basically be if you

00:00:09.983 --> 00:00:10.743
come over to

00:00:11.693 --> 00:00:12.763
storage and databases,

00:00:12.843 --> 00:00:14.163
you're going to notice we have a few different

00:00:14.163 --> 00:00:14.683
products here.

00:00:14.683 --> 00:00:17.723
We have a KV for a caching key value store.

00:00:17.723 --> 00:00:19.683
We have a SQL D1 database.

00:00:19.683 --> 00:00:21.563
This is a SQLite powered database that we're going

00:00:21.563 --> 00:00:22.523
to be using throughout the course.

00:00:22.523 --> 00:00:23.123
This is free,

00:00:23.123 --> 00:00:25.033
it's part of the free cloudflare tier.

00:00:25.063 --> 00:00:28.203
hyperdrive is a proxy to postgres databases.

00:00:28.203 --> 00:00:29.723
It's a really cool product but I don't want to go

00:00:29.723 --> 00:00:30.793
too deep into it right now.

00:00:31.153 --> 00:00:32.913
we have queues which we're going to use pretty

00:00:32.913 --> 00:00:34.673
deeply in the course analytics engine.

00:00:34.923 --> 00:00:36.603
then you have R2 object storage.

00:00:36.603 --> 00:00:38.363
So if you want to store like large files,

00:00:38.363 --> 00:00:38.843
images,

00:00:38.923 --> 00:00:39.403
text,

00:00:39.483 --> 00:00:40.203
videos,

00:00:40.223 --> 00:00:41.343
big huge JSON blocks,

00:00:41.343 --> 00:00:43.303
this is like a great storage mechanism for that.

00:00:43.303 --> 00:00:45.223
And they have a free tier so you have to put in a

00:00:45.223 --> 00:00:45.983
credit card but you know,

00:00:45.983 --> 00:00:46.743
you like have

00:00:47.243 --> 00:00:48.843
certain amount of gigabytes that you get for free

00:00:48.843 --> 00:00:50.523
every single month and then you have these

00:00:50.523 --> 00:00:53.463
operations so deletes and reads and updates and

00:00:53.463 --> 00:00:53.943
whatnot.

00:00:53.943 --> 00:00:56.343
So this is honestly so stinking cheap.

00:00:56.343 --> 00:00:58.743
If you Compare it to S3 it's even cheaper than S3

00:00:58.743 --> 00:01:00.063
and it's S3 compatible from,

00:01:00.063 --> 00:01:00.743
from Amazon.

00:01:00.743 --> 00:01:01.663
So pretty cool.

00:01:01.663 --> 00:01:02.423
So anyways,

00:01:02.423 --> 00:01:04.623
I'm just going through this because all of these

00:01:04.623 --> 00:01:05.703
things are resources.

00:01:05.703 --> 00:01:07.743
These are basically like types of compute or data

00:01:07.743 --> 00:01:10.103
store that we want to be able to access from our

00:01:10.103 --> 00:01:10.423
worker.

00:01:10.423 --> 00:01:11.503
And in Cloudflare,

00:01:11.823 --> 00:01:14.023
binding a worker to a resource that's within

00:01:14.023 --> 00:01:16.223
Cloudflare's ecosystem is really easy.

00:01:16.223 --> 00:01:17.103
And it's like,

00:01:17.103 --> 00:01:18.783
I mean it's really easy but it's also

00:01:19.263 --> 00:01:19.583
really,

00:01:19.583 --> 00:01:20.303
really powerful.

00:01:20.303 --> 00:01:21.903
So they have this page bindings,

00:01:21.903 --> 00:01:22.343
they have like,

00:01:22.343 --> 00:01:23.023
some of these bind,

00:01:23.763 --> 00:01:25.363
have access to and you can see there's also like

00:01:25.363 --> 00:01:25.923
AI.

00:01:25.923 --> 00:01:28.163
So there's this whole AI section where they have a

00:01:28.163 --> 00:01:30.123
vector database if you want to like build a vector

00:01:30.123 --> 00:01:30.883
based application.

00:01:31.733 --> 00:01:32.373
they have

00:01:33.123 --> 00:01:33.523
they,

00:01:33.763 --> 00:01:35.243
they have workers AI.

00:01:35.243 --> 00:01:36.763
These are a whole bunch of open source models that

00:01:36.763 --> 00:01:38.323
you can access without having to like go to

00:01:38.323 --> 00:01:39.122
OpenAI or other

00:01:39.923 --> 00:01:40.643
providers.

00:01:41.523 --> 00:01:42.403
They have images,

00:01:42.483 --> 00:01:43.123
they have

00:01:43.593 --> 00:01:45.553
Something that I find really cool is they have

00:01:45.553 --> 00:01:47.313
workflows that we're going to go really deep into.

00:01:47.313 --> 00:01:48.753
So there's a whole bunch of different things here.

00:01:48.753 --> 00:01:49.993
And for all of these products,

00:01:50.073 --> 00:01:51.193
if you just click on it,

00:01:51.273 --> 00:01:53.073
the documentations will basically Say like,

00:01:53.073 --> 00:01:55.333
here's how you use it in a work if you want to get

00:01:55.333 --> 00:01:56.933
a cape key key value.

00:01:57.613 --> 00:01:58.893
so that's what we're going to do right now,

00:01:58.893 --> 00:02:00.893
really quick just to kind of understand how we're

00:02:00.893 --> 00:02:01.213
going to,

00:02:01.213 --> 00:02:03.373
how to bind a resource to a worker.

00:02:03.613 --> 00:02:05.293
So if we head over to our

00:02:05.575 --> 00:02:06.478
storage and databases,

00:02:06.478 --> 00:02:07.398
let's go to kb,

00:02:07.478 --> 00:02:08.238
create an instance.

00:02:08.238 --> 00:02:10.987
I'm going to call this test cache for now.

00:02:10.987 --> 00:02:13.274
And then essentially what you have to do now that

00:02:13.274 --> 00:02:14.114
we have this created,

00:02:14.114 --> 00:02:15.434
you can head over to your

00:02:16.234 --> 00:02:17.654
Wrangler JSON file.

00:02:17.654 --> 00:02:19.894
And because this has a schema attached to it,

00:02:19.894 --> 00:02:21.334
depending on which IDE you use,

00:02:21.414 --> 00:02:23.174
you can actually like without even really having

00:02:23.394 --> 00:02:24.274
go look at the docs.

00:02:24.514 --> 00:02:26.674
It'll give you some type hints that will probably

00:02:26.674 --> 00:02:27.714
guide you through this.

00:02:27.714 --> 00:02:28.994
Because like I don't have this memorized,

00:02:28.994 --> 00:02:30.514
but I just kind of come through here.

00:02:30.674 --> 00:02:31.714
I'm going to say like,

00:02:31.714 --> 00:02:34.354
I'm looking for KV KV namespaces.

00:02:34.434 --> 00:02:36.914
You can have more than one KV namespace associated

00:02:36.914 --> 00:02:37.554
with your

00:02:38.134 --> 00:02:39.054
worker application.

00:02:39.294 --> 00:02:40.454
It's going to take a binding,

00:02:40.454 --> 00:02:43.294
I'll call this cache and then it's also going to

00:02:43.294 --> 00:02:46.214
take a ID so we can run over and we can grab this

00:02:46.214 --> 00:02:47.054
ID right here.

00:02:47.134 --> 00:02:49.374
Now another thing that you're going to note here,

00:02:49.374 --> 00:02:50.414
a lot of the

00:02:50.734 --> 00:02:52.654
a lot of these resources have this

00:02:53.134 --> 00:02:53.934
experimental

00:02:54.394 --> 00:02:55.154
and what experimental?

00:02:55.154 --> 00:02:55.634
Remote.

00:02:55.634 --> 00:02:57.154
This is a new feature that they've rolled out.

00:02:57.154 --> 00:02:58.914
If you're watching this course a few months from

00:02:58.914 --> 00:02:59.114
now,

00:02:59.114 --> 00:03:00.554
this might not be experimental anymore,

00:03:00.554 --> 00:03:01.644
it might just be remote.

00:03:01.674 --> 00:03:02.634
so if it's different,

00:03:02.634 --> 00:03:03.514
don't worry too much.

00:03:03.514 --> 00:03:05.074
We're going to use this feature throughout the

00:03:05.074 --> 00:03:05.274
course.

00:03:05.274 --> 00:03:06.874
But essentially what this means is when you're

00:03:06.874 --> 00:03:07.834
developing locally

00:03:08.324 --> 00:03:09.654
Typically what happens is when,

00:03:09.654 --> 00:03:10.814
when you're developing Locally,

00:03:10.814 --> 00:03:13.494
there's this dot wrangler folder and this has the

00:03:13.494 --> 00:03:14.494
state v3.

00:03:14.494 --> 00:03:15.654
There's a whole bunch of like,

00:03:16.254 --> 00:03:17.974
like all of these Cloudflare resources.

00:03:17.974 --> 00:03:19.894
There's the simulated environment that you,

00:03:19.894 --> 00:03:21.844
that spins up when you run this application

00:03:21.844 --> 00:03:25.084
locally and it like stores your data within the

00:03:25.084 --> 00:03:25.684
application.

00:03:26.194 --> 00:03:28.954
which means when you're like making a request to a

00:03:28.954 --> 00:03:29.834
key value store,

00:03:29.834 --> 00:03:31.354
you're actually just like sourcing out of this

00:03:31.354 --> 00:03:33.314
folder when you're developing locally and you're

00:03:33.314 --> 00:03:36.353
not going to the actual hosted version,

00:03:37.124 --> 00:03:38.564
the hosted resource now,

00:03:38.914 --> 00:03:39.664
it's kind of like

00:03:40.144 --> 00:03:41.904
one that's a pretty major inconvenience when

00:03:41.904 --> 00:03:42.384
you're developing.

00:03:42.384 --> 00:03:43.944
Like a lot of times you want to just be able to

00:03:43.944 --> 00:03:44.864
like have,

00:03:45.274 --> 00:03:45.634
you know,

00:03:45.634 --> 00:03:47.834
access the actual store that you're using or the

00:03:47.834 --> 00:03:48.954
actual resource that you're using.

00:03:49.314 --> 00:03:51.714
so what this flag does is it basically says when

00:03:51.714 --> 00:03:52.794
you're running this locally,

00:03:52.794 --> 00:03:55.874
it actually goes and it uses this specific

00:03:56.224 --> 00:03:57.024
key like

00:03:57.024 --> 00:03:58.194
KB namespace.

00:03:58.194 --> 00:03:59.834
But for right now we're not going to worry about

00:03:59.834 --> 00:04:00.094
that.

00:04:00.094 --> 00:04:01.194
we're going to use this throughout the course.

00:04:01.194 --> 00:04:02.674
This is just going to be locally.

00:04:02.844 --> 00:04:04.204
so I'm going to say npm

00:04:05.804 --> 00:04:07.316
NPM run CF

00:04:07.371 --> 00:04:08.171
type gen

00:04:08.601 --> 00:04:10.201
and if you're curious where that command's being

00:04:10.201 --> 00:04:10.681
sourced from,

00:04:10.681 --> 00:04:12.601
if we come over to the package JSON,

00:04:13.741 --> 00:04:15.698
you can see that we have this script

00:04:15.777 --> 00:04:18.397
and it is basically just running wrangler types.

00:04:18.687 --> 00:04:19.087
now

00:04:19.647 --> 00:04:20.567
what happens is,

00:04:20.567 --> 00:04:23.167
if we come over to our Hono API,

00:04:23.167 --> 00:04:25.407
I have a new route here called Save id.

00:04:25.487 --> 00:04:27.447
This is going to be like an ID that we pass in.

00:04:27.447 --> 00:04:28.127
So I'm going to say

00:04:28.447 --> 00:04:28.547
await,

00:04:28.927 --> 00:04:30.927
C EMV cache

00:04:31.247 --> 00:04:34.527
and then it's going to want to have you put a key.

00:04:34.527 --> 00:04:35.727
I'm going to have a static key.

00:04:35.727 --> 00:04:36.207
This is

00:04:37.117 --> 00:04:37.357
test

00:04:38.557 --> 00:04:38.957
key.

00:04:39.837 --> 00:04:40.677
This is like,

00:04:40.677 --> 00:04:42.237
not a real like use case.

00:04:42.237 --> 00:04:43.917
This is just kind of to illustrate how to use

00:04:43.917 --> 00:04:45.197
bindings in an application.

00:04:45.197 --> 00:04:47.437
And then I'm going to also have this route that

00:04:47.437 --> 00:04:48.557
says get last id.

00:04:48.717 --> 00:04:49.117
So

00:04:49.517 --> 00:04:51.277
we're going to say ID

00:04:51.597 --> 00:04:52.237
calls

00:04:52.637 --> 00:04:53.037
C

00:04:53.527 --> 00:04:55.527
cache dot get and then the same key that we

00:04:55.527 --> 00:04:56.367
specified here.

00:04:56.527 --> 00:04:58.207
So when we run this locally,

00:04:58.810 --> 00:05:00.608
what we're going to have here is we're going to

00:05:00.608 --> 00:05:01.848
have this like

00:05:01.968 --> 00:05:04.608
this is a Hono react starter template power

00:05:04.688 --> 00:05:05.808
provided by Cloudflare.

00:05:05.968 --> 00:05:08.688
Now we're going to go over to our save ID endpoint

00:05:08.688 --> 00:05:10.048
and then we're going to pass in

00:05:12.362 --> 00:05:12.762
test

00:05:13.082 --> 00:05:14.042
ID1.

00:05:14.362 --> 00:05:16.202
So it saved test ID1.

00:05:16.362 --> 00:05:16.762
Now

00:05:17.162 --> 00:05:18.522
open this into a new tab.

00:05:18.522 --> 00:05:19.242
If we go

00:05:19.731 --> 00:05:20.771
get last id,

00:05:20.851 --> 00:05:22.291
you can see that we grabbed,

00:05:22.371 --> 00:05:24.771
the last ID that was saved in our key value store.

00:05:24.771 --> 00:05:26.051
So we hit this route,

00:05:26.211 --> 00:05:28.851
we save it in our KB and then we had this route

00:05:28.851 --> 00:05:30.731
and then we pull the last one from our kv.

00:05:30.731 --> 00:05:32.371
So if we come back over here and then I'm going to

00:05:32.371 --> 00:05:32.611
say

00:05:33.201 --> 00:05:33.441
two.

00:05:34.161 --> 00:05:35.441
So that just saved two.

00:05:35.441 --> 00:05:37.161
Now we're going to go hit this and this should be

00:05:37.161 --> 00:05:38.681
updated to 2 because this is like.

00:05:38.681 --> 00:05:40.481
So basically what we're doing is we are persisting

00:05:40.481 --> 00:05:42.081
state across different routes.

00:05:42.641 --> 00:05:44.681
This isn't a real use case for kv,

00:05:44.681 --> 00:05:46.681
but we're going to be using some very,

00:05:46.681 --> 00:05:48.841
very realistic use cases for KV throughout this

00:05:48.841 --> 00:05:49.121
course.

00:05:49.121 --> 00:05:49.521
Now,

00:05:50.121 --> 00:05:52.161
this is really all that I have to talk about in

00:05:52.161 --> 00:05:54.881
terms of how to use bindings with resources.

00:05:54.881 --> 00:05:55.641
But just note,

00:05:55.641 --> 00:05:55.961
like,

00:05:56.121 --> 00:05:58.161
every single time you see a new Cloudflare product

00:05:58.161 --> 00:05:59.161
that you're not familiar with,

00:05:59.371 --> 00:06:01.331
you can simply just go find the documentation and

00:06:01.331 --> 00:06:03.491
you can just look at the examples of how you use

00:06:03.491 --> 00:06:03.731
it.

00:06:03.731 --> 00:06:04.311
it's pretty.

00:06:04.311 --> 00:06:04.631
I mean,

00:06:04.631 --> 00:06:04.871
it's.

00:06:04.871 --> 00:06:05.151
Honestly,

00:06:05.151 --> 00:06:06.631
it's very straightforward on how to use it.

00:06:06.631 --> 00:06:08.551
I think the documentation isn't bad in terms of,

00:06:08.551 --> 00:06:08.711
like,

00:06:08.711 --> 00:06:10.271
the resources that you have access to.

00:06:10.591 --> 00:06:11.111
And then,

00:06:11.111 --> 00:06:11.511
you know,

00:06:11.511 --> 00:06:12.491
you can go through your wrangler,

00:06:12.851 --> 00:06:15.531
JSON file and it probably will just like give you

00:06:15.531 --> 00:06:18.051
like the type hints as you're building out this

00:06:18.051 --> 00:06:19.651
configuration where you don't even have to look at

00:06:19.651 --> 00:06:20.091
the docs,

00:06:20.091 --> 00:06:21.451
but if you have to look at the docs,

00:06:21.451 --> 00:06:21.851
obviously,

00:06:21.851 --> 00:06:22.011
like,

00:06:22.011 --> 00:06:23.331
all the docs are going to have

00:06:23.731 --> 00:06:24.931
examples of how to like,

00:06:24.931 --> 00:06:26.051
manage those bindings.

00:06:26.051 --> 00:06:26.851
So like,

00:06:26.851 --> 00:06:27.171
every,

00:06:27.411 --> 00:06:28.191
every single,

00:06:28.191 --> 00:06:29.531
product here will have like,

00:06:29.531 --> 00:06:30.251
examples of how

00:06:30.551 --> 00:06:30.711
them.

00:06:30.711 --> 00:06:31.031
So,

00:06:31.131 --> 00:06:31.501
that's,

00:06:31.501 --> 00:06:32.581
that's how to go through the process.

00:06:32.581 --> 00:06:34.821
You're going to become insanely familiar with this

00:06:34.821 --> 00:06:36.141
because it's really powerful.

00:06:36.141 --> 00:06:36.341
Like,

00:06:36.341 --> 00:06:37.181
if you think about it,

00:06:37.261 --> 00:06:39.741
to throw up a key value store in an application

00:06:39.741 --> 00:06:40.981
was like just one.

00:06:40.981 --> 00:06:42.781
Like it was a input form,

00:06:42.941 --> 00:06:43.821
hit submit,

00:06:43.901 --> 00:06:45.341
and then this is the code.

00:06:45.341 --> 00:06:46.861
Like one line of code to save,

00:06:46.861 --> 00:06:47.901
one line of code to get.

00:06:47.901 --> 00:06:48.581
It's really powerful.

00:06:48.581 --> 00:06:50.581
And I feel like all of the resources that I use

00:06:50.581 --> 00:06:51.861
for Cloudflare are kind of like this.

00:06:51.861 --> 00:06:52.181
I'm like,

00:06:52.181 --> 00:06:52.541
wow,

00:06:52.541 --> 00:06:54.381
that was way easier to implement than I expected.

00:06:54.381 --> 00:06:56.901
Just because you're developing in an ecosystem

00:06:56.901 --> 00:06:57.221
that,

00:06:57.221 --> 00:06:57.741
you know,

00:06:57.741 --> 00:06:58.941
has a lot of really cool products.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.356 --> 00:00:00.716
All right,

00:00:00.716 --> 00:00:02.836
so we finally got to the part of the course that's

00:00:02.836 --> 00:00:03.476
actually fun.

00:00:03.476 --> 00:00:05.116
We're going to actually start building everything

00:00:05.116 --> 00:00:06.796
out and we're going to learn by doing,

00:00:06.796 --> 00:00:08.516
which honestly is the best way to learn.

00:00:08.516 --> 00:00:10.356
Instead of me just like lecturing for the next 12

00:00:10.356 --> 00:00:10.636
hours,

00:00:10.636 --> 00:00:11.636
we're going to dive very,

00:00:11.636 --> 00:00:14.236
very deep into a code and we're going to start

00:00:14.236 --> 00:00:16.356
with the front end and we're going to slowly start

00:00:16.356 --> 00:00:17.476
moving our way to the back end.

00:00:17.716 --> 00:00:19.636
The further back that we go into the stack,

00:00:19.716 --> 00:00:22.276
the more in depth the material is going to get.

00:00:22.356 --> 00:00:24.676
So if you're overwhelmed by how fast we go over

00:00:24.676 --> 00:00:25.316
the front end,

00:00:25.476 --> 00:00:26.156
that's okay.

00:00:26.156 --> 00:00:27.656
I kind of expect that the.

00:00:27.806 --> 00:00:30.606
This course is meant to be a framework agnostic

00:00:30.606 --> 00:00:32.286
look at how to build on top of cloudflare,

00:00:32.286 --> 00:00:34.366
so you can bring whatever framework you want and

00:00:34.526 --> 00:00:36.406
it's geared towards helping you really understand

00:00:36.406 --> 00:00:38.086
how to build a service on the back end.

00:00:38.086 --> 00:00:39.646
So we're going to go through the front end.

00:00:39.646 --> 00:00:40.566
We're going to look at,

00:00:40.566 --> 00:00:40.926
like,

00:00:40.926 --> 00:00:41.326
how

00:00:41.438 --> 00:00:43.129
page navigation works and the different

00:00:43.129 --> 00:00:44.170
technologies that we use.

00:00:44.170 --> 00:00:45.810
But don't be too overwhelmed if you don't

00:00:45.810 --> 00:00:46.930
understand a lot of this,

00:00:46.930 --> 00:00:48.930
just because that's not what we're trying to do.

00:00:48.930 --> 00:00:50.290
We're not trying to teach you how to use this

00:00:50.290 --> 00:00:50.690
framework,

00:00:50.690 --> 00:00:52.090
we're not going to try to teach you how to use

00:00:52.090 --> 00:00:53.290
REACT and trpc.

00:00:53.290 --> 00:00:54.730
I just want to show you how we're using it.

00:00:54.890 --> 00:00:55.050
And,

00:00:55.120 --> 00:00:56.520
and then that's going to kind of help solidify

00:00:56.520 --> 00:00:58.480
this project structure and how to navigate things.

00:00:58.560 --> 00:01:00.520
So what we're going to do is we're going to head

00:01:00.520 --> 00:01:01.282
over to Apps

00:01:01.282 --> 00:01:02.242
User Application,

00:01:02.242 --> 00:01:03.162
which is our front end,

00:01:03.162 --> 00:01:05.162
and then we're also going to CD into that

00:01:05.162 --> 00:01:06.162
directory as well.

00:01:06.162 --> 00:01:07.082
So Apps

00:01:07.562 --> 00:01:10.082
User Application and then we're going to say PNPM

00:01:10.082 --> 00:01:10.682
run dev.

00:01:10.682 --> 00:01:12.362
So this is going to boot up our application.

00:01:12.842 --> 00:01:14.202
If we come over here,

00:01:14.202 --> 00:01:16.642
we'll go to that homepage on Port 3000,

00:01:16.642 --> 00:01:18.282
which is where our application is running,

00:01:18.282 --> 00:01:19.962
and you can see that this is the homepage.

00:01:19.962 --> 00:01:20.316
Now,

00:01:20.414 --> 00:01:22.334
when you click on Get Started for Free,

00:01:22.734 --> 00:01:25.854
it navigates us over to the forward slash app,

00:01:26.094 --> 00:01:29.734
which is kind of like the dashboard section of the

00:01:29.734 --> 00:01:32.414
user application is kind of like where the users

00:01:32.414 --> 00:01:32.734
are,

00:01:33.274 --> 00:01:35.153
doing like managing the links and actually

00:01:35.153 --> 00:01:36.434
interacting with the application.

00:01:36.674 --> 00:01:38.434
This is also towards the end of the course,

00:01:38.434 --> 00:01:40.514
we're going to implement some authentication.

00:01:40.514 --> 00:01:42.834
So forward slash app will be protected only

00:01:42.834 --> 00:01:45.634
authenticated logged in users will be able to view

00:01:45.864 --> 00:01:46.984
the contents of this page.

00:01:47.624 --> 00:01:49.464
So how are we doing this right now?

00:01:49.464 --> 00:01:49.704
This,

00:01:49.704 --> 00:01:51.944
this application is set up on a very,

00:01:51.944 --> 00:01:52.784
it's actually very simple,

00:01:52.784 --> 00:01:53.544
it's just React,

00:01:53.704 --> 00:01:56.864
it's using Tanstack router for page navigation and

00:01:56.864 --> 00:01:58.664
then the data being passed and forth from the

00:01:58.664 --> 00:02:01.344
front end to the back end is provided by trpc

00:02:01.344 --> 00:02:03.704
which is running on a really lightweight worker on

00:02:03.704 --> 00:02:04.664
cloudflare workers.

00:02:04.744 --> 00:02:06.344
So we'll kind of get into that right now.

00:02:06.344 --> 00:02:07.817
Now if you head over to source

00:02:07.817 --> 00:02:08.924
and you look at Routes,

00:02:09.244 --> 00:02:10.364
if you're familiar with Next,

00:02:10.364 --> 00:02:12.194
JS is a very similar convention.

00:02:12.194 --> 00:02:13.644
the only difference is we don't have like

00:02:14.254 --> 00:02:16.154
dot page page dot tsx.

00:02:16.154 --> 00:02:17.004
that's not the convention.

00:02:17.004 --> 00:02:17.684
It's basically

00:02:18.004 --> 00:02:19.364
any file name

00:02:19.684 --> 00:02:22.484
inside of Routes becomes its own page.

00:02:22.724 --> 00:02:23.124
And

00:02:23.844 --> 00:02:26.284
what you can see here is this is the index inside

00:02:26.284 --> 00:02:26.804
of app

00:02:26.819 --> 00:02:28.072
and this is the home page.

00:02:28.392 --> 00:02:29.952
And then if you look at app,

00:02:29.952 --> 00:02:31.912
so forward slash app would be the path,

00:02:32.312 --> 00:02:34.372
inside of this auth underscore auth.

00:02:34.372 --> 00:02:36.212
So because this is protected we'll kind of get

00:02:36.212 --> 00:02:37.772
into how this works later in the course.

00:02:37.772 --> 00:02:41.012
But inside of Auth we have this index tsx

00:02:41.412 --> 00:02:43.052
and that is this page right here.

00:02:43.052 --> 00:02:45.372
The actual dashboard that we're seeing now this

00:02:45.372 --> 00:02:47.412
dashboard is pulling data from

00:02:47.912 --> 00:02:51.308
a variety of TRBC endpoints on the back end.

00:02:51.628 --> 00:02:53.068
And what you're going to notice is

00:02:53.548 --> 00:02:55.668
it's a very common convention where we have a

00:02:55.668 --> 00:02:56.188
loader,

00:02:56.428 --> 00:02:58.028
which is a 10 stack

00:02:58.208 --> 00:02:58.848
router

00:02:59.168 --> 00:03:01.968
convention where essentially when the page loads

00:03:02.368 --> 00:03:04.328
all of this logic gets executed.

00:03:04.328 --> 00:03:05.808
And this logic is basically

00:03:06.238 --> 00:03:08.678
prefetching a whole bunch of data that's living in

00:03:08.678 --> 00:03:08.878
a,

00:03:08.878 --> 00:03:10.758
that's living behind a TRPC route.

00:03:10.758 --> 00:03:13.678
So that's living behind a backend handler that's

00:03:13.678 --> 00:03:15.198
going to be pulling data from a database,

00:03:15.278 --> 00:03:16.718
providing it back to the front end.

00:03:16.958 --> 00:03:17.518
And then

00:03:18.848 --> 00:03:20.208
we're going to have a whole bunch of these

00:03:20.208 --> 00:03:21.048
different components.

00:03:21.048 --> 00:03:22.208
So we have these cards,

00:03:22.208 --> 00:03:24.448
these metric cards and we have some of these

00:03:24.448 --> 00:03:24.968
tables.

00:03:24.968 --> 00:03:27.488
So if we come down here and we look at top

00:03:27.488 --> 00:03:28.368
countries table,

00:03:28.688 --> 00:03:30.048
which is this table right here,

00:03:30.368 --> 00:03:31.568
we can drill into that

00:03:32.044 --> 00:03:34.285
and you can see this is just a very typical J R

00:03:34.285 --> 00:03:35.365
TSX component

00:03:35.825 --> 00:03:36.265
React.

00:03:36.745 --> 00:03:37.625
Now the

00:03:37.945 --> 00:03:40.545
main difference here is we're actually like

00:03:40.545 --> 00:03:41.145
fetching data,

00:03:41.385 --> 00:03:43.265
but we're not fetching data in the traditional

00:03:43.265 --> 00:03:44.985
sense of like making an API call,

00:03:44.985 --> 00:03:45.745
handling the data,

00:03:45.745 --> 00:03:47.625
parsing everything and then passing it through.

00:03:48.105 --> 00:03:50.305
We have a very simplified version of like how

00:03:50.305 --> 00:03:51.785
we're grabbing data from the back end.

00:03:51.785 --> 00:03:53.065
And this is using

00:03:53.345 --> 00:03:55.435
Use query from Tanstack.

00:03:55.675 --> 00:03:57.755
Now this is honestly probably the most popular

00:03:57.985 --> 00:04:00.945
powerful data fetching library I've ever seen or

00:04:00.945 --> 00:04:01.265
used.

00:04:01.345 --> 00:04:04.505
And I feel stupid that I wasn't using it earlier

00:04:04.505 --> 00:04:06.385
in my career and I'll show you why.

00:04:06.465 --> 00:04:07.345
So if you,

00:04:07.345 --> 00:04:09.185
if you're familiar with Tanstack query,

00:04:09.425 --> 00:04:10.905
you can just kind of forward through this.

00:04:10.905 --> 00:04:12.225
But if you're not,

00:04:12.385 --> 00:04:12.905
honestly,

00:04:12.905 --> 00:04:14.465
I think I'm going to change the way that you're

00:04:14.465 --> 00:04:15.985
going to develop like how you're going to

00:04:15.985 --> 00:04:16.625
implement fetching,

00:04:16.625 --> 00:04:18.385
fetching logic inside of your applications.

00:04:18.545 --> 00:04:20.025
And it doesn't matter what framework,

00:04:20.025 --> 00:04:22.985
like they have a svelte version of it,

00:04:22.985 --> 00:04:23.505
they have

00:04:23.765 --> 00:04:24.085
Vue,

00:04:24.085 --> 00:04:25.045
they have Solid.

00:04:25.045 --> 00:04:25.565
And if,

00:04:25.565 --> 00:04:26.565
obviously if you work in.

00:04:26.565 --> 00:04:26.765
Net,

00:04:26.765 --> 00:04:27.325
in React,

00:04:27.565 --> 00:04:28.965
they have the React version of it,

00:04:28.965 --> 00:04:30.905
which is kind of like the first one that came out.

00:04:30.905 --> 00:04:31.305
So

00:04:32.025 --> 00:04:34.545
when you have a front end component and that

00:04:34.545 --> 00:04:36.625
component mounts for the first time and you need

00:04:36.625 --> 00:04:37.945
to go get data from a backend,

00:04:37.945 --> 00:04:40.305
this is a very typical pattern and honestly it's

00:04:40.305 --> 00:04:40.585
wrong.

00:04:40.585 --> 00:04:42.665
But this is how I see so many people do it,

00:04:42.745 --> 00:04:43.865
even at large companies,

00:04:44.105 --> 00:04:45.225
like working at a large company.

00:04:45.225 --> 00:04:47.065
I can't tell you how many times I've seen code

00:04:47.145 --> 00:04:47.745
just like this.

00:04:47.745 --> 00:04:49.345
And honestly I think I've written code like this

00:04:49.345 --> 00:04:50.105
in the past when I,

00:04:50.105 --> 00:04:51.905
when I started out and was kind of newer.

00:04:51.905 --> 00:04:54.745
So you have like a users component that

00:04:55.115 --> 00:04:57.715
when it mounts it has a use effect and then that

00:04:57.715 --> 00:05:00.995
use effect has a asynchronous data call to a

00:05:00.995 --> 00:05:01.515
backend.

00:05:01.515 --> 00:05:02.844
And because you can't like

00:05:02.844 --> 00:05:05.482
cleanly define an async function inside of a use

00:05:05.482 --> 00:05:05.802
effect,

00:05:05.802 --> 00:05:08.602
you have to define the fetch users function and

00:05:08.602 --> 00:05:10.842
then also call it inside of the use effect,

00:05:10.922 --> 00:05:12.642
which is just kind of tedious.

00:05:12.642 --> 00:05:13.002
But

00:05:13.892 --> 00:05:15.612
essentially what you want to do is you want to get

00:05:15.612 --> 00:05:18.412
some data from this user's endpoint and then you

00:05:18.412 --> 00:05:20.692
want to populate a user state.

00:05:20.852 --> 00:05:22.372
So you fetch some data

00:05:22.982 --> 00:05:24.022
and when you get the data,

00:05:24.342 --> 00:05:25.542
you set user.

00:05:25.542 --> 00:05:27.462
So you set data users to the

00:05:27.492 --> 00:05:29.752
response back from the API and then that is

00:05:29.752 --> 00:05:31.312
rendered in the UI down here.

00:05:31.712 --> 00:05:33.752
Now that API call might take a few seconds.

00:05:33.752 --> 00:05:34.792
So if it takes a few seconds,

00:05:34.792 --> 00:05:35.392
what do you do?

00:05:35.392 --> 00:05:36.512
You need some loading state,

00:05:36.512 --> 00:05:36.792
right?

00:05:36.792 --> 00:05:38.152
So your application is a little bit more

00:05:38.152 --> 00:05:38.832
interactive.

00:05:38.832 --> 00:05:41.512
So you throw in an is loading function or an is

00:05:41.512 --> 00:05:42.112
loading state,

00:05:43.322 --> 00:05:43.812
object.

00:05:44.132 --> 00:05:46.932
So then it's set to true and then the data call

00:05:46.932 --> 00:05:48.852
happens and then once all that stuff is done,

00:05:48.852 --> 00:05:50.372
then you set it default and when it's,

00:05:50.492 --> 00:05:51.012
when it's true,

00:05:51.012 --> 00:05:52.852
you have a little loading indicator and when it's

00:05:52.852 --> 00:05:53.212
false,

00:05:53.212 --> 00:05:54.652
that loading indicator goes away.

00:05:54.812 --> 00:05:55.972
And then if there's an error,

00:05:55.972 --> 00:05:57.252
if that API error is out,

00:05:57.252 --> 00:05:58.212
the Server's down or something.

00:05:58.212 --> 00:05:59.172
You also want to,

00:05:59.172 --> 00:05:59.532
you know,

00:05:59.532 --> 00:06:00.932
have a clean error message as well.

00:06:00.932 --> 00:06:02.972
So you throw in another state variable.

00:06:02.972 --> 00:06:04.252
Now this code is honestly,

00:06:04.252 --> 00:06:04.842
it's pretty bad.

00:06:04.842 --> 00:06:05.891
and if you don't know why it's bad,

00:06:05.891 --> 00:06:06.652
that's really fine.

00:06:06.652 --> 00:06:08.572
But I want to show you how to make it so much

00:06:08.572 --> 00:06:08.892
better.

00:06:09.412 --> 00:06:10.772
one of the issues here is

00:06:11.092 --> 00:06:11.772
this data,

00:06:11.772 --> 00:06:13.532
this user's data isn't type safe.

00:06:13.532 --> 00:06:16.532
We don't know if user has a name or if user has a

00:06:16.532 --> 00:06:19.212
last name or if it's camel case or if they have an

00:06:19.212 --> 00:06:19.452
email.

00:06:19.452 --> 00:06:19.732
Right,

00:06:19.732 --> 00:06:20.252
we don't know that.

00:06:20.252 --> 00:06:22.192
And we'll have to like console log it out to even

00:06:22.192 --> 00:06:23.232
see what data is available.

00:06:23.812 --> 00:06:25.092
and if that data changes,

00:06:25.092 --> 00:06:26.892
we also don't know like we're just going to have

00:06:26.892 --> 00:06:27.812
errors in our application.

00:06:27.812 --> 00:06:29.052
That's the only way we're going to find things

00:06:29.052 --> 00:06:29.332
out.

00:06:29.502 --> 00:06:31.902
if this fails and we want to refetch,

00:06:31.902 --> 00:06:34.462
we don't have any clean retry logic as well.

00:06:35.032 --> 00:06:37.512
these are things that 10 stack query are going to

00:06:37.512 --> 00:06:38.552
help tremendously with.

00:06:38.632 --> 00:06:41.032
So if we look at this code,

00:06:41.112 --> 00:06:41.592
you know,

00:06:41.592 --> 00:06:42.632
kind of like solidify,

00:06:42.632 --> 00:06:42.992
use,

00:06:42.992 --> 00:06:44.152
effect function,

00:06:44.232 --> 00:06:44.872
set state,

00:06:45.112 --> 00:06:46.472
render stuff based on state.

00:06:47.102 --> 00:06:48.862
Now let's look at a cleaner version of this.

00:06:49.262 --> 00:06:51.822
A cleaner version of this using Tanstack query

00:06:51.822 --> 00:06:52.622
would look like this.

00:06:52.702 --> 00:06:54.622
You move your fetch function out.

00:06:54.782 --> 00:06:56.822
So the function that's actually interfacing with

00:06:56.822 --> 00:06:57.582
your API,

00:06:57.822 --> 00:07:00.582
bringing data down and then providing that data to

00:07:00.582 --> 00:07:01.862
the front end is kind of moved out.

00:07:01.862 --> 00:07:03.302
You probably put this in a different file,

00:07:03.302 --> 00:07:03.702
honestly,

00:07:03.702 --> 00:07:05.822
and then it could be reused in other components.

00:07:06.142 --> 00:07:08.222
And then you have a Tanstack,

00:07:08.642 --> 00:07:09.522
react query,

00:07:09.682 --> 00:07:11.522
a usequery method.

00:07:11.682 --> 00:07:14.122
And essentially what's happening here is you're

00:07:14.122 --> 00:07:15.322
going to specify a query key.

00:07:15.322 --> 00:07:17.882
So this query key is going to be unique to a

00:07:17.882 --> 00:07:18.242
query,

00:07:18.622 --> 00:07:19.262
a given query.

00:07:19.422 --> 00:07:21.262
And the reason why you want a query key is

00:07:21.342 --> 00:07:23.382
Tanstack actually does some caching on the front

00:07:23.382 --> 00:07:23.662
end.

00:07:23.742 --> 00:07:25.902
So if you have multiple components that require

00:07:25.902 --> 00:07:26.862
data from the same

00:07:27.062 --> 00:07:29.622
from the same API in the same endpoint with the

00:07:29.622 --> 00:07:30.342
same input,

00:07:30.582 --> 00:07:32.502
instead of continuously fetching data from the

00:07:32.502 --> 00:07:32.822
back end,

00:07:32.822 --> 00:07:33.262
you can,

00:07:33.262 --> 00:07:34.982
you can basically configure this to say,

00:07:34.982 --> 00:07:35.382
hey,

00:07:35.762 --> 00:07:37.922
the data is only of a few seconds old,

00:07:37.922 --> 00:07:38.882
don't refetch it,

00:07:38.882 --> 00:07:40.042
just pull it from cache.

00:07:40.042 --> 00:07:40.822
there's a whole,

00:07:41.062 --> 00:07:41.582
you know,

00:07:41.582 --> 00:07:42.982
very like intricate

00:07:43.482 --> 00:07:45.402
caching configuration that we're not going to dive

00:07:45.402 --> 00:07:45.882
too deep into.

00:07:45.882 --> 00:07:47.642
Just know it exists and you can look at,

00:07:47.642 --> 00:07:49.462
you can look into like how to configure that

00:07:49.602 --> 00:07:50.364
on your own time.

00:07:50.364 --> 00:07:52.982
And then the other thing that we need is a fetch

00:07:52.982 --> 00:07:53.462
function.

00:07:53.622 --> 00:07:54.582
And the fetch function,

00:07:54.582 --> 00:07:56.422
you just basically pass in the function.

00:07:56.422 --> 00:07:57.182
You don't call it,

00:07:57.182 --> 00:07:57.662
you just pass,

00:07:57.662 --> 00:07:57.982
you say,

00:07:57.982 --> 00:07:58.982
this is my function.

00:07:58.982 --> 00:07:59.382
And

00:07:59.782 --> 00:08:01.542
when this components mounts,

00:08:01.942 --> 00:08:04.182
this function is going to be invoked and

00:08:04.442 --> 00:08:06.762
tan stack query is going to basically say like,

00:08:06.762 --> 00:08:07.042
okay,

00:08:07.042 --> 00:08:08.802
do I need to fetch data or do I already have data

00:08:08.802 --> 00:08:09.522
in cache?

00:08:09.522 --> 00:08:11.002
And if I already have data in cache,

00:08:11.002 --> 00:08:11.602
you can say,

00:08:11.602 --> 00:08:12.962
show that data in cache,

00:08:13.202 --> 00:08:15.282
but while that data is shown on the page,

00:08:15.442 --> 00:08:18.002
go get some other data and then I'm going to

00:08:18.002 --> 00:08:18.802
update that for you.

00:08:18.802 --> 00:08:19.522
So all of these things,

00:08:19.522 --> 00:08:21.362
like you can configure that logic,

00:08:21.682 --> 00:08:23.802
but if you just use it right out of the box,

00:08:23.802 --> 00:08:25.562
you'll notice all of a sudden your UI becomes more

00:08:25.562 --> 00:08:27.282
snappy and way easier to manage.

00:08:27.362 --> 00:08:29.602
You'll also notice that you have an is loading

00:08:29.852 --> 00:08:32.358
property as well as part of use query

00:08:32.358 --> 00:08:33.600
and you have an error,

00:08:34.480 --> 00:08:35.800
you have an error flag as well.

00:08:35.800 --> 00:08:36.080
So

00:08:36.400 --> 00:08:38.680
just in this little tiny bit of code you're able

00:08:38.680 --> 00:08:39.280
to go from,

00:08:39.664 --> 00:08:40.784
you'll be able to go from this

00:08:41.584 --> 00:08:42.624
simplified to this.

00:08:42.704 --> 00:08:43.904
You have your reach.

00:08:43.984 --> 00:08:46.384
Also I didn't mention if this fails,

00:08:46.464 --> 00:08:48.384
by default it'll retry for you.

00:08:48.384 --> 00:08:50.384
And I think it retries like four times and each

00:08:50.384 --> 00:08:52.864
retry kind of backs off exponentially.

00:08:52.864 --> 00:08:53.344
So like

00:08:53.744 --> 00:08:54.983
it'll retry immediately,

00:08:54.983 --> 00:08:56.304
it'll wait a second retry,

00:08:56.304 --> 00:08:58.264
it'll wait a few more seconds and then retry kind

00:08:58.264 --> 00:08:58.664
of a thing.

00:08:58.664 --> 00:09:00.514
and then you can disable that if you don't want

00:09:00.514 --> 00:09:01.074
that logic.

00:09:01.074 --> 00:09:03.154
But and then another thing is like if you move

00:09:03.154 --> 00:09:03.594
tabs,

00:09:03.594 --> 00:09:04.714
you come to like another tab,

00:09:04.714 --> 00:09:05.714
it can come back to it.

00:09:06.224 --> 00:09:07.064
It'll also like,

00:09:07.064 --> 00:09:08.904
by default it'll refetch data as well.

00:09:08.904 --> 00:09:10.224
So like data can stay,

00:09:10.404 --> 00:09:12.524
not so data won't be stale on your ui,

00:09:12.524 --> 00:09:13.604
which is also super cool.

00:09:13.604 --> 00:09:13.924
So

00:09:14.324 --> 00:09:16.244
just know how much more simple this is.

00:09:16.244 --> 00:09:17.484
You're able to handle loading,

00:09:17.484 --> 00:09:19.164
you're able to handle the error based upon the

00:09:19.164 --> 00:09:21.364
properties that use that use query provides to

00:09:21.364 --> 00:09:21.604
you.

00:09:21.844 --> 00:09:24.244
Now TRPC takes this a step further,

00:09:24.324 --> 00:09:26.924
makes it simple and like way easier to work with.

00:09:26.924 --> 00:09:28.724
The main reason to me is

00:09:29.044 --> 00:09:31.564
instead of like reaching out to an API that you

00:09:31.564 --> 00:09:34.044
don't know the shape of and it could change on the

00:09:34.044 --> 00:09:34.404
back end,

00:09:34.404 --> 00:09:35.724
that shape could change on the back end,

00:09:35.724 --> 00:09:37.004
and then the front end doesn't know.

00:09:37.004 --> 00:09:38.844
I mean it shouldn't change on the back end if you

00:09:38.844 --> 00:09:39.724
design a good API.

00:09:39.724 --> 00:09:40.044
But

00:09:40.524 --> 00:09:41.244
it happens,

00:09:41.250 --> 00:09:42.235
your UI doesn't know.

00:09:42.235 --> 00:09:44.435
So like some data you get Data that's unexpected

00:09:44.435 --> 00:09:46.475
on the front end and things start breaking and you

00:09:46.475 --> 00:09:48.835
don't know until users or your monitoring tool

00:09:48.835 --> 00:09:49.555
picks it up.

00:09:49.715 --> 00:09:52.395
Now TRPC takes us a step further where essentially

00:09:52.395 --> 00:09:53.875
what it says is instead of having this,

00:09:53.875 --> 00:09:54.915
this REST API,

00:09:54.995 --> 00:09:57.115
we're going to wrap your API in some like type

00:09:57.115 --> 00:09:58.995
safe logic so you can define the front end,

00:09:58.995 --> 00:09:59.795
the the input

00:10:00.095 --> 00:10:02.575
and the output and then you'll use a client that

00:10:02.575 --> 00:10:04.575
has context to the shape of that data.

00:10:04.735 --> 00:10:06.175
So that's what this would look like.

00:10:06.735 --> 00:10:07.862
So just imagine here

00:10:08.078 --> 00:10:08.718
you have,

00:10:08.718 --> 00:10:09.118
so

00:10:09.438 --> 00:10:11.638
if you look here we're importing a TRPC client.

00:10:11.638 --> 00:10:13.198
This is just kind of pseudocode

00:10:13.598 --> 00:10:14.158
and then

00:10:14.798 --> 00:10:18.438
the client knows that I have a user's route and

00:10:18.438 --> 00:10:20.798
that users route has a method called get all.

00:10:21.278 --> 00:10:23.838
And you might notice here is this use query.

00:10:24.078 --> 00:10:26.398
We're not explicitly defining a query key

00:10:26.798 --> 00:10:28.078
and a query function.

00:10:28.158 --> 00:10:29.678
So we're not defining these two.

00:10:29.824 --> 00:10:31.154
We're using this query

00:10:31.724 --> 00:10:32.204
options,

00:10:32.204 --> 00:10:35.004
which is a newer way of using react query

00:10:35.324 --> 00:10:35.724
with

00:10:35.944 --> 00:10:36.904
trpc.

00:10:37.384 --> 00:10:38.864
So it's taking care of that for us.

00:10:38.864 --> 00:10:40.984
It's basically providing the query function that

00:10:40.984 --> 00:10:41.704
needs to be called

00:10:42.024 --> 00:10:44.024
and it's also providing a unique key,

00:10:44.444 --> 00:10:46.404
that way you don't have to memorize and keep in

00:10:46.404 --> 00:10:48.124
your head of like which keys you're using,

00:10:48.124 --> 00:10:49.164
which is also super,

00:10:49.164 --> 00:10:49.804
super nice.

00:10:50.254 --> 00:10:51.634
and then you could break this up.

00:10:51.974 --> 00:10:53.734
So you could break this up and basically say

00:10:53.774 --> 00:10:55.984
instead of query you could like specify I only

00:10:55.984 --> 00:10:58.544
want data and I only want is loading and I only

00:10:58.544 --> 00:10:59.104
want error.

00:10:59.104 --> 00:11:00.904
Kind of like how we had in the first example.

00:11:01.264 --> 00:11:03.344
this is just kind of pseudo code but you handle it

00:11:03.344 --> 00:11:03.744
the same way.

00:11:03.744 --> 00:11:05.184
So you have a loading,

00:11:05.184 --> 00:11:07.064
you have a error handling and then you display

00:11:07.064 --> 00:11:07.678
your users.

00:11:09.454 --> 00:11:11.294
So now that we kind of understand why

00:11:11.634 --> 00:11:13.774
react query is really useful and we also

00:11:13.774 --> 00:11:15.614
understand the basics of like how you're going to

00:11:15.614 --> 00:11:16.894
use TRPC in your project.

00:11:17.454 --> 00:11:19.494
Let's head over to our code base and just kind of

00:11:19.494 --> 00:11:20.414
quickly walk through it.

00:11:20.414 --> 00:11:20.814
So

00:11:21.090 --> 00:11:22.610
what you're going to notice is our

00:11:22.720 --> 00:11:23.735
top countries table

00:11:23.735 --> 00:11:24.825
has the suspense query.

00:11:24.825 --> 00:11:26.265
It's very similar to use query.

00:11:26.265 --> 00:11:27.745
The only difference is it doesn't have a loading

00:11:27.745 --> 00:11:27.945
state.

00:11:27.945 --> 00:11:30.105
It just assumes that we have data and if we don't

00:11:30.105 --> 00:11:30.505
have the data,

00:11:30.505 --> 00:11:32.385
the component doesn't render up until we have that

00:11:32.385 --> 00:11:32.665
data.

00:11:33.145 --> 00:11:35.145
And then we basically say data is

00:11:35.295 --> 00:11:36.855
We're naming data clicks by country

00:11:37.445 --> 00:11:39.525
and then we're rendering that inside of a table.

00:11:39.925 --> 00:11:41.860
Now if you want to see the back end code,

00:11:43.240 --> 00:11:45.640
the back end code is actually part of this project

00:11:45.960 --> 00:11:47.440
so if you look out,

00:11:47.440 --> 00:11:48.760
if we look outside of here,

00:11:48.920 --> 00:11:51.040
we have source and then we have worker.

00:11:51.040 --> 00:11:53.280
The source is the front end application and the

00:11:53.280 --> 00:11:55.960
worker is the lightweight cloudflare worker.

00:11:55.960 --> 00:11:57.400
That's just kind of like the

00:11:57.540 --> 00:11:59.680
data interface for the front end of our

00:11:59.680 --> 00:12:00.200
application.

00:12:00.850 --> 00:12:04.490
We have this TRPC folder and this TRPC folder has

00:12:04.490 --> 00:12:05.410
our routers.

00:12:05.410 --> 00:12:07.410
So we can see here is we have this router,

00:12:07.410 --> 00:12:09.890
we have a links router and we have an evaluations

00:12:09.890 --> 00:12:10.450
router.

00:12:10.610 --> 00:12:11.810
The links router

00:12:12.130 --> 00:12:12.770
has these

00:12:12.800 --> 00:12:15.190
different methods that we've implemented and these

00:12:15.190 --> 00:12:16.070
are all type safe.

00:12:16.070 --> 00:12:16.990
So what we can do,

00:12:16.990 --> 00:12:17.790
and this is like,

00:12:17.790 --> 00:12:18.270
honestly,

00:12:18.270 --> 00:12:20.910
probably like the best part of trpc,

00:12:20.990 --> 00:12:22.670
other than it being type safe is

00:12:23.070 --> 00:12:25.590
if I'm so I'm here in my front end and then I want

00:12:25.590 --> 00:12:26.910
to go find the back end code

00:12:27.190 --> 00:12:27.990
that lives somewhere.

00:12:27.990 --> 00:12:29.310
Maybe if your project's huge,

00:12:29.310 --> 00:12:29.710
you're like,

00:12:29.710 --> 00:12:29.990
okay,

00:12:29.990 --> 00:12:30.710
I want to go find this,

00:12:30.710 --> 00:12:32.470
I could go search for the file and jump to it.

00:12:32.470 --> 00:12:35.970
But you could also command and click on the method

00:12:35.970 --> 00:12:38.335
and it jumps right to this back in code.

00:12:38.335 --> 00:12:39.895
So right now the backend code,

00:12:39.895 --> 00:12:41.935
all it's doing is it's saying I don't have any

00:12:41.935 --> 00:12:42.415
input,

00:12:42.415 --> 00:12:44.095
I just get the data for that account

00:12:44.655 --> 00:12:46.495
and then I am going to return

00:12:46.895 --> 00:12:47.295
a

00:12:47.382 --> 00:12:48.515
dummy data array

00:12:48.995 --> 00:12:50.195
of these countries.

00:12:50.515 --> 00:12:52.575
So it's basically like a country code and,

00:12:52.725 --> 00:12:53.685
and a count code.

00:12:53.765 --> 00:12:55.565
So that's kind of how we're interfacing with it.

00:12:55.565 --> 00:12:57.125
Now what we're going to do throughout the,

00:12:57.365 --> 00:12:59.525
the next few sections of this course is we're

00:12:59.525 --> 00:13:01.285
going to start building out the back end for this.

00:13:01.285 --> 00:13:02.245
So we're going to build out,

00:13:02.305 --> 00:13:04.065
we're going to create a database and we're going

00:13:04.065 --> 00:13:06.185
to create those tables and then throughout this

00:13:06.185 --> 00:13:08.225
course we're going to use different queries,

00:13:09.355 --> 00:13:11.555
that wire into these methods.

00:13:11.555 --> 00:13:13.515
So we'll have some like const data

00:13:13.915 --> 00:13:14.635
await

00:13:16.635 --> 00:13:17.035
my

00:13:17.355 --> 00:13:17.875
query.

00:13:17.875 --> 00:13:19.755
So it's going to call like a database on the back

00:13:19.755 --> 00:13:21.355
end and then it's going to return that data to the

00:13:21.355 --> 00:13:21.755
front end.

00:13:21.755 --> 00:13:23.355
So we're going to start building this out right

00:13:23.355 --> 00:13:23.475
now.

00:13:23.475 --> 00:13:25.255
But I just think really important to kind of just

00:13:25.255 --> 00:13:26.415
solidify that.

00:13:26.415 --> 00:13:30.295
We have a react application that's using Tanstack

00:13:30.315 --> 00:13:33.105
router for page navigation and then we're using

00:13:33.105 --> 00:13:35.945
Tanstack query to get data from a lightweight

00:13:35.945 --> 00:13:37.985
backend that's bundled in the exact same

00:13:38.125 --> 00:13:38.425
project.

00:13:38.425 --> 00:13:40.185
So in the exact same user application.

00:13:40.665 --> 00:13:43.625
And that backend is hosted on a cloudflare worker.

00:13:43.945 --> 00:13:45.665
And that cloudflare worker is,

00:13:45.665 --> 00:13:46.985
has implemented trpc.

00:13:46.985 --> 00:13:49.185
So we have really type safe data exchange from the

00:13:49.185 --> 00:13:50.185
front end to the back end.

00:13:50.465 --> 00:13:52.345
Honestly this is a simple setup but it's so

00:13:52.345 --> 00:13:55.025
stinking powerful and I do think like if you like

00:13:55.025 --> 00:13:55.345
Next,

00:13:56.125 --> 00:13:56.685
that's fine.

00:13:56.685 --> 00:13:57.325
Like we have like,

00:13:57.325 --> 00:13:59.085
like you can use TRPC with next.

00:13:59.165 --> 00:14:00.125
Next also has

00:14:00.155 --> 00:14:01.005
Next JS has

00:14:01.405 --> 00:14:03.925
their server functions as kind of like an offering

00:14:03.925 --> 00:14:05.135
which is very similar to this.

00:14:05.435 --> 00:14:07.435
but the beauty of this is like it's just framework

00:14:07.435 --> 00:14:07.995
agnostic.

00:14:07.995 --> 00:14:10.715
Bring it to any TSX based project and like

00:14:10.715 --> 00:14:12.235
everything becomes so much easier.

00:14:12.235 --> 00:14:13.995
So we're going to dive deeper into this.

00:14:14.075 --> 00:14:14.086
So.

00:14:14.086 --> 00:14:16.209
But now that we understand holistically the front

00:14:16.209 --> 00:14:19.249
end to the lightweight back end running onto trpc,

00:14:19.329 --> 00:14:21.209
let's get into like the data aspect of this

00:14:21.209 --> 00:14:21.450
course.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.290 --> 00:00:00.810
All right,

00:00:00.810 --> 00:00:02.450
so let's actually start building out the data

00:00:02.450 --> 00:00:04.450
layer of our application now.

00:00:04.450 --> 00:00:05.090
Like promised,

00:00:05.090 --> 00:00:07.370
we're going to be using the built in D1 database

00:00:07.370 --> 00:00:08.570
as part of Cloudflare's offering.

00:00:08.570 --> 00:00:10.090
It's really great for this project because we

00:00:10.090 --> 00:00:11.500
don't have to jump to different providers.

00:00:11.500 --> 00:00:12.670
but if you are building a really,

00:00:12.670 --> 00:00:14.350
really serious project that's going to have good

00:00:14.350 --> 00:00:16.150
scale and you're building it like for a client or

00:00:16.150 --> 00:00:16.430
something,

00:00:16.510 --> 00:00:18.350
I wouldn't necessarily recommend this

00:00:18.990 --> 00:00:20.190
with a few different caveats.

00:00:20.270 --> 00:00:20.670
Now

00:00:21.310 --> 00:00:24.030
I think that the D1 database is insane for side

00:00:24.030 --> 00:00:24.470
projects,

00:00:24.470 --> 00:00:26.350
it's insane for smaller projects or even some mid

00:00:26.350 --> 00:00:26.990
sized projects.

00:00:26.990 --> 00:00:27.630
But there's a few

00:00:28.010 --> 00:00:29.530
caveats that you have to pay attention to.

00:00:29.810 --> 00:00:32.530
in terms of like the number of rows you can read,

00:00:32.930 --> 00:00:34.970
they have very generous like offerings.

00:00:34.970 --> 00:00:37.730
So like as part of their $5 a month workers pay

00:00:37.730 --> 00:00:39.570
tier you get 25 billion

00:00:39.970 --> 00:00:42.050
reads and then you pay per usage after that and

00:00:42.050 --> 00:00:42.970
it's the same thing for rights.

00:00:42.970 --> 00:00:45.010
50 million rides and you pay for usage after that.

00:00:45.010 --> 00:00:45.810
Like if you have

00:00:46.130 --> 00:00:47.035
this much usage

00:00:47.035 --> 00:00:47.729
on D1,

00:00:47.729 --> 00:00:48.369
that's crazy.

00:00:48.369 --> 00:00:50.329
Like I haven't really seen side projects hit this.

00:00:50.329 --> 00:00:52.729
I mean I guess it's possible but this is like,

00:00:52.729 --> 00:00:53.089
you know,

00:00:53.089 --> 00:00:54.689
you're building a pretty serious application at

00:00:54.689 --> 00:00:56.489
this point and then I would say probably pick a

00:00:56.489 --> 00:00:57.449
different database provider.

00:00:57.449 --> 00:00:58.329
So if you're under these

00:00:58.709 --> 00:00:59.709
thresholds like go ahead,

00:00:59.709 --> 00:01:00.309
use D1,

00:01:00.309 --> 00:01:01.429
you're going to have a great time.

00:01:01.469 --> 00:01:03.069
the main limitation here is

00:01:03.549 --> 00:01:05.829
the database size which is 10 gigabytes.

00:01:05.829 --> 00:01:06.189
Now

00:01:06.819 --> 00:01:08.539
most side projects you probably don't have to

00:01:08.539 --> 00:01:10.979
worry about hitting that 10 gigabyte limit per

00:01:10.979 --> 00:01:12.019
database instance.

00:01:12.099 --> 00:01:12.499
But

00:01:12.999 --> 00:01:14.979
there are more data intensive applications where

00:01:14.979 --> 00:01:16.299
this is going to become an issue.

00:01:16.459 --> 00:01:18.779
And that's kind of like where things get really

00:01:18.779 --> 00:01:19.099
tricky.

00:01:19.099 --> 00:01:20.019
With D1 database,

00:01:20.019 --> 00:01:21.219
I've heard a lot of people say,

00:01:21.219 --> 00:01:23.659
well I'm not worried about that limit because

00:01:23.659 --> 00:01:25.459
essentially what I'll do is I'll do like a multi

00:01:25.459 --> 00:01:26.269
tenant setup,

00:01:26.419 --> 00:01:28.979
meaning each user gets their own database.

00:01:28.979 --> 00:01:31.699
And I think there's a company called Torso which

00:01:31.699 --> 00:01:32.659
kind of pioneered

00:01:32.979 --> 00:01:33.739
this at like

00:01:34.719 --> 00:01:35.259
at a

00:01:35.259 --> 00:01:37.379
kind of a more enterprise level or like serious

00:01:37.379 --> 00:01:37.699
service.

00:01:37.699 --> 00:01:39.259
But essentially like they're like,

00:01:39.259 --> 00:01:39.459
yeah,

00:01:39.459 --> 00:01:40.259
you can kind of spin up

00:01:40.288 --> 00:01:42.369
database instance per user.

00:01:42.579 --> 00:01:44.139
now that's totally fine and dandy,

00:01:44.139 --> 00:01:44.899
you can go that route.

00:01:44.899 --> 00:01:47.299
But I do think that setup is very complicated and

00:01:47.699 --> 00:01:49.739
one of the main issues is when you're connecting

00:01:49.739 --> 00:01:52.019
to your D1 database via Cloudflare worker You need

00:01:52.019 --> 00:01:53.939
to specify that in your Wrangler configuration.

00:01:54.019 --> 00:01:56.439
So if you got a new user and you want to bring in

00:01:56.439 --> 00:01:57.279
a new database,

00:01:57.599 --> 00:02:00.759
you would have to redeploy or deploy your project

00:02:00.759 --> 00:02:02.639
as a new worker for them.

00:02:02.719 --> 00:02:03.799
And I just,

00:02:03.799 --> 00:02:05.879
I just don't know really how you scale that within

00:02:05.879 --> 00:02:07.839
like the Cloudflare worker ecosystem.

00:02:07.839 --> 00:02:09.839
Cloudflare does have another totally different

00:02:09.839 --> 00:02:12.999
offering for this use case and that is called the

00:02:12.999 --> 00:02:13.279
workers,

00:02:14.229 --> 00:02:16.589
workers for platforms which give you a few

00:02:16.589 --> 00:02:17.269
different features.

00:02:17.269 --> 00:02:17.789
Like they have,

00:02:17.789 --> 00:02:17.989
it's,

00:02:17.989 --> 00:02:20.109
it's $25 base price month and then it's per

00:02:20.109 --> 00:02:20.869
additional usage.

00:02:20.869 --> 00:02:21.189
So

00:02:21.739 --> 00:02:23.179
basically it's the same pricing as workers,

00:02:23.579 --> 00:02:25.259
development process is the same as workers.

00:02:25.259 --> 00:02:27.339
But like one of the main things is you can like

00:02:27.339 --> 00:02:29.779
dynamically create resources and then dynamically

00:02:29.779 --> 00:02:31.819
bind to those resources inside of a worker.

00:02:31.819 --> 00:02:34.179
So you can build like a more true multi tenant

00:02:34.179 --> 00:02:34.579
setup.

00:02:34.579 --> 00:02:37.539
But in order to do that you need to like have the

00:02:37.539 --> 00:02:39.499
foundations of how to build on workers solidified.

00:02:39.499 --> 00:02:41.139
And that's what this course is going to focus on.

00:02:41.139 --> 00:02:42.499
We're not going to be focusing on like the really

00:02:42.499 --> 00:02:43.939
complicated multi tenant setup,

00:02:43.939 --> 00:02:45.659
we're going to be focusing on how to like build

00:02:45.659 --> 00:02:47.899
full stack applications really well using all the

00:02:47.899 --> 00:02:48.699
Cloudflare services.

00:02:48.859 --> 00:02:50.459
So that's what we're going to stick to.

00:02:50.459 --> 00:02:50.859
So

00:02:51.169 --> 00:02:52.129
as part of this course,

00:02:52.129 --> 00:02:53.569
like we're going to be using D1.

00:02:53.649 --> 00:02:55.689
And what you're going to notice if you're kind of

00:02:55.689 --> 00:02:57.449
reading through documentations trying to sort out

00:02:57.449 --> 00:02:59.329
how to build with D1,

00:02:59.329 --> 00:03:01.729
you're going to see examples like this where you

00:03:01.729 --> 00:03:04.129
have a fetch handler and then you get your

00:03:04.459 --> 00:03:07.369
D1 database through the environment binding and

00:03:07.369 --> 00:03:09.809
then you say prepare and you write some SQL query

00:03:09.809 --> 00:03:11.489
and then you get your data to your user.

00:03:11.569 --> 00:03:12.809
Now this path is totally fine.

00:03:12.809 --> 00:03:13.929
You can write queries like this,

00:03:13.929 --> 00:03:15.689
but when you're building like a really big

00:03:15.689 --> 00:03:15.969
project,

00:03:16.209 --> 00:03:18.089
you're going to want to bring in some tooling that

00:03:18.089 --> 00:03:21.129
kind of helps make this process more type safe and

00:03:21.129 --> 00:03:23.189
more scalable in terms of scaling your code base.

00:03:23.189 --> 00:03:26.018
And that's where like an ORM comes into play where

00:03:26.018 --> 00:03:26.361
you can,

00:03:26.361 --> 00:03:28.161
instead of writing raw SQL statements,

00:03:28.161 --> 00:03:30.241
you can have your schemas defined inside of your

00:03:30.241 --> 00:03:30.841
code base,

00:03:30.841 --> 00:03:32.961
so your tables defined inside of your code base.

00:03:33.121 --> 00:03:35.521
And then you can bring in an ORM like Drizzle or

00:03:35.521 --> 00:03:36.521
there's other orms out there.

00:03:36.521 --> 00:03:37.761
I think Drizzle is one of the best one,

00:03:37.991 --> 00:03:39.791
where you can basically programmatically create

00:03:39.791 --> 00:03:42.591
your queries where you say database.select.

00:03:42.591 --> 00:03:43.511
from users,

00:03:43.641 --> 00:03:46.481
and Then you can have like joins and filters and

00:03:46.481 --> 00:03:47.001
whatnot.

00:03:47.001 --> 00:03:49.441
So this is just like a way of like creating really

00:03:49.441 --> 00:03:50.151
type safe,

00:03:50.291 --> 00:03:53.691
queries and kind of abstracting the query creation

00:03:53.691 --> 00:03:56.171
logic away from like traditional SQL statements

00:03:56.171 --> 00:03:58.571
where like you might write a SQL statement inside

00:03:58.571 --> 00:04:00.491
of your code base but you have a syntax error or

00:04:00.491 --> 00:04:02.931
you're like having a table that's the wrong name.

00:04:02.931 --> 00:04:04.531
And then all of a sudden your application crashes

00:04:04.531 --> 00:04:05.851
out of nowhere and you're trying to figure out why

00:04:05.851 --> 00:04:06.330
and it's like,

00:04:06.330 --> 00:04:06.611
oh,

00:04:06.611 --> 00:04:06.811
well,

00:04:06.811 --> 00:04:08.971
I wrote the wrong query because this is just a

00:04:08.971 --> 00:04:09.331
string.

00:04:09.411 --> 00:04:09.811
And

00:04:10.131 --> 00:04:12.051
the only time I know if it's going to fail is

00:04:12.051 --> 00:04:13.411
during runtime where this,

00:04:13.411 --> 00:04:16.091
during build time it's going to error out if like

00:04:16.091 --> 00:04:16.931
you're using a

00:04:17.491 --> 00:04:19.011
table name that is not defined.

00:04:19.561 --> 00:04:20.561
so it's really nice.

00:04:20.561 --> 00:04:22.521
You can kind of like makes that building process a

00:04:22.521 --> 00:04:22.921
lot easier.

00:04:22.921 --> 00:04:24.761
It makes your data type safe when you get data

00:04:24.761 --> 00:04:25.881
back from your database.

00:04:26.521 --> 00:04:28.521
now there's another issue with this pattern though

00:04:28.521 --> 00:04:30.641
that you'll find in documentations is like,

00:04:30.641 --> 00:04:31.321
you'll have your,

00:04:31.901 --> 00:04:34.121
you'll have your D1 database provided from a

00:04:34.121 --> 00:04:36.121
binding and then you'll pass it into the drizzle

00:04:36.121 --> 00:04:38.281
method and then from there you have the Drizzle

00:04:38.281 --> 00:04:39.601
database where you can write queries.

00:04:39.601 --> 00:04:41.681
But what you'll notice here is,

00:04:41.681 --> 00:04:42.681
I guess not what you'll notice,

00:04:42.681 --> 00:04:44.201
but like what you'll find out as you're building

00:04:44.201 --> 00:04:46.161
bigger projects is you're going to have tons and

00:04:46.161 --> 00:04:47.881
tons of different API endpoints and server

00:04:47.881 --> 00:04:48.821
functions and whatnot.

00:04:48.821 --> 00:04:50.221
And this thing is going to be very,

00:04:50.221 --> 00:04:53.181
very repetitive where you continually pass in

00:04:53.434 --> 00:04:53.830
the same,

00:04:53.830 --> 00:04:56.190
like database instance into your drizzle,

00:04:56.510 --> 00:04:57.150
method.

00:04:57.310 --> 00:04:59.590
And then you're creating like a query inside of

00:04:59.590 --> 00:05:00.910
your application code.

00:05:00.910 --> 00:05:01.310
And

00:05:01.830 --> 00:05:03.030
it's fine for smaller projects,

00:05:03.030 --> 00:05:04.070
but as things get big,

00:05:04.070 --> 00:05:05.750
you'll notice like you have a lot of the same

00:05:05.750 --> 00:05:07.870
queries that you're continuously rewriting and

00:05:07.870 --> 00:05:08.310
rewriting.

00:05:08.310 --> 00:05:10.390
And that's kind of where the monorepo setup comes

00:05:10.390 --> 00:05:10.590
in,

00:05:10.590 --> 00:05:12.710
where we're able to abstract the,

00:05:12.790 --> 00:05:14.630
or move the queries to a different

00:05:15.170 --> 00:05:15.650
package,

00:05:15.730 --> 00:05:16.850
kind of define them.

00:05:16.930 --> 00:05:19.610
Say like this query is meant for this use case and

00:05:19.610 --> 00:05:21.330
then we can use it throughout our project.

00:05:21.410 --> 00:05:21.810
So like,

00:05:21.810 --> 00:05:23.810
it would kind of be something like this where you

00:05:23.810 --> 00:05:24.130
have

00:05:24.450 --> 00:05:26.530
a package called Data Ops.

00:05:26.530 --> 00:05:27.810
It's in our project right now,

00:05:27.810 --> 00:05:29.650
it's in our monorepo and we're going to have a

00:05:29.650 --> 00:05:31.410
bunch of different SQL queries defined in there

00:05:31.410 --> 00:05:34.490
that are written using the Drizzle rm and then

00:05:34.490 --> 00:05:36.290
they're going to be imported throughout,

00:05:36.370 --> 00:05:37.310
all of our applications.

00:05:37.310 --> 00:05:38.630
This project is only going to have two

00:05:38.630 --> 00:05:39.070
applications.

00:05:39.070 --> 00:05:40.830
But as your service grows and your use cases

00:05:40.830 --> 00:05:42.110
become more sophisticated,

00:05:42.110 --> 00:05:43.750
you might be having more deployables,

00:05:43.750 --> 00:05:45.150
like independent applications.

00:05:45.390 --> 00:05:47.290
And then you'll be able to source the same queries

00:05:47.290 --> 00:05:49.210
so you don't have a whole bunch of like redundant

00:05:49.210 --> 00:05:50.730
code all throughout your code base.

00:05:51.210 --> 00:05:53.290
Another pattern that I like to follow is,

00:05:53.850 --> 00:05:54.850
if you notice here,

00:05:54.850 --> 00:05:57.290
this drizzle instance is taking in the D1

00:05:57.290 --> 00:05:57.850
database.

00:05:57.850 --> 00:06:00.570
But if you connect to other database providers,

00:06:00.570 --> 00:06:02.970
like the way that you create this object is

00:06:02.970 --> 00:06:03.290
different.

00:06:03.450 --> 00:06:03.830
Like

00:06:03.870 --> 00:06:04.750
With neon,

00:06:04.990 --> 00:06:06.830
you pass in a query

00:06:07.150 --> 00:06:07.870
URL

00:06:08.230 --> 00:06:08.630
with

00:06:09.219 --> 00:06:09.619
with.

00:06:09.859 --> 00:06:10.459
Let's see,

00:06:10.459 --> 00:06:12.699
Supabase is like another scenario where like

00:06:12.699 --> 00:06:14.799
you're using a different orm,

00:06:14.799 --> 00:06:15.359
like a different.

00:06:15.359 --> 00:06:17.039
So this one is postgresjs.

00:06:17.459 --> 00:06:20.379
you're passing in that URL and then planetscale is

00:06:20.379 --> 00:06:22.219
going to be a little bit different where you are

00:06:22.219 --> 00:06:25.299
using the PlanetScale serverless as part of the

00:06:25.299 --> 00:06:26.259
Drizzle RM.

00:06:26.419 --> 00:06:28.539
And then you're passing in individually like a

00:06:28.539 --> 00:06:30.339
host and a username and a password.

00:06:30.419 --> 00:06:32.499
So if at your application layer,

00:06:32.499 --> 00:06:35.379
like you are defining drizzle like this throughout

00:06:35.379 --> 00:06:37.139
your code in tons of different places,

00:06:37.139 --> 00:06:38.899
and then you swap out your database provider,

00:06:38.979 --> 00:06:40.419
all of a sudden you're gonna have to go through

00:06:40.419 --> 00:06:41.739
like your entire code base.

00:06:41.739 --> 00:06:42.819
You're gonna have to update

00:06:43.329 --> 00:06:43.569
the

00:06:43.619 --> 00:06:45.559
the actual import statement for drizzle.

00:06:45.559 --> 00:06:46.479
And then you're gonna have to.

00:06:46.879 --> 00:06:48.559
And you're gonna have to update the way that it's

00:06:48.559 --> 00:06:50.119
instantiated across your entire code base,

00:06:50.119 --> 00:06:52.439
which would make migrating to a different database

00:06:52.439 --> 00:06:53.119
very difficult.

00:06:53.119 --> 00:06:55.199
And one of the reasons why I think orms are great

00:06:55.279 --> 00:06:56.959
is you could in theory migrate to a different

00:06:56.959 --> 00:06:58.159
database with more ease.

00:06:58.159 --> 00:07:00.519
So I'm going to show you the monorepo setup where

00:07:00.519 --> 00:07:02.359
you kind of alleviate all of these problems.

00:07:02.359 --> 00:07:02.839
So we can,

00:07:02.839 --> 00:07:04.013
we can get into that right now.

00:07:04.064 --> 00:07:04.384
All right,

00:07:04.384 --> 00:07:06.584
so if we navigate back to our project and we come

00:07:06.584 --> 00:07:07.424
into the packages

00:07:07.824 --> 00:07:09.064
Data Ops folder,

00:07:09.064 --> 00:07:12.304
essentially this is a package and this package is

00:07:12.304 --> 00:07:14.344
going to contain code that's shared at different

00:07:14.344 --> 00:07:15.744
services or different apps.

00:07:15.744 --> 00:07:17.864
So in the Data Ops package we're going to have

00:07:17.864 --> 00:07:18.714
information like

00:07:18.714 --> 00:07:19.284
we're going to have,

00:07:19.284 --> 00:07:21.164
we're going to have like our database queries,

00:07:21.164 --> 00:07:22.284
we're going to have Zod schemas,

00:07:22.284 --> 00:07:22.964
we're going to have

00:07:23.524 --> 00:07:24.764
logic that can be shared,

00:07:24.764 --> 00:07:25.604
that's a little bit more common,

00:07:25.604 --> 00:07:27.324
that can be shared across different services and

00:07:27.324 --> 00:07:28.924
then they're going to be used in our user

00:07:28.924 --> 00:07:29.244
application,

00:07:29.244 --> 00:07:31.004
so our front end application and then also our

00:07:31.004 --> 00:07:31.754
data service that,

00:07:31.824 --> 00:07:33.264
that we're going to be spending a lot of time

00:07:33.264 --> 00:07:33.784
building out.

00:07:33.784 --> 00:07:35.824
Now as your application scales there could be

00:07:36.144 --> 00:07:37.504
scenarios where you

00:07:37.794 --> 00:07:39.314
are building out different services,

00:07:39.474 --> 00:07:41.794
different deployables and it's really nice to have

00:07:41.874 --> 00:07:44.394
your generic code easily shareable across all of

00:07:44.394 --> 00:07:44.674
these

00:07:44.784 --> 00:07:45.764
different applications.

00:07:45.764 --> 00:07:47.444
So that's a process that we're going to follow

00:07:47.444 --> 00:07:47.924
right now.

00:07:48.324 --> 00:07:48.724
And

00:07:49.234 --> 00:07:51.344
before we create our database inside,

00:07:51.344 --> 00:07:52.384
before we create our data,

00:07:52.384 --> 00:07:54.704
our database and our tables in Cloudflare,

00:07:55.044 --> 00:07:56.804
just kind of like walk through the structure a

00:07:56.804 --> 00:07:57.164
little bit.

00:07:57.164 --> 00:07:57.804
So this,

00:07:57.874 --> 00:07:59.314
this is a pmpm,

00:07:59.714 --> 00:08:01.174
workspace like package

00:08:01.734 --> 00:08:04.254
and we have some scripts defined inside of the

00:08:04.254 --> 00:08:05.654
package JSON file.

00:08:05.654 --> 00:08:08.294
And a lot of these scripts are related to Drizzle.

00:08:08.294 --> 00:08:08.614
And

00:08:08.814 --> 00:08:10.734
if you're not familiar with like the full process

00:08:10.734 --> 00:08:12.734
of building on top of Drizzle or using Drizzle,

00:08:12.734 --> 00:08:14.494
I actually have a pretty decent video on it that

00:08:14.494 --> 00:08:15.094
I'll link to.

00:08:15.154 --> 00:08:16.834
and their documentation is pretty good as well.

00:08:16.834 --> 00:08:18.994
But you have these concepts of like if you have a

00:08:18.994 --> 00:08:20.034
schema that exists

00:08:20.354 --> 00:08:21.794
you can run some commands,

00:08:22.604 --> 00:08:25.204
specifically Drizzle Kit Poll that will pull in

00:08:25.204 --> 00:08:27.964
those tables and it will create a whole bunch of

00:08:28.234 --> 00:08:31.084
typescript files that represent those tables and

00:08:31.084 --> 00:08:33.124
they are called schemas and then you can use those

00:08:33.124 --> 00:08:34.514
schemas to create queries.

00:08:34.514 --> 00:08:36.084
and there's like some other things like migrate

00:08:36.084 --> 00:08:37.604
and generate that we're actually not going to use

00:08:37.604 --> 00:08:38.564
too much in this course.

00:08:38.954 --> 00:08:41.224
Studio gives us an interactive query environment.

00:08:41.544 --> 00:08:43.144
So these are kind of the things that we're going

00:08:43.144 --> 00:08:44.184
to worry about right now.

00:08:44.314 --> 00:08:46.284
and in order to make this happen what we need to

00:08:46.284 --> 00:08:47.924
do is we need to head over to our Drizzle

00:08:47.924 --> 00:08:48.604
configuration.

00:08:48.764 --> 00:08:51.364
And what this does is this basically says okay,

00:08:51.364 --> 00:08:53.304
this is how you authenticate to our database.

00:08:53.704 --> 00:08:54.104
And

00:08:54.504 --> 00:08:56.704
then when we actually pull information from your

00:08:56.704 --> 00:08:58.984
database and then we create some like typescript

00:08:58.984 --> 00:08:59.304
files.

00:08:59.304 --> 00:09:00.104
Where do those go?

00:09:00.104 --> 00:09:01.864
And that's what this out command does.

00:09:01.864 --> 00:09:02.544
It basically says,

00:09:02.544 --> 00:09:03.544
inside of our source,

00:09:03.704 --> 00:09:06.104
we're going to output some of these drizzle,

00:09:06.114 --> 00:09:06.704
schemas,

00:09:06.704 --> 00:09:08.744
and it's going to create some files inside of our

00:09:08.744 --> 00:09:09.384
code base.

00:09:09.384 --> 00:09:09.784
So,

00:09:09.974 --> 00:09:11.084
that's what we're going to go through now.

00:09:11.084 --> 00:09:12.804
And you're going to notice that we have some of

00:09:12.804 --> 00:09:13.084
these.

00:09:13.734 --> 00:09:14.214
we have,

00:09:14.214 --> 00:09:14.414
like,

00:09:14.414 --> 00:09:14.694
these,

00:09:14.854 --> 00:09:15.974
the Cloudflare account ID,

00:09:15.974 --> 00:09:16.734
the database ID,

00:09:16.734 --> 00:09:18.214
and a Cloudflare D1 token.

00:09:18.214 --> 00:09:19.454
So we're going to go through the process of

00:09:19.454 --> 00:09:20.374
creating this right now.

00:09:20.374 --> 00:09:21.694
So first we're going to create the table,

00:09:21.694 --> 00:09:22.924
then we're going to configure it,

00:09:23.074 --> 00:09:23.874
work with Drizzle,

00:09:23.874 --> 00:09:24.994
and we'll go from there.

00:09:25.154 --> 00:09:27.797
So if we head over to our Cloudflare dashboard,

00:09:28.152 --> 00:09:30.552
We can head under the storage and database section

00:09:30.872 --> 00:09:33.552
and then let's head over to D1 SQL database.

00:09:33.552 --> 00:09:35.912
And you can see we don't have any database created

00:09:35.912 --> 00:09:36.392
right now.

00:09:36.392 --> 00:09:37.632
So we're going to go ahead and we're going to

00:09:37.632 --> 00:09:39.832
create a database and for this project we're going

00:09:39.832 --> 00:09:40.392
to call it,

00:09:40.842 --> 00:09:44.202
Smart Links and we'll say that's our project name

00:09:44.362 --> 00:09:46.442
and then we're going to say stage.

00:09:46.442 --> 00:09:49.682
And the reason why I'm saying dash stage here is

00:09:49.682 --> 00:09:50.042
because

00:09:50.442 --> 00:09:50.802
at the,

00:09:50.802 --> 00:09:51.802
towards the end of this project,

00:09:51.802 --> 00:09:53.682
I'm going to show you how to create multiple

00:09:53.682 --> 00:09:55.082
environments of your application.

00:09:55.082 --> 00:09:57.302
So you could have like one for testing and for

00:09:57.302 --> 00:09:57.622
development

00:09:57.942 --> 00:09:59.542
and for actually like,

00:09:59.542 --> 00:10:00.022
you know,

00:10:00.022 --> 00:10:02.662
building out ideas that you can test before you

00:10:02.662 --> 00:10:04.902
actually move it to the production version that's

00:10:04.902 --> 00:10:05.742
user facing.

00:10:05.742 --> 00:10:06.102
So,

00:10:06.312 --> 00:10:08.322
everything that is like we're developing now is

00:10:08.322 --> 00:10:10.442
going to be like dash stage and then later we'll

00:10:10.442 --> 00:10:13.162
have one that's meant for production so we can hit

00:10:13.162 --> 00:10:13.482
create.

00:10:13.496 --> 00:10:14.924
Now what that's going to do is this gives us a

00:10:14.924 --> 00:10:16.724
database and we're going to come look at the

00:10:16.724 --> 00:10:17.644
settings really quick.

00:10:17.724 --> 00:10:18.124
But

00:10:18.384 --> 00:10:19.944
in order to get this to work with,

00:10:20.674 --> 00:10:21.714
to work with Drizzle,

00:10:21.954 --> 00:10:23.274
we need a few different things.

00:10:23.274 --> 00:10:24.754
We need our account id.

00:10:24.754 --> 00:10:27.514
The account ID can be found in two places.

00:10:27.514 --> 00:10:29.874
One it can be found at like this first section of

00:10:29.874 --> 00:10:30.514
the URL,

00:10:30.514 --> 00:10:32.194
but it's kind of messy to get it from there.

00:10:32.754 --> 00:10:34.594
So what you can do is you come over to workers

00:10:35.234 --> 00:10:37.714
and they should have this section where like it's

00:10:37.714 --> 00:10:38.354
account id.

00:10:38.514 --> 00:10:40.034
So we're going to go ahead and copy that.

00:10:40.934 --> 00:10:43.454
and then first what I'm going to do is I am going

00:10:43.454 --> 00:10:44.374
to paste in

00:10:46.034 --> 00:10:46.914
So we're going to,

00:10:46.994 --> 00:10:50.594
at the root of the data ops package,

00:10:50.754 --> 00:10:53.074
we're going to create a file called.emb

00:10:54.114 --> 00:10:54.674
and this,

00:10:54.674 --> 00:10:56.514
you should make sure that this is always in your

00:10:56.594 --> 00:10:58.914
git ignore so you don't accidentally push these to

00:10:58.914 --> 00:10:59.354
GitHub.

00:10:59.354 --> 00:11:01.234
And then we're going to say Cloudflare account ID

00:11:01.974 --> 00:11:03.034
equals this account ID.

00:11:03.552 --> 00:11:05.792
We're also going to do the same for our Cloudflare

00:11:05.792 --> 00:11:06.352
database.

00:11:06.352 --> 00:11:08.592
So we're going to say cloudflare D1 database

00:11:08.672 --> 00:11:09.312
equals.

00:11:09.792 --> 00:11:11.632
Head back over to the

00:11:12.352 --> 00:11:13.632
storage and databases

00:11:14.112 --> 00:11:15.552
D1 SQL database.

00:11:15.951 --> 00:11:18.272
Click on that guy and let's copy that

00:11:18.312 --> 00:11:19.192
database link.

00:11:19.832 --> 00:11:21.232
Now just know all these steps.

00:11:21.232 --> 00:11:22.992
You could also create and manage your database

00:11:22.992 --> 00:11:24.312
from the Wrangler cli.

00:11:24.432 --> 00:11:26.212
I just want to like make sure we're also familiar

00:11:26.212 --> 00:11:27.652
with the dashboard.

00:11:27.972 --> 00:11:30.652
Now the last thing that we need is a Cloudflare D1

00:11:30.652 --> 00:11:31.002
token.

00:11:31.152 --> 00:11:33.192
Now this one is a little bit less documented,

00:11:33.192 --> 00:11:35.072
which is kind of why I think a course is valuable,

00:11:35.072 --> 00:11:36.352
as you can see this process.

00:11:36.352 --> 00:11:39.592
But essentially Cloudflare gives you API tokens

00:11:39.592 --> 00:11:41.872
that allow you to also manage resources via an

00:11:41.872 --> 00:11:42.352
API.

00:11:42.352 --> 00:11:45.312
And that's what the Drizzle Kit is using as well

00:11:45.312 --> 00:11:47.072
for authentication with Cloudflare.

00:11:47.232 --> 00:11:47.632
So,

00:11:47.892 --> 00:11:48.872
we can head over to

00:11:49.672 --> 00:11:51.272
Manage account at the bottom left.

00:11:51.752 --> 00:11:54.132
you can go to account APIs and then what we're

00:11:54.132 --> 00:11:55.952
going to do is we're going to say create a token

00:11:56.342 --> 00:11:58.312
and there's a bunch of these like pre built ones.

00:11:58.462 --> 00:11:59.102
usually typically,

00:11:59.102 --> 00:12:00.302
I typically don't use these templates.

00:12:00.302 --> 00:12:01.102
I just say like,

00:12:01.102 --> 00:12:02.302
let's do a custom token.

00:12:02.542 --> 00:12:04.462
We're going to say get started and I'm going to

00:12:04.462 --> 00:12:05.262
call this my

00:12:05.902 --> 00:12:07.662
Smart Links DB

00:12:07.982 --> 00:12:08.622
token.

00:12:08.622 --> 00:12:10.422
And you're only going to ever be able to see this

00:12:10.422 --> 00:12:10.782
once.

00:12:10.902 --> 00:12:13.102
so just make sure you save it and secure it

00:12:13.102 --> 00:12:13.542
somewhere.

00:12:13.952 --> 00:12:15.192
then what we're going to do is I'm going to search

00:12:15.192 --> 00:12:16.112
for D1.

00:12:16.192 --> 00:12:17.152
I type D1,

00:12:17.152 --> 00:12:18.192
it's at the very bottom.

00:12:18.562 --> 00:12:20.592
so this is going to Give access to D1 and what

00:12:20.592 --> 00:12:22.272
types of permissions we're going to want to give

00:12:22.272 --> 00:12:23.192
it edit permission.

00:12:23.522 --> 00:12:25.202
so we can also write and update stuff.

00:12:25.602 --> 00:12:27.962
And we're going to say continue to summary create

00:12:27.962 --> 00:12:28.362
token.

00:12:28.362 --> 00:12:30.322
Now I will be deleting this token later,

00:12:30.562 --> 00:12:33.082
so don't try to like steal it because it's just

00:12:33.082 --> 00:12:33.682
this whole,

00:12:33.842 --> 00:12:35.342
this whole this token will be gone.

00:12:36.212 --> 00:12:39.172
now I'm going to come on over to my Cloudflare D1

00:12:39.172 --> 00:12:40.932
token and we're going to add this here.

00:12:41.452 --> 00:12:44.372
we're going to save and then just make sure that

00:12:44.372 --> 00:12:45.772
you're CD into packages,

00:12:45.772 --> 00:12:46.412
so CD

00:12:47.612 --> 00:12:48.252
packages.

00:12:48.515 --> 00:12:50.475
And then we're going to say data Ops.

00:12:50.475 --> 00:12:52.515
So now we're at the root level of Data Ops.

00:12:52.755 --> 00:12:54.595
And what we're going to want to do is we're going

00:12:54.595 --> 00:12:55.995
to want to pull in some,

00:12:55.995 --> 00:12:57.515
we're going to basically want to like make sure

00:12:57.515 --> 00:12:58.195
everything's working.

00:12:58.355 --> 00:12:58.755
So

00:12:58.965 --> 00:12:59.815
as you can see here,

00:12:59.815 --> 00:13:02.295
we have a package JSON file.

00:13:02.725 --> 00:13:03.035
nope,

00:13:03.035 --> 00:13:03.315
sorry,

00:13:03.315 --> 00:13:04.035
wrong section.

00:13:04.035 --> 00:13:06.675
In the Data Ops source we have a

00:13:07.075 --> 00:13:08.675
package JSON file

00:13:08.995 --> 00:13:10.955
and we have a pull script.

00:13:10.955 --> 00:13:12.355
So this is going to pull whatever

00:13:12.765 --> 00:13:15.005
tables exist inside of our D1 database,

00:13:15.005 --> 00:13:16.285
which none exist right now,

00:13:16.365 --> 00:13:17.965
and they're going to put them in the code base.

00:13:17.965 --> 00:13:18.605
So I'm going to say

00:13:19.085 --> 00:13:20.365
PNPM run

00:13:20.765 --> 00:13:21.325
poll.

00:13:22.722 --> 00:13:23.422
wrong words.

00:13:23.422 --> 00:13:24.422
PNPM run.

00:13:25.509 --> 00:13:25.909
All right,

00:13:25.909 --> 00:13:27.269
so you're going to see something like this,

00:13:27.269 --> 00:13:28.529
where it's getting all of these,

00:13:28.649 --> 00:13:30.729
where it's getting all of the tables and then it

00:13:30.729 --> 00:13:30.929
like,

00:13:30.929 --> 00:13:32.889
finishes different migrations and

00:13:33.209 --> 00:13:36.129
ultimately you now have a Drizzle out folder

00:13:36.129 --> 00:13:36.849
inside of your project.

00:13:36.849 --> 00:13:38.809
And that Drizzle out folder is going to have a

00:13:38.969 --> 00:13:39.959
schema's file and.

00:13:40.029 --> 00:13:40.629
And spoiler alert.

00:13:40.629 --> 00:13:42.149
We don't have any schemas yet because we haven't

00:13:42.149 --> 00:13:43.349
created any tables,

00:13:43.349 --> 00:13:44.982
but we're going to go ahead and do that right now.

00:13:45.145 --> 00:13:48.105
So let's head back over to the Cloudflare UI

00:13:48.505 --> 00:13:51.465
and let's go back to our database section and

00:13:51.465 --> 00:13:52.585
let's click on our

00:13:52.819 --> 00:13:53.792
Smart links,

00:13:53.802 --> 00:13:54.532
stage table.

00:13:54.532 --> 00:13:56.092
And then this is actually pretty,

00:13:56.092 --> 00:13:57.692
a relatively new feature by Cloudflare.

00:13:57.692 --> 00:13:59.212
The UI might change a little bit around it,

00:13:59.212 --> 00:14:02.052
but we can say explore data and they give us like

00:14:02.052 --> 00:14:03.172
our own interactive

00:14:03.322 --> 00:14:04.712
query environment where we can

00:14:05.112 --> 00:14:05.992
create tables,

00:14:05.992 --> 00:14:07.272
write queries and whatnot.

00:14:07.272 --> 00:14:08.832
So we're going to go ahead and create a few

00:14:08.832 --> 00:14:09.392
different tables.

00:14:09.392 --> 00:14:10.872
The first table that we're going to create

00:14:11.412 --> 00:14:13.492
called links and don't worry about typing this,

00:14:13.492 --> 00:14:14.212
I'm going to paste,

00:14:14.212 --> 00:14:15.492
I'm going to make sure it's paste.

00:14:15.492 --> 00:14:16.972
I'm going to have it in the bottom of the video.

00:14:16.972 --> 00:14:17.972
You'll be able to paste it.

00:14:17.972 --> 00:14:20.092
So we're going to create a links table and that

00:14:20.092 --> 00:14:22.332
links table is going to have like ID about the

00:14:22.332 --> 00:14:22.692
link,

00:14:22.722 --> 00:14:24.692
and account ID destinations.

00:14:24.692 --> 00:14:26.252
It has like a whole bunch of different information

00:14:26.332 --> 00:14:26.892
that is

00:14:27.002 --> 00:14:27.732
that's useful.

00:14:27.812 --> 00:14:29.412
So we can go ahead and we can

00:14:29.982 --> 00:14:30.772
run that guy.

00:14:31.187 --> 00:14:33.547
We're also going to create a table called Link

00:14:33.547 --> 00:14:35.357
Clicks and this is going to be that

00:14:35.667 --> 00:14:37.747
table that powers the analytics.

00:14:37.747 --> 00:14:39.267
So all of like the actual like

00:14:39.946 --> 00:14:42.866
so all of the like dashboard related stuff where

00:14:42.866 --> 00:14:45.146
we're able to see like how many queries were

00:14:45.466 --> 00:14:47.906
how many click link clicks per link per region and

00:14:47.906 --> 00:14:48.306
whatnot.

00:14:48.306 --> 00:14:50.165
So that's what this table is going to be

00:14:50.165 --> 00:14:51.465
and we can go ahead and run that guy

00:14:51.576 --> 00:14:53.537
and then we are going to,

00:14:54.035 --> 00:14:56.075
we're going to create a few different indexes as

00:14:56.075 --> 00:14:56.355
well.

00:14:56.515 --> 00:14:56.915
So

00:14:57.255 --> 00:14:59.725
this is actually probably not necessary for this

00:14:59.725 --> 00:15:00.045
project.

00:15:00.285 --> 00:15:00.685
But

00:15:00.925 --> 00:15:02.465
when we create indexes on tables,

00:15:02.465 --> 00:15:04.425
it's basically creating data structures

00:15:04.745 --> 00:15:05.705
for each table

00:15:06.185 --> 00:15:06.825
that allow

00:15:07.245 --> 00:15:09.125
reads and writes to be more performant.

00:15:09.125 --> 00:15:11.125
Well technically in this case reads will be more

00:15:11.125 --> 00:15:11.645
performant,

00:15:11.645 --> 00:15:12.965
writes will be less performant.

00:15:12.965 --> 00:15:15.405
But a lot of times if you have like a scenario

00:15:15.405 --> 00:15:18.125
where you have data that's segmented by account

00:15:18.535 --> 00:15:20.295
and then every single query you have is kind of

00:15:20.295 --> 00:15:20.855
filtering,

00:15:20.855 --> 00:15:22.935
I want to find all the data for an account.

00:15:24.075 --> 00:15:26.235
you might want to index based upon an account so

00:15:26.235 --> 00:15:28.755
your query can isolate those accounts really

00:15:28.755 --> 00:15:30.155
quickly and then scan the data.

00:15:30.515 --> 00:15:33.075
if you want to learn more about like how to manage

00:15:33.075 --> 00:15:33.714
schemas,

00:15:33.714 --> 00:15:35.155
how to write performing queries,

00:15:35.155 --> 00:15:37.475
how to like learn more about indexes if that's not

00:15:37.475 --> 00:15:39.355
your forte or you don't have like a lot of

00:15:39.355 --> 00:15:40.595
experience in the data world.

00:15:40.995 --> 00:15:43.155
PlanetScale actually has this course which I'll

00:15:43.155 --> 00:15:44.835
link at the bottom of this video where

00:15:45.635 --> 00:15:46.515
they go into like,

00:15:46.755 --> 00:15:48.675
like it's actually pretty high level but it goes

00:15:48.675 --> 00:15:49.355
relatively deep.

00:15:49.355 --> 00:15:51.475
So like they teach you about schemas and data

00:15:51.475 --> 00:15:53.315
types and how to write performant queries and how

00:15:53.315 --> 00:15:54.275
to index and like,

00:15:54.275 --> 00:15:55.795
I honestly think this is probably one of the best

00:15:55.795 --> 00:15:57.075
like free SQL like

00:15:57.315 --> 00:15:58.235
resources out there.

00:15:58.235 --> 00:16:01.035
So it applies for SQLite and for like these

00:16:01.035 --> 00:16:02.435
concepts are kind of the same across different

00:16:02.435 --> 00:16:03.075
databases.

00:16:03.475 --> 00:16:04.475
So don't think like,

00:16:04.475 --> 00:16:04.675
oh,

00:16:04.675 --> 00:16:04.795
well,

00:16:04.795 --> 00:16:05.875
I'm not using PlanetScale.

00:16:05.875 --> 00:16:06.195
Like it,

00:16:06.195 --> 00:16:06.675
it is

00:16:07.075 --> 00:16:09.635
these concepts kind of like cascade past just like

00:16:09.635 --> 00:16:10.415
one database,

00:16:10.415 --> 00:16:11.352
type or provider.

00:16:11.921 --> 00:16:12.321
All right,

00:16:12.401 --> 00:16:13.921
so let's head back over to here.

00:16:14.161 --> 00:16:15.681
I'm going to run these indexes,

00:16:15.788 --> 00:16:16.752
run all these guys.

00:16:16.891 --> 00:16:17.449
And then

00:16:17.599 --> 00:16:19.809
the last table that we are going to create

00:16:19.905 --> 00:16:20.475
is called

00:16:21.035 --> 00:16:21.675
destination

00:16:23.035 --> 00:16:24.235
evaluations.

00:16:24.395 --> 00:16:25.675
So this guy right here

00:16:26.315 --> 00:16:28.315
is the table that basically

00:16:29.035 --> 00:16:31.715
keeps track of like the evaluations that our AI

00:16:31.715 --> 00:16:32.035
runs.

00:16:32.035 --> 00:16:34.475
So our AI is going to like programmatically go

00:16:34.475 --> 00:16:34.795
through,

00:16:34.875 --> 00:16:36.835
find different like destination links.

00:16:36.835 --> 00:16:37.915
It's going to load the page,

00:16:37.915 --> 00:16:40.315
it's going to look at the content of the page and

00:16:40.315 --> 00:16:40.995
it's going to tell us like,

00:16:40.995 --> 00:16:41.195
hey,

00:16:41.195 --> 00:16:43.275
is this product sold out or is this page no longer

00:16:43.275 --> 00:16:43.515
available?

00:16:43.515 --> 00:16:44.435
It's going to be a pretty like,

00:16:44.435 --> 00:16:46.515
smart AI system and then we're going to have to

00:16:46.515 --> 00:16:48.515
kind of like store metadata about that process and

00:16:48.515 --> 00:16:49.634
that's what this table is going to be.

00:16:49.634 --> 00:16:51.475
I know I'm going like over these tables really

00:16:51.475 --> 00:16:51.915
quickly.

00:16:51.995 --> 00:16:53.475
They're going to make a lot more sense as we

00:16:53.475 --> 00:16:54.115
progress further.

00:16:54.115 --> 00:16:56.675
But the main purpose of this section of the video

00:16:56.675 --> 00:16:59.035
is we need to create a,

00:16:59.375 --> 00:17:00.915
we need to create our tables.

00:17:00.915 --> 00:17:03.035
That way we can actually start like using those

00:17:03.035 --> 00:17:04.195
tables in our application.

00:17:04.836 --> 00:17:06.836
So the main point that I want to drive here home

00:17:06.836 --> 00:17:08.076
now is we have tables,

00:17:08.076 --> 00:17:09.396
we have all of them created.

00:17:09.876 --> 00:17:12.476
Now if we head back over to our repo and we make

00:17:12.476 --> 00:17:13.716
sure we are in our

00:17:14.224 --> 00:17:16.024
we are in the Data Ops package,

00:17:16.024 --> 00:17:17.024
not the application.

00:17:17.184 --> 00:17:18.704
And then we say pnpm,

00:17:18.864 --> 00:17:20.064
run Poll

00:17:20.384 --> 00:17:22.464
Drizzle is now going to

00:17:22.864 --> 00:17:23.984
dynamically create

00:17:24.304 --> 00:17:25.104
all of these

00:17:25.554 --> 00:17:26.184
schemas

00:17:26.504 --> 00:17:27.704
based upon the,

00:17:27.890 --> 00:17:30.108
based upon the tables that we just created,

00:17:30.318 --> 00:17:32.118
in our Cloudflare D1 database.

00:17:32.118 --> 00:17:34.158
So you can see we have our links table,

00:17:34.548 --> 00:17:36.738
we have our link clicks table

00:17:37.248 --> 00:17:39.408
and we have our destination evaluation.

00:17:39.408 --> 00:17:41.408
So these are the three tables that we have

00:17:41.408 --> 00:17:41.848
created.

00:17:41.848 --> 00:17:44.208
And now what we can do is we can use these schemas

00:17:44.208 --> 00:17:46.968
to write queries that will actually like insert

00:17:46.968 --> 00:17:49.281
data into our table or read data from our tables.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.098 --> 00:00:00.578
All right,

00:00:00.578 --> 00:00:02.618
so now that we have our database created,

00:00:02.618 --> 00:00:05.218
we have created our tables and we've pulled those

00:00:05.218 --> 00:00:07.498
table schemas into our project that are,

00:00:07.498 --> 00:00:09.778
and they're represented as typescript objects.

00:00:10.018 --> 00:00:11.857
Let's now go through the process of actually

00:00:11.857 --> 00:00:14.498
building out a query that's going to create and

00:00:14.578 --> 00:00:15.698
save link information.

00:00:16.178 --> 00:00:19.098
So what I'm going to do here is I'm actually going

00:00:19.098 --> 00:00:19.458
to

00:00:19.778 --> 00:00:21.298
navigate over to

00:00:21.628 --> 00:00:23.698
the app that the user application within the

00:00:23.698 --> 00:00:23.938
project.

00:00:24.178 --> 00:00:25.738
I just want to be able to kind of split these

00:00:25.738 --> 00:00:27.778
applications up so we're able to

00:00:28.098 --> 00:00:30.338
navigate and kind of see what's going on easier.

00:00:30.418 --> 00:00:31.538
But you don't have to do this.

00:00:31.538 --> 00:00:33.298
You can work within this Mono repo.

00:00:33.298 --> 00:00:36.698
But for me I'm just going to CD into the apps and

00:00:36.698 --> 00:00:37.778
the user application

00:00:38.098 --> 00:00:38.817
and then

00:00:39.814 --> 00:00:41.094
I'm going to open up

00:00:41.124 --> 00:00:42.861
the user application as its own,

00:00:42.868 --> 00:00:44.448
as its own project here.

00:00:44.448 --> 00:00:46.488
So this is going to be a little bit easier for you

00:00:46.488 --> 00:00:47.648
guys to see what's going on.

00:00:47.648 --> 00:00:48.048
So

00:00:48.328 --> 00:00:48.848
I'll do that.

00:00:48.848 --> 00:00:50.648
I'm going to open up a new terminal in here

00:00:50.758 --> 00:00:53.846
and then I'm going to say pnpm run dev and I'm

00:00:53.846 --> 00:00:55.646
going to zoom in quite a bit so you guys can

00:00:55.646 --> 00:00:55.926
actually

00:00:56.486 --> 00:00:58.166
see more clearly what's going on.

00:00:58.966 --> 00:01:01.946
But now we have our application running up,

00:01:01.946 --> 00:01:02.784
we'll head on over

00:01:03.026 --> 00:01:05.746
and what we're going to do is we're going to start

00:01:05.746 --> 00:01:07.826
the process of actually building out the

00:01:08.036 --> 00:01:08.947
Create Link

00:01:09.374 --> 00:01:09.814
logic.

00:01:09.814 --> 00:01:11.654
So if you head over to this Create Link button,

00:01:11.654 --> 00:01:13.734
you're going to see that essentially what we need

00:01:13.734 --> 00:01:16.174
to do is we need to specify some type of name so

00:01:16.174 --> 00:01:16.974
we can say like

00:01:17.994 --> 00:01:18.714
random

00:01:19.114 --> 00:01:19.514
product

00:01:20.154 --> 00:01:22.394
and then we're going to give it a link and that's

00:01:22.394 --> 00:01:24.033
the link that is going to be routed to when

00:01:24.033 --> 00:01:24.914
somebody clicks on it.

00:01:24.914 --> 00:01:25.914
And then when we hit Create

00:01:26.234 --> 00:01:28.154
it should create it and then bring us to this

00:01:28.154 --> 00:01:28.714
dashboard.

00:01:28.714 --> 00:01:30.394
Now obviously this is just kind of dummy data

00:01:30.394 --> 00:01:30.874
right now,

00:01:31.194 --> 00:01:33.274
but what we're going to do is we're actually going

00:01:33.274 --> 00:01:34.274
to build out that logic.

00:01:34.274 --> 00:01:36.074
So we can go to the Create Link thing,

00:01:36.644 --> 00:01:39.124
slide over to the user application and then let's

00:01:39.124 --> 00:01:39.884
go into the routes.

00:01:39.884 --> 00:01:41.844
So in the routes inside of our app

00:01:41.854 --> 00:01:42.680
we will go to auth,

00:01:42.840 --> 00:01:44.920
and then there's this Create tsx,

00:01:44.920 --> 00:01:46.360
so this is the Create page.

00:01:46.760 --> 00:01:49.120
And then what we're going to notice here is we

00:01:49.120 --> 00:01:50.120
have a mutation.

00:01:50.440 --> 00:01:52.680
And that mutation is the

00:01:52.950 --> 00:01:55.940
function that actually calls the server side code

00:01:56.020 --> 00:01:57.300
to save the link information.

00:01:57.780 --> 00:02:00.340
And what happens here is if we can go find Create.

00:02:01.100 --> 00:02:03.420
Create mutation is There's a button

00:02:03.740 --> 00:02:06.420
that is basically the Create button that calls

00:02:06.420 --> 00:02:07.100
this mutation.

00:02:07.180 --> 00:02:09.620
And then when it calls that mutation and it's

00:02:09.620 --> 00:02:10.700
successfully resolved,

00:02:11.260 --> 00:02:11.900
it will,

00:02:12.260 --> 00:02:15.940
it'll navigate to the specific link page.

00:02:16.340 --> 00:02:18.460
So what we're going to want to do is we're going

00:02:18.460 --> 00:02:20.340
to want to actually build out what's on the back

00:02:20.340 --> 00:02:20.900
end here.

00:02:20.980 --> 00:02:22.694
So if we go to our mutation,

00:02:22.776 --> 00:02:24.336
we can right click on it,

00:02:24.336 --> 00:02:24.866
or we can,

00:02:25.016 --> 00:02:27.376
can command click on it and we can drill into the

00:02:27.376 --> 00:02:27.816
actual,

00:02:27.986 --> 00:02:28.756
worker code.

00:02:28.996 --> 00:02:30.396
Or if you don't do that,

00:02:30.396 --> 00:02:32.836
what you can do is you can go to.

00:02:33.156 --> 00:02:34.356
So if you look at the source,

00:02:34.356 --> 00:02:35.456
you can head over to Worker,

00:02:35.456 --> 00:02:36.296
go to the routes,

00:02:37.016 --> 00:02:38.376
go to the links,

00:02:38.376 --> 00:02:39.016
and I'm going to go,

00:02:39.216 --> 00:02:39.972
to the links.

00:02:39.972 --> 00:02:42.994
And then you'll see we have this specific

00:02:43.314 --> 00:02:44.034
mutation

00:02:44.514 --> 00:02:45.954
that says Create Link.

00:02:46.434 --> 00:02:48.594
Now there's also a input schema.

00:02:48.594 --> 00:02:48.764
And,

00:02:48.834 --> 00:02:50.274
and I don't want to touch too deep on this,

00:02:50.274 --> 00:02:53.154
but basically we're using a library called Zod to

00:02:53.314 --> 00:02:55.154
define what that input looks like.

00:02:55.154 --> 00:02:57.194
And then it does validation and throws errors if

00:02:57.194 --> 00:02:58.194
it's not of that type.

00:02:58.614 --> 00:03:00.114
this is actually defined

00:03:00.434 --> 00:03:02.594
inside of our Data Ops

00:03:02.694 --> 00:03:04.454
package within our monorepo.

00:03:04.534 --> 00:03:05.814
So what we're going to do is we're going to go

00:03:05.814 --> 00:03:07.334
over to that Data Ops package,

00:03:07.494 --> 00:03:09.894
we're going to go look for this Create Link schema

00:03:09.894 --> 00:03:10.934
just so you can see what it is.

00:03:11.254 --> 00:03:13.454
And then what we're going to do is we're actually

00:03:13.454 --> 00:03:14.694
going to build out the logic

00:03:14.744 --> 00:03:15.304
to say

00:03:15.944 --> 00:03:19.624
to take the input data and then save it inside of

00:03:19.624 --> 00:03:20.424
our database.

00:03:20.504 --> 00:03:24.064
So let's head over to our Data Ops package.

00:03:24.064 --> 00:03:25.628
What we're going to do is we're first going to

00:03:25.628 --> 00:03:26.668
look under Source.

00:03:26.740 --> 00:03:27.600
We can go to Zod,

00:03:27.920 --> 00:03:29.000
we can go to Links,

00:03:29.000 --> 00:03:30.480
and then you can see what this

00:03:30.530 --> 00:03:31.400
schema looks like.

00:03:31.800 --> 00:03:32.200
So

00:03:32.470 --> 00:03:34.705
a link schema is basically taking this.

00:03:34.705 --> 00:03:35.745
So it's basically taking

00:03:36.145 --> 00:03:36.405
this,

00:03:36.555 --> 00:03:36.795
this,

00:03:36.935 --> 00:03:38.455
object as the input.

00:03:38.755 --> 00:03:40.135
it takes a link id,

00:03:40.135 --> 00:03:41.351
it takes an account id,

00:03:41.351 --> 00:03:43.991
which this is going to come into play when we are

00:03:44.071 --> 00:03:45.951
actually integrating authentication into our

00:03:45.951 --> 00:03:46.471
application.

00:03:46.711 --> 00:03:47.151
For now,

00:03:47.151 --> 00:03:48.711
this will just kind of be dummy data.

00:03:49.371 --> 00:03:50.051
it takes a name,

00:03:50.051 --> 00:03:51.851
as you saw from this input,

00:03:52.251 --> 00:03:53.371
it takes destination,

00:03:54.091 --> 00:03:54.131
takes

00:03:54.351 --> 00:03:55.151
destinations,

00:03:55.391 --> 00:03:56.591
which is another

00:03:57.231 --> 00:03:58.151
Zod object,

00:03:58.151 --> 00:03:59.391
which is basically a

00:04:00.306 --> 00:04:02.666
which is basically just like an object of a key

00:04:02.666 --> 00:04:03.280
value pair.

00:04:03.280 --> 00:04:06.078
And then what we're doing is we are wiring it and

00:04:06.078 --> 00:04:08.038
we're basically pointing it as the input.

00:04:08.118 --> 00:04:10.438
So this is the specific type of data that we

00:04:10.678 --> 00:04:12.409
expect to be sent from the UI

00:04:12.426 --> 00:04:14.066
and to actually create the Query.

00:04:14.066 --> 00:04:16.266
What we can do is we can head over to our

00:04:16.676 --> 00:04:18.076
what we're going to do is we're actually probably

00:04:18.076 --> 00:04:19.596
going to create a new folder here.

00:04:19.596 --> 00:04:19.956
So

00:04:20.526 --> 00:04:22.135
going to create a new folder under Source

00:04:22.135 --> 00:04:23.719
and it's going to be called Queries.

00:04:25.959 --> 00:04:28.999
And inside of that folder I will create a new file

00:04:29.079 --> 00:04:31.399
and we'll call this Links ts.

00:04:32.352 --> 00:04:32.752
so

00:04:33.054 --> 00:04:34.014
Links ts.

00:04:34.174 --> 00:04:35.854
What we are going to want to do is we're going to

00:04:35.854 --> 00:04:36.574
want to actually

00:04:37.804 --> 00:04:38.684
create this

00:04:39.204 --> 00:04:39.604
Create

00:04:40.164 --> 00:04:43.324
link query that inserts the data into our

00:04:43.324 --> 00:04:43.724
database.

00:04:43.724 --> 00:04:44.724
So we can say export

00:04:47.768 --> 00:04:48.328
function,

00:04:48.488 --> 00:04:49.340
Create link

00:04:51.084 --> 00:04:52.684
and what we're going to actually do is we're going

00:04:52.684 --> 00:04:54.106
to make this async.

00:04:58.495 --> 00:05:00.895
Now this create link is going to take in some data

00:05:01.295 --> 00:05:04.255
and that data is going to be of the type Create

00:05:04.255 --> 00:05:06.575
link that we have defined inside of our Zod

00:05:06.575 --> 00:05:07.135
schemas.

00:05:07.215 --> 00:05:07.449
So

00:05:07.449 --> 00:05:08.941
what we can do is we can look here.

00:05:12.976 --> 00:05:13.456
All right,

00:05:13.536 --> 00:05:14.816
so we have this

00:05:15.136 --> 00:05:15.936
name we have,

00:05:15.936 --> 00:05:19.136
we have this type which is the Create link schema

00:05:19.136 --> 00:05:19.576
type.

00:05:19.576 --> 00:05:21.096
And I'm going to just make sure that that is

00:05:21.096 --> 00:05:23.296
imported and we can actually go to that file and

00:05:23.296 --> 00:05:23.736
you can see.

00:05:23.736 --> 00:05:25.696
So basically what we're saying is we have this

00:05:25.756 --> 00:05:28.556
Create links odd schema and what we're going to do

00:05:28.556 --> 00:05:29.636
is we are going to,

00:05:29.716 --> 00:05:31.276
we export the type of that.

00:05:31.276 --> 00:05:34.756
So we have a Zod infer type of and we have the

00:05:34.916 --> 00:05:36.276
Create link type schema.

00:05:36.276 --> 00:05:37.396
So this just makes our

00:05:37.616 --> 00:05:39.576
code very type safe and it also helps with like

00:05:39.576 --> 00:05:40.256
autocomplete.

00:05:40.256 --> 00:05:42.436
AI is able to understand and complet stuff faster

00:05:42.436 --> 00:05:42.596
too,

00:05:42.596 --> 00:05:43.396
which is really nice.

00:05:43.396 --> 00:05:45.836
So what we're doing is we're going to say the data

00:05:45.836 --> 00:05:47.756
that gets passed into has to be of the shape

00:05:47.756 --> 00:05:48.556
create link.

00:05:48.956 --> 00:05:52.476
And additionally it needs an account ID because on

00:05:52.476 --> 00:05:54.876
this type we are actually omitting

00:05:55.076 --> 00:05:57.266
the account ID because this is going to be

00:05:58.146 --> 00:06:00.506
in by our TRPC route and I'll show you what that's

00:06:00.506 --> 00:06:01.146
going to look like.

00:06:01.306 --> 00:06:01.706
So

00:06:02.187 --> 00:06:03.608
if we head back to this function,

00:06:03.608 --> 00:06:05.368
what we can do is we're going to first say like

00:06:05.368 --> 00:06:06.368
let's get our database.

00:06:06.448 --> 00:06:09.428
So we're going to say const and DB equals

00:06:10.038 --> 00:06:11.068
get db.

00:06:12.268 --> 00:06:14.388
And you might be wondering where is get DB come

00:06:14.388 --> 00:06:14.548
from.

00:06:14.548 --> 00:06:15.708
This is kind of what I want to touch on.

00:06:15.708 --> 00:06:16.668
This is the first step

00:06:16.818 --> 00:06:19.458
of the process that I kind of take when building

00:06:19.458 --> 00:06:23.178
out a monorepo is I create a getter and a setter

00:06:23.178 --> 00:06:24.058
for the database.

00:06:24.058 --> 00:06:25.392
So if we head over to this file,

00:06:25.392 --> 00:06:27.433
it's going to be in database TS

00:06:27.753 --> 00:06:29.273
what we're going to see is there's this very

00:06:29.273 --> 00:06:31.833
simple logic where we are implementing or we're

00:06:31.833 --> 00:06:33.573
importing drizzle from the

00:06:33.663 --> 00:06:34.864
D1 package of drizzle.

00:06:34.864 --> 00:06:36.909
Then what we're basically saying is we're defining

00:06:36.909 --> 00:06:38.869
a database or a DB

00:06:39.349 --> 00:06:41.529
that has the return type of drizzle

00:06:41.561 --> 00:06:43.761
and then we have this function and this function

00:06:43.761 --> 00:06:44.041
is

00:06:44.311 --> 00:06:45.301
init database,

00:06:45.301 --> 00:06:48.821
which takes in a D1 database and then it sets this

00:06:49.061 --> 00:06:49.710
globally.

00:06:49.710 --> 00:06:52.100
Now what we're able to do is when the application

00:06:52.100 --> 00:06:54.900
runs and it starts up and we get a request,

00:06:55.370 --> 00:06:56.770
the very first thing that we're going to do when

00:06:56.770 --> 00:06:58.570
we get a request is we're going to call this

00:06:58.570 --> 00:06:59.050
method

00:06:59.370 --> 00:07:01.850
init database and then that's going to set this

00:07:01.850 --> 00:07:05.210
database so we can use it throughout the rest of

00:07:05.210 --> 00:07:06.570
the lifecycle of a request.

00:07:06.730 --> 00:07:08.490
And then what happens here is we're able to kind

00:07:08.490 --> 00:07:09.770
of abstract away the

00:07:10.230 --> 00:07:11.630
getting and the creating of

00:07:12.150 --> 00:07:13.990
queries within our application code.

00:07:13.990 --> 00:07:15.910
And it's all going to be pushed into this package.

00:07:16.070 --> 00:07:16.470
So

00:07:17.370 --> 00:07:19.770
from there we export this function called get db

00:07:20.020 --> 00:07:21.740
which is literally just trying to get this DB

00:07:21.740 --> 00:07:22.260
right here.

00:07:22.740 --> 00:07:25.500
And if that DB hasn't been instantiated so we

00:07:25.500 --> 00:07:26.180
don't call this

00:07:26.920 --> 00:07:29.000
if we don't call this when we first get a request

00:07:29.160 --> 00:07:30.160
we're going to see this error.

00:07:30.160 --> 00:07:31.960
And if we see this error we know exactly what went

00:07:31.960 --> 00:07:32.320
wrong

00:07:32.420 --> 00:07:33.940
we'll just make sure we have it instantiated.

00:07:33.940 --> 00:07:35.459
So this is kind of like a one time setup thing

00:07:35.459 --> 00:07:37.420
that we do when we're building out a new

00:07:37.720 --> 00:07:39.126
service or application.

00:07:39.126 --> 00:07:40.460
So let's head back to our queries

00:07:40.528 --> 00:07:41.434
and we're going to

00:07:41.754 --> 00:07:42.674
write this query.

00:07:42.674 --> 00:07:44.874
So a few things that I'm going to do here like I'm

00:07:44.874 --> 00:07:45.914
going to create a

00:07:47.294 --> 00:07:49.054
ID which is going to be used,

00:07:50.334 --> 00:07:52.314
which is going to be used or passed in

00:07:52.314 --> 00:07:53.714
as like the actual link id.

00:07:53.874 --> 00:07:55.794
And a nano ID is like a good,

00:07:55.794 --> 00:07:57.794
but it's much smaller just because I don't want

00:07:57.794 --> 00:07:58.914
these links to be too long,

00:07:59.124 --> 00:08:00.634
because it's kind of like a short link system.

00:08:01.034 --> 00:08:03.074
And then what we're going to do is we're going to

00:08:03.074 --> 00:08:03.354
say

00:08:03.674 --> 00:08:05.434
await db.insvert

00:08:06.314 --> 00:08:08.634
and then we're going to pass in the links table.

00:08:08.634 --> 00:08:09.834
So this links table

00:08:10.234 --> 00:08:10.874
should be

00:08:11.974 --> 00:08:15.014
it'll be imported from the schemas that were

00:08:15.014 --> 00:08:16.134
generated by

00:08:16.534 --> 00:08:16.934
the

00:08:17.334 --> 00:08:18.414
Drizzle Kit command.

00:08:18.414 --> 00:08:20.358
When we said npm run pull

00:08:20.358 --> 00:08:22.514
so we're able to pull this actual link schema.

00:08:22.514 --> 00:08:24.351
This was auto generated by that command

00:08:24.351 --> 00:08:25.573
and then we're going to go ahead and finish

00:08:25.573 --> 00:08:27.054
writing this query where we insert

00:08:28.344 --> 00:08:29.144
values.

00:08:33.224 --> 00:08:34.744
And I'm just going to go ahead and copy some of

00:08:34.744 --> 00:08:35.394
this stuff.

00:08:35.394 --> 00:08:35.629
So

00:08:36.676 --> 00:08:37.876
we're going to Pass in the ID

00:08:37.969 --> 00:08:38.864
the account name,

00:08:38.864 --> 00:08:41.189
so data.account name which is defined here.

00:08:41.869 --> 00:08:45.629
then we're going to pass in the data name which is

00:08:45.629 --> 00:08:46.565
passed in from here,

00:08:46.565 --> 00:08:49.857
and we're going to JSON our Stringify the

00:08:49.857 --> 00:08:51.217
destinations object.

00:08:51.217 --> 00:08:53.017
So we're going to store all the destinations that

00:08:53.017 --> 00:08:54.430
the links could possibly route to.

00:08:54.432 --> 00:08:54.832
And

00:08:55.152 --> 00:08:57.072
that is literally all that we need to do here.

00:08:57.072 --> 00:08:58.712
The only last thing that I want to do is I'm just

00:08:58.712 --> 00:08:59.232
going to return

00:08:59.802 --> 00:09:01.482
the ID that was defined.

00:09:01.642 --> 00:09:03.002
So just to kind of reiterate,

00:09:03.082 --> 00:09:04.202
we have this function,

00:09:04.442 --> 00:09:06.282
and this function is called Create Link.

00:09:06.922 --> 00:09:09.722
this is going to be used inside of our TRPC route.

00:09:10.202 --> 00:09:12.602
We are grabbing our database from a,

00:09:12.762 --> 00:09:14.702
database getter that we've defined within this

00:09:14.702 --> 00:09:15.302
package,

00:09:15.622 --> 00:09:16.662
creating a random id,

00:09:16.902 --> 00:09:19.062
Then we're inserting the data into our database.

00:09:19.222 --> 00:09:19.782
All right,

00:09:20.262 --> 00:09:21.942
so now what we're going to want to do is you're

00:09:21.942 --> 00:09:23.542
going to want to understand exactly how

00:09:24.482 --> 00:09:25.142
we end up,

00:09:25.195 --> 00:09:27.035
how we actually end up building this project so it

00:09:27.035 --> 00:09:28.875
can be used by our application.

00:09:28.955 --> 00:09:31.605
So if you look in our package JSON

00:09:31.605 --> 00:09:33.369
inside of this data ops package,

00:09:33.369 --> 00:09:36.371
we specified the name Repo Data Ops.

00:09:36.371 --> 00:09:37.091
So this is the project,

00:09:37.171 --> 00:09:38.611
or this is like the package name.

00:09:38.931 --> 00:09:41.171
And then we have this export script which if you

00:09:41.171 --> 00:09:42.331
haven't worked in a monorepo,

00:09:42.331 --> 00:09:45.051
you might not be familiar that like pnpm,

00:09:45.051 --> 00:09:47.411
you're able to define an export script.

00:09:47.491 --> 00:09:47.741
And,

00:09:47.891 --> 00:09:49.811
and what this does is this basically says,

00:09:50.181 --> 00:09:53.101
this package should have access to like these

00:09:53.101 --> 00:09:54.181
specific paths.

00:09:54.181 --> 00:09:56.261
So it should be able to import stuff from a

00:09:56.261 --> 00:09:57.381
database path,

00:09:57.621 --> 00:09:59.061
stuff from a queries path,

00:09:59.141 --> 00:09:59.781
which is

00:10:00.181 --> 00:10:01.381
in the same folder

00:10:01.701 --> 00:10:03.861
for where we define this specific query.

00:10:04.271 --> 00:10:05.721
and then basically what we're doing is we're

00:10:05.721 --> 00:10:05.961
saying

00:10:06.281 --> 00:10:09.321
go traverse all of the query files within this

00:10:09.321 --> 00:10:12.841
folder and it's specifying the types when this is

00:10:12.841 --> 00:10:13.241
built

00:10:13.801 --> 00:10:16.201
and it's also specifying where those JS files are.

00:10:16.351 --> 00:10:18.341
we're doing the same for SOD schemas and then a

00:10:18.341 --> 00:10:19.221
few other things in here.

00:10:19.381 --> 00:10:21.541
So this is the configuration for the package of a

00:10:21.541 --> 00:10:22.341
monorepo.

00:10:22.341 --> 00:10:22.901
And then

00:10:23.012 --> 00:10:24.468
what we're going to do is

00:10:24.948 --> 00:10:27.388
you're going to make sure you are in the data ops

00:10:27.388 --> 00:10:30.228
package and then you're going to say pnpm

00:10:31.668 --> 00:10:32.708
run build.

00:10:33.668 --> 00:10:36.228
That's going to build the code and that's going to

00:10:36.228 --> 00:10:38.948
be output into a dist folder and what you're going

00:10:38.948 --> 00:10:40.828
to notice here is in the dist folder we'll have

00:10:40.828 --> 00:10:41.788
the same paths here.

00:10:41.788 --> 00:10:43.708
So like run we will have a dist

00:10:44.268 --> 00:10:46.748
and then we should have a database,

00:10:47.008 --> 00:10:47.888
or a DB

00:10:48.288 --> 00:10:49.088
database

00:10:49.488 --> 00:10:50.008
js.

00:10:50.008 --> 00:10:52.048
So DB database js.

00:10:52.288 --> 00:10:53.248
Same with the queries.

00:10:53.248 --> 00:10:55.568
So we have a queries folder and essentially like

00:10:55.568 --> 00:10:58.318
our code got exported into here in JS format.

00:10:58.318 --> 00:11:00.048
and it also exported those types.

00:11:00.128 --> 00:11:00.458
So

00:11:00.458 --> 00:11:02.828
our TypeScript project or application will be able

00:11:02.828 --> 00:11:04.508
to pick up on those types too.

00:11:05.068 --> 00:11:07.628
So if we now head back over to our,

00:11:08.598 --> 00:11:10.958
if we head back over to our user application and

00:11:10.958 --> 00:11:12.918
then we go to the package JSON file,

00:11:12.918 --> 00:11:15.238
what you're going to notice here is we have a

00:11:15.238 --> 00:11:15.558
project

00:11:16.118 --> 00:11:17.078
defined in here

00:11:17.403 --> 00:11:18.356
called Repo

00:11:18.676 --> 00:11:19.596
DataOps.

00:11:19.596 --> 00:11:20.516
And this is actually.

00:11:20.516 --> 00:11:22.156
So if you look at the version here,

00:11:22.156 --> 00:11:23.956
it's not like a numeric version,

00:11:24.436 --> 00:11:26.156
it's coming from workspace.

00:11:26.156 --> 00:11:27.636
So this is PMPM specific,

00:11:27.636 --> 00:11:29.876
where we basically say this package is going to

00:11:29.876 --> 00:11:30.756
come from workspace.

00:11:30.756 --> 00:11:32.866
So it knows to look at the workspace and,

00:11:32.936 --> 00:11:34.776
and then pull those files from wherever the

00:11:34.776 --> 00:11:36.056
exports have been defined

00:11:36.456 --> 00:11:38.456
inside of this workspace.

00:11:38.696 --> 00:11:39.256
Okay,

00:11:39.496 --> 00:11:39.896
so,

00:11:40.216 --> 00:11:41.176
and now

00:11:41.976 --> 00:11:43.416
what we're going to want to do is we're going to

00:11:43.416 --> 00:11:45.896
want to head back over to our TRPC route

00:11:46.296 --> 00:11:47.176
called Links,

00:11:47.496 --> 00:11:48.536
where we have this,

00:11:49.163 --> 00:11:51.323
where we have this Create link method.

00:11:51.643 --> 00:11:53.603
And then what we're going to do is we're basically

00:11:53.603 --> 00:11:54.203
going to say

00:11:54.843 --> 00:11:57.883
we're going to take the input from trpc

00:11:58.443 --> 00:12:01.163
and you can see that this input is from the input.

00:12:01.163 --> 00:12:02.283
We have the name,

00:12:02.283 --> 00:12:03.563
we have the destinations,

00:12:03.583 --> 00:12:05.443
we have some information that's being sent from

00:12:05.443 --> 00:12:06.003
the ui.

00:12:06.323 --> 00:12:07.923
And then we're going to say await,

00:12:09.813 --> 00:12:11.893
and we're going to call this method and this

00:12:11.893 --> 00:12:12.213
should,

00:12:13.093 --> 00:12:14.453
should be able to import this

00:12:15.093 --> 00:12:15.973
from our

00:12:16.453 --> 00:12:17.333
data ops.

00:12:17.333 --> 00:12:18.933
So we can say from queries,

00:12:20.009 --> 00:12:21.449
forward slash links.

00:12:22.719 --> 00:12:23.119
All right,

00:12:23.199 --> 00:12:25.679
so we have this method Create Links.

00:12:25.919 --> 00:12:27.519
We'll head on over to our code

00:12:27.839 --> 00:12:29.199
on the create link,

00:12:29.879 --> 00:12:31.079
on the Create link

00:12:31.479 --> 00:12:32.999
procedure that we've defined here.

00:12:33.319 --> 00:12:35.319
And then we're just going to simply put

00:12:35.639 --> 00:12:36.759
in this data.

00:12:36.759 --> 00:12:38.039
So we are going to say,

00:12:45.414 --> 00:12:45.894
okay,

00:12:45.894 --> 00:12:47.734
so what we're able to do is.

00:12:47.813 --> 00:12:49.814
So I guess one other thing here,

00:12:50.134 --> 00:12:51.334
we're going to want to also

00:12:52.294 --> 00:12:53.014
expose

00:12:54.214 --> 00:12:55.054
ctx.

00:12:55.054 --> 00:12:56.094
This is the context.

00:12:56.094 --> 00:12:58.454
So with trpc you have,

00:12:58.454 --> 00:13:00.254
if you just basically say like I'm going to take

00:13:00.254 --> 00:13:00.534
data,

00:13:00.854 --> 00:13:02.454
you have a bunch of information here.

00:13:02.794 --> 00:13:03.194
You have

00:13:03.514 --> 00:13:04.954
data dot input.

00:13:05.194 --> 00:13:08.034
This is the input that's defined inside of your

00:13:08.034 --> 00:13:08.714
procedure.

00:13:09.194 --> 00:13:10.794
You also have context

00:13:11.114 --> 00:13:13.314
which has some like attributes related to the

00:13:13.314 --> 00:13:15.194
request and then also additional things that you

00:13:15.194 --> 00:13:15.474
add.

00:13:15.474 --> 00:13:17.194
We're going to go into this in just a little bit.

00:13:18.554 --> 00:13:20.154
so essentially what we're doing here is we're

00:13:20.154 --> 00:13:21.274
saying we just need to grab.

00:13:21.274 --> 00:13:23.754
We just want context and we want input.

00:13:23.754 --> 00:13:25.834
And then the input is the input from the form,

00:13:26.234 --> 00:13:27.514
so we're inputting that here.

00:13:27.834 --> 00:13:30.314
And then the account ID is actually the user ID

00:13:30.554 --> 00:13:32.714
that's going to be provided from our auth

00:13:33.484 --> 00:13:34.044
framework.

00:13:34.204 --> 00:13:36.684
Now what I want to do right now is I want to

00:13:36.703 --> 00:13:37.013
run,

00:13:37.013 --> 00:13:39.333
I want to actually like use the UI and it's going

00:13:39.333 --> 00:13:40.053
to error out.

00:13:40.053 --> 00:13:41.253
And when it errors out,

00:13:41.253 --> 00:13:41.772
try to like,

00:13:41.772 --> 00:13:43.453
think of why it's actually erroring out.

00:13:43.453 --> 00:13:44.467
So we come over here,

00:13:44.467 --> 00:13:45.454
I'm going to inspect,

00:13:45.854 --> 00:13:46.574
go to Network,

00:13:46.700 --> 00:13:48.261
and I'm going to basically give it a fake product

00:13:48.261 --> 00:13:48.621
name,

00:13:50.351 --> 00:13:50.991
product one.

00:13:51.471 --> 00:13:53.831
And we're just going to have like some random

00:13:53.831 --> 00:13:56.431
destination URL and we're going to hit create.

00:13:56.431 --> 00:13:58.431
And what you can see is we have a failed

00:13:58.781 --> 00:13:59.491
Create link.

00:13:59.731 --> 00:14:01.291
We got a 500 here.

00:14:01.291 --> 00:14:03.571
It's going to have kind of some generic like

00:14:03.731 --> 00:14:04.611
internal service

00:14:05.021 --> 00:14:05.371
error.

00:14:05.371 --> 00:14:07.051
And then the error is

00:14:07.451 --> 00:14:09.131
database not initialized.

00:14:09.131 --> 00:14:09.964
So if you remember,

00:14:09.964 --> 00:14:11.044
we created

00:14:11.244 --> 00:14:11.523
our.

00:14:11.523 --> 00:14:13.046
We created our database

00:14:13.215 --> 00:14:15.695
logic where we have to initialize the.

00:14:16.575 --> 00:14:16.585
We,

00:14:16.715 --> 00:14:18.435
have to initialize the database when we first

00:14:18.435 --> 00:14:19.395
receive the request.

00:14:20.035 --> 00:14:21.940
So with our cloudflare worker,

00:14:21.940 --> 00:14:22.890
if we close the stuff.

00:14:22.890 --> 00:14:24.650
So if you come to the worker in our user

00:14:24.650 --> 00:14:25.208
application,

00:14:25.208 --> 00:14:26.043
come to index,

00:14:26.043 --> 00:14:27.963
what you're going to see is we have this very

00:14:28.043 --> 00:14:29.963
generic basic fetch handler

00:14:30.603 --> 00:14:31.843
and we're receiving,

00:14:31.843 --> 00:14:32.923
we're defining the fetch

00:14:33.143 --> 00:14:35.503
method and we're getting the request and the EMV

00:14:35.503 --> 00:14:36.823
with all the bindings and everything.

00:14:37.813 --> 00:14:40.213
And what we're doing is we're basically saying if

00:14:40.213 --> 00:14:41.893
the path is of trpc,

00:14:42.133 --> 00:14:44.933
we're going to pass in that request to this

00:14:44.933 --> 00:14:45.813
fetch request handler,

00:14:45.973 --> 00:14:48.053
which is implementing trpc.

00:14:48.053 --> 00:14:50.733
So it's kind of routing the request to our TRPC

00:14:50.733 --> 00:14:51.733
handler internally.

00:14:52.213 --> 00:14:54.773
So this is basically the entry point of a request.

00:14:55.093 --> 00:14:57.653
So what we can do is we can say init database

00:14:58.133 --> 00:14:59.813
and I'm going to go ahead and import that.

00:15:01.013 --> 00:15:02.213
So it's going to come from

00:15:03.433 --> 00:15:04.073
ops

00:15:05.109 --> 00:15:05.727
database

00:15:08.089 --> 00:15:10.894
and then we can pass in emv.db.

00:15:10.894 --> 00:15:13.202
emv.db.

00:15:14.396 --> 00:15:15.116
oh yeah,

00:15:15.196 --> 00:15:16.876
also one other thing to note here.

00:15:16.956 --> 00:15:18.556
So we've created our.

00:15:19.116 --> 00:15:21.516
We've created our database in Cloudflare,

00:15:21.916 --> 00:15:23.356
we've created those tables,

00:15:23.606 --> 00:15:26.846
but we also need to bind it to our actual worker

00:15:26.846 --> 00:15:27.126
here.

00:15:27.766 --> 00:15:30.166
So we're going to head over to the Wrangler JSON

00:15:30.166 --> 00:15:30.518
file

00:15:31.551 --> 00:15:33.471
and then what we're going to do is we're going to

00:15:33.471 --> 00:15:33.791
say

00:15:34.751 --> 00:15:36.031
A D1 databases

00:15:37.311 --> 00:15:38.271
and it's going to.

00:15:38.351 --> 00:15:39.711
We're going to pass in the binding,

00:15:39.711 --> 00:15:40.751
which is db,

00:15:41.391 --> 00:15:44.271
and then we're also going to want to pass in the,

00:15:44.895 --> 00:15:46.955
we're also going to want to pass in the actual

00:15:46.955 --> 00:15:48.515
database id so

00:15:49.115 --> 00:15:50.555
we can head back to Cloudflare,

00:15:50.875 --> 00:15:52.315
come to our database,

00:15:52.323 --> 00:15:53.295
copy that link,

00:15:58.456 --> 00:16:00.342
paste in this database id,

00:16:00.342 --> 00:16:02.479
and then lastly what we're going to do just to

00:16:02.479 --> 00:16:03.239
make this work,

00:16:03.519 --> 00:16:04.119
so we're actually

00:16:04.599 --> 00:16:06.119
sending data to the

00:16:06.819 --> 00:16:08.279
actual database and Cloudflare

00:16:08.589 --> 00:16:09.549
we're going to enable

00:16:09.869 --> 00:16:11.029
experimental remote.

00:16:11.029 --> 00:16:12.029
But before we do that,

00:16:12.349 --> 00:16:13.149
I'm actually going.

00:16:13.149 --> 00:16:14.389
I'm not going to enable this yet.

00:16:14.389 --> 00:16:15.989
I'm just going to show you what happens here.

00:16:15.989 --> 00:16:16.349
So

00:16:16.669 --> 00:16:18.389
now that we have this thing configured,

00:16:18.389 --> 00:16:19.669
let's kill that application,

00:16:19.669 --> 00:16:20.749
run pnpm,

00:16:23.629 --> 00:16:24.668
run CF

00:16:25.869 --> 00:16:26.589
type gen,

00:16:27.850 --> 00:16:29.174
that's going to create our types.

00:16:29.254 --> 00:16:31.414
So if we come over to this worker configuration,

00:16:31.414 --> 00:16:32.854
you can see that we now have this,

00:16:33.914 --> 00:16:35.114
this D1 database

00:16:35.434 --> 00:16:38.154
as part of our namespace for this Cloudflare

00:16:38.154 --> 00:16:38.474
environment.

00:16:39.354 --> 00:16:41.274
Now we can head back to our index file,

00:16:41.274 --> 00:16:42.696
so the entry point to our worker.

00:16:42.802 --> 00:16:44.914
And you can see that this is no longer throwing a

00:16:44.914 --> 00:16:45.474
type error.

00:16:45.474 --> 00:16:47.394
So we're able to successfully instantiate the

00:16:47.394 --> 00:16:47.914
database.

00:16:47.914 --> 00:16:49.794
So now if we run our application

00:16:50.534 --> 00:16:52.548
and we try to submit that query again,

00:16:52.548 --> 00:16:54.058
we should not get an error.

00:16:54.578 --> 00:16:55.778
But we're also not.

00:16:55.778 --> 00:16:57.578
It's not going to send the data to our actual

00:16:57.578 --> 00:16:58.178
database.

00:16:58.258 --> 00:16:58.658
So

00:16:58.978 --> 00:16:59.938
when this loads,

00:16:59.938 --> 00:17:01.618
I'll show you exactly what I mean here.

00:17:04.745 --> 00:17:05.065
Right,

00:17:05.065 --> 00:17:06.505
so we're going to say

00:17:08.345 --> 00:17:09.385
product one

00:17:09.785 --> 00:17:11.745
and then we're going to give it a destination and

00:17:11.745 --> 00:17:12.705
we're going to hit create link.

00:17:12.705 --> 00:17:13.945
It looks like we got another error.

00:17:13.945 --> 00:17:15.225
Let's just see if we can't quickly

00:17:15.975 --> 00:17:17.495
figure out what is happening here.

00:17:17.655 --> 00:17:17.914
So,

00:17:17.914 --> 00:17:18.454
all right,

00:17:18.454 --> 00:17:19.974
so if you notice that we have a.

00:17:19.974 --> 00:17:21.014
We have an error here.

00:17:21.094 --> 00:17:23.814
Now the reason we have an error here is because

00:17:24.054 --> 00:17:25.654
this is actually trying to

00:17:26.134 --> 00:17:27.894
insert data into a database

00:17:28.374 --> 00:17:29.094
locally.

00:17:29.174 --> 00:17:30.994
So when we run the

00:17:30.994 --> 00:17:32.634
when we run our dev script,

00:17:32.714 --> 00:17:35.194
what happens is it creates a.

00:17:35.834 --> 00:17:38.634
Basically it creates like a fake table or like a

00:17:38.634 --> 00:17:40.474
local table inside of state,

00:17:40.864 --> 00:17:44.064
instead of the rank wrangler folder state and into

00:17:44.064 --> 00:17:44.264
here.

00:17:44.264 --> 00:17:46.064
So you can see that this is actually going to be a

00:17:46.304 --> 00:17:47.584
SQLite file.

00:17:48.004 --> 00:17:49.164
so everything from the project,

00:17:49.164 --> 00:17:51.084
when running locally is actually going to try to

00:17:51.084 --> 00:17:52.804
source the data from this table.

00:17:52.804 --> 00:17:55.244
And the error that we get is basically saying our

00:17:55.244 --> 00:17:57.644
links table that we're inserting data into has not

00:17:57.644 --> 00:17:58.404
been Created.

00:17:58.724 --> 00:17:59.124
Now,

00:17:59.284 --> 00:18:01.804
we could technically run a command and create

00:18:01.804 --> 00:18:02.154
that,

00:18:02.154 --> 00:18:03.224
query in this,

00:18:03.224 --> 00:18:03.544
like,

00:18:03.624 --> 00:18:05.424
SQLite database that's running locally.

00:18:05.424 --> 00:18:06.864
But it's just really tedious.

00:18:06.864 --> 00:18:09.064
And now because Cloudflare has this feature,

00:18:09.154 --> 00:18:10.804
to run experimental remote,

00:18:11.894 --> 00:18:14.294
we can head back over to our Wrangler JSON file.

00:18:14.454 --> 00:18:16.694
We're going to specify that we want to run

00:18:16.694 --> 00:18:18.534
experimental remote as true.

00:18:19.094 --> 00:18:20.854
And then one thing to note,

00:18:20.854 --> 00:18:23.184
it's actually not crazy clear from the docs as of

00:18:23.184 --> 00:18:23.464
today.

00:18:23.784 --> 00:18:26.504
If you go over to your vite config,

00:18:27.704 --> 00:18:28.641
which is over here,

00:18:28.641 --> 00:18:31.206
you can see that we have our Cloudflare vite

00:18:31.206 --> 00:18:31.766
plugin.

00:18:32.086 --> 00:18:34.326
We're also going to want to come into here

00:18:34.806 --> 00:18:37.526
and we're going to want to say experimental

00:18:39.268 --> 00:18:42.148
and it's going to be remote bindings is true.

00:18:42.228 --> 00:18:43.828
So basically this is the same type of

00:18:43.828 --> 00:18:44.348
configuration.

00:18:44.348 --> 00:18:46.948
This just tells our Cloudflare vite config that

00:18:46.948 --> 00:18:47.748
that is the case.

00:18:47.908 --> 00:18:50.068
So now what I need to do is I need to.

00:18:50.468 --> 00:18:51.748
I'm going to run a Wrangler

00:18:53.117 --> 00:18:53.837
logout.

00:18:53.997 --> 00:18:55.957
The only reason I'm doing this is because I have

00:18:55.957 --> 00:18:57.517
other Cloudflare accounts that

00:18:58.077 --> 00:18:58.137
I'm,

00:18:58.297 --> 00:18:58.737
connected to.

00:18:58.737 --> 00:19:00.137
I want to make sure I'm connected to the right

00:19:00.137 --> 00:19:00.417
one.

00:19:00.417 --> 00:19:02.537
You probably don't have to run Wrangler logout.

00:19:02.537 --> 00:19:05.297
And then I'm going to say pnpm run dev.

00:19:05.837 --> 00:19:07.757
This is going to start up our application again.

00:19:08.057 --> 00:19:09.897
and then what it did is it actually.

00:19:11.977 --> 00:19:13.724
It actually opened up a new tab.

00:19:13.724 --> 00:19:15.434
And I think we've gone through this process once

00:19:15.434 --> 00:19:16.034
before already,

00:19:16.114 --> 00:19:18.514
but essentially it's asking if we have permission

00:19:18.514 --> 00:19:18.834
to.

00:19:18.834 --> 00:19:19.434
Or if it.

00:19:19.434 --> 00:19:19.874
If it.

00:19:19.874 --> 00:19:22.154
If we'll grant it permission to connect to that D1

00:19:22.154 --> 00:19:22.594
database.

00:19:22.594 --> 00:19:25.234
Because we're running in the experimental remote

00:19:25.394 --> 00:19:26.714
with experimental remote.

00:19:26.714 --> 00:19:27.074
True.

00:19:27.154 --> 00:19:28.528
So we're going to go ahead and allow that.

00:19:28.678 --> 00:19:30.678
So now we should come back over here and you

00:19:30.678 --> 00:19:31.038
should be.

00:19:31.038 --> 00:19:32.558
We can see that this is actually running

00:19:32.558 --> 00:19:33.070
successfully.

00:19:33.188 --> 00:19:34.536
So one last try here.

00:19:34.611 --> 00:19:36.691
another thing to note is when you run

00:19:37.011 --> 00:19:38.011
experimental dev,

00:19:38.011 --> 00:19:38.691
as of today,

00:19:39.171 --> 00:19:41.171
it takes a minute for it to actually,

00:19:41.251 --> 00:19:41.610
like,

00:19:41.610 --> 00:19:43.931
set up and make the connections and connect and

00:19:43.931 --> 00:19:45.531
authenticate with Cloudflare server.

00:19:45.531 --> 00:19:47.171
So your loading page,

00:19:47.171 --> 00:19:47.891
you're going to notice,

00:19:47.891 --> 00:19:50.091
is actually a little bit longer than what it would

00:19:50.091 --> 00:19:50.931
be if you deployed,

00:19:50.931 --> 00:19:51.131
like,

00:19:51.131 --> 00:19:52.611
if you were to deploy this application.

00:19:52.611 --> 00:19:52.861
The.

00:19:52.931 --> 00:19:54.411
The loading is insanely snappy.

00:19:54.411 --> 00:19:54.771
So,

00:19:55.011 --> 00:19:55.531
okay,

00:19:55.531 --> 00:19:57.651
so we're going to say product one

00:19:59.686 --> 00:20:01.135
and then we're going to give it some random link

00:20:01.135 --> 00:20:02.535
and we're going to say create link.

00:20:02.935 --> 00:20:04.735
And you can see that actually went through

00:20:04.735 --> 00:20:05.575
successfully.

00:20:05.655 --> 00:20:07.495
And if we Head back over to our

00:20:08.055 --> 00:20:11.015
SQL D1 database and we go to explore data.

00:20:11.175 --> 00:20:12.055
We can say

00:20:12.455 --> 00:20:14.535
select star from links

00:20:15.306 --> 00:20:16.915
and you can see that we actually have data in

00:20:16.915 --> 00:20:17.355
there now.

00:20:17.795 --> 00:20:19.635
So at this point what we've done is we've

00:20:19.635 --> 00:20:20.435
successfully

00:20:21.045 --> 00:20:24.405
we've successfully created a query in our packages

00:20:24.675 --> 00:20:26.065
in our data ops package

00:20:27.762 --> 00:20:29.354
that we've exported called Create Link,

00:20:29.434 --> 00:20:30.874
which takes in some link data,

00:20:31.274 --> 00:20:33.035
inserts the data into our database.

00:20:33.215 --> 00:20:34.485
we've then exported this,

00:20:34.805 --> 00:20:36.645
we've exported this from our package.

00:20:36.965 --> 00:20:39.885
We've used the package inside of our actual user

00:20:39.885 --> 00:20:40.485
application,

00:20:40.485 --> 00:20:41.605
our REACT application.

00:20:42.495 --> 00:20:44.395
We've wired it into a TRPC method

00:20:44.395 --> 00:20:45.646
and we have put in

00:20:45.776 --> 00:20:47.486
and we've instantiated our database.

00:20:47.566 --> 00:20:50.046
That way our database is able to

00:20:50.896 --> 00:20:52.576
be accessed within our queries.

00:20:52.576 --> 00:20:54.736
So inside of these queries we're able to get the

00:20:54.736 --> 00:20:56.575
database and then write queries.

00:20:56.576 --> 00:20:58.776
Now this is really nice because in our application

00:20:58.776 --> 00:20:59.856
code it's very,

00:20:59.856 --> 00:21:00.576
very simple.

00:21:00.586 --> 00:21:03.016
all we have to do is we have to implement

00:21:03.203 --> 00:21:05.693
we just basically like use the method that we've

00:21:05.693 --> 00:21:07.893
exported from our package and then we interface

00:21:07.893 --> 00:21:08.773
with data that way.

00:21:08.773 --> 00:21:10.573
So what you're going to notice is this is a

00:21:10.953 --> 00:21:12.233
very scalable way of

00:21:12.303 --> 00:21:13.913
this is a very scalable way of

00:21:15.953 --> 00:21:18.113
building a project just because it kind of like,

00:21:18.113 --> 00:21:20.433
it makes your code very modular and it makes it so

00:21:20.433 --> 00:21:21.353
you can reuse things.

00:21:21.353 --> 00:21:23.513
And it's really easy to know like okay,

00:21:23.513 --> 00:21:24.593
I have a schema,

00:21:24.593 --> 00:21:26.273
it's going to be in a schemas package.

00:21:26.353 --> 00:21:27.153
I have a,

00:21:27.153 --> 00:21:28.593
like a Zod schema is going to be a schema's

00:21:28.593 --> 00:21:28.793
package.

00:21:28.793 --> 00:21:30.753
If I have a query it's going to be in a queries

00:21:30.753 --> 00:21:31.473
package and then

00:21:31.743 --> 00:21:33.733
you can kind of like mentally keep track of what's

00:21:33.733 --> 00:21:34.773
going on a lot easier.

00:21:34.933 --> 00:21:35.853
One note here,

00:21:35.853 --> 00:21:36.933
there's an actual bug

00:21:37.263 --> 00:21:38.463
is this Create link.

00:21:38.703 --> 00:21:40.063
It returns an id.

00:21:40.303 --> 00:21:41.423
So we're going to say const

00:21:42.190 --> 00:21:43.070
link id

00:21:44.583 --> 00:21:47.223
then we are going to return that link id

00:21:47.581 --> 00:21:48.507
because if we look here,

00:21:48.667 --> 00:21:50.987
it actually probably navigated over to

00:21:51.307 --> 00:21:52.187
random id,

00:21:52.187 --> 00:21:54.347
which is not the behavior that we want.

00:21:55.147 --> 00:21:57.547
We want to be able to basically say create.

00:21:58.907 --> 00:22:00.867
We want to be able to create that link and then it

00:22:00.867 --> 00:22:03.281
will navigate to the link ID that was created.

00:22:03.549 --> 00:22:05.549
So Optimistic Parrot Random name,

00:22:05.709 --> 00:22:07.309
it's going to go to this URL.

00:22:07.309 --> 00:22:08.029
We hit create

00:22:08.349 --> 00:22:10.149
and then what you see here is it actually

00:22:10.149 --> 00:22:12.079
navigates to this link that is a random

00:22:12.299 --> 00:22:13.099
nano id.

00:22:13.899 --> 00:22:14.339
So yeah,

00:22:14.339 --> 00:22:16.059
I think that this was a really good section.

00:22:16.059 --> 00:22:17.699
And then in this next section we're going to start

00:22:17.699 --> 00:22:19.379
building out a whole bunch of other queries just

00:22:19.379 --> 00:22:19.859
to kind of,

00:22:19.859 --> 00:22:20.139
like,

00:22:20.299 --> 00:22:22.259
build this habit and build this pattern so we can

00:22:22.259 --> 00:22:23.246
solidify the skill.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.034 --> 00:00:00.274
All right,

00:00:00.274 --> 00:00:01.994
so now that we've gone through the process of

00:00:01.994 --> 00:00:03.714
building these links within our,

00:00:03.714 --> 00:00:06.194
within a package in our Monorepo and then wiring

00:00:06.194 --> 00:00:07.874
them into our TRPC routes,

00:00:08.114 --> 00:00:10.234
let's go through the process of finishing off all

00:00:10.234 --> 00:00:12.634
of the CRUD operations before we move into the

00:00:12.634 --> 00:00:14.034
more sophisticated and

00:00:14.484 --> 00:00:15.674
complex things with this project.

00:00:15.914 --> 00:00:17.434
So if you look here,

00:00:17.434 --> 00:00:19.714
we have our Create link function that we just

00:00:19.714 --> 00:00:20.234
created.

00:00:20.674 --> 00:00:20.934
we,

00:00:21.004 --> 00:00:22.524
we also have this links

00:00:22.844 --> 00:00:24.884
data table where all the links that have been

00:00:24.884 --> 00:00:25.964
created will show up here.

00:00:26.044 --> 00:00:27.604
you'll be able to see the actual link,

00:00:28.304 --> 00:00:31.064
that you can use as like the short link and then

00:00:31.064 --> 00:00:31.904
you can copy it,

00:00:32.064 --> 00:00:34.384
but you can also click on that link and you'll go

00:00:34.384 --> 00:00:35.264
to the link page.

00:00:35.344 --> 00:00:37.424
Now this link page also has a bunch of CRUD

00:00:37.424 --> 00:00:37.864
operations.

00:00:37.864 --> 00:00:38.784
Like you're able to

00:00:39.364 --> 00:00:40.064
edit the name,

00:00:40.144 --> 00:00:41.453
so you can put in a new name,

00:00:41.692 --> 00:00:44.205
you can edit the default destination URL.

00:00:44.285 --> 00:00:46.005
So if you're going to change where this is going

00:00:46.005 --> 00:00:46.765
to be routed,

00:00:47.175 --> 00:00:49.095
and then you can additionally you can

00:00:49.165 --> 00:00:51.415
enable or disable GEO routing.

00:00:51.415 --> 00:00:53.055
So if you want to

00:00:53.495 --> 00:00:55.335
say like everybody in

00:00:55.521 --> 00:00:56.401
Albania

00:00:56.721 --> 00:00:58.871
is going to be routed to a separate link,

00:00:58.871 --> 00:00:59.941
that's going to be controlled here,

00:00:59.941 --> 00:01:02.261
but you could also turn off GEO routing for

00:01:02.741 --> 00:01:03.901
a given link.

00:01:03.901 --> 00:01:04.981
So that's the,

00:01:05.141 --> 00:01:06.861
these are kind of like the CRUD operations that

00:01:06.861 --> 00:01:08.181
are going to power the application.

00:01:08.181 --> 00:01:09.621
And then once we have these done,

00:01:09.861 --> 00:01:10.121
we,

00:01:10.191 --> 00:01:11.791
we'll be able to actually get some data in the

00:01:11.791 --> 00:01:13.431
database and then we're going to be able to build

00:01:13.431 --> 00:01:15.271
out a backend system on top of it.

00:01:15.271 --> 00:01:16.671
And that's like the really fun part.

00:01:16.671 --> 00:01:18.031
So let's go ahead and do that.

00:01:18.031 --> 00:01:19.711
The first thing that I want to do is I want to

00:01:20.031 --> 00:01:22.871
create like have real live data show up in this

00:01:22.871 --> 00:01:23.551
data table.

00:01:23.791 --> 00:01:26.111
So if we head back over to our package,

00:01:26.831 --> 00:01:28.951
what we want to do is we're going to want to

00:01:28.951 --> 00:01:30.511
create a new query.

00:01:30.511 --> 00:01:32.031
And this query is going to be called

00:01:32.351 --> 00:01:33.231
Get Links.

00:01:33.231 --> 00:01:34.351
And for the sake of time,

00:01:34.351 --> 00:01:36.271
because this is quite a bit to type,

00:01:36.731 --> 00:01:37.851
just going to paste it in here

00:01:38.811 --> 00:01:40.291
and then we'll just kind of walk through what

00:01:40.291 --> 00:01:40.731
we're doing.

00:01:40.811 --> 00:01:41.211
So,

00:01:42.421 --> 00:01:44.036
make sure all these guys are imported

00:01:44.036 --> 00:01:44.766
greater than that.

00:01:47.525 --> 00:01:49.486
So essentially what this query is going to do and

00:01:49.486 --> 00:01:51.366
we're not going to like have to talk about every

00:01:51.366 --> 00:01:52.566
single query in this detail,

00:01:52.566 --> 00:01:54.086
but I just kind of want to show you how

00:01:54.406 --> 00:01:54.806
these

00:01:54.826 --> 00:01:56.366
these query abstractions,

00:01:56.366 --> 00:01:57.486
where you put it behind a method,

00:01:57.486 --> 00:01:58.766
how they can be really powerful.

00:01:58.766 --> 00:02:00.246
So essentially what we're doing is we're Doing

00:02:00.246 --> 00:02:01.726
that same convention where we have

00:02:02.506 --> 00:02:04.466
an account ID because we want to just see all the

00:02:04.466 --> 00:02:05.626
links for a given account

00:02:05.693 --> 00:02:06.676
and then we're going to have some,

00:02:06.676 --> 00:02:09.076
an optional property which is created before.

00:02:09.076 --> 00:02:10.876
And what this is going to do is if somebody has

00:02:10.876 --> 00:02:11.956
like thousands of links,

00:02:11.956 --> 00:02:14.236
we'll be able to implement pagination where we can

00:02:14.236 --> 00:02:14.916
basically say

00:02:15.236 --> 00:02:18.436
show us like 15 links created before this date and

00:02:18.436 --> 00:02:20.396
then we get that last date and then we say create

00:02:20.396 --> 00:02:21.436
it before this date.

00:02:21.436 --> 00:02:23.076
so this is a very simple way of implementing

00:02:23.156 --> 00:02:25.236
pagination where you have a limit number

00:02:25.796 --> 00:02:27.156
and you also have a

00:02:28.026 --> 00:02:28.666
created before.

00:02:28.986 --> 00:02:30.746
Now what we do is we basically have these

00:02:30.746 --> 00:02:31.226
conditions.

00:02:31.546 --> 00:02:34.266
So these are going to be the filters of the query

00:02:34.586 --> 00:02:35.866
and we're going to have a default.

00:02:35.866 --> 00:02:37.946
So we're always going to filter by account ID

00:02:38.426 --> 00:02:39.146
and then

00:02:40.026 --> 00:02:41.586
if created before is defined,

00:02:41.586 --> 00:02:43.066
we're going to go ahead and push in

00:02:43.466 --> 00:02:44.826
a greater than query.

00:02:44.826 --> 00:02:45.746
So what this is saying is,

00:02:45.746 --> 00:02:48.106
this is saying on the column created,

00:02:48.106 --> 00:02:50.186
which is like the created time of that link,

00:02:51.806 --> 00:02:53.326
show us anything that's greater than the

00:02:53.366 --> 00:02:54.546
created before date.

00:02:55.106 --> 00:02:57.266
And then just a very simple select.

00:02:57.266 --> 00:02:59.026
So we're going to select link id,

00:02:59.346 --> 00:03:01.026
the destinations array,

00:03:01.486 --> 00:03:03.736
or destinations object or JSON object,

00:03:04.283 --> 00:03:05.323
the created time

00:03:05.963 --> 00:03:06.923
and the link name.

00:03:07.163 --> 00:03:09.563
This is going to be coming from links

00:03:09.963 --> 00:03:10.363
where

00:03:10.683 --> 00:03:11.483
our conditions

00:03:11.963 --> 00:03:13.963
Account ID is of that account ID

00:03:13.996 --> 00:03:16.064
and is before that created date.

00:03:16.104 --> 00:03:18.464
And then we're going to order that by create a

00:03:18.464 --> 00:03:19.300
date so it's sorted.

00:03:19.300 --> 00:03:21.938
And then we are going to say limit 25.

00:03:22.018 --> 00:03:22.398
So

00:03:22.398 --> 00:03:23.938
it'll always only return 25.

00:03:23.938 --> 00:03:25.098
And this is going to power that.

00:03:25.098 --> 00:03:25.358
This

00:03:25.918 --> 00:03:27.188
this data table right here.

00:03:27.559 --> 00:03:28.318
So remember,

00:03:28.318 --> 00:03:30.359
every single time we add a new query in here,

00:03:30.679 --> 00:03:33.239
we're going to want to make sure we are in our

00:03:33.399 --> 00:03:34.439
data ops

00:03:35.159 --> 00:03:35.639
package.

00:03:35.639 --> 00:03:36.919
So I'm going to say packages

00:03:39.169 --> 00:03:41.649
data ops and then I'm going to say pnpm

00:03:42.049 --> 00:03:42.449
run

00:03:43.009 --> 00:03:43.409
build.

00:03:44.209 --> 00:03:45.329
It's going to build the project,

00:03:45.489 --> 00:03:46.689
it will dump

00:03:47.169 --> 00:03:49.569
get links into that disk folder and then we'll be

00:03:49.569 --> 00:03:51.409
able to use it in our other application.

00:03:51.489 --> 00:03:53.409
So now what we're going to want to do is we're

00:03:53.409 --> 00:03:55.249
going to head over to our user application,

00:03:56.239 --> 00:03:59.079
and then I think it might be best if we kind of

00:03:59.079 --> 00:04:01.199
worked from the UI to the backend.

00:04:01.279 --> 00:04:03.359
So if we come over to our source

00:04:03.959 --> 00:04:04.759
and we go to Routes,

00:04:04.759 --> 00:04:07.079
so in our front end we go to Routes app

00:04:07.639 --> 00:04:08.039
auth,

00:04:08.199 --> 00:04:11.079
then we're going to head over to our links.

00:04:11.479 --> 00:04:12.774
this is our links page.

00:04:12.774 --> 00:04:13.759
Now this links page

00:04:13.759 --> 00:04:14.639
has a loader,

00:04:15.029 --> 00:04:17.419
that pre fetches Data from the links list,

00:04:17.419 --> 00:04:19.199
which is basically this data right here.

00:04:19.199 --> 00:04:20.674
And what we can do is basically.

00:04:20.674 --> 00:04:21.154
So it's,

00:04:21.154 --> 00:04:22.354
what it's doing is it's pace,

00:04:22.354 --> 00:04:22.674
it's,

00:04:22.674 --> 00:04:22.944
it's

00:04:23.674 --> 00:04:24.794
it's passing in the data,

00:04:24.794 --> 00:04:26.474
it's grabbing data from that links list

00:04:26.794 --> 00:04:28.154
and it's not passing any

00:04:28.474 --> 00:04:29.334
input because

00:04:29.391 --> 00:04:29.706
the

00:04:30.026 --> 00:04:32.506
only input that's needed is the created before

00:04:32.586 --> 00:04:32.986
time.

00:04:33.146 --> 00:04:35.586
And for the very first load of the page we

00:04:35.586 --> 00:04:37.386
actually don't need to grab that created before

00:04:37.546 --> 00:04:38.586
because it's just going to

00:04:38.906 --> 00:04:41.331
grab like the 25 most recent links.

00:04:41.331 --> 00:04:43.091
so if we come over here you can see that we're

00:04:43.091 --> 00:04:44.171
using the suspense query.

00:04:44.171 --> 00:04:46.251
So this is where we actually access that data in

00:04:46.251 --> 00:04:47.143
our root component.

00:04:47.143 --> 00:04:47.436
And

00:04:47.946 --> 00:04:49.946
we can see exactly where this links is used.

00:04:50.266 --> 00:04:51.626
So I'm just going to say

00:04:51.866 --> 00:04:52.766
links dot

00:04:53.166 --> 00:04:53.470
so

00:04:54.066 --> 00:04:54.294
so

00:04:54.294 --> 00:04:56.606
so basically so we're getting this links data and

00:04:56.606 --> 00:04:59.286
then throw down here a little bit deeper into our

00:04:59.286 --> 00:04:59.646
code.

00:04:59.646 --> 00:05:01.606
We're going to notice that we actually have this

00:05:01.606 --> 00:05:01.952
table

00:05:02.004 --> 00:05:04.084
and this table is going to

00:05:04.384 --> 00:05:05.244
this table has like.

00:05:05.244 --> 00:05:06.524
So this is a tan stack table.

00:05:06.524 --> 00:05:07.964
We're not going to dive too deep into this.

00:05:07.964 --> 00:05:10.364
But if you're building really complicated tables

00:05:10.364 --> 00:05:12.324
where you have like a bunch of features you want

00:05:12.324 --> 00:05:13.084
to be able to sort,

00:05:13.084 --> 00:05:13.924
move stuff around,

00:05:14.504 --> 00:05:16.144
just have a bunch of like functionality right out

00:05:16.144 --> 00:05:16.744
of the box.

00:05:16.744 --> 00:05:18.584
Tan stack table is,

00:05:18.584 --> 00:05:21.264
or tanstack react table is an insanely good

00:05:21.364 --> 00:05:22.144
package to you.

00:05:22.144 --> 00:05:24.344
So we're not going to get super deep into it.

00:05:24.344 --> 00:05:27.024
But just know like we can define some columns,

00:05:27.404 --> 00:05:28.884
can style those columns,

00:05:28.884 --> 00:05:29.724
we can give like,

00:05:29.724 --> 00:05:30.964
we can put buttons in there.

00:05:31.124 --> 00:05:33.624
this is a specific one where it has like a copy

00:05:33.624 --> 00:05:35.504
button and when you copy it it copies it to the

00:05:35.504 --> 00:05:35.984
clipboard.

00:05:35.984 --> 00:05:37.584
So it's really cool what we can do here.

00:05:37.584 --> 00:05:39.904
but what happens is we go further down and we

00:05:39.904 --> 00:05:41.897
basically say that the data is the links

00:05:41.919 --> 00:05:42.319
and

00:05:42.919 --> 00:05:44.519
this is going to wire into

00:05:45.078 --> 00:05:46.359
this is going to get table,

00:05:46.439 --> 00:05:48.439
get the rows and it's basically going to start

00:05:48.439 --> 00:05:50.479
iterating and creating the

00:05:50.479 --> 00:05:51.779
the table for us here.

00:05:51.779 --> 00:05:53.219
So that's what's going on.

00:05:53.219 --> 00:05:55.459
So essentially what we need to do is we need to

00:05:55.459 --> 00:05:58.019
populate or actually like wire in the query that

00:05:58.019 --> 00:05:59.219
we just created on our back.

00:06:00.219 --> 00:06:01.099
this linked list,

00:06:01.549 --> 00:06:02.829
linked list method.

00:06:02.829 --> 00:06:05.469
So we can command click on that and it's going to

00:06:05.469 --> 00:06:07.389
take us over to worker TRPC routes,

00:06:07.469 --> 00:06:08.149
links.

00:06:08.149 --> 00:06:10.169
you could also navigate on the left sidebar if

00:06:10.169 --> 00:06:11.129
that's what you like to do.

00:06:11.369 --> 00:06:12.649
So you can see that this

00:06:12.899 --> 00:06:14.691
that this specific procedure

00:06:14.691 --> 00:06:15.845
takes in a

00:06:16.055 --> 00:06:19.065
optional offset which is a number which is

00:06:19.065 --> 00:06:20.025
actually just that date,

00:06:20.025 --> 00:06:20.345
time,

00:06:21.465 --> 00:06:22.025
and then

00:06:22.425 --> 00:06:23.545
it is going to

00:06:23.837 --> 00:06:25.677
And then what it's going to do is it's going to

00:06:25.997 --> 00:06:28.397
return this dummy data which is just this big

00:06:28.397 --> 00:06:28.957
stupid

00:06:28.987 --> 00:06:30.127
dummy array of

00:06:30.847 --> 00:06:31.205
just

00:06:31.205 --> 00:06:33.016
random like links and dummy data.

00:06:33.096 --> 00:06:35.576
So I'm going to go ahead and I'm going to delete

00:06:35.816 --> 00:06:36.776
all this stuff

00:06:36.958 --> 00:06:37.772
head back over here.

00:06:37.772 --> 00:06:39.144
We should be getting a type error

00:06:39.227 --> 00:06:39.627
and

00:06:39.757 --> 00:06:41.327
what I'm going to do is I'm going to basically say

00:06:41.327 --> 00:06:41.616
like

00:06:42.728 --> 00:06:43.208
await.

00:06:44.248 --> 00:06:46.408
Get links is the method that we defined

00:06:47.368 --> 00:06:49.928
and this should be coming from our queries over

00:06:49.928 --> 00:06:52.208
here so we can head over to our.

00:06:52.208 --> 00:06:54.248
I'm going to first delete this links list

00:06:54.661 --> 00:06:56.822
and then I am going to say

00:06:57.782 --> 00:06:58.182
get

00:06:59.342 --> 00:07:00.622
get links.

00:07:00.862 --> 00:07:01.262
So

00:07:02.246 --> 00:07:02.606
All right,

00:07:02.606 --> 00:07:05.366
so now that we have this get links method that

00:07:05.366 --> 00:07:06.726
we've defined in our package,

00:07:06.886 --> 00:07:06.976
or

00:07:06.976 --> 00:07:08.286
in our Data Ops package,

00:07:08.286 --> 00:07:09.966
now that we have this imported,

00:07:10.206 --> 00:07:12.366
we can come over here and then what we're going to

00:07:12.366 --> 00:07:13.965
see is this is going to take in,

00:07:14.112 --> 00:07:16.170
this is going to take in an account ID and a

00:07:16.170 --> 00:07:17.250
created before time.

00:07:17.410 --> 00:07:17.577
So

00:07:17.577 --> 00:07:19.121
what we are going to want to do is we're going to

00:07:19.121 --> 00:07:19.761
want to say,

00:07:19.811 --> 00:07:21.161
we're going to grab context.

00:07:21.161 --> 00:07:22.681
We're also going to grab input

00:07:23.301 --> 00:07:26.981
inside of our query for our tenants for our TRPC

00:07:27.061 --> 00:07:27.541
query.

00:07:27.781 --> 00:07:28.581
And then the

00:07:28.901 --> 00:07:32.381
the account ID for our use case is going to be the

00:07:32.381 --> 00:07:33.781
user info.id.

00:07:33.781 --> 00:07:34.821
now this is dummy data.

00:07:34.821 --> 00:07:36.581
Right now we're going to get deeper into this in

00:07:36.581 --> 00:07:37.421
the off section.

00:07:37.421 --> 00:07:38.821
So for the sake of

00:07:38.851 --> 00:07:39.981
this part of the course,

00:07:39.981 --> 00:07:40.821
just like no,

00:07:40.981 --> 00:07:42.701
you're going to understand where this is coming

00:07:42.701 --> 00:07:44.080
from and why at a later time.

00:07:44.324 --> 00:07:46.114
And then we're also going to pass in the

00:07:46.874 --> 00:07:48.474
input which we have the,

00:07:48.714 --> 00:07:49.794
the optional offset.

00:07:49.794 --> 00:07:51.624
And we're calling this offset because this is

00:07:51.771 --> 00:07:54.391
because this is meant to be the actual like date

00:07:54.391 --> 00:07:56.151
time that's going to be passed when we add

00:07:56.151 --> 00:07:56.714
pagination.

00:07:58.947 --> 00:07:59.347
And

00:07:59.747 --> 00:08:01.667
the only thing that we have to do here is because

00:08:01.667 --> 00:08:02.787
this is going to be a number,

00:08:02.787 --> 00:08:04.987
is we just need to make sure we cast that guy to a

00:08:04.987 --> 00:08:05.307
string.

00:08:05.307 --> 00:08:05.517
So

00:08:06.387 --> 00:08:06.707
okay,

00:08:06.707 --> 00:08:09.827
so from here we have our input offset to string.

00:08:09.827 --> 00:08:12.147
So we're able to basically say whenever this

00:08:12.407 --> 00:08:14.187
whenever this procedure gets called with

00:08:14.667 --> 00:08:15.067
the,

00:08:15.067 --> 00:08:16.587
with the before date specified,

00:08:17.147 --> 00:08:18.987
it'll be picked up here and if not

00:08:19.387 --> 00:08:20.827
undefined will be passed in.

00:08:20.907 --> 00:08:23.227
So now we're successfully able to call this

00:08:23.307 --> 00:08:23.847
endpoint.

00:08:23.847 --> 00:08:25.687
And then what we should see is when we run our

00:08:25.687 --> 00:08:26.527
user application

00:08:29.010 --> 00:08:30.450
and we head back over here

00:08:31.090 --> 00:08:32.770
when this links page loads,

00:08:33.170 --> 00:08:34.650
if we did everything correctly,

00:08:34.650 --> 00:08:36.330
we should see that this table is going to be

00:08:36.330 --> 00:08:39.170
populated with that one link that we have created.

00:08:39.330 --> 00:08:41.370
So the loading is going to take a little bit.

00:08:41.370 --> 00:08:41.730
And this,

00:08:41.730 --> 00:08:43.610
this is just because we're using the experimental

00:08:43.610 --> 00:08:44.240
dev mode.

00:08:44.449 --> 00:08:46.290
I do suspect that this will get faster as

00:08:46.290 --> 00:08:48.610
Cloudflare builds out this feature a little bit.

00:08:48.690 --> 00:08:50.330
So you can see here's the two links that we've

00:08:50.330 --> 00:08:50.650
created.

00:08:50.650 --> 00:08:52.730
We've created Optimistic Parrot and Product one.

00:08:52.730 --> 00:08:54.450
And if we go through this process and we say

00:08:55.480 --> 00:08:55.720
Product

00:08:56.120 --> 00:08:56.520
three

00:08:57.080 --> 00:08:59.440
and then we just give it another random link and

00:08:59.440 --> 00:09:01.600
we hit create when we head back over to that

00:09:01.600 --> 00:09:01.880
links.

00:09:01.880 --> 00:09:03.680
Now you can see we have three here and we can

00:09:03.680 --> 00:09:04.280
click on it.

00:09:04.620 --> 00:09:06.460
and the data that's actually under this page is

00:09:06.460 --> 00:09:07.540
still just dummy data,

00:09:07.940 --> 00:09:08.740
but now what,

00:09:08.740 --> 00:09:10.980
we've successfully populated this data table.

00:09:11.300 --> 00:09:12.740
So let's actually go through the process

00:09:13.060 --> 00:09:15.780
of building out all of the CRUD operations here.

00:09:15.940 --> 00:09:16.330
and this,

00:09:16.330 --> 00:09:17.330
we're going to go through this really,

00:09:17.330 --> 00:09:18.850
really quickly just for the purpose of time

00:09:18.850 --> 00:09:19.730
because I don't really,

00:09:19.730 --> 00:09:21.110
I don't think it really matters to

00:09:21.190 --> 00:09:23.110
like solidify this like

00:09:23.820 --> 00:09:24.540
UI setup.

00:09:24.540 --> 00:09:26.780
I really want to get to the actual data operations

00:09:26.780 --> 00:09:28.260
on the back end because that's where our learning

00:09:28.260 --> 00:09:29.500
is just going to accelerate.

00:09:30.780 --> 00:09:31.340
Okay,

00:09:31.340 --> 00:09:34.220
so if we head back over to our data Ops package

00:09:34.220 --> 00:09:35.500
and we go to these queries,

00:09:35.500 --> 00:09:37.060
I'm just going to dump a bunch of other queries

00:09:37.060 --> 00:09:38.540
that we're going to need right now.

00:09:38.700 --> 00:09:39.100
So

00:09:39.500 --> 00:09:42.580
we're going to want to have a query that updates

00:09:42.580 --> 00:09:43.500
the link name.

00:09:43.740 --> 00:09:45.580
So this is getting the database,

00:09:45.660 --> 00:09:47.980
it's going to the links table and it's going to

00:09:47.980 --> 00:09:50.780
update the name and the updated time where their

00:09:50.860 --> 00:09:52.312
link ID equals link id.

00:09:52.355 --> 00:09:53.635
We're also going to

00:09:54.348 --> 00:09:55.988
we're also going to create a method called Get

00:09:55.988 --> 00:09:58.788
Link and this is going to basically give us like

00:09:58.788 --> 00:10:00.828
that basic link information on this page,

00:10:01.258 --> 00:10:02.538
right when the page loads.

00:10:02.538 --> 00:10:04.818
So like the name and destination URLs and all that

00:10:04.818 --> 00:10:05.418
fun stuff.

00:10:05.498 --> 00:10:05.898
So

00:10:06.813 --> 00:10:09.093
so what we have here is basically like we're just

00:10:09.093 --> 00:10:10.813
selecting that whole row,

00:10:11.443 --> 00:10:12.213
based upon

00:10:12.693 --> 00:10:13.093
a

00:10:13.503 --> 00:10:14.393
given link id.

00:10:14.713 --> 00:10:16.833
And it looks like we're using a schema here as

00:10:16.833 --> 00:10:17.113
well.

00:10:17.113 --> 00:10:18.873
So we're going to import this from that

00:10:19.263 --> 00:10:22.143
zodlink schema and you can see that this is our

00:10:22.303 --> 00:10:24.703
schema for an actual link.

00:10:24.863 --> 00:10:25.823
So link id,

00:10:25.823 --> 00:10:26.623
Account ID name,

00:10:26.623 --> 00:10:27.303
destinations,

00:10:27.303 --> 00:10:27.943
Create and update.

00:10:27.943 --> 00:10:29.423
It's a pretty simple schema here.

00:10:29.463 --> 00:10:30.023
so we're gonna,

00:10:30.023 --> 00:10:30.789
we can save that,

00:10:30.789 --> 00:10:31.797
head back over here.

00:10:32.337 --> 00:10:34.617
we're also going to want to update the link

00:10:34.617 --> 00:10:35.097
destination.

00:10:35.417 --> 00:10:35.817
So

00:10:36.117 --> 00:10:38.217
the default destination of where the link is

00:10:38.217 --> 00:10:38.817
routed to,

00:10:39.217 --> 00:10:40.417
which is going to be this one.

00:10:40.417 --> 00:10:41.777
And then any additional

00:10:42.377 --> 00:10:43.977
like geo routing that we,

00:10:44.367 --> 00:10:46.287
a Nate what that we configure at a link level.

00:10:46.447 --> 00:10:47.817
It's also going to be powered

00:10:47.817 --> 00:10:48.047
by,

00:10:48.047 --> 00:10:49.087
by this call.

00:10:49.247 --> 00:10:50.847
So we can create another,

00:10:52.207 --> 00:10:53.167
we can create another

00:10:54.047 --> 00:10:56.127
another function here called Update link

00:10:56.127 --> 00:10:58.447
destinations and then we will

00:11:00.045 --> 00:11:01.165
import this type.

00:11:01.245 --> 00:11:02.725
So the destinations type.

00:11:02.725 --> 00:11:05.165
If you look here it's going to be this object and

00:11:05.165 --> 00:11:06.045
this is kind of an actual,

00:11:06.045 --> 00:11:06.925
this is actually a

00:11:08.125 --> 00:11:09.605
You might look at this and think this is kind of a

00:11:09.605 --> 00:11:10.405
complicated type.

00:11:10.405 --> 00:11:10.765
But

00:11:11.165 --> 00:11:13.965
what essentially what we have here is we have a

00:11:14.265 --> 00:11:16.325
ZOD object that takes in

00:11:17.265 --> 00:11:20.305
a key of default and this is the default URL

00:11:20.705 --> 00:11:21.345
and then

00:11:21.825 --> 00:11:24.545
it can have any other key value pair and the key

00:11:24.545 --> 00:11:27.225
value pairs is basically a country ID and a

00:11:27.225 --> 00:11:28.385
destination URL.

00:11:28.545 --> 00:11:28.945
So

00:11:29.135 --> 00:11:30.865
it's like kind of this interesting type that we've

00:11:30.865 --> 00:11:32.545
defined so we always know we can call

00:11:32.545 --> 00:11:35.905
object.default to have a default URL and then

00:11:36.455 --> 00:11:37.835
any other key in there is essentially,

00:11:37.905 --> 00:11:40.295
essentially going to be like a location based

00:11:40.295 --> 00:11:41.475
routing configuration.

00:11:42.188 --> 00:11:42.674
All right,

00:11:42.834 --> 00:11:45.291
so let's head back over to our links

00:11:45.291 --> 00:11:46.774
so you can see that we're gonna,

00:11:47.014 --> 00:11:47.814
we basically

00:11:48.184 --> 00:11:49.754
take in this destinations type,

00:11:49.754 --> 00:11:50.473
we parse it,

00:11:50.473 --> 00:11:52.434
make sure it is totally safe before we stick it

00:11:52.434 --> 00:11:53.154
into our database.

00:11:53.154 --> 00:11:54.954
And this is a pattern that I like to follow where

00:11:55.364 --> 00:11:57.824
I have a type defined just so it kind of helps

00:11:57.824 --> 00:11:59.664
with like the type hinting when you're putting

00:11:59.664 --> 00:12:00.784
data into a method.

00:12:00.864 --> 00:12:01.164
But,

00:12:01.314 --> 00:12:04.314
but I also like to do a parsing on it because I

00:12:04.314 --> 00:12:06.194
would rather throw an error at the application

00:12:06.194 --> 00:12:06.914
runtime

00:12:07.014 --> 00:12:08.954
before the data actually makes it into the

00:12:08.954 --> 00:12:09.554
database.

00:12:10.124 --> 00:12:12.364
then like I'd rather throw that error than

00:12:12.364 --> 00:12:14.924
basically not do this and then have the potential

00:12:14.924 --> 00:12:16.924
of like wrong application code

00:12:17.884 --> 00:12:19.324
bad data into our database.

00:12:19.324 --> 00:12:21.044
So this is like an extra layer of protection that

00:12:21.044 --> 00:12:22.484
I like to do when I'm building out

00:12:22.944 --> 00:12:24.964
these queries is like if I have like some type of

00:12:24.964 --> 00:12:27.444
sensitive type that I need to update I like to do

00:12:27.444 --> 00:12:29.324
a little bit of pre processing beforehand.

00:12:29.664 --> 00:12:30.304
yeah so the,

00:12:30.304 --> 00:12:32.304
this shouldn't be everything that we need to power

00:12:32.304 --> 00:12:32.504
this.

00:12:32.504 --> 00:12:33.664
We'll be able to update this.

00:12:33.824 --> 00:12:36.144
We'll be able to enable geo routing and whatnot

00:12:36.144 --> 00:12:37.904
and then we'll also be able to

00:12:38.264 --> 00:12:40.544
you know put like where a country is going to be

00:12:40.544 --> 00:12:41.224
routed to.

00:12:41.384 --> 00:12:41.740
So

00:12:41.740 --> 00:12:42.801
make sure this is saved.

00:12:43.041 --> 00:12:44.761
And then we are going to npm,

00:12:44.761 --> 00:12:45.041
run,

00:12:45.601 --> 00:12:46.001
build,

00:12:46.001 --> 00:12:47.201
we're going to build this guy.

00:12:47.521 --> 00:12:49.201
This is going to make sure all of these

00:12:49.681 --> 00:12:51.361
queries that we have just defined

00:12:51.691 --> 00:12:53.451
are available for our packages

00:12:54.111 --> 00:12:55.871
and then we'll head over to our application

00:12:56.191 --> 00:12:58.191
and what we can do here is

00:12:58.751 --> 00:13:00.271
we're going to want to go to our

00:13:00.491 --> 00:13:01.631
we're going to want to go to our

00:13:02.111 --> 00:13:02.751
ui,

00:13:02.911 --> 00:13:03.871
go to the app

00:13:04.271 --> 00:13:05.391
and then you can see

00:13:05.711 --> 00:13:06.671
we have link,

00:13:07.271 --> 00:13:10.771
link $sign ID and this is kind of where this like

00:13:11.301 --> 00:13:14.288
dynamic variable of that ID is going to be pulled

00:13:14.288 --> 00:13:16.553
and then what you're going to notice here is when

00:13:16.553 --> 00:13:17.753
this component is loaded.

00:13:17.753 --> 00:13:19.433
So when this page is loaded for the very first

00:13:19.433 --> 00:13:19.716
time

00:13:19.811 --> 00:13:22.971
we're going to pre fetch our gitlink data and that

00:13:22.971 --> 00:13:23.731
get link Data,

00:13:23.921 --> 00:13:24.971
is going to be used

00:13:25.291 --> 00:13:26.891
throughout this entire component.

00:13:26.971 --> 00:13:27.371
So

00:13:27.801 --> 00:13:29.451
we're not going to go too deep into like you can,

00:13:29.451 --> 00:13:31.051
you can kind of like go through and see where it's

00:13:31.051 --> 00:13:31.451
being used.

00:13:31.451 --> 00:13:32.771
But for the purpose of this,

00:13:32.771 --> 00:13:34.691
let's just head over to our TRPC

00:13:34.781 --> 00:13:36.113
route on the back end

00:13:36.113 --> 00:13:38.478
and let's add in the gitlink call.

00:13:38.478 --> 00:13:40.278
So you can see we have some dummy data here.

00:13:40.358 --> 00:13:42.358
So what I'm going to do is I'm basically going to

00:13:42.358 --> 00:13:42.598
say

00:13:42.803 --> 00:13:43.283
input

00:13:43.683 --> 00:13:45.603
and this is going to take a link ID

00:13:46.083 --> 00:13:47.763
and then we can say await.

00:13:48.003 --> 00:13:48.883
Let's say const

00:13:50.083 --> 00:13:51.843
data equals await,

00:13:52.243 --> 00:13:53.283
get link

00:13:53.763 --> 00:13:55.923
that should import it and we'll pass in that link

00:13:55.923 --> 00:13:56.243
id.

00:13:56.803 --> 00:13:58.523
So this is going to be this,

00:13:58.523 --> 00:14:00.763
this data will be the same shape of this dummy

00:14:00.763 --> 00:14:01.923
data that we have down here.

00:14:01.923 --> 00:14:02.323
So

00:14:02.673 --> 00:14:04.383
what I'm going to do is I'm going to delete this

00:14:04.383 --> 00:14:04.743
guy.

00:14:05.543 --> 00:14:07.703
We also have a TRPC

00:14:07.873 --> 00:14:08.713
error that's thrown.

00:14:08.713 --> 00:14:10.153
So if for whatever reason

00:14:10.563 --> 00:14:11.843
we navigate to a page

00:14:12.443 --> 00:14:13.963
that doesn't have that link found,

00:14:13.963 --> 00:14:16.683
it's going to throw a TRBC not found.

00:14:16.923 --> 00:14:17.323
So

00:14:17.643 --> 00:14:19.083
if we head back over here,

00:14:19.163 --> 00:14:21.323
what we're going to notice is when this loads,

00:14:21.323 --> 00:14:23.077
we actually get that real product name.

00:14:23.077 --> 00:14:23.837
and then we actually,

00:14:23.837 --> 00:14:24.677
we should get that

00:14:24.897 --> 00:14:28.257
real default URL so we can also update this.

00:14:28.257 --> 00:14:30.177
So I'm just going to say like

00:14:30.789 --> 00:14:31.530
test.com

00:14:34.850 --> 00:14:35.907
and then we'll save it.

00:14:36.129 --> 00:14:37.489
If we reload the page,

00:14:37.569 --> 00:14:38.929
what you're going to notice is

00:14:39.159 --> 00:14:39.669
maybe that.

00:14:39.669 --> 00:14:39.989
Oh,

00:14:39.989 --> 00:14:41.069
we haven't done that one yet.

00:14:41.069 --> 00:14:41.389
Okay,

00:14:41.389 --> 00:14:41.749
sorry.

00:14:41.939 --> 00:14:44.059
but what you're going to notice here is this data

00:14:44.059 --> 00:14:45.019
is actually correct.

00:14:45.019 --> 00:14:46.659
We need to actually have these mutations.

00:14:46.659 --> 00:14:48.179
I'm kind of getting ahead of myself here.

00:14:48.179 --> 00:14:48.579
So

00:14:48.749 --> 00:14:50.699
the next thing here is we want to update the link

00:14:50.699 --> 00:14:51.059
name.

00:14:51.139 --> 00:14:51.539
So

00:14:51.749 --> 00:14:53.419
if we go to our UI project,

00:14:53.937 --> 00:14:56.137
we should be able to find the section where we

00:14:56.137 --> 00:14:58.977
have this input which contains that link name.

00:14:59.057 --> 00:15:03.017
So we can head back over to the front end of our

00:15:03.017 --> 00:15:03.377
code.

00:15:03.537 --> 00:15:05.457
I'm just going to go ahead and search for

00:15:06.097 --> 00:15:06.897
link name.

00:15:07.137 --> 00:15:08.617
And it looks like it's going to be actually

00:15:08.617 --> 00:15:10.657
layered deeper down in a component.

00:15:10.657 --> 00:15:11.057
So

00:15:12.417 --> 00:15:14.377
we can kind of like scan through here and then we

00:15:14.377 --> 00:15:16.537
can see that we have this link name editor.

00:15:16.537 --> 00:15:18.767
So this is going to be an individual component and

00:15:18.767 --> 00:15:19.767
it takes in a

00:15:20.087 --> 00:15:22.367
link info.name and it takes in an ID.

00:15:22.367 --> 00:15:24.407
So we'll go to that link editor and then what

00:15:24.407 --> 00:15:26.247
we're going to notice here is we have a mutation.

00:15:26.327 --> 00:15:27.847
So we basically say,

00:15:28.247 --> 00:15:30.367
we have a mutation on the back end that is called

00:15:30.367 --> 00:15:31.527
update link name.

00:15:32.007 --> 00:15:35.127
And this mutation is going to be used on a form

00:15:35.127 --> 00:15:35.767
submit.

00:15:35.847 --> 00:15:36.247
So

00:15:36.567 --> 00:15:38.487
essentially when a user clicks on,

00:15:38.688 --> 00:15:40.006
when a user clicks on this

00:15:41.076 --> 00:15:41.516
save.

00:15:41.516 --> 00:15:43.596
So when a user clicks on this button right here,

00:15:44.666 --> 00:15:48.026
it's going to call Handle save and Handle save is

00:15:48.026 --> 00:15:48.666
going to

00:15:50.276 --> 00:15:51.796
Handle save is going to

00:15:51.983 --> 00:15:54.083
pass in the data into this mutation.

00:15:54.723 --> 00:15:55.123
So

00:15:55.303 --> 00:15:56.223
here's what we're going to.

00:15:56.223 --> 00:15:57.223
So what we can do is

00:15:57.243 --> 00:15:58.623
it's going to pass a link ID and name.

00:15:58.623 --> 00:15:59.823
That's what we need on the backend.

00:15:59.823 --> 00:16:01.343
So let's head on over to the backend

00:16:02.303 --> 00:16:02.703
and

00:16:03.183 --> 00:16:05.423
what we see here is basically this mutation is

00:16:05.423 --> 00:16:07.183
just console logging the input.

00:16:07.183 --> 00:16:08.783
So link ID and link name.

00:16:09.023 --> 00:16:10.543
What we can do is we can say await

00:16:11.183 --> 00:16:11.823
update

00:16:12.143 --> 00:16:12.943
link name

00:16:13.983 --> 00:16:17.743
and then we can pass in the input.link ID because

00:16:17.743 --> 00:16:20.583
it takes in the link ID and it also takes in the

00:16:20.583 --> 00:16:20.863
name.

00:16:21.023 --> 00:16:24.863
So then we'll say input the new name that was

00:16:24.863 --> 00:16:25.423
defined.

00:16:25.823 --> 00:16:27.663
So now if we head over to our ui,

00:16:28.223 --> 00:16:29.703
what we can do is we can say,

00:16:29.703 --> 00:16:30.023
okay,

00:16:30.023 --> 00:16:31.343
I'm going to edit this.

00:16:31.803 --> 00:16:32.943
so when we hit edit,

00:16:32.943 --> 00:16:35.303
it toggles like an is editing state.

00:16:35.583 --> 00:16:37.023
And then we can say Product

00:16:37.583 --> 00:16:39.023
three new name.

00:16:39.823 --> 00:16:40.863
Go ahead and save that.

00:16:41.023 --> 00:16:42.743
So now when we refresh this page,

00:16:42.743 --> 00:16:44.823
we should notice that the state is actually

00:16:44.823 --> 00:16:45.503
preserved.

00:16:45.583 --> 00:16:48.743
So this is actually being updated in our database.

00:16:48.743 --> 00:16:50.063
And just to kind of prove that,

00:16:50.143 --> 00:16:53.223
we can head over to our database and we can rerun

00:16:53.223 --> 00:16:53.823
this query

00:16:54.143 --> 00:16:56.503
and what we're going to see is the name is going

00:16:56.503 --> 00:16:56.943
to be

00:16:57.343 --> 00:16:59.263
Product three new name.

00:16:59.423 --> 00:17:01.263
We can head back over to our UI

00:17:02.013 --> 00:17:02.893
and let's just,

00:17:03.053 --> 00:17:03.613
you know,

00:17:03.613 --> 00:17:06.213
give it back to Product three as the was the

00:17:06.213 --> 00:17:06.973
original name.

00:17:07.213 --> 00:17:08.253
We'll hit save.

00:17:08.333 --> 00:17:10.373
You can go to the database as well just to kind of

00:17:10.373 --> 00:17:11.213
prove that this is working.

00:17:11.453 --> 00:17:13.613
And you can see that this is now Product three.

00:17:13.773 --> 00:17:14.173
So,

00:17:14.523 --> 00:17:17.113
we're able to do this crud operation where we

00:17:17.323 --> 00:17:19.433
are able to fire a mutation query.

00:17:19.433 --> 00:17:20.953
And just if you've never used

00:17:21.063 --> 00:17:22.373
Tanstack mutations before,

00:17:22.853 --> 00:17:23.693
it's pretty cool.

00:17:23.693 --> 00:17:24.733
Like if you look at it,

00:17:24.733 --> 00:17:26.053
if we go ahead and change this,

00:17:26.953 --> 00:17:27.873
when you hit this guy,

00:17:27.873 --> 00:17:29.593
you're going to notice a request is made.

00:17:29.913 --> 00:17:32.393
This really is just a post request.

00:17:32.423 --> 00:17:33.593
there's nothing special about it.

00:17:33.593 --> 00:17:35.353
It's not like doing anything other than just a

00:17:35.353 --> 00:17:37.103
typical HTTP request.

00:17:37.713 --> 00:17:39.513
like you could copy this guy,

00:17:39.513 --> 00:17:39.863
you could

00:17:40.233 --> 00:17:42.833
copy a curl and you can actually view it as a

00:17:42.833 --> 00:17:43.353
curl.

00:17:49.197 --> 00:17:49.677
So it's just,

00:17:49.837 --> 00:17:51.557
it really is just like a Very typical

00:17:51.557 --> 00:17:53.739
it really is just like a typical HTTP request.

00:17:53.739 --> 00:17:55.219
There's nothing special about it.

00:17:55.229 --> 00:17:57.519
even though like in the code it kind of seems like

00:17:57.519 --> 00:17:59.719
a function that's part of like our JavaScript.

00:17:59.719 --> 00:18:00.279
It's just

00:18:00.598 --> 00:18:03.719
a wrapper around the HTTP request and it's able to

00:18:03.719 --> 00:18:05.009
kind of manage like that type

00:18:05.139 --> 00:18:06.499
parsing and whatnot for us.

00:18:06.499 --> 00:18:07.379
So it's pretty cool.

00:18:07.539 --> 00:18:09.099
So the last thing that we're going to want to do

00:18:09.099 --> 00:18:11.219
in terms of CRUD operations is we're going to want

00:18:11.219 --> 00:18:12.459
to enable geo routing.

00:18:12.459 --> 00:18:13.179
So we're going to,

00:18:13.179 --> 00:18:15.139
if we go over to our UI and we go back

00:18:16.389 --> 00:18:19.189
links ID page we should see that there is a

00:18:19.819 --> 00:18:21.124
geolinks toggle and

00:18:21.153 --> 00:18:23.473
And in this geolinks toggle we're going to notice

00:18:23.473 --> 00:18:25.073
that there is a mutation

00:18:25.473 --> 00:18:28.593
that we're defining as updatedestination mutation.

00:18:28.913 --> 00:18:31.153
And essentially what it's doing is it is just

00:18:31.153 --> 00:18:33.833
taking in any type of changes that we make to the

00:18:33.833 --> 00:18:36.513
georouting destinations and it's updating that on

00:18:36.513 --> 00:18:37.953
the TRPC site as well.

00:18:38.033 --> 00:18:38.433
So

00:18:38.743 --> 00:18:41.163
you can see here that we have this update links

00:18:41.163 --> 00:18:42.803
destination TRPC route.

00:18:43.373 --> 00:18:44.413
We can drill into it,

00:18:44.493 --> 00:18:46.013
head on over to our backend.

00:18:46.133 --> 00:18:50.213
so it's going to be worker TRPC route router and

00:18:50.213 --> 00:18:50.933
then links

00:18:51.253 --> 00:18:54.133
and this is our update destination links in

00:18:54.263 --> 00:18:57.303
this is our update destination links route and

00:18:57.303 --> 00:18:58.983
this is taking in an id

00:18:59.303 --> 00:19:02.263
so the given link id and it's also taking in this

00:19:02.263 --> 00:19:04.423
destination schema which we've already gone over.

00:19:04.533 --> 00:19:06.683
this is a schema that is coming from our

00:19:07.493 --> 00:19:09.613
be coming from our Data Ops package under that

00:19:09.613 --> 00:19:10.613
schema section.

00:19:10.693 --> 00:19:11.173
So it's,

00:19:11.173 --> 00:19:13.253
it's part of the package in our monorepo.

00:19:13.653 --> 00:19:15.933
Now all it's doing is it's console logging out

00:19:15.933 --> 00:19:17.093
this information that we have.

00:19:17.333 --> 00:19:19.813
So what we can do is we can say wait,

00:19:20.213 --> 00:19:20.853
update

00:19:21.413 --> 00:19:22.853
link destinations

00:19:23.072 --> 00:19:25.473
that automatically imported for us up here.

00:19:26.033 --> 00:19:26.993
Now we can,

00:19:27.696 --> 00:19:29.296
we can say let's make it,

00:19:29.296 --> 00:19:32.906
let's pass in the input.link ID

00:19:33.651 --> 00:19:36.251
and input.destinations because that's,

00:19:36.251 --> 00:19:37.811
this is the information that's required.

00:19:37.891 --> 00:19:38.291
So

00:19:38.611 --> 00:19:39.011
the,

00:19:39.091 --> 00:19:41.211
one of the things that I really love about TRPC is

00:19:41.211 --> 00:19:42.611
if you design your

00:19:42.791 --> 00:19:45.031
your types for your project in a really generic

00:19:45.031 --> 00:19:47.551
way and then you make sure that those types are

00:19:47.551 --> 00:19:48.711
used as the entry points,

00:19:48.851 --> 00:19:51.481
or the input for your queries in your package.

00:19:51.481 --> 00:19:53.841
So for your database queries and then you make

00:19:53.841 --> 00:19:55.761
sure that those database queries that the type

00:19:55.761 --> 00:19:57.801
that is returned is also like very clean.

00:19:58.121 --> 00:19:58.521
The

00:19:58.581 --> 00:20:00.091
amount of code that you have to write

00:20:00.511 --> 00:20:03.191
at this like API layer or the TRBC layer is so

00:20:03.191 --> 00:20:03.631
minimal.

00:20:03.631 --> 00:20:05.951
Like these routes are just so tight and clean.

00:20:06.111 --> 00:20:08.221
and it's just so type safe from the front end to

00:20:08.221 --> 00:20:08.701
the back end.

00:20:08.701 --> 00:20:11.021
And this pattern just makes it so easy to just

00:20:11.021 --> 00:20:13.221
scale and build these applications so quickly.

00:20:13.241 --> 00:20:14.301
like this project that I'm,

00:20:14.301 --> 00:20:15.061
that I built,

00:20:15.141 --> 00:20:16.501
I built this before actually

00:20:17.181 --> 00:20:18.441
before the filming of this course.

00:20:18.441 --> 00:20:20.641
And like I was able to do this in just a few days

00:20:20.641 --> 00:20:22.281
just because of like how

00:20:22.771 --> 00:20:24.691
how powerful these tools are that we're using.

00:20:24.691 --> 00:20:26.051
So I really hope you're enjoying

00:20:26.071 --> 00:20:27.031
the technologies that we're,

00:20:27.031 --> 00:20:28.511
that we're using if you haven't used these before.

00:20:29.311 --> 00:20:30.271
So now that we have this

00:20:30.641 --> 00:20:32.641
now that we have this mutation built for the

00:20:32.641 --> 00:20:33.121
update,

00:20:33.821 --> 00:20:35.741
for the update destinations logic,

00:20:35.741 --> 00:20:38.461
what we can see here is we have a default URL

00:20:38.781 --> 00:20:41.141
and then we have this geo routing section and this

00:20:41.141 --> 00:20:43.181
georouting section is not enabled right now.

00:20:43.341 --> 00:20:44.941
So if we go ahead and enable it

00:20:45.341 --> 00:20:48.421
we will have the ability to basically say anybody

00:20:48.421 --> 00:20:49.261
from a given country,

00:20:49.501 --> 00:20:50.381
we'll say like

00:20:50.471 --> 00:20:52.791
anybody in the United States

00:20:54.379 --> 00:20:56.539
of America is going to go to.

00:20:56.539 --> 00:20:59.419
Let's just send them to the torso.com website.

00:20:59.579 --> 00:21:01.779
obviously for our use case it probably is like

00:21:01.779 --> 00:21:02.539
product pages,

00:21:02.699 --> 00:21:04.699
like landing pages for different products for

00:21:04.699 --> 00:21:05.499
different regions.

00:21:05.799 --> 00:21:07.559
but we'll put this in there and we're going to go

00:21:07.559 --> 00:21:08.839
ahead and say save destination.

00:21:09.079 --> 00:21:11.179
We have this nice little toast that pops up

00:21:11.209 --> 00:21:12.809
as part of our SHADCN

00:21:13.059 --> 00:21:13.699
library.

00:21:13.699 --> 00:21:14.245
And then,

00:21:15.557 --> 00:21:17.957
and then you can see that we have like a

00:21:17.957 --> 00:21:19.037
destination down here.

00:21:19.037 --> 00:21:20.797
So we say everybody from the United States of

00:21:20.797 --> 00:21:22.497
America is going to go to this Torso.

00:21:22.577 --> 00:21:24.417
We can go ahead and add another destination.

00:21:24.577 --> 00:21:26.637
we're going to say everybody in Albania

00:21:27.117 --> 00:21:30.757
is going to go to this Cloudflare D1 doc page for

00:21:30.757 --> 00:21:30.997
now.

00:21:30.997 --> 00:21:32.045
So we'll put that in there.

00:21:32.045 --> 00:21:33.206
Go ahead and hit save.

00:21:33.206 --> 00:21:34.806
And you can see that we have these two.

00:21:34.886 --> 00:21:36.726
Now when we reload this page

00:21:36.807 --> 00:21:38.733
we're going to notice that these destinations are

00:21:38.733 --> 00:21:39.013
here.

00:21:39.203 --> 00:21:40.273
and then we

00:21:40.753 --> 00:21:43.633
come over to our links and you can see that it's

00:21:43.633 --> 00:21:45.633
counting the number of destinations as part of

00:21:45.633 --> 00:21:46.033
this product,

00:21:46.833 --> 00:21:47.343
as part of this

00:21:47.391 --> 00:21:47.747
this

00:21:47.747 --> 00:21:50.197
link and there's three of them and we click on it,

00:21:50.197 --> 00:21:50.957
come over here.

00:21:50.957 --> 00:21:52.717
We can see that that data is persisting.

00:21:52.717 --> 00:21:55.157
So we effectively built out these CRUD operations.

00:21:55.207 --> 00:21:56.727
we also have like a nice little

00:21:57.047 --> 00:21:57.847
pop up here.

00:21:57.847 --> 00:22:01.207
So if we decide to disable georouting and we have

00:22:01.447 --> 00:22:01.757
these

00:22:01.877 --> 00:22:02.837
links already defined,

00:22:02.837 --> 00:22:04.917
it's basically going to say like if you disable

00:22:04.917 --> 00:22:07.157
geo routing we're going to be like the links that

00:22:07.157 --> 00:22:08.677
you've already saved are going to get deleted.

00:22:08.677 --> 00:22:11.197
So when you hit disable georouting it's actually

00:22:11.197 --> 00:22:13.117
going to call that same mutation that we just

00:22:13.117 --> 00:22:15.497
defined and it's just going to put empty data in

00:22:15.497 --> 00:22:15.777
there.

00:22:15.857 --> 00:22:16.257
So

00:22:16.507 --> 00:22:18.077
we can go to the network and we can go ahead and

00:22:18.077 --> 00:22:19.237
take a look at what that looks like.

00:22:19.237 --> 00:22:19.837
Disable.

00:22:19.997 --> 00:22:21.176
So you can see that this

00:22:21.176 --> 00:22:22.217
you can see that this

00:22:24.327 --> 00:22:26.967
update link destination route was called and we

00:22:26.967 --> 00:22:29.327
passed in some data but we only passed in the

00:22:29.327 --> 00:22:30.247
default destination.

00:22:30.407 --> 00:22:32.647
So it kind of just overrode that data.

00:22:32.917 --> 00:22:34.757
so we don't have those destinations anymore.

00:22:34.757 --> 00:22:36.157
Now if you were,

00:22:36.157 --> 00:22:37.637
if you're really paying close attention,

00:22:37.637 --> 00:22:39.877
what you're going to notice is right when this

00:22:40.707 --> 00:22:42.787
right when this request was settled or was

00:22:42.837 --> 00:22:44.007
successfully fulfilled,

00:22:44.567 --> 00:22:46.247
this request fired.

00:22:46.327 --> 00:22:47.127
And if you look,

00:22:47.127 --> 00:22:50.127
this request says get link and this is actually

00:22:50.127 --> 00:22:50.487
the

00:22:50.577 --> 00:22:51.367
data call

00:22:51.368 --> 00:22:52.747
that is used to populate

00:22:53.147 --> 00:22:53.547
the

00:22:53.657 --> 00:22:54.647
data on this page.

00:22:54.647 --> 00:22:56.207
So why did this one fire?

00:22:56.207 --> 00:22:57.127
This wasn't an accident,

00:22:57.127 --> 00:22:58.567
this was actually very intentional.

00:22:58.567 --> 00:23:01.567
So if you come over here like basically if you

00:23:01.567 --> 00:23:03.207
imagine like when you disable that

00:23:03.417 --> 00:23:05.297
you're going to want to make sure like the data on

00:23:05.297 --> 00:23:07.417
the page is fresh and you could build out a bunch

00:23:07.417 --> 00:23:09.897
of like state management logic on the ui.

00:23:09.897 --> 00:23:10.297
But

00:23:10.677 --> 00:23:13.397
with the beauty of the Tanstack query is what we

00:23:13.397 --> 00:23:15.477
can do is we can head over to our UI

00:23:16.357 --> 00:23:18.277
and we will come into our

00:23:18.357 --> 00:23:20.491
we'll come into this geo routing toggle and then

00:23:20.491 --> 00:23:22.291
what you're going to notice is in this mutation

00:23:22.291 --> 00:23:23.411
where we update

00:23:23.731 --> 00:23:25.331
our destinations object,

00:23:25.811 --> 00:23:26.931
we say on success.

00:23:27.091 --> 00:23:29.211
So like when this query has successful

00:23:29.391 --> 00:23:30.271
successfully

00:23:30.511 --> 00:23:31.151
settles

00:23:31.871 --> 00:23:32.271
what,

00:23:32.431 --> 00:23:34.431
what's going to happen is we're going to take our

00:23:34.671 --> 00:23:35.391
query client,

00:23:35.391 --> 00:23:36.011
this is our

00:23:36.041 --> 00:23:37.401
Tanstack query client

00:23:37.801 --> 00:23:40.581
and we are going to invalidate qu queries.

00:23:40.821 --> 00:23:42.701
And which query are we going to invalidate?

00:23:42.701 --> 00:23:45.061
We're going to invalidate a query with the key

00:23:45.381 --> 00:23:46.421
that's coming from

00:23:46.741 --> 00:23:48.661
our get links call.

00:23:49.141 --> 00:23:51.661
And what this does is it basically says like once

00:23:51.661 --> 00:23:52.341
we hit success,

00:23:52.741 --> 00:23:53.701
we're going to say

00:23:54.101 --> 00:23:54.191
invalidate

00:23:54.641 --> 00:23:55.041
that data.

00:23:55.041 --> 00:23:58.201
And when you invalidate that data with NStack,

00:23:58.441 --> 00:24:00.881
it has to go make that data call again to get

00:24:00.881 --> 00:24:01.481
fresh data.

00:24:01.641 --> 00:24:03.921
So it's kind of like the side effect where you go

00:24:03.921 --> 00:24:05.881
update something and instead of like doing all

00:24:05.881 --> 00:24:08.001
this complicated state management globally

00:24:08.001 --> 00:24:09.561
throughout your product or your project,

00:24:09.561 --> 00:24:10.681
you can basically say,

00:24:10.681 --> 00:24:11.081
okay,

00:24:11.081 --> 00:24:11.871
I want to invalidate

00:24:12.261 --> 00:24:13.621
this data and this data and this data.

00:24:13.621 --> 00:24:15.261
So it's just going to go fetch that data from the

00:24:15.261 --> 00:24:16.781
server and just get like the fresh stuff.

00:24:16.781 --> 00:24:19.061
So it's such a snappy like clean way of doing

00:24:19.061 --> 00:24:20.421
stuff where you don't have to like worry about

00:24:20.421 --> 00:24:20.901
managing,

00:24:20.901 --> 00:24:23.061
managing state on the back end and on the front

00:24:23.061 --> 00:24:23.741
end just say,

00:24:23.741 --> 00:24:23.981
hey,

00:24:23.981 --> 00:24:26.061
I want to refresh this data and then Tanstat query

00:24:26.061 --> 00:24:26.901
takes care of it for you.

00:24:26.901 --> 00:24:27.301
It's really,

00:24:27.301 --> 00:24:27.861
really cool.

00:24:28.021 --> 00:24:28.421
So,

00:24:28.581 --> 00:24:29.021
all right,

00:24:29.021 --> 00:24:30.651
so I think that's enough for this section.

00:24:31.311 --> 00:24:33.511
we've successfully been able to have all of our

00:24:33.511 --> 00:24:34.991
CRUD operations for this product.

00:24:35.181 --> 00:24:37.031
we're able to create links,

00:24:37.351 --> 00:24:40.111
we're able to view all of the links that have been

00:24:40.111 --> 00:24:42.191
created and then we're also able to update things

00:24:42.191 --> 00:24:43.031
about that link.

00:24:43.611 --> 00:24:44.291
that's like a really.

00:24:44.291 --> 00:24:46.011
I think this is a really clean pattern of,

00:24:46.041 --> 00:24:48.031
building crud operations on

00:24:48.321 --> 00:24:50.618
Building crud operations on top of

00:24:51.248 --> 00:24:51.878
on top of

00:24:52.178 --> 00:24:53.658
applications that are running on cloudflare

00:24:53.658 --> 00:24:53.938
workers.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.028 --> 00:00:00.468
All right,

00:00:00.468 --> 00:00:03.708
so we've gone pretty deep into the front end and

00:00:03.708 --> 00:00:05.148
the thin little back end,

00:00:05.568 --> 00:00:08.288
that is facing the user of this application,

00:00:08.288 --> 00:00:09.888
which is built on trpc.

00:00:10.288 --> 00:00:10.688
Now,

00:00:11.098 --> 00:00:13.358
I know we kind of touched over a lot of these

00:00:13.358 --> 00:00:15.478
topics really quickly and that's kind of by

00:00:15.478 --> 00:00:15.798
design.

00:00:15.878 --> 00:00:17.998
I don't want this to be a framework course.

00:00:17.998 --> 00:00:20.558
I want this to be building on top of Cloudflare

00:00:20.558 --> 00:00:20.918
course.

00:00:20.918 --> 00:00:21.318
So,

00:00:21.508 --> 00:00:23.238
before we actually get into this next section,

00:00:23.238 --> 00:00:24.958
which is kind of where we're going to go much,

00:00:24.958 --> 00:00:27.428
much deeper into the Cloudflare services and

00:00:27.578 --> 00:00:28.938
infrastructure and different like,

00:00:28.938 --> 00:00:30.458
products that we're building on top of,

00:00:30.468 --> 00:00:32.478
that's kind of the meat of this course.

00:00:33.008 --> 00:00:35.188
I do want to get in the habit of continuously

00:00:35.188 --> 00:00:36.578
deploying throughout this,

00:00:36.578 --> 00:00:37.408
throughout this course.

00:00:37.408 --> 00:00:38.168
Just so like,

00:00:38.248 --> 00:00:40.048
you're never in a position where you're,

00:00:40.048 --> 00:00:40.528
you know,

00:00:40.528 --> 00:00:41.608
six hours into a course,

00:00:41.608 --> 00:00:43.368
you try to deploy and something doesn't work.

00:00:43.768 --> 00:00:44.768
I kind of model,

00:00:44.768 --> 00:00:46.888
I'm going to model this after the way that I build

00:00:46.888 --> 00:00:49.528
products for other people or for myself where,

00:00:50.068 --> 00:00:51.588
I'm incrementally building things

00:00:51.898 --> 00:00:53.578
and then I'm continuously deploying.

00:00:53.578 --> 00:00:55.418
So I'm never kind of in a position of like

00:00:55.418 --> 00:00:56.018
figuring out like,

00:00:56.018 --> 00:00:56.538
holy cow,

00:00:56.538 --> 00:00:56.858
like

00:00:57.258 --> 00:00:59.378
I'm so deep into this project and now I'm having

00:00:59.378 --> 00:01:00.568
an issue with the deployment.

00:01:00.568 --> 00:01:01.278
I like to like,

00:01:01.278 --> 00:01:03.678
incrementally do things just because like one,

00:01:03.678 --> 00:01:04.838
you're shipping really quickly,

00:01:04.838 --> 00:01:07.117
you're able to validate changes really fast and

00:01:07.117 --> 00:01:09.118
your project is always in a state that's just kind

00:01:09.118 --> 00:01:09.918
of ready to go.

00:01:09.998 --> 00:01:10.398
So,

00:01:11.078 --> 00:01:11.958
with that said,

00:01:12.118 --> 00:01:14.278
let's head back over to our user application.

00:01:14.358 --> 00:01:15.638
It's probably still running.

00:01:15.638 --> 00:01:17.398
We're going to go ahead and kill that application

00:01:17.958 --> 00:01:18.518
and then,

00:01:19.108 --> 00:01:21.428
from earlier in the course you're going to know

00:01:21.428 --> 00:01:23.268
that we have to run one simple command.

00:01:23.588 --> 00:01:25.748
And that simple command is living inside of this

00:01:25.748 --> 00:01:26.228
packages,

00:01:26.408 --> 00:01:26.988
inside of this

00:01:26.988 --> 00:01:27.868
package JSON,

00:01:28.188 --> 00:01:30.668
we have a deploy command right here.

00:01:30.828 --> 00:01:31.032
So

00:01:31.054 --> 00:01:32.814
essentially what we're going to do is we're going

00:01:32.814 --> 00:01:34.014
to say pnpm,

00:01:34.334 --> 00:01:34.734
run,

00:01:35.054 --> 00:01:35.694
deploy.

00:01:36.814 --> 00:01:38.814
Now this specific project

00:01:39.294 --> 00:01:42.534
does fail if you have any like type errors or

00:01:42.534 --> 00:01:44.254
linting errors in the UI site.

00:01:44.254 --> 00:01:45.824
So if you do get a failure to,

00:01:45.974 --> 00:01:46.534
that's okay.

00:01:47.214 --> 00:01:49.734
I kind of intentionally got us a failure here just

00:01:49.734 --> 00:01:51.054
so we can kind of see what's happening.

00:01:51.054 --> 00:01:52.974
But you can see that this is saying

00:01:53.454 --> 00:01:54.374
set is connected,

00:01:54.374 --> 00:01:55.214
is declared,

00:01:55.294 --> 00:01:56.574
but it is never read.

00:01:56.814 --> 00:01:59.214
So we can head over to our,

00:01:59.554 --> 00:02:00.374
click socket.

00:02:00.534 --> 00:02:02.214
And yours might not be this way,

00:02:02.214 --> 00:02:03.814
but you can notice that

00:02:03.914 --> 00:02:06.034
it's throwing an error because this is a dummy

00:02:06.034 --> 00:02:08.554
component that we haven't implemented yet and it

00:02:08.714 --> 00:02:10.904
is failing just because we've defined something

00:02:10.904 --> 00:02:11.624
that's not used.

00:02:11.944 --> 00:02:13.504
And that's okay for now.

00:02:13.504 --> 00:02:14.424
I'm just going to

00:02:14.984 --> 00:02:16.904
I'm just going to delete it and just say

00:02:17.544 --> 00:02:18.264
underscore.

00:02:18.344 --> 00:02:20.344
So this is kind of just like,

00:02:20.974 --> 00:02:22.764
your linting tool will look at this and be like,

00:02:22.764 --> 00:02:23.004
okay,

00:02:23.004 --> 00:02:23.204
yeah,

00:02:23.204 --> 00:02:24.804
this is intentionally not being used.

00:02:25.044 --> 00:02:25.444
So

00:02:26.084 --> 00:02:28.404
I'm going to go ahead and clear and I'm going to

00:02:28.404 --> 00:02:28.924
deploy again.

00:02:28.924 --> 00:02:30.804
So this deployment should be successful.

00:02:30.804 --> 00:02:31.884
So just note like,

00:02:31.884 --> 00:02:33.284
if you run into deployment issues,

00:02:33.364 --> 00:02:34.404
not the end of the world,

00:02:34.454 --> 00:02:36.224
just read through like what it's saying.

00:02:36.224 --> 00:02:37.824
You should be able to figure it out quickly.

00:02:37.824 --> 00:02:39.424
And especially with AI these days,

00:02:39.424 --> 00:02:41.824
like being able to pop open your cursor tab and

00:02:41.824 --> 00:02:42.344
then ask like,

00:02:42.344 --> 00:02:42.544
hey,

00:02:42.544 --> 00:02:43.144
I got this error.

00:02:43.144 --> 00:02:43.864
What's going on?

00:02:43.864 --> 00:02:45.384
These types of things that should be able to

00:02:45.384 --> 00:02:45.944
figure out very,

00:02:45.944 --> 00:02:46.424
very quick.

00:02:47.394 --> 00:02:47.674
so this,

00:02:47.674 --> 00:02:49.714
what we're noticing is it's uploading all of our

00:02:49.714 --> 00:02:50.914
assets from our build.

00:02:51.104 --> 00:02:51.594
it's basically,

00:02:51.594 --> 00:02:52.594
it's built all of them,

00:02:52.594 --> 00:02:53.314
all of the stuff.

00:02:53.314 --> 00:02:54.154
It's stuck it into,

00:02:54.764 --> 00:02:56.054
the dist folder and

00:02:56.208 --> 00:02:57.888
it has uploaded it to

00:02:58.098 --> 00:02:59.938
Cloudflare CD and all around the world.

00:03:00.258 --> 00:03:02.418
And what you also will probably note is

00:03:02.738 --> 00:03:04.898
we have this EMV DB

00:03:05.298 --> 00:03:06.578
and this has

00:03:06.908 --> 00:03:09.708
this is basically the ID of our database because

00:03:09.868 --> 00:03:11.388
we added our database

00:03:12.848 --> 00:03:14.688
or we should have added our database in this

00:03:14.688 --> 00:03:15.168
wrangler,

00:03:15.418 --> 00:03:15.808
file.

00:03:15.808 --> 00:03:16.608
Or in this wrangler.

00:03:16.608 --> 00:03:16.888
Yeah,

00:03:16.888 --> 00:03:18.448
in this wrangler JSON file.

00:03:18.688 --> 00:03:20.494
So if you go over to this URL,

00:03:22.689 --> 00:03:25.132
our project should be deployed and it should be

00:03:25.132 --> 00:03:25.612
usable.

00:03:26.172 --> 00:03:27.932
And notice how snappy this is.

00:03:27.932 --> 00:03:30.132
Like before when we were running this locally,

00:03:30.132 --> 00:03:31.012
when you click on this button,

00:03:31.012 --> 00:03:32.012
you get a lot of loading.

00:03:32.012 --> 00:03:34.572
But this is actually the real behavior of how

00:03:34.572 --> 00:03:35.502
snappy it should be.

00:03:35.562 --> 00:03:37.032
when you deploy this thing.

00:03:37.032 --> 00:03:39.232
So you click and it instantly goes over.

00:03:39.232 --> 00:03:39.632
So,

00:03:39.872 --> 00:03:42.092
this is real data that's sitting in our database.

00:03:42.172 --> 00:03:44.148
We can update the data as well.

00:03:44.148 --> 00:03:45.301
We can add some

00:03:45.611 --> 00:03:47.051
GEO routing logic.

00:03:47.051 --> 00:03:47.451
So

00:03:47.524 --> 00:03:49.194
just a random URL here.

00:03:49.585 --> 00:03:52.183
And when you refresh that data should be,

00:03:52.323 --> 00:03:53.123
should persist.

00:03:53.203 --> 00:03:53.603
So

00:03:53.923 --> 00:03:54.323
yeah,

00:03:54.323 --> 00:03:56.043
just want to get in this habit of continuously

00:03:56.043 --> 00:03:56.443
deploying.

00:03:56.443 --> 00:03:58.203
So at this point just make sure your UI is

00:03:58.203 --> 00:04:00.123
deployed and then we're going to move deeper down

00:04:00.123 --> 00:04:00.723
into the stack.

00:04:00.723 --> 00:04:02.303
We're actually going to start building out,

00:04:02.903 --> 00:04:05.303
the API that manages the link routing.

00:04:05.303 --> 00:04:06.423
We're going to build out queues,

00:04:06.423 --> 00:04:07.463
we're going to build out workflows.

00:04:07.463 --> 00:04:08.503
We're going to work with A.I.

00:04:08.503 --> 00:04:09.203
it's going to be.

00:04:09.203 --> 00:04:10.483
It's going to be pretty cool what we're going to

00:04:10.483 --> 00:04:11.323
learn from here on out.

00:04:11.323 --> 00:04:13.403
So I hope you've enjoyed the course this far and

00:04:13.403 --> 00:04:13.923
do please,

00:04:13.923 --> 00:04:14.163
like,

00:04:14.163 --> 00:04:15.683
let me know if there's anything where

00:04:16.003 --> 00:04:17.883
you feel like can be improved or if it's not

00:04:17.883 --> 00:04:18.643
working as expected.

00:04:18.723 --> 00:04:20.563
And then I'm going to continuously make sure that

00:04:20.563 --> 00:04:22.163
these course sections are updated,

00:04:22.463 --> 00:04:24.743
so people don't get stuck and people are actually

00:04:24.743 --> 00:04:26.943
able to progress fast throughout the process,

00:04:26.943 --> 00:04:27.343
so.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.060 --> 00:00:00.420
All right,

00:00:00.420 --> 00:00:02.980
so now that we have a good chunk of the user

00:00:02.980 --> 00:00:04.340
facing application built out,

00:00:04.340 --> 00:00:06.260
all these crud operations are working and we're

00:00:06.260 --> 00:00:08.220
able to create smart links.

00:00:08.380 --> 00:00:10.180
We're going to move a little bit deeper back into

00:00:10.180 --> 00:00:12.980
the stack and start building out the data side of

00:00:12.980 --> 00:00:13.740
this application.

00:00:13.750 --> 00:00:16.020
the first chunk that we're going to kind of take a

00:00:16.020 --> 00:00:18.020
stab at is we're actually going to build out the

00:00:18.260 --> 00:00:19.380
smart routing system

00:00:19.780 --> 00:00:21.940
that listens to a source link,

00:00:22.450 --> 00:00:25.890
request and then routes or redirects that request

00:00:26.290 --> 00:00:27.730
to the intended destination.

00:00:27.970 --> 00:00:31.250
So if you notice here we have these links that got

00:00:31.250 --> 00:00:33.730
created whenever we would create a link through

00:00:33.730 --> 00:00:34.370
this flow

00:00:34.850 --> 00:00:36.610
and right now it says undefined.

00:00:36.610 --> 00:00:38.730
That's just because this is configured by a vite

00:00:38.730 --> 00:00:40.530
environment variable that we haven't set yet.

00:00:40.530 --> 00:00:41.970
Once we get a domain,

00:00:42.410 --> 00:00:43.550
we're going to be configuring this.

00:00:43.550 --> 00:00:46.110
So don't expect this URL to work as it stands

00:00:46.110 --> 00:00:46.550
right now.

00:00:47.710 --> 00:00:49.910
as we've kind of gone over throughout the creation

00:00:49.910 --> 00:00:50.990
of this UI is

00:00:51.560 --> 00:00:53.320
every single link has a destination.

00:00:53.800 --> 00:00:55.240
So this is kind of like the default,

00:00:55.240 --> 00:00:56.760
this is where all the traffic goes to.

00:00:56.920 --> 00:01:00.120
And then we're optionally able to configure geo

00:01:00.120 --> 00:01:01.160
based routing as well.

00:01:01.160 --> 00:01:03.760
So essentially what that's intended to do is when

00:01:03.760 --> 00:01:05.400
a smart link receives a request,

00:01:05.480 --> 00:01:07.880
it's gonna look up the configuration for that

00:01:07.880 --> 00:01:09.080
specific link ID

00:01:09.480 --> 00:01:11.880
and then it's also going to look at where that

00:01:11.880 --> 00:01:13.000
request is coming from.

00:01:13.010 --> 00:01:15.130
right now we're just kind of building out country

00:01:15.130 --> 00:01:15.400
based

00:01:15.400 --> 00:01:18.150
you could get city level or providence or state

00:01:18.150 --> 00:01:18.470
level.

00:01:18.590 --> 00:01:19.350
but currently

00:01:19.460 --> 00:01:20.850
what we're going to do is we're just going to try

00:01:20.850 --> 00:01:23.330
to check like where is this user like making the

00:01:23.330 --> 00:01:23.850
request.

00:01:23.850 --> 00:01:26.850
And then does that link have any geo routing

00:01:26.850 --> 00:01:27.450
configuration

00:01:27.850 --> 00:01:29.930
that matches that user's location?

00:01:30.090 --> 00:01:30.690
If so,

00:01:30.690 --> 00:01:31.510
it's going to route,

00:01:31.510 --> 00:01:34.210
it's going to figure out where the geo destination

00:01:34.210 --> 00:01:36.490
is and if not it's just going to fall back to that

00:01:36.490 --> 00:01:37.530
default destination.

00:01:37.770 --> 00:01:39.730
So that's the logic that we're going to build.

00:01:39.730 --> 00:01:40.090
And

00:01:41.210 --> 00:01:42.570
this type of implementation,

00:01:42.890 --> 00:01:44.610
if you're like just kind of building this from

00:01:44.610 --> 00:01:45.130
scratch,

00:01:45.210 --> 00:01:46.730
not on top of Cloudflare,

00:01:46.810 --> 00:01:48.970
I do think it is a little bit more cumbersome

00:01:48.970 --> 00:01:51.250
because you typically would have to look at an IP

00:01:51.250 --> 00:01:54.090
address of a user and then have some type of

00:01:54.250 --> 00:01:54.970
database

00:01:55.000 --> 00:01:55.450
stores

00:01:56.040 --> 00:01:58.520
IP address range to a location.

00:01:58.520 --> 00:01:59.230
And those aren't

00:01:59.230 --> 00:02:00.020
crazy accurate,

00:02:00.020 --> 00:02:01.570
but they're good enough and you could

00:02:01.570 --> 00:02:03.480
build an intelligent routing system based on that.

00:02:03.480 --> 00:02:03.800
But

00:02:04.420 --> 00:02:05.490
because Cloudflare is

00:02:05.490 --> 00:02:06.040
a very,

00:02:06.760 --> 00:02:09.640
widely used content delivery network and DNS

00:02:09.640 --> 00:02:10.200
provider,

00:02:10.520 --> 00:02:12.520
their headers actually tag

00:02:12.840 --> 00:02:13.640
all that information

00:02:13.960 --> 00:02:16.440
about the user and about the request that's being

00:02:16.440 --> 00:02:17.400
made for us.

00:02:17.400 --> 00:02:17.550
So,

00:02:17.550 --> 00:02:19.780
we actually don't have to bring in other services,

00:02:20.260 --> 00:02:21.060
which makes it really,

00:02:21.060 --> 00:02:22.210
really powerful if you want to,

00:02:22.210 --> 00:02:23.760
build out server side analytics,

00:02:23.760 --> 00:02:24.650
for your application,

00:02:24.650 --> 00:02:27.250
because they do tag each request with a whole

00:02:27.250 --> 00:02:27.810
bunch of super,

00:02:27.810 --> 00:02:28.770
super useful information.

00:02:29.780 --> 00:02:31.460
so if we head over to our

00:02:31.768 --> 00:02:32.808
project repo,

00:02:32.968 --> 00:02:35.088
we're actually going to be working inside of this

00:02:35.088 --> 00:02:35.848
data service,

00:02:36.448 --> 00:02:37.324
project for now.

00:02:37.355 --> 00:02:39.355
Now if we head over to this data service

00:02:39.595 --> 00:02:40.315
application

00:02:40.795 --> 00:02:42.475
and we go into source,

00:02:42.475 --> 00:02:43.835
you'll see that there's a single file,

00:02:43.835 --> 00:02:45.755
it's going to be the index TS file

00:02:46.155 --> 00:02:48.635
and this is the entry point to the data service.

00:02:48.825 --> 00:02:51.095
if you kind of remember how we configured the

00:02:51.095 --> 00:02:53.095
lightweight backend for our user application,

00:02:53.095 --> 00:02:56.015
you might notice that this setup is slightly

00:02:56.015 --> 00:02:56.295
different.

00:02:56.295 --> 00:02:58.735
It's kind of like a class based setup and I'll

00:02:58.735 --> 00:03:00.195
kind of go compare and contrast.

00:03:00.305 --> 00:03:01.265
worker entry point

00:03:01.585 --> 00:03:03.145
that implements a fetch handler.

00:03:03.145 --> 00:03:05.825
So we're able to route requests and respond to

00:03:05.825 --> 00:03:06.545
requests.

00:03:06.545 --> 00:03:08.265
and for now all it does is it returns.

00:03:08.265 --> 00:03:08.865
Hello world.

00:03:09.425 --> 00:03:13.025
Now our user application had a very similar setup.

00:03:13.025 --> 00:03:15.005
the entry point instead of in the source was in

00:03:15.005 --> 00:03:15.645
the worker

00:03:16.045 --> 00:03:18.845
and we had this index ts and you notice this is

00:03:18.845 --> 00:03:20.125
like a very similar setup,

00:03:20.125 --> 00:03:22.845
but it's not extending a worker entry point,

00:03:22.845 --> 00:03:25.485
it's just exporting a default fetch handler.

00:03:26.245 --> 00:03:28.205
these setups are technically the same.

00:03:28.685 --> 00:03:31.165
There really is no difference between the two

00:03:31.485 --> 00:03:33.845
other than the syntax and the semantics of how

00:03:33.845 --> 00:03:34.915
this is actually built.

00:03:37.265 --> 00:03:38.305
I actually favor

00:03:38.625 --> 00:03:41.185
this route when you're building out like a very

00:03:42.969 --> 00:03:43.769
data service,

00:03:43.849 --> 00:03:46.529
not kind of like compiling a full stack framework

00:03:46.529 --> 00:03:47.929
to deploy on a cloudflare.

00:03:47.929 --> 00:03:49.769
Like if you're just kind of building out services

00:03:49.769 --> 00:03:50.729
that run on workers.

00:03:51.019 --> 00:03:52.579
this is my preferred way of setting it up.

00:03:52.579 --> 00:03:55.139
And the reason why I like setting it up is because

00:03:55.139 --> 00:03:57.529
it's like very clear what you have access to.

00:03:57.529 --> 00:03:59.439
you can see like we're going to be grabbing the

00:03:59.439 --> 00:04:00.479
environment variable.

00:04:01.279 --> 00:04:02.959
You also have access to queues,

00:04:03.119 --> 00:04:04.159
as you can see here.

00:04:04.239 --> 00:04:05.759
You also have access to

00:04:06.319 --> 00:04:08.029
like a cron based scheduler.

00:04:08.069 --> 00:04:10.109
And essentially each one of these methods that

00:04:10.109 --> 00:04:12.469
we're able to implement is considered a worker

00:04:12.469 --> 00:04:13.029
trigger.

00:04:13.059 --> 00:04:14.489
if you look at a fetch handler,

00:04:14.489 --> 00:04:16.769
a fetch handler basically says if we receive a

00:04:16.769 --> 00:04:17.929
HTTP request,

00:04:17.929 --> 00:04:20.529
that is a trigger to invoke a worker and to run

00:04:20.529 --> 00:04:21.329
your worker code.

00:04:21.329 --> 00:04:22.809
Now there's other triggers,

00:04:22.809 --> 00:04:23.449
there's queues,

00:04:23.849 --> 00:04:24.929
there's a schedule.

00:04:24.929 --> 00:04:27.609
So kind of you can configure a cron based job to

00:04:27.609 --> 00:04:28.169
say every

00:04:28.539 --> 00:04:29.649
day at one o',

00:04:29.649 --> 00:04:29.929
clock,

00:04:30.409 --> 00:04:30.889
hit this,

00:04:30.969 --> 00:04:32.379
basically run the worker code,

00:04:32.379 --> 00:04:35.389
and all of the application logic you define inside

00:04:35.389 --> 00:04:36.429
of the handler.

00:04:36.589 --> 00:04:38.789
So inside of the schedule or the queue or the

00:04:38.789 --> 00:04:40.749
fetch is your application code.

00:04:40.839 --> 00:04:41.989
that is kind of trigger based.

00:04:41.989 --> 00:04:44.509
Now the vast majority of the time you're going to

00:04:44.509 --> 00:04:46.189
be building your service is on top of the fetch

00:04:46.189 --> 00:04:46.629
handler,

00:04:46.629 --> 00:04:48.429
but there's a whole bunch of other compute

00:04:48.429 --> 00:04:51.389
primitives that we have access to and this is kind

00:04:51.389 --> 00:04:53.269
of how we interface with them and build on top of

00:04:53.269 --> 00:04:53.509
it.

00:04:53.509 --> 00:04:55.379
So I enjoy building

00:04:55.709 --> 00:04:56.829
and a traditional like service,

00:04:56.829 --> 00:04:59.229
not like your full Stack application where you're

00:04:59.229 --> 00:05:01.029
kind of like building out a UI and your code

00:05:01.029 --> 00:05:01.469
application,

00:05:01.549 --> 00:05:03.029
your crude operations and whatnot.

00:05:03.029 --> 00:05:05.309
When I'm building an actual like data service,

00:05:05.389 --> 00:05:07.469
this is typically the setup that I like to follow.

00:05:07.709 --> 00:05:09.829
And the reason why I prefer the class based

00:05:09.829 --> 00:05:10.189
approach

00:05:12.109 --> 00:05:14.429
over actually just exporting each one of these

00:05:14.429 --> 00:05:16.029
handlers individually is

00:05:16.329 --> 00:05:18.729
because you have access to the constructor and

00:05:18.809 --> 00:05:19.689
you're able to,

00:05:20.039 --> 00:05:20.709
when trigger

00:05:21.219 --> 00:05:22.259
starts up your worker,

00:05:22.579 --> 00:05:23.739
no matter what trigger it is,

00:05:23.739 --> 00:05:24.059
you can,

00:05:24.059 --> 00:05:26.059
under that constructor you can run some

00:05:26.059 --> 00:05:27.739
boilerplate setup code if you have any

00:05:27.739 --> 00:05:29.699
dependencies that you want to set up for your

00:05:29.699 --> 00:05:30.089
request.

00:05:30.089 --> 00:05:32.199
and we're going to get deeper into

00:05:32.519 --> 00:05:34.519
how to kind of play with that constructor to help

00:05:34.519 --> 00:05:34.829
us

00:05:34.829 --> 00:05:36.199
build more scalable applications.

00:05:36.199 --> 00:05:37.789
But it's kind of beyond the point for now.

00:05:40.059 --> 00:05:42.459
we're just going to run the application so we can

00:05:42.459 --> 00:05:44.619
say pnpm or just make sure that you have

00:05:45.129 --> 00:05:46.569
CD into data service.

00:05:46.729 --> 00:05:48.569
So CD into apps,

00:05:48.729 --> 00:05:49.449
data service.

00:05:49.449 --> 00:05:51.049
Now we're in the data service application,

00:05:51.049 --> 00:05:52.489
then you can say pnpm run

00:05:53.289 --> 00:05:55.289
dev and that's going to spin up our application.

00:05:55.529 --> 00:05:57.769
This is going to be running on port 8787.

00:05:57.769 --> 00:05:59.289
This is the default port that

00:05:59.409 --> 00:06:01.269
Cloudflare applications run on.

00:06:01.269 --> 00:06:04.589
Unless you bring in a framework that specifies a

00:06:04.589 --> 00:06:05.269
different port

00:06:05.909 --> 00:06:07.709
and if we head over here,

00:06:07.709 --> 00:06:09.589
you can see if we load this page,

00:06:09.589 --> 00:06:10.429
we get hello,

00:06:10.429 --> 00:06:11.389
world rendered.

00:06:11.389 --> 00:06:13.109
So this is just a very simple hello,

00:06:13.109 --> 00:06:15.109
world fetch handler that returns some

00:06:15.409 --> 00:06:16.769
response text to us.

00:06:16.955 --> 00:06:17.115
Now,

00:06:17.115 --> 00:06:18.755
before we move deeper into building out these

00:06:18.755 --> 00:06:19.035
services,

00:06:19.115 --> 00:06:21.395
let's go ahead and deploy just so we can make sure

00:06:21.395 --> 00:06:23.635
our application starts in a perfect state and

00:06:23.635 --> 00:06:24.795
everything's running as expected.

00:06:24.985 --> 00:06:26.495
in our package JSON file,

00:06:26.495 --> 00:06:29.015
we have a deploy script which is just running

00:06:29.015 --> 00:06:29.975
Wrangler Deploy.

00:06:30.025 --> 00:06:32.675
having a basic worker entry point like this

00:06:33.155 --> 00:06:35.035
really requires very little overhead and

00:06:35.035 --> 00:06:35.715
configuration.

00:06:35.715 --> 00:06:36.595
As you can see

00:06:36.705 --> 00:06:38.775
Wrangler JSON file is very,

00:06:38.775 --> 00:06:39.615
very minimal.

00:06:39.655 --> 00:06:40.335
and our

00:06:41.055 --> 00:06:43.095
startup scripts are also very basic.

00:06:43.095 --> 00:06:45.095
So this is meant to be there.

00:06:45.095 --> 00:06:46.935
So basically we have deploy and we have dev.

00:06:46.935 --> 00:06:48.655
These are the two things that we care most about

00:06:48.655 --> 00:06:49.135
right now.

00:06:49.375 --> 00:06:51.775
So we're going to say pnpm run deploy.

00:06:52.311 --> 00:06:54.111
This is asking me to authenticate,

00:06:54.111 --> 00:06:56.071
because I haven't authenticated in a little bit.

00:06:56.151 --> 00:06:59.111
Probably will not ask for you to do that because

00:06:59.111 --> 00:07:00.791
you probably just barely did this.

00:07:01.421 --> 00:07:04.531
now we have this application deployed so we can

00:07:04.531 --> 00:07:05.531
grab this URL,

00:07:05.771 --> 00:07:07.131
head over to a browser,

00:07:07.771 --> 00:07:10.331
and we should see the hello world as well.

00:07:10.441 --> 00:07:12.481
that's really all that we have to do right now to

00:07:12.481 --> 00:07:13.321
get this thing set up.

00:07:13.321 --> 00:07:14.231
And then now I'm going to show you

00:07:14.231 --> 00:07:16.648
how we can start building out these services in a

00:07:16.648 --> 00:07:17.608
really modular way.

00:07:17.608 --> 00:07:18.338
How we can test them,

00:07:18.338 --> 00:07:18.388
them,

00:07:18.388 --> 00:07:19.748
make sure everything's working as expected.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.556 --> 00:00:00.876
Okay,

00:00:00.876 --> 00:00:03.916
so now let's head back to our index TS file in our

00:00:03.916 --> 00:00:04.556
data service.

00:00:04.796 --> 00:00:07.476
So as you can see here we have a very basic fetch

00:00:07.476 --> 00:00:09.196
handler that returns hello world.

00:00:09.516 --> 00:00:11.036
So for this data service

00:00:11.356 --> 00:00:13.356
we are going to have a few different routes,

00:00:13.356 --> 00:00:15.196
meaning a few different paths that

00:00:16.176 --> 00:00:17.296
or users can hit

00:00:17.776 --> 00:00:19.416
that handle some logic.

00:00:19.416 --> 00:00:20.176
And if you

00:00:20.736 --> 00:00:22.936
look at how we currently have the user application

00:00:22.936 --> 00:00:23.456
set up

00:00:23.856 --> 00:00:25.483
where we have our worker

00:00:25.483 --> 00:00:28.072
and inside of our workers and index TS file,

00:00:28.072 --> 00:00:29.032
we're kind of saying

00:00:30.362 --> 00:00:30.682
here.

00:00:30.682 --> 00:00:34.362
If the URL that's provided by the request has a

00:00:34.362 --> 00:00:36.442
path name that starts with trpc,

00:00:36.442 --> 00:00:38.562
then we're going to handle the TRPC stuff.

00:00:38.562 --> 00:00:38.922
And

00:00:39.472 --> 00:00:41.282
essentially like imagine if you had a whole bunch

00:00:41.282 --> 00:00:41.842
of different routes,

00:00:41.842 --> 00:00:42.402
maybe you had

00:00:42.802 --> 00:00:44.562
API forward slash auth,

00:00:44.952 --> 00:00:45.782
all of that different,

00:00:46.102 --> 00:00:47.062
all these different routes.

00:00:47.592 --> 00:00:49.552
You would essentially be having a whole bunch of

00:00:49.552 --> 00:00:52.392
boilerplate of like manually parsing paths and

00:00:52.392 --> 00:00:53.552
then routing conditionally.

00:00:53.552 --> 00:00:53.912
And

00:00:54.232 --> 00:00:56.332
whenever you find yourself kind of building out

00:00:56.332 --> 00:00:57.092
that use case,

00:00:57.172 --> 00:01:00.132
you've kind of exceeded what type of logic should

00:01:00.132 --> 00:01:01.572
live inside of a fetch handler.

00:01:01.812 --> 00:01:03.812
And that's when you should bring in a different

00:01:04.112 --> 00:01:05.192
routing framework.

00:01:05.192 --> 00:01:06.432
Now there's a lot of different

00:01:06.912 --> 00:01:09.632
web frameworks that accomplish this exact thing.

00:01:10.032 --> 00:01:10.752
My favorite,

00:01:10.912 --> 00:01:12.352
not just for Cloudflare workers,

00:01:12.352 --> 00:01:14.112
but for other runtimes as well

00:01:14.412 --> 00:01:15.212
is Hono.

00:01:15.552 --> 00:01:18.552
Hono is a very lightweight web framework that I

00:01:18.552 --> 00:01:20.552
think was originally built to make the development

00:01:20.552 --> 00:01:22.472
process on cloudflare Worker so much better.

00:01:22.712 --> 00:01:23.592
But they've also

00:01:24.062 --> 00:01:26.172
become so popular that it's not just a cloudflare

00:01:26.172 --> 00:01:26.732
worker thing.

00:01:26.732 --> 00:01:28.812
Like people are actually building full stack

00:01:28.812 --> 00:01:30.212
frameworks on top of Hono.

00:01:30.212 --> 00:01:31.532
They're doing server side rendering,

00:01:31.612 --> 00:01:33.052
they're doing a whole bunch of cool stuff.

00:01:33.052 --> 00:01:36.732
But for me I almost exclusively use it for APIs,

00:01:36.842 --> 00:01:39.592
building like rest APIs that are either internal

00:01:39.592 --> 00:01:40.462
service facing,

00:01:40.462 --> 00:01:42.712
for like services to communicate with each other

00:01:43.082 --> 00:01:45.122
or in some situations actually building it

00:01:45.122 --> 00:01:46.282
externally facing.

00:01:46.362 --> 00:01:46.762
So

00:01:47.102 --> 00:01:49.402
users of an application are consuming an API as a

00:01:49.402 --> 00:01:49.642
product.

00:01:49.802 --> 00:01:52.402
So Hono can really accomplish all of these

00:01:52.402 --> 00:01:54.962
different use cases and the integration process is

00:01:54.962 --> 00:01:55.602
really easy.

00:01:55.602 --> 00:01:58.122
Now the documentation for Hono to integrate,

00:01:58.122 --> 00:01:59.402
if you look at like how to

00:01:59.492 --> 00:02:01.282
deploy Hono application on Cloudflare,

00:02:01.282 --> 00:02:03.522
they're going to have a very specific Hono way of

00:02:03.522 --> 00:02:05.642
doing it and you can totally go that route.

00:02:05.642 --> 00:02:07.962
But what I like to do is I like to basically say

00:02:07.962 --> 00:02:09.922
the entry point for a cloudflare worker

00:02:10.222 --> 00:02:11.582
is this snippet of code.

00:02:11.662 --> 00:02:14.902
And then everything that I build on top of this is

00:02:14.902 --> 00:02:15.902
going to be wired in,

00:02:15.902 --> 00:02:17.982
in a more like manual way.

00:02:18.142 --> 00:02:20.982
So we'll just make sure we have Hono installed.

00:02:20.982 --> 00:02:22.502
It should already be installed in this project,

00:02:22.502 --> 00:02:24.702
but you can run PMPM Ihono.

00:02:24.732 --> 00:02:25.490
just to make sure.

00:02:26.176 --> 00:02:27.616
Now that is installed,

00:02:28.336 --> 00:02:31.056
what we're going to do is we are going to actually

00:02:31.056 --> 00:02:32.016
create a

00:02:32.656 --> 00:02:35.416
new folder inside of Source and I'm going to call

00:02:35.416 --> 00:02:36.256
it Hono.

00:02:36.416 --> 00:02:36.696
You can,

00:02:36.766 --> 00:02:38.206
you could probably call this API as well,

00:02:38.206 --> 00:02:40.846
but this isn't just going to be like a REST API as

00:02:40.846 --> 00:02:41.006
well.

00:02:41.006 --> 00:02:42.766
There's going to be a few other use cases for it.

00:02:42.766 --> 00:02:44.126
So I'm going to call it Hono.

00:02:44.126 --> 00:02:45.406
Just make it really descriptive.

00:02:45.506 --> 00:02:46.966
and then inside of Hono,

00:02:47.046 --> 00:02:49.606
I'm going to create a app ts.

00:02:51.501 --> 00:02:52.926
Now inside of the app ts,

00:02:52.926 --> 00:02:55.126
we're obviously going to want to import Hono,

00:02:55.126 --> 00:02:56.446
so we'll go ahead and do that.

00:02:57.836 --> 00:03:00.396
And then what we're going to do is we are going to

00:03:00.396 --> 00:03:01.916
set up the actual Hono app.

00:03:02.076 --> 00:03:03.236
So a Hono app.

00:03:03.236 --> 00:03:05.116
This is the typical configuration.

00:03:05.934 --> 00:03:06.734
a lot of like,

00:03:06.734 --> 00:03:08.214
examples you're just going to see is going to say

00:03:08.214 --> 00:03:09.934
like const app new Hono.

00:03:10.014 --> 00:03:12.414
And you might not see the bindings here,

00:03:12.734 --> 00:03:13.974
which is totally okay.

00:03:13.974 --> 00:03:14.494
This is a,

00:03:14.494 --> 00:03:15.774
this is a valid setup.

00:03:15.774 --> 00:03:16.574
But for us,

00:03:16.974 --> 00:03:18.574
what we're going to do is we're going to make sure

00:03:18.574 --> 00:03:20.854
that this is exported so we can use it in our

00:03:20.854 --> 00:03:21.774
worker entry point.

00:03:22.014 --> 00:03:24.094
And then we're also going to be saying the

00:03:24.094 --> 00:03:26.174
bindings are going to be our cloudflare,

00:03:26.344 --> 00:03:27.434
EMV bindings.

00:03:27.514 --> 00:03:27.798
So,

00:03:28.219 --> 00:03:28.859
that this,

00:03:28.859 --> 00:03:29.539
so this is the,

00:03:29.539 --> 00:03:31.859
this is like the basic setup of an application.

00:03:31.859 --> 00:03:34.019
And then from here what we can do is we can build

00:03:34.019 --> 00:03:35.099
out actual routes.

00:03:35.339 --> 00:03:37.499
So the first route that we're going to build out

00:03:37.499 --> 00:03:39.819
is basically we're going to say app dot get

00:03:40.299 --> 00:03:41.259
and we're going to say

00:03:41.579 --> 00:03:41.589
colon

00:03:42.039 --> 00:03:42.399
id

00:03:42.879 --> 00:03:44.079
and then inside of this

00:03:44.574 --> 00:03:45.654
section of the handler,

00:03:45.654 --> 00:03:47.094
we're going to be able to actually handle the

00:03:47.094 --> 00:03:47.534
request.

00:03:47.534 --> 00:03:49.974
So what's happening here is basically this is a

00:03:49.974 --> 00:03:50.654
dynamic.

00:03:51.384 --> 00:03:52.464
is a dynamic path

00:03:52.784 --> 00:03:53.424
where the

00:03:53.984 --> 00:03:54.384
ID

00:03:54.704 --> 00:03:57.904
of a given link is going to be routed to.

00:03:58.064 --> 00:03:58.464
So,

00:03:59.394 --> 00:04:01.394
essentially when we create a link in our

00:04:01.394 --> 00:04:01.834
dashboard,

00:04:01.834 --> 00:04:03.754
it's just kind of this random id and then when

00:04:03.754 --> 00:04:04.754
that is clicked,

00:04:04.754 --> 00:04:07.594
it should hit this endpoint and then our service

00:04:07.594 --> 00:04:10.034
is going to be able to pull this ID and we're

00:04:10.034 --> 00:04:11.554
going to be able to look up all the routing

00:04:11.554 --> 00:04:12.834
configuration for it.

00:04:12.914 --> 00:04:13.314
So,

00:04:13.754 --> 00:04:16.114
what you're going to notice is we have a few

00:04:16.114 --> 00:04:16.394
different

00:04:16.544 --> 00:04:18.014
things with this context.

00:04:18.014 --> 00:04:20.014
So C is for context in Hono

00:04:20.594 --> 00:04:20.834
and

00:04:21.234 --> 00:04:23.154
we're going to have access to EMV

00:04:23.474 --> 00:04:24.834
where we have our bindings.

00:04:25.474 --> 00:04:28.114
We're also going to have access to the request.

00:04:28.754 --> 00:04:29.874
This is the actual like

00:04:30.284 --> 00:04:31.354
request that's being made.

00:04:31.354 --> 00:04:33.194
This is going to contain headers and cookies and

00:04:33.194 --> 00:04:33.674
whatnot.

00:04:33.834 --> 00:04:36.394
We're also going to have access to the response.

00:04:37.674 --> 00:04:40.714
So if you want to set cookies that get saved on

00:04:40.714 --> 00:04:41.434
the client side,

00:04:41.434 --> 00:04:43.274
you could also do that with the response.

00:04:43.534 --> 00:04:44.094
and then

00:04:44.414 --> 00:04:45.374
there's a few other things.

00:04:45.374 --> 00:04:47.614
Like if we want to just like say C

00:04:48.094 --> 00:04:48.654
JSON,

00:04:49.394 --> 00:04:52.194
we could just basically say return C JSON

00:04:53.474 --> 00:04:56.794
and we could give like some data hello world.

00:04:56.794 --> 00:04:58.954
So I think we'll just start with this for now.

00:04:58.954 --> 00:04:59.314
So

00:04:59.494 --> 00:05:01.234
the context is really powerful with Hono.

00:05:01.234 --> 00:05:02.874
You notice we didn't have to like import a whole

00:05:02.874 --> 00:05:04.314
bunch of stuff to get this to work.

00:05:04.314 --> 00:05:06.394
We just have like a very basic

00:05:07.344 --> 00:05:09.264
handler here and it's saying

00:05:10.054 --> 00:05:12.054
it's just returning a JSON object of hello world.

00:05:12.054 --> 00:05:13.694
And we're going to extend this further as we go

00:05:13.694 --> 00:05:13.974
along.

00:05:14.134 --> 00:05:15.974
But what we're going to want to do is we're going

00:05:15.974 --> 00:05:17.174
to want to head back to our,

00:05:17.536 --> 00:05:19.776
we're going to want to head back to our index ts

00:05:20.176 --> 00:05:20.816
and then

00:05:21.216 --> 00:05:24.176
our fetch handler is no longer just going to

00:05:24.176 --> 00:05:25.296
return hello world.

00:05:25.296 --> 00:05:27.216
What it's going to do is it's going to return

00:05:28.336 --> 00:05:30.656
app and we're going to import that from Hono

00:05:31.136 --> 00:05:31.726
and the

00:05:31.726 --> 00:05:34.786
of a Hono instance will have a fetch handler.

00:05:34.786 --> 00:05:36.546
So it's just kind of going to be a pass through

00:05:36.546 --> 00:05:37.346
fetch handler

00:05:37.666 --> 00:05:39.826
where we pass through the request.

00:05:40.466 --> 00:05:42.466
Now this isn't all we're going to pass through.

00:05:43.426 --> 00:05:44.226
a service,

00:05:44.466 --> 00:05:45.666
a worker entry point

00:05:46.066 --> 00:05:47.666
also has access to

00:05:48.066 --> 00:05:48.706
an environment.

00:05:49.266 --> 00:05:50.466
So these are our bindings.

00:05:50.786 --> 00:05:52.466
It also has access to

00:05:52.826 --> 00:05:53.626
a context.

00:05:54.026 --> 00:05:56.346
Now this returns some cloudflare specific stuff.

00:05:56.346 --> 00:05:57.546
Like we have a

00:05:58.096 --> 00:05:59.066
wait until method,

00:05:59.066 --> 00:06:01.906
which basically we can pass code snippets into

00:06:01.906 --> 00:06:05.226
this wait until method that can execute after the

00:06:05.226 --> 00:06:06.066
request is received.

00:06:06.306 --> 00:06:08.226
So if you have some background tasks that you want

00:06:08.226 --> 00:06:08.466
to run,

00:06:08.466 --> 00:06:09.906
that's only going to take a few seconds.

00:06:10.356 --> 00:06:11.716
this is a great way of doing it and we're actually

00:06:11.716 --> 00:06:12.676
going to use this

00:06:13.816 --> 00:06:14.936
in the next few videos.

00:06:14.936 --> 00:06:15.976
But for now

00:06:16.376 --> 00:06:19.376
if we notice the fetch handler actually takes in a

00:06:19.376 --> 00:06:20.056
few extra things.

00:06:20.056 --> 00:06:21.056
It takes in a request,

00:06:21.056 --> 00:06:23.376
it takes in an emv and it also takes in an

00:06:23.376 --> 00:06:24.536
execution context.

00:06:24.616 --> 00:06:26.496
So we're going to pass those things in.

00:06:26.496 --> 00:06:28.616
So we're going to say this EMV and this

00:06:29.336 --> 00:06:29.936
context.

00:06:29.936 --> 00:06:33.016
And you notice this is all type safe because Hono

00:06:33.016 --> 00:06:36.016
has made a insanely great interface that works

00:06:36.016 --> 00:06:37.656
with standard web requests,

00:06:37.906 --> 00:06:39.826
but it also works perfectly with

00:06:40.146 --> 00:06:43.266
the specific nuances of the cloudflare runtime as

00:06:43.266 --> 00:06:43.506
well.

00:06:43.586 --> 00:06:44.706
So from here

00:06:45.986 --> 00:06:48.226
it's just a very simple pass through our fetch

00:06:48.226 --> 00:06:50.906
handler for our worker entry point is just passing

00:06:50.906 --> 00:06:52.866
it into our fetch handler,

00:06:52.976 --> 00:06:53.376
for

00:06:53.696 --> 00:06:55.056
our Hono application.

00:06:55.056 --> 00:06:56.016
So now if we

00:06:56.336 --> 00:06:58.256
PNPM run dev,

00:06:58.870 --> 00:06:59.988
this should start up

00:07:00.388 --> 00:07:01.388
and this Hono,

00:07:01.388 --> 00:07:03.628
this hello world should be not found because we

00:07:03.628 --> 00:07:05.748
don't have our homepage built out.

00:07:06.278 --> 00:07:06.518
But

00:07:06.838 --> 00:07:09.638
if you just do any type of random id,

00:07:10.918 --> 00:07:12.838
what you're going to notice is we actually get

00:07:12.838 --> 00:07:13.158
that

00:07:13.558 --> 00:07:13.568
hello,

00:07:13.878 --> 00:07:15.358
world JSON response.

00:07:15.998 --> 00:07:17.728
So this is how we set up Hono.

00:07:17.888 --> 00:07:19.008
it's very,

00:07:19.248 --> 00:07:20.008
very simple.

00:07:20.008 --> 00:07:20.888
Like you know,

00:07:20.888 --> 00:07:22.568
you're going to read a whole bunch of like how to

00:07:22.568 --> 00:07:23.008
do this,

00:07:23.238 --> 00:07:25.328
like how to articles or watch videos or go through

00:07:25.328 --> 00:07:26.008
the documentation.

00:07:26.008 --> 00:07:26.488
But just

00:07:26.808 --> 00:07:27.208
the

00:07:28.808 --> 00:07:30.848
limited amount of code that we've had to write to

00:07:30.848 --> 00:07:32.008
actually get this to work

00:07:32.258 --> 00:07:32.738
is awesome.

00:07:32.738 --> 00:07:33.178
You know,

00:07:33.178 --> 00:07:35.298
just a very simple Hono app

00:07:35.618 --> 00:07:36.258
creation,

00:07:36.578 --> 00:07:37.618
defining a route.

00:07:37.618 --> 00:07:39.538
And we can define as many routes as we want.

00:07:39.598 --> 00:07:40.908
and then you could even break this up.

00:07:40.908 --> 00:07:43.068
So if your application is like a really big API,

00:07:43.228 --> 00:07:45.068
you can create folders where you create

00:07:45.388 --> 00:07:46.108
multiple,

00:07:46.638 --> 00:07:49.318
Hono instances and then all of those get wired

00:07:49.318 --> 00:07:50.358
into the same route.

00:07:50.428 --> 00:07:50.948
that's like,

00:07:50.948 --> 00:07:51.588
they have a lot,

00:07:51.588 --> 00:07:53.028
lot of information on how to do that in the

00:07:53.028 --> 00:07:53.548
documentation,

00:07:53.548 --> 00:07:55.668
but it's such a robust framework that we're

00:07:55.668 --> 00:07:56.308
building on top of.

00:07:56.308 --> 00:07:58.708
And then the integration for it is also painfully

00:07:58.708 --> 00:07:58.988
simple.

00:07:58.988 --> 00:07:59.468
It's just

00:08:00.088 --> 00:08:02.328
passing the request into our fetch handler and

00:08:02.328 --> 00:08:04.648
then also making sure that we include our

00:08:05.128 --> 00:08:06.688
environment and our context.

00:08:06.688 --> 00:08:07.648
If you don't include these,

00:08:07.648 --> 00:08:08.568
especially the environment,

00:08:08.898 --> 00:08:10.738
when you actually try to access your binding

00:08:10.738 --> 00:08:12.418
inside of your Hono application,

00:08:12.658 --> 00:08:14.178
you'll be getting errors because

00:08:14.658 --> 00:08:16.978
the context no longer would have access to that.

00:08:17.458 --> 00:08:18.978
So that's where we're going to stop this one.

00:08:19.138 --> 00:08:20.198
and then coming up,

00:08:20.198 --> 00:08:22.918
we're going to extend this to actually handle our

00:08:24.328 --> 00:08:25.862
dynamic routing logic.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.087 --> 00:00:00.487
All right,

00:00:00.567 --> 00:00:02.407
so now that we have our

00:00:02.967 --> 00:00:05.887
Hono application wired into our cloudflare worker

00:00:05.887 --> 00:00:07.207
fetch entry point right here,

00:00:07.527 --> 00:00:09.807
let's go ahead and understand the request object

00:00:09.807 --> 00:00:11.806
and the headers that we have access to that will

00:00:11.806 --> 00:00:14.127
make this entire dynamic routing system actually

00:00:14.127 --> 00:00:14.807
come to life.

00:00:15.047 --> 00:00:17.447
So first thing that I want to do is I want to take

00:00:17.447 --> 00:00:19.327
a look at the context and then I just want to see

00:00:19.327 --> 00:00:19.527
like,

00:00:19.527 --> 00:00:19.847
okay,

00:00:19.847 --> 00:00:21.517
what properties are available to us.

00:00:21.697 --> 00:00:23.177
there's a whole bunch of different things here

00:00:23.177 --> 00:00:25.017
that are useful and we're going to make use of

00:00:25.017 --> 00:00:25.497
some of them.

00:00:25.497 --> 00:00:27.057
But the one that is

00:00:27.437 --> 00:00:28.397
going to actually like,

00:00:28.397 --> 00:00:31.397
power this dynamic routing system is actually the

00:00:31.397 --> 00:00:32.397
headers of the request.

00:00:32.637 --> 00:00:33.037
So,

00:00:33.207 --> 00:00:35.337
inside of the context you can see the rec,

00:00:35.417 --> 00:00:36.217
which is the

00:00:36.617 --> 00:00:39.097
request provided by the cloudflare worker.

00:00:39.097 --> 00:00:39.337
Now,

00:00:39.337 --> 00:00:42.297
Hono does some pre processing to the request.

00:00:42.617 --> 00:00:46.257
So the request at this layer of our application is

00:00:46.257 --> 00:00:48.777
actually not the same as the request here.

00:00:48.907 --> 00:00:50.517
they actually have slightly different properties.

00:00:50.517 --> 00:00:53.597
Hono attaches a few different helper methods to

00:00:53.597 --> 00:00:53.947
make,

00:00:53.947 --> 00:00:55.927
working with like cookies and headers really

00:00:55.927 --> 00:00:56.327
simple.

00:00:56.817 --> 00:00:57.817
But for our use case,

00:00:57.817 --> 00:00:59.537
what we're going to want to do is like,

00:00:59.537 --> 00:01:00.977
we're going to want to look at,

00:01:02.437 --> 00:01:02.997
raw.

00:01:03.157 --> 00:01:03.557
So

00:01:03.877 --> 00:01:06.877
Hono also provides like this RAW object,

00:01:06.877 --> 00:01:08.597
which is the RAW request,

00:01:08.597 --> 00:01:12.117
meaning the actual like request that was provided

00:01:12.357 --> 00:01:14.677
inside of this Hono fetch handler.

00:01:14.677 --> 00:01:17.157
So from the cloudflare request we have our

00:01:17.157 --> 00:01:18.437
standard request object,

00:01:18.997 --> 00:01:19.397
and

00:01:19.977 --> 00:01:21.797
that request object is being passed into Hono.

00:01:21.797 --> 00:01:23.837
And Hono does a little bit of processing and gives

00:01:23.837 --> 00:01:26.317
us access to APIs and methods that make working

00:01:26.317 --> 00:01:27.127
with the request easy,

00:01:27.277 --> 00:01:27.717
easier.

00:01:27.717 --> 00:01:28.077
But

00:01:28.110 --> 00:01:31.606
if we want RAW access to the original request,

00:01:31.606 --> 00:01:33.766
you can do so by accessing RAW here.

00:01:34.166 --> 00:01:36.246
and then inside of raw you're going to see that we

00:01:36.246 --> 00:01:36.886
have headers.

00:01:36.966 --> 00:01:38.086
Now these headers,

00:01:38.086 --> 00:01:39.846
if we just JSON parse these headers,

00:01:39.846 --> 00:01:40.886
you can see what's in here.

00:01:45.280 --> 00:01:46.720
So we're just going to go ahead and,

00:01:46.960 --> 00:01:48.250
stringify the headers.

00:01:48.490 --> 00:01:50.090
We can hit our

00:01:51.110 --> 00:01:51.670
route here.

00:01:52.150 --> 00:01:54.910
And you can see there's not any useful headers in

00:01:54.910 --> 00:01:55.350
this information,

00:01:55.430 --> 00:01:56.870
which is okay because,

00:01:57.460 --> 00:02:00.510
the Cloudflare specific environments are actually

00:02:00.670 --> 00:02:01.070
available

00:02:01.870 --> 00:02:04.270
under this CF property.

00:02:04.270 --> 00:02:04.550
Now,

00:02:04.550 --> 00:02:05.830
CF stands for Cloudflare,

00:02:05.830 --> 00:02:08.310
and this is the additional header information that

00:02:08.310 --> 00:02:09.310
is actually like

00:02:09.690 --> 00:02:12.330
attached from Cloudflare servers when a request is

00:02:12.330 --> 00:02:12.650
made.

00:02:12.810 --> 00:02:15.370
So if we go ahead and we hit this endpoint again,

00:02:15.544 --> 00:02:16.864
what you're going to see is we actually have a

00:02:16.864 --> 00:02:18.744
whole bunch of useful information here.

00:02:18.984 --> 00:02:19.384
Now,

00:02:19.554 --> 00:02:21.184
this is going to be kind of hard to read,

00:02:21.424 --> 00:02:23.864
so we can you know what we can do is we can copy

00:02:23.864 --> 00:02:25.744
it just to get a better understanding of it.

00:02:25.744 --> 00:02:27.904
We could just Google JSON parser

00:02:28.154 --> 00:02:29.738
and we have this JSON converter.

00:02:30.188 --> 00:02:32.468
looks like Claude AI actually is having an

00:02:32.468 --> 00:02:33.988
advertisement on jsonconverter.

00:02:33.988 --> 00:02:34.688
That's kind of funny.

00:02:34.688 --> 00:02:37.568
JSON formatter.org is a tried and true

00:02:38.128 --> 00:02:38.768
website for this.

00:02:38.768 --> 00:02:39.168
So

00:02:39.588 --> 00:02:41.808
what you can see here is we have a whole bunch of

00:02:41.808 --> 00:02:44.648
diff of useful information that is provided inside

00:02:44.648 --> 00:02:45.128
of the

00:02:45.208 --> 00:02:47.948
Cloudflare object inside of a request.

00:02:48.668 --> 00:02:49.068
And

00:02:49.398 --> 00:02:52.038
specifically what we're looking at is kind of like

00:02:52.038 --> 00:02:53.638
the location based stuff.

00:02:53.638 --> 00:02:54.678
So I'm currently

00:02:55.078 --> 00:02:55.878
on a trip

00:02:56.158 --> 00:02:56.898
in Washington.

00:02:56.898 --> 00:02:59.298
So you can see that the closest Cloudflare

00:02:59.378 --> 00:03:00.018
location,

00:03:00.178 --> 00:03:01.918
so the server that is actually handling the

00:03:01.918 --> 00:03:04.438
request managed by Cloudflare is located in

00:03:04.438 --> 00:03:05.078
Seattle.

00:03:05.367 --> 00:03:07.047
gives us information about the time zone

00:03:07.367 --> 00:03:08.807
and it gives us the

00:03:09.437 --> 00:03:12.517
the nearest latitude and longitude of the server

00:03:12.517 --> 00:03:13.917
that is making that request.

00:03:14.607 --> 00:03:15.097
and then

00:03:15.657 --> 00:03:17.857
you get some additional information that's really

00:03:17.857 --> 00:03:19.257
useful like the postal code,

00:03:20.027 --> 00:03:20.667
the city,

00:03:21.387 --> 00:03:21.787
some,

00:03:21.867 --> 00:03:24.147
you get access to the actual like Internet

00:03:24.147 --> 00:03:25.147
provider as well.

00:03:25.147 --> 00:03:27.707
So these are all super useful things but a region

00:03:27.707 --> 00:03:28.507
code as well.

00:03:28.507 --> 00:03:30.777
Now the thing that we are going to be

00:03:30.777 --> 00:03:33.247
most interested in is actually the country.

00:03:34.643 --> 00:03:37.443
you can see here that we have this flag country.

00:03:37.683 --> 00:03:40.563
There's also this is EU country which I'm assuming

00:03:40.563 --> 00:03:43.963
they're using for like GDPR compliance to

00:03:43.963 --> 00:03:45.363
basically know like oh,

00:03:45.643 --> 00:03:47.923
requests from the specific region have specific

00:03:48.083 --> 00:03:49.123
compliance related things.

00:03:49.123 --> 00:03:51.843
So they have a very specific is EU country there

00:03:51.843 --> 00:03:52.883
which is kind of interesting.

00:03:52.883 --> 00:03:55.323
So if you have a very sensitive application where

00:03:55.323 --> 00:03:57.883
you're really worried about GDPR compliance for a

00:03:57.883 --> 00:03:58.643
given use case,

00:03:58.643 --> 00:04:00.283
I think that's something that you could also latch

00:04:00.283 --> 00:04:00.643
onto.

00:04:00.643 --> 00:04:02.763
But what we care about here is we care about the

00:04:02.763 --> 00:04:03.043
country

00:04:03.763 --> 00:04:05.803
and we also care about the latitude and longitude.

00:04:05.803 --> 00:04:07.843
This is information that we're going to save when

00:04:07.843 --> 00:04:10.403
we receive a request to actually determine our

00:04:10.403 --> 00:04:11.363
routing logic.

00:04:11.719 --> 00:04:12.999
So heading back to our

00:04:13.459 --> 00:04:14.859
heading back to our app,

00:04:14.859 --> 00:04:16.019
let's just go ahead and say

00:04:16.788 --> 00:04:17.189
const

00:04:18.229 --> 00:04:19.429
country equals

00:04:19.989 --> 00:04:21.114
c rec.raw.cf

00:04:21.114 --> 00:04:25.540
rec.raw.cf and then

00:04:27.610 --> 00:04:28.650
we can say country.

00:04:29.050 --> 00:04:30.030
So it looks like

00:04:30.050 --> 00:04:32.530
CF object is an optional object and then

00:04:32.930 --> 00:04:34.210
attached to that is country.

00:04:34.290 --> 00:04:35.250
So this could be

00:04:35.950 --> 00:04:38.990
this is of type undefined or of type unknown.

00:04:38.990 --> 00:04:41.670
But in our use case it's going to either be a

00:04:41.670 --> 00:04:43.310
string or it's going to be undefined.

00:04:43.390 --> 00:04:43.790
Now

00:04:44.460 --> 00:04:46.460
I think what we want to do is we can just

00:04:46.460 --> 00:04:48.140
basically we can go ahead and say

00:04:50.140 --> 00:04:50.540
const

00:04:51.100 --> 00:04:54.300
CF is going to equal CF just so we don't have to

00:04:54.300 --> 00:04:55.900
type this a million different times.

00:04:57.084 --> 00:04:58.444
And let's do the same for

00:04:59.164 --> 00:05:03.324
latitude and longitude so c.um

00:05:03.964 --> 00:05:05.258
or cf.

00:05:05.658 --> 00:05:07.018
Latitude and

00:05:07.498 --> 00:05:08.213
constitute.

00:05:08.213 --> 00:05:08.569
constitute.

00:05:08.569 --> 00:05:10.455
constitute.

00:05:10.855 --> 00:05:13.135
Now I'm just going to go ahead in here and I'm

00:05:13.135 --> 00:05:14.135
going to return this information.

00:05:14.375 --> 00:05:15.810
So we can basically say

00:05:16.262 --> 00:05:16.502
country

00:05:17.416 --> 00:05:19.608
lat and longitude.

00:05:19.608 --> 00:05:21.175
We can head back to our

00:05:21.815 --> 00:05:23.015
worker that is

00:05:23.185 --> 00:05:24.375
we head back to the browser,

00:05:24.455 --> 00:05:26.295
hit that worker and you can see we actually are

00:05:26.295 --> 00:05:27.255
able to grab that information.

00:05:27.575 --> 00:05:30.535
So the next step here that now that we have access

00:05:30.615 --> 00:05:31.495
to the

00:05:31.885 --> 00:05:32.765
cloudflare

00:05:33.165 --> 00:05:33.805
specific

00:05:34.475 --> 00:05:35.093
tags

00:05:35.177 --> 00:05:37.457
is to actually build out the conditional routing

00:05:37.457 --> 00:05:37.897
logic.

00:05:37.897 --> 00:05:38.697
So we're going to

00:05:38.857 --> 00:05:41.677
introduce a database lookup here but we're also to

00:05:41.677 --> 00:05:44.517
speed things up we're also going to add a KV cache

00:05:44.517 --> 00:05:47.157
just so we can have really instantaneous

00:05:47.157 --> 00:05:48.077
redirects.

00:05:48.077 --> 00:05:49.757
So let's go ahead and start that process.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.844 --> 00:00:03.484
so now let's actually integrate some of our data

00:00:03.484 --> 00:00:06.324
operations into this code so we can build out the

00:00:06.324 --> 00:00:07.324
routing logic.

00:00:07.324 --> 00:00:11.004
So I'm going to just get rid of this stuff as we

00:00:11.004 --> 00:00:11.724
really don't

00:00:12.044 --> 00:00:13.244
need it at the moment.

00:00:14.124 --> 00:00:15.804
we're going to start from scratch here.

00:00:15.884 --> 00:00:17.404
So just to kind of recap,

00:00:17.404 --> 00:00:20.724
the ID that is passed through here is going to be

00:00:20.724 --> 00:00:22.524
the actual link id

00:00:23.024 --> 00:00:25.584
and we have that data stored in our database.

00:00:25.824 --> 00:00:26.224
So

00:00:26.614 --> 00:00:27.184
we also,

00:00:27.344 --> 00:00:28.224
if you remember,

00:00:28.464 --> 00:00:31.026
inside of our Data Ops package

00:00:31.026 --> 00:00:34.405
we actually have some useful methods that we built

00:00:34.405 --> 00:00:35.725
out and we have,

00:00:35.805 --> 00:00:37.884
or we should have already built out

00:00:38.365 --> 00:00:39.245
the actual

00:00:39.585 --> 00:00:40.225
the actual

00:00:40.865 --> 00:00:43.345
query to get the link information given,

00:00:43.585 --> 00:00:44.385
given an id.

00:00:44.625 --> 00:00:47.275
So we have a get link takes a link ID and,

00:00:47.345 --> 00:00:49.185
and then just simply returns the

00:00:49.965 --> 00:00:50.685
configuration,

00:00:50.685 --> 00:00:53.005
the routing configuration for that link.

00:00:53.245 --> 00:00:53.645
So

00:00:54.045 --> 00:00:57.245
what we can do here is we can import that link,

00:00:57.775 --> 00:00:58.975
that get link call.

00:00:59.055 --> 00:01:01.375
So see if it will auto import for us.

00:01:01.375 --> 00:01:02.015
So const

00:01:03.135 --> 00:01:06.495
link info from DB is what we can call it.

00:01:06.735 --> 00:01:08.375
And we're going to say get link.

00:01:08.375 --> 00:01:10.895
So that's going to be coming from our repo Data

00:01:10.895 --> 00:01:11.935
Ops package

00:01:12.255 --> 00:01:12.545
and,

00:01:12.775 --> 00:01:15.575
and we're also going to have to make sure that we

00:01:15.835 --> 00:01:17.435
collect our id.

00:01:17.675 --> 00:01:18.635
So with Hono,

00:01:19.035 --> 00:01:22.155
what we can do is we can basically say the context

00:01:22.155 --> 00:01:23.595
request param.

00:01:23.595 --> 00:01:26.195
So this is one of those methods that HONO gives us

00:01:26.195 --> 00:01:27.915
that makes accessing like

00:01:28.725 --> 00:01:30.245
the context of our request

00:01:30.565 --> 00:01:33.605
or like the headers or the actual path variables

00:01:33.605 --> 00:01:35.965
or search parameters or even the payload for a

00:01:35.965 --> 00:01:36.565
post request,

00:01:36.565 --> 00:01:38.725
all that stuff instead of like having a whole

00:01:38.725 --> 00:01:39.205
bunch of

00:01:39.685 --> 00:01:41.725
manual parsing and just making sure everything's

00:01:41.725 --> 00:01:42.485
of the right type.

00:01:42.485 --> 00:01:44.525
HONU does a really good job at kind of inferring

00:01:44.525 --> 00:01:45.325
types for us.

00:01:45.325 --> 00:01:48.405
So it knows this route always needs an id

00:01:48.805 --> 00:01:49.205
and

00:01:49.295 --> 00:01:51.915
it always knows that obviously a path parameter

00:01:51.915 --> 00:01:52.875
has to be a string.

00:01:52.875 --> 00:01:56.835
So ID here is a type safe string type and it

00:01:56.835 --> 00:01:58.035
should always be defined.

00:01:58.195 --> 00:01:58.595
So

00:01:58.702 --> 00:02:00.796
we can go ahead and pass the ID into the

00:02:01.306 --> 00:02:01.936
get link

00:02:02.976 --> 00:02:06.576
into the get link method that calls our database

00:02:06.736 --> 00:02:06.996
and,

00:02:07.146 --> 00:02:09.346
and then inside of this JSON object for now we'll

00:02:09.346 --> 00:02:11.946
just make sure we're able to properly return

00:02:12.506 --> 00:02:14.186
link info from database.

00:02:14.186 --> 00:02:15.506
So when we run this,

00:02:15.506 --> 00:02:17.386
because this is a nonsensical link,

00:02:17.386 --> 00:02:19.626
we'll get an empty object here

00:02:19.946 --> 00:02:20.706
which is totally.

00:02:20.706 --> 00:02:21.226
Okay,

00:02:21.226 --> 00:02:22.426
I'm gonna pull my,

00:02:22.586 --> 00:02:24.106
pull this over just a little bit.

00:02:24.446 --> 00:02:26.296
but if you head to your SmartLink application,

00:02:26.296 --> 00:02:28.736
hopefully you've already created a link and we

00:02:28.736 --> 00:02:29.496
have this link,

00:02:29.496 --> 00:02:30.136
all of these

00:02:30.136 --> 00:02:32.946
different URLs so you can copy One of those,

00:02:32.946 --> 00:02:34.226
this link shouldn't work.

00:02:34.306 --> 00:02:37.226
But the thing that you care about right now is you

00:02:37.226 --> 00:02:37.746
can grab,

00:02:38.626 --> 00:02:40.346
the tail end of this path,

00:02:40.346 --> 00:02:41.986
which is the actual link id,

00:02:42.056 --> 00:02:42.886
head back over here,

00:02:42.886 --> 00:02:46.246
put the link ID at the end of the path parameter,

00:02:46.726 --> 00:02:48.886
and what you're going to notice is we also don't

00:02:48.886 --> 00:02:49.526
get any data.

00:02:49.606 --> 00:02:50.486
Now why is that?

00:02:50.576 --> 00:02:51.666
this is kind of where

00:02:52.146 --> 00:02:55.106
the specific worker configuration comes into play.

00:02:55.296 --> 00:02:58.006
so if you head over to the Wrangler JSON

00:02:58.326 --> 00:02:59.174
C file,

00:02:59.926 --> 00:03:01.486
what you're going to notice is we haven't

00:03:01.486 --> 00:03:02.566
configured our database.

00:03:02.646 --> 00:03:03.046
So,

00:03:03.236 --> 00:03:05.266
at this point let's go ahead and follow the exact

00:03:05.266 --> 00:03:05.906
same path

00:03:06.196 --> 00:03:06.436
that

00:03:06.896 --> 00:03:09.616
took for our user application and configure a

00:03:09.616 --> 00:03:10.136
database.

00:03:10.136 --> 00:03:10.376
Now,

00:03:10.376 --> 00:03:12.056
I would say just pause this video and see if you

00:03:12.056 --> 00:03:12.896
can't do it on your own,

00:03:12.896 --> 00:03:14.936
just to kind of solidify that skill.

00:03:15.496 --> 00:03:15.896
but

00:03:16.296 --> 00:03:18.216
what I'll do is I'll go through that process right

00:03:18.216 --> 00:03:18.536
now.

00:03:18.616 --> 00:03:21.296
So we're going to say D1 databases and then we're

00:03:21.296 --> 00:03:22.856
going to make sure we have that type.

00:03:22.856 --> 00:03:25.456
Instead of me trying to look into the Cloudflare

00:03:25.456 --> 00:03:25.736
environment,

00:03:26.136 --> 00:03:28.776
I'm just going to head over to the Wrangler,

00:03:29.436 --> 00:03:31.116
configuration for our user application

00:03:31.486 --> 00:03:32.926
and I'm going to copy that stuff over.

00:03:33.406 --> 00:03:33.685
So

00:03:33.685 --> 00:03:34.884
copy that information over.

00:03:35.025 --> 00:03:35.425
And

00:03:35.815 --> 00:03:37.675
you can see that we're pulling this database id,

00:03:37.755 --> 00:03:39.435
we're calling this binding db.

00:03:39.995 --> 00:03:41.595
And most importantly,

00:03:41.805 --> 00:03:44.795
for the local setup is we have our experimental

00:03:44.795 --> 00:03:45.875
remote set to true.

00:03:45.875 --> 00:03:47.515
This means we're actually going to be able to

00:03:47.515 --> 00:03:48.395
connect to our

00:03:48.795 --> 00:03:51.115
database that is managed by Cloudflare and it's

00:03:51.115 --> 00:03:53.675
not going to pull from like a local SQLite file

00:03:53.755 --> 00:03:55.835
running inside of our repository here.

00:03:55.995 --> 00:03:56.395
So,

00:03:56.605 --> 00:03:57.715
we have that guy running.

00:03:58.165 --> 00:04:02.005
So let's go ahead and say PNPM run CF type jit

00:04:02.725 --> 00:04:04.245
same exact process as before.

00:04:04.485 --> 00:04:04.885
So,

00:04:05.785 --> 00:04:06.825
this inside of our

00:04:07.575 --> 00:04:08.975
Wrangler configuration,

00:04:08.975 --> 00:04:12.135
you can see we have a D1 database type and

00:04:12.375 --> 00:04:13.975
for the purpose of this project and we'll go a

00:04:13.975 --> 00:04:15.775
little bit deeper into why later in the course,

00:04:15.775 --> 00:04:17.735
but I actually have a second

00:04:18.555 --> 00:04:21.595
binding setup where I extend the Cloudflare's EMV

00:04:21.595 --> 00:04:22.315
with my own.

00:04:22.395 --> 00:04:23.685
And we're going to like,

00:04:23.685 --> 00:04:25.125
there's a really good reason for this,

00:04:25.125 --> 00:04:27.845
but we're not going to dive too deep as to why

00:04:27.845 --> 00:04:28.485
that's the case.

00:04:28.485 --> 00:04:28.845
But

00:04:29.325 --> 00:04:31.245
if we head back over to our app TS,

00:04:31.325 --> 00:04:32.125
you're going to see

00:04:32.445 --> 00:04:34.445
C EMV DB

00:04:34.765 --> 00:04:36.525
will give us access to our

00:04:36.915 --> 00:04:37.885
D1 database.

00:04:37.965 --> 00:04:38.365
Now,

00:04:38.605 --> 00:04:39.845
the D1 database,

00:04:39.845 --> 00:04:41.965
it just gives us access to run these raw queries,

00:04:42.205 --> 00:04:44.405
and we want to make sure that this guy works.

00:04:44.405 --> 00:04:44.725
Now,

00:04:44.725 --> 00:04:45.565
spoiler alert,

00:04:45.645 --> 00:04:47.405
this code is going to fail.

00:04:47.405 --> 00:04:48.005
So if we say,

00:04:48.005 --> 00:04:48.725
pnpm,

00:04:48.725 --> 00:04:49.985
run device,

00:04:50.375 --> 00:04:51.695
go ahead and hit this endpoint,

00:04:51.695 --> 00:04:54.175
we should get a 500 or we should see some error

00:04:54.175 --> 00:04:55.015
outs here.

00:04:56.129 --> 00:04:57.489
make sure that stuff is saved.

00:04:57.541 --> 00:04:59.578
And it looks like we're currently not getting an

00:04:59.578 --> 00:04:59.938
error.

00:04:59.938 --> 00:05:02.298
And the reason why is because we are actually not

00:05:02.298 --> 00:05:03.698
awaiting get link.

00:05:03.778 --> 00:05:05.938
So this request is happening after

00:05:06.888 --> 00:05:08.568
after we are responding.

00:05:08.808 --> 00:05:10.168
So what we're going to do is we're going to make

00:05:10.168 --> 00:05:10.958
sure we await,

00:05:10.958 --> 00:05:12.648
because this is an asynchronous call

00:05:13.128 --> 00:05:15.328
and when we hit this we should get an internal

00:05:15.328 --> 00:05:15.968
server error.

00:05:15.968 --> 00:05:16.408
There we go.

00:05:16.408 --> 00:05:18.368
So this is kind of what the behavior that you

00:05:18.368 --> 00:05:18.808
would expect.

00:05:19.228 --> 00:05:21.068
if you dig into these error logs,

00:05:21.068 --> 00:05:22.588
what you're going to notice is we have this

00:05:22.588 --> 00:05:24.188
database not initialized.

00:05:24.188 --> 00:05:27.148
So if you remember from earlier on in the course

00:05:27.148 --> 00:05:28.908
when we were setting up the user application,

00:05:29.548 --> 00:05:30.668
we have our

00:05:30.988 --> 00:05:32.268
data ops package

00:05:33.148 --> 00:05:34.588
which has a

00:05:35.138 --> 00:05:36.708
database initializer here.

00:05:36.788 --> 00:05:38.988
And this has to be called when we've,

00:05:38.988 --> 00:05:39.348
for the,

00:05:39.348 --> 00:05:41.428
for the very first time when we set up our project

00:05:41.428 --> 00:05:43.108
and when the worker is invoked.

00:05:43.188 --> 00:05:43.588
So

00:05:43.998 --> 00:05:46.908
if we head back over to our index file inside of

00:05:46.908 --> 00:05:47.668
our data service,

00:05:47.908 --> 00:05:50.548
what we're going to do is we are going to create a

00:05:50.548 --> 00:05:51.268
constructor.

00:05:51.828 --> 00:05:53.028
Now the constructor,

00:05:53.428 --> 00:05:54.468
this is just basic,

00:05:55.678 --> 00:05:57.908
object oriented programming convention here.

00:05:57.908 --> 00:06:00.588
So the constructor is going to be invoked when the

00:06:00.588 --> 00:06:02.468
class is instantiated for the first time,

00:06:02.468 --> 00:06:04.508
meaning when this worker is triggered,

00:06:04.508 --> 00:06:05.988
whether it be through a fetch handler

00:06:06.308 --> 00:06:09.228
or from a queue or a schedule or whatever it may

00:06:09.228 --> 00:06:09.468
be,

00:06:09.468 --> 00:06:10.948
whenever this worker is triggered,

00:06:11.498 --> 00:06:13.258
this chunk of code is going to execute.

00:06:13.258 --> 00:06:14.298
And you can see that

00:06:14.318 --> 00:06:15.558
passed into the constructor of

00:06:15.558 --> 00:06:18.198
this worker entry point is the execution context

00:06:18.198 --> 00:06:19.798
and is also the environment,

00:06:20.338 --> 00:06:22.258
so the bindings that we have access to.

00:06:22.258 --> 00:06:24.738
So what I'm going to do is I'm going to say so

00:06:24.738 --> 00:06:25.058
super.

00:06:25.297 --> 00:06:27.418
So this is something that you have to specify

00:06:27.418 --> 00:06:28.418
whenever you are

00:06:29.018 --> 00:06:31.338
working inside of a constructor to make sure that

00:06:31.338 --> 00:06:33.818
the class is going to have the exact same behavior

00:06:33.898 --> 00:06:36.858
you pass in the original properties,

00:06:36.958 --> 00:06:37.898
into the super method.

00:06:37.898 --> 00:06:39.218
And then what we're going to do is we're going to

00:06:39.218 --> 00:06:39.938
say initial

00:06:40.248 --> 00:06:43.168
database and we're going to say EMV DB.

00:06:43.168 --> 00:06:45.528
So we're going to pass in that D1 SQL database.

00:06:45.608 --> 00:06:47.128
Now when we load this guy

00:06:47.528 --> 00:06:48.808
we should get our data.

00:06:48.808 --> 00:06:49.328
And there we go,

00:06:49.328 --> 00:06:50.008
we got our data.

00:06:50.168 --> 00:06:52.008
So now this is the intended behavior

00:06:52.058 --> 00:06:53.448
that we would expect to see because

00:06:53.768 --> 00:06:55.528
our database was initialized

00:06:56.008 --> 00:06:57.288
when we received the request.

00:06:57.288 --> 00:06:59.488
And before processing that request everything is

00:06:59.488 --> 00:07:03.008
set up and we are able to call our helper methods

00:07:03.008 --> 00:07:04.488
that interact with our database.

00:07:04.488 --> 00:07:04.888
So

00:07:05.018 --> 00:07:06.748
this is a really clean design in my opinion,

00:07:06.748 --> 00:07:09.028
because all of our queries are kind of isolated in

00:07:09.028 --> 00:07:10.508
their own section they're reusable.

00:07:10.578 --> 00:07:12.688
we're able to use this on the front end and we're

00:07:12.688 --> 00:07:14.328
able to use this deeper in the back end for

00:07:14.328 --> 00:07:15.008
certain operations.

00:07:15.008 --> 00:07:16.006
This get link call

00:07:16.006 --> 00:07:17.716
and from here we return,

00:07:18.326 --> 00:07:19.686
link info from db.

00:07:19.846 --> 00:07:21.366
So this is how we

00:07:21.686 --> 00:07:22.256
set up,

00:07:22.346 --> 00:07:26.066
the basic database configuration for our backend

00:07:26.066 --> 00:07:26.586
application.

00:07:26.586 --> 00:07:27.466
And it's going to be,

00:07:27.866 --> 00:07:30.546
it's going to basically be what drives all of the

00:07:30.546 --> 00:07:31.546
logic going forward,

00:07:32.186 --> 00:07:33.666
are the interactions that we have with our

00:07:33.666 --> 00:07:34.426
database here.

00:07:34.506 --> 00:07:34.906
So,

00:07:35.146 --> 00:07:38.146
just remember that this isn't necessarily a SQL or

00:07:38.146 --> 00:07:40.116
a DB D1 database convention.

00:07:40.456 --> 00:07:42.856
I follow this pattern when I set up really any

00:07:44.056 --> 00:07:46.136
serverless database with Cloudflare workers.

00:07:46.514 --> 00:07:46.914
All right,

00:07:46.914 --> 00:07:48.474
so coming up in this next video,

00:07:48.474 --> 00:07:50.314
we're actually going to get into the meat of

00:07:50.314 --> 00:07:52.154
building out the routing logic.

00:07:52.154 --> 00:07:54.354
So we're going to be looking at the Cloudflare,

00:07:54.864 --> 00:07:56.054
specific tag properties,

00:07:56.134 --> 00:07:57.334
determining where the user is,

00:07:57.334 --> 00:08:00.334
and then we're going to route them to the desired

00:08:00.334 --> 00:08:02.294
destination link instead of just returning this

00:08:02.294 --> 00:08:03.254
JSON object

00:08:03.814 --> 00:08:06.694
based upon the data that we get back from our

00:08:06.694 --> 00:08:07.574
database call.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.114 --> 00:00:00.514
All right,

00:00:00.514 --> 00:00:04.194
so now that our route has access to the actual

00:00:05.164 --> 00:00:08.444
smartlink configuration with all of the attributed

00:00:08.444 --> 00:00:09.884
routing logic,

00:00:10.284 --> 00:00:12.083
what we can do is we can go ahead and we can

00:00:12.083 --> 00:00:14.724
actually build out the routing behavior within our

00:00:14.724 --> 00:00:15.324
application.

00:00:15.484 --> 00:00:15.884
So

00:00:16.244 --> 00:00:18.004
the very first thing that we're going to do is

00:00:18.004 --> 00:00:19.684
we're going to do some basic error handling.

00:00:20.004 --> 00:00:22.164
So I'm going to go ahead and call this,

00:00:22.474 --> 00:00:24.394
instead of link info from db,

00:00:24.394 --> 00:00:25.994
I'm just going to call this link info.

00:00:26.314 --> 00:00:26.954
And then

00:00:27.564 --> 00:00:31.044
what we can do is we can say if link info is null.

00:00:31.044 --> 00:00:33.724
So basically if somebody throws in like a wrong

00:00:34.044 --> 00:00:35.344
link that isn't found,

00:00:35.744 --> 00:00:38.624
we're going to want to have some basic 404 logic

00:00:38.624 --> 00:00:40.544
where we say the destination not found.

00:00:40.544 --> 00:00:43.104
Now if this was going to be a true user facing

00:00:43.104 --> 00:00:43.744
application,

00:00:44.064 --> 00:00:46.624
you would want to return a component that is

00:00:46.624 --> 00:00:47.064
styled,

00:00:47.064 --> 00:00:47.744
that is like,

00:00:47.744 --> 00:00:48.984
looks nice with your branding,

00:00:48.984 --> 00:00:49.744
that says like,

00:00:50.364 --> 00:00:50.804
like the,

00:00:50.804 --> 00:00:51.204
sorry,

00:00:51.204 --> 00:00:52.484
this leak is not found or whatever,

00:00:52.484 --> 00:00:53.844
but for now it's just going to be text.

00:00:53.844 --> 00:00:56.284
Because I just do not want to balloon this

00:00:56.864 --> 00:00:59.464
course past the point where like it's not adding

00:00:59.464 --> 00:01:00.024
that much value.

00:01:00.024 --> 00:01:01.824
I just want to be able to crank out as much

00:01:01.824 --> 00:01:04.704
information as possible related to building intent

00:01:04.704 --> 00:01:06.144
services on top of Cloudflare.

00:01:06.944 --> 00:01:09.224
so additionally what we're going to want to do is

00:01:09.224 --> 00:01:10.624
we're also going to want to

00:01:11.004 --> 00:01:14.364
create or grab the header information related to

00:01:14.364 --> 00:01:15.644
the actual routing.

00:01:15.644 --> 00:01:16.044
So

00:01:16.454 --> 00:01:18.294
we haven't actually gone over this yet.

00:01:18.614 --> 00:01:19.014
So

00:01:19.084 --> 00:01:21.234
what we can do is we can head over to our

00:01:23.134 --> 00:01:26.374
ops package and then inside of here we are

00:01:26.374 --> 00:01:28.134
actually going to create a new folder

00:01:28.694 --> 00:01:31.814
and that folder is going to be called Schemas.

00:01:32.054 --> 00:01:32.454
So

00:01:33.034 --> 00:01:36.274
actually I think a better name for it is just

00:01:36.274 --> 00:01:36.914
going to be Zod.

00:01:36.914 --> 00:01:37.514
So basically

00:01:37.884 --> 00:01:40.074
we use ODD in this application to make sure things

00:01:40.074 --> 00:01:42.834
are type safe and we can like parse data to ensure

00:01:43.074 --> 00:01:46.474
that a object coming from an unknown source is of

00:01:46.474 --> 00:01:47.394
a certain type.

00:01:47.674 --> 00:01:49.754
and a lot of times we're going to want to share

00:01:49.994 --> 00:01:52.194
these types across different projects.

00:01:52.194 --> 00:01:55.354
So that basically what we want to do is we want to

00:01:55.354 --> 00:01:57.194
head back over to our Data Ops package.

00:01:57.324 --> 00:02:00.594
and inside of source we can create a new folder

00:02:00.594 --> 00:02:01.634
called Zod.

00:02:01.714 --> 00:02:02.594
So I'm going to say

00:02:03.154 --> 00:02:03.634
Zod

00:02:03.775 --> 00:02:05.547
and it looks like it should already actually be

00:02:05.547 --> 00:02:06.187
part of this

00:02:06.207 --> 00:02:06.667
this project.

00:02:07.067 --> 00:02:08.267
So inside of here

00:02:08.707 --> 00:02:10.897
we're going to have links and a lot of these are

00:02:10.897 --> 00:02:13.097
going to be predefined for us just so we don't

00:02:13.097 --> 00:02:15.057
waste too much time typing a whole Bunch of stuff

00:02:15.057 --> 00:02:15.337
out.

00:02:15.967 --> 00:02:17.727
but the one that we care about is actually going

00:02:17.727 --> 00:02:19.767
to be called Cloudflare info schema.

00:02:19.767 --> 00:02:21.727
So what I've done here is I have added

00:02:22.207 --> 00:02:23.487
a Zod schema

00:02:23.887 --> 00:02:25.647
that grabs the information that we've already

00:02:25.647 --> 00:02:27.007
discussed that we care about,

00:02:27.077 --> 00:02:27.807
the actual country,

00:02:28.287 --> 00:02:30.047
the latitude and the longitude.

00:02:30.047 --> 00:02:31.406
And then I just have some

00:02:31.457 --> 00:02:33.447
additional like helpers here to make sure,

00:02:33.687 --> 00:02:35.167
like the latitude and the longitude,

00:02:35.167 --> 00:02:36.487
it comes in as a string,

00:02:36.997 --> 00:02:39.747
that we are going to be parsing that into a number

00:02:40.217 --> 00:02:42.777
before it is actually accessed by our code.

00:02:42.837 --> 00:02:45.217
so we have a little pre processor or transform

00:02:45.217 --> 00:02:47.457
method here and then we have a country and these

00:02:47.457 --> 00:02:48.137
are all optional

00:02:48.457 --> 00:02:51.537
just so we can ensure we have like a type safe,

00:02:51.537 --> 00:02:53.197
object of this information

00:02:53.597 --> 00:02:55.677
because the data that's coming from the Cloudflare

00:02:55.677 --> 00:02:57.037
headers is of the type unknown.

00:02:57.157 --> 00:02:59.077
so we can't really make use of it.

00:02:59.637 --> 00:03:02.277
Now what we could do is we could head back to our,

00:03:02.847 --> 00:03:06.287
we can head back to our app TS in our data service

00:03:06.447 --> 00:03:06.737
and,

00:03:06.807 --> 00:03:07.847
and we can import this

00:03:08.327 --> 00:03:09.047
schema.

00:03:09.447 --> 00:03:10.887
So we'll go ahead and say

00:03:11.207 --> 00:03:14.647
from our Repo Data Ops Zod schema folder,

00:03:14.647 --> 00:03:16.887
we're going to say here are our links

00:03:17.527 --> 00:03:18.547
or here are our

00:03:18.687 --> 00:03:19.979
Cloudflare info schema

00:03:19.979 --> 00:03:21.304
and we can pass in

00:03:21.828 --> 00:03:22.140
the.

00:03:22.220 --> 00:03:23.420
So I'm going to say const

00:03:24.938 --> 00:03:25.328
cf

00:03:25.888 --> 00:03:26.528
headers

00:03:26.848 --> 00:03:28.608
and it's just going to be the headers that we care

00:03:28.608 --> 00:03:28.928
about.

00:03:29.088 --> 00:03:30.098
So we're going to say dot

00:03:30.368 --> 00:03:30.768
parse

00:03:31.488 --> 00:03:33.568
I'm going to actually safe parse this just so we

00:03:33.568 --> 00:03:35.888
don't throw an error because there's a very valid

00:03:35.888 --> 00:03:37.768
scenario where we might not have all the headers

00:03:37.768 --> 00:03:38.608
that we need and

00:03:39.168 --> 00:03:41.448
we still are able to route people to the default

00:03:41.448 --> 00:03:41.888
destination.

00:03:42.288 --> 00:03:43.928
So I'm going to say safe parse and then I'm going

00:03:43.928 --> 00:03:47.488
to say c.rec.raw

00:03:48.208 --> 00:03:48.848
cf.

00:03:48.848 --> 00:03:50.048
So we'll pass it that information

00:03:50.608 --> 00:03:51.968
and then the output,

00:03:52.448 --> 00:03:53.448
we're going to handle it.

00:03:53.448 --> 00:03:56.948
So we're going to say if CF header.

00:03:57.218 --> 00:03:58.602
we'll say error.

00:03:58.602 --> 00:04:00.922
Now let's say say if it's not successful.

00:04:00.922 --> 00:04:02.682
So if it's not successful,

00:04:03.722 --> 00:04:06.322
what we want to do is we're going to do a very

00:04:06.322 --> 00:04:08.842
similar error here where we're going to return c

00:04:08.842 --> 00:04:09.641
dot text

00:04:10.362 --> 00:04:11.642
and it's going to be

00:04:12.890 --> 00:04:14.490
I actually wonder if we,

00:04:14.890 --> 00:04:16.370
for now we'll handle this error.

00:04:16.370 --> 00:04:18.490
But I just wonder like in a scenario where you

00:04:18.490 --> 00:04:19.610
actually have a,

00:04:19.770 --> 00:04:20.108
like

00:04:20.184 --> 00:04:21.544
these headers fail to actually

00:04:22.164 --> 00:04:22.864
be parsable,

00:04:22.864 --> 00:04:25.064
we probably want to route them to like the Default

00:04:25.064 --> 00:04:25.584
destination.

00:04:25.984 --> 00:04:26.744
So we'll,

00:04:26.744 --> 00:04:27.664
we'll probably add that later,

00:04:27.664 --> 00:04:29.344
but for now I'm just going to say C.

00:04:29.504 --> 00:04:29.984
Txt

00:04:30.644 --> 00:04:32.384
we're just going to return the text invalid

00:04:32.384 --> 00:04:33.384
Cloudflare headers.

00:04:33.384 --> 00:04:35.504
Now I think we can actually handle this a little

00:04:35.504 --> 00:04:35.864
bit better,

00:04:35.864 --> 00:04:37.304
but let's be on the point for now.

00:04:37.684 --> 00:04:39.584
and then what we're going to want to do is now

00:04:39.584 --> 00:04:41.344
that we have the headers is we're going to want to

00:04:41.344 --> 00:04:43.242
look at the actual country code

00:04:43.426 --> 00:04:44.386
so we can say

00:04:44.966 --> 00:04:45.366
const

00:04:46.806 --> 00:04:47.446
headers

00:04:48.486 --> 00:04:49.046
equals

00:04:49.926 --> 00:04:50.646
dot data.

00:04:51.286 --> 00:04:51.686
So

00:04:52.136 --> 00:04:53.736
this will give us access to the country

00:04:54.136 --> 00:04:55.496
and in order to.

00:04:56.136 --> 00:04:57.536
So basically what we're going to want to do is

00:04:57.536 --> 00:04:58.856
we're going to want to look up

00:04:59.336 --> 00:04:59.736
the

00:04:59.976 --> 00:05:03.296
the routing logic inside of our link info that is

00:05:03.296 --> 00:05:06.216
provided from our database query for those link

00:05:06.216 --> 00:05:06.976
configurations.

00:05:07.376 --> 00:05:09.136
And we're going to want to see if the destination

00:05:09.136 --> 00:05:11.056
is in there and if it's not we're going to fall

00:05:11.056 --> 00:05:12.336
back to the default dest.

00:05:12.876 --> 00:05:13.116
And

00:05:13.396 --> 00:05:14.816
this code is insanely simple,

00:05:14.816 --> 00:05:15.696
but it's also

00:05:16.016 --> 00:05:18.056
kind of a little bit tedious to write.

00:05:18.056 --> 00:05:20.296
And I just feel like this is going to become very,

00:05:20.296 --> 00:05:22.096
very cluttered if we put all of our

00:05:22.556 --> 00:05:22.716
app,

00:05:22.716 --> 00:05:25.036
we put all of our logic under a single route.

00:05:25.196 --> 00:05:25.596
So

00:05:25.976 --> 00:05:28.296
what I want to do is I'm going to create a new

00:05:28.296 --> 00:05:30.456
folder and we'll just call this Helpers for now.

00:05:31.656 --> 00:05:33.016
And inside of Helpers

00:05:33.656 --> 00:05:36.456
let's call this Routing Ops

00:05:37.096 --> 00:05:37.816
ts

00:05:37.896 --> 00:05:38.476
if you notice,

00:05:38.476 --> 00:05:40.156
I like the word ops for different types of

00:05:40.156 --> 00:05:41.076
operations that happen.

00:05:41.516 --> 00:05:41.836
I think

00:05:42.236 --> 00:05:46.556
naming functions and variables and files in the

00:05:47.206 --> 00:05:49.136
software development world is very controversial.

00:05:49.136 --> 00:05:49.816
People have very,

00:05:49.816 --> 00:05:50.896
very strong opinions.

00:05:51.536 --> 00:05:51.936
Okay,

00:05:51.936 --> 00:05:52.776
for the purpose of time,

00:05:52.776 --> 00:05:53.856
let's just go ahead and

00:05:54.556 --> 00:05:56.996
I'm just going to paste over this code that I have

00:05:56.996 --> 00:05:57.676
pre written.

00:05:57.756 --> 00:05:59.676
This is going to do our conditional

00:05:59.986 --> 00:06:00.736
routing logic.

00:06:00.736 --> 00:06:02.696
So we actually have this leak schema,

00:06:02.696 --> 00:06:03.166
typed

00:06:03.276 --> 00:06:06.476
Skype type defined inside of our Data Ops package.

00:06:06.766 --> 00:06:08.286
And this is going to be coming from our Zod

00:06:08.286 --> 00:06:08.846
schemas.

00:06:09.486 --> 00:06:11.926
And we can look at this and this has like the

00:06:11.926 --> 00:06:12.166
name,

00:06:12.166 --> 00:06:12.926
the link id,

00:06:12.926 --> 00:06:14.446
the account ID and the destination.

00:06:14.446 --> 00:06:16.606
So this is all of the information that is actually

00:06:16.606 --> 00:06:17.326
in our

00:06:17.526 --> 00:06:21.026
that is saved in our D1 database when we create a

00:06:21.026 --> 00:06:21.386
link.

00:06:21.406 --> 00:06:23.046
you can go ahead and head over to the

00:06:23.786 --> 00:06:26.186
Query Explorer inside the Cloudflare dashboard and

00:06:26.186 --> 00:06:27.706
you can go inspect the data if you want to,

00:06:27.706 --> 00:06:28.426
just to make sure.

00:06:28.756 --> 00:06:29.396
but yeah,

00:06:29.636 --> 00:06:30.916
this is the type and

00:06:31.326 --> 00:06:32.846
then what we're going to do is we're basically

00:06:32.846 --> 00:06:34.446
going to also pass in the country code,

00:06:34.446 --> 00:06:36.406
which can be optional from cloudflare.

00:06:36.406 --> 00:06:37.446
So the cloud,

00:06:37.446 --> 00:06:37.806
the

00:06:38.453 --> 00:06:40.954
the country code will not be there or could

00:06:40.954 --> 00:06:41.514
possibly

00:06:41.654 --> 00:06:42.414
be undefined.

00:06:42.494 --> 00:06:44.094
So if it's undefined,

00:06:44.094 --> 00:06:46.053
what we're going to do is we're basically going to

00:06:46.053 --> 00:06:48.934
say give us the default URL and that's going to be

00:06:48.934 --> 00:06:50.174
what we use for the routing.

00:06:50.174 --> 00:06:50.654
And then

00:06:51.814 --> 00:06:52.854
as well as that,

00:06:52.854 --> 00:06:54.334
what we're going to also do is we're going to say

00:06:54.334 --> 00:06:55.334
the link info

00:06:55.514 --> 00:06:57.674
destinations and then we're going to pass in the

00:06:57.674 --> 00:06:58.314
country code.

00:06:58.314 --> 00:06:59.514
And if that's not null,

00:06:59.514 --> 00:07:01.594
meaning there is a country code in that

00:07:01.594 --> 00:07:02.314
configuration,

00:07:02.554 --> 00:07:04.514
then we're going to return that link and then the

00:07:04.514 --> 00:07:06.474
fallback is just going to be our

00:07:07.534 --> 00:07:09.134
link info destinations.

00:07:09.294 --> 00:07:12.254
So we can go ahead and we can use this in our

00:07:12.254 --> 00:07:12.654
code.

00:07:12.734 --> 00:07:13.694
So head back over,

00:07:13.694 --> 00:07:14.830
we'll say make sure it's saved,

00:07:14.830 --> 00:07:16.669
head back over to our app ts

00:07:16.669 --> 00:07:18.292
and then what we're going to do is we're going to

00:07:18.292 --> 00:07:18.572
say

00:07:18.972 --> 00:07:20.002
construction

00:07:20.552 --> 00:07:22.472
destinations equal

00:07:23.112 --> 00:07:24.632
and we'll import this code

00:07:25.446 --> 00:07:25.846
and

00:07:26.406 --> 00:07:28.406
we have to make sure that we pass our

00:07:28.806 --> 00:07:29.557
link info

00:07:29.557 --> 00:07:32.325
because this is the type from our database call.

00:07:32.485 --> 00:07:34.085
And then we will also return

00:07:34.405 --> 00:07:34.804
our

00:07:35.915 --> 00:07:39.115
headers.country so we'll pass that in.

00:07:40.155 --> 00:07:41.995
So now this should

00:07:42.344 --> 00:07:43.224
I deleted country

00:07:43.288 --> 00:07:44.193
headers country

00:07:45.393 --> 00:07:48.073
so now this will always return a string so there

00:07:48.073 --> 00:07:50.473
will always be a URL at this point that we get

00:07:50.473 --> 00:07:52.793
back where we can actually handle our conditional

00:07:52.793 --> 00:07:53.313
routing.

00:07:53.753 --> 00:07:56.153
so then instead of just returning this JSON block

00:07:56.153 --> 00:07:56.633
for now,

00:07:56.633 --> 00:07:58.593
what we're going to do is we are going to say

00:07:58.593 --> 00:07:58.953
return

00:07:59.433 --> 00:08:00.793
C redirect

00:08:01.273 --> 00:08:03.193
and we will pass in the destination.

00:08:03.993 --> 00:08:06.153
we're just going to call this destination singular

00:08:06.233 --> 00:08:08.473
because it's just one single destination that's

00:08:08.473 --> 00:08:09.273
going to be routed to.

00:08:09.673 --> 00:08:11.993
So now if we come back and we reload this,

00:08:11.993 --> 00:08:15.033
we should actually be routed to a destination URL

00:08:15.033 --> 00:08:17.313
which is just this like dummy in grok URL.

00:08:17.313 --> 00:08:19.753
So what I'm going to do is I'm going to go back to

00:08:19.753 --> 00:08:20.073
here.

00:08:20.313 --> 00:08:20.873
So I

00:08:21.193 --> 00:08:23.353
will come back to our Smart Links application

00:08:23.833 --> 00:08:25.993
and let's just go ahead and let's modify

00:08:26.613 --> 00:08:29.173
let's modify product 3 to give it a better

00:08:30.423 --> 00:08:31.465
URL here so

00:08:31.465 --> 00:08:33.454
we can come over here and I'm just going to say

00:08:33.454 --> 00:08:34.534
this is going to go to

00:08:34.934 --> 00:08:36.614
google.com so

00:08:37.268 --> 00:08:38.548
we can add our

00:08:38.868 --> 00:08:40.416
destination to google.com

00:08:40.416 --> 00:08:41.586
go ahead and save that.

00:08:41.906 --> 00:08:42.306
And

00:08:43.126 --> 00:08:43.486
our.

00:08:43.486 --> 00:08:44.646
This is our link ID.

00:08:45.206 --> 00:08:47.606
So go to port 8787,

00:08:48.166 --> 00:08:49.926
the application that's running locally,

00:08:50.726 --> 00:08:53.083
hit that and you can see it routes to Google.

00:08:53.118 --> 00:08:53.398
All right,

00:08:53.398 --> 00:08:55.878
so now that we know that our redirect logic is

00:08:55.878 --> 00:08:57.958
working and we're successfully able to pull a link

00:08:57.958 --> 00:08:59.398
configuration from our database,

00:08:59.398 --> 00:09:02.078
let's just go ahead and ensure that our geo based

00:09:02.078 --> 00:09:03.358
routing logic holds up.

00:09:03.438 --> 00:09:03.838
And

00:09:04.318 --> 00:09:05.958
order to do that let's just go ahead and deploy

00:09:05.958 --> 00:09:07.598
just to make sure the app is always staying in a

00:09:07.598 --> 00:09:08.038
good state.

00:09:08.198 --> 00:09:09.958
So what we can do is

00:09:10.598 --> 00:09:12.918
just make sure you don't have any type errors.

00:09:12.968 --> 00:09:15.138
you can always head over to your wrangler,

00:09:15.568 --> 00:09:17.938
JSON C just to make sure there's nothing weird

00:09:17.938 --> 00:09:18.208
here.

00:09:18.418 --> 00:09:19.138
the service

00:09:19.438 --> 00:09:19.878
is going to,

00:09:19.878 --> 00:09:21.998
or we've already deployed so it's going to be

00:09:22.158 --> 00:09:24.718
reachable by the service name data service here

00:09:24.878 --> 00:09:26.878
and then we'll just say pnpm run,

00:09:27.118 --> 00:09:27.758
deploy.

00:09:28.638 --> 00:09:30.478
looks like I did a little typo there

00:09:32.532 --> 00:09:34.039
and you'll be able to see that

00:09:34.169 --> 00:09:36.279
as we deploy that we're actually going to be

00:09:36.279 --> 00:09:37.319
having the binding

00:09:37.669 --> 00:09:39.109
for that D1 database.

00:09:39.189 --> 00:09:39.589
So,

00:09:39.948 --> 00:09:42.508
so it looks like it has successfully deployed.

00:09:42.668 --> 00:09:44.099
Let's grab our URL,

00:09:44.099 --> 00:09:45.173
let's head over here.

00:09:45.481 --> 00:09:48.201
This should be a 404 for now because we don't have

00:09:48.201 --> 00:09:49.121
any handling here.

00:09:49.121 --> 00:09:51.321
It's just a very skinned down web service.

00:09:52.051 --> 00:09:55.441
we will head over to this link that we have in our

00:09:55.441 --> 00:09:56.401
user application.

00:09:56.658 --> 00:09:58.618
This should route to Google because the default

00:09:58.618 --> 00:10:00.178
URL is still Google.

00:10:01.138 --> 00:10:04.098
And in order to test the geo based routing let's

00:10:04.098 --> 00:10:05.378
go ahead and

00:10:06.068 --> 00:10:07.428
go to NordVPN.

00:10:07.668 --> 00:10:08.508
So you don't,

00:10:08.508 --> 00:10:09.428
if you don't have a VPN,

00:10:09.428 --> 00:10:10.668
you don't have to follow along here.

00:10:10.668 --> 00:10:11.508
It's kind of

00:10:11.788 --> 00:10:12.468
beyond the point.

00:10:12.468 --> 00:10:14.308
Now I have noticed that

00:10:15.028 --> 00:10:16.668
some VPN providers,

00:10:16.668 --> 00:10:18.548
when they say you're connected to a region,

00:10:18.948 --> 00:10:21.228
you're actually not connected to that region.

00:10:21.228 --> 00:10:22.468
You're connected to another country.

00:10:22.468 --> 00:10:25.268
Especially like in Europe or Asia where there's a

00:10:25.268 --> 00:10:26.828
bunch of countries that are really close to each

00:10:26.828 --> 00:10:27.108
other.

00:10:27.108 --> 00:10:29.048
So what we're going to do is we're going to say

00:10:29.048 --> 00:10:31.128
Malaysia and I hope this works for this example.

00:10:31.478 --> 00:10:33.518
we're going to connect to Malaysia and then we're

00:10:33.518 --> 00:10:34.118
going to say

00:10:34.838 --> 00:10:38.678
anybody that routes from Malaysia with that link

00:10:38.758 --> 00:10:41.158
instead of going to Google they should go to

00:10:41.158 --> 00:10:41.798
LinkedIn.

00:10:41.878 --> 00:10:42.598
Now there's

00:10:43.158 --> 00:10:45.798
there in reality like this is probably going to be

00:10:45.798 --> 00:10:46.918
like a product page

00:10:47.238 --> 00:10:47.678
for people

00:10:48.398 --> 00:10:50.318
that is like country specific.

00:10:50.398 --> 00:10:51.918
So this is just kind of a stupid

00:10:52.018 --> 00:10:52.488
example.

00:10:52.488 --> 00:10:54.408
But what we'll do here is we're going to go ahead

00:10:54.408 --> 00:10:55.448
and we're going to add

00:10:56.088 --> 00:10:56.808
Malaysia

00:10:59.348 --> 00:11:01.428
and the destination is going to be LinkedIn

00:11:01.948 --> 00:11:02.952
so we'll hit save.

00:11:03.752 --> 00:11:04.952
So that is now there.

00:11:05.592 --> 00:11:07.592
So if we grab our link id

00:11:07.858 --> 00:11:10.737
forward slash this link id and this should

00:11:11.058 --> 00:11:11.898
go to LinkedIn.

00:11:11.898 --> 00:11:12.218
Yep.

00:11:12.218 --> 00:11:12.598
So that

00:11:12.598 --> 00:11:14.878
GEO based logic is working as expected,

00:11:14.878 --> 00:11:15.998
which is pretty cool there.

00:11:15.998 --> 00:11:16.398
So,

00:11:16.718 --> 00:11:17.358
okay,

00:11:17.438 --> 00:11:17.818
so

00:11:18.198 --> 00:11:20.358
if you might have noticed when we loaded this,

00:11:21.148 --> 00:11:24.108
the time that it actually took to do the redirect

00:11:24.108 --> 00:11:25.228
there was a bit of a pause.

00:11:25.228 --> 00:11:25.548
And

00:11:26.348 --> 00:11:28.508
that's largely just because like we're,

00:11:28.588 --> 00:11:29.068
you know,

00:11:29.068 --> 00:11:30.268
like it is there,

00:11:30.268 --> 00:11:31.988
there's like some network latency there.

00:11:31.988 --> 00:11:32.348
But

00:11:32.608 --> 00:11:34.848
there's also just the sheer fact that we're using

00:11:34.848 --> 00:11:36.008
a D1 database.

00:11:36.008 --> 00:11:37.568
There's going to be just like a little bit of

00:11:37.568 --> 00:11:39.048
latency that you're going to notice for that

00:11:39.048 --> 00:11:39.968
network travel time.

00:11:40.348 --> 00:11:42.228
so for this next section we're going to speed up

00:11:42.228 --> 00:11:45.788
these queries by caching that link configuration

00:11:46.468 --> 00:11:47.948
in a Cloudflare kv,

00:11:47.948 --> 00:11:50.028
which is a perfect use case for something like

00:11:50.028 --> 00:11:50.308
this.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.030 --> 00:00:00.390
all right,

00:00:00.390 --> 00:00:01.950
so as we saw from the last video,

00:00:02.110 --> 00:00:04.390
this gitlink is calling our database and is

00:00:04.390 --> 00:00:05.710
getting the link configuration.

00:00:05.790 --> 00:00:07.870
And that was pretty snappy when I was making a

00:00:07.870 --> 00:00:09.030
request from the United States,

00:00:09.030 --> 00:00:12.470
but it was a bit slower when we were on a VPN in

00:00:12.470 --> 00:00:14.110
Malaysia and made that same request.

00:00:14.590 --> 00:00:17.150
Now the reason why is because our D1 database is

00:00:17.150 --> 00:00:18.350
sitting in the United States.

00:00:18.510 --> 00:00:21.110
So the network travel from Malaysia or Asia or

00:00:21.110 --> 00:00:23.550
Europe to the database and back is going to be,

00:00:23.910 --> 00:00:25.470
there's going to be a little bit of extra latency

00:00:25.470 --> 00:00:25.750
there.

00:00:25.750 --> 00:00:29.270
Now we can actually sort this type of issue out on

00:00:29.270 --> 00:00:30.460
top of Cloudflare's

00:00:30.500 --> 00:00:33.020
data ecosystem with a Cloudflare KV,

00:00:33.020 --> 00:00:35.140
because Cloudflare KVs are just a very,

00:00:35.140 --> 00:00:37.060
very simple key value pair cache,

00:00:37.430 --> 00:00:38.840
that is eventually consistent.

00:00:38.840 --> 00:00:41.080
And I actually have a pretty good video on my

00:00:41.080 --> 00:00:42.640
YouTube channel where we explain

00:00:42.800 --> 00:00:45.360
when to use eventually consistent caching.

00:00:45.680 --> 00:00:48.320
And this is one of the use cases where like

00:00:48.720 --> 00:00:51.600
this would actually make sense because essentially

00:00:51.980 --> 00:00:54.400
we're not updating the data frequently.

00:00:54.440 --> 00:00:56.280
sometimes with eventually consistent caching

00:00:56.280 --> 00:00:59.640
you'll write data into a key value store and that

00:00:59.640 --> 00:01:01.800
data is going to be replicated across servers

00:01:01.800 --> 00:01:04.720
around the world and it might take a few seconds

00:01:04.720 --> 00:01:05.480
for it to actually

00:01:05.960 --> 00:01:06.840
make it to

00:01:07.020 --> 00:01:08.700
a server that's close to your users.

00:01:08.700 --> 00:01:09.060
And

00:01:09.480 --> 00:01:10.080
for like,

00:01:10.160 --> 00:01:13.640
types of operations where you need your writes to

00:01:13.640 --> 00:01:15.170
be immediately ready,

00:01:15.320 --> 00:01:16.120
that's not going to work.

00:01:16.220 --> 00:01:18.640
and also if you're updating data frequently for

00:01:18.640 --> 00:01:19.360
the same key,

00:01:19.360 --> 00:01:20.520
that's also not going to work.

00:01:20.520 --> 00:01:21.640
So I would encourage you,

00:01:21.640 --> 00:01:22.320
if you're interested,

00:01:22.320 --> 00:01:24.640
to kind of like learn the nuances to watch this

00:01:24.640 --> 00:01:24.920
video.

00:01:25.160 --> 00:01:26.520
It goes really in depth.

00:01:26.520 --> 00:01:26.920
But

00:01:27.240 --> 00:01:28.100
without further ado,

00:01:28.100 --> 00:01:31.100
let's go ahead and implement a KV store on top of

00:01:31.100 --> 00:01:31.380
this,

00:01:32.120 --> 00:01:34.880
dynamic routing logic to speed things up and make

00:01:34.880 --> 00:01:36.200
it globally distributed.

00:01:36.280 --> 00:01:36.680
So

00:01:37.080 --> 00:01:39.240
we can head over to the Cloudflare dashboard

00:01:39.560 --> 00:01:39.880
and,

00:01:40.030 --> 00:01:41.150
and like always,

00:01:41.230 --> 00:01:41.920
this type of

00:01:41.920 --> 00:01:44.770
workflow you could also do from the Wrangler cli.

00:01:44.770 --> 00:01:47.210
But I do find working inside of the dashboard to

00:01:47.210 --> 00:01:48.240
be pretty simple.

00:01:48.240 --> 00:01:50.410
and I do think that's where most people gravitate

00:01:50.410 --> 00:01:50.850
towards.

00:01:51.010 --> 00:01:54.210
So what we can do is we can head over to our

00:01:55.510 --> 00:01:56.710
storage databases

00:01:57.190 --> 00:01:59.710
and previously we created a SQL D1 database.

00:01:59.710 --> 00:02:01.110
But what we're going to do is we're going to

00:02:01.110 --> 00:02:02.910
create a key value pair.

00:02:02.910 --> 00:02:05.110
Now this is also part of their free offering.

00:02:05.110 --> 00:02:05.510
So

00:02:06.010 --> 00:02:07.690
I have a test cache created.

00:02:07.690 --> 00:02:09.570
But what I'm going to do is I'm going to say this

00:02:09.570 --> 00:02:10.650
is going to be

00:02:12.490 --> 00:02:13.130
smart

00:02:13.930 --> 00:02:14.650
links

00:02:15.450 --> 00:02:16.090
cache

00:02:16.410 --> 00:02:16.970
stage.

00:02:17.050 --> 00:02:17.770
Now remember,

00:02:17.770 --> 00:02:18.170
I'm

00:02:18.600 --> 00:02:20.720
having a suffix of stage for all of these

00:02:20.720 --> 00:02:22.880
resources because later on the course we're going

00:02:22.880 --> 00:02:25.280
to actually create a stage environment and a

00:02:25.280 --> 00:02:27.160
production environment so we can test things

00:02:27.880 --> 00:02:28.980
in a more like

00:02:29.230 --> 00:02:31.150
professional and enterprise way.

00:02:31.230 --> 00:02:33.030
So I'm going to go ahead and create that key value

00:02:33.030 --> 00:02:33.470
pair.

00:02:33.843 --> 00:02:35.176
I'll copy the ID right now

00:02:35.736 --> 00:02:37.896
we'll head over to our wrangler

00:02:38.396 --> 00:02:38.956
JSON.

00:02:39.276 --> 00:02:41.676
And remember this is inside of our data service

00:02:41.756 --> 00:02:42.716
package or

00:02:42.766 --> 00:02:44.396
application because that's where we're working

00:02:44.396 --> 00:02:44.916
right now.

00:02:45.476 --> 00:02:48.276
And I will go ahead and I will say

00:02:49.606 --> 00:02:50.886
KV namespaces

00:02:51.686 --> 00:02:54.166
is going to be part so the binding,

00:02:54.166 --> 00:02:55.526
we'll just call this cache

00:02:56.786 --> 00:02:58.306
and it's going to be

00:02:59.666 --> 00:03:02.306
the ID we'll pass in the ID and then

00:03:02.626 --> 00:03:06.066
we will also say experimental remote equals true

00:03:06.226 --> 00:03:08.146
just so we can access the actual

00:03:08.616 --> 00:03:10.916
KV store that is hosted by cloudflare.

00:03:11.316 --> 00:03:13.636
Then we're going to say PNPM run CF

00:03:13.710 --> 00:03:14.430
type gen.

00:03:14.670 --> 00:03:16.830
Make sure you are in your data service

00:03:17.070 --> 00:03:18.030
directory here.

00:03:18.990 --> 00:03:22.510
And now we have this cache namespace.

00:03:22.590 --> 00:03:22.990
So

00:03:23.560 --> 00:03:26.251
if we head back over to our app ts,

00:03:26.251 --> 00:03:28.598
what you're going to notice is we have this

00:03:28.918 --> 00:03:30.118
C EMV

00:03:30.438 --> 00:03:31.718
cache is now available.

00:03:31.733 --> 00:03:34.074
Now the order of operation here is actually going

00:03:34.074 --> 00:03:35.074
to be first,

00:03:35.074 --> 00:03:36.114
when we get a request,

00:03:36.114 --> 00:03:38.474
we're going to check our key value pair to see if

00:03:38.474 --> 00:03:40.514
the data is stored in the cache.

00:03:40.754 --> 00:03:41.714
And if it's not,

00:03:41.794 --> 00:03:43.554
we're going to fall back to our database call.

00:03:43.874 --> 00:03:47.194
And then if the database call renders or returns

00:03:47.194 --> 00:03:47.634
some data,

00:03:48.034 --> 00:03:52.034
we'll store that in our KB cache and then we will

00:03:52.364 --> 00:03:53.814
continue the flow as follows.

00:03:53.814 --> 00:03:54.174
So

00:03:54.574 --> 00:03:56.454
this type of conditional logic is something where

00:03:56.454 --> 00:03:58.614
I usually don't like to put it inside of the route

00:03:58.614 --> 00:04:00.494
just because the route becomes kind of bloated.

00:04:00.494 --> 00:04:03.094
This is about as complex as I want this route to

00:04:03.094 --> 00:04:03.374
be.

00:04:04.014 --> 00:04:06.694
So we can head over to our helpers and we'll go to

00:04:06.694 --> 00:04:07.614
our route ops.

00:04:08.094 --> 00:04:10.653
And first off I'm going to go ahead and I'm going

00:04:10.653 --> 00:04:12.014
to create a method called

00:04:13.434 --> 00:04:14.974
get link info from kb.

00:04:14.974 --> 00:04:16.574
Now this is going to take our

00:04:16.854 --> 00:04:17.714
Cloudflare environment

00:04:18.194 --> 00:04:20.754
and it's going to take a id and that's basically

00:04:20.754 --> 00:04:22.634
going to be like the key that we look something up

00:04:22.634 --> 00:04:22.914
on.

00:04:23.384 --> 00:04:25.144
Now what we can do is we can say const

00:04:25.704 --> 00:04:26.904
link info

00:04:28.104 --> 00:04:28.744
equals

00:04:29.944 --> 00:04:30.584
await

00:04:30.689 --> 00:04:32.209
EMV cache

00:04:32.529 --> 00:04:32.929
get

00:04:33.329 --> 00:04:34.689
and we're going to pass in that id.

00:04:35.809 --> 00:04:37.969
Now if it is not found,

00:04:38.529 --> 00:04:39.889
we can just return null.

00:04:41.195 --> 00:04:42.875
And then what we're going to want to do is we're

00:04:42.875 --> 00:04:44.635
going to add some try catch logic here.

00:04:44.955 --> 00:04:46.275
So we could do try catch.

00:04:46.275 --> 00:04:47.445
We could also do safe parser.

00:04:47.475 --> 00:04:49.595
it doesn't really matter for this use case,

00:04:49.595 --> 00:04:50.795
but if you remember,

00:04:50.795 --> 00:04:53.395
we actually have a Zod schema for our

00:04:53.875 --> 00:04:55.845
link data that's stored in the database.

00:04:55.845 --> 00:04:56.175
this is,

00:04:56.175 --> 00:04:57.855
you're going to notice we're going to be importing

00:04:57.855 --> 00:04:59.775
these schemas from our package,

00:04:59.985 --> 00:05:00.775
inside of our,

00:05:00.775 --> 00:05:03.095
from our monorepo inside of our data ops package,

00:05:03.335 --> 00:05:04.775
just to keep things really clean,

00:05:04.775 --> 00:05:06.615
make sure everything's super type safe and we're

00:05:06.615 --> 00:05:08.655
not running into any issues where like a type is

00:05:08.655 --> 00:05:09.015
wrong.

00:05:09.335 --> 00:05:11.695
Essentially what's happening here is the data

00:05:11.695 --> 00:05:13.495
that's returned is a string.

00:05:13.985 --> 00:05:14.225
And

00:05:14.625 --> 00:05:15.945
what we're going to do is we're going to parse

00:05:15.945 --> 00:05:16.465
that string,

00:05:16.545 --> 00:05:18.785
put it in a JSON format if it's found,

00:05:19.025 --> 00:05:20.785
and then we're going to run it through a,

00:05:21.065 --> 00:05:24.585
Zod parser just to make sure this is fully type

00:05:24.585 --> 00:05:25.025
safe.

00:05:25.025 --> 00:05:27.585
So this method can either return null or it can

00:05:27.585 --> 00:05:29.225
return the data that we expect,

00:05:29.765 --> 00:05:30.345
in a very

00:05:30.745 --> 00:05:31.585
type safe

00:05:31.785 --> 00:05:33.785
link schema format.

00:05:34.345 --> 00:05:34.985
Okay,

00:05:34.985 --> 00:05:37.745
so then what I'm going to basically do is I'm

00:05:37.745 --> 00:05:38.905
going to say let's

00:05:39.815 --> 00:05:40.055
create

00:05:40.375 --> 00:05:42.255
Another method and this is going to be the one

00:05:42.255 --> 00:05:43.735
that we actually use in our application.

00:05:44.135 --> 00:05:44.625
in our

00:05:44.625 --> 00:05:46.085
route called get

00:05:46.805 --> 00:05:46.825
georouting

00:05:47.545 --> 00:05:48.425
destinations.

00:05:48.745 --> 00:05:51.625
This is also going to be taking an ENB and an ID

00:05:52.105 --> 00:05:54.865
and then what we're going to want to do is inside

00:05:54.865 --> 00:05:55.385
of app

00:05:55.525 --> 00:05:57.665
we have this code here where we're calling our

00:05:57.665 --> 00:05:58.265
database.

00:05:58.665 --> 00:06:00.705
All of this logic is actually going to be moved

00:06:00.705 --> 00:06:02.265
into this route ops

00:06:02.345 --> 00:06:04.135
inside of this git routing destination.

00:06:04.215 --> 00:06:06.415
So the very first thing that we are going to do is

00:06:06.415 --> 00:06:07.335
we are going to say

00:06:07.815 --> 00:06:08.375
let's

00:06:10.017 --> 00:06:13.417
let's get the information from our get link info

00:06:13.417 --> 00:06:13.939
from KV

00:06:13.939 --> 00:06:15.776
and if it's not found or if it is found

00:06:16.096 --> 00:06:17.676
let's just go ahead and return that

00:06:17.676 --> 00:06:18.692
and if it's not found

00:06:19.341 --> 00:06:20.621
let's go to our database

00:06:21.501 --> 00:06:22.341
and let's look

00:06:22.381 --> 00:06:22.781
our,

00:06:23.421 --> 00:06:26.181
let's look up the link info from DB calling the

00:06:26.181 --> 00:06:29.421
get link which is just kind of a wrapper around a

00:06:29.501 --> 00:06:30.537
database query.

00:06:30.552 --> 00:06:32.952
And if it's not found we can go ahead and return

00:06:32.952 --> 00:06:33.432
null.

00:06:34.552 --> 00:06:36.072
And if it is found

00:06:36.552 --> 00:06:38.792
just for this very first time what we're going to

00:06:38.792 --> 00:06:39.752
do is we're going to

00:06:40.232 --> 00:06:41.912
save it into a database.

00:06:42.072 --> 00:06:44.632
So I'm calling this Save LinkInfo to KV.

00:06:44.712 --> 00:06:46.912
So we'll go ahead and we will write this query

00:06:46.912 --> 00:06:47.672
really quickly.

00:06:49.272 --> 00:06:50.232
So I'm going to say

00:06:50.840 --> 00:06:51.239
save

00:06:51.559 --> 00:06:53.919
link info into KB and this is going to take an

00:06:53.919 --> 00:06:54.699
embassy,

00:06:54.849 --> 00:06:57.049
going to take an ID which is the key and then the

00:06:57.049 --> 00:06:59.169
value is the link info and it's of this link

00:06:59.169 --> 00:06:59.889
infotype.

00:07:00.049 --> 00:07:02.569
And what you're going to notice here is we have a

00:07:02.569 --> 00:07:05.569
ENV cache put and we're saving this information.

00:07:05.949 --> 00:07:06.909
we're saving this information

00:07:07.309 --> 00:07:08.389
into the kv.

00:07:08.389 --> 00:07:11.189
So the next time this method is called we'll be

00:07:11.189 --> 00:07:13.909
able to grab the data from the KV and we won't

00:07:13.909 --> 00:07:15.480
have to make a database call.

00:07:15.480 --> 00:07:17.457
And then the last thing is obviously just

00:07:17.457 --> 00:07:18.097
returning

00:07:18.747 --> 00:07:19.867
the link info.

00:07:21.547 --> 00:07:22.907
So that is pretty

00:07:22.943 --> 00:07:24.713
concise and a pretty tight method here.

00:07:24.713 --> 00:07:25.913
I think this is pretty clean.

00:07:26.313 --> 00:07:28.233
Now one other note about

00:07:28.833 --> 00:07:30.753
a cloudflare KB is

00:07:31.263 --> 00:07:32.513
essentially you.

00:07:32.593 --> 00:07:35.033
So you can store really as much information as you

00:07:35.033 --> 00:07:35.233
like.

00:07:35.233 --> 00:07:37.393
I forgot what the exact limits are but I don't

00:07:37.393 --> 00:07:39.153
really think that the limits in terms of storage

00:07:39.153 --> 00:07:40.993
is something crazy relevant for this.

00:07:41.333 --> 00:07:44.413
but you also have the ability when you are saving

00:07:44.413 --> 00:07:44.773
data

00:07:45.173 --> 00:07:47.253
you can pass in a few different things.

00:07:47.983 --> 00:07:48.943
you can pass in

00:07:49.663 --> 00:07:50.783
a type that you expect.

00:07:50.943 --> 00:07:52.063
You can also set

00:07:52.203 --> 00:07:53.943
a TTL which means a total time to live.

00:07:53.943 --> 00:07:55.823
So you can basically say when you save something.

00:07:56.303 --> 00:07:58.823
I want this to automatically be cleaned up and

00:07:58.823 --> 00:08:01.103
deleted by Cloudflare at a later date.

00:08:01.423 --> 00:08:03.663
So what we can do is we can basically set a.

00:08:08.339 --> 00:08:09.882
We can set an expiration ttl

00:08:10.587 --> 00:08:12.427
and this is going to be in seconds.

00:08:12.587 --> 00:08:13.787
So for this purpose,

00:08:13.787 --> 00:08:16.187
let's just say for now this is kind of arbitrary.

00:08:16.187 --> 00:08:17.307
So one minute

00:08:18.427 --> 00:08:18.827
times

00:08:20.427 --> 00:08:20.827
one,

00:08:22.127 --> 00:08:23.007
times 60.

00:08:23.247 --> 00:08:24.687
So it's going to be one hour

00:08:25.167 --> 00:08:26.127
times 24.

00:08:26.207 --> 00:08:28.287
So we will cache for exactly 24 hours.

00:08:28.287 --> 00:08:28.687
Now,

00:08:29.547 --> 00:08:32.027
caching logic is going to be entirely dependent on

00:08:32.027 --> 00:08:32.427
you,

00:08:32.587 --> 00:08:32.987
so

00:08:33.467 --> 00:08:34.427
TTL time,

00:08:41.471 --> 00:08:42.591
depending on your use case,

00:08:42.591 --> 00:08:44.031
I think this should be fine for now.

00:08:44.131 --> 00:08:45.371
so basically we're gonna,

00:08:45.371 --> 00:08:46.491
we're not gonna balloon cache,

00:08:46.491 --> 00:08:47.451
we're not gonna have a whole bunch of,

00:08:47.451 --> 00:08:47.611
like,

00:08:47.611 --> 00:08:49.091
data that's stored unnecessarily,

00:08:49.091 --> 00:08:51.251
but then if there's a link that's being visited

00:08:51.251 --> 00:08:51.891
frequently,

00:08:52.011 --> 00:08:53.811
we'll be pulling from the cache all the time.

00:08:53.811 --> 00:08:54.211
So

00:08:54.801 --> 00:08:55.561
I think this is a,

00:08:55.561 --> 00:08:56.721
this is a good ttl.

00:08:56.831 --> 00:08:58.301
and if you're curious about ttl,

00:08:58.301 --> 00:09:01.981
my video on Cloudflare KV goes into depth onto

00:09:01.981 --> 00:09:02.941
that aspect of it as well.

00:09:02.941 --> 00:09:03.261
But yeah,

00:09:03.261 --> 00:09:04.501
it's pretty cool that you can basically just say,

00:09:04.501 --> 00:09:05.581
I'm going to store some information

00:09:06.141 --> 00:09:07.861
and I'm not going to worry about cleaning it up

00:09:07.861 --> 00:09:08.101
later.

00:09:08.101 --> 00:09:09.901
Cloudflare is just going to delete it for me once

00:09:09.901 --> 00:09:10.751
this time is hit.

00:09:10.751 --> 00:09:11.255
All right,

00:09:11.415 --> 00:09:12.935
so now that we have

00:09:13.255 --> 00:09:14.535
our git destination,

00:09:14.855 --> 00:09:16.535
our git routing destination,

00:09:16.535 --> 00:09:17.815
we can head back over to

00:09:18.295 --> 00:09:19.255
App ts,

00:09:19.525 --> 00:09:20.645
and then I'm just going to

00:09:21.285 --> 00:09:23.285
call that instead of our get links,

00:09:23.605 --> 00:09:24.725
we're going to pass in

00:09:25.045 --> 00:09:26.165
C emv,

00:09:26.405 --> 00:09:27.845
we'll pass in our id.

00:09:28.565 --> 00:09:29.645
And yeah,

00:09:29.645 --> 00:09:30.565
that's all we need.

00:09:30.725 --> 00:09:32.965
So we get that same type link info.

00:09:32.965 --> 00:09:35.364
So that's the only change to the code here.

00:09:35.364 --> 00:09:36.945
You can see it's still very tight.

00:09:36.945 --> 00:09:39.225
it's a very clean method or a very clean route.

00:09:39.385 --> 00:09:41.145
And we've pushed a lot of this,

00:09:41.145 --> 00:09:41.505
like,

00:09:41.505 --> 00:09:44.265
wrangling of the data and saving into the cache

00:09:44.265 --> 00:09:47.385
and checking into this route ops to help us

00:09:47.705 --> 00:09:49.778
keep things a little bit more modular and clean.

00:09:49.866 --> 00:09:50.906
So you can run this locally,

00:09:50.906 --> 00:09:52.826
make sure everything is working as expected

00:09:53.146 --> 00:09:53.706
and then

00:09:53.956 --> 00:09:56.276
obviously what we're going to be getting into the

00:09:56.276 --> 00:09:57.036
pattern of

00:09:57.356 --> 00:09:59.556
doing very frequently is once we make any type of

00:09:59.556 --> 00:10:00.156
major change,

00:10:00.476 --> 00:10:02.836
we're going to make sure we're able to deploy and

00:10:02.836 --> 00:10:03.716
everything works as expected.

00:10:03.716 --> 00:10:04.836
So we say pnpm,

00:10:04.836 --> 00:10:05.196
run,

00:10:05.676 --> 00:10:06.316
deploy.

00:10:06.556 --> 00:10:09.516
This deployment should give us access to the

00:10:10.436 --> 00:10:11.276
key value pair,

00:10:11.276 --> 00:10:13.236
the cloudflare KV as a binding.

00:10:13.656 --> 00:10:15.216
So this should go through the deployment process

00:10:15.216 --> 00:10:17.108
and when it's done we'll go ahead and check that.

00:10:17.108 --> 00:10:17.392
Oh,

00:10:17.392 --> 00:10:19.712
and it looks like we have one error here.

00:10:20.192 --> 00:10:21.192
So unexpected.

00:10:21.192 --> 00:10:22.512
It looks like I have a,

00:10:23.362 --> 00:10:25.872
looks like I have a type error somewhere in this

00:10:25.872 --> 00:10:26.312
code.

00:10:27.022 --> 00:10:28.542
Because I was copying pasting,

00:10:28.782 --> 00:10:30.422
I don't think you'll run into this issue.

00:10:30.422 --> 00:10:31.422
But just note,

00:10:31.722 --> 00:10:33.662
this build process will typically if there's some

00:10:33.662 --> 00:10:34.862
type of issue with your code,

00:10:34.942 --> 00:10:37.302
it'll tell you exactly where that failure is and

00:10:37.302 --> 00:10:39.102
then you'll be able to rectify that pretty

00:10:39.102 --> 00:10:39.462
quickly.

00:10:39.462 --> 00:10:41.462
So this is why I like to deploy frequently just so

00:10:41.462 --> 00:10:43.802
your applications is not in a state that isn't

00:10:44.202 --> 00:10:44.522
you know,

00:10:44.522 --> 00:10:46.402
running and working and behaving in a healthy

00:10:46.402 --> 00:10:46.606
manner.

00:10:46.608 --> 00:10:47.628
right now that we see,

00:10:47.628 --> 00:10:49.628
now we can see that this deployment was

00:10:49.628 --> 00:10:50.308
successful.

00:10:50.708 --> 00:10:52.388
I'll head over to the browser

00:10:52.948 --> 00:10:54.548
and let's just grab this.

00:10:54.548 --> 00:10:56.668
So this should redirect us as a.

00:10:56.668 --> 00:10:57.948
So watch how long this takes.

00:10:57.948 --> 00:10:59.108
This is taking some time,

00:10:59.968 --> 00:11:01.528
honestly it's taking longer than it should,

00:11:01.528 --> 00:11:02.968
but I think that's just because of that network

00:11:02.968 --> 00:11:04.128
travel from Malaysia.

00:11:04.368 --> 00:11:06.928
But now let's go ahead and hit that one more time,

00:11:06.928 --> 00:11:08.048
that exact same link.

00:11:08.288 --> 00:11:10.128
And we should notice that this speeds up

00:11:10.128 --> 00:11:11.168
tremendously.

00:11:11.420 --> 00:11:11.696
Yep.

00:11:11.710 --> 00:11:14.230
So it's able to redirect and that was able to hit

00:11:14.230 --> 00:11:14.910
the cache.

00:11:14.910 --> 00:11:15.310
So

00:11:15.440 --> 00:11:17.310
a few different notes here if you really want to.

00:11:17.390 --> 00:11:19.790
What you could do is you could come into,

00:11:20.370 --> 00:11:21.650
you could come into this method

00:11:21.960 --> 00:11:23.320
and you could add some logs.

00:11:23.400 --> 00:11:26.280
So you could basically say like console log

00:11:26.520 --> 00:11:27.160
checking,

00:11:29.937 --> 00:11:31.217
checking cache

00:11:33.297 --> 00:11:34.657
and then you could say

00:11:35.137 --> 00:11:37.657
inside of here you could say like retrieve from

00:11:37.657 --> 00:11:39.737
cache and you could put some logging statements

00:11:39.737 --> 00:11:40.177
out here.

00:11:40.457 --> 00:11:41.677
you could deploy your changes.

00:11:41.757 --> 00:11:43.746
Then you could head over to your worker code,

00:11:44.127 --> 00:11:45.327
you could go to your data service,

00:11:45.605 --> 00:11:46.904
head over to the logs.

00:11:46.905 --> 00:11:48.620
Then you could do real time logs right here,

00:11:49.100 --> 00:11:51.740
select events and then you would be able to see,

00:11:51.820 --> 00:11:53.100
as you do this,

00:11:53.110 --> 00:11:54.644
as you do this dynamic routing,

00:11:56.338 --> 00:11:57.960
you'd be able to see these logs come in,

00:11:57.960 --> 00:11:58.480
in real time,

00:11:58.480 --> 00:11:59.760
you'd be able to see those messages.

00:11:59.760 --> 00:12:00.920
So if you ever need a debug,

00:12:00.920 --> 00:12:02.160
and you actually want to do that.

00:12:02.160 --> 00:12:03.450
It's in production or,

00:12:03.450 --> 00:12:03.690
like,

00:12:03.690 --> 00:12:04.650
after you've deployed.

00:12:04.650 --> 00:12:06.090
That's a great way of doing so.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.178 --> 00:00:02.538
So now that we fully completed this link routing

00:00:02.538 --> 00:00:02.938
logic,

00:00:02.938 --> 00:00:05.178
which is kind of like the crux of the product

00:00:05.178 --> 00:00:05.778
offering,

00:00:06.338 --> 00:00:07.938
we're going to get into what my,

00:00:07.938 --> 00:00:08.698
in my opinion,

00:00:08.698 --> 00:00:10.498
the funnest aspect of this course.

00:00:10.818 --> 00:00:13.578
So we're going to dive deeper into the data side

00:00:13.578 --> 00:00:14.018
of things,

00:00:14.348 --> 00:00:15.538
building out Cloudflare services.

00:00:16.178 --> 00:00:17.418
Now as you can see here,

00:00:17.418 --> 00:00:19.538
there's like different features in this dashboard.

00:00:19.698 --> 00:00:22.098
A lot of this is providing us analytics

00:00:22.728 --> 00:00:22.968
and

00:00:23.468 --> 00:00:24.468
there's some different components.

00:00:24.468 --> 00:00:26.548
Like you have this map and in real time,

00:00:26.548 --> 00:00:27.508
when users are

00:00:28.068 --> 00:00:29.548
clicking on links and being routed to

00:00:29.548 --> 00:00:30.108
destinations,

00:00:30.108 --> 00:00:31.508
you should be able to see where those

00:00:32.008 --> 00:00:32.448
links are.

00:00:32.448 --> 00:00:34.368
And then we're going to be getting into different

00:00:34.528 --> 00:00:36.768
things about having AI check

00:00:38.148 --> 00:00:40.668
the health of a link destination to see if a

00:00:40.668 --> 00:00:42.548
product sold out or if the link isn't working

00:00:42.548 --> 00:00:43.508
anymore or whatnot.

00:00:43.938 --> 00:00:45.748
and we have a whole bunch of different features to

00:00:45.748 --> 00:00:46.748
build on top of that.

00:00:46.908 --> 00:00:47.308
Now

00:00:47.868 --> 00:00:50.868
in order to do so it all depends on a link being

00:00:50.868 --> 00:00:53.908
clicked and us capturing that data of a link being

00:00:53.908 --> 00:00:54.428
clicked.

00:00:54.748 --> 00:00:57.188
Now as you can see here inside of our app,

00:00:57.188 --> 00:00:58.668
ts like this is a pretty,

00:00:58.878 --> 00:01:00.048
this is a pretty like tight,

00:01:00.048 --> 00:01:02.968
a pretty safe route that we built out and there's

00:01:02.968 --> 00:01:05.488
really not like a lot of errors to like a lot of

00:01:05.488 --> 00:01:06.288
areas to fail.

00:01:07.168 --> 00:01:09.848
so what we could do is like when a user clicks on

00:01:09.848 --> 00:01:10.288
a link,

00:01:10.288 --> 00:01:11.648
we could have a

00:01:11.958 --> 00:01:14.518
database call where we like insert that data and

00:01:14.518 --> 00:01:15.478
then on the back,

00:01:15.868 --> 00:01:16.748
in the back end we could,

00:01:16.748 --> 00:01:17.148
you know,

00:01:17.148 --> 00:01:19.588
every like 10 minutes we can get some data and we

00:01:19.588 --> 00:01:19.948
can,

00:01:20.028 --> 00:01:20.548
you know,

00:01:20.548 --> 00:01:21.468
crunch the numbers,

00:01:21.468 --> 00:01:23.948
create the analytics and feed that into our

00:01:23.948 --> 00:01:24.428
dashboard.

00:01:24.428 --> 00:01:27.468
But if we want stuff to be real time and to be a

00:01:27.468 --> 00:01:29.708
little bit more reactive kind of event based,

00:01:29.868 --> 00:01:31.788
not just like batch processing based

00:01:32.588 --> 00:01:32.628
essentially,

00:01:33.008 --> 00:01:34.488
what we're going to want to do is we're going to

00:01:34.488 --> 00:01:35.008
want to

00:01:35.328 --> 00:01:36.368
introduce queues.

00:01:36.528 --> 00:01:38.288
And the reason why we're going to introduce queues

00:01:38.288 --> 00:01:40.848
is what we're going to say is when we get a

00:01:41.088 --> 00:01:41.648
request

00:01:42.368 --> 00:01:43.888
and we're going to route that to

00:01:44.448 --> 00:01:45.268
a destination.

00:01:45.517 --> 00:01:47.998
After that is done in the background of that

00:01:47.998 --> 00:01:48.518
request,

00:01:48.518 --> 00:01:50.118
we're just going to save a little bit of that

00:01:50.118 --> 00:01:50.438
information.

00:01:50.678 --> 00:01:51.718
We're going to say like,

00:01:52.038 --> 00:01:53.078
here's a link id,

00:01:53.398 --> 00:01:55.918
the user came from a country and this is like the

00:01:55.918 --> 00:01:56.318
latitude,

00:01:56.318 --> 00:01:58.078
the longitude and the

00:01:58.928 --> 00:02:01.408
and the destination that like they were routed to,

00:02:01.488 --> 00:02:03.488
we're going to send that to a queue and it's going

00:02:03.488 --> 00:02:04.968
to go to a queue and then it's going to be

00:02:04.968 --> 00:02:07.368
processed by a whole different service that's kind

00:02:07.368 --> 00:02:09.888
of isolated from this API that we've built out,

00:02:10.288 --> 00:02:12.908
and from there we can start building out really

00:02:12.908 --> 00:02:15.388
cool things like storing the data for analytics

00:02:15.388 --> 00:02:16.028
purposes.

00:02:16.508 --> 00:02:19.668
We can use durable objects to say,

00:02:19.668 --> 00:02:20.068
okay,

00:02:20.068 --> 00:02:21.268
this link was just clicked.

00:02:21.268 --> 00:02:23.068
We could send that data to a durable object.

00:02:23.068 --> 00:02:24.108
And if a user

00:02:24.428 --> 00:02:25.348
is on,

00:02:25.348 --> 00:02:25.628
like,

00:02:25.628 --> 00:02:25.948
their,

00:02:26.338 --> 00:02:27.298
web application,

00:02:27.378 --> 00:02:29.498
this web application could be connected to that

00:02:29.498 --> 00:02:31.338
durable object and then we'll be able to see that

00:02:31.338 --> 00:02:32.258
in real time here.

00:02:32.298 --> 00:02:35.328
we can also use these link clicks whenever a day,

00:02:35.328 --> 00:02:37.208
whenever data is written to a queue and we are

00:02:37.208 --> 00:02:38.608
able to process data from that queue.

00:02:38.608 --> 00:02:40.928
We could start running Cloudflare workflows to run

00:02:41.488 --> 00:02:43.888
our AI pipeline to determine the health of the

00:02:43.888 --> 00:02:44.088
link.

00:02:44.088 --> 00:02:44.248
So,

00:02:44.248 --> 00:02:44.448
like,

00:02:44.448 --> 00:02:46.728
everything is kind of going to be built on top of

00:02:46.728 --> 00:02:48.248
the fact that we are able to say,

00:02:48.248 --> 00:02:48.528
okay,

00:02:48.528 --> 00:02:49.488
a link is clicked,

00:02:49.648 --> 00:02:51.328
send that event to a queue,

00:02:51.408 --> 00:02:53.608
and then go trigger all of that orchestration,

00:02:53.608 --> 00:02:55.088
all that logic on the back end.

00:02:55.228 --> 00:02:56.188
we can trigger that

00:02:56.828 --> 00:02:58.908
based upon the data that's being fed from a queue.

00:02:58.908 --> 00:03:00.948
And we're going to go super deep into queues and

00:03:00.948 --> 00:03:01.908
other things in other,

00:03:01.908 --> 00:03:02.268
like,

00:03:02.788 --> 00:03:03.988
compute products that,

00:03:03.988 --> 00:03:06.028
that work that exist within Cloudflare's

00:03:06.028 --> 00:03:06.708
ecosystem.

00:03:06.868 --> 00:03:07.688
So let's get into it.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.000 --> 00:00:00.230
okay,

00:00:00.230 --> 00:00:02.230
so now that our smart routing system is built out,

00:00:02.230 --> 00:00:04.190
let's move a layer back into the stack and start

00:00:04.190 --> 00:00:05.710
building out our queue pipeline.

00:00:05.790 --> 00:00:06.670
So queues,

00:00:06.670 --> 00:00:07.870
if you haven't used them before,

00:00:08.030 --> 00:00:11.230
are in my opinion a very underlooked compute

00:00:11.230 --> 00:00:12.190
primitive within

00:00:12.509 --> 00:00:14.270
like a full stack ecosystem.

00:00:14.510 --> 00:00:16.310
I think that there's a lot of developers that

00:00:16.310 --> 00:00:17.350
don't have experience with queues.

00:00:17.350 --> 00:00:18.670
They don't really know why to use them.

00:00:18.670 --> 00:00:21.830
But using them can actually make your systems more

00:00:21.830 --> 00:00:22.350
resilient,

00:00:22.430 --> 00:00:22.990
modular,

00:00:22.990 --> 00:00:23.710
maintainable

00:00:24.180 --> 00:00:25.540
and can really help you scale.

00:00:25.640 --> 00:00:27.690
so I mean you don't need it like you don't need to

00:00:27.690 --> 00:00:29.690
use queues just because you want a system to be

00:00:29.690 --> 00:00:30.890
able to handle high volume.

00:00:30.970 --> 00:00:32.810
You can use it for a lot of different reasons.

00:00:33.410 --> 00:00:35.770
from my background kind of coming from like a data

00:00:35.770 --> 00:00:37.170
and back end engineering

00:00:37.890 --> 00:00:39.570
space at a really large company,

00:00:39.970 --> 00:00:43.290
we heavily used a technology called Apache Kafka

00:00:43.290 --> 00:00:45.090
which is just kind of an event based queuing

00:00:45.090 --> 00:00:47.730
mechanism that has a lot of different nuances,

00:00:47.970 --> 00:00:49.910
on how you can build like a distributed system,

00:00:49.910 --> 00:00:52.590
how you can manage state in a really large data

00:00:52.590 --> 00:00:53.430
ecosystem.

00:00:53.890 --> 00:00:56.450
But there are lighter weight versions of like

00:00:56.450 --> 00:00:57.410
queuing mechanisms.

00:00:57.410 --> 00:00:58.850
Cloudflare queues is one of them.

00:00:58.910 --> 00:01:00.960
if you Google you're going to probably come across

00:01:00.960 --> 00:01:01.760
Rabbit mq.

00:01:01.760 --> 00:01:03.520
This is a pretty big open source queuing

00:01:04.240 --> 00:01:04.900
offering.

00:01:05.220 --> 00:01:07.780
Amazon has a Amazon simple queue service.

00:01:08.100 --> 00:01:10.420
Redis also has a very popular pub sub

00:01:10.780 --> 00:01:11.300
offering.

00:01:11.300 --> 00:01:13.580
They also have Redis streams which if you're

00:01:13.580 --> 00:01:16.220
already using Redis you can configure a Redis

00:01:16.220 --> 00:01:18.940
cluster to essentially act as like a queuing

00:01:18.940 --> 00:01:19.580
mechanism.

00:01:19.874 --> 00:01:21.845
so what are queues and why would you want to use

00:01:21.845 --> 00:01:22.125
them?

00:01:22.535 --> 00:01:23.815
At a very high level

00:01:24.135 --> 00:01:26.735
a queue is just kind of a middle layer inside of a

00:01:26.735 --> 00:01:29.735
distributed system where you can offload some data

00:01:29.815 --> 00:01:31.575
to be processed in the background.

00:01:31.655 --> 00:01:32.055
So

00:01:32.245 --> 00:01:34.215
like a high level data flow of this would be like

00:01:34.215 --> 00:01:37.095
you have some application that has some data and

00:01:37.095 --> 00:01:40.295
it writes it to a queue and then you can build a

00:01:40.295 --> 00:01:42.095
totally separate decoupled bit of

00:01:42.655 --> 00:01:45.535
application logic that acts as a consumer that

00:01:45.535 --> 00:01:48.655
reads that data and then processes it in some way.

00:01:48.815 --> 00:01:51.095
So why would you want to use a queue and in what

00:01:51.095 --> 00:01:52.655
scenarios would you want to use a queue?

00:01:52.655 --> 00:01:53.055
So

00:01:53.255 --> 00:01:56.085
from my kind of like my mental model for using

00:01:56.085 --> 00:01:58.565
queues is basically saying if I have a background

00:01:58.565 --> 00:02:00.245
task where I want to

00:02:00.725 --> 00:02:01.765
process some data,

00:02:02.005 --> 00:02:04.145
and I don't want it to be dependent on an HTTP

00:02:04.145 --> 00:02:04.465
request.

00:02:04.465 --> 00:02:08.225
So like imagine a user hits an API and gives the

00:02:08.225 --> 00:02:09.065
API some data.

00:02:09.465 --> 00:02:11.265
Now if that API is going to do a whole bunch of

00:02:11.265 --> 00:02:13.305
stuff and let's say that request might take like

00:02:13.305 --> 00:02:13.629
15,

00:02:13.701 --> 00:02:14.585
30 seconds,

00:02:14.745 --> 00:02:16.585
if the user closes that connection,

00:02:16.745 --> 00:02:18.905
you're also probably going to lose data and you're

00:02:18.905 --> 00:02:20.345
going to stop processing that request

00:02:20.465 --> 00:02:21.245
throughout that process.

00:02:21.565 --> 00:02:23.405
So in that scenario I would say

00:02:23.745 --> 00:02:25.865
put that data in a background task and in this

00:02:25.865 --> 00:02:28.025
case a queue and then respond to the user,

00:02:28.025 --> 00:02:28.385
hey,

00:02:28.385 --> 00:02:29.545
we're processing your data,

00:02:29.545 --> 00:02:29.825
right?

00:02:29.825 --> 00:02:31.425
And then your UI application can,

00:02:31.505 --> 00:02:32.465
can handle that,

00:02:33.005 --> 00:02:34.245
that state to basically say like,

00:02:34.245 --> 00:02:34.565
okay,

00:02:34.565 --> 00:02:34.845
yeah,

00:02:34.845 --> 00:02:35.245
so this,

00:02:35.245 --> 00:02:36.485
this data is being processed,

00:02:36.485 --> 00:02:38.085
I'm going to check back in 10 seconds,

00:02:38.085 --> 00:02:38.725
30 seconds,

00:02:38.725 --> 00:02:40.765
whatever to like see if that task is done.

00:02:41.105 --> 00:02:43.665
there's also this concept of event driven systems

00:02:43.665 --> 00:02:44.785
where you have

00:02:45.125 --> 00:02:47.745
one event from a system that kind of cascades and

00:02:47.745 --> 00:02:48.985
triggers other things to happen.

00:02:49.145 --> 00:02:50.705
queues provide a

00:02:51.115 --> 00:02:53.115
perfect middle ground to

00:02:53.595 --> 00:02:54.365
facilitate

00:02:54.365 --> 00:02:56.415
event driven systems so you can build application

00:02:56.415 --> 00:02:59.295
logic on top of like a cascading series of things

00:02:59.295 --> 00:02:59.855
happening.

00:03:00.255 --> 00:03:03.095
another very important scenario is no data loss.

00:03:03.095 --> 00:03:05.255
So like queues usually will guarantee at least

00:03:05.255 --> 00:03:06.094
once delivery.

00:03:06.094 --> 00:03:06.735
Which means,

00:03:07.325 --> 00:03:09.215
if you write some data to a queue,

00:03:09.455 --> 00:03:12.215
you can guarantee that data is on a queue and you

00:03:12.215 --> 00:03:14.535
can process it and handle like failure.

00:03:14.535 --> 00:03:14.975
So if,

00:03:15.055 --> 00:03:15.975
if data fails,

00:03:15.975 --> 00:03:17.055
you can basically say hey,

00:03:17.055 --> 00:03:18.095
I don't want to complete

00:03:18.635 --> 00:03:19.795
the processing of this data.

00:03:19.795 --> 00:03:22.355
And then the queue can maintain that data up until

00:03:22.355 --> 00:03:23.765
it's successfully processed.

00:03:23.765 --> 00:03:24.615
so this is where

00:03:24.935 --> 00:03:25.975
like payments,

00:03:26.295 --> 00:03:27.015
bank information,

00:03:27.175 --> 00:03:27.535
different,

00:03:27.535 --> 00:03:29.015
like really important transactions,

00:03:29.015 --> 00:03:31.295
you can like put data on a queue to kind of

00:03:31.295 --> 00:03:33.375
guarantee that you don't want to guarantee

00:03:33.375 --> 00:03:35.655
application logic that isn't going to lose data

00:03:35.895 --> 00:03:37.335
and then modular services.

00:03:37.495 --> 00:03:39.655
So like if you have a really bloated full stack

00:03:39.655 --> 00:03:41.335
framework that's doing a whole bunch of stuff,

00:03:41.495 --> 00:03:43.535
sending data to a queue and having a lighter

00:03:43.535 --> 00:03:45.735
weight back in service that manages that data.

00:03:45.905 --> 00:03:47.435
of lot allows your system to be a little bit more

00:03:47.435 --> 00:03:48.595
maintainable and scalable,

00:03:48.685 --> 00:03:50.055
from a code based perspective.

00:03:50.055 --> 00:03:52.135
So Cloudflare queues has a bunch of different

00:03:52.135 --> 00:03:52.495
features.

00:03:52.495 --> 00:03:52.775
You know,

00:03:52.775 --> 00:03:54.775
you have your basic flow where you have a producer

00:03:54.775 --> 00:03:56.815
that can write some data to a queue and then you

00:03:56.815 --> 00:03:59.695
have a consumer where you implement logic to get

00:03:59.695 --> 00:04:01.614
that data from a queue and then process it

00:04:01.614 --> 00:04:02.043
somehow.

00:04:02.139 --> 00:04:05.259
Now some of the cool features about queues is the

00:04:05.259 --> 00:04:07.939
built in retry logic so you can configure a queue

00:04:07.939 --> 00:04:08.779
to basically say,

00:04:08.939 --> 00:04:09.299
hey,

00:04:09.299 --> 00:04:10.299
I'm going to get some data,

00:04:10.459 --> 00:04:12.379
and then when a consumer is reading it,

00:04:12.379 --> 00:04:13.579
if that data fails,

00:04:13.659 --> 00:04:15.259
it will automatically retry.

00:04:15.259 --> 00:04:17.919
And you can set that logic to retry three times,

00:04:17.919 --> 00:04:18.399
one time,

00:04:18.399 --> 00:04:20.359
no times however you want that to be

00:04:21.629 --> 00:04:22.589
out of the box.

00:04:22.909 --> 00:04:25.109
There's also this concept called the dead letter

00:04:25.109 --> 00:04:25.469
queue,

00:04:25.709 --> 00:04:28.589
where if you write data to a queue and it's

00:04:28.589 --> 00:04:30.509
processed by a consumer and then that

00:04:30.689 --> 00:04:32.689
data fails a certain number of times,

00:04:33.009 --> 00:04:35.369
you can offload that data back to a dead letter

00:04:35.369 --> 00:04:37.449
queue where that data can kind of be saved and

00:04:37.449 --> 00:04:39.649
then you can process it later from that same

00:04:39.649 --> 00:04:40.111
consumer.

00:04:40.111 --> 00:04:40.762
You could also,

00:04:40.842 --> 00:04:41.802
in like a more

00:04:42.202 --> 00:04:43.182
complicated system,

00:04:43.872 --> 00:04:45.872
you could have a dead letter queue where data goes

00:04:45.872 --> 00:04:46.832
to a consumer,

00:04:46.832 --> 00:04:47.432
it fails,

00:04:47.432 --> 00:04:48.552
it goes to a dead letter queue.

00:04:48.552 --> 00:04:50.352
And then you have a totally different type of

00:04:50.352 --> 00:04:52.912
service and pipeline that reads that failed data

00:04:52.912 --> 00:04:54.572
and then processes it some other way.

00:04:54.580 --> 00:04:55.940
So there's a whole bunch of different

00:04:56.570 --> 00:04:58.810
features that are kind of built into queues that

00:04:58.810 --> 00:05:00.650
allow you to build resilient systems.

00:05:00.650 --> 00:05:01.930
And we're going to go through this process,

00:05:01.930 --> 00:05:03.610
we're going to integrate it into our

00:05:04.110 --> 00:05:06.350
data pipeline for our smart

00:05:06.830 --> 00:05:07.630
routing service

00:05:07.950 --> 00:05:10.710
to basically get link clicks and then getting the

00:05:10.710 --> 00:05:11.230
link clicks.

00:05:11.230 --> 00:05:12.630
We're going to facilitate a whole bunch of

00:05:12.630 --> 00:05:13.630
different other data services,

00:05:14.170 --> 00:05:15.450
going to actually power the

00:05:16.540 --> 00:05:17.180
AI

00:05:17.740 --> 00:05:18.780
analyzing of

00:05:19.040 --> 00:05:19.760
web pages.

00:05:19.840 --> 00:05:22.000
It'll also power the web sockets,

00:05:22.080 --> 00:05:23.110
it will also power

00:05:23.650 --> 00:05:26.210
all of the analytics that we see on our dashboard.

00:05:26.290 --> 00:05:26.690
So

00:05:26.760 --> 00:05:28.570
the queue is kind of going to be like the heart of

00:05:28.570 --> 00:05:29.329
getting that data,

00:05:29.410 --> 00:05:31.850
making sure that data saved and then it's going to

00:05:31.850 --> 00:05:33.650
facilitate a whole bunch of different types of

00:05:33.730 --> 00:05:34.770
processes that happen

00:05:34.860 --> 00:05:35.989
when we get our link click.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.119 --> 00:00:01.359
So before we use queues,

00:00:01.359 --> 00:00:03.639
we're going to have to upgrade our Cloudflare

00:00:03.639 --> 00:00:05.799
account from the free tier to the paid tier.

00:00:06.119 --> 00:00:08.159
Now essentially what this means is when you

00:00:08.159 --> 00:00:10.199
Upgrade to the $5 a month tier,

00:00:10.279 --> 00:00:11.879
you're unlocking a whole bunch of different,

00:00:12.109 --> 00:00:14.099
products and features that Cloudflare offers.

00:00:14.099 --> 00:00:15.739
So you'll unlock containers,

00:00:15.899 --> 00:00:18.819
you'll unlock all versions of durable objects.

00:00:18.819 --> 00:00:20.139
Workflows were already free.

00:00:20.619 --> 00:00:23.619
And then under the storage databases we're going

00:00:23.619 --> 00:00:24.469
to be unlocking key.

00:00:25.099 --> 00:00:25.739
So I've already

00:00:26.059 --> 00:00:26.459
actually

00:00:26.939 --> 00:00:29.459
upgraded this account to the pay tier just now for

00:00:29.459 --> 00:00:30.459
the purpose of this course.

00:00:30.459 --> 00:00:33.099
This is a course specific Cloudflare account.

00:00:33.259 --> 00:00:33.659
Now,

00:00:34.099 --> 00:00:35.259
the billing,

00:00:35.259 --> 00:00:36.779
I think some people find it confusing,

00:00:36.779 --> 00:00:38.299
I find it relatively straightforward,

00:00:38.299 --> 00:00:40.498
but we can walk through really quickly how to

00:00:40.579 --> 00:00:41.939
conceptualize the billing.

00:00:41.939 --> 00:00:42.339
So,

00:00:42.579 --> 00:00:43.759
a few notes right off the bat.

00:00:43.759 --> 00:00:46.479
This is $5 per account and you can add

00:00:46.799 --> 00:00:48.799
people to your account if you're collaborating

00:00:48.799 --> 00:00:50.479
with members of like your team.

00:00:50.479 --> 00:00:51.919
So if you're growing a team,

00:00:52.079 --> 00:00:53.519
you have different people working with you,

00:00:53.519 --> 00:00:55.239
you can actually add them to your course.

00:00:55.239 --> 00:00:55.599
You

00:00:55.979 --> 00:00:56.859
that under,

00:00:57.039 --> 00:00:58.648
you can do that under account management.

00:00:59.208 --> 00:01:00.568
You can add members to your team,

00:01:00.568 --> 00:01:01.488
you can give them permissions,

00:01:01.488 --> 00:01:03.408
you can say what resources they have access to and

00:01:03.408 --> 00:01:04.208
what they don't have access to.

00:01:04.208 --> 00:01:05.328
And when you add them to your account,

00:01:05.328 --> 00:01:07.128
you're not paying $5 per member.

00:01:07.128 --> 00:01:07.648
It just,

00:01:07.648 --> 00:01:09.048
you just are able to add them,

00:01:09.128 --> 00:01:09.848
which is great.

00:01:09.848 --> 00:01:12.048
If you look at a lot of other SaaS platforms and

00:01:12.048 --> 00:01:12.928
compute platforms,

00:01:12.928 --> 00:01:16.088
they basically charge $25 or $20 or $15 every

00:01:16.088 --> 00:01:17.488
single person you add to your account,

00:01:17.488 --> 00:01:19.928
which I just don't really love that model.

00:01:20.948 --> 00:01:21.508
part of this,

00:01:21.508 --> 00:01:23.828
you can deploy up to 500 applications.

00:01:23.988 --> 00:01:26.988
So you can have 500 worker applications on your

00:01:26.988 --> 00:01:27.788
Cloudflare account,

00:01:27.788 --> 00:01:28.142
which

00:01:28.142 --> 00:01:28.728
is a lot.

00:01:28.788 --> 00:01:30.078
if you're doing more than that,

00:01:30.078 --> 00:01:31.078
they have other plans.

00:01:31.078 --> 00:01:33.078
They have this like workers for platforms which

00:01:33.078 --> 00:01:33.678
allow you,

00:01:33.678 --> 00:01:35.518
this give you like more flexibility around

00:01:36.178 --> 00:01:36.538
having

00:01:36.750 --> 00:01:38.275
being able to like programmatically deploy

00:01:38.275 --> 00:01:38.795
applications,

00:01:38.795 --> 00:01:39.395
easier

00:01:39.795 --> 00:01:41.555
manage bindings in a dynamic way.

00:01:41.555 --> 00:01:43.535
But that's far beyond the scope of this course,

00:01:43.775 --> 00:01:43.935
course.

00:01:43.935 --> 00:01:44.895
But 500

00:01:45.455 --> 00:01:47.855
applications or 500 worker applications on a

00:01:47.855 --> 00:01:48.335
single account,

00:01:48.335 --> 00:01:48.695
Like,

00:01:48.695 --> 00:01:50.935
I think it'd be very hard to build that many

00:01:50.935 --> 00:01:52.055
things to hit that limit.

00:01:52.055 --> 00:01:53.375
So that's one great thing.

00:01:53.565 --> 00:01:56.165
and then the other thing is just this usage based

00:01:56.165 --> 00:01:56.585
limit,

00:01:56.585 --> 00:01:57.625
usage based pricing.

00:01:57.625 --> 00:01:58.025
So

00:01:58.665 --> 00:01:59.785
part of the standard plan,

00:01:59.785 --> 00:02:00.585
$5 a month,

00:02:00.585 --> 00:02:02.945
you get 10 million requests a month and then each

00:02:02.945 --> 00:02:03.865
additional million

00:02:04.185 --> 00:02:05.705
requests is 30 cents.

00:02:05.705 --> 00:02:06.345
This is very,

00:02:06.345 --> 00:02:06.785
very cheap.

00:02:06.785 --> 00:02:09.345
If you Compare this to Vercel or Netlify or

00:02:09.345 --> 00:02:09.785
Convex.

00:02:09.785 --> 00:02:10.425
This is much,

00:02:10.585 --> 00:02:10.635
much

00:02:10.765 --> 00:02:11.125
cheaper.

00:02:11.125 --> 00:02:12.965
So you're getting a lot of bang for your buck for

00:02:12.965 --> 00:02:13.725
that five bucks.

00:02:14.175 --> 00:02:16.455
And then they just have like different ways of

00:02:16.455 --> 00:02:19.135
billing based upon CPU time versus like the full

00:02:19.135 --> 00:02:20.255
duration of the request.

00:02:20.415 --> 00:02:22.095
And if you like read through,

00:02:22.095 --> 00:02:24.015
they kind of have like these breakdowns of

00:02:24.545 --> 00:02:26.865
if you have an example of where you're getting

00:02:26.865 --> 00:02:28.785
like 30 million requests and you have a certain

00:02:28.785 --> 00:02:29.265
number of

00:02:29.585 --> 00:02:30.305
compute time,

00:02:30.305 --> 00:02:32.305
they basically kind of give you these examples of

00:02:32.305 --> 00:02:34.385
how much you're going to expect to be billed at

00:02:34.385 --> 00:02:35.025
the end of the month.

00:02:35.105 --> 00:02:35.505
Now

00:02:36.095 --> 00:02:38.615
what I found while I've been building for

00:02:38.615 --> 00:02:39.775
different clients is

00:02:40.275 --> 00:02:40.595
you know,

00:02:40.595 --> 00:02:42.555
you might have a hard time sussing out exactly how

00:02:42.555 --> 00:02:43.795
much a service is going to cost.

00:02:43.795 --> 00:02:45.475
Like maybe you know roughly how many requests

00:02:45.475 --> 00:02:45.955
you're going to get,

00:02:45.955 --> 00:02:46.475
but it's like,

00:02:46.475 --> 00:02:46.635
well,

00:02:46.635 --> 00:02:48.995
how much CPU time is every request going to take

00:02:48.995 --> 00:02:49.595
on average?

00:02:49.595 --> 00:02:50.355
How can I

00:02:50.605 --> 00:02:52.115
create like a good mental model for that?

00:02:52.115 --> 00:02:54.795
What I've noticed is the vast majority of projects

00:02:54.795 --> 00:02:57.515
that I've worked on for customers seldomly go past

00:02:57.515 --> 00:02:58.635
that $5 a month.

00:02:58.635 --> 00:02:59.155
Just because

00:02:59.555 --> 00:03:01.395
for a lot of like midsize businesses,

00:03:01.395 --> 00:03:03.875
10 million requests is a lot to handle in a month.

00:03:03.875 --> 00:03:04.715
Now it's not crazy,

00:03:04.715 --> 00:03:05.835
it's not like crazy numbers.

00:03:05.835 --> 00:03:07.235
But what I've noticed is

00:03:07.995 --> 00:03:10.035
during the development process and launching and

00:03:10.035 --> 00:03:10.875
beta testing,

00:03:11.035 --> 00:03:13.675
we never really exceed that $5 a month tier.

00:03:13.675 --> 00:03:15.915
So we're able to get a really good gauge as to

00:03:16.365 --> 00:03:18.115
what functions are having like,

00:03:18.355 --> 00:03:21.275
or what workers are having higher average CPU

00:03:21.275 --> 00:03:21.635
time,

00:03:21.835 --> 00:03:23.635
which workers are getting the most requests.

00:03:23.635 --> 00:03:26.755
And before we even like break into this usage

00:03:26.755 --> 00:03:27.515
based billing,

00:03:27.515 --> 00:03:30.235
we're able to get a good mental model as to once

00:03:30.235 --> 00:03:32.395
we scale to a certain number of users or a certain

00:03:32.395 --> 00:03:33.315
amount of revenue,

00:03:33.315 --> 00:03:35.515
how much this pricing is going to be based upon

00:03:35.515 --> 00:03:35.795
like

00:03:36.195 --> 00:03:37.115
historical usage.

00:03:37.115 --> 00:03:39.355
So I wouldn't be super concerned about trying to

00:03:39.355 --> 00:03:41.995
like project how much you theoretically are going

00:03:41.995 --> 00:03:42.755
to pay one day.

00:03:42.755 --> 00:03:44.435
I would say build this stuff,

00:03:44.435 --> 00:03:45.595
know that it's going to scale,

00:03:45.595 --> 00:03:47.275
know that it's going to be cheaper than really any

00:03:47.275 --> 00:03:48.795
of the other serverless providers.

00:03:48.795 --> 00:03:49.315
And then

00:03:50.165 --> 00:03:52.244
after doing that for a few weeks and actually

00:03:52.244 --> 00:03:53.685
getting users and seeing usage,

00:03:53.685 --> 00:03:55.285
you'll be able to kind of build that mental model

00:03:55.285 --> 00:03:57.845
out and have like an accurate pricing of like your

00:03:57.845 --> 00:03:59.285
theoretical number for scale.

00:03:59.285 --> 00:03:59.685
So

00:03:59.885 --> 00:04:01.045
now that's if you're like,

00:04:01.045 --> 00:04:01.565
you know,

00:04:01.565 --> 00:04:02.205
starting out,

00:04:02.205 --> 00:04:04.285
you don't have like an existing company,

00:04:04.445 --> 00:04:06.245
you don't really know how many users you're going

00:04:06.245 --> 00:04:06.485
to have.

00:04:06.485 --> 00:04:06.965
If you have,

00:04:06.965 --> 00:04:07.245
like,

00:04:07.605 --> 00:04:07.765
very,

00:04:07.765 --> 00:04:08.985
very specific number of,

00:04:08.985 --> 00:04:10.585
users that you know you're going to have,

00:04:10.825 --> 00:04:11.225
and

00:04:11.625 --> 00:04:13.385
you know you're going to be making money doing

00:04:13.385 --> 00:04:14.105
high volume,

00:04:14.105 --> 00:04:14.945
you should probably,

00:04:14.945 --> 00:04:15.385
you know,

00:04:15.385 --> 00:04:16.145
run the math and,

00:04:16.145 --> 00:04:16.305
like,

00:04:16.305 --> 00:04:17.625
kind of project what it's going to be.

00:04:17.625 --> 00:04:19.945
But there's a very small percentage of

00:04:20.505 --> 00:04:22.185
people and services that

00:04:22.665 --> 00:04:23.065
actually,

00:04:23.305 --> 00:04:23.705
like,

00:04:24.345 --> 00:04:27.465
hit a meaningful amount of volume to really even

00:04:27.465 --> 00:04:28.985
be concerned about the price here.

00:04:29.065 --> 00:04:30.665
So just to keep that in mind,

00:04:30.665 --> 00:04:31.185
when you're.

00:04:31.185 --> 00:04:32.465
You're thinking about billing.

00:04:32.465 --> 00:04:33.545
So this point,

00:04:33.545 --> 00:04:35.625
make sure you upgrade to this $5 a month plan.

00:04:35.625 --> 00:04:36.345
And then from there,

00:04:36.345 --> 00:04:38.065
what you're going to notice is if you head over to

00:04:38.065 --> 00:04:38.585
the que,

00:04:39.115 --> 00:04:40.315
it's going to basically say,

00:04:40.315 --> 00:04:40.955
create a queue.

00:04:40.955 --> 00:04:42.275
If you're on the free tier,

00:04:42.275 --> 00:04:43.875
this is going to say you need to upgrade in order

00:04:43.875 --> 00:04:44.606
to create a queue.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.124 --> 00:00:00.604
All right,

00:00:00.684 --> 00:00:02.644
so now that we have our account set up,

00:00:02.644 --> 00:00:05.244
let's go through the process of creating a queue

00:00:05.244 --> 00:00:07.324
and binding it to our application and then we'll

00:00:07.324 --> 00:00:09.244
kind of like talk through the development process

00:00:09.244 --> 00:00:10.524
for working with queues.

00:00:10.684 --> 00:00:12.604
So first thing that we're going to do is head over

00:00:12.604 --> 00:00:13.684
to storage and databases,

00:00:13.684 --> 00:00:14.604
go to queues,

00:00:14.604 --> 00:00:16.124
and then we can go to create.

00:00:16.204 --> 00:00:16.564
Now,

00:00:16.564 --> 00:00:17.444
like I've said before,

00:00:17.444 --> 00:00:19.644
you can do this from the Wrangler CLI if you want,

00:00:19.644 --> 00:00:21.404
but we're going to be using the

00:00:21.614 --> 00:00:23.484
UI for the purpose of this course.

00:00:23.644 --> 00:00:25.684
So what we're going to do is we're going to call

00:00:25.684 --> 00:00:26.044
this

00:00:26.844 --> 00:00:27.404
Smart

00:00:28.224 --> 00:00:28.944
Links,

00:00:30.214 --> 00:00:31.204
data queue

00:00:31.844 --> 00:00:35.204
and then I'm going to have stage appended to the

00:00:35.204 --> 00:00:37.564
end because this is essentially the lower

00:00:37.564 --> 00:00:39.844
environment version of the application and we'll

00:00:39.844 --> 00:00:41.884
get to actually how we segment and build out the

00:00:41.884 --> 00:00:42.964
production version later.

00:00:43.124 --> 00:00:44.884
So let's go ahead and create that.

00:00:44.976 --> 00:00:45.318
All right,

00:00:45.318 --> 00:00:46.918
so from here you can see that we have these

00:00:46.918 --> 00:00:47.318
queues.

00:00:47.398 --> 00:00:49.718
We can click on that guy and we can grab some

00:00:49.718 --> 00:00:50.678
useful information here.

00:00:50.678 --> 00:00:51.878
So this is the queue name,

00:00:51.878 --> 00:00:53.158
this is the qid

00:00:53.638 --> 00:00:56.038
and it's currently in the state of inactive.

00:00:56.518 --> 00:00:58.118
So if we head back to our application

00:00:58.518 --> 00:01:00.278
and we go to our data service,

00:01:00.838 --> 00:01:03.638
we can head over to our Wrangler JSON file.

00:01:03.718 --> 00:01:05.878
What we're going to do is we are going to be

00:01:05.878 --> 00:01:07.238
adding an actual

00:01:07.448 --> 00:01:08.578
queues section

00:01:08.898 --> 00:01:10.178
to this configuration

00:01:10.578 --> 00:01:11.697
so we can say queues.

00:01:11.697 --> 00:01:13.258
And what this does is from my end,

00:01:13.258 --> 00:01:15.178
it automatically auto completes consumers and

00:01:15.178 --> 00:01:15.858
producers.

00:01:16.018 --> 00:01:18.858
We're going to first start by adding a consumer

00:01:18.858 --> 00:01:19.138
here.

00:01:19.218 --> 00:01:21.578
So we need to go ahead and delete the producers

00:01:21.578 --> 00:01:22.818
for now as we don't need it.

00:01:22.978 --> 00:01:23.228
And.

00:01:23.378 --> 00:01:25.538
And inside of here you can actually add more than

00:01:25.538 --> 00:01:27.618
one consumer to give an application.

00:01:27.618 --> 00:01:29.898
And we'll kind of like talk about how that would

00:01:29.898 --> 00:01:30.978
look in just a minute.

00:01:31.378 --> 00:01:33.378
But let's just start by saying,

00:01:33.678 --> 00:01:34.764
we're going to give it a queue

00:01:34.764 --> 00:01:36.370
and then we're going to be passing in the queue

00:01:36.370 --> 00:01:36.690
name

00:01:37.010 --> 00:01:37.890
from here

00:01:39.350 --> 00:01:41.470
And after we have a queue name we can head back

00:01:41.470 --> 00:01:42.430
over to our code.

00:01:42.430 --> 00:01:44.070
Now there are a lot of different

00:01:44.390 --> 00:01:46.230
configurations that you can put inside this

00:01:46.230 --> 00:01:47.150
consumer block,

00:01:47.150 --> 00:01:48.590
which we will go into later.

00:01:48.590 --> 00:01:49.230
But for now,

00:01:49.230 --> 00:01:49.870
bare minimum,

00:01:49.870 --> 00:01:52.510
all you need is the queue name in your application

00:01:52.510 --> 00:01:54.910
will know that it should act as a consumer.

00:01:54.910 --> 00:01:56.390
Now in order for this code to work

00:01:56.710 --> 00:01:58.950
we also need to make sure we implement the queue

00:01:58.950 --> 00:01:59.430
handler

00:01:59.750 --> 00:02:01.830
inside of our worker entry point.

00:02:01.990 --> 00:02:03.270
So head back to index.

00:02:03.590 --> 00:02:05.190
Now depending on your ide

00:02:05.590 --> 00:02:07.190
you should be able to just say queue

00:02:07.650 --> 00:02:08.850
and it should autocomplete.

00:02:08.850 --> 00:02:11.010
And essentially what it's doing is it's saying a

00:02:11.010 --> 00:02:14.450
queue method is going to receive a batch of events

00:02:14.530 --> 00:02:17.250
and those events will have messages and each of

00:02:17.250 --> 00:02:19.370
the message contains some data that you want to

00:02:19.370 --> 00:02:19.650
process.

00:02:19.970 --> 00:02:22.410
So what I like to do is I like to ensure that this

00:02:22.410 --> 00:02:24.930
function is async from the beginning.

00:02:25.570 --> 00:02:28.610
And then I basically say here's a batch

00:02:29.220 --> 00:02:29.620
of

00:02:30.180 --> 00:02:30.740
message,

00:02:30.740 --> 00:02:31.140
batch.

00:02:31.300 --> 00:02:32.900
The type is unknown for now.

00:02:33.320 --> 00:02:34.920
And what we're doing is we are saying,

00:02:34.920 --> 00:02:35.320
okay,

00:02:35.320 --> 00:02:37.000
for every single message

00:02:37.400 --> 00:02:38.520
inside of a,

00:02:39.040 --> 00:02:39.980
a batch of messages,

00:02:40.300 --> 00:02:43.260
let's just Simply log out message.body.

00:02:43.260 --> 00:02:45.340
so the body contains the actual information

00:02:45.980 --> 00:02:47.820
or the actual data for a

00:02:48.340 --> 00:02:49.620
given queue event.

00:02:50.180 --> 00:02:51.380
And additionally

00:02:51.780 --> 00:02:54.180
a message has some other information.

00:02:54.340 --> 00:02:56.500
Like you have an ack to basically mean

00:02:56.820 --> 00:02:58.060
acknowledge the message,

00:02:58.060 --> 00:03:00.580
which tells the the queue that you've processed

00:03:00.580 --> 00:03:00.740
it.

00:03:00.740 --> 00:03:01.860
You don't have to call ack,

00:03:01.860 --> 00:03:03.940
but you can manually call ACK if you want to say

00:03:03.940 --> 00:03:05.220
I've processed this message,

00:03:05.220 --> 00:03:06.740
I don't want to process it anymore.

00:03:07.340 --> 00:03:09.820
this will also give you a number of attempts that

00:03:09.820 --> 00:03:12.140
the queue has tried for a given message,

00:03:12.140 --> 00:03:12.660
for the,

00:03:12.660 --> 00:03:14.460
for the number of attempts that like a queue has

00:03:14.460 --> 00:03:14.780
actually

00:03:15.100 --> 00:03:17.260
attempted to process and then failed.

00:03:17.350 --> 00:03:18.640
so this will start out zero

00:03:19.040 --> 00:03:19.520
bodies.

00:03:19.520 --> 00:03:20.320
Obviously the data,

00:03:20.510 --> 00:03:22.200
every single queue event has a given

00:03:22.520 --> 00:03:22.920
ID

00:03:23.640 --> 00:03:24.040
and

00:03:24.230 --> 00:03:25.240
you have a retry

00:03:25.430 --> 00:03:27.770
method and then you have a timestamp associated

00:03:27.770 --> 00:03:28.290
with it.

00:03:28.450 --> 00:03:31.170
So for now all we're going to be doing is we're

00:03:31.170 --> 00:03:33.570
going to be logging the message body.

00:03:33.960 --> 00:03:36.680
now what we can do is we can say pnpm run,

00:03:36.760 --> 00:03:37.400
deploy,

00:03:37.960 --> 00:03:40.880
make sure you are in the data services directory

00:03:40.880 --> 00:03:41.560
when you do this.

00:03:41.644 --> 00:03:43.404
Now when this is done deploying,

00:03:43.404 --> 00:03:44.964
what you're going to notice is you're going to

00:03:44.964 --> 00:03:47.844
have a consumer for smart links data queue.

00:03:47.844 --> 00:03:51.484
So basically this knows that a dependency for the

00:03:51.884 --> 00:03:54.514
data service is now the queue that we have

00:03:54.514 --> 00:03:56.114
configured as the consumer.

00:03:56.574 --> 00:03:58.334
And then for the deployment to be successful you

00:03:58.334 --> 00:04:00.414
have to make sure you build out a queue handler

00:04:00.414 --> 00:04:01.534
and for now we are just

00:04:01.854 --> 00:04:02.734
logging the body.

00:04:02.814 --> 00:04:05.254
Eventually we're going to be passing in the data

00:04:05.254 --> 00:04:08.334
to an actual handler that processes a given event.

00:04:09.134 --> 00:04:11.294
So we can head back over to our Cloudflare account

00:04:11.614 --> 00:04:13.374
and you can come over to

00:04:13.874 --> 00:04:15.234
the workers and pages.

00:04:15.371 --> 00:04:15.771
And

00:04:16.531 --> 00:04:18.491
from here what we're going to do is I'm actually

00:04:18.491 --> 00:04:21.411
going to open the logs in a new tab.

00:04:21.921 --> 00:04:22.161
So

00:04:22.481 --> 00:04:24.241
we have our logs here

00:04:24.561 --> 00:04:27.281
for this specific data service application.

00:04:27.521 --> 00:04:30.321
And this is just like one way of validating your

00:04:30.401 --> 00:04:31.161
key was working.

00:04:31.161 --> 00:04:32.561
You could also do this locally.

00:04:32.611 --> 00:04:34.801
I typically like to test back in projects,

00:04:35.651 --> 00:04:38.531
in a kind of more like production way.

00:04:38.531 --> 00:04:40.371
So what I like to do is I like to say,

00:04:40.801 --> 00:04:44.271
to build out modular components that I can test in

00:04:44.271 --> 00:04:47.791
isolation with unit tests and then to actual test

00:04:47.791 --> 00:04:49.431
like end to end integrations,

00:04:49.621 --> 00:04:50.441
by deploying.

00:04:50.601 --> 00:04:52.521
So for now we're just gonna

00:04:52.901 --> 00:04:54.501
making sure visually that this is working.

00:04:54.661 --> 00:04:56.261
Because if it's your first time working with

00:04:56.261 --> 00:04:56.661
queues,

00:04:56.661 --> 00:04:58.421
there might be a lot of questions that you have.

00:04:58.821 --> 00:05:02.021
So let's head over to our storage databases queues

00:05:02.181 --> 00:05:02.851
and remember,

00:05:02.851 --> 00:05:03.271
we have the

00:05:03.271 --> 00:05:06.551
logs open in a new tab and I just turn the real

00:05:06.551 --> 00:05:07.431
time logs on.

00:05:07.911 --> 00:05:09.991
So what we're going to notice now is the status

00:05:09.991 --> 00:05:12.351
for a queue is now active because it now has a

00:05:12.351 --> 00:05:13.911
consumer for that queue.

00:05:14.151 --> 00:05:17.271
Something to note is a queue can only have one

00:05:17.271 --> 00:05:17.991
consumer,

00:05:17.991 --> 00:05:20.311
so you can't have multiple applications

00:05:20.941 --> 00:05:22.021
consuming from the same queue.

00:05:22.021 --> 00:05:24.101
I think Cloudflare eventually wants to build out

00:05:24.101 --> 00:05:24.741
that capability,

00:05:24.741 --> 00:05:27.341
but for now you can only have one consumer.

00:05:27.741 --> 00:05:29.221
Let's head over to Messages now.

00:05:29.221 --> 00:05:30.541
There's a bunch of things here that we're going to

00:05:30.541 --> 00:05:31.301
be going through later,

00:05:31.301 --> 00:05:33.141
but for now we're just going to go to send

00:05:33.141 --> 00:05:33.559
messages

00:05:33.679 --> 00:05:34.119
All right,

00:05:34.119 --> 00:05:37.079
so let's go ahead and just send hello World as a

00:05:37.079 --> 00:05:37.999
text message.

00:05:38.149 --> 00:05:40.059
the body is going to show up as hello World.

00:05:40.779 --> 00:05:43.739
And if the real time logs are not being finicky

00:05:43.739 --> 00:05:44.859
within a few seconds,

00:05:44.859 --> 00:05:45.819
we should see

00:05:46.219 --> 00:05:47.539
the logs pop up here.

00:05:47.539 --> 00:05:48.539
So you can see that,

00:05:49.029 --> 00:05:51.469
we got one log that is basically the event,

00:05:51.469 --> 00:05:53.909
the Q event that gets logged automatically by the

00:05:53.909 --> 00:05:54.189
system.

00:05:54.349 --> 00:05:56.709
And then we have our additional actual console log

00:05:56.709 --> 00:05:57.929
here where we said queue,

00:05:57.999 --> 00:05:58.159
queue,

00:05:58.159 --> 00:05:58.399
event,

00:05:59.119 --> 00:05:59.859
hello World.

00:06:00.099 --> 00:06:00.499
So

00:06:00.819 --> 00:06:02.979
let's just see if that will pop up one more time.

00:06:03.139 --> 00:06:04.459
And just to note,

00:06:04.459 --> 00:06:06.059
sometimes these real time logs can be a bit

00:06:06.059 --> 00:06:06.639
finicky.

00:06:06.739 --> 00:06:08.859
so I wouldn't stress too much if you're not seeing

00:06:08.859 --> 00:06:10.339
these logs pop up for you,

00:06:10.899 --> 00:06:11.299
but,

00:06:11.629 --> 00:06:13.869
this is one way of just kind of validating that

00:06:13.869 --> 00:06:15.309
things are working as expected.

00:06:15.949 --> 00:06:17.789
So we should see them pop up.

00:06:17.789 --> 00:06:20.269
And there's usually a delay of just a few seconds.

00:06:20.509 --> 00:06:22.949
And we can kind of configure how long that delay

00:06:22.949 --> 00:06:23.229
is

00:06:23.489 --> 00:06:23.778
as well.

00:06:23.778 --> 00:06:24.112
But

00:06:24.592 --> 00:06:26.832
let's just send a few more events here.

00:06:27.545 --> 00:06:28.105
All right,

00:06:28.105 --> 00:06:29.605
so you can see that we had these,

00:06:29.605 --> 00:06:31.145
hello World messages come up.

00:06:31.145 --> 00:06:31.985
And if you notice,

00:06:31.985 --> 00:06:34.705
we have our one system log here and then we have

00:06:34.705 --> 00:06:35.105
hello World.

00:06:35.105 --> 00:06:35.545
Hello World.

00:06:35.545 --> 00:06:36.065
Hello World.

00:06:36.065 --> 00:06:36.425
So

00:06:37.145 --> 00:06:39.305
what this is actually noting is this is a

00:06:39.625 --> 00:06:42.025
log that's generated by the system when the

00:06:42.025 --> 00:06:43.385
trigger happens for the first time,

00:06:43.385 --> 00:06:46.425
when that we get a batch of messages and then this

00:06:46.425 --> 00:06:49.545
specific batch processed those three messages

00:06:50.025 --> 00:06:50.985
in one event.

00:06:51.145 --> 00:06:52.745
So essentially there was a batch of three,

00:06:52.905 --> 00:06:54.785
and then it looped through and logged each one

00:06:54.785 --> 00:06:55.265
individually.

00:06:55.265 --> 00:06:56.025
So that's a great,

00:06:56.465 --> 00:06:58.305
that's a great visualization of how

00:06:58.785 --> 00:06:59.185
this,

00:07:00.065 --> 00:07:02.305
this batch of messages is an array of messages,

00:07:02.305 --> 00:07:04.813
and then we process them individually one by one.

00:07:04.964 --> 00:07:07.324
Another feature that we have here in the UI is

00:07:07.324 --> 00:07:10.604
actually the ability to pause the delivery of

00:07:10.604 --> 00:07:11.444
these events.

00:07:11.684 --> 00:07:13.124
So if we come over here,

00:07:13.124 --> 00:07:15.364
we can change the status to pause.

00:07:16.164 --> 00:07:18.244
And what's going to happen here is if we send a

00:07:18.244 --> 00:07:19.231
bunch of these events,

00:07:19.231 --> 00:07:21.401
they're actually not going to be processed by the

00:07:21.401 --> 00:07:21.921
consumer.

00:07:21.921 --> 00:07:23.441
They're going to be stuck in this queue.

00:07:23.681 --> 00:07:26.641
And you can set at the Wrangler configuration

00:07:26.641 --> 00:07:26.961
level,

00:07:27.511 --> 00:07:30.151
how long you want data to actually be stored in

00:07:30.151 --> 00:07:31.671
the queue until it expires.

00:07:32.071 --> 00:07:32.991
And from here,

00:07:32.991 --> 00:07:33.671
if we hit list,

00:07:33.671 --> 00:07:35.991
you can see we actually have these messages here

00:07:36.151 --> 00:07:37.631
and we can add a few more.

00:07:37.631 --> 00:07:38.151
Boom,

00:07:38.151 --> 00:07:38.631
boom,

00:07:38.631 --> 00:07:39.111
boom.

00:07:39.158 --> 00:07:40.261
Let's list that one more time.

00:07:40.261 --> 00:07:41.701
You can see that we get these messages.

00:07:42.021 --> 00:07:43.961
we should be able to actually like inspect it.

00:07:43.961 --> 00:07:45.321
If this was like a JSON object,

00:07:45.321 --> 00:07:47.281
you'd be able to see more information about the

00:07:47.281 --> 00:07:48.321
contents of that queue.

00:07:48.321 --> 00:07:48.521
Now,

00:07:48.521 --> 00:07:50.161
I don't use this UI to like,

00:07:50.321 --> 00:07:51.161
do very much.

00:07:51.161 --> 00:07:52.481
I just kind of want to illustrate

00:07:52.921 --> 00:07:53.401
that currently

00:07:53.961 --> 00:07:56.081
these messages are in the queue,

00:07:56.081 --> 00:07:58.801
they're not being processed because we have paused

00:07:58.801 --> 00:08:00.281
the status and I actually,

00:08:00.281 --> 00:08:02.281
we're going to be using the pause delivery status

00:08:02.281 --> 00:08:04.121
for our dead letter queue later on.

00:08:04.441 --> 00:08:06.361
Let's go ahead and hit resume.

00:08:06.521 --> 00:08:07.721
When you hit resume,

00:08:07.801 --> 00:08:09.793
they're going to be processed over here.

00:08:09.793 --> 00:08:10.365
And then,

00:08:11.545 --> 00:08:13.145
once the consumer is done processing them,

00:08:13.145 --> 00:08:13.865
when we hit list,

00:08:13.865 --> 00:08:16.145
you can see that there are no more messages in the

00:08:16.145 --> 00:08:17.905
queue because they have all been processed.

00:08:17.985 --> 00:08:19.785
So that's just kind of like one thing to note

00:08:19.785 --> 00:08:19.985
here.

00:08:19.985 --> 00:08:22.265
You do have the ability to pause all messages from

00:08:22.265 --> 00:08:22.545
being.

00:08:23.165 --> 00:08:23.365
So if,

00:08:23.365 --> 00:08:23.525
like,

00:08:23.525 --> 00:08:25.565
there's any reason why you need to have a kill

00:08:25.565 --> 00:08:26.605
switch in your application,

00:08:26.605 --> 00:08:26.805
like,

00:08:26.805 --> 00:08:27.365
to basically say,

00:08:27.365 --> 00:08:27.725
hey,

00:08:27.805 --> 00:08:28.925
I don't want to process

00:08:29.245 --> 00:08:30.405
anything else right now,

00:08:30.405 --> 00:08:31.105
I want to wait,

00:08:31.355 --> 00:08:31.955
until like,

00:08:31.955 --> 00:08:33.835
I fix a bug or something is resolved.

00:08:33.835 --> 00:08:35.755
You can actually do that inside of the dashboard,

00:08:35.755 --> 00:08:36.395
which is kind of cool.

00:08:36.395 --> 00:08:37.515
It's kind of a cool feature to have.

00:08:37.595 --> 00:08:39.515
I only use it really for like,

00:08:39.915 --> 00:08:42.355
sticking failed messages in a dead letter queue.

00:08:42.355 --> 00:08:44.315
And then I pause the delivery of the dead letter

00:08:44.315 --> 00:08:45.275
queue just to like,

00:08:45.275 --> 00:08:47.915
retain that data until I determine what I want to

00:08:47.915 --> 00:08:48.275
do with,

00:08:48.275 --> 00:08:48.635
like,

00:08:48.635 --> 00:08:50.075
how I want to process that data.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.066 --> 00:00:00.466
All right,

00:00:00.546 --> 00:00:04.426
so now that we have a qconsumer created and we

00:00:04.426 --> 00:00:05.906
have our queue created,

00:00:05.906 --> 00:00:08.026
let's go ahead and build out the logic for the

00:00:08.026 --> 00:00:10.826
producer so we can actually send messages to the

00:00:10.826 --> 00:00:13.906
queue so they can be processed by this consumer.

00:00:14.466 --> 00:00:16.386
So right now we are in our data service

00:00:17.266 --> 00:00:20.866
project inside of our Monorepo and we have our

00:00:20.866 --> 00:00:21.586
Hono app,

00:00:21.586 --> 00:00:23.106
so our app TS file.

00:00:23.386 --> 00:00:23.506
Now,

00:00:23.506 --> 00:00:26.186
the only route that we have here right now is the

00:00:26.266 --> 00:00:28.026
Smart link router,

00:00:28.026 --> 00:00:30.506
which basically says whenever we get a link click,

00:00:30.586 --> 00:00:32.986
we're able to figure out the destination that that

00:00:32.986 --> 00:00:34.266
link click should be routed to.

00:00:34.266 --> 00:00:37.106
And then we redirect the user to that intended

00:00:37.106 --> 00:00:37.706
destination.

00:00:38.436 --> 00:00:38.866
from here,

00:00:38.866 --> 00:00:40.706
what we want to do is we want to capture that link

00:00:40.706 --> 00:00:41.186
click data,

00:00:41.186 --> 00:00:43.146
and then we want to save it in the back in our

00:00:43.146 --> 00:00:44.706
backend service so we can,

00:00:44.706 --> 00:00:45.226
you know,

00:00:45.226 --> 00:00:46.466
power different features,

00:00:47.056 --> 00:00:48.816
as part of this entire SaaS offering.

00:00:49.126 --> 00:00:49.366
Now,

00:00:49.366 --> 00:00:52.246
we could collect that data here and then save it

00:00:52.246 --> 00:00:54.566
and store it inside of this request.

00:00:54.646 --> 00:00:56.686
But what we want to do is we want to ensure that

00:00:56.686 --> 00:00:58.966
this operation happens as fast as possible.

00:00:59.206 --> 00:00:59.606
So

00:01:00.086 --> 00:01:02.086
essentially we're going to offload that data to a

00:01:02.086 --> 00:01:04.206
queue so it can be processed by an entirely

00:01:04.206 --> 00:01:05.125
separate process.

00:01:05.446 --> 00:01:05.846
And,

00:01:06.006 --> 00:01:09.046
this link redirect logic can just remain as snappy

00:01:09.046 --> 00:01:09.526
as possible.

00:01:09.846 --> 00:01:11.966
So what we're going to do is we're going to head

00:01:11.966 --> 00:01:14.326
over to our Wrangler JSON C file in our data

00:01:14.326 --> 00:01:15.046
service project,

00:01:15.846 --> 00:01:18.246
we are going to go ahead and add a producer.

00:01:18.326 --> 00:01:20.406
So if we add our producers,

00:01:21.686 --> 00:01:23.406
we all we have to do is we need to give it a

00:01:23.406 --> 00:01:23.926
binding.

00:01:24.006 --> 00:01:25.366
So I'm going to say queue.

00:01:25.446 --> 00:01:27.526
This is the object that we're going to use to

00:01:27.526 --> 00:01:28.486
access the queue

00:01:28.806 --> 00:01:31.206
and then we're going to pass in our name.

00:01:31.526 --> 00:01:33.206
So it's going to be the same name as here.

00:01:34.646 --> 00:01:35.926
And this is our queue name.

00:01:36.086 --> 00:01:36.886
So this,

00:01:37.046 --> 00:01:39.526
this basically tells our producer that the data

00:01:39.526 --> 00:01:41.846
that is going to be sent when calling this queue

00:01:41.846 --> 00:01:42.726
binding is,

00:01:43.036 --> 00:01:45.116
should arrive on this specific queue.

00:01:45.826 --> 00:01:46.936
I'm going to go ahead and run

00:01:47.256 --> 00:01:48.096
pmpm,

00:01:48.096 --> 00:01:49.016
run CF

00:01:49.336 --> 00:01:50.136
type jet

00:01:51.291 --> 00:01:53.377
and that's going to generate this queue type.

00:01:53.377 --> 00:01:55.457
And if we head over to our worker configuration,

00:01:55.457 --> 00:01:57.337
you're going to see we now have this queue binding

00:01:57.337 --> 00:01:58.577
of the type Q.

00:01:58.688 --> 00:02:00.494
So let's head over to our app TS

00:02:00.494 --> 00:02:02.009
and you're going to be able to see if we access

00:02:02.009 --> 00:02:03.049
our bindings here.

00:02:03.289 --> 00:02:04.969
We now have a Q object

00:02:05.289 --> 00:02:06.369
that has two methods.

00:02:06.369 --> 00:02:06.529
We,

00:02:06.599 --> 00:02:08.199
we have a send and we have a send batch.

00:02:08.279 --> 00:02:09.279
When we call send,

00:02:09.279 --> 00:02:11.239
we're basically just sending one event to the

00:02:11.239 --> 00:02:12.599
Queue for further processing.

00:02:12.919 --> 00:02:16.119
Send batch is going to take an array of events

00:02:16.519 --> 00:02:18.239
and essentially those are also going to be

00:02:18.239 --> 00:02:19.879
processed in like the same batch.

00:02:19.879 --> 00:02:21.879
But the reason why you'd want to use this is

00:02:22.119 --> 00:02:24.679
imagine you pull some data from like your database

00:02:24.679 --> 00:02:26.399
or something and you have a whole bunch of data

00:02:26.399 --> 00:02:28.639
and you don't want to like iterate over that data

00:02:28.639 --> 00:02:30.279
and send a thousand different,

00:02:30.609 --> 00:02:32.569
a thousand different events to the queue

00:02:32.569 --> 00:02:33.169
individually.

00:02:33.689 --> 00:02:35.649
What you can do is you can like send batches of 50

00:02:35.649 --> 00:02:37.209
or batches of 100 events.

00:02:37.329 --> 00:02:39.629
and that's going to basically make your operation

00:02:39.629 --> 00:02:39.869
much,

00:02:39.869 --> 00:02:40.109
much,

00:02:40.109 --> 00:02:40.749
much faster.

00:02:40.989 --> 00:02:42.709
And then you're not going to hit any type of like

00:02:42.709 --> 00:02:44.949
request limit where the worker runtime.

00:02:44.949 --> 00:02:46.869
If you're making these sub requests to a separate

00:02:46.869 --> 00:02:47.109
service,

00:02:47.109 --> 00:02:48.429
you only can make a thousand of them.

00:02:48.429 --> 00:02:49.549
That mean 1000 is a lot.

00:02:49.549 --> 00:02:51.509
But this just basically makes things more

00:02:51.509 --> 00:02:52.029
efficient.

00:02:52.309 --> 00:02:54.829
it is like less IO that's needed for your

00:02:54.829 --> 00:02:55.389
application,

00:02:55.629 --> 00:02:57.629
less opportunity for issues to come up.

00:02:57.949 --> 00:02:58.509
and then it's just,

00:02:58.509 --> 00:02:58.869
you know,

00:02:58.869 --> 00:02:59.269
faster.

00:02:59.269 --> 00:03:00.949
So that's what Send batch is going to do.

00:03:00.949 --> 00:03:02.789
But for now what we're going to do is we're

00:03:02.789 --> 00:03:03.778
basically going to say

00:03:04.608 --> 00:03:05.088
await

00:03:05.728 --> 00:03:07.248
c EMB Q

00:03:08.793 --> 00:03:10.633
and then we're going to send an event.

00:03:11.193 --> 00:03:13.433
Now the data that we want to capture,

00:03:13.673 --> 00:03:15.693
is going to be of the type link,

00:03:15.693 --> 00:03:16.852
click message type,

00:03:17.013 --> 00:03:19.173
which is something we've actually have defined

00:03:19.253 --> 00:03:20.453
inside of our

00:03:20.853 --> 00:03:22.213
DataOps package.

00:03:22.613 --> 00:03:25.893
So inside of our data Ops package in the Mono repo

00:03:25.973 --> 00:03:27.333
we have this type.

00:03:27.413 --> 00:03:29.013
So I'm going to go ahead and import it.

00:03:29.013 --> 00:03:30.453
So what I'm going to do is I'm going to say

00:03:31.523 --> 00:03:32.403
queue message

00:03:33.443 --> 00:03:34.483
is of the type,

00:03:34.866 --> 00:03:36.068
link click message type

00:03:36.068 --> 00:03:37.892
which is coming from our package that we have

00:03:37.892 --> 00:03:38.227
built.

00:03:38.227 --> 00:03:38.816
And then

00:03:39.216 --> 00:03:40.496
we're going to say equals.

00:03:40.732 --> 00:03:42.366
This is going to be of the type

00:03:44.206 --> 00:03:44.606
link,

00:03:44.606 --> 00:03:45.086
click.

00:03:45.406 --> 00:03:47.806
And I'm going to go ahead and go to our backend

00:03:47.806 --> 00:03:49.326
service really quick just so you can,

00:03:49.566 --> 00:03:50.926
you know or not our backend service,

00:03:50.926 --> 00:03:51.406
our data,

00:03:51.526 --> 00:03:52.436
data ops package.

00:03:52.436 --> 00:03:54.316
So you can see where this is coming from in just a

00:03:54.316 --> 00:03:54.556
second.

00:03:55.126 --> 00:03:57.006
But first what we're going to do is we're actually

00:03:57.006 --> 00:04:00.366
going to add the data that's necessary for sending

00:04:00.366 --> 00:04:01.046
to our queue.

00:04:01.046 --> 00:04:02.726
So we're going to want an id,

00:04:03.446 --> 00:04:04.966
we're going to want a country.

00:04:05.140 --> 00:04:06.400
This is the country code,

00:04:06.480 --> 00:04:06.990
from the,

00:04:06.990 --> 00:04:08.096
basically from the user.

00:04:08.407 --> 00:04:10.031
I think this is going to come from

00:04:10.031 --> 00:04:10.683
destination.

00:04:12.084 --> 00:04:13.844
We're going to want the

00:04:14.904 --> 00:04:15.484
let's see,

00:04:15.820 --> 00:04:19.340
this is actually coming from our header.

00:04:19.340 --> 00:04:20.540
So from our headers

00:04:21.180 --> 00:04:23.100
we can say I want the country,

00:04:23.740 --> 00:04:25.500
we also need to provide the destination.

00:04:25.820 --> 00:04:27.940
So the actual link that this is supposed to be

00:04:27.940 --> 00:04:28.620
routed to

00:04:29.260 --> 00:04:30.820
so we can say destin.

00:04:30.820 --> 00:04:31.170
Actually

00:04:31.170 --> 00:04:32.820
what I want to do is I want to make sure these are

00:04:32.820 --> 00:04:33.620
not in strings.

00:04:33.780 --> 00:04:34.420
Destination

00:04:34.950 --> 00:04:38.230
going to route to our actual destination URL

00:04:38.710 --> 00:04:41.950
and then we're also going to be providing an

00:04:41.950 --> 00:04:42.710
account ID

00:04:43.430 --> 00:04:45.590
which is coming from our link info data.

00:04:47.020 --> 00:04:47.607
Additionally,

00:04:47.607 --> 00:04:49.087
where you want the latitude,

00:04:49.577 --> 00:04:51.107
which is coming from our headers

00:04:52.627 --> 00:04:55.827
and we want the longitude which is also coming

00:04:55.827 --> 00:04:57.347
from our headers.

00:05:00.428 --> 00:05:01.468
And lastly,

00:05:01.868 --> 00:05:04.588
I'm just going to stick a timestamp in here

00:05:05.468 --> 00:05:08.348
just so we're able to track when this specific

00:05:08.348 --> 00:05:09.508
operation happens.

00:05:09.508 --> 00:05:10.508
So I'm going to say to

00:05:10.828 --> 00:05:12.108
ISO string

00:05:12.837 --> 00:05:15.917
now we are going to pass the Q message into the

00:05:15.917 --> 00:05:16.437
send

00:05:17.067 --> 00:05:17.627
method

00:05:18.027 --> 00:05:21.347
and essentially from here that data is going to

00:05:21.347 --> 00:05:23.627
successfully route to our queue and we're going to

00:05:23.627 --> 00:05:25.347
deploy and test it just so we can make sure

00:05:25.347 --> 00:05:26.647
everything's on the up and up.

00:05:26.887 --> 00:05:30.047
But one last thing to note is this operation is

00:05:30.047 --> 00:05:32.607
going to take a few milliseconds to basically send

00:05:32.607 --> 00:05:34.247
the data to the queue and then get an

00:05:34.247 --> 00:05:37.047
acknowledgement back from the queue that it has

00:05:37.047 --> 00:05:38.887
successfully made it to the queue.

00:05:38.887 --> 00:05:41.527
Now we don't want to wait for this IO

00:05:41.847 --> 00:05:42.247
before

00:05:42.567 --> 00:05:43.767
we actually redirect.

00:05:44.007 --> 00:05:46.527
So what we're going to do is we can copy that and

00:05:46.527 --> 00:05:47.687
then we're going to say C

00:05:48.407 --> 00:05:50.767
execution context and then we're going to access a

00:05:50.767 --> 00:05:51.927
cloudflare specific

00:05:52.567 --> 00:05:52.607
runtime

00:05:53.107 --> 00:05:53.467
feature

00:05:53.757 --> 00:05:54.557
which is wait until,

00:05:54.957 --> 00:05:57.317
which basically says you can run some like

00:05:57.317 --> 00:05:58.637
asynchronous task

00:05:58.957 --> 00:06:01.717
after redirect happens or after your request is

00:06:01.717 --> 00:06:02.317
fulfilled

00:06:02.717 --> 00:06:05.437
and you have up to 30 seconds to basically

00:06:05.997 --> 00:06:09.037
ensure that this worker stays running to complete

00:06:09.037 --> 00:06:09.277
something.

00:06:09.277 --> 00:06:11.197
And you know this operation's only going to take

00:06:11.517 --> 00:06:12.717
a few milliseconds.

00:06:12.797 --> 00:06:16.477
So the only caveat here is it no longer has to be

00:06:16.647 --> 00:06:17.937
we no longer have to await it.

00:06:18.177 --> 00:06:20.417
So all we're doing is we're saying let's go ahead

00:06:20.417 --> 00:06:24.177
and wait for the queue sending method to,

00:06:24.327 --> 00:06:26.487
to finish before we close out the worker.

00:06:26.647 --> 00:06:28.887
But this is going to be bypassed,

00:06:28.887 --> 00:06:31.567
this is going to redirect to the user and then on

00:06:31.567 --> 00:06:33.887
the background we're going to be able to send this

00:06:33.887 --> 00:06:34.807
data to the queue.

00:06:34.887 --> 00:06:37.647
Now this isn't 100% fail safe.

00:06:37.647 --> 00:06:38.567
There are very,

00:06:39.367 --> 00:06:41.367
very unlikely edge cases that would

00:06:41.687 --> 00:06:42.207
make it.

00:06:42.207 --> 00:06:44.127
So this method actually doesn't complete

00:06:44.127 --> 00:06:44.887
successfully.

00:06:44.967 --> 00:06:45.367
But

00:06:45.507 --> 00:06:46.767
the worker closes down.

00:06:46.767 --> 00:06:47.327
It's very,

00:06:47.327 --> 00:06:47.967
very rare.

00:06:48.287 --> 00:06:50.487
So if you have like insanely critical data,

00:06:50.487 --> 00:06:50.847
like

00:06:51.467 --> 00:06:52.427
transaction data,

00:06:52.667 --> 00:06:54.667
financial data data where you can have.

00:06:54.747 --> 00:06:55.147
No,

00:06:55.307 --> 00:06:55.747
you know,

00:06:55.747 --> 00:06:55.947
like,

00:06:55.947 --> 00:06:57.627
there's no leeway in losing that data.

00:06:57.787 --> 00:06:59.707
I don't know if I would necessarily use this,

00:06:59.707 --> 00:07:00.467
but other than that,

00:07:00.467 --> 00:07:01.587
this is really great for,

00:07:01.587 --> 00:07:01.787
like,

00:07:01.787 --> 00:07:04.267
analytic based things where you just need to stick

00:07:04.267 --> 00:07:04.587
data,

00:07:04.627 --> 00:07:05.187
somewhere,

00:07:05.187 --> 00:07:05.424
so.

00:07:06.305 --> 00:07:09.305
So now that we have this producer set up and we're

00:07:09.305 --> 00:07:11.185
able to send data to a queue,

00:07:11.185 --> 00:07:12.545
we're going to go ahead and deploy,

00:07:13.025 --> 00:07:15.265
just make sure everything is working as expected.

00:07:15.505 --> 00:07:16.545
So data,

00:07:16.625 --> 00:07:19.185
when we click on a link that gets redirected,

00:07:19.265 --> 00:07:20.065
we shouldn't.

00:07:20.065 --> 00:07:21.345
This should execute,

00:07:21.505 --> 00:07:23.865
it should be written to a queue and then it should

00:07:23.865 --> 00:07:25.905
be logged out right here.

00:07:26.145 --> 00:07:27.745
So I'm going to say pmpm,

00:07:28.685 --> 00:07:28.925
run,

00:07:29.165 --> 00:07:29.805
deploy.

00:07:31.055 --> 00:07:33.135
And we're going to notice there's going to be an

00:07:33.135 --> 00:07:35.895
additional binding that our application has access

00:07:35.895 --> 00:07:36.215
to,

00:07:36.215 --> 00:07:38.027
which is this new queue binding.

00:07:38.387 --> 00:07:40.347
So you can see we have a new queue binding right

00:07:40.347 --> 00:07:40.627
here.

00:07:41.266 --> 00:07:43.866
I'm going to head over to our Cloudflare dashboard

00:07:43.866 --> 00:07:45.906
and I still have the log tabs up here,

00:07:46.066 --> 00:07:47.306
so let's just go ahead and like,

00:07:47.306 --> 00:07:49.186
see if we can't try this live log again.

00:07:49.906 --> 00:07:52.466
And I have our ui,

00:07:52.466 --> 00:07:53.426
so we have our,

00:07:54.539 --> 00:07:56.702
and the user application has some of these links.

00:07:56.702 --> 00:07:57.822
So let's go ahead and

00:07:58.342 --> 00:08:00.042
I'm just going to click on a link and I'm just

00:08:00.042 --> 00:08:01.682
going to copy this top section,

00:08:01.682 --> 00:08:03.882
just because we don't have our actual URL built

00:08:03.882 --> 00:08:04.322
out yet.

00:08:04.642 --> 00:08:07.202
And then I'm going to go to our data service.

00:08:07.202 --> 00:08:09.072
This is our data service URL we're going to,

00:08:09.142 --> 00:08:12.062
which you can also access here from the deployment

00:08:12.062 --> 00:08:12.582
right here.

00:08:13.462 --> 00:08:14.322
And I'm going to,

00:08:14.322 --> 00:08:17.162
append to the end of it this specific id,

00:08:17.242 --> 00:08:18.762
because I know this is a valid id,

00:08:19.002 --> 00:08:20.922
and this should redirect to Google.

00:08:20.955 --> 00:08:22.449
And then as you can see,

00:08:22.529 --> 00:08:25.169
our real time logs were able to capture the actual

00:08:25.249 --> 00:08:25.609
link.

00:08:25.609 --> 00:08:26.049
Click.

00:08:26.129 --> 00:08:28.529
So this is the get request to a valid URL.

00:08:29.089 --> 00:08:31.769
And then I did this three times just to make sure

00:08:31.769 --> 00:08:33.249
we're able to get some data into here.

00:08:33.409 --> 00:08:33.969
And then

00:08:34.289 --> 00:08:35.969
our queue event was triggered.

00:08:35.969 --> 00:08:38.129
So you can see we have our QEvent log

00:08:38.339 --> 00:08:39.059
which is right here.

00:08:39.619 --> 00:08:42.339
And then we're actually logging out the JSON data.

00:08:42.419 --> 00:08:43.579
I'm going to go ahead and stop that.

00:08:43.579 --> 00:08:46.259
We should have a valid our valid data in our logs.

00:08:46.499 --> 00:08:49.179
And then you can see here we actually are able to

00:08:49.179 --> 00:08:50.499
capture that data that we sent.

00:08:50.499 --> 00:08:51.659
So it's of the type leak.

00:08:51.659 --> 00:08:52.099
Click.

00:08:52.309 --> 00:08:53.189
this is the destination,

00:08:53.668 --> 00:08:54.869
this is the country code,

00:08:54.869 --> 00:08:55.909
this is the link id,

00:08:56.069 --> 00:08:57.029
the timestamp,

00:08:57.189 --> 00:08:57.949
the latitude,

00:08:57.949 --> 00:08:59.149
the longitude of the user.

00:08:59.149 --> 00:09:01.349
So we're actually successfully able to capture

00:09:01.349 --> 00:09:01.669
data

00:09:02.229 --> 00:09:04.309
at this specific layer,

00:09:04.439 --> 00:09:05.319
in our application.

00:09:05.319 --> 00:09:07.319
So from here what we're going to want to do is

00:09:07.319 --> 00:09:09.399
we're going to want to actually build out the

00:09:09.799 --> 00:09:10.879
handler for this.

00:09:10.879 --> 00:09:11.239
And

00:09:11.489 --> 00:09:13.689
I like to build out the handler in a very type

00:09:13.689 --> 00:09:14.209
safe way.

00:09:14.289 --> 00:09:15.809
So I'm going to walk us through that process.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.055 --> 00:00:00.495
Alright,

00:00:00.495 --> 00:00:02.815
so now that we've successfully built a producer

00:00:02.815 --> 00:00:05.375
that writes data to a queue and then a consumer

00:00:05.375 --> 00:00:07.415
right here picks that data up from the queue,

00:00:07.655 --> 00:00:10.375
let's talk about how we can properly implement a

00:00:10.375 --> 00:00:12.215
handler to be able to

00:00:12.585 --> 00:00:15.465
ensure that the data coming into the queue is of a

00:00:15.465 --> 00:00:16.105
certain type

00:00:16.185 --> 00:00:18.425
that we expect and then how we can properly

00:00:18.425 --> 00:00:21.025
process that data in a distributed system like

00:00:21.025 --> 00:00:21.305
this.

00:00:21.385 --> 00:00:21.785
So

00:00:22.075 --> 00:00:23.625
I kind of alluded to it before,

00:00:23.625 --> 00:00:24.025
but

00:00:24.515 --> 00:00:26.275
essentially what we're doing here is we're going

00:00:26.275 --> 00:00:27.795
to be using a schema,

00:00:27.795 --> 00:00:29.475
like a Zod schema to

00:00:30.255 --> 00:00:33.215
that the data in the body is of a certain type and

00:00:33.215 --> 00:00:34.935
then we're going to handle the routing based on

00:00:34.935 --> 00:00:35.255
that.

00:00:35.255 --> 00:00:38.535
So if we head over to our actual packages over

00:00:38.535 --> 00:00:38.855
here,

00:00:39.255 --> 00:00:40.515
our data Ops package,

00:00:40.515 --> 00:00:41.795
we have this

00:00:42.155 --> 00:00:43.055
we have this Zod

00:00:43.268 --> 00:00:43.788
folder

00:00:44.108 --> 00:00:46.228
and inside of the Zod folder we have some types

00:00:46.228 --> 00:00:47.228
that I've already defined.

00:00:47.308 --> 00:00:47.978
Now you see,

00:00:48.048 --> 00:00:49.608
essentially what we're doing is we're basically

00:00:49.608 --> 00:00:50.248
saying a,

00:00:50.248 --> 00:00:50.768
when we,

00:00:50.928 --> 00:00:53.688
the data coming into a queue needs to be of a

00:00:53.688 --> 00:00:54.608
specific base

00:00:54.648 --> 00:00:54.908
type,

00:00:54.908 --> 00:00:55.748
a base schema.

00:00:55.988 --> 00:00:58.268
And what that is going to do is it's going to have

00:00:58.268 --> 00:00:58.628
a

00:00:58.898 --> 00:01:00.898
it's going to have a type with a label

00:01:01.158 --> 00:01:03.738
associated with what that event type is and then

00:01:03.738 --> 00:01:05.058
it's going to pass in some data.

00:01:05.618 --> 00:01:08.718
Now this type right now that we've implemented

00:01:08.868 --> 00:01:10.948
as you kind of saw in the,

00:01:10.948 --> 00:01:12.948
when we implemented the API router is

00:01:13.348 --> 00:01:13.748
we

00:01:14.268 --> 00:01:15.468
passed the data

00:01:15.788 --> 00:01:16.828
for the specific

00:01:17.048 --> 00:01:17.688
link click.

00:01:17.688 --> 00:01:19.608
You can kind of see that over here

00:01:19.928 --> 00:01:22.852
we have this type here where it is link click

00:01:22.934 --> 00:01:23.334
and

00:01:23.654 --> 00:01:24.294
it is

00:01:24.894 --> 00:01:27.374
passing in the data of this specific type and it's

00:01:27.374 --> 00:01:30.494
adhering to this link click message type.

00:01:30.814 --> 00:01:32.574
So if we come over to this

00:01:33.254 --> 00:01:34.674
Q ZOD schema again

00:01:35.074 --> 00:01:37.474
you can see that this is extending a base class.

00:01:37.474 --> 00:01:39.554
So basically we're just building upon this kind

00:01:39.554 --> 00:01:40.674
more generic type.

00:01:41.374 --> 00:01:41.614
Now

00:01:42.054 --> 00:01:44.374
the last thing that I've done here is I am

00:01:44.534 --> 00:01:46.854
creating a discriminated union

00:01:47.414 --> 00:01:50.774
that basically looks at the type and says the data

00:01:51.414 --> 00:01:53.324
field is going to be somewhat dynamic,

00:01:53.644 --> 00:01:56.844
but it's only going to be valid data if it

00:01:56.844 --> 00:01:59.324
conforms to the schemas that we pass into

00:01:59.884 --> 00:02:02.284
this specific discriminated union.

00:02:02.364 --> 00:02:03.404
So in the future,

00:02:03.644 --> 00:02:06.204
right now we're only processing link click types.

00:02:06.204 --> 00:02:07.804
But there could be a scenario where

00:02:08.204 --> 00:02:09.404
we start processing different,

00:02:09.954 --> 00:02:12.114
different shape data on the same queue.

00:02:12.354 --> 00:02:13.954
So we could simply create another

00:02:14.274 --> 00:02:17.234
schema that looks like this with a different type

00:02:17.234 --> 00:02:18.674
that implements some data

00:02:18.904 --> 00:02:21.564
that is supposed to receive and then that will be

00:02:21.564 --> 00:02:23.724
added here to this discriminated union.

00:02:24.124 --> 00:02:25.323
So if we,

00:02:25.323 --> 00:02:28.524
if we go ahead and we head back over to our

00:02:30.114 --> 00:02:31.874
if we head back over to our

00:02:32.274 --> 00:02:34.114
index TS in our data service,

00:02:34.434 --> 00:02:36.194
we're going to go ahead and do just that.

00:02:36.194 --> 00:02:37.554
So we're going to say const

00:02:38.544 --> 00:02:39.104
parsed

00:02:39.724 --> 00:02:40.084
event

00:02:40.964 --> 00:02:41.604
equals

00:02:42.404 --> 00:02:42.804
Q

00:02:43.124 --> 00:02:44.404
message schema.

00:02:44.644 --> 00:02:47.190
So this is our generic schema type right here

00:02:47.190 --> 00:02:48.526
and then we're going to say

00:02:48.639 --> 00:02:51.442
dot safe parse so this is going to parse the data

00:02:51.681 --> 00:02:53.242
but it's not going to throw an error

00:02:53.242 --> 00:02:54.212
if it fails

00:02:55.092 --> 00:02:57.824
and we're going to pass in message.body

00:02:57.824 --> 00:02:58.552
message.body

00:02:58.872 --> 00:03:01.352
so we're going to pass in the body into safeparse.

00:03:01.752 --> 00:03:02.152
Now

00:03:04.632 --> 00:03:06.312
the next step is basically going to be

00:03:06.712 --> 00:03:08.232
ensuring that the

00:03:08.632 --> 00:03:10.392
event successfully parsed.

00:03:10.392 --> 00:03:13.672
So we can say parsed event.success.

00:03:14.792 --> 00:03:17.592
then here we're going to handle the successful

00:03:17.592 --> 00:03:20.032
event parse and if it doesn't conform to the type

00:03:20.032 --> 00:03:20.632
that we expect

00:03:21.352 --> 00:03:24.152
we're just going to go ahead and log out or error

00:03:24.392 --> 00:03:25.232
console error.

00:03:25.232 --> 00:03:25.512
The

00:03:25.912 --> 00:03:26.832
actual like

00:03:27.502 --> 00:03:28.382
parsed event

00:03:28.422 --> 00:03:29.232
error message.

00:03:29.792 --> 00:03:30.192
Now

00:03:30.782 --> 00:03:32.342
here you can do more than logging.

00:03:32.342 --> 00:03:32.982
You could probably,

00:03:32.982 --> 00:03:33.382
you know,

00:03:33.382 --> 00:03:35.022
in a production ready system you could

00:03:35.052 --> 00:03:36.822
send some data to like whatever

00:03:37.082 --> 00:03:39.242
alerting mechanism you have for monitoring your

00:03:39.242 --> 00:03:39.802
application.

00:03:39.882 --> 00:03:41.842
But for now we're just going to go ahead and log

00:03:41.842 --> 00:03:42.362
that information.

00:03:42.616 --> 00:03:45.216
The next step here is we're going to take a look.

00:03:45.216 --> 00:03:46.376
We're basically going to say,

00:03:46.626 --> 00:03:49.156
the event is going to be the parsed event dot data

00:03:49.796 --> 00:03:51.076
and then we can,

00:03:51.236 --> 00:03:54.076
from here we can check if it's of a specific type.

00:03:54.076 --> 00:03:56.236
We can pass it off to a specific handler.

00:03:56.236 --> 00:03:56.996
So we can say

00:03:57.316 --> 00:03:58.556
right now we only have one type,

00:03:58.556 --> 00:03:58.956
obviously.

00:03:58.956 --> 00:03:59.636
So if event

00:04:00.036 --> 00:04:00.916
dot type

00:04:01.396 --> 00:04:01.956
equals.

00:04:01.956 --> 00:04:04.036
And this should autocomplete the only type name

00:04:04.036 --> 00:04:05.516
that we have because this is a literal,

00:04:05.516 --> 00:04:06.396
which is kind of nice,

00:04:06.396 --> 00:04:07.476
it autocompletes for us,

00:04:08.096 --> 00:04:08.816
link click.

00:04:09.136 --> 00:04:11.616
Then we're going to pass it into a handler we're

00:04:11.616 --> 00:04:12.176
going to define.

00:04:12.176 --> 00:04:13.976
And right now that handler is just going to take

00:04:13.976 --> 00:04:16.856
that data and it's going to save it in our link

00:04:16.856 --> 00:04:17.696
clicks database,

00:04:17.696 --> 00:04:19.876
or links click table inside of our D1 database.

00:04:19.876 --> 00:04:21.916
Now if you remember earlier in the course we

00:04:21.916 --> 00:04:23.196
created a whole bunch of

00:04:23.546 --> 00:04:25.766
tables and we didn't use all those tables right

00:04:25.766 --> 00:04:26.046
away.

00:04:26.286 --> 00:04:29.166
One of the tables we didn't use is actually this

00:04:29.166 --> 00:04:30.486
link clicks table.

00:04:30.486 --> 00:04:32.686
So if we select star from

00:04:33.416 --> 00:04:34.216
link clicks,

00:04:35.416 --> 00:04:37.096
you're going to notice that there shouldn't be any

00:04:37.096 --> 00:04:37.776
data in here.

00:04:37.776 --> 00:04:38.936
It should be totally empty,

00:04:39.056 --> 00:04:41.176
because we haven't actually inserted any data into

00:04:41.176 --> 00:04:41.336
here.

00:04:41.336 --> 00:04:41.616
But,

00:04:41.696 --> 00:04:43.296
but what's going to happen is our

00:04:44.116 --> 00:04:46.796
queue pipeline is going to get that data and it's

00:04:46.796 --> 00:04:48.435
going to save it into this table.

00:04:48.435 --> 00:04:49.636
So that's our very first operation.

00:04:49.636 --> 00:04:51.876
There will be more operations that our handler

00:04:51.876 --> 00:04:52.196
does,

00:04:52.196 --> 00:04:53.556
but that's going to be the first one.

00:04:53.716 --> 00:04:54.596
So if you remember,

00:04:54.676 --> 00:04:55.556
all of our

00:04:56.466 --> 00:04:57.686
all of our actual,

00:04:57.836 --> 00:05:01.116
actual database operations we put in a package so

00:05:01.116 --> 00:05:02.556
we can share them across different

00:05:03.226 --> 00:05:03.916
implementations,

00:05:03.916 --> 00:05:05.436
so across different applications.

00:05:05.516 --> 00:05:08.716
So inside of our data ops package we can head over

00:05:08.716 --> 00:05:10.396
to the queries links

00:05:10.796 --> 00:05:12.036
and at the very bottom.

00:05:12.036 --> 00:05:12.795
Let's go ahead.

00:05:12.795 --> 00:05:14.316
I'm just going to copy this in for now.

00:05:14.316 --> 00:05:16.156
We're going to create a method called add link

00:05:16.156 --> 00:05:16.716
clicks.

00:05:16.876 --> 00:05:19.636
And Add link clicks is going to ensure that it

00:05:19.636 --> 00:05:22.316
takes the data from the schema that we've defined

00:05:22.316 --> 00:05:23.196
inside of our

00:05:23.716 --> 00:05:25.076
ZOD schema for the queue

00:05:25.476 --> 00:05:26.116
and then

00:05:26.596 --> 00:05:29.076
it's going to be using this specific table.

00:05:29.466 --> 00:05:30.976
this is our drizzle table.

00:05:30.976 --> 00:05:33.136
Link clicks and then it's just passing in the

00:05:33.136 --> 00:05:33.616
basic information.

00:05:33.616 --> 00:05:34.216
Account id,

00:05:34.216 --> 00:05:34.736
destination,

00:05:34.736 --> 00:05:35.096
country,

00:05:35.096 --> 00:05:35.416
click,

00:05:35.416 --> 00:05:35.616
time,

00:05:35.616 --> 00:05:36.016
latitude,

00:05:36.016 --> 00:05:36.416
longitude.

00:05:36.416 --> 00:05:37.816
This is the data that we're sending into the

00:05:37.816 --> 00:05:38.176
queue.

00:05:38.546 --> 00:05:40.306
there's no manipulation needed from here.

00:05:40.306 --> 00:05:41.906
This is just basically getting that information

00:05:42.306 --> 00:05:43.986
and inserting it into our table.

00:05:44.066 --> 00:05:46.746
Now make sure you CD into your package so you can

00:05:46.746 --> 00:05:47.666
properly build this.

00:05:48.386 --> 00:05:50.066
So we're going to go into packages,

00:05:51.026 --> 00:05:51.346
cd,

00:05:51.426 --> 00:05:52.386
Data Ops,

00:05:52.706 --> 00:05:53.626
pnpm,

00:05:53.626 --> 00:05:54.466
run build.

00:05:54.466 --> 00:05:55.586
That's going to build this.

00:05:55.746 --> 00:05:56.626
Make sure you build.

00:05:56.706 --> 00:05:58.706
It's very critical to build just so

00:05:59.106 --> 00:05:59.506
you,

00:05:59.586 --> 00:05:59.946
your

00:05:59.946 --> 00:06:02.446
applications will have access to this add link

00:06:02.446 --> 00:06:03.166
click method.

00:06:03.166 --> 00:06:05.406
So I'm going to head back into our

00:06:05.706 --> 00:06:06.856
actual application,

00:06:07.176 --> 00:06:09.896
our data service and we are in our data service

00:06:09.896 --> 00:06:11.496
now so we can go over here.

00:06:11.656 --> 00:06:12.056
And

00:06:12.496 --> 00:06:14.856
what I'm going to do is I'm going to create,

00:06:15.656 --> 00:06:16.576
I actually already created this.

00:06:16.576 --> 00:06:17.816
I'm going to delete this really quick.

00:06:17.816 --> 00:06:19.896
So we are going to create a

00:06:19.999 --> 00:06:20.639
folder

00:06:20.959 --> 00:06:21.359
called

00:06:21.779 --> 00:06:23.899
that is called Q handlers

00:06:25.259 --> 00:06:28.059
and queue handlers is going to contain all of the

00:06:28.219 --> 00:06:30.299
different like logic that we're going to implement

00:06:30.299 --> 00:06:32.379
whenever you build out like logic to process data

00:06:32.379 --> 00:06:33.099
from a queue.

00:06:33.499 --> 00:06:34.859
So I'm going to call this the

00:06:35.179 --> 00:06:35.659
link

00:06:36.349 --> 00:06:36.829
click.

00:06:36.829 --> 00:06:37.149
So this,

00:06:37.149 --> 00:06:39.629
this handler is the link clicks handler.

00:06:43.109 --> 00:06:46.029
And right now this handler is going to take in

00:06:46.029 --> 00:06:46.629
some data here.

00:06:46.629 --> 00:06:47.829
So it's going to take in

00:06:48.229 --> 00:06:51.109
the event which is the event type received by the

00:06:51.109 --> 00:06:51.509
queue

00:06:52.309 --> 00:06:54.229
and then it is going to

00:06:54.609 --> 00:06:56.669
use this database method that we just defined

00:06:56.669 --> 00:06:58.829
inside of our package called add link click.

00:06:58.909 --> 00:07:02.189
And you can see that it got imported from our repo

00:07:02.189 --> 00:07:04.749
data ops which is our package queries link.

00:07:04.749 --> 00:07:06.349
So this is the method that we just defined.

00:07:06.429 --> 00:07:09.549
So this is kind of just like a wrapper around a

00:07:09.549 --> 00:07:10.669
database call for now.

00:07:10.729 --> 00:07:12.799
but in the future this method is going,

00:07:12.799 --> 00:07:15.199
this add link click method is going to handle

00:07:15.199 --> 00:07:16.439
different types of operations.

00:07:16.439 --> 00:07:18.479
One is going to save data into a queue.

00:07:18.639 --> 00:07:18.999
Two,

00:07:18.999 --> 00:07:21.199
it's probably going to interface with a workflow,

00:07:21.199 --> 00:07:23.199
it's going to interface with durable objects and

00:07:23.199 --> 00:07:25.279
there's just going to be like an entire cascade,

00:07:25.629 --> 00:07:26.739
cascading amount of

00:07:27.309 --> 00:07:28.949
or the data is just going to kind of cascade

00:07:28.949 --> 00:07:30.789
across different type of handlers to like do

00:07:30.789 --> 00:07:32.429
different things as we build out more features.

00:07:32.429 --> 00:07:33.629
So for now it's simple.

00:07:33.709 --> 00:07:34.669
We're passing in env.

00:07:34.829 --> 00:07:35.949
We're not using it right now,

00:07:35.949 --> 00:07:37.469
but we will be using it in the future.

00:07:37.549 --> 00:07:40.429
So just note that so we can head back over to our

00:07:40.429 --> 00:07:40.869
index.

00:07:40.869 --> 00:07:42.569
TS Looks like we have a

00:07:43.279 --> 00:07:43.729
error here.

00:07:43.729 --> 00:07:45.129
And then I am just going to say

00:07:45.609 --> 00:07:46.249
await,

00:07:47.609 --> 00:07:50.609
we can import this handling click and then pass in

00:07:50.609 --> 00:07:53.049
this emv and then we're going to pass in our

00:07:53.049 --> 00:07:53.369
event.

00:07:53.449 --> 00:07:56.129
So this is our parsed event and it is of a

00:07:56.129 --> 00:07:58.689
specific type and that type is the same that is

00:07:58.689 --> 00:07:59.609
needed by our handler.

00:07:59.769 --> 00:08:02.169
So just to kind of recap here we have a producer

00:08:02.169 --> 00:08:04.089
since data queue the queue,

00:08:04.249 --> 00:08:06.209
get that data on a queue gets picked up by our

00:08:06.209 --> 00:08:06.649
consumer,

00:08:06.649 --> 00:08:07.849
which is implemented here.

00:08:08.089 --> 00:08:10.489
We are going to do some parsing to make sure all

00:08:10.489 --> 00:08:12.969
of the data that enters this queue is of a certain

00:08:12.969 --> 00:08:13.549
type type.

00:08:13.549 --> 00:08:14.549
If we don't know the type,

00:08:14.549 --> 00:08:15.389
we don't know that data.

00:08:15.389 --> 00:08:16.869
We don't want to process it because it's just

00:08:16.869 --> 00:08:18.069
going to mess things up in our system.

00:08:18.499 --> 00:08:19.209
if it's a success,

00:08:19.369 --> 00:08:21.289
if we successfully parse that message,

00:08:21.449 --> 00:08:23.729
we're going to go take a look at the type of event

00:08:23.729 --> 00:08:25.689
that it is and based upon the type we're going to

00:08:25.689 --> 00:08:26.729
pass it into a handler.

00:08:26.729 --> 00:08:29.289
And this handler right now is just sticking data

00:08:29.529 --> 00:08:31.449
in this data and in this table.

00:08:31.689 --> 00:08:33.649
So let's go ahead and deploy this pnpm,

00:08:33.649 --> 00:08:33.929
run,

00:08:34.969 --> 00:08:35.529
deploy

00:08:36.489 --> 00:08:38.449
and while this is deploying you can head over to

00:08:38.449 --> 00:08:39.129
your ui.

00:08:40.119 --> 00:08:41.239
just make sure that you

00:08:41.719 --> 00:08:42.119
get

00:08:42.439 --> 00:08:44.839
the like go to one of your links,

00:08:45.319 --> 00:08:45.719
find

00:08:46.279 --> 00:08:49.719
the ID for that link and eventually we're going to

00:08:49.719 --> 00:08:51.559
have the UI is going to be a little bit better,

00:08:51.559 --> 00:08:54.319
so we'll be able to copy it and whatnot and then

00:08:54.319 --> 00:08:56.199
go to the URL for your data service.

00:08:56.519 --> 00:08:57.279
So we're going to go,

00:08:57.279 --> 00:08:57.879
data service.

00:08:58.279 --> 00:09:00.279
I'm going to pass this right here and I'm going to

00:09:00.279 --> 00:09:00.759
hit enter.

00:09:01.159 --> 00:09:03.879
Now we redirected to Google and within a few

00:09:03.879 --> 00:09:05.959
seconds that queue should process

00:09:07.129 --> 00:09:07.529
the data

00:09:07.849 --> 00:09:10.729
and it should stick it in this link clicks table.

00:09:10.729 --> 00:09:11.769
So when we run this again,

00:09:11.769 --> 00:09:13.449
you can see we have data

00:09:13.639 --> 00:09:15.149
that actually made it into our queue,

00:09:15.149 --> 00:09:16.029
which is really nice.

00:09:16.189 --> 00:09:16.589
So

00:09:17.439 --> 00:09:19.359
just to kind of recap data flow,

00:09:19.359 --> 00:09:21.039
we have our producer which

00:09:21.359 --> 00:09:21.759
is

00:09:22.529 --> 00:09:24.689
being used inside of our redirect service,

00:09:24.929 --> 00:09:26.649
sending data to the queue.

00:09:26.649 --> 00:09:27.569
The queue is being

00:09:27.739 --> 00:09:29.659
the data from the queue is being picked up from a

00:09:29.659 --> 00:09:31.579
consumer and the consumer is taking that data and

00:09:31.579 --> 00:09:33.139
sticking it into a database.

00:09:33.139 --> 00:09:34.769
So that's what we have now.

00:09:34.769 --> 00:09:36.679
we kind of have like an end to end flow working

00:09:36.679 --> 00:09:36.999
now.

00:09:36.999 --> 00:09:37.359
So

00:09:37.659 --> 00:09:39.499
from here once you get to this point in building

00:09:39.499 --> 00:09:40.299
an application,

00:09:40.539 --> 00:09:42.939
you kind of have like all the foundation built out

00:09:43.099 --> 00:09:46.139
and you'll be able to implement really quickly new

00:09:46.139 --> 00:09:46.579
features.

00:09:46.579 --> 00:09:47.659
So like if you,

00:09:47.659 --> 00:09:50.059
if you want to add more logic into the handler,

00:09:50.059 --> 00:09:51.099
it's very modular,

00:09:51.099 --> 00:09:52.779
you can add logic into the new handler.

00:09:52.779 --> 00:09:54.779
If you want to add different types of events,

00:09:54.799 --> 00:09:55.719
that do different things,

00:09:55.719 --> 00:09:57.039
you can send it to the same queue,

00:09:57.119 --> 00:09:58.559
you can implement a new handler.

00:09:59.039 --> 00:10:01.079
and the thing that I really like about it is as

00:10:01.079 --> 00:10:03.079
your project grows and you start bringing on new

00:10:03.079 --> 00:10:03.679
team members,

00:10:03.679 --> 00:10:04.439
you can say like,

00:10:04.439 --> 00:10:04.879
okay,

00:10:04.879 --> 00:10:06.759
these guys are just focused on like,

00:10:06.759 --> 00:10:07.839
kind of like the front end,

00:10:08.099 --> 00:10:09.039
lightweight backend.

00:10:09.039 --> 00:10:10.919
They interface with the database and then all

00:10:10.919 --> 00:10:11.799
these data operations.

00:10:11.799 --> 00:10:12.999
Maybe you have another guy that's like,

00:10:12.999 --> 00:10:13.239
okay,

00:10:13.239 --> 00:10:15.199
I'm going to really build out

00:10:15.279 --> 00:10:17.139
all these features on the back end and I'm going

00:10:17.139 --> 00:10:17.579
to make sure like,

00:10:17.579 --> 00:10:18.339
they're really modular,

00:10:18.339 --> 00:10:19.139
really testable,

00:10:19.459 --> 00:10:20.339
really professional.

00:10:20.339 --> 00:10:22.739
And it's like kind of like this contract in the

00:10:22.739 --> 00:10:23.579
middle where you can say like,

00:10:23.579 --> 00:10:23.899
okay,

00:10:23.899 --> 00:10:25.459
you guys that are working on the front end,

00:10:25.459 --> 00:10:26.259
make sure the data,

00:10:26.559 --> 00:10:28.279
that's put onto this queue is of this specific

00:10:28.279 --> 00:10:29.359
type and

00:10:29.919 --> 00:10:31.439
send it to me under these conditions.

00:10:31.439 --> 00:10:33.439
And then I'm going to build out all this logic.

00:10:33.439 --> 00:10:35.319
So in parallel you can start building like really

00:10:35.319 --> 00:10:36.719
advanced features and systems.

00:10:37.119 --> 00:10:37.959
So it's great for like,

00:10:37.959 --> 00:10:38.639
small projects,

00:10:38.639 --> 00:10:41.139
but it can actually grow into larger projects as

00:10:41.139 --> 00:10:41.419
well.

00:10:41.419 --> 00:10:44.059
So this is kind of why I enjoy queues and why I

00:10:44.059 --> 00:10:44.339
think it's

00:10:44.559 --> 00:10:45.239
kind of like a

00:10:45.559 --> 00:10:46.479
overlooked,

00:10:46.479 --> 00:10:47.159
underused,

00:10:47.619 --> 00:10:50.439
mechanism in a lot of full stack projects and why

00:10:50.439 --> 00:10:51.759
I think more people should use it.

00:10:51.839 --> 00:10:53.079
So in this next video,

00:10:53.079 --> 00:10:54.079
we're going to dive deeper,

00:10:54.079 --> 00:10:55.639
specifically into the Cloudflare queue,

00:10:55.639 --> 00:10:57.599
and we're going to look at different configuration

00:10:57.599 --> 00:10:59.719
options that they provide us that are on the more

00:10:59.719 --> 00:11:00.385
advanced side.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.000 --> 00:00:00.348
All right,

00:00:00.348 --> 00:00:02.988
so let's dive deeper into the advanced topics in

00:00:02.988 --> 00:00:04.428
regards to Cloudflare queues.

00:00:04.618 --> 00:00:05.448
I just want to note,

00:00:05.448 --> 00:00:07.688
before we dive too deep is the current

00:00:07.688 --> 00:00:10.168
architecture of our system is we have our data

00:00:10.168 --> 00:00:11.168
service application,

00:00:11.408 --> 00:00:13.248
and the data service application

00:00:14.048 --> 00:00:14.118
has,

00:00:14.188 --> 00:00:17.028
a Hono API and it also has a qconsumer,

00:00:17.028 --> 00:00:18.148
as you can see right here.

00:00:18.148 --> 00:00:20.388
So we have our fetch handler and then we also have

00:00:20.388 --> 00:00:21.268
a qconsumer.

00:00:21.268 --> 00:00:23.868
Each one of these are considered triggers inside

00:00:23.868 --> 00:00:24.148
of

00:00:24.448 --> 00:00:25.608
Cloudflare's ecosystem.

00:00:25.608 --> 00:00:28.408
And each trigger can invoke the worker runtime or

00:00:28.408 --> 00:00:28.998
your worker,

00:00:28.998 --> 00:00:30.028
application code.

00:00:30.428 --> 00:00:31.628
And right now,

00:00:31.628 --> 00:00:33.948
when a request comes into the Hono API,

00:00:33.948 --> 00:00:36.588
we're able to determine which route or which

00:00:36.588 --> 00:00:38.388
destination it should be routed to.

00:00:38.388 --> 00:00:40.107
And then we just simply redirect to that service.

00:00:40.107 --> 00:00:42.108
And after that redirect is done,

00:00:42.428 --> 00:00:44.348
we are sending some data onto a queue,

00:00:44.428 --> 00:00:47.108
and then that data stays on a queue and then it

00:00:47.108 --> 00:00:47.948
triggers this,

00:00:48.578 --> 00:00:49.468
queue consumer,

00:00:49.698 --> 00:00:51.978
which is still part of the same data service.

00:00:51.978 --> 00:00:54.018
And this is totally valid,

00:00:54.078 --> 00:00:56.518
a totally valid implementation within Cloudflare.

00:00:56.598 --> 00:00:56.878
Now,

00:00:56.878 --> 00:00:58.478
a lot of people kind of might think like,

00:00:58.478 --> 00:00:58.838
oh,

00:00:58.998 --> 00:01:01.158
your consumer and your producer code should be

00:01:01.158 --> 00:01:01.918
totally separate.

00:01:01.918 --> 00:01:03.158
They should be separate deployables.

00:01:03.158 --> 00:01:03.318
And,

00:01:03.318 --> 00:01:03.638
you know,

00:01:03.638 --> 00:01:04.738
that also is fine.

00:01:04.738 --> 00:01:07.098
it's a very flexible pattern from what I found.

00:01:07.098 --> 00:01:08.858
I have a lot of services that I've built for

00:01:08.858 --> 00:01:11.098
clients where we'll have like seven different

00:01:11.098 --> 00:01:11.858
backend services.

00:01:11.938 --> 00:01:13.218
They're all pretty lightweight.

00:01:13.218 --> 00:01:13.618
And,

00:01:13.938 --> 00:01:15.998
one backend service will send some data to a queue

00:01:15.998 --> 00:01:17.918
and it will be picked up by a totally separate

00:01:18.158 --> 00:01:18.718
deployable.

00:01:18.718 --> 00:01:19.118
So

00:01:19.438 --> 00:01:21.678
they don't necessarily have to live inside of the

00:01:21.678 --> 00:01:21.998
same,

00:01:22.378 --> 00:01:22.998
application.

00:01:23.478 --> 00:01:24.918
The only caveat here is,

00:01:24.918 --> 00:01:26.678
is when you're running this locally,

00:01:27.078 --> 00:01:28.878
so when you run this application locally,

00:01:28.878 --> 00:01:30.838
you say NPM run dev.

00:01:32.098 --> 00:01:34.258
you are able to basically say,

00:01:34.418 --> 00:01:35.458
the queue is,

00:01:36.078 --> 00:01:38.198
the queue right now is running locally.

00:01:38.198 --> 00:01:40.998
So all the queue data is saved inside of the data

00:01:40.998 --> 00:01:41.358
service,

00:01:41.438 --> 00:01:43.198
inside of the Wrangler folder in state.

00:01:43.278 --> 00:01:44.718
And there's going to be some like,

00:01:45.518 --> 00:01:45.798
you know,

00:01:45.798 --> 00:01:48.238
state management specifically for handling queues.

00:01:48.398 --> 00:01:50.398
So if you want to write like,

00:01:50.398 --> 00:01:52.878
actually test your consumer locally,

00:01:52.878 --> 00:01:54.358
there's kind of two ways of doing it.

00:01:54.358 --> 00:01:55.758
One is you can create a

00:01:56.078 --> 00:01:57.118
dummy API

00:01:57.518 --> 00:01:59.838
point right here that writes some data.

00:01:59.838 --> 00:02:01.918
Then you can just go to localhost and you can hit

00:02:01.918 --> 00:02:02.238
that.

00:02:02.508 --> 00:02:05.758
you can also trigger a queue through the Wrangler

00:02:05.758 --> 00:02:06.318
cli.

00:02:06.318 --> 00:02:08.238
There's some documentation for that that I'll link

00:02:08.238 --> 00:02:09.078
in this description.

00:02:09.638 --> 00:02:10.038
And,

00:02:10.268 --> 00:02:12.438
you could also technically use remote binding.

00:02:12.438 --> 00:02:13.918
So there's a lot of different things that you can

00:02:13.918 --> 00:02:14.278
do here.

00:02:14.278 --> 00:02:14.598
And

00:02:15.258 --> 00:02:16.938
I don't think that there's like one,

00:02:17.508 --> 00:02:18.178
pattern that's like,

00:02:18.178 --> 00:02:19.018
better than the other.

00:02:19.228 --> 00:02:21.468
but the only caveat here is if you have like

00:02:21.468 --> 00:02:24.348
multiple data services and you run one locally and

00:02:24.588 --> 00:02:25.588
one data service,

00:02:25.588 --> 00:02:25.988
so like,

00:02:25.988 --> 00:02:26.748
let's say you have

00:02:27.468 --> 00:02:27.498
another

00:02:27.728 --> 00:02:28.688
service over here

00:02:28.713 --> 00:02:30.664
and that service writes to this queue

00:02:30.984 --> 00:02:33.264
and the consumer lives in this service.

00:02:33.264 --> 00:02:34.584
When you run this locally,

00:02:34.744 --> 00:02:36.984
this consumer isn't actually going to be able to

00:02:36.984 --> 00:02:37.624
pick up data,

00:02:37.764 --> 00:02:38.524
running locally.

00:02:38.524 --> 00:02:40.004
Now you could do remote bindings,

00:02:40.004 --> 00:02:41.604
but remote bindings with

00:02:42.154 --> 00:02:44.474
the queue implementation can become a little bit

00:02:44.474 --> 00:02:45.194
messy because,

00:02:45.934 --> 00:02:47.894
it technically can only have one consumer.

00:02:47.894 --> 00:02:50.054
So what I typically like to do is,

00:02:50.054 --> 00:02:50.574
you know,

00:02:50.574 --> 00:02:53.774
make things really modular and then test just the

00:02:53.774 --> 00:02:54.334
handler.

00:02:54.604 --> 00:02:55.644
so just this

00:02:56.284 --> 00:02:57.724
bit of code right here,

00:02:57.776 --> 00:02:59.536
basically just this chunk right here.

00:02:59.586 --> 00:03:01.266
I like to kind of test that and

00:03:01.826 --> 00:03:03.866
not have to continuously run this thing locally.

00:03:03.866 --> 00:03:04.146
I,

00:03:04.226 --> 00:03:06.546
I find that I'm able to develop quicker if I'm not

00:03:06.546 --> 00:03:08.646
just like relying on console log statements in the

00:03:08.646 --> 00:03:09.086
terminal.

00:03:09.706 --> 00:03:12.186
but from here I just kind of want to get into a

00:03:12.186 --> 00:03:13.266
lot of the other configurations.

00:03:13.266 --> 00:03:13.666
So like,

00:03:13.666 --> 00:03:14.346
let's talk about,

00:03:14.856 --> 00:03:17.656
some producer features and then consumer features,

00:03:17.656 --> 00:03:19.238
retry dead letter and whatnot.

00:03:19.465 --> 00:03:19.865
Okay,

00:03:19.865 --> 00:03:20.905
so one of the main,

00:03:21.725 --> 00:03:24.125
consumer or one of the main producer features that

00:03:24.125 --> 00:03:24.765
I want to show

00:03:25.245 --> 00:03:26.885
is something that we're actually not going to be

00:03:26.885 --> 00:03:27.165
using.

00:03:27.245 --> 00:03:27.845
But it's,

00:03:27.845 --> 00:03:30.085
it's something that's good to know is when you

00:03:30.085 --> 00:03:30.845
send data,

00:03:31.075 --> 00:03:31.765
to your,

00:03:31.765 --> 00:03:33.205
when you send data to your

00:03:34.065 --> 00:03:34.625
queue,

00:03:35.105 --> 00:03:37.745
you can additionally pass in some options.

00:03:38.065 --> 00:03:39.585
One of the options is

00:03:40.225 --> 00:03:41.265
content type.

00:03:41.585 --> 00:03:42.625
Now content type,

00:03:42.625 --> 00:03:44.105
they have a few different valid types here.

00:03:44.105 --> 00:03:44.905
You can send bytes,

00:03:44.905 --> 00:03:45.625
you can send JSON,

00:03:45.625 --> 00:03:46.425
you can send text,

00:03:46.425 --> 00:03:47.365
you can send V8.

00:03:47.365 --> 00:03:49.805
Now because this is just like an object,

00:03:49.805 --> 00:03:51.965
it's going to be treated as JSON,

00:03:52.155 --> 00:03:52.405
which

00:03:52.805 --> 00:03:54.125
that's just going to be default.

00:03:54.125 --> 00:03:55.565
But you could in theory,

00:03:55.565 --> 00:03:57.845
if you're like processing lower level stuff,

00:03:57.995 --> 00:03:59.975
you could send over raw bytes,

00:03:59.975 --> 00:04:01.155
you could send just text.

00:04:01.605 --> 00:04:03.655
and it looks like you also have like a VA type,

00:04:03.655 --> 00:04:05.815
which I'm not entirely familiar with what this

00:04:05.815 --> 00:04:06.655
would be used for.

00:04:07.135 --> 00:04:08.575
so that's like one thing to note.

00:04:08.655 --> 00:04:11.055
And from there I think from the consumer

00:04:11.055 --> 00:04:11.615
perspective,

00:04:12.085 --> 00:04:13.355
if it's of a specific type,

00:04:13.355 --> 00:04:15.595
you might not have to parse it in a.

00:04:15.915 --> 00:04:16.515
You might like,

00:04:16.515 --> 00:04:17.995
let's say it's JSON.

00:04:18.155 --> 00:04:18.915
So for example,

00:04:18.915 --> 00:04:19.275
our

00:04:19.325 --> 00:04:20.493
consumer is looking.

00:04:20.813 --> 00:04:24.173
Our consumer doesn't actually take this and go

00:04:24.173 --> 00:04:26.933
from like a JSON string to an object.

00:04:26.933 --> 00:04:28.573
It just knows that it's an object.

00:04:28.753 --> 00:04:30.453
so that's kind of what this content type is able

00:04:30.453 --> 00:04:30.893
to do.

00:04:31.213 --> 00:04:33.533
And the thing that I find really good and really

00:04:33.533 --> 00:04:36.333
cool with the producer is you also have

00:04:36.803 --> 00:04:38.083
this delay seconds.

00:04:38.403 --> 00:04:40.483
Now this is an optional parameter now,

00:04:40.483 --> 00:04:42.483
but what you can do is I think it's like between

00:04:42.963 --> 00:04:45.963
0 seconds and 12 hours is the window that you have

00:04:45.963 --> 00:04:46.163
here.

00:04:46.163 --> 00:04:49.443
So you could basically say like I want to wait 10

00:04:49.443 --> 00:04:49.923
minutes.

00:04:50.993 --> 00:04:52.683
and this is 10 minutes and seconds.

00:04:52.683 --> 00:04:53.643
And you.

00:04:53.803 --> 00:04:54.283
What is,

00:04:54.283 --> 00:04:55.723
what happens is that data

00:04:56.283 --> 00:04:58.563
goes to the queue but isn't actually processed by

00:04:58.563 --> 00:05:01.483
the consumer until this time hits that threshold.

00:05:01.483 --> 00:05:03.403
And I find this really useful for a lot of

00:05:03.403 --> 00:05:04.203
different use cases.

00:05:04.203 --> 00:05:06.123
Like one of the scenarios is,

00:05:06.503 --> 00:05:09.463
when using the Twilio Twilio API to send SMS

00:05:09.463 --> 00:05:10.103
texts,

00:05:10.313 --> 00:05:13.113
what you can do is you can basically send a text

00:05:13.273 --> 00:05:15.593
and then you get a Twilio id and then I go and

00:05:15.593 --> 00:05:16.713
stick a Twilio id,

00:05:17.123 --> 00:05:19.773
inside of the data of a queue and then I say wait

00:05:19.773 --> 00:05:20.413
10 minutes.

00:05:20.653 --> 00:05:22.453
And the reason why I want to wait 10 minutes is

00:05:22.453 --> 00:05:23.253
because Twilio,

00:05:23.253 --> 00:05:23.613
like

00:05:23.933 --> 00:05:26.933
within a few minutes that message should arrive by

00:05:26.933 --> 00:05:27.453
the user.

00:05:27.453 --> 00:05:29.413
And then if you call the API again you can check

00:05:29.413 --> 00:05:32.413
like if the message was delivered or if it failed,

00:05:32.413 --> 00:05:33.293
or if it's

00:05:33.643 --> 00:05:34.243
just been sent.

00:05:34.243 --> 00:05:34.603
Right.

00:05:35.003 --> 00:05:36.283
So from here I just add,

00:05:36.283 --> 00:05:36.443
like,

00:05:36.443 --> 00:05:37.563
an arbitrary delay,

00:05:37.963 --> 00:05:39.243
check it in 10 minutes,

00:05:39.243 --> 00:05:41.363
and the consumer basically just calls the API,

00:05:41.363 --> 00:05:42.083
gets that data,

00:05:42.083 --> 00:05:42.843
keeps track of,

00:05:42.843 --> 00:05:43.163
like,

00:05:43.163 --> 00:05:44.163
what has been delivered,

00:05:44.163 --> 00:05:45.443
what hasn't delivered and whatnot.

00:05:45.443 --> 00:05:46.963
So that's a valid use case for this.

00:05:46.963 --> 00:05:48.403
There's a lot of different reasons why you might

00:05:48.403 --> 00:05:49.003
want to add some,

00:05:49.003 --> 00:05:49.243
like,

00:05:49.243 --> 00:05:50.363
delay when you send.

00:05:50.363 --> 00:05:52.403
But it's just one cool feature that Cloudflare has

00:05:52.403 --> 00:05:54.923
kind of baked into the producer side of things.

00:05:55.071 --> 00:05:57.471
Now the consumer is where you have a lot

00:05:57.661 --> 00:05:59.991
of flexibility around how to configure things

00:05:59.991 --> 00:06:02.671
specifically for a use case or your use case that

00:06:02.671 --> 00:06:03.511
you're implementing.

00:06:03.511 --> 00:06:06.911
So this is our consumer and if we head over to the

00:06:06.911 --> 00:06:07.511
wrangler

00:06:07.911 --> 00:06:08.471
JSON

00:06:08.801 --> 00:06:09.591
C file,

00:06:09.751 --> 00:06:11.551
we're going to notice right now the only thing

00:06:11.551 --> 00:06:13.831
that we've passed into this consumer is

00:06:14.001 --> 00:06:14.811
a queue name.

00:06:14.891 --> 00:06:16.491
But you also have a few different

00:06:17.131 --> 00:06:18.091
props or

00:06:19.221 --> 00:06:20.751
variables that you can configure here.

00:06:20.991 --> 00:06:23.191
And we'll kind of talk through a few of these.

00:06:23.191 --> 00:06:23.671
So like,

00:06:23.671 --> 00:06:26.431
the first one that I want to look at is the

00:06:26.851 --> 00:06:27.891
max retries.

00:06:28.291 --> 00:06:28.691
So

00:06:29.411 --> 00:06:30.771
essentially by default,

00:06:31.101 --> 00:06:32.551
Q is going to retry three times.

00:06:32.551 --> 00:06:34.351
Meaning if your logic here

00:06:34.751 --> 00:06:36.111
fails for whatever reason,

00:06:36.511 --> 00:06:39.631
it's going to retry three times until that

00:06:39.901 --> 00:06:42.061
it's going to retry three times until it basically

00:06:42.061 --> 00:06:43.261
just throws that message away.

00:06:43.661 --> 00:06:45.941
And this could be useful if like you rely on an

00:06:45.941 --> 00:06:48.441
external API and that API goes down for just a

00:06:48.441 --> 00:06:48.681
second

00:06:49.001 --> 00:06:49.401
and

00:06:49.881 --> 00:06:51.481
you still want to process that data,

00:06:51.561 --> 00:06:53.721
it'll just automatically retry it for you.

00:06:53.721 --> 00:06:55.881
Now there might be scenarios where you don't want

00:06:55.881 --> 00:06:56.481
to retry.

00:06:56.481 --> 00:06:59.601
Like if you are sending data to an LLM and it's

00:06:59.601 --> 00:07:00.401
really really expensive,

00:07:00.401 --> 00:07:02.441
or like image generation and it's really really

00:07:02.441 --> 00:07:02.921
expensive,

00:07:03.161 --> 00:07:05.321
you might not want some scenario where your

00:07:05.321 --> 00:07:08.201
application code fails and you continuously ping

00:07:08.201 --> 00:07:10.201
that API and like rack up all this money,

00:07:10.291 --> 00:07:11.571
and your code gets stuck.

00:07:11.571 --> 00:07:13.011
So this is kind of where

00:07:13.101 --> 00:07:14.471
depending on what type of use case you're

00:07:14.471 --> 00:07:16.471
implementing at the consumer level,

00:07:16.471 --> 00:07:18.631
you can basically say how many times you want to

00:07:18.631 --> 00:07:18.911
ret.

00:07:19.531 --> 00:07:20.571
So we're not gonna,

00:07:20.571 --> 00:07:22.331
we're just gonna keep the default for this use

00:07:22.331 --> 00:07:23.131
case right now.

00:07:23.371 --> 00:07:25.931
But if you did set like let's say you said five

00:07:25.931 --> 00:07:26.171
times,

00:07:26.171 --> 00:07:28.001
I'm gonna retry five times is your

00:07:28.231 --> 00:07:28.871
logic.

00:07:28.951 --> 00:07:29.751
You could also

00:07:30.071 --> 00:07:31.111
provide a

00:07:31.511 --> 00:07:31.541
retry

00:07:31.931 --> 00:07:32.411
delay.

00:07:32.411 --> 00:07:35.171
So you could basically say how long in between

00:07:35.171 --> 00:07:36.451
each time it retries.

00:07:36.451 --> 00:07:37.531
Do you want that to be.

00:07:37.611 --> 00:07:39.931
So that's one value that's like pretty cool here.

00:07:40.731 --> 00:07:42.651
And then the thing that we're going to be using

00:07:42.731 --> 00:07:43.371
the most,

00:07:43.371 --> 00:07:43.771
or

00:07:44.091 --> 00:07:47.411
at least using as part of this course is the dead

00:07:47.411 --> 00:07:48.091
letter Q.

00:07:48.461 --> 00:07:49.991
and essentially what this is saying is

00:07:50.371 --> 00:07:50.931
saying if

00:07:51.651 --> 00:07:53.891
we retry until we hit that threshold

00:07:55.571 --> 00:07:57.331
and this event is just going to fail,

00:07:57.331 --> 00:07:59.011
we're not going to process it anymore.

00:07:59.171 --> 00:08:01.091
If you configure a dead letter queue,

00:08:01.171 --> 00:08:03.891
it'll send that data onto a dead letter queue so

00:08:03.891 --> 00:08:05.783
you can manage those failed events separately.

00:08:05.957 --> 00:08:08.237
So let's quickly head over to the Cloudflare

00:08:08.237 --> 00:08:10.437
dashboard and let's create a dead letter queue.

00:08:10.597 --> 00:08:12.437
So if we head over here,

00:08:12.437 --> 00:08:13.317
let's go to

00:08:13.637 --> 00:08:14.917
storage and databases,

00:08:15.317 --> 00:08:17.916
let's go to queues and I'm going to create a new

00:08:17.916 --> 00:08:18.397
queue here.

00:08:18.397 --> 00:08:19.397
So I'm going to call this

00:08:19.867 --> 00:08:20.817
smart links

00:08:21.777 --> 00:08:23.057
dead letter,

00:08:24.647 --> 00:08:25.157
stage,

00:08:25.557 --> 00:08:27.815
because this is just lower environment for now

00:08:28.419 --> 00:08:29.539
we can create that queue.

00:08:30.579 --> 00:08:33.499
And then what I'm going to immediately do is I'm

00:08:33.499 --> 00:08:34.499
going to come into here,

00:08:34.579 --> 00:08:35.859
I'm going to go to messages

00:08:36.499 --> 00:08:38.099
and I am going to

00:08:38.499 --> 00:08:41.299
have the status to be paused because I want,

00:08:41.299 --> 00:08:41.939
I don't want

00:08:42.339 --> 00:08:45.259
any data to be actually processed when it arrives

00:08:45.259 --> 00:08:46.579
to the queue for the time being.

00:08:47.379 --> 00:08:48.939
So we're going to head over here,

00:08:48.939 --> 00:08:50.419
we're going to basically say here's our dead

00:08:50.419 --> 00:08:51.059
letter queue

00:08:51.539 --> 00:08:52.099
and then

00:08:52.759 --> 00:08:55.199
we can head over into our index TS file and then

00:08:55.199 --> 00:08:57.639
we're going to intentionally throw an error here

00:08:57.719 --> 00:09:00.119
so we can comment out this code for now.

00:09:00.199 --> 00:09:01.239
And then let's just

00:09:03.699 --> 00:09:04.899
throw new

00:09:05.219 --> 00:09:08.179
error and we'll just say test error.

00:09:08.499 --> 00:09:09.059
Okay,

00:09:09.619 --> 00:09:11.219
so we can PNPM run,

00:09:11.219 --> 00:09:12.099
deploy this.

00:09:13.873 --> 00:09:16.113
Now if we head over to

00:09:16.833 --> 00:09:17.233
our

00:09:17.873 --> 00:09:18.233
link,

00:09:18.233 --> 00:09:19.233
so I have one saved here,

00:09:19.233 --> 00:09:21.633
I'm just going to say this is our data service.

00:09:22.433 --> 00:09:23.793
This should trigger that queue.

00:09:23.793 --> 00:09:25.553
We just did a redirect and

00:09:25.933 --> 00:09:29.353
instead of that data actually flowing into the

00:09:29.353 --> 00:09:29.713
table,

00:09:29.713 --> 00:09:31.313
because right now we're saving the link click

00:09:31.313 --> 00:09:31.713
table.

00:09:31.873 --> 00:09:34.273
What we're going to notice is if we come over to

00:09:34.273 --> 00:09:34.593
our

00:09:35.503 --> 00:09:38.623
we come over to our dead letter queue and we go to

00:09:38.623 --> 00:09:38.943
list,

00:09:39.103 --> 00:09:40.383
we should have some data

00:09:40.523 --> 00:09:41.843
that ends up in this queue.

00:09:41.843 --> 00:09:42.323
Message

00:09:42.723 --> 00:09:43.043
now.

00:09:43.043 --> 00:09:44.883
Right now we're not doing anything with

00:09:45.203 --> 00:09:47.203
the data inside of

00:09:47.383 --> 00:09:48.003
this queue.

00:09:48.403 --> 00:09:49.683
We are just simply like,

00:09:49.683 --> 00:09:51.043
it's just simply being stored here.

00:09:51.043 --> 00:09:54.003
Now this is kind of where dead letter or like

00:09:54.003 --> 00:09:56.283
failed event processing becomes more advanced

00:09:56.283 --> 00:09:58.123
because there's so many different routes that you

00:09:58.123 --> 00:09:58.643
can go.

00:09:58.883 --> 00:09:59.443
You could,

00:09:59.443 --> 00:10:01.043
and this is what we're going to do for now

00:10:01.583 --> 00:10:01.823
is

00:10:02.707 --> 00:10:05.827
you could just basically say I'm going to

00:10:06.485 --> 00:10:08.065
make another consumer here

00:10:09.136 --> 00:10:11.496
and it's going to be consuming from the dead

00:10:11.496 --> 00:10:12.176
letter queue.

00:10:12.176 --> 00:10:14.016
And then we're basically just going to say

00:10:14.336 --> 00:10:16.496
we're going to do a number of retries.

00:10:16.496 --> 00:10:18.256
We'll just call it zero for now.

00:10:18.496 --> 00:10:20.296
So now this has two consumers.

00:10:20.296 --> 00:10:22.365
And then inside of your application logic,

00:10:22.365 --> 00:10:24.777
whenever you receive a batch of events,

00:10:25.237 --> 00:10:28.397
the batch is going to be a batch specifically from

00:10:28.397 --> 00:10:28.997
a queue.

00:10:28.997 --> 00:10:31.317
So this queue is going to be,

00:10:31.339 --> 00:10:33.348
this queue is going to be the name of the queue

00:10:33.428 --> 00:10:34.868
that we have inside of our

00:10:35.528 --> 00:10:36.688
wrangler JSON C.

00:10:36.688 --> 00:10:38.448
So it's either going to be this

00:10:39.008 --> 00:10:39.098
smart

00:10:39.267 --> 00:10:41.348
link stated queue or the dead letter queue.

00:10:41.348 --> 00:10:44.228
So if you wanted to segment the processing logic,

00:10:44.228 --> 00:10:45.828
depending on if it's a

00:10:46.148 --> 00:10:47.628
failed message or not,

00:10:47.628 --> 00:10:49.228
or if it's coming from a dead letter queue,

00:10:49.228 --> 00:10:50.228
you could do it this way.

00:10:50.468 --> 00:10:52.748
You could also create an entirely separate

00:10:52.748 --> 00:10:53.108
service,

00:10:53.818 --> 00:10:55.818
that is that implements a queue handler

00:10:56.778 --> 00:10:58.978
that only processes dead letter queues as well if

00:10:58.978 --> 00:10:59.658
you wanted to,

00:10:59.658 --> 00:11:00.298
depending on

00:11:00.608 --> 00:11:01.278
your use case.

00:11:01.358 --> 00:11:02.998
Now for us we're not really going to have to

00:11:02.998 --> 00:11:04.158
distinguish between the two.

00:11:04.158 --> 00:11:06.598
We're just going to have that data get parked onto

00:11:06.598 --> 00:11:09.038
that queue and then it's going to be configured

00:11:09.038 --> 00:11:09.677
into here.

00:11:09.838 --> 00:11:10.076
So

00:11:10.076 --> 00:11:10.933
it's going to be configured.

00:11:10.933 --> 00:11:11.613
So basically

00:11:11.823 --> 00:11:14.933
any of these failed events they can end up back,

00:11:15.083 --> 00:11:16.913
in this dead letter queue and then we can go

00:11:16.913 --> 00:11:19.073
toggle the dead letter queue from pause back to

00:11:19.073 --> 00:11:19.513
resume.

00:11:19.513 --> 00:11:20.713
If we want to process this,

00:11:21.093 --> 00:11:21.573
process them.

00:11:21.573 --> 00:11:22.613
So it's just very simpler,

00:11:22.693 --> 00:11:23.973
simple handling for now.

00:11:24.053 --> 00:11:25.333
But just know that you can,

00:11:25.333 --> 00:11:25.693
you know,

00:11:25.693 --> 00:11:27.013
build a very advanced system

00:11:27.193 --> 00:11:29.273
and workflow on top of these features.

00:11:29.593 --> 00:11:33.113
So I'm going to head back to our index ts,

00:11:33.353 --> 00:11:34.073
go ahead and

00:11:34.633 --> 00:11:35.744
uncomment this guy

00:11:36.743 --> 00:11:37.143
and

00:11:38.921 --> 00:11:40.841
we can go ahead and deploy one more time.

00:11:42.320 --> 00:11:43.520
And if we look at our

00:11:43.840 --> 00:11:44.800
SQL table,

00:11:44.800 --> 00:11:47.760
so I'm just going to head over to our SQL table

00:11:47.827 --> 00:11:48.943
and I'm going to select

00:11:49.583 --> 00:11:49.983
star

00:11:50.383 --> 00:11:51.983
from link clicks.

00:11:52.225 --> 00:11:54.141
So you can see we only have two records in here.

00:11:54.301 --> 00:11:55.821
If we look at our queue

00:11:56.541 --> 00:11:58.541
we have two records that are pending.

00:11:58.541 --> 00:12:00.621
Our deployment has successfully went through.

00:12:01.101 --> 00:12:02.301
So when I resume this,

00:12:02.646 --> 00:12:04.886
our consumer should now pick that up.

00:12:06.246 --> 00:12:08.926
we shouldn't have any more inside of our messages

00:12:08.926 --> 00:12:11.126
that are in that queue for this dead letter queue.

00:12:11.286 --> 00:12:12.926
And then if we run this query again,

00:12:12.926 --> 00:12:14.966
we should see that we have four entries into here.

00:12:14.966 --> 00:12:16.686
So you can see that now we processed all that

00:12:16.686 --> 00:12:16.966
data.

00:12:17.046 --> 00:12:19.726
So this flow was basically process some data,

00:12:19.726 --> 00:12:20.406
it failed,

00:12:20.406 --> 00:12:21.846
it got sent to a dead letter queue,

00:12:21.846 --> 00:12:23.366
that dead letter queue was paused.

00:12:23.366 --> 00:12:25.686
So like that the data wasn't processed.

00:12:25.846 --> 00:12:26.566
We then

00:12:27.226 --> 00:12:29.066
in this scenario imagine like you have some

00:12:29.066 --> 00:12:29.786
service outage,

00:12:29.786 --> 00:12:30.026
right?

00:12:30.026 --> 00:12:32.506
You go like ensure that the issue is resolved,

00:12:32.506 --> 00:12:33.386
everything's fixed,

00:12:33.986 --> 00:12:35.186
resumed and working as expected.

00:12:35.506 --> 00:12:38.626
Then you head back over to your queue and you hit

00:12:38.626 --> 00:12:39.346
resume.

00:12:39.426 --> 00:12:41.466
So what I like to do for these dead letter queue

00:12:41.466 --> 00:12:44.226
setups is I just like keep it paused at all times

00:12:44.546 --> 00:12:46.826
and then if I ever get data onto this queue,

00:12:46.826 --> 00:12:49.465
I kind of on a case by case basis figure out how

00:12:49.465 --> 00:12:50.226
to process it,

00:12:50.226 --> 00:12:52.506
but it really just depends on your workload.

00:12:52.506 --> 00:12:55.306
So this is another like advanced feature and the

00:12:55.306 --> 00:12:56.506
routes that you can go are endless.

00:12:56.506 --> 00:12:57.906
But just note it's really cool.

00:12:57.906 --> 00:12:59.556
And you can build some like really,

00:12:59.706 --> 00:13:01.666
really production ready systems on top of just

00:13:01.666 --> 00:13:03.946
these very simple primitives and configurations.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.060 --> 00:00:00.460
All right,

00:00:00.460 --> 00:00:01.660
so in this next section of the course,

00:00:01.660 --> 00:00:03.260
we're going to be building out our evaluation

00:00:03.260 --> 00:00:03.900
engine,

00:00:03.900 --> 00:00:07.380
which ultimately is a multi step workflow that is

00:00:07.380 --> 00:00:09.980
designed to check these destination URLs to make

00:00:09.980 --> 00:00:11.860
sure the content behind those URLs is still

00:00:11.860 --> 00:00:13.060
available or still healthy.

00:00:13.060 --> 00:00:14.260
So if it's an E commerce page,

00:00:14.260 --> 00:00:16.500
you can imagine a user would want to know if the

00:00:16.500 --> 00:00:17.850
product is all of a sudden sold out.

00:00:18.450 --> 00:00:19.770
and we're going to use AI to do this.

00:00:19.770 --> 00:00:20.130
So like,

00:00:20.130 --> 00:00:21.850
there's a lot of directions this tool could go.

00:00:21.850 --> 00:00:23.850
We're going to keep it pretty simple for this

00:00:23.850 --> 00:00:24.170
course.

00:00:24.170 --> 00:00:24.530
But

00:00:24.930 --> 00:00:25.330
throughout,

00:00:25.380 --> 00:00:26.540
throughout the development of this,

00:00:26.540 --> 00:00:27.340
you can kind of think like,

00:00:27.340 --> 00:00:27.540
oh,

00:00:27.540 --> 00:00:29.100
how could I extend this to make it more powerful

00:00:29.100 --> 00:00:30.020
and more feature rich.

00:00:30.020 --> 00:00:30.340
But

00:00:30.590 --> 00:00:31.880
what we're going to do is we're going to leverage

00:00:31.880 --> 00:00:34.640
Cloudflare workflows to essentially build a multi

00:00:34.640 --> 00:00:38.640
step workflow where we 1 load the destination URL,

00:00:38.720 --> 00:00:41.200
make sure all the content loads fully renders,

00:00:41.200 --> 00:00:42.680
because sometimes important information is

00:00:42.680 --> 00:00:45.280
populated by JavaScript after like the pages

00:00:45.360 --> 00:00:46.640
retrieved from a server.

00:00:47.220 --> 00:00:48.500
once it's fully loaded,

00:00:48.580 --> 00:00:49.540
grab all that content,

00:00:50.110 --> 00:00:50.830
save all the text,

00:00:50.830 --> 00:00:52.670
save all the HTML and then

00:00:52.670 --> 00:00:55.750
pass that over to an AI model as the next step to

00:00:56.150 --> 00:00:58.610
ultimately determine like our logic to determine

00:00:58.610 --> 00:00:59.930
if a link is healthy or not.

00:00:59.930 --> 00:01:01.490
And then the last step is going to be stuffing

00:01:01.490 --> 00:01:03.850
that data back into R2 just so we can store it

00:01:03.850 --> 00:01:04.570
temporarily,

00:01:04.590 --> 00:01:05.239
so we can

00:01:05.560 --> 00:01:06.480
build out like,

00:01:06.480 --> 00:01:06.920
you know,

00:01:06.920 --> 00:01:08.040
this isn't something we're going to do in the

00:01:08.040 --> 00:01:08.200
course,

00:01:08.200 --> 00:01:09.840
but you can imagine you could build out different

00:01:09.840 --> 00:01:10.280
types of

00:01:10.350 --> 00:01:12.630
workflows to evaluate the,

00:01:12.630 --> 00:01:15.150
to manually evaluate or to use AI to evaluate

00:01:15.170 --> 00:01:16.530
the accuracy of your

00:01:16.980 --> 00:01:17.900
evaluation engine.

00:01:17.900 --> 00:01:18.260
So,

00:01:18.600 --> 00:01:19.960
this is a pretty cool section.

00:01:20.100 --> 00:01:22.160
we're going to be using Cloudflare workflows.

00:01:22.160 --> 00:01:23.040
We're going to use the Open,

00:01:23.200 --> 00:01:24.800
or we're going to use the AI SDK,

00:01:24.907 --> 00:01:27.124
and then browser rendering by Puppeteer.

00:01:27.124 --> 00:01:27.484
So

00:01:28.194 --> 00:01:30.394
before we dive too deep into the actual code

00:01:30.394 --> 00:01:30.994
implementation,

00:01:30.994 --> 00:01:32.714
let's just kind of like take a look at what

00:01:32.714 --> 00:01:33.754
Cloudflare workers are.

00:01:33.754 --> 00:01:35.634
So their documentation on Cloudflare workers are

00:01:35.634 --> 00:01:35.914
pretty good.

00:01:35.914 --> 00:01:37.074
It's a relatively new product.

00:01:37.154 --> 00:01:38.914
It just recently became generally available.

00:01:39.154 --> 00:01:39.434
I

00:01:39.894 --> 00:01:41.854
use this product way more than I originally

00:01:41.854 --> 00:01:42.454
thought that I would.

00:01:42.454 --> 00:01:43.374
I always thought that like,

00:01:43.374 --> 00:01:43.574
oh,

00:01:43.574 --> 00:01:45.054
I could do the same thing theoretically with

00:01:45.054 --> 00:01:45.814
durable objects,

00:01:45.814 --> 00:01:47.734
which you can because this is built on top of

00:01:47.734 --> 00:01:48.654
durable objects.

00:01:48.654 --> 00:01:49.014
But

00:01:50.214 --> 00:01:51.214
it's running,

00:01:51.214 --> 00:01:53.414
it's technically running on Cloudflare's account,

00:01:53.414 --> 00:01:55.254
not like your Personal Cloudflare account.

00:01:55.254 --> 00:01:56.454
So there are like,

00:01:56.454 --> 00:01:58.014
because of that they're able to like release this

00:01:58.014 --> 00:01:59.934
on the free tier so you can use it even if like

00:01:59.934 --> 00:02:01.174
you're not paying for Cloudflare.

00:02:01.414 --> 00:02:03.294
And there's some different like limits and pricing

00:02:03.294 --> 00:02:04.054
related to that,

00:02:04.054 --> 00:02:05.494
but it's a really cool product.

00:02:05.534 --> 00:02:07.154
ultimately like if we just read through here,

00:02:07.154 --> 00:02:07.474
it

00:02:08.044 --> 00:02:09.444
workflows allow you to build multi step

00:02:09.444 --> 00:02:11.404
applications that can automatically retry,

00:02:11.404 --> 00:02:11.964
persist,

00:02:11.964 --> 00:02:13.404
state and run for minutes,

00:02:13.404 --> 00:02:13.724
hours,

00:02:13.724 --> 00:02:14.764
days or weeks.

00:02:16.084 --> 00:02:16.332
so

00:02:16.332 --> 00:02:19.304
there's so many workflows that I find myself in,

00:02:19.544 --> 00:02:21.224
that I find myself building out and using

00:02:21.544 --> 00:02:22.944
in this new world of AI.

00:02:22.944 --> 00:02:25.224
Because so much is just like it used to be.

00:02:25.304 --> 00:02:27.424
Most operations you just kind of do behind an API,

00:02:27.424 --> 00:02:28.184
they're pretty quick.

00:02:28.314 --> 00:02:30.954
and then like the heavier long running tasks that

00:02:30.954 --> 00:02:32.234
I would do at an enterprise level,

00:02:32.234 --> 00:02:34.074
you'd use like really beefy hardware.

00:02:34.074 --> 00:02:35.754
You'd use airflow to orchestrate,

00:02:36.104 --> 00:02:36.784
spark jobs.

00:02:36.784 --> 00:02:38.664
You'd move tons and tons of data around.

00:02:38.664 --> 00:02:40.944
But with this AI inference world you're kind of

00:02:40.944 --> 00:02:41.944
like you know,

00:02:41.944 --> 00:02:43.064
sending off a request,

00:02:43.144 --> 00:02:44.904
waiting 30 seconds for something to happen,

00:02:44.904 --> 00:02:45.504
getting that,

00:02:45.504 --> 00:02:47.984
making sure that you're reliably able to get the

00:02:47.984 --> 00:02:48.264
result,

00:02:48.344 --> 00:02:48.824
save it,

00:02:48.824 --> 00:02:49.544
store it how,

00:02:49.544 --> 00:02:50.774
how you want to store it.

00:02:51.354 --> 00:02:53.474
and because of this like the whole API model

00:02:53.474 --> 00:02:53.954
doesn't work.

00:02:53.954 --> 00:02:56.434
But it's also not like a heavy task that you want

00:02:56.434 --> 00:02:59.314
to like kind of offload to these more like really

00:02:59.314 --> 00:03:01.154
beefy data orchestration software.

00:03:01.154 --> 00:03:01.514
So

00:03:01.874 --> 00:03:04.074
Cloudflare Workflows is a great tool for that.

00:03:04.074 --> 00:03:06.634
And if you look at like just like the basic setup

00:03:06.634 --> 00:03:06.994
of it,

00:03:07.554 --> 00:03:09.074
essentially all that you have to do

00:03:09.474 --> 00:03:11.554
is you use the workflow entry point,

00:03:11.634 --> 00:03:13.594
you extend it with whatever your class name is,

00:03:13.594 --> 00:03:15.874
and then you define a run method that takes an

00:03:15.874 --> 00:03:18.074
event and like you can pass data into this event,

00:03:18.074 --> 00:03:19.874
so you can pass some parameters into this event

00:03:20.434 --> 00:03:23.394
and then you define some steps and inside of this

00:03:23.394 --> 00:03:24.994
run method is where your workflow lives.

00:03:24.994 --> 00:03:26.754
So like you can say like this is your first step

00:03:26.754 --> 00:03:28.194
and it's doing something with files.

00:03:28.194 --> 00:03:29.714
This isn't honestly the best example,

00:03:29.714 --> 00:03:30.034
but

00:03:30.434 --> 00:03:32.544
and then the next step is like an API response,

00:03:32.764 --> 00:03:35.484
like goes to an API and then the next one is like,

00:03:35.484 --> 00:03:35.684
oh,

00:03:35.684 --> 00:03:36.924
let's sleep for a period of time.

00:03:36.924 --> 00:03:38.124
It's pretty cool that you can sleep.

00:03:38.124 --> 00:03:39.144
there's other things that you could do.

00:03:39.144 --> 00:03:41.104
You could like say pause and wait for an event

00:03:41.424 --> 00:03:43.784
and your workflow could literally just pause for

00:03:43.784 --> 00:03:45.304
like a whole year if you needed to.

00:03:45.304 --> 00:03:46.864
And then you can have some other service doing

00:03:46.864 --> 00:03:48.704
something and then when something is completed,

00:03:48.864 --> 00:03:50.464
it could tell your workflow,

00:03:50.464 --> 00:03:50.744
hey,

00:03:50.744 --> 00:03:51.184
here's an,

00:03:51.184 --> 00:03:51.784
here's an event.

00:03:51.784 --> 00:03:53.024
I just finished this.

00:03:53.104 --> 00:03:54.464
And then when you get that event,

00:03:54.464 --> 00:03:55.544
you could like resume.

00:03:55.544 --> 00:03:56.944
So that's another cool feature that they have.

00:03:57.264 --> 00:03:57.584
but really,

00:03:57.584 --> 00:03:59.734
it's just the thing that I like about it the most

00:03:59.734 --> 00:04:03.094
is I can take like these isolated steps of logic

00:04:03.094 --> 00:04:03.894
and I can

00:04:03.914 --> 00:04:06.015
define whatever code that I have inside of here.

00:04:06.255 --> 00:04:08.775
And then what you can do is you can define like

00:04:08.775 --> 00:04:10.335
inside of a config that's optional.

00:04:10.335 --> 00:04:11.895
There's some defaults if you don't specify

00:04:11.895 --> 00:04:14.175
anything where you can say how many times you want

00:04:14.175 --> 00:04:14.895
it to retry.

00:04:15.155 --> 00:04:16.545
the delay of each retry,

00:04:16.545 --> 00:04:18.145
like the back off strategy,

00:04:18.145 --> 00:04:18.945
so exponential.

00:04:18.945 --> 00:04:21.065
So like increasingly becomes longer and longer

00:04:21.065 --> 00:04:22.065
each time it retries.

00:04:22.065 --> 00:04:23.825
And it's really cool that you can do that at a

00:04:23.825 --> 00:04:25.345
step level because you could

00:04:25.975 --> 00:04:27.815
render a browser which is relatively cheap.

00:04:27.965 --> 00:04:28.555
and you could say,

00:04:28.555 --> 00:04:28.835
okay,

00:04:28.835 --> 00:04:29.395
if it fails,

00:04:29.395 --> 00:04:30.555
I want to do this like three times.

00:04:30.725 --> 00:04:33.355
and then when you do the AI computation for the

00:04:33.355 --> 00:04:33.835
next step,

00:04:33.835 --> 00:04:34.275
you know,

00:04:34.275 --> 00:04:34.915
you could say like,

00:04:34.915 --> 00:04:35.235
I don't.

00:04:35.235 --> 00:04:36.395
If like there's an issue with

00:04:36.765 --> 00:04:37.435
my logic,

00:04:37.435 --> 00:04:39.835
or if there's an issue with like some provider,

00:04:40.475 --> 00:04:42.155
probably mostly just your logic,

00:04:42.315 --> 00:04:43.155
you could say like,

00:04:43.155 --> 00:04:43.715
if it fails,

00:04:43.715 --> 00:04:44.355
it fails once.

00:04:44.355 --> 00:04:46.195
I'm not going to try it five different times and

00:04:46.195 --> 00:04:46.596
then like

00:04:46.596 --> 00:04:49.255
multiply my AI spin by five times and then not

00:04:49.255 --> 00:04:51.055
have my code in like a functioning state.

00:04:51.055 --> 00:04:51.455
So

00:04:51.885 --> 00:04:53.685
it is really cool that you can segment this logic

00:04:53.685 --> 00:04:55.005
in this really concise way.

00:04:55.565 --> 00:04:56.125
and then

00:04:56.289 --> 00:04:57.249
one thing that

00:04:58.389 --> 00:04:59.269
is important to know,

00:04:59.269 --> 00:05:00.589
they do have some different limits here.

00:05:00.589 --> 00:05:00.949
So

00:05:01.749 --> 00:05:03.789
depending on your workload this might be an issue.

00:05:03.789 --> 00:05:04.549
I think for

00:05:04.869 --> 00:05:06.229
95% of

00:05:06.549 --> 00:05:07.229
people's work,

00:05:07.229 --> 00:05:08.229
like use cases,

00:05:08.229 --> 00:05:09.149
this isn't an issue.

00:05:09.149 --> 00:05:11.909
But they do have a concurrent workflow instance

00:05:11.909 --> 00:05:12.429
execution,

00:05:12.429 --> 00:05:15.669
which essentially means the number of instances of

00:05:15.669 --> 00:05:17.349
your workflow that are currently running at a

00:05:17.349 --> 00:05:18.149
given point in time.

00:05:18.439 --> 00:05:19.479
If you're on a paid tier,

00:05:19.479 --> 00:05:20.959
can be 4,500,

00:05:20.959 --> 00:05:21.639
which is really,

00:05:21.639 --> 00:05:23.679
really high for a concurrent use case.

00:05:23.679 --> 00:05:24.039
And

00:05:24.849 --> 00:05:26.809
if you do need more than that,

00:05:26.809 --> 00:05:28.169
they do have this like,

00:05:28.169 --> 00:05:30.049
form that you can fill out to request for higher

00:05:30.049 --> 00:05:30.409
limits.

00:05:30.409 --> 00:05:31.409
I don't really know like

00:05:31.729 --> 00:05:32.129
how

00:05:32.609 --> 00:05:33.409
often they

00:05:33.838 --> 00:05:36.199
will give you those like limit increases.

00:05:36.199 --> 00:05:37.679
I assume they would,

00:05:37.679 --> 00:05:38.119
you know,

00:05:38.119 --> 00:05:38.559
like they.

00:05:38.639 --> 00:05:40.789
Cloudflare seems to work with you.

00:05:41.329 --> 00:05:42.129
but yeah,

00:05:42.129 --> 00:05:43.169
I would just keep this in mind.

00:05:43.169 --> 00:05:45.529
Like if you have some random use case which you

00:05:45.529 --> 00:05:45.769
know,

00:05:45.769 --> 00:05:48.239
where you have like 10,000 concurrent runs going

00:05:48.239 --> 00:05:48.839
on at a,

00:05:48.919 --> 00:05:49.959
at a given point in time,

00:05:49.959 --> 00:05:52.399
this might not be the best option just because of

00:05:52.399 --> 00:05:53.479
this limitation right here,

00:05:53.639 --> 00:05:55.999
but you could theoretically build out this exact

00:05:55.999 --> 00:05:57.479
same thing on top of durable objects.

00:05:57.479 --> 00:05:59.199
And we'll be getting into durable objects later in

00:05:59.199 --> 00:05:59.639
this course,

00:05:59.799 --> 00:06:01.399
so definitely keep that in mind.

00:06:01.429 --> 00:06:02.588
if you're going to sleep,

00:06:02.588 --> 00:06:04.709
kind of like delay something for running,

00:06:05.109 --> 00:06:06.709
you have a maximum of a year,

00:06:06.709 --> 00:06:07.789
which is kind of crazy.

00:06:07.789 --> 00:06:09.869
You could just like tell your code to sleep and

00:06:09.869 --> 00:06:10.789
then six months from now,

00:06:10.789 --> 00:06:11.549
wake up and do something,

00:06:11.549 --> 00:06:11.949
you know,

00:06:11.949 --> 00:06:12.189
which,

00:06:12.189 --> 00:06:12.869
which is cool.

00:06:12.869 --> 00:06:15.069
these are like the core limitations that I do

00:06:15.069 --> 00:06:16.309
think that you should call out.

00:06:16.769 --> 00:06:17.009
and

00:06:17.365 --> 00:06:18.925
one other thing that I wanted to call out.

00:06:18.925 --> 00:06:19.445
This is a very,

00:06:19.445 --> 00:06:21.325
very similar product to something else called

00:06:21.325 --> 00:06:22.285
trigger.dev.

00:06:22.285 --> 00:06:24.125
this is a really popular background task.

00:06:24.125 --> 00:06:25.005
They kind of rebranded,

00:06:25.005 --> 00:06:27.045
they're now saying background jobs and AI

00:06:27.285 --> 00:06:28.125
infrastructure.

00:06:28.125 --> 00:06:31.204
So lots of people use this for building out

00:06:31.204 --> 00:06:32.645
workflows that interface with,

00:06:32.875 --> 00:06:33.875
AI providers.

00:06:33.875 --> 00:06:36.435
And what I've noticed is tons and tons of people

00:06:36.435 --> 00:06:36.955
that like,

00:06:36.955 --> 00:06:38.795
commit to the Vercel ecosystem,

00:06:39.035 --> 00:06:41.115
they end up using this as a secondary product.

00:06:41.355 --> 00:06:42.935
Just because Vercel doesn't have

00:06:42.935 --> 00:06:45.645
Some type of durable execution engine the way that

00:06:45.885 --> 00:06:45.915
Vercel,

00:06:46.385 --> 00:06:48.585
or the way that Cloudflare and other providers do.

00:06:48.585 --> 00:06:48.945
So

00:06:49.505 --> 00:06:50.185
the main difference,

00:06:50.185 --> 00:06:50.385
like,

00:06:50.385 --> 00:06:50.705
I think,

00:06:50.705 --> 00:06:53.065
I do think that I haven't used trigger.dev,

00:06:53.065 --> 00:06:54.985
but I have seen some different use cases for it.

00:06:54.985 --> 00:06:56.665
They do seem to have a really great developer

00:06:56.665 --> 00:06:56.945
experience.

00:06:57.025 --> 00:06:58.945
It's just the pricing is kind of crazy.

00:06:58.945 --> 00:07:00.785
Like you're kind of locked in at a

00:07:01.395 --> 00:07:02.675
monthly amount and then,

00:07:02.835 --> 00:07:03.275
you know,

00:07:03.275 --> 00:07:03.515
like,

00:07:03.515 --> 00:07:05.595
you only have 25 concurrent runs.

00:07:05.595 --> 00:07:06.675
So it really,

00:07:06.755 --> 00:07:07.155
like,

00:07:07.395 --> 00:07:09.635
I think that in terms of this type of product,

00:07:09.715 --> 00:07:11.475
Cloudflare has one of the better ones with

00:07:11.475 --> 00:07:12.075
workflows.

00:07:12.075 --> 00:07:14.235
And it's kind of crazy that they're able to spin

00:07:14.235 --> 00:07:15.395
up these products,

00:07:15.395 --> 00:07:17.795
these like sub products inside of their ecosystem

00:07:17.795 --> 00:07:19.755
so easily because they have durable objects,

00:07:19.755 --> 00:07:21.734
and durable objects are such a useful tool.

00:07:21.734 --> 00:07:21.996
All right,

00:07:21.996 --> 00:07:23.996
so enough rambling about workflows.

00:07:23.996 --> 00:07:26.196
Let's actually start to dig in and implement this

00:07:26.196 --> 00:07:26.693
use case.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.055 --> 00:00:00.375
All right,

00:00:00.375 --> 00:00:03.015
to start building out our evaluation workflow,

00:00:03.015 --> 00:00:04.495
essentially what we're going to want to do is

00:00:04.495 --> 00:00:06.095
we're going to want to head over to our data

00:00:06.095 --> 00:00:06.855
service project,

00:00:07.255 --> 00:00:08.495
and then under Source,

00:00:08.495 --> 00:00:09.815
I'm going to create a new folder.

00:00:09.815 --> 00:00:11.575
I'm going to call this Workflows.

00:00:12.534 --> 00:00:13.815
I always like to keep,

00:00:14.565 --> 00:00:16.925
all of the products or all of the services or

00:00:16.925 --> 00:00:18.165
subservices that I build,

00:00:18.615 --> 00:00:19.335
on top of,

00:00:19.335 --> 00:00:19.655
like,

00:00:19.815 --> 00:00:21.535
workflows or durable objects or queues.

00:00:21.535 --> 00:00:22.455
I kind of like to keep them

00:00:23.005 --> 00:00:24.765
in their own folders just to keep things,

00:00:24.765 --> 00:00:25.005
like,

00:00:25.005 --> 00:00:26.245
better organized and clean.

00:00:26.245 --> 00:00:27.165
It's really easy to

00:00:27.645 --> 00:00:29.965
navigate your code base as it gets bigger if you

00:00:29.965 --> 00:00:30.485
kind of follow,

00:00:30.485 --> 00:00:30.765
like,

00:00:30.765 --> 00:00:32.165
a structure and kind of stick to it.

00:00:32.165 --> 00:00:33.685
So we're going to call workflows,

00:00:33.685 --> 00:00:35.605
and all of the workflows that we build are going

00:00:35.605 --> 00:00:37.125
to live inside of this folder.

00:00:37.125 --> 00:00:39.485
So the first one is going to be a workflow

00:00:39.885 --> 00:00:41.565
with a file called,

00:00:42.145 --> 00:00:44.752
Destination Evaluation Workflow ts.

00:00:44.752 --> 00:00:47.016
And what this is going to do is this is going to,

00:00:47.506 --> 00:00:49.756
use browser rendering to render a destination

00:00:49.756 --> 00:00:50.116
page.

00:00:50.116 --> 00:00:51.036
It's going to use AI,

00:00:51.036 --> 00:00:53.216
it's going to stack some stuff up into R2.

00:00:53.296 --> 00:00:54.616
There's going to be multiple steps.

00:00:54.616 --> 00:00:57.016
So in order to get started with the workflow,

00:00:57.016 --> 00:00:58.456
what you're going to want to do is you're going to

00:00:58.456 --> 00:00:59.216
want to import

00:00:59.616 --> 00:01:00.776
the workflow entry point.

00:01:00.776 --> 00:01:01.616
That's the most important thing.

00:01:01.616 --> 00:01:03.336
We have a few other things here like the workflow

00:01:03.336 --> 00:01:04.576
step and the workflow event,

00:01:04.576 --> 00:01:06.966
but the main thing is this worker entry point.

00:01:07.156 --> 00:01:09.036
what this is going to do is this is going to.

00:01:09.036 --> 00:01:11.516
This is basically a class that implements all of

00:01:11.516 --> 00:01:12.836
the logic for a workflow,

00:01:12.916 --> 00:01:15.196
and then we're simply latching on to a specific

00:01:15.196 --> 00:01:17.996
method to build out the logic that's encapsulated

00:01:17.996 --> 00:01:18.836
inside of this,

00:01:18.986 --> 00:01:20.016
workflow entry point.

00:01:20.096 --> 00:01:22.856
So what we can do is we can create a class called

00:01:22.856 --> 00:01:23.616
the Destination

00:01:23.916 --> 00:01:25.036
Evaluation workflow,

00:01:25.116 --> 00:01:27.676
which extends the workflow entry point.

00:01:28.156 --> 00:01:28.436
Now,

00:01:28.436 --> 00:01:29.596
we have some other things going on here.

00:01:29.596 --> 00:01:31.826
We have an ENV that's passed in as a generic,

00:01:32.146 --> 00:01:33.626
These are our Cloudflare EMVs.

00:01:33.626 --> 00:01:34.866
We've kind of covered this in the past.

00:01:35.186 --> 00:01:37.826
And then this unknown is actually something we're

00:01:37.826 --> 00:01:38.666
going to be adding later.

00:01:38.666 --> 00:01:40.546
It's ultimately going to be adding the

00:01:40.866 --> 00:01:43.946
type of data that is passed into the workflow when

00:01:43.946 --> 00:01:44.306
it is,

00:01:44.306 --> 00:01:46.146
when it runs or when it's executed.

00:01:46.306 --> 00:01:48.386
So essentially from here,

00:01:48.386 --> 00:01:49.106
what we can do

00:01:49.516 --> 00:01:51.036
is we can say async

00:01:51.756 --> 00:01:52.156
run.

00:01:52.236 --> 00:01:52.516
Now,

00:01:52.516 --> 00:01:54.556
this run method that we're implementing is

00:01:54.556 --> 00:01:56.596
actually a method that's part of the workflow

00:01:56.596 --> 00:01:57.196
entry point.

00:01:57.596 --> 00:02:00.396
So if you just depending on which IDE you're

00:02:00.396 --> 00:02:00.636
using,

00:02:00.796 --> 00:02:02.396
you can hit enter on that.

00:02:02.396 --> 00:02:03.756
And what you're going to notice is,

00:02:04.216 --> 00:02:05.596
run takes in an event.

00:02:05.676 --> 00:02:07.996
And that event is going to actually have the data

00:02:08.076 --> 00:02:11.036
that we pass in when we want to run this workflow.

00:02:11.196 --> 00:02:13.676
And then it's also going to have a step which is,

00:02:14.536 --> 00:02:15.656
which is provided by

00:02:15.976 --> 00:02:17.016
this base class,

00:02:17.096 --> 00:02:18.376
the worker entry point.

00:02:18.536 --> 00:02:19.096
And this,

00:02:19.096 --> 00:02:21.576
this step allows us to create multiple different

00:02:21.576 --> 00:02:23.536
steps and configure each step the way that we

00:02:23.536 --> 00:02:23.816
want.

00:02:23.896 --> 00:02:25.256
And you can see that

00:02:25.836 --> 00:02:27.796
for the event it's actually inferring the type

00:02:27.796 --> 00:02:28.596
unknown from here,

00:02:28.596 --> 00:02:29.356
which is okay,

00:02:29.356 --> 00:02:31.476
because later we're going to go in and change that

00:02:31.476 --> 00:02:32.916
once we define what type we have.

00:02:32.916 --> 00:02:33.276
But

00:02:33.836 --> 00:02:34.834
this is ultimately

00:02:34.976 --> 00:02:35.376
a,

00:02:35.456 --> 00:02:37.776
this is ultimately a workflow and this workflow

00:02:37.776 --> 00:02:38.736
doesn't do anything right now.

00:02:38.736 --> 00:02:40.736
So inside of here we can take R step

00:02:41.476 --> 00:02:43.396
and you can say step dot do.

00:02:43.636 --> 00:02:44.986
Now these steps,

00:02:44.986 --> 00:02:46.516
are essentially asynchronous.

00:02:46.756 --> 00:02:49.396
So you can say await step dot do.

00:02:50.756 --> 00:02:51.156
And

00:02:51.876 --> 00:02:52.276
further,

00:02:52.516 --> 00:02:54.636
the thing that you can do on top of that is you

00:02:54.636 --> 00:02:55.716
can also say const

00:02:56.116 --> 00:02:57.076
collected data.

00:03:00.415 --> 00:03:01.303
const collected data.

00:03:01.303 --> 00:03:03.063
So this is basically data that we're going to

00:03:03.063 --> 00:03:05.463
capture by the return statement of a workflow.

00:03:05.463 --> 00:03:07.063
And we're going to say await

00:03:07.513 --> 00:03:08.233
step dot do.

00:03:08.393 --> 00:03:10.433
And then you're going to pass it a name or a

00:03:10.433 --> 00:03:12.233
description as to what that step is supposed to

00:03:12.233 --> 00:03:12.393
do.

00:03:12.393 --> 00:03:14.393
And this just makes it like really human

00:03:14.553 --> 00:03:15.313
understandable.

00:03:15.313 --> 00:03:16.993
When you're like looking at your workflow and all

00:03:16.993 --> 00:03:17.993
the steps that are executing,

00:03:17.993 --> 00:03:21.193
you can segment specifically what each step is and

00:03:21.193 --> 00:03:21.633
what they're doing.

00:03:21.633 --> 00:03:22.313
And if it failed,

00:03:22.313 --> 00:03:23.473
or if it didn't fail and whatnot.

00:03:23.473 --> 00:03:23.833
So,

00:03:23.973 --> 00:03:26.073
I'm calling this collect rendered destination

00:03:26.153 --> 00:03:26.633
page,

00:03:27.363 --> 00:03:27.763
data.

00:03:27.843 --> 00:03:28.243
That's,

00:03:28.243 --> 00:03:29.554
that's a pretty descriptive name.

00:03:29.554 --> 00:03:31.452
And then you're defining a method

00:03:31.792 --> 00:03:32.512
inside of do.

00:03:32.672 --> 00:03:34.992
So this is ultimately where your logic lives.

00:03:35.072 --> 00:03:37.512
So all the logic here right now we're just going

00:03:37.512 --> 00:03:38.632
to say console log,

00:03:38.632 --> 00:03:39.592
collecting rendered data,

00:03:39.592 --> 00:03:40.472
destination page.

00:03:40.472 --> 00:03:42.992
We're going to log that information up and we are

00:03:42.992 --> 00:03:43.872
going to return,

00:03:44.372 --> 00:03:45.632
an object of dummy data.

00:03:45.712 --> 00:03:46.112
Now,

00:03:46.432 --> 00:03:46.792
well,

00:03:46.792 --> 00:03:48.392
eventually what we're going to do is this is going

00:03:48.392 --> 00:03:49.952
to be the actual logic to

00:03:50.272 --> 00:03:51.472
do the browser rendering,

00:03:51.472 --> 00:03:52.472
taking that URL,

00:03:52.792 --> 00:03:53.352
loading,

00:03:53.412 --> 00:03:53.832
the page,

00:03:53.832 --> 00:03:54.512
rendering everything,

00:03:54.592 --> 00:03:56.472
extracting all the information and then returning

00:03:56.472 --> 00:03:56.712
it.

00:03:56.712 --> 00:03:58.792
But for now we're just going to do two things.

00:03:58.792 --> 00:03:59.472
We're going to say

00:03:59.832 --> 00:04:01.912
dummy data and then we're also going to say

00:04:02.392 --> 00:04:03.112
URL.

00:04:03.192 --> 00:04:05.832
And I want to the reason I'm doing this is I want

00:04:05.832 --> 00:04:08.472
to illustrate how you can actually access the URL.

00:04:08.472 --> 00:04:11.832
So the event is going to have a payload,

00:04:11.832 --> 00:04:14.432
and part of that payload will be data that you

00:04:14.432 --> 00:04:15.272
attach to it.

00:04:15.352 --> 00:04:17.592
And right now we have the type unknown,

00:04:17.592 --> 00:04:17.992
but

00:04:18.312 --> 00:04:20.792
when you specify a specific type here,

00:04:21.132 --> 00:04:22.942
that payload is going to be of that type.

00:04:22.942 --> 00:04:24.647
So we'll get into that in just a little bit.

00:04:24.647 --> 00:04:25.322
But ultimately,

00:04:25.322 --> 00:04:28.162
what we have here is a single step workflow

00:04:28.482 --> 00:04:29.602
that is returning

00:04:30.002 --> 00:04:30.882
collected data.

00:04:31.122 --> 00:04:31.522
Now,

00:04:31.922 --> 00:04:34.162
I'm just going to also console login out here,

00:04:36.882 --> 00:04:39.282
but inside of this run you could define more

00:04:39.282 --> 00:04:39.722
steps.

00:04:39.722 --> 00:04:42.282
So you could say step dot DO under here and add

00:04:42.282 --> 00:04:42.962
another step.

00:04:43.052 --> 00:04:44.282
you could say await,

00:04:45.322 --> 00:04:46.312
step.

00:04:46.382 --> 00:04:46.782
sleep,

00:04:46.782 --> 00:04:48.462
and you could basically tell it to sleep for a

00:04:48.462 --> 00:04:49.102
period of time.

00:04:49.802 --> 00:04:51.122
so there's a few different things that you can do

00:04:51.122 --> 00:04:51.322
there.

00:04:51.322 --> 00:04:53.282
But essentially under this run is where all that

00:04:53.282 --> 00:04:54.282
logic is going to live.

00:04:54.282 --> 00:04:54.922
But for now,

00:04:54.922 --> 00:04:57.442
what we want to do is we want to just deploy what

00:04:57.442 --> 00:05:00.642
we have right now just to ensure that everything's

00:05:00.642 --> 00:05:01.482
working as expected.

00:05:01.722 --> 00:05:03.642
And you can kind of like play around with,

00:05:03.912 --> 00:05:05.006
the workflow ui.

00:05:05.063 --> 00:05:05.143
So,

00:05:05.143 --> 00:05:06.663
in order to deploy your workflow,

00:05:06.663 --> 00:05:08.103
the very first thing that you're going to want to

00:05:08.103 --> 00:05:10.383
do is you're going to want to go to the index ts

00:05:10.383 --> 00:05:11.543
of your data service,

00:05:11.813 --> 00:05:12.403
application

00:05:12.883 --> 00:05:14.563
and then we can import,

00:05:15.253 --> 00:05:16.403
the destination

00:05:17.363 --> 00:05:18.563
evaluation workflow

00:05:19.263 --> 00:05:19.663
from,

00:05:21.595 --> 00:05:22.883
from our workflows folder.

00:05:22.883 --> 00:05:23.532
And actually,

00:05:23.532 --> 00:05:24.812
we're not importing it,

00:05:24.812 --> 00:05:26.172
we are going to export it.

00:05:26.172 --> 00:05:27.412
So we're exporting that.

00:05:27.812 --> 00:05:31.452
And then head over to your wrangler.JSON c file

00:05:31.452 --> 00:05:32.372
for your data service.

00:05:33.180 --> 00:05:34.741
And then what you're going to do is you're going

00:05:34.741 --> 00:05:36.861
to define a new type here.

00:05:36.941 --> 00:05:38.541
So we're going to create the

00:05:40.641 --> 00:05:43.521
for our workflows and you can have

00:05:44.291 --> 00:05:44.691
as many,

00:05:44.691 --> 00:05:46.011
I don't know if there's a hard limit,

00:05:46.011 --> 00:05:47.731
but you can have as really as many workflows as

00:05:47.731 --> 00:05:49.891
you want associated with a specific worker

00:05:49.891 --> 00:05:50.451
application.

00:05:50.771 --> 00:05:52.611
All you need to do is you need to provide a

00:05:52.611 --> 00:05:53.091
binding.

00:05:53.091 --> 00:05:55.051
So we're going to call this Destination Evaluation

00:05:55.051 --> 00:05:55.651
Workflow

00:05:56.131 --> 00:05:58.451
and then we have to give it a name.

00:05:58.451 --> 00:06:00.090
This is going to be the name that shows up in

00:06:00.090 --> 00:06:00.771
Cloudflare.

00:06:00.851 --> 00:06:02.291
So we're going to give this guy a name.

00:06:02.701 --> 00:06:04.291
and then the last thing that we're going to do is

00:06:04.291 --> 00:06:05.931
we have to give it the class name

00:06:06.491 --> 00:06:09.451
of what is exported in index ts,

00:06:09.531 --> 00:06:10.331
which is this.

00:06:10.831 --> 00:06:11.071
So

00:06:11.631 --> 00:06:12.191
from there,

00:06:12.591 --> 00:06:14.631
this is all the configuration that's needed for a

00:06:14.631 --> 00:06:14.991
workflow.

00:06:14.991 --> 00:06:15.981
It's actually pretty easy.

00:06:15.981 --> 00:06:18.701
and then you're going to navigate or CD into your

00:06:18.941 --> 00:06:19.741
data service

00:06:21.021 --> 00:06:23.341
application and then pnpm run,

00:06:23.421 --> 00:06:24.061
deploy.

00:06:25.954 --> 00:06:28.234
From here we're going to head over to our

00:06:28.234 --> 00:06:29.314
Cloudflare dashboard

00:06:29.634 --> 00:06:32.514
and then what you're going to notice is inside of

00:06:32.514 --> 00:06:32.994
Compute,

00:06:32.994 --> 00:06:34.674
we're going to have workflows,

00:06:34.674 --> 00:06:37.394
and we should see our workflow show up right here.

00:06:37.953 --> 00:06:39.624
So this is our actual workflow,

00:06:39.624 --> 00:06:40.794
that we just deployed,

00:06:41.034 --> 00:06:43.554
and they have like a really nice clean UI for it.

00:06:43.554 --> 00:06:44.874
And they've actually added a few different

00:06:44.874 --> 00:06:45.994
features in the last few months,

00:06:45.994 --> 00:06:47.914
which I am definitely a fan of.

00:06:47.914 --> 00:06:48.764
You have metrics,

00:06:49.044 --> 00:06:50.724
you can see like the number of instances,

00:06:50.804 --> 00:06:51.934
retry steps,

00:06:52.514 --> 00:06:52.834
all time,

00:06:52.834 --> 00:06:53.954
some interesting stuff there.

00:06:54.594 --> 00:06:54.994
And,

00:06:55.414 --> 00:06:56.974
Settings right now is pretty bare bone.

00:06:56.974 --> 00:06:58.534
It looks like they just have a delete button.

00:06:58.814 --> 00:07:00.774
but what I'm interested in is this trigger button

00:07:00.774 --> 00:07:01.614
under Instances.

00:07:01.934 --> 00:07:05.054
So this is a way that you can basically execute

00:07:05.054 --> 00:07:07.694
your workflow manually from the UI now.

00:07:07.694 --> 00:07:09.254
And what we're going to do is we're going to be

00:07:09.254 --> 00:07:10.864
executing it inside of our code base,

00:07:10.864 --> 00:07:11.634
programmatically,

00:07:11.874 --> 00:07:13.914
but you could also do it in the UI or you could

00:07:13.914 --> 00:07:15.754
use a Cloudflare CLI if you wanted to.

00:07:15.754 --> 00:07:16.874
So there's a few different options here,

00:07:16.874 --> 00:07:18.474
but for testing purposes and just kind of

00:07:18.474 --> 00:07:19.404
understanding what,

00:07:19.474 --> 00:07:21.034
what you can do is you can basically like,

00:07:21.034 --> 00:07:21.194
say,

00:07:21.194 --> 00:07:22.234
I want to trigger this workflow.

00:07:22.234 --> 00:07:22.514
And,

00:07:22.724 --> 00:07:25.114
a workflow is going to have a unique ID associated

00:07:25.114 --> 00:07:25.514
with it.

00:07:25.514 --> 00:07:26.594
If you provide it,

00:07:26.594 --> 00:07:28.434
that's the unique ID that it's going to use.

00:07:28.674 --> 00:07:29.074
And,

00:07:29.644 --> 00:07:30.564
if you don't provide it,

00:07:30.564 --> 00:07:32.124
it's going to randomly generate one for you.

00:07:32.364 --> 00:07:35.044
And then you can also provide parameters which we

00:07:35.044 --> 00:07:36.044
kind of discussed here,

00:07:36.044 --> 00:07:36.444
where

00:07:36.496 --> 00:07:38.496
right now our parameters are unknown.

00:07:38.496 --> 00:07:40.296
So we're not going to pass any parameters here.

00:07:40.296 --> 00:07:40.816
For now,

00:07:40.816 --> 00:07:42.416
we're just going to say trigger instance.

00:07:43.470 --> 00:07:45.070
And what's going to happen is we're going to see

00:07:45.070 --> 00:07:45.870
the step show up.

00:07:45.870 --> 00:07:47.531
So I'm going to reload that page really quick.

00:07:47.531 --> 00:07:49.540
And you can see that this instant has,

00:07:49.540 --> 00:07:51.490
one step and it is completed.

00:07:51.970 --> 00:07:53.570
So our workflow is actually working

00:07:53.890 --> 00:07:54.530
as expected.

00:07:54.690 --> 00:07:56.610
This is kind of like the best way to validate it.

00:07:56.610 --> 00:07:58.210
You can see when it started and ended.

00:07:58.900 --> 00:08:01.020
and what we're going to notice here is this is the

00:08:01.020 --> 00:08:01.540
output.

00:08:01.620 --> 00:08:02.900
So this is the data

00:08:03.300 --> 00:08:05.140
that was returned right here.

00:08:05.220 --> 00:08:05.500
Now,

00:08:05.500 --> 00:08:07.180
if you don't return data in a step,

00:08:07.180 --> 00:08:07.420
if,

00:08:07.420 --> 00:08:07.580
like,

00:08:07.580 --> 00:08:09.380
you're just doing some type of data mutation

00:08:10.090 --> 00:08:12.090
and you're not actually returning any data that's

00:08:12.090 --> 00:08:13.210
used for the,

00:08:13.710 --> 00:08:14.350
actual

00:08:14.533 --> 00:08:15.410
step itself,

00:08:15.810 --> 00:08:16.210
you know,

00:08:16.210 --> 00:08:18.210
you obviously wouldn't capture that as a variable

00:08:18.210 --> 00:08:20.210
and you probably wouldn't have a return statement.

00:08:20.290 --> 00:08:22.570
And then you would have no data here,

00:08:22.570 --> 00:08:25.010
but you can see that the output is dummy data,

00:08:25.010 --> 00:08:26.530
which we've hard coded here.

00:08:26.530 --> 00:08:29.330
So from here we know that our workflow is working

00:08:29.330 --> 00:08:29.890
as expected.

00:08:30.290 --> 00:08:30.690
And,

00:08:30.790 --> 00:08:31.670
if it fails,

00:08:31.670 --> 00:08:33.590
you could also retry it inside of the ui,

00:08:33.590 --> 00:08:34.270
which is pretty cool.

00:08:34.310 --> 00:08:36.310
and the UI does give you kind of a nice space

00:08:36.310 --> 00:08:37.030
where you can see,

00:08:37.030 --> 00:08:37.350
like,

00:08:37.350 --> 00:08:38.830
once you have tons of workflows going,

00:08:38.830 --> 00:08:41.550
you can see like holistically how many are failing

00:08:41.550 --> 00:08:43.010
if you have any errors pop up.

00:08:43.230 --> 00:08:45.870
and then you can rerun jobs manually if,

00:08:45.870 --> 00:08:46.190
like,

00:08:46.190 --> 00:08:48.150
your use case dictates that.

00:08:48.150 --> 00:08:50.150
Usually it's more programmatic and you wouldn't

00:08:50.150 --> 00:08:50.910
want your,

00:08:51.230 --> 00:08:51.870
you know,

00:08:52.110 --> 00:08:54.670
management of workflows to live inside of the ui.

00:08:54.670 --> 00:08:56.190
But for just understanding,

00:08:56.340 --> 00:08:57.220
how this works,

00:08:57.460 --> 00:08:58.580
it's a great UI for it.

00:08:58.580 --> 00:08:59.140
It's very simple.

00:08:59.140 --> 00:08:59.380
So,

00:08:59.530 --> 00:08:59.770
so

00:09:00.570 --> 00:09:02.010
that's workflows in a nutshell.

00:09:02.010 --> 00:09:03.330
So now what we're going to do is we're actually

00:09:03.330 --> 00:09:05.170
going to start building on top of this workflow

00:09:05.170 --> 00:09:06.410
now that we have it deployed,

00:09:06.650 --> 00:09:07.690
and we're going to,

00:09:07.820 --> 00:09:10.270
integrate with browser rendering and the AI SDK

00:09:10.270 --> 00:09:11.510
and the cloudflare workers,

00:09:11.920 --> 00:09:12.640
AI product.

00:09:12.800 --> 00:09:14.240
So there's a lot that we're going to do here,

00:09:14.240 --> 00:09:14.894
which is pretty cool.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.071 --> 00:00:02.351
So now that we have a workflow deployed that has a

00:00:02.351 --> 00:00:04.071
single step returning dummy data,

00:00:04.071 --> 00:00:04.551
right now,

00:00:04.631 --> 00:00:06.551
let's build out the actual logic to,

00:00:07.111 --> 00:00:08.791
render these web pages,

00:00:08.871 --> 00:00:11.751
extract the content and then provide it so it can

00:00:11.751 --> 00:00:14.471
be used for a subsequent step in this workflow.

00:00:14.951 --> 00:00:15.231
Now,

00:00:15.231 --> 00:00:16.311
in order to actually,

00:00:16.311 --> 00:00:16.631
like,

00:00:16.631 --> 00:00:18.151
manage this browser rendering,

00:00:18.231 --> 00:00:20.791
Cloudflare has a pretty good product right out of

00:00:20.791 --> 00:00:21.271
the box.

00:00:21.381 --> 00:00:23.021
it's just called browser rendering.

00:00:23.021 --> 00:00:23.381
And

00:00:24.081 --> 00:00:24.921
what you can do is like,

00:00:24.921 --> 00:00:26.641
they have an API that you can basically like,

00:00:26.641 --> 00:00:29.121
feed in a webpage and call different endpoints to

00:00:29.121 --> 00:00:30.711
pull information about a web page.

00:00:30.711 --> 00:00:31.651
a lot of people like,

00:00:31.651 --> 00:00:34.171
just need like a PDF or a screenshot of a page,

00:00:34.201 --> 00:00:34.871
or like the content.

00:00:35.531 --> 00:00:36.131
but sometimes,

00:00:36.131 --> 00:00:36.291
like,

00:00:36.291 --> 00:00:37.931
you need to do more sophisticated

00:00:38.251 --> 00:00:41.291
types of operations on a specific web page.

00:00:41.291 --> 00:00:42.611
And in order to do that,

00:00:42.611 --> 00:00:44.131
there's a lot of different libraries and

00:00:44.131 --> 00:00:46.611
frameworks out there that give you the ability to,

00:00:46.611 --> 00:00:46.891
like,

00:00:46.891 --> 00:00:48.851
listen to events that are happening on a web page.

00:00:48.851 --> 00:00:49.851
So you could basically say,

00:00:50.131 --> 00:00:50.851
load a webpage,

00:00:50.851 --> 00:00:52.691
wait for all the network requests to,

00:00:52.911 --> 00:00:53.311
stop,

00:00:53.551 --> 00:00:56.111
wait for the page to fully load and then call,

00:00:56.431 --> 00:00:58.591
extract an element from a page or take a picture

00:00:58.591 --> 00:00:58.911
or,

00:00:59.791 --> 00:01:00.271
you know,

00:01:00.271 --> 00:01:02.871
rip all of the text or the HTML.

00:01:02.871 --> 00:01:04.271
So there's a lot that you can do and

00:01:04.651 --> 00:01:06.171
different libraries to facilitate that.

00:01:06.171 --> 00:01:07.611
Now one of the libraries that's really,

00:01:07.611 --> 00:01:09.091
really popular is Puppeteer.

00:01:09.091 --> 00:01:10.671
Puppeteer is just that it basically,

00:01:11.161 --> 00:01:11.881
helps you

00:01:12.281 --> 00:01:14.681
programmatically render a web page and then

00:01:15.341 --> 00:01:15.661
action.

00:01:15.661 --> 00:01:16.381
So you could like,

00:01:16.381 --> 00:01:17.661
navigate to a new page.

00:01:17.741 --> 00:01:18.321
you could like,

00:01:18.321 --> 00:01:20.081
listen to events that are happening on a pa.

00:01:20.541 --> 00:01:21.021
It's honestly,

00:01:21.021 --> 00:01:22.141
it's a very dense library.

00:01:22.231 --> 00:01:22.701
also very,

00:01:22.701 --> 00:01:23.421
very popular.

00:01:23.501 --> 00:01:24.781
Now Cloudflare

00:01:26.081 --> 00:01:26.401
has,

00:01:26.649 --> 00:01:29.049
a Puppeteer Cloudflare fork.

00:01:29.129 --> 00:01:30.809
So what they've done is they've gone into

00:01:30.809 --> 00:01:32.569
Cloudflare and they've kind of forked it and just

00:01:32.569 --> 00:01:32.809
made it.

00:01:32.809 --> 00:01:34.889
So it's like very compatible with the way that

00:01:34.889 --> 00:01:36.409
they implemented browser rendering.

00:01:36.409 --> 00:01:38.089
And then what they've done is they've kind of like

00:01:38.089 --> 00:01:40.169
provided a really clear entry point so you can

00:01:40.249 --> 00:01:43.009
pass in a browser binding that you define inside

00:01:43.009 --> 00:01:44.329
of your Wrangler configuration.

00:01:44.719 --> 00:01:45.119
And then,

00:01:45.459 --> 00:01:46.619
it's really just this simple.

00:01:46.619 --> 00:01:47.099
It's like,

00:01:47.099 --> 00:01:47.459
hey,

00:01:47.459 --> 00:01:49.059
I want to define a browser,

00:01:49.059 --> 00:01:51.099
and then I'm going to say browser,

00:01:51.099 --> 00:01:51.539
new page.

00:01:51.539 --> 00:01:52.659
So you open up a new page.

00:01:52.719 --> 00:01:55.169
this is just programmatically virtually opening up

00:01:55.169 --> 00:01:55.729
a new page.

00:01:55.729 --> 00:01:56.249
And then,

00:01:56.709 --> 00:01:57.069
you're saying,

00:01:57.069 --> 00:01:58.309
await page goto.

00:01:58.309 --> 00:02:00.269
So you pass in a URL and it goes to that page.

00:02:00.269 --> 00:02:02.469
And then this is giving you some page metrics and

00:02:02.469 --> 00:02:03.269
you're closing the page.

00:02:03.269 --> 00:02:04.349
Now we're going to be doing

00:02:04.669 --> 00:02:05.709
a lot of other stuff.

00:02:05.709 --> 00:02:07.269
Like we're not just going to be extracting like

00:02:07.269 --> 00:02:08.549
performance metrics of a page.

00:02:08.549 --> 00:02:09.389
We're going to be,

00:02:10.229 --> 00:02:11.469
listening to network calls,

00:02:11.469 --> 00:02:12.429
getting the page to load,

00:02:12.429 --> 00:02:13.549
and then downloading content.

00:02:13.549 --> 00:02:15.244
So we could pass it off to an AI model.

00:02:15.897 --> 00:02:16.217
Now,

00:02:16.217 --> 00:02:18.537
before we actually start writing the code to this,

00:02:18.617 --> 00:02:21.007
let's just look at one call out here,

00:02:21.007 --> 00:02:23.287
that I do think is important to note just so you

00:02:23.287 --> 00:02:24.687
can have some context in the future.

00:02:24.757 --> 00:02:26.387
if you come over to limits,

00:02:26.627 --> 00:02:29.107
what you're going to notice is on the paid tier,

00:02:29.107 --> 00:02:30.467
which is what we're currently on,

00:02:30.936 --> 00:02:32.136
they do have a,

00:02:33.042 --> 00:02:36.002
they have a limit on the concurrent browsers that

00:02:36.002 --> 00:02:38.602
are currently like running at a given point in

00:02:38.602 --> 00:02:38.882
time.

00:02:39.042 --> 00:02:39.442
So,

00:02:39.742 --> 00:02:41.102
you can see that there's 10 per account.

00:02:41.102 --> 00:02:42.582
And they say that they're like always,

00:02:43.482 --> 00:02:45.042
they say that they're always like reevaluating

00:02:45.042 --> 00:02:46.242
these limits and they're going to be higher.

00:02:46.242 --> 00:02:48.122
You could also request an increase.

00:02:48.282 --> 00:02:49.762
Now for this use case,

00:02:49.762 --> 00:02:51.842
this is kind of one where like 10 concurrent

00:02:51.842 --> 00:02:54.442
requests technically wouldn't scale if this was a

00:02:54.442 --> 00:02:56.842
SaaS product used by a ton of people with a ton of

00:02:56.842 --> 00:02:57.882
links and a ton of traffic.

00:02:57.882 --> 00:02:58.202
Right.

00:02:58.432 --> 00:03:00.192
we're going to use this anyways because,

00:03:01.442 --> 00:03:03.322
really like what we're doing is we're just

00:03:03.322 --> 00:03:05.752
simplifying the setup of Puppeteer,

00:03:05.752 --> 00:03:07.842
and like a virtual browser render because they

00:03:07.842 --> 00:03:08.962
provide that product for us.

00:03:08.962 --> 00:03:09.322
And

00:03:09.642 --> 00:03:10.202
honestly,

00:03:10.202 --> 00:03:10.962
10 concurrent,

00:03:10.962 --> 00:03:12.842
you could probably scale this to a certain point.

00:03:12.842 --> 00:03:15.202
I'm actually using browser rendering for a client

00:03:15.202 --> 00:03:15.642
right now.

00:03:15.642 --> 00:03:16.042
And

00:03:16.472 --> 00:03:16.682
you know,

00:03:16.682 --> 00:03:18.122
we have several hundred users.

00:03:18.122 --> 00:03:19.282
It's a pretty active product.

00:03:19.442 --> 00:03:19.842
And

00:03:20.272 --> 00:03:21.942
this is able to scale just because like,

00:03:21.942 --> 00:03:23.742
10 concurrent is still a lot and usually these

00:03:23.742 --> 00:03:24.902
operations don't take very long.

00:03:24.902 --> 00:03:26.342
But do keep that in mind.

00:03:26.342 --> 00:03:28.962
Now if you wanted to build out a more robust,

00:03:29.462 --> 00:03:32.142
a more robust solution that utilizes browser

00:03:32.142 --> 00:03:32.662
rendering,

00:03:32.822 --> 00:03:33.382
technically,

00:03:33.382 --> 00:03:36.502
the browser rendering platform that Cloudflare

00:03:36.502 --> 00:03:38.782
developed is built on top of Cloudflare

00:03:38.782 --> 00:03:39.222
Containers.

00:03:39.222 --> 00:03:41.182
And now that Cloudflare Containers is in beta,

00:03:41.182 --> 00:03:42.552
but it is released,

00:03:42.552 --> 00:03:44.728
you essentially just get like access to

00:03:45.048 --> 00:03:46.008
virtual machines.

00:03:46.178 --> 00:03:46.568
and

00:03:47.208 --> 00:03:47.768
you can,

00:03:47.928 --> 00:03:48.368
you know,

00:03:48.368 --> 00:03:49.208
using Docker,

00:03:49.208 --> 00:03:51.328
define the type of environment that you want and

00:03:51.328 --> 00:03:52.168
you could build out,

00:03:52.168 --> 00:03:52.648
you could

00:03:53.178 --> 00:03:55.138
install all the dependencies for Puppeteer or

00:03:55.138 --> 00:03:56.058
whatever you want to use,

00:03:56.518 --> 00:03:56.958
and then,

00:03:57.278 --> 00:03:57.758
you know,

00:03:57.758 --> 00:03:58.558
virtually render

00:03:59.038 --> 00:04:01.558
these web pages and browsers inside of a

00:04:01.558 --> 00:04:01.958
container.

00:04:01.958 --> 00:04:03.478
And then these containers don't have the same

00:04:03.478 --> 00:04:03.838
limits.

00:04:03.838 --> 00:04:04.318
So you could,

00:04:04.318 --> 00:04:04.638
you know,

00:04:04.638 --> 00:04:04.878
like,

00:04:04.878 --> 00:04:05.438
scale this

00:04:05.998 --> 00:04:07.118
quite infinitely.

00:04:07.118 --> 00:04:07.758
Not infinitely,

00:04:07.758 --> 00:04:09.478
but you could really scale this depending on your

00:04:09.478 --> 00:04:09.878
use case.

00:04:09.878 --> 00:04:10.238
So,

00:04:10.398 --> 00:04:12.118
what I like to do is I like to start with browser

00:04:12.118 --> 00:04:12.478
rendering,

00:04:12.478 --> 00:04:14.038
because it just takes minutes to set up.

00:04:14.278 --> 00:04:16.118
And once you hit critical scale,

00:04:16.198 --> 00:04:16.718
you can actually,

00:04:16.718 --> 00:04:16.958
like,

00:04:16.958 --> 00:04:18.478
start looking at an alternative,

00:04:18.618 --> 00:04:20.418
probably containers or something else if you

00:04:20.418 --> 00:04:22.298
wanted to build out a more robust

00:04:22.798 --> 00:04:24.558
solution that didn't have this limit.

00:04:24.558 --> 00:04:26.398
But we are not really going to have to worry about

00:04:26.398 --> 00:04:27.068
this limit for now.

00:04:27.231 --> 00:04:28.991
So to get started with browser rendering,

00:04:29.001 --> 00:04:30.061
we can just go to get started

00:04:30.621 --> 00:04:32.541
and it looks like they're going to have an example

00:04:32.541 --> 00:04:33.021
right here.

00:04:33.321 --> 00:04:34.601
we're going to ignore this

00:04:34.921 --> 00:04:36.921
and what we're going to want to do is we're going

00:04:36.921 --> 00:04:39.241
to want to make sure we have Puppeteer installed.

00:04:39.481 --> 00:04:40.761
So let's grab,

00:04:41.721 --> 00:04:43.321
let's make sure we have that installed.

00:04:43.401 --> 00:04:45.321
So we are in data service right now.

00:04:47.481 --> 00:04:49.401
I'm going to install that and then,

00:04:50.781 --> 00:04:52.861
I don't think we actually need to create a

00:04:53.261 --> 00:04:54.141
KV space.

00:04:54.229 --> 00:04:56.149
It looks like for this example they are just

00:04:56.789 --> 00:04:59.429
using a KV space to like store some information

00:04:59.429 --> 00:05:00.109
about your,

00:05:00.109 --> 00:05:01.029
your browser render.

00:05:01.189 --> 00:05:02.709
We're going to ignore that for now.

00:05:03.029 --> 00:05:05.189
All we're going to need to do is we're going to

00:05:05.189 --> 00:05:08.279
need to add this binding in our wrangler.or in our

00:05:08.279 --> 00:05:09.369
wrangler JSON c.

00:05:09.449 --> 00:05:09.849
So

00:05:11.049 --> 00:05:13.209
let's head over to our wrangler JSON.

00:05:13.209 --> 00:05:13.409
See,

00:05:13.409 --> 00:05:14.179
it looks like I already have it up

00:05:14.331 --> 00:05:16.171
and I'm just going to go to the top over here and

00:05:16.171 --> 00:05:17.131
I'm going to say

00:05:18.276 --> 00:05:18.848
browser

00:05:18.952 --> 00:05:19.352
and

00:05:19.513 --> 00:05:20.831
I'm going to give it a binding.

00:05:20.831 --> 00:05:22.591
So we can provide a single binding.

00:05:22.591 --> 00:05:24.071
And this is going to be.

00:05:24.311 --> 00:05:25.391
What are we going to call this?

00:05:25.391 --> 00:05:26.211
Let's just call this,

00:05:32.937 --> 00:05:34.777
we're just going to call this virtual browser.

00:05:34.857 --> 00:05:35.217
Now,

00:05:35.217 --> 00:05:37.457
since we are in our data service directory right

00:05:37.457 --> 00:05:37.657
now,

00:05:37.657 --> 00:05:39.657
we can say pnpm run CF

00:05:41.097 --> 00:05:42.217
type gen

00:05:42.584 --> 00:05:45.304
and what we're going to notice is we now have this

00:05:45.464 --> 00:05:47.384
virtual browser binding,

00:05:47.534 --> 00:05:50.014
that's specified inside of our Cloudflare

00:05:50.014 --> 00:05:50.334
environment.

00:05:51.774 --> 00:05:53.134
So inside of our code,

00:05:53.134 --> 00:05:53.934
what we can do

00:05:54.254 --> 00:05:54.654
is,

00:05:55.444 --> 00:05:57.924
essentially wherever we have access to our emv,

00:05:58.244 --> 00:05:58.451
we

00:05:58.452 --> 00:06:00.497
We can also access our virtual browser,

00:06:00.727 --> 00:06:01.237
binding.

00:06:01.237 --> 00:06:03.597
So what we want to do here is let's just,

00:06:03.597 --> 00:06:06.357
let's just show really quick what we can do so we

00:06:06.357 --> 00:06:08.117
can say this dot emv.

00:06:08.117 --> 00:06:10.837
Now we are inside of our workflow right now and

00:06:10.837 --> 00:06:12.597
what you're going to notice is we now have our

00:06:12.597 --> 00:06:15.237
virtual browser and that virtual browser is going

00:06:15.237 --> 00:06:16.317
to have a fetch handler.

00:06:16.317 --> 00:06:18.037
But if we look at how they implement,

00:06:18.897 --> 00:06:20.657
how they implement this with Puppeteer,

00:06:21.137 --> 00:06:23.017
they're basically just saying we're going to be

00:06:23.017 --> 00:06:23.457
passing,

00:06:23.457 --> 00:06:25.297
we're going to import Puppeteer and we're going to

00:06:25.297 --> 00:06:26.417
be passing that into

00:06:27.057 --> 00:06:28.587
a launch method,

00:06:28.587 --> 00:06:31.049
from the Puppeteer Cloudflare library.

00:06:31.280 --> 00:06:33.440
So let's make sure that we have that imported

00:06:33.440 --> 00:06:33.760
here.

00:06:34.479 --> 00:06:36.680
This is importing Puppeteer and then I'm just

00:06:36.680 --> 00:06:38.320
going to copy these two lines.

00:06:38.560 --> 00:06:38.960
So,

00:06:40.430 --> 00:06:41.910
they called this virtual browser.

00:06:41.910 --> 00:06:45.230
We're just going to say this emv.virtual browser.

00:06:45.230 --> 00:06:47.790
So essentially we're passing in our browser

00:06:47.790 --> 00:06:50.790
binding into this Puppeteer launch and then we are

00:06:50.790 --> 00:06:52.110
creating a new page here.

00:06:52.270 --> 00:06:52.346
So

00:06:52.347 --> 00:06:54.337
Now with this code we've actually successfully

00:06:54.337 --> 00:06:55.577
launched when this runs,

00:06:55.577 --> 00:06:57.017
we've launched a browser page.

00:06:57.017 --> 00:07:00.257
Now we can do some other stuff like we can await

00:07:00.257 --> 00:07:00.977
page go to.

00:07:00.977 --> 00:07:03.217
And you notice this autocomplete for me is looking

00:07:03.217 --> 00:07:04.577
for payload URL,

00:07:04.577 --> 00:07:06.977
but we don't know the type of the payload yet.

00:07:07.057 --> 00:07:09.057
And that's because we haven't defined that.

00:07:09.137 --> 00:07:11.297
So what we're going to want to do is we're going

00:07:11.297 --> 00:07:12.737
to want to head over to our

00:07:14.026 --> 00:07:14.586
to our

00:07:14.906 --> 00:07:17.028
service bindings that we've defined here.

00:07:17.028 --> 00:07:19.390
And this is just extending our cloudflare,

00:07:19.900 --> 00:07:20.780
our Cloudflare

00:07:21.100 --> 00:07:21.820
emv.

00:07:21.900 --> 00:07:22.300
Now

00:07:22.620 --> 00:07:23.660
what I do,

00:07:23.660 --> 00:07:25.340
or this is kind of like a pattern that I like to

00:07:25.340 --> 00:07:27.100
follow is I like to create an interface.

00:07:27.100 --> 00:07:29.700
And because this type is defined inside of my

00:07:29.700 --> 00:07:30.780
TypeScript config,

00:07:31.420 --> 00:07:31.460
this

00:07:31.560 --> 00:07:33.080
is going to be accessible throughout the whole

00:07:33.080 --> 00:07:33.360
project.

00:07:33.840 --> 00:07:34.400
And then,

00:07:36.924 --> 00:07:39.564
and then we can use it inside of our destination

00:07:39.804 --> 00:07:41.244
evaluation workflow.

00:07:41.244 --> 00:07:44.484
So where we have this time this specific unknown

00:07:44.484 --> 00:07:46.764
type we can pass in our

00:07:48.944 --> 00:07:51.784
we can pass in our interface that we just defined

00:07:51.784 --> 00:07:51.984
here.

00:07:51.984 --> 00:07:53.824
And this interface is taking a link id,

00:07:54.224 --> 00:07:56.464
destination URL and account id.

00:07:56.464 --> 00:07:58.344
So when we actually run this workflow

00:07:58.344 --> 00:07:59.024
programmatically,

00:07:59.184 --> 00:08:00.704
this is the information that we're going to be

00:08:00.704 --> 00:08:01.824
passing into the workflow.

00:08:01.824 --> 00:08:02.224
So

00:08:03.394 --> 00:08:05.874
what we can do here is now we should be able to

00:08:05.874 --> 00:08:08.234
say payload and it actually has that type,

00:08:08.234 --> 00:08:10.354
so we can pass in the destination URL,

00:08:10.354 --> 00:08:11.554
which is pretty nifty.

00:08:11.714 --> 00:08:12.114
So

00:08:12.514 --> 00:08:13.114
the last

00:08:13.434 --> 00:08:16.634
little bit of what we want to do here is we are

00:08:16.634 --> 00:08:17.994
going to basically say

00:08:18.514 --> 00:08:19.092
we're gonna

00:08:19.092 --> 00:08:20.932
go to the destination URL

00:08:22.576 --> 00:08:23.856
and we're going to get that response.

00:08:24.261 --> 00:08:26.834
And then what we want to do is we're going to want

00:08:26.834 --> 00:08:27.994
to wait for the page

00:08:28.314 --> 00:08:29.354
to be done loading,

00:08:29.354 --> 00:08:31.114
we're going to want to wait for all the requests

00:08:31.114 --> 00:08:31.754
to complete.

00:08:31.914 --> 00:08:32.314
So

00:08:32.644 --> 00:08:34.654
Puppeteer has a handy method for that.

00:08:34.654 --> 00:08:36.573
It's wait for network idle.

00:08:36.573 --> 00:08:38.854
So basically no more requests are being issued.

00:08:39.254 --> 00:08:41.854
And then what we're going to do is we are going to

00:08:41.854 --> 00:08:44.334
use the page and we're going to run an email on it

00:08:44.334 --> 00:08:46.214
and we're going to extract the body.

00:08:46.374 --> 00:08:46.954
So I'm

00:08:46.994 --> 00:08:47.514
a webpage,

00:08:47.514 --> 00:08:48.754
if you should be familiar,

00:08:49.174 --> 00:08:51.534
basically has an HTML block and inside the HTML

00:08:51.534 --> 00:08:52.134
block has a body.

00:08:52.134 --> 00:08:54.574
And that body contains basically the whole content

00:08:54.574 --> 00:08:55.174
for the site,

00:08:55.334 --> 00:08:56.854
so or for the page.

00:08:57.014 --> 00:08:58.374
So essentially what we're going to do is we're

00:08:58.374 --> 00:08:59.694
going to say page eval,

00:08:59.694 --> 00:09:01.694
we're going to extract the body element,

00:09:01.694 --> 00:09:03.814
and then we're going to get all of the inner text.

00:09:03.894 --> 00:09:06.894
So this is just going to be like a raw dump of the

00:09:06.894 --> 00:09:07.254
text.

00:09:07.414 --> 00:09:07.974
And then,

00:09:08.684 --> 00:09:11.164
I also am going to extract just like the content

00:09:11.244 --> 00:09:11.684
itself.

00:09:11.684 --> 00:09:14.004
So this is going to be like the entire HTML block.

00:09:14.004 --> 00:09:14.844
So we're saying page.

00:09:14.844 --> 00:09:15.804
This is our web page

00:09:16.174 --> 00:09:16.414
content.

00:09:16.424 --> 00:09:16.994
this is another,

00:09:17.764 --> 00:09:19.428
method that Puppeteer provides us.

00:09:19.428 --> 00:09:21.090
And then also something that's going to be

00:09:21.090 --> 00:09:22.650
important is going to be the status.

00:09:22.650 --> 00:09:23.050
Because,

00:09:23.050 --> 00:09:23.330
like,

00:09:23.330 --> 00:09:24.650
if a Status is a404,

00:09:24.650 --> 00:09:25.530
like the page isn't found,

00:09:25.530 --> 00:09:27.050
you probably don't need to actually render,

00:09:27.130 --> 00:09:27.450
like,

00:09:27.450 --> 00:09:29.490
pass it through AI because you know that that page

00:09:29.490 --> 00:09:30.730
isn't found and you can just,

00:09:31.000 --> 00:09:32.490
alert the user based upon that.

00:09:32.490 --> 00:09:33.770
So this is just going to basically,

00:09:33.770 --> 00:09:34.010
like,

00:09:34.010 --> 00:09:35.930
make our system a little bit more intelligent.

00:09:36.740 --> 00:09:37.140
now

00:09:37.234 --> 00:09:39.021
we're going to return that information here,

00:09:39.181 --> 00:09:39.581
so

00:09:40.071 --> 00:09:41.271
I'm going to just dump that here.

00:09:41.751 --> 00:09:42.871
So just to recap here,

00:09:42.871 --> 00:09:44.791
now we have a collected data,

00:09:45.251 --> 00:09:46.471
we have our collected data,

00:09:47.061 --> 00:09:48.341
variable that

00:09:48.821 --> 00:09:51.701
is getting the return value of our very first step

00:09:51.861 --> 00:09:52.821
in our workflow.

00:09:52.821 --> 00:09:54.861
And the step is rendering browser.

00:09:54.861 --> 00:09:56.021
Is rendering a.

00:09:56.341 --> 00:09:59.341
Is using a virtual browser to render a web page to

00:09:59.341 --> 00:10:00.261
extract the information.

00:10:00.901 --> 00:10:03.341
Then we're passing in our virtual browser or a

00:10:03.341 --> 00:10:04.101
remote browser

00:10:04.441 --> 00:10:06.201
into a Puppeteer instance

00:10:06.601 --> 00:10:08.121
that's going to give us this browser.

00:10:08.201 --> 00:10:10.201
And then we're going to say we want to define a

00:10:10.201 --> 00:10:10.681
new page.

00:10:11.081 --> 00:10:12.121
We are going to,

00:10:12.321 --> 00:10:14.601
load that new page or go to that new page,

00:10:14.841 --> 00:10:15.561
and then

00:10:15.663 --> 00:10:18.033
we're going to wait for all of the network to be

00:10:18.033 --> 00:10:19.314
idle so the page is fully loaded.

00:10:19.314 --> 00:10:20.754
And there's other things that you can do to ensure

00:10:20.754 --> 00:10:21.634
the page is fully loaded.

00:10:21.634 --> 00:10:23.394
There's a bunch of methods that you can define

00:10:23.794 --> 00:10:24.994
on top of Puppeteer,

00:10:25.254 --> 00:10:26.914
we're going to extract the raw body

00:10:27.474 --> 00:10:27.794
text,

00:10:27.794 --> 00:10:29.794
so all of the inner text inside of the body of the

00:10:29.794 --> 00:10:30.354
web page.

00:10:30.354 --> 00:10:32.034
And then we're also going to get like the actual

00:10:32.034 --> 00:10:34.194
HTML content there and we're going to get the

00:10:34.194 --> 00:10:35.794
status and then we're going to return it.

00:10:35.874 --> 00:10:38.394
So that's a recap of what this is doing now.

00:10:38.394 --> 00:10:41.434
We should be able to actually deploy this and see

00:10:41.434 --> 00:10:41.954
it working,

00:10:42.434 --> 00:10:44.474
inside of the Cloudflare dashboard when we run.

00:10:44.474 --> 00:10:48.120
So I'm going to say pnpm run deployment.

00:10:48.310 --> 00:10:50.270
So now that this is successfully deployed,

00:10:50.270 --> 00:10:53.310
let's head back over to our workflow dashboard

00:10:53.310 --> 00:10:55.230
inside of our Cloudflare dashboard and let's

00:10:55.230 --> 00:10:56.150
trigger a new instance.

00:10:56.150 --> 00:10:58.150
Now I just have this example,

00:10:58.530 --> 00:11:01.370
I just have this example input of the parameters,

00:11:01.370 --> 00:11:03.370
essentially the exact same parameters that we've

00:11:03.370 --> 00:11:04.970
defined as this interface.

00:11:04.970 --> 00:11:05.530
Link id,

00:11:05.530 --> 00:11:07.170
destination URL and account id.

00:11:07.730 --> 00:11:08.130
And

00:11:08.590 --> 00:11:10.470
what I'm going to do is I'm going to say let's go

00:11:10.470 --> 00:11:11.230
to my website,

00:11:11.790 --> 00:11:13.070
backpine.com

00:11:14.299 --> 00:11:16.099
and essentially when this workflow runs,

00:11:16.099 --> 00:11:17.659
it should grab this destination URL,

00:11:17.659 --> 00:11:19.939
should go to backpine.com and we should see some

00:11:19.939 --> 00:11:20.379
of the

00:11:21.349 --> 00:11:22.869
text body from that site.

00:11:23.109 --> 00:11:24.829
So this is now queued,

00:11:24.829 --> 00:11:26.469
I'm going to refresh it because the

00:11:26.948 --> 00:11:28.629
dashboard isn't totally real time.

00:11:28.739 --> 00:11:29.989
so this is currently running.

00:11:30.149 --> 00:11:31.949
Refresh it one more time and it should be

00:11:31.949 --> 00:11:32.469
complete.

00:11:32.679 --> 00:11:33.193
All right,

00:11:33.193 --> 00:11:34.353
so this is now completed.

00:11:34.353 --> 00:11:36.953
So what we can do is we can look at the actual

00:11:36.953 --> 00:11:38.623
body that was outputted and this is,

00:11:39.013 --> 00:11:39.893
this was defined here,

00:11:39.893 --> 00:11:42.213
so it was returned as the body text.

00:11:42.213 --> 00:11:45.333
And you can see that this is the body text from

00:11:45.733 --> 00:11:47.813
my actual like website currently.

00:11:47.893 --> 00:11:50.493
And the output's obviously truncated just because

00:11:50.493 --> 00:11:51.369
like they're not gonna,

00:11:51.369 --> 00:11:53.030
they're not gonna let you like display all this

00:11:53.030 --> 00:11:53.310
data.

00:11:53.310 --> 00:11:53.710
But

00:11:54.109 --> 00:11:55.990
what we're eventually gonna do is we're gonna pass

00:11:55.990 --> 00:11:58.230
this information into an AI model and then we're

00:11:58.230 --> 00:11:59.630
also going to back up this,

00:11:59.740 --> 00:12:02.550
the data that we pull here in R2 for object

00:12:02.550 --> 00:12:03.030
storage.

00:12:03.030 --> 00:12:03.270
Really,

00:12:03.270 --> 00:12:04.390
really cheap object storage.

00:12:04.390 --> 00:12:06.870
So at this point what we have is we have

00:12:07.230 --> 00:12:08.070
successfully the

00:12:09.440 --> 00:12:10.000
render out,

00:12:10.210 --> 00:12:11.410
to launch a browser,

00:12:11.410 --> 00:12:12.130
render the page,

00:12:12.130 --> 00:12:14.210
click the info from the page and then return it

00:12:14.210 --> 00:12:14.610
here.

00:12:14.610 --> 00:12:16.450
So subsequently it could be used

00:12:16.930 --> 00:12:18.450
by other steps,

00:12:18.480 --> 00:12:19.220
in this workflow.

00:12:19.220 --> 00:12:21.700
And you can notice we're actually logging out this

00:12:21.700 --> 00:12:22.340
raw data.

00:12:22.930 --> 00:12:25.090
I'm going to open in a new tab A,

00:12:25.234 --> 00:12:27.342
I'm going to open our worker for data service over

00:12:27.342 --> 00:12:27.622
here.

00:12:27.702 --> 00:12:28.102
So

00:12:29.562 --> 00:12:32.122
you should be able to see the workflow logs here

00:12:32.122 --> 00:12:32.682
as well.

00:12:32.762 --> 00:12:33.162
So

00:12:33.672 --> 00:12:34.552
go to events.

00:12:34.952 --> 00:12:35.352
And

00:12:35.920 --> 00:12:38.402
you can see that this is actually logging out the

00:12:38.402 --> 00:12:39.202
HTML.

00:12:39.282 --> 00:12:41.242
So you can see that like we have,

00:12:41.242 --> 00:12:43.522
we've defined a log inside of the workflow and we

00:12:43.522 --> 00:12:44.962
can see the logs

00:12:45.282 --> 00:12:46.802
at the worker level,

00:12:47.072 --> 00:12:47.702
inside of here.

00:12:47.702 --> 00:12:49.982
Because this workflow is attached specifically to

00:12:49.982 --> 00:12:50.662
this worker.

00:12:50.822 --> 00:12:52.622
And that might be a little bit confusing because

00:12:52.622 --> 00:12:53.662
you might like kind of expect,

00:12:53.662 --> 00:12:53.942
oh,

00:12:53.942 --> 00:12:54.062
well,

00:12:54.062 --> 00:12:55.742
why can't I see logs at the workflow?

00:12:55.742 --> 00:12:57.742
Because I'm like analyzing data from a workflow.

00:12:57.742 --> 00:13:00.342
But just note that the logs are associated with

00:13:00.342 --> 00:13:02.492
the worker that it was deployed along with.

00:13:02.882 --> 00:13:03.122
So

00:13:03.432 --> 00:13:05.122
that's just something that's important for

00:13:05.122 --> 00:13:06.402
debugging purposes.

00:13:07.042 --> 00:13:09.882
But what we want to do now for the very last thing

00:13:09.882 --> 00:13:11.522
before we move on to the next section and actually

00:13:11.522 --> 00:13:13.002
start building up more advanced features,

00:13:13.002 --> 00:13:13.282
is

00:13:13.602 --> 00:13:16.162
I don't like to have a workflow which is like a

00:13:16.162 --> 00:13:17.602
whole bunch of stuff defined inside.

00:13:17.602 --> 00:13:20.882
I like to move everything into its own method.

00:13:20.882 --> 00:13:22.162
So that's what we're going to do.

00:13:22.402 --> 00:13:24.482
We are going to create a,

00:13:24.712 --> 00:13:25.702
we're going to basically

00:13:25.799 --> 00:13:26.759
inside of helpers,

00:13:26.839 --> 00:13:29.039
we're going to create a new file and this is going

00:13:29.039 --> 00:13:29.559
to be called

00:13:31.159 --> 00:13:31.959
browser

00:13:33.976 --> 00:13:34.456
render,

00:13:34.921 --> 00:13:35.561
ts

00:13:36.681 --> 00:13:37.081
and

00:13:37.401 --> 00:13:40.201
I am going to just so I have this code already.

00:13:40.521 --> 00:13:42.081
So essentially this is going to be doing the same

00:13:42.081 --> 00:13:42.241
thing.

00:13:42.241 --> 00:13:43.601
I'm just going to make sure we have the right

00:13:43.601 --> 00:13:44.521
binding name here.

00:13:45.081 --> 00:13:46.201
Virtual browser.

00:13:46.761 --> 00:13:47.721
And it's,

00:13:48.121 --> 00:13:49.041
it's the exact same thing.

00:13:49.041 --> 00:13:51.001
It's all the logic that we have inside of here,

00:13:51.001 --> 00:13:53.781
it's just kind of moved into its own method.

00:13:54.261 --> 00:13:55.301
And one.

00:13:55.541 --> 00:13:58.341
Also one thing to note here is I've also added a

00:13:58.341 --> 00:14:00.461
Await browser close because you're going to want

00:14:00.461 --> 00:14:02.621
to make sure you close the browser instance just

00:14:02.621 --> 00:14:04.741
so you don't like hit your 10 concurrent

00:14:05.141 --> 00:14:06.901
have to like wait for Cloudflare to kill those

00:14:06.901 --> 00:14:07.781
instances for you.

00:14:07.781 --> 00:14:08.701
So when you're done,

00:14:08.701 --> 00:14:10.341
go ahead Await close and then

00:14:10.341 --> 00:14:11.061
you should be good.

00:14:11.141 --> 00:14:14.021
So we're going to essentially come into here and

00:14:14.261 --> 00:14:15.272
delete this stuff

00:14:15.272 --> 00:14:17.092
and then I am going to return

00:14:18.022 --> 00:14:18.662
that method

00:14:19.782 --> 00:14:23.982
and I'm going to pass in this EMB and the

00:14:23.982 --> 00:14:25.302
destination URL.

00:14:25.302 --> 00:14:28.062
So this is how I try to keep the workflows really

00:14:28.062 --> 00:14:28.502
concise.

00:14:28.502 --> 00:14:28.982
You have

00:14:29.212 --> 00:14:31.522
clearly defined step and then you have a helper

00:14:31.522 --> 00:14:32.802
method that handles it in this way.

00:14:32.802 --> 00:14:34.802
If you have a workflow that has like 50 steps,

00:14:34.802 --> 00:14:36.692
it's really easy to navigate through

00:14:36.702 --> 00:14:37.220
your code.

00:14:37.623 --> 00:14:39.463
So one last thing is we can just like

00:14:39.863 --> 00:14:41.583
PMPM run deploy one more time.

00:14:41.583 --> 00:14:42.183
That's going to be,

00:14:42.183 --> 00:14:43.223
go ahead and be successful.

00:14:43.383 --> 00:14:44.863
And what we're going to do is we're going to move

00:14:44.863 --> 00:14:46.703
on to the next step where we use this collected

00:14:46.703 --> 00:14:48.323
data and we're going to pass it into

00:14:48.733 --> 00:14:50.221
an NAI use case.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:01.064 --> 00:00:03.744
Now the very next step of this workflow is going

00:00:03.744 --> 00:00:06.384
to be taking this collected data and then passing

00:00:06.384 --> 00:00:07.144
it into an

00:00:07.624 --> 00:00:10.784
AI model to further analyze the website to make

00:00:10.784 --> 00:00:12.104
sure it's a healthy website,

00:00:12.304 --> 00:00:14.544
make sure nothing's changed that you know you

00:00:14.544 --> 00:00:16.144
don't want to change like a product not being

00:00:16.144 --> 00:00:16.424
available.

00:00:16.904 --> 00:00:19.984
Now in order to do this we could go to OpenAI's

00:00:19.984 --> 00:00:22.184
API and we could use any number of their models.

00:00:22.184 --> 00:00:23.464
We could go to Anthropic,

00:00:23.804 --> 00:00:26.204
we could go to OpenRouter so we could proxy these

00:00:26.204 --> 00:00:29.884
requests via one provider to really any number of

00:00:29.884 --> 00:00:31.044
providers that we want to use,

00:00:31.044 --> 00:00:32.684
which is a really compelling product.

00:00:32.684 --> 00:00:33.084
But

00:00:33.404 --> 00:00:35.324
for this specific use case,

00:00:35.864 --> 00:00:38.084
we're actually going to be using Cloudflare's

00:00:38.084 --> 00:00:38.864
built in workers,

00:00:39.244 --> 00:00:39.803
AI,

00:00:40.124 --> 00:00:42.364
which is ultimately just a whole bunch of self

00:00:42.364 --> 00:00:45.244
hosted open source models that Cloudflare is

00:00:45.244 --> 00:00:47.644
hosting on their own GPUs all around the world.

00:00:48.284 --> 00:00:50.524
Now when I say like hosting some models,

00:00:50.524 --> 00:00:52.284
like they're hosting a ton of models and,

00:00:52.434 --> 00:00:54.954
and they're updating this every single time a new

00:00:54.954 --> 00:00:57.234
model drops that is like worth hosting.

00:00:57.234 --> 00:01:00.114
So today this went by OpenAI just barely dropped

00:01:00.114 --> 00:01:00.274
this,

00:01:00.274 --> 00:01:02.034
literally dropped today as of making this video.

00:01:02.354 --> 00:01:02.754
And

00:01:03.244 --> 00:01:05.194
they're hosting it now because this one is an

00:01:05.194 --> 00:01:06.074
open source model.

00:01:06.074 --> 00:01:06.434
Now

00:01:06.784 --> 00:01:08.954
there's a whole bunch of different tasks that you

00:01:08.954 --> 00:01:09.234
can do.

00:01:09.234 --> 00:01:10.994
For our use case we're just going to be doing text

00:01:10.994 --> 00:01:13.434
generation but they also have stuff for like text

00:01:13.434 --> 00:01:13.954
to image,

00:01:13.954 --> 00:01:14.834
image to text.

00:01:15.394 --> 00:01:16.714
You  can do like loras,

00:01:16.714 --> 00:01:17.074
you can.

00:01:17.074 --> 00:01:18.914
There's some models that have capabilities for

00:01:18.914 --> 00:01:19.794
function calling.

00:01:19.874 --> 00:01:22.754
Now the feature that we care the most about for

00:01:22.914 --> 00:01:23.794
our use case

00:01:24.254 --> 00:01:24.494
is

00:01:25.294 --> 00:01:26.334
JSON mode.

00:01:27.134 --> 00:01:28.934
Now when you're like kind of interfacing with

00:01:28.934 --> 00:01:29.454
ChatGPT,

00:01:29.934 --> 00:01:31.054
you can ask it a question.

00:01:31.054 --> 00:01:32.894
It gives you like this big text block.

00:01:32.894 --> 00:01:34.494
Now if you have this big text block,

00:01:34.654 --> 00:01:36.414
how do you actually use that in your system?

00:01:36.574 --> 00:01:39.414
Like how do you extract very specific key details

00:01:39.414 --> 00:01:39.774
about

00:01:40.814 --> 00:01:41.214
about

00:01:41.694 --> 00:01:43.054
the output of a model

00:01:43.374 --> 00:01:44.894
in a very reliable way?

00:01:45.534 --> 00:01:47.814
so essentially what OpenAI pioneered is they

00:01:47.814 --> 00:01:49.534
pioneered a specific schema

00:01:50.084 --> 00:01:53.004
that you can pass into a model to say I want you

00:01:53.004 --> 00:01:55.444
to answer this question or perform this task and I

00:01:55.444 --> 00:01:57.884
want your output to be in a JSON object of this

00:01:57.884 --> 00:01:58.724
specific type

00:01:59.114 --> 00:02:02.044
and then typically the model does a really good

00:02:02.044 --> 00:02:03.964
job at conforming to that type because I think

00:02:03.964 --> 00:02:04.884
they've trained on it.

00:02:04.884 --> 00:02:07.524
And then the provider also will typically like

00:02:07.604 --> 00:02:11.364
ensure that that type  comes back as expected.

00:02:11.604 --> 00:02:12.004
So

00:02:12.344 --> 00:02:14.524
there's kind of like two layers to it.

00:02:14.524 --> 00:02:16.924
But what that looks like in practice is you,

00:02:16.924 --> 00:02:18.484
you provide some system prompts.

00:02:18.484 --> 00:02:19.204
So you basically say,

00:02:19.204 --> 00:02:20.724
so extract data about a,

00:02:20.964 --> 00:02:23.474
about a country and then you give it like the

00:02:23.474 --> 00:02:24.114
user's input.

00:02:24.114 --> 00:02:25.874
So the user says tell me about India,

00:02:25.954 --> 00:02:26.354
right?

00:02:26.754 --> 00:02:27.634
And then

00:02:28.434 --> 00:02:31.514
along with the input from the user and from the

00:02:31.514 --> 00:02:31.794
system,

00:02:31.954 --> 00:02:32.834
so these messages,

00:02:32.834 --> 00:02:35.154
you're also going to be specifying a response

00:02:35.154 --> 00:02:35.674
format.

00:02:35.674 --> 00:02:38.434
So this is going to be a  JSON type.

00:02:38.434 --> 00:02:40.874
And then you can see the JSON schema looks like

00:02:40.874 --> 00:02:41.154
this.

00:02:41.234 --> 00:02:41.634
So

00:02:42.194 --> 00:02:43.314
it's going to be a type of

00:02:43.714 --> 00:02:45.954
object and then these are the properties inside of

00:02:45.954 --> 00:02:46.434
that object.

00:02:46.814 --> 00:02:47.454
You have name,

00:02:47.534 --> 00:02:48.254
you have capital,

00:02:48.414 --> 00:02:49.294
you have languages.

00:02:49.294 --> 00:02:50.894
And languages is an array,

00:02:50.894 --> 00:02:51.934
an array of strings.

00:02:52.174 --> 00:02:52.574
Capital

00:02:53.054 --> 00:02:54.094
is just a string,

00:02:54.094 --> 00:02:55.414
name is just a string.

00:02:55.414 --> 00:02:56.734
And then these are all required.

00:02:56.894 --> 00:02:58.694
So this is a very specific format.

00:02:58.694 --> 00:03:00.014
You could also do like enums.

00:03:00.014 --> 00:03:00.774
So it has to be like,

00:03:00.774 --> 00:03:01.614
of one type.

00:03:01.694 --> 00:03:02.094
And

00:03:02.564 --> 00:03:03.574
so this is a,

00:03:03.574 --> 00:03:06.494
this is kind of like the schema that OpenAI has

00:03:06.494 --> 00:03:07.694
pioneered and

00:03:08.174 --> 00:03:11.054
a lot of other models and also providers are kind

00:03:11.054 --> 00:03:13.054
of adhering to this format because so many people

00:03:13.054 --> 00:03:14.094
have already built out

00:03:15.134 --> 00:03:17.294
they've already built out like a lot of their

00:03:17.294 --> 00:03:17.614
system

00:03:17.934 --> 00:03:19.454
utilizing this format.

00:03:19.534 --> 00:03:19.934
So

00:03:20.494 --> 00:03:22.974
essentially think this data goes into the system

00:03:23.214 --> 00:03:26.094
and then the output of a model instead of this big

00:03:26.094 --> 00:03:28.254
block of text telling the user about India,

00:03:28.734 --> 00:03:30.814
what it's doing is it's telling that user specific

00:03:30.814 --> 00:03:31.454
things about India.

00:03:31.454 --> 00:03:33.174
So this is the response from a model.

00:03:33.174 --> 00:03:34.254
So the name is India,

00:03:34.254 --> 00:03:35.614
the capital is New Delhi.

00:03:35.694 --> 00:03:36.334
Languages,

00:03:37.214 --> 00:03:38.774
these are the languages spoken in India.

00:03:38.774 --> 00:03:40.334
There's a lot of languages spoken in India,

00:03:40.334 --> 00:03:41.134
which is pretty cool.

00:03:41.674 --> 00:03:44.294
and then for the specific feature of JSON mode,

00:03:44.294 --> 00:03:46.534
these are currently the models that are supported.

00:03:47.574 --> 00:03:48.254
and you know,

00:03:48.254 --> 00:03:49.494
I think most of these will do.

00:03:49.494 --> 00:03:51.534
You're going to get varied performance model to

00:03:51.534 --> 00:03:51.894
model.

00:03:51.894 --> 00:03:53.094
Some models are more expensive,

00:03:53.094 --> 00:03:54.334
more capable and slower.

00:03:54.334 --> 00:03:55.134
Some are fast,

00:03:55.134 --> 00:03:55.894
less capable,

00:03:55.974 --> 00:03:57.694
some have lower context windows,

00:03:57.694 --> 00:03:59.014
some have higher context windows.

00:03:59.014 --> 00:04:01.254
So it really just like depends on your use case.

00:04:01.254 --> 00:04:03.294
But we're going to play around with a few of them.

00:04:03.294 --> 00:04:05.014
And the good thing about workflows is you could

00:04:05.014 --> 00:04:05.334
like,

00:04:05.334 --> 00:04:05.894
you know,

00:04:05.894 --> 00:04:07.414
you could kind of a B test step.

00:04:07.414 --> 00:04:09.414
So you could say like one step is going to

00:04:09.934 --> 00:04:10.974
use one model,

00:04:10.974 --> 00:04:12.414
another step is going to use another model.

00:04:12.414 --> 00:04:14.233
And then you could do some like background

00:04:14.233 --> 00:04:15.313
processing to like

00:04:15.734 --> 00:04:18.113
compare the outputs of both to see like,

00:04:18.113 --> 00:04:18.353
you know,

00:04:18.353 --> 00:04:20.153
is there one model that performs a task better

00:04:20.153 --> 00:04:20.673
than another.

00:04:20.753 --> 00:04:22.673
So that's essentially what we're going to do is

00:04:22.673 --> 00:04:23.953
we're going to be using JSON mode,

00:04:23.953 --> 00:04:25.553
but instead of just like using,

00:04:26.033 --> 00:04:27.233
like stuffing that data,

00:04:27.534 --> 00:04:28.993
in that specific format

00:04:29.313 --> 00:04:29.713
into

00:04:30.113 --> 00:04:32.433
the worker entry point for the AI.

00:04:32.433 --> 00:04:34.273
We're actually going to be using a

00:04:35.313 --> 00:04:36.193
really popular,

00:04:37.073 --> 00:04:39.544
SDK that was built by Vercell called,

00:04:39.674 --> 00:04:41.224
the AI SDK.

00:04:41.544 --> 00:04:43.304
And what this does is this kind of like,

00:04:43.304 --> 00:04:45.304
provides a very generic class

00:04:45.864 --> 00:04:47.864
that allows you to interface with

00:04:48.424 --> 00:04:49.864
so many different models.

00:04:49.864 --> 00:04:50.584
Like they have,

00:04:50.744 --> 00:04:52.624
they literally have so many different providers

00:04:52.624 --> 00:04:53.624
that they're compatible with.

00:04:53.944 --> 00:04:56.184
And this just basically makes it so you're not

00:04:56.184 --> 00:04:56.664
like using,

00:04:57.064 --> 00:04:57.624
you know,

00:04:57.814 --> 00:05:02.344
OpenAI's SDK and Grox SDK and

00:05:02.954 --> 00:05:04.744
Deep Seq's SDK.

00:05:04.744 --> 00:05:07.384
I think Deep Seq actually uses OpenAI for their,

00:05:07.384 --> 00:05:08.024
their SDK.

00:05:08.024 --> 00:05:09.344
But you kind of get the point.

00:05:09.344 --> 00:05:09.504
Like,

00:05:09.504 --> 00:05:10.424
you're not like bringing

00:05:11.204 --> 00:05:11.364
things,

00:05:11.364 --> 00:05:12.364
you're creating a whole bunch of like,

00:05:12.364 --> 00:05:14.244
helper functions and then you're dynamically

00:05:14.244 --> 00:05:14.444
saying,

00:05:14.444 --> 00:05:14.644
okay,

00:05:14.644 --> 00:05:16.164
I want to call this function to use this model and

00:05:16.164 --> 00:05:17.084
this function to use this model.

00:05:17.084 --> 00:05:18.524
This just gives you one very,

00:05:18.524 --> 00:05:19.204
very clear,

00:05:20.244 --> 00:05:23.524
standard way of interfacing with tons of different

00:05:23.524 --> 00:05:24.044
providers.

00:05:24.044 --> 00:05:25.444
And this is going to make more sense as we get

00:05:25.444 --> 00:05:25.724
into it.

00:05:25.724 --> 00:05:26.804
If you're not familiar with this tool,

00:05:26.804 --> 00:05:28.924
but I really do think that you're going to like

00:05:28.924 --> 00:05:29.444
this tool,

00:05:29.474 --> 00:05:30.484
you're probably going to like,

00:05:30.484 --> 00:05:32.644
use this SDK for other projects in the future.

00:05:33.204 --> 00:05:33.604
Now,

00:05:36.004 --> 00:05:37.844
just before we actually get into the code,

00:05:37.844 --> 00:05:39.444
it might make sense to look at,

00:05:39.934 --> 00:05:43.064
to look at just like how you interface with,

00:05:44.264 --> 00:05:46.184
with the  worker AI bindings.

00:05:46.344 --> 00:05:48.744
So  this is just their basic documentation.

00:05:48.744 --> 00:05:50.104
You can see they're creating a project.

00:05:50.104 --> 00:05:52.304
But what I care about is I care about the binding.

00:05:52.304 --> 00:05:54.344
So in order to use bindings in your project,

00:05:54.504 --> 00:05:56.704
in order to access all these different models and

00:05:56.704 --> 00:05:57.344
different use cases,

00:05:57.344 --> 00:06:00.104
you literally just need to say in your Wrangler

00:06:00.104 --> 00:06:02.664
config AI and give it a binding.

00:06:03.064 --> 00:06:03.464
Then

00:06:03.944 --> 00:06:04.824
what you can do,

00:06:05.054 --> 00:06:07.784
inside of your worker is you can basically say,

00:06:07.784 --> 00:06:10.424
I want to go to the AI binding and I want to run.

00:06:10.894 --> 00:06:13.374
You pass in the specific model that you care about

00:06:13.614 --> 00:06:16.374
and then you pass in like a prompt or you pass in

00:06:16.374 --> 00:06:16.654
like,

00:06:17.114 --> 00:06:18.334
the actual like

00:06:19.374 --> 00:06:21.534
input with the system message and whatnot.

00:06:21.534 --> 00:06:22.814
So this is pretty cool.

00:06:22.814 --> 00:06:24.094
It's actually insanely,

00:06:24.294 --> 00:06:26.494
powerful that with just this like,

00:06:26.573 --> 00:06:28.174
very limited amount of code,

00:06:28.174 --> 00:06:30.094
you're able to do so much,

00:06:30.654 --> 00:06:32.294
you're able to use so many different models.

00:06:32.294 --> 00:06:34.094
So I do think that Cloudflare has built a pretty

00:06:34.094 --> 00:06:34.734
cool product here.

00:06:39.304 --> 00:06:40.264
So without further ado,

00:06:40.264 --> 00:06:41.944
let's get into this next section where we actually

00:06:41.944 --> 00:06:44.024
start building this out using Cloudflare workers

00:06:44.024 --> 00:06:44.584
AI.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.066 --> 00:00:00.546
All right,

00:00:00.546 --> 00:00:03.466
so now that we've completed the step that scrapes

00:00:03.466 --> 00:00:05.746
data from a website using browser rendering,

00:00:05.746 --> 00:00:08.706
we're going to move into the AI portion of this

00:00:08.706 --> 00:00:09.346
workflow,

00:00:09.586 --> 00:00:12.425
which is ultimately going to take the body text

00:00:12.425 --> 00:00:14.346
that's extracted from a website and it's going to

00:00:14.346 --> 00:00:17.506
pass it off to an AI workflow where the AI is

00:00:17.506 --> 00:00:19.506
going to determine the health of a specific page

00:00:19.506 --> 00:00:20.386
or the page content.

00:00:20.866 --> 00:00:21.266
So

00:00:21.516 --> 00:00:23.306
what we're going to be using in this section

00:00:23.656 --> 00:00:25.656
is the AI SDK by Vercel.

00:00:25.896 --> 00:00:28.256
And we're going to be using Cloudflare's built in

00:00:28.256 --> 00:00:29.016
AI workers

00:00:29.216 --> 00:00:30.796
product which basically gives you

00:00:30.856 --> 00:00:33.356
access to a whole bunch of different open source

00:00:33.356 --> 00:00:35.276
AI models that they host on their own

00:00:35.276 --> 00:00:35.840
infrastructure.

00:00:36.768 --> 00:00:40.288
Now the AI SDK has tons and tons of features.

00:00:40.288 --> 00:00:41.248
It's actually a very,

00:00:41.248 --> 00:00:43.008
very well built library in my opinion.

00:00:43.038 --> 00:00:45.848
it looks like the AI SDK 5 is now available.

00:00:46.088 --> 00:00:46.488
So

00:00:46.788 --> 00:00:48.348
essentially what we're going to do is we're just

00:00:48.348 --> 00:00:50.468
going to be interfacing with this as a pretty

00:00:50.468 --> 00:00:51.508
simple use case.

00:00:51.648 --> 00:00:54.008
like I think the vast majority of use cases right

00:00:54.008 --> 00:00:55.928
now or the things that are most popular that

00:00:55.928 --> 00:00:56.608
people are building

00:00:56.928 --> 00:01:00.008
is they're using this generate text method that's

00:01:00.008 --> 00:01:02.888
provided by the AI library from this AI SDK.

00:01:02.888 --> 00:01:05.208
Now there's so many different capabilities of this

00:01:05.208 --> 00:01:05.648
platform,

00:01:06.048 --> 00:01:08.488
but I think this is a great illustration of what

00:01:08.488 --> 00:01:10.688
it can do because if you look at the semantics

00:01:10.688 --> 00:01:10.968
here,

00:01:10.968 --> 00:01:12.528
you have generate text

00:01:12.888 --> 00:01:13.768
and you have a prompt,

00:01:13.768 --> 00:01:14.168
right?

00:01:14.568 --> 00:01:14.968
And

00:01:15.318 --> 00:01:17.438
from here you can basically pass in a model and

00:01:17.438 --> 00:01:19.478
they've done a whole bunch of like abstraction.

00:01:19.478 --> 00:01:20.318
So you can provide

00:01:20.868 --> 00:01:23.298
a model from a given provider and then under the

00:01:23.298 --> 00:01:25.138
hood of this generate text it's able to,

00:01:25.138 --> 00:01:25.578
you know,

00:01:25.578 --> 00:01:27.138
dynamically figure out how to use it.

00:01:27.218 --> 00:01:27.618
So

00:01:27.988 --> 00:01:28.628
what we're going,

00:01:28.628 --> 00:01:30.588
or just one other thing to call out is you can

00:01:30.588 --> 00:01:32.948
look at how this is structured OpenAI

00:01:33.588 --> 00:01:35.188
simply just using the OpenAI

00:01:37.128 --> 00:01:39.688
or the OpenAI provider passing in a specific model

00:01:39.928 --> 00:01:40.898
and anthropic

00:01:41.218 --> 00:01:42.738
Google or custom,

00:01:42.818 --> 00:01:43.698
which is kind of cool.

00:01:43.698 --> 00:01:44.978
So you can also build your own custom

00:01:45.058 --> 00:01:46.078
implementations of

00:01:46.078 --> 00:01:46.878
model providers.

00:01:46.878 --> 00:01:47.158
But

00:01:48.038 --> 00:01:50.038
what makes this really nice is we can experiment,

00:01:50.038 --> 00:01:50.538
we can use

00:01:50.538 --> 00:01:52.258
a whole bunch of different Cloudflare models,

00:01:52.258 --> 00:01:53.178
but we can also

00:01:53.738 --> 00:01:54.418
utilize

00:01:54.418 --> 00:01:56.208
a whole bunch of different providers and you can

00:01:56.208 --> 00:01:57.168
play with different prompts,

00:01:57.168 --> 00:01:58.968
you can play with different like models on how

00:01:58.968 --> 00:02:01.488
they perform with a given prompt and you can build

00:02:01.488 --> 00:02:01.848
really,

00:02:01.928 --> 00:02:03.048
really sophisticated

00:02:03.368 --> 00:02:05.888
evaluations of your AI output on the back end.

00:02:06.008 --> 00:02:06.488
if you want to.

00:02:06.488 --> 00:02:08.008
We're not going to go that deep into this course

00:02:08.008 --> 00:02:09.568
we're mostly just going to integrate this into our

00:02:09.568 --> 00:02:10.488
existing application

00:02:10.808 --> 00:02:13.408
but at the core this is kind of like how you use

00:02:13.408 --> 00:02:16.048
the AI SDK if you're just doing really basic text

00:02:16.048 --> 00:02:17.768
generation and I do encourage you to go deeper

00:02:17.768 --> 00:02:18.628
into this section

00:02:18.628 --> 00:02:20.188
if you want to see like the other capabilities

00:02:21.218 --> 00:02:23.858
Now one cool thing about the Cloudflare AI workers

00:02:23.858 --> 00:02:27.498
is they do realize that the AI SDK is very widely

00:02:27.498 --> 00:02:27.778
used

00:02:28.258 --> 00:02:30.338
so they ended up building their very own

00:02:30.591 --> 00:02:31.391
their very own

00:02:32.631 --> 00:02:35.511
implementation of a provider so you can install

00:02:35.511 --> 00:02:37.271
the workers AI provider

00:02:37.591 --> 00:02:39.611
and then what you can do is you're going to notice

00:02:39.611 --> 00:02:42.101
you basically define this model and you pass in

00:02:42.101 --> 00:02:43.741
the Cloudflare model here and then

00:02:44.141 --> 00:02:48.061
you're able to use the generate text from the AI

00:02:48.061 --> 00:02:48.701
SDK.

00:02:48.701 --> 00:02:51.421
So it's cool that it even works with Cloudflare's

00:02:51.421 --> 00:02:52.381
native built in

00:02:52.381 --> 00:02:55.121
offering for their AI for their AI models.

00:02:55.201 --> 00:02:57.241
So let's go ahead and start implementing the code

00:02:57.241 --> 00:02:57.647
for this.

00:02:57.799 --> 00:02:59.959
So what I'm going to do here is basically we're

00:02:59.959 --> 00:03:02.679
going to have a new step that passes in the body

00:03:02.759 --> 00:03:04.559
of the data that was scraped,

00:03:04.559 --> 00:03:05.439
but not just like the body,

00:03:05.439 --> 00:03:07.639
the actual extracted text from the body.

00:03:07.639 --> 00:03:10.359
Because you can imagine an HTML document is going

00:03:10.359 --> 00:03:12.439
to have a whole bunch of tags for like,

00:03:12.949 --> 00:03:14.989
formatting and styling and layout and whatnot.

00:03:14.989 --> 00:03:16.309
And that's just going to take up a whole bunch of

00:03:16.309 --> 00:03:16.669
tokens.

00:03:16.669 --> 00:03:18.789
It's going to be more expensive from the AI side,

00:03:18.869 --> 00:03:21.549
which is why we have extracted the,

00:03:21.619 --> 00:03:22.979
the text from the body.

00:03:23.139 --> 00:03:25.379
And then we're also returning this here just so we

00:03:25.379 --> 00:03:25.899
can use that.

00:03:25.899 --> 00:03:27.679
And that's going to just keep our

00:03:27.679 --> 00:03:29.689
it's going to keep our prompt more concise and

00:03:29.689 --> 00:03:30.569
it's going to be less,

00:03:30.889 --> 00:03:32.809
information that the model has to reason about.

00:03:32.889 --> 00:03:35.609
So it'll likely give us better outputs from the AI

00:03:35.609 --> 00:03:36.968
side of things and it will also be much,

00:03:36.968 --> 00:03:37.529
much cheaper.

00:03:38.029 --> 00:03:39.609
so what we're going to do is we're going to go

00:03:39.609 --> 00:03:42.369
into the helpers and we're going to go ahead and

00:03:42.369 --> 00:03:43.329
create a,

00:03:43.669 --> 00:03:46.769
file called AI Destination Checker ts.

00:03:47.619 --> 00:03:49.299
Now this file is going to be pretty,

00:03:49.379 --> 00:03:51.299
it's going to have a very simple method and we're

00:03:51.299 --> 00:03:53.149
going to be using the generate,

00:03:53.149 --> 00:03:54.117
Generate object

00:03:54.183 --> 00:03:54.583
from.

00:03:55.223 --> 00:03:57.143
Generate object from the AI SDK,

00:03:57.623 --> 00:04:00.223
slightly different from what we see here in this

00:04:00.223 --> 00:04:02.023
example where this is generate text.

00:04:02.023 --> 00:04:04.183
The reason we're using generate object is because

00:04:04.503 --> 00:04:06.863
we are going to be using structured output.

00:04:06.863 --> 00:04:08.743
We're not just going to be generating like raw

00:04:08.743 --> 00:04:09.103
text,

00:04:09.103 --> 00:04:10.983
but essentially the semantics,

00:04:11.013 --> 00:04:12.753
and the syntax here is going to be the exact,

00:04:12.753 --> 00:04:14.513
exact same as what you see here.

00:04:15.283 --> 00:04:17.603
now we're going to most likely have to install

00:04:19.165 --> 00:04:22.605
inside of data service pmpmi Zod Looks like

00:04:23.325 --> 00:04:25.725
Zod is currently not installed in this specific

00:04:25.725 --> 00:04:26.266
application.

00:04:27.318 --> 00:04:29.798
And then what we're going to do is we're going to

00:04:29.878 --> 00:04:31.558
first define a schema,

00:04:31.558 --> 00:04:32.638
an output schema.

00:04:32.638 --> 00:04:35.398
So we can use Zod to basically say,

00:04:35.398 --> 00:04:35.865
okay,

00:04:35.908 --> 00:04:37.668
I expect a specific type

00:04:37.848 --> 00:04:39.568
of data in a specific structure

00:04:39.888 --> 00:04:40.848
with specific

00:04:40.928 --> 00:04:43.928
values to be outputted from the,

00:04:43.928 --> 00:04:45.368
from a model output.

00:04:45.368 --> 00:04:47.368
So to kind of explain what that would look like,

00:04:47.368 --> 00:04:48.608
I have this copy and pasted.

00:04:48.848 --> 00:04:51.728
We're going to define this specific output schema.

00:04:51.728 --> 00:04:54.248
And what we're going to notice about this output

00:04:54.248 --> 00:04:56.688
schema is we can basically say

00:04:57.187 --> 00:04:59.313
is we can basically say we're going to define this

00:04:59.313 --> 00:05:00.423
Zod object and,

00:05:00.493 --> 00:05:03.133
and this odd object is going to have a payment

00:05:03.133 --> 00:05:03.565
status

00:05:03.565 --> 00:05:05.380
and the payment status is going to have two

00:05:05.380 --> 00:05:06.220
different properties.

00:05:06.220 --> 00:05:09.100
The first property is going to be just status and

00:05:09.100 --> 00:05:10.340
this is going to be an enum.

00:05:10.340 --> 00:05:12.140
And right now we just kind of have like three

00:05:12.140 --> 00:05:13.099
different statuses.

00:05:13.180 --> 00:05:14.540
We have available product,

00:05:14.780 --> 00:05:17.020
not available product or unknown status.

00:05:17.020 --> 00:05:19.580
Now this is a very much like an E commerce centric

00:05:19.580 --> 00:05:20.060
use case,

00:05:20.060 --> 00:05:22.140
but you could imagine you could make this more

00:05:22.140 --> 00:05:22.460
general.

00:05:22.460 --> 00:05:24.300
You can create whatever statuses you want.

00:05:24.300 --> 00:05:24.700
So

00:05:25.200 --> 00:05:26.800
when the AI is scanning the

00:05:27.040 --> 00:05:28.740
text of a specific web page,

00:05:28.980 --> 00:05:31.820
it's able to like not just tag from these three

00:05:31.820 --> 00:05:32.300
statuses,

00:05:32.300 --> 00:05:33.940
but you can kind of define your own concepts here.

00:05:33.940 --> 00:05:36.380
And this is where like really the experimentation

00:05:36.380 --> 00:05:38.820
of working with AI is really big because there's

00:05:38.820 --> 00:05:40.779
so many different things that it can do and it

00:05:40.779 --> 00:05:42.660
really just kind of depends on like what models,

00:05:42.760 --> 00:05:43.240
you're using,

00:05:43.480 --> 00:05:44.920
how you're structuring your prompt,

00:05:44.960 --> 00:05:46.980
kind of like the strategy and the vibes around how

00:05:46.980 --> 00:05:47.700
you work with it.

00:05:47.700 --> 00:05:49.540
So it is kind of an interesting aspect of

00:05:49.540 --> 00:05:51.380
engineering that's changed the way that I think

00:05:51.380 --> 00:05:52.140
about things because

00:05:52.710 --> 00:05:52.950
you know,

00:05:52.950 --> 00:05:54.910
like a lot of this is just kind of like how it

00:05:54.910 --> 00:05:56.310
feels where you know,

00:05:56.310 --> 00:05:58.630
it's less of like a deterministic output.

00:05:58.630 --> 00:06:00.630
But the good thing about the

00:06:01.030 --> 00:06:03.790
the structured output is we can guarantee that

00:06:03.790 --> 00:06:06.190
we're going to get result with this specific type.

00:06:06.190 --> 00:06:08.589
So you can see here we have status and we're

00:06:08.589 --> 00:06:10.150
providing these three different types.

00:06:10.310 --> 00:06:11.630
And what you can also do,

00:06:11.630 --> 00:06:13.030
a really nice thing about Zod,

00:06:13.260 --> 00:06:15.690
is you can pass in a description and this

00:06:15.690 --> 00:06:17.770
description can kind of like provide further

00:06:17.770 --> 00:06:19.890
context to the model as to what you're looking

00:06:19.890 --> 00:06:20.170
for.

00:06:20.170 --> 00:06:22.730
So here we basically say indicates the product's

00:06:22.730 --> 00:06:23.810
availability on the pa.

00:06:24.510 --> 00:06:24.750
available,

00:06:25.230 --> 00:06:27.070
the product appears available for purchase,

00:06:27.070 --> 00:06:27.550
not available,

00:06:27.710 --> 00:06:29.470
the product appears unavailable,

00:06:29.470 --> 00:06:29.910
sold out,

00:06:29.910 --> 00:06:30.470
discontinued,

00:06:30.470 --> 00:06:30.830
whatever.

00:06:30.830 --> 00:06:31.790
Right now,

00:06:32.030 --> 00:06:34.550
this is just kind of like a very simplified

00:06:34.550 --> 00:06:35.350
version of this prompt.

00:06:35.350 --> 00:06:36.670
We're actually going to have a more enhanced

00:06:36.670 --> 00:06:36.950
prompt.

00:06:36.950 --> 00:06:38.350
But what you can notice here is like we're

00:06:38.350 --> 00:06:39.509
basically just you know,

00:06:39.509 --> 00:06:42.750
providing some like extra help to the model so we

00:06:42.750 --> 00:06:42.990
can

00:06:43.850 --> 00:06:46.730
determine specifically what status that it should

00:06:46.730 --> 00:06:47.570
tag the given

00:06:47.890 --> 00:06:49.330
input text or the given

00:06:49.870 --> 00:06:52.510
text from a web page into specific statuses.

00:06:52.590 --> 00:06:52.935
Now

00:06:52.935 --> 00:06:55.351
we're also going to have this property status

00:06:55.351 --> 00:06:55.671
reason,

00:06:55.991 --> 00:06:58.671
where the status reason has a description that we

00:06:58.671 --> 00:07:00.991
provide to the model which basically says a

00:07:00.991 --> 00:07:02.031
concise explanation,

00:07:02.031 --> 00:07:03.271
citing specific words,

00:07:03.271 --> 00:07:03.751
phrases,

00:07:03.751 --> 00:07:04.311
patterns,

00:07:04.391 --> 00:07:06.391
from the context that lead to the status.

00:07:06.391 --> 00:07:07.431
If unknown status,

00:07:07.431 --> 00:07:09.751
explain why it was missing or ambiguous.

00:07:09.751 --> 00:07:12.511
So essentially like what I've noticed is when you

00:07:12.511 --> 00:07:13.831
want AI to tag

00:07:14.771 --> 00:07:16.611
specific statuses given a prompt,

00:07:16.851 --> 00:07:19.291
if you also ask it to provide a reason as to why

00:07:19.291 --> 00:07:20.691
it provided that status.

00:07:20.691 --> 00:07:22.811
It does a much better job at actually like

00:07:22.811 --> 00:07:24.011
providing accurate statuses.

00:07:24.011 --> 00:07:26.331
Now this is kind of like mostly just like vibe

00:07:26.331 --> 00:07:27.891
based and then also you know,

00:07:27.891 --> 00:07:30.011
evaluations that I've done on data sets.

00:07:30.011 --> 00:07:30.291
But

00:07:31.941 --> 00:07:34.501
just simply asking for like a one line or a very

00:07:34.501 --> 00:07:34.981
simple

00:07:35.111 --> 00:07:37.481
concise explanation as to why it did what it did

00:07:37.801 --> 00:07:39.801
oftentimes gives you better output.

00:07:40.631 --> 00:07:41.111
and then

00:07:41.124 --> 00:07:41.670
at the very,

00:07:41.670 --> 00:07:43.910
very top level here you're going to notice that

00:07:44.110 --> 00:07:45.070
have some other descriptions.

00:07:45.070 --> 00:07:46.470
And the good thing about the

00:07:46.790 --> 00:07:47.270
Zod,

00:07:47.590 --> 00:07:48.110
about these,

00:07:48.110 --> 00:07:48.830
this object,

00:07:48.830 --> 00:07:49.750
when you pass it descriptions,

00:07:49.750 --> 00:07:50.070
these

00:07:50.550 --> 00:07:51.670
descriptions are actually

00:07:52.070 --> 00:07:52.790
passed into

00:07:53.270 --> 00:07:54.269
the input prompt.

00:07:54.269 --> 00:07:56.202
Now if you remember early on in a few,

00:07:56.202 --> 00:07:59.722
a few videos ago I was showing the actual format

00:07:59.962 --> 00:08:02.282
that is passed if you make an open or if you make

00:08:02.282 --> 00:08:03.402
an API call to

00:08:03.962 --> 00:08:06.642
a provider that uses this JSON format for

00:08:06.642 --> 00:08:07.562
structured outputs.

00:08:07.562 --> 00:08:08.042
And then

00:08:08.382 --> 00:08:11.102
I noted that you know you can pass in a specific

00:08:11.102 --> 00:08:11.502
type,

00:08:11.502 --> 00:08:13.102
it's going to be in the JSON format and then you

00:08:13.102 --> 00:08:15.622
can provide a schema and that schema has you know

00:08:15.622 --> 00:08:15.902
like

00:08:16.262 --> 00:08:18.102
it's going to be of the type object and here are

00:08:18.102 --> 00:08:19.342
the properties within an object

00:08:19.662 --> 00:08:20.062
and

00:08:20.162 --> 00:08:22.482
you know you can also not showing in this use case

00:08:22.482 --> 00:08:23.162
but you can provide

00:08:23.562 --> 00:08:25.162
descriptions as to like

00:08:25.542 --> 00:08:27.662
what this property is like describing what that

00:08:27.662 --> 00:08:28.422
property should be.

00:08:28.742 --> 00:08:30.582
And this is being fed into

00:08:31.122 --> 00:08:31.642
the input

00:08:31.952 --> 00:08:34.512
of the prompt and then it's actually kind of like

00:08:34.902 --> 00:08:36.792
influencing how the model is going to behave and

00:08:36.792 --> 00:08:38.632
then it's going to be enforcing that this specific

00:08:38.632 --> 00:08:39.472
type on the way back.

00:08:39.472 --> 00:08:42.032
Now this is a curl and you can see that this is

00:08:42.032 --> 00:08:42.592
kind of like,

00:08:42.592 --> 00:08:44.392
kind of a complicated structure to work with.

00:08:44.392 --> 00:08:44.992
It's going to be,

00:08:44.992 --> 00:08:45.352
you know,

00:08:45.352 --> 00:08:47.232
if you were to type this out on your own it'd be a

00:08:47.232 --> 00:08:48.192
little bit tedious.

00:08:48.272 --> 00:08:48.672
So

00:08:49.232 --> 00:08:51.792
you know what OpenAI has done is

00:08:52.112 --> 00:08:53.952
they've basically used Zod,

00:08:54.032 --> 00:08:55.712
which is kind of what we've done here.

00:08:55.872 --> 00:08:59.352
And they have inside of here this Zod text format.

00:08:59.352 --> 00:09:01.792
So you basically pass it in a schema

00:09:02.172 --> 00:09:04.492
like here and then you give it a name and

00:09:05.042 --> 00:09:05.812
it's able to

00:09:06.132 --> 00:09:08.412
take this schema and kind of iterate through that

00:09:08.412 --> 00:09:11.932
schema and create the exact same structure as what

00:09:11.932 --> 00:09:12.612
you see here.

00:09:12.612 --> 00:09:14.932
So it's not magic that's happening when we're

00:09:14.932 --> 00:09:16.212
passing in like an actual,

00:09:16.532 --> 00:09:16.972
you know,

00:09:16.972 --> 00:09:18.452
programmatic Zod schema here.

00:09:18.452 --> 00:09:19.732
It just is really simple.

00:09:19.732 --> 00:09:20.772
They have this like

00:09:21.102 --> 00:09:22.639
they have this library that.

00:09:22.639 --> 00:09:24.093
They have this library that is

00:09:24.221 --> 00:09:26.553
helping you know convert a Zod schema into a

00:09:26.553 --> 00:09:28.513
schema that their API recognizes.

00:09:28.513 --> 00:09:29.793
So there's really no magic here.

00:09:30.023 --> 00:09:30.533
and then

00:09:30.913 --> 00:09:32.593
on the AI side of things,

00:09:32.673 --> 00:09:33.033
what,

00:09:33.033 --> 00:09:35.153
what we're going to notice is when we pass it in

00:09:35.153 --> 00:09:35.553
to

00:09:35.953 --> 00:09:39.233
a helper method from the AISDK under the hood,

00:09:39.233 --> 00:09:40.353
they're most likely using

00:09:40.673 --> 00:09:42.993
this exact same dependency here.

00:09:43.013 --> 00:09:44.113
maybe they're using something different,

00:09:44.113 --> 00:09:45.233
maybe they're doing it on their,

00:09:45.233 --> 00:09:45.793
on their end,

00:09:45.793 --> 00:09:47.993
but they're probably just under the hood also

00:09:47.993 --> 00:09:48.753
using this.

00:09:48.753 --> 00:09:50.953
So there's just a lot of layers of abstraction.

00:09:50.953 --> 00:09:52.793
I just want to make sure we kind of like touch on

00:09:52.793 --> 00:09:53.633
a few of these layers.

00:09:53.633 --> 00:09:54.273
Just so you know,

00:09:54.273 --> 00:09:54.593
like,

00:09:54.753 --> 00:09:55.633
if you wanted to,

00:09:55.633 --> 00:09:57.193
you could use a normal API call,

00:09:57.193 --> 00:09:59.153
you could provide this really verbose schema and

00:09:59.153 --> 00:10:00.273
you're going to get that type back.

00:10:00.443 --> 00:10:01.923
Now if you want to like make things more

00:10:01.923 --> 00:10:03.203
programmatic and easier to manage,

00:10:03.203 --> 00:10:05.203
you're probably going to be using some type of

00:10:05.203 --> 00:10:05.963
schema library.

00:10:05.963 --> 00:10:07.883
So Python has something called pydantic,

00:10:08.283 --> 00:10:11.083
but in TypeScript or JavaScript you have Zod and

00:10:11.083 --> 00:10:11.643
then you know,

00:10:11.643 --> 00:10:14.283
this is able to go from like a Zod schema to their

00:10:14.363 --> 00:10:17.003
specific JSON schema that their API expects.

00:10:17.083 --> 00:10:19.003
So let's actually move into

00:10:19.323 --> 00:10:20.123
using this.

00:10:20.283 --> 00:10:21.473
So we have this

00:10:21.473 --> 00:10:23.663
method or this function called aidestination

00:10:23.663 --> 00:10:24.223
checker.

00:10:24.223 --> 00:10:25.783
Now first thing that we're going to do

00:10:26.213 --> 00:10:28.533
is we're going to define a workers AI.

00:10:28.933 --> 00:10:31.813
And what this does is it essentially creates

00:10:31.983 --> 00:10:33.663
a object that

00:10:33.983 --> 00:10:34.783
takes into

00:10:35.103 --> 00:10:35.503
the

00:10:35.693 --> 00:10:38.219
that takes in the context of this specific

00:10:38.220 --> 00:10:38.740
binding,

00:10:38.740 --> 00:10:39.660
which is our

00:10:40.280 --> 00:10:40.800
AI.

00:10:40.800 --> 00:10:41.400
Oh yeah,

00:10:41.560 --> 00:10:42.160
One thing,

00:10:42.160 --> 00:10:43.920
we probably should have done this a little bit

00:10:43.920 --> 00:10:44.200
earlier.

00:10:44.600 --> 00:10:47.520
Let's head to our wrangler JSON C file in our data

00:10:47.520 --> 00:10:47.880
service

00:10:48.440 --> 00:10:50.400
and in the binding what we're going to do is we're

00:10:50.400 --> 00:10:53.050
going to be adding this AI and dependency and

00:10:53.050 --> 00:10:55.290
we're going to give it the binding name AI here.

00:10:55.690 --> 00:10:57.090
Now when we run PNPM,

00:10:57.090 --> 00:10:57.930
run CF

00:10:58.810 --> 00:10:59.530
type gen,

00:10:59.552 --> 00:11:02.113
it's going to generate that type and then now we

00:11:02.113 --> 00:11:04.313
should see if we say EMB A,

00:11:04.873 --> 00:11:06.073
it's going to provide,

00:11:06.073 --> 00:11:08.553
it's going to basically pass in this AI binding

00:11:08.873 --> 00:11:10.313
into this helper

00:11:10.323 --> 00:11:12.633
function that Cloudflare is providing us.

00:11:12.633 --> 00:11:14.993
And then from there what we can do is we can

00:11:14.993 --> 00:11:17.753
essentially say we're going to actually pass in

00:11:17.753 --> 00:11:18.513
the body text

00:11:18.793 --> 00:11:20.233
to our API provider

00:11:20.793 --> 00:11:23.593
and this is going to be using the generate object

00:11:23.593 --> 00:11:24.919
from our AI SDK.

00:11:24.919 --> 00:11:26.978
And what this is going to take is this is going to

00:11:26.978 --> 00:11:27.778
take a model

00:11:28.098 --> 00:11:30.418
and for now we're going to be using our workers

00:11:30.498 --> 00:11:31.138
AI,

00:11:31.768 --> 00:11:32.838
variable that we defined

00:11:33.318 --> 00:11:34.998
and we will be passing in

00:11:35.518 --> 00:11:37.718
a specific model that we want to use.

00:11:37.718 --> 00:11:39.118
Now you're going to notice that,

00:11:40.108 --> 00:11:41.268
they kind of allow you.

00:11:41.268 --> 00:11:42.348
Because this is typescript,

00:11:42.348 --> 00:11:44.588
they have like all of these as specific

00:11:44.928 --> 00:11:46.528
models that we can pass into here.

00:11:46.768 --> 00:11:47.808
Now I have one here.

00:11:47.808 --> 00:11:48.368
This is

00:11:48.628 --> 00:11:49.348
one from Meta.

00:11:49.348 --> 00:11:50.348
It performs pretty well,

00:11:50.348 --> 00:11:52.828
but you can definitely play around with the models

00:11:52.828 --> 00:11:54.388
that support the structured output.

00:11:54.388 --> 00:11:55.588
You can pass them into here.

00:11:55.588 --> 00:11:55.988
So,

00:11:56.672 --> 00:11:59.013
now it looks like we are getting an issue here.

00:11:59.173 --> 00:12:00.213
Why is that the case?

00:12:00.941 --> 00:12:01.997
just one second here.

00:12:01.997 --> 00:12:04.477
So we're passing the model and then we're also

00:12:04.477 --> 00:12:05.517
going to give it a prompt.

00:12:05.597 --> 00:12:07.317
So the prompt that we're going to give it is just

00:12:07.317 --> 00:12:07.917
going to be like,

00:12:08.157 --> 00:12:10.237
is this product available for purchase?

00:12:10.397 --> 00:12:11.757
So we'll pass in this prompt,

00:12:12.327 --> 00:12:14.167
is this product available for purchase?

00:12:14.247 --> 00:12:15.847
And then we're also going to

00:12:16.487 --> 00:12:16.497
pass,

00:12:16.707 --> 00:12:17.067
in

00:12:17.467 --> 00:12:20.427
the body text that we're passing into this method.

00:12:20.427 --> 00:12:22.587
So in the prompt it's just going to be like this

00:12:22.587 --> 00:12:25.347
big block of the text that we scraped from the web

00:12:25.347 --> 00:12:25.707
page.

00:12:25.947 --> 00:12:27.986
And then we're also going to pass in the schema,

00:12:27.986 --> 00:12:29.168
which is the output schema.

00:12:29.529 --> 00:12:29.965
All right,

00:12:29.965 --> 00:12:31.005
so as you can see here,

00:12:31.085 --> 00:12:32.765
we're essentially defining this result.

00:12:33.285 --> 00:12:35.805
we're awaiting generate object instead of generate

00:12:35.805 --> 00:12:36.085
text.

00:12:36.085 --> 00:12:38.325
So we're not generating text like this example,

00:12:38.485 --> 00:12:40.805
we're generating an object and that object

00:12:40.805 --> 00:12:42.465
requires output schema.

00:12:42.465 --> 00:12:43.985
And that's what we've defined right here.

00:12:43.985 --> 00:12:46.665
We've passed in the prompt with the entire body

00:12:46.665 --> 00:12:47.056
text.

00:12:47.056 --> 00:12:49.259
And then we've also passed in our model which is

00:12:49.259 --> 00:12:51.259
using this workers AI wrapper.

00:12:51.259 --> 00:12:51.659
So

00:12:51.979 --> 00:12:54.299
now what we can do is we can just simply.

00:12:54.379 --> 00:12:56.219
We're going to return a few things here.

00:12:57.509 --> 00:12:59.989
this response is going to give us a status from

00:12:59.989 --> 00:13:02.229
the API and it's going to give us a status reason.

00:13:02.309 --> 00:13:04.069
So it's basically going to give us

00:13:04.389 --> 00:13:06.309
this right here and this right here.

00:13:06.389 --> 00:13:07.749
These are the things that we care about.

00:13:07.909 --> 00:13:09.909
So we can say status and,

00:13:09.979 --> 00:13:12.311
and this is going to be result.object.

00:13:12.910 --> 00:13:14.482
pagestatus.status.

00:13:14.802 --> 00:13:16.482
and then we can say status,

00:13:16.482 --> 00:13:16.802
region,

00:13:17.042 --> 00:13:18.482
Reason is going to be the same thing.

00:13:18.482 --> 00:13:20.722
So this is going to provide us both of these,

00:13:20.912 --> 00:13:21.712
which is kind of cool.

00:13:21.712 --> 00:13:22.152
It's kind of,

00:13:22.152 --> 00:13:24.112
it's kind of nice how concise this code is.

00:13:24.752 --> 00:13:26.432
right now we've kind of defined the prompt in our

00:13:26.432 --> 00:13:26.872
code base,

00:13:26.872 --> 00:13:27.632
but there are like,

00:13:27.632 --> 00:13:29.672
ways you can kind of abstract that into a separate

00:13:29.672 --> 00:13:29.912
service.

00:13:29.912 --> 00:13:31.512
If you're building something really robust where

00:13:31.512 --> 00:13:33.632
you want to like play around with a whole bunch of

00:13:33.632 --> 00:13:34.312
different prompts.

00:13:34.312 --> 00:13:35.192
But for now,

00:13:35.192 --> 00:13:36.272
I think this is good enough.

00:13:36.412 --> 00:13:37.612
what we can do from here

00:13:38.050 --> 00:13:39.907
is we can head over to our workflow

00:13:39.907 --> 00:13:41.579
and we will be adding a new step.

00:13:41.819 --> 00:13:43.819
So this step is going to be called

00:13:44.579 --> 00:13:45.299
evaluation.

00:13:45.948 --> 00:13:46.250
Well,

00:13:46.552 --> 00:13:48.312
we'll call this AI status.

00:13:48.392 --> 00:13:52.992
So AI status is going to define a step and it's

00:13:52.992 --> 00:13:55.032
going to say use AI to check the page status.

00:13:55.272 --> 00:13:58.392
And because this is an AI operation where,

00:13:58.972 --> 00:14:00.612
it could be computationally expensive,

00:14:00.612 --> 00:14:01.572
it could also charge,

00:14:01.572 --> 00:14:02.492
it could charge a lot,

00:14:02.492 --> 00:14:03.452
it's going to be slower.

00:14:03.772 --> 00:14:06.292
I don't want some type of issue to be going on

00:14:06.292 --> 00:14:07.852
with the provider or the code where

00:14:08.252 --> 00:14:09.012
if it fails,

00:14:09.012 --> 00:14:09.812
it keeps retrying.

00:14:09.812 --> 00:14:11.332
Let's say it retries three times and it

00:14:11.332 --> 00:14:12.092
continuously fails,

00:14:12.092 --> 00:14:13.412
and then we just kind of eat that cost.

00:14:13.412 --> 00:14:14.452
I like to kind of keep,

00:14:14.452 --> 00:14:16.412
whenever I do types of AI operations,

00:14:16.732 --> 00:14:19.092
I like to keep it to just have like one or zero

00:14:19.092 --> 00:14:19.692
retries,

00:14:19.692 --> 00:14:21.212
just so we can control that spend.

00:14:21.582 --> 00:14:23.465
and then we're going to import our AI checker.

00:14:23.510 --> 00:14:25.030
And it looks like I have a different name here.

00:14:25.030 --> 00:14:25.350
So,

00:14:25.350 --> 00:14:26.270
collected data,

00:14:26.270 --> 00:14:28.253
and we're going to pass in the data body text.

00:14:28.341 --> 00:14:29.461
So this should return,

00:14:29.841 --> 00:14:31.171
this should return the,

00:14:31.921 --> 00:14:32.321
the,

00:14:32.401 --> 00:14:34.561
the AI status and the AI status reason.

00:14:34.641 --> 00:14:36.361
So just to kind of recap what we have here,

00:14:36.361 --> 00:14:39.361
we have a workflow that takes collected data.

00:14:39.921 --> 00:14:43.081
It goes and it scrapes the web page that we

00:14:43.081 --> 00:14:44.801
provide into this workflow.

00:14:45.291 --> 00:14:46.571
It gets the HTML,

00:14:46.571 --> 00:14:47.691
it also gets the body text,

00:14:47.691 --> 00:14:49.651
and then it uses the body text right here and it

00:14:49.651 --> 00:14:51.211
stuffs that body text into,

00:14:52.071 --> 00:14:56.111
an AI prompt that is using the generate object

00:14:56.111 --> 00:14:59.231
from the AI SDK to give us a structured output to

00:14:59.231 --> 00:15:01.591
kind of figure out the availability of a given

00:15:01.831 --> 00:15:03.511
product page or a given website.

00:15:04.151 --> 00:15:05.511
So what we can do from here

00:15:05.911 --> 00:15:07.671
is we can go ahead and deploy this.

00:15:07.671 --> 00:15:08.751
So we can try to like,

00:15:08.751 --> 00:15:10.431
actually run and test this OP and pm.

00:15:10.431 --> 00:15:10.791
Run,

00:15:11.731 --> 00:15:12.078
deploy.

00:15:12.103 --> 00:15:14.743
So now that this has been successfully deployed,

00:15:14.743 --> 00:15:17.063
let's head over to our Cloudflare dashboard,

00:15:17.383 --> 00:15:19.303
head over to compute and workers,

00:15:19.463 --> 00:15:20.463
go to workflows,

00:15:20.463 --> 00:15:22.743
and then let's click on the specific workflow that

00:15:22.743 --> 00:15:23.383
we have in mind.

00:15:23.463 --> 00:15:25.503
Now I'm going to go ahead and say trigger again.

00:15:25.503 --> 00:15:27.143
And what I've done here is I have a

00:15:27.573 --> 00:15:28.053
input,

00:15:28.053 --> 00:15:29.293
which is taking the link id,

00:15:29.783 --> 00:15:33.423
the destination URL and the test account ID here.

00:15:33.423 --> 00:15:33.663
Now,

00:15:33.663 --> 00:15:33.863
really,

00:15:33.863 --> 00:15:35.703
the only thing that we care about at this moment

00:15:35.783 --> 00:15:37.103
is this destination URL.

00:15:37.103 --> 00:15:38.983
And what I did is I went online and I found

00:15:39.303 --> 00:15:41.863
some AliExpress product that is currently

00:15:42.263 --> 00:15:44.623
no Longer available because it's kind of an older

00:15:44.623 --> 00:15:44.903
product.

00:15:45.143 --> 00:15:45.543
So

00:15:45.743 --> 00:15:48.243
this is a great use case where we can see like we

00:15:48.243 --> 00:15:48.923
should see it,

00:15:48.923 --> 00:15:50.283
tag it as not

00:15:50.603 --> 00:15:52.603
as basically saying this product is not available.

00:15:53.343 --> 00:15:54.903
so let's go ahead and trigger that workflow.

00:15:54.903 --> 00:15:56.463
It's probably going to take a few seconds for it

00:15:56.463 --> 00:15:58.103
to kick off because essentially you have to go

00:15:58.103 --> 00:15:58.623
scrape the

00:15:58.623 --> 00:15:59.543
content of that page

00:15:59.943 --> 00:16:02.043
and then the next step is going to be passing it

00:16:02.043 --> 00:16:02.883
into the AI.

00:16:02.963 --> 00:16:05.203
So I'm going to go ahead and

00:16:06.103 --> 00:16:08.423
skip essentially to the section where this is

00:16:08.423 --> 00:16:08.695
done.

00:16:09.056 --> 00:16:11.536
So we can now see in real time that this has

00:16:11.616 --> 00:16:12.876
popped up as running.

00:16:12.876 --> 00:16:13.276
So

00:16:13.626 --> 00:16:14.546
the first step is running.

00:16:14.546 --> 00:16:16.706
We are collecting the render destination page.

00:16:16.706 --> 00:16:19.226
So we are scraping the web page and this is going

00:16:19.226 --> 00:16:19.986
to be a bit of a delay.

00:16:19.986 --> 00:16:21.666
I would actually suspect that this workflow is

00:16:21.666 --> 00:16:22.466
done at this point.

00:16:22.466 --> 00:16:22.866
Yep,

00:16:22.866 --> 00:16:23.346
there we go.

00:16:23.346 --> 00:16:23.706
So

00:16:24.526 --> 00:16:26.526
now both of our steps are defined,

00:16:26.526 --> 00:16:27.606
are completed here.

00:16:27.606 --> 00:16:29.946
If you noticed before when we ran this we only had

00:16:29.946 --> 00:16:30.266
one step.

00:16:30.266 --> 00:16:31.826
But now that we've defined a second step in our

00:16:31.826 --> 00:16:33.746
workflow we have that second step here.

00:16:33.746 --> 00:16:36.786
And this says use AI to check if the status of a

00:16:36.786 --> 00:16:37.106
page.

00:16:37.106 --> 00:16:39.306
You use AI to check status of page.

00:16:39.306 --> 00:16:42.146
So you can see that the output is status product

00:16:42.146 --> 00:16:42.746
not available

00:16:43.066 --> 00:16:44.066
and it gives us a reason.

00:16:44.066 --> 00:16:45.666
And the product appears to be unavailable,

00:16:45.666 --> 00:16:46.066
sold out,

00:16:46.066 --> 00:16:46.546
discontinued,

00:16:46.546 --> 00:16:49.626
etc because the due to zero quantity.

00:16:49.866 --> 00:16:52.026
in the help section which indicates

00:16:52.156 --> 00:16:52.476
the,

00:16:52.476 --> 00:16:52.836
the,

00:16:53.956 --> 00:16:54.836
which indicate

00:16:55.776 --> 00:16:57.176
the availability of purchase.

00:16:57.176 --> 00:16:59.006
So it did successfully

00:16:59.006 --> 00:17:01.076
tag this as saying it was not available.

00:17:01.236 --> 00:17:01.636
Now

00:17:01.896 --> 00:17:03.976
I would honestly expect it to pull

00:17:04.296 --> 00:17:05.536
to like reference this,

00:17:05.536 --> 00:17:07.056
you know instead of quantity.

00:17:07.056 --> 00:17:07.416
But

00:17:07.996 --> 00:17:09.476
it did successfully tag it.

00:17:09.476 --> 00:17:11.456
So what we're going to do is one last thing here.

00:17:11.966 --> 00:17:12.326
I,

00:17:12.326 --> 00:17:14.406
I mentioned that this prompt is kind of like bare

00:17:14.406 --> 00:17:14.686
bones.

00:17:14.686 --> 00:17:15.566
It's really simple.

00:17:15.886 --> 00:17:18.486
Now typically like you want your prompts to be

00:17:18.486 --> 00:17:19.806
pretty descriptive and

00:17:20.586 --> 00:17:21.306
longer really.

00:17:21.526 --> 00:17:24.286
so what I have here is I have a prompt that I was

00:17:24.286 --> 00:17:25.046
playing around with

00:17:25.206 --> 00:17:27.186
a few days ago that works really well for this use

00:17:27.186 --> 00:17:27.346
case.

00:17:27.346 --> 00:17:28.826
So I'm going to go ahead and paste it in here and

00:17:28.826 --> 00:17:29.706
we'll just go over it.

00:17:31.066 --> 00:17:33.066
So now essentially what we have is

00:17:33.226 --> 00:17:35.906
the exact same code passing in the EMB and the

00:17:35.906 --> 00:17:36.546
body text,

00:17:36.586 --> 00:17:38.166
passing in the AI worker

00:17:38.486 --> 00:17:39.206
binding.

00:17:39.286 --> 00:17:42.086
Now we have a prompt that's going to be like much,

00:17:42.086 --> 00:17:43.166
much more descriptive.

00:17:43.166 --> 00:17:46.006
So at the prompt level we kind of say like you're

00:17:46.006 --> 00:17:47.806
going to analyze the webpage content and we give

00:17:47.806 --> 00:17:49.606
it a really good explanation as to what it's Going

00:17:49.606 --> 00:17:49.926
to do

00:17:51.156 --> 00:17:51.876
pass in the,

00:17:51.974 --> 00:17:53.816
we pass in the steps or the

00:17:53.888 --> 00:17:55.952
the goal that it's supposed to accomplish.

00:17:55.952 --> 00:17:58.632
So like identify language that indicates if a

00:17:58.632 --> 00:17:58.872
product,

00:17:59.272 --> 00:18:00.312
the product is available,

00:18:00.772 --> 00:18:03.532
or indicates the product's unavailability or the

00:18:03.532 --> 00:18:04.372
unknown status.

00:18:04.372 --> 00:18:04.772
Right.

00:18:04.782 --> 00:18:06.002
so we have like a very,

00:18:06.002 --> 00:18:08.762
very clear explanation as to what the model is

00:18:08.762 --> 00:18:09.442
supposed to do.

00:18:09.522 --> 00:18:10.082
And then

00:18:10.662 --> 00:18:12.902
we kind of delineate between the prompt and the

00:18:12.902 --> 00:18:15.422
web page and then we pass in the web page content

00:18:15.422 --> 00:18:16.022
right here.

00:18:16.022 --> 00:18:17.862
So we've just kind of enhanced this prompt just to

00:18:17.862 --> 00:18:19.502
give it a structure that's going to be a little

00:18:19.502 --> 00:18:21.782
bit more interpretable by these large language

00:18:21.782 --> 00:18:22.262
models.

00:18:22.262 --> 00:18:24.222
And then we also give it a much better system

00:18:24.222 --> 00:18:24.764
prompt here.

00:18:24.788 --> 00:18:27.188
And then here is basically the same thing.

00:18:27.188 --> 00:18:28.388
We haven't changed much.

00:18:28.398 --> 00:18:28.768
we've,

00:18:28.768 --> 00:18:29.918
we've made this

00:18:30.092 --> 00:18:30.332
the,

00:18:30.332 --> 00:18:32.532
the enum types and the definition here.

00:18:32.532 --> 00:18:33.332
And the reason

00:18:34.402 --> 00:18:35.762
description is all kind of the same.

00:18:36.002 --> 00:18:38.322
And we're passing this into our

00:18:39.702 --> 00:18:40.642
generate object,

00:18:41.022 --> 00:18:42.782
to our generate object prompt.

00:18:43.502 --> 00:18:44.382
and then we're also

00:18:44.782 --> 00:18:46.382
modify or passing it into

00:18:46.862 --> 00:18:47.182
the

00:18:47.182 --> 00:18:49.446
into the schema inside of this

00:18:50.006 --> 00:18:52.246
generate object from the AI SDK.

00:18:52.246 --> 00:18:54.486
Now I do expect this to work

00:18:54.966 --> 00:18:56.726
better just because I have actually played around

00:18:56.726 --> 00:18:57.526
with this a little bit.

00:18:57.606 --> 00:18:59.446
But this is one of the things where

00:19:00.076 --> 00:19:01.116
it's really up to you,

00:19:01.416 --> 00:19:04.256
the user or the creator of an application like

00:19:04.256 --> 00:19:05.536
this to experiment a lot,

00:19:05.536 --> 00:19:08.496
to just figure out exactly what types of prompts

00:19:08.496 --> 00:19:10.536
and what types of capabilities each model can do,

00:19:10.536 --> 00:19:11.296
how much they cost,

00:19:11.296 --> 00:19:12.056
how long they take.

00:19:12.056 --> 00:19:13.896
It's really just a whole bunch of experimentation.

00:19:14.496 --> 00:19:16.576
so I would encourage you to like try different

00:19:16.576 --> 00:19:17.056
models,

00:19:17.056 --> 00:19:18.006
different prompts.

00:19:18.006 --> 00:19:20.116
you can build workflows around like you know,

00:19:20.116 --> 00:19:22.516
AB testing different models and different prompts

00:19:22.516 --> 00:19:22.876
and stuff.

00:19:22.876 --> 00:19:25.356
And then on the back end you can have a whole

00:19:25.356 --> 00:19:27.766
system that kind of like uses a really beefy

00:19:27.766 --> 00:19:29.886
expensive model to kind of sample outputs and

00:19:29.886 --> 00:19:31.006
grade how they did.

00:19:31.006 --> 00:19:33.406
So this is like a lighter weight cheap model.

00:19:33.406 --> 00:19:35.526
But you could technically have an entire like

00:19:35.526 --> 00:19:37.806
backend service that is listening to the outputs,

00:19:37.886 --> 00:19:39.246
doing some batch processing.

00:19:39.246 --> 00:19:39.966
So it's cheaper

00:19:40.686 --> 00:19:40.736
using

00:19:40.866 --> 00:19:42.466
like Beefier models by OpenAI

00:19:42.786 --> 00:19:45.506
to you know like actually grade how,

00:19:45.826 --> 00:19:46.946
how it did or how,

00:19:46.946 --> 00:19:49.106
how like the model output actually performed here.

00:19:49.106 --> 00:19:49.506
So

00:19:49.826 --> 00:19:50.706
this is deployed,

00:19:50.866 --> 00:19:53.026
let's go ahead and head back to our

00:19:53.252 --> 00:19:53.852
our workflow.

00:19:53.852 --> 00:19:56.932
I'm just going to copy the same exact input and I

00:19:56.932 --> 00:19:59.572
am going to trigger a new instance here with that

00:19:59.572 --> 00:20:00.212
same link.

00:20:01.252 --> 00:20:02.292
Now let's see if,

00:20:02.532 --> 00:20:03.042
if the

00:20:03.042 --> 00:20:05.532
output is any different I expect it to still say

00:20:05.532 --> 00:20:05.852
that,

00:20:05.962 --> 00:20:07.082
the product is unavailable,

00:20:07.082 --> 00:20:08.282
but maybe it gives a better,

00:20:08.282 --> 00:20:08.682
more,

00:20:09.442 --> 00:20:11.762
clear explanation as to why it tagged it as

00:20:11.762 --> 00:20:12.289
unavailable.

00:20:12.289 --> 00:20:12.604
All right,

00:20:12.604 --> 00:20:14.604
so it looks like the workflow is running.

00:20:15.294 --> 00:20:17.534
right now it is collecting the webpage,

00:20:17.534 --> 00:20:18.594
so it's scraping that web page.

00:20:18.869 --> 00:20:19.949
So now that this is finished,

00:20:19.949 --> 00:20:21.989
we can go ahead and take a look at that output.

00:20:21.989 --> 00:20:24.709
And what I see here is the status is unknown

00:20:25.029 --> 00:20:27.789
and it says the webpage content does not contain

00:20:27.789 --> 00:20:29.509
any information about the product's availability.

00:20:29.589 --> 00:20:32.669
It appears to be a general AliExpress page.

00:20:32.669 --> 00:20:33.029
So,

00:20:33.199 --> 00:20:34.969
a few different reasons why I think it might not

00:20:34.969 --> 00:20:35.649
have picked up

00:20:35.919 --> 00:20:38.119
the content this time would be one,

00:20:38.119 --> 00:20:38.359
like,

00:20:38.359 --> 00:20:41.199
the status that AliExpress gave back would be like

00:20:41.719 --> 00:20:42.359
kind of a general,

00:20:42.439 --> 00:20:42.839
like,

00:20:43.129 --> 00:20:45.129
rate limited page or 401 or something.

00:20:45.129 --> 00:20:47.049
Just what you're going to notice if you're like

00:20:47.049 --> 00:20:47.809
web scraping.

00:20:49.089 --> 00:20:49.489
You know,

00:20:49.489 --> 00:20:52.129
these providers very well might block those

00:20:52.129 --> 00:20:53.889
requests because they don't want bots doing this

00:20:53.889 --> 00:20:54.369
typically.

00:20:54.939 --> 00:20:55.339
and,

00:20:56.609 --> 00:20:57.409
so if we look here,

00:20:57.409 --> 00:20:57.969
we're going to see,

00:20:57.969 --> 00:20:58.289
okay,

00:20:58.289 --> 00:20:59.649
so the status was actually 200.

00:20:59.809 --> 00:21:02.409
So at this point in time it's very clear on the

00:21:02.409 --> 00:21:04.089
webpage that it says like the product is

00:21:04.089 --> 00:21:04.769
unavailable.

00:21:05.319 --> 00:21:05.599
now,

00:21:05.599 --> 00:21:07.599
right now we don't really have any visibility into

00:21:07.599 --> 00:21:09.679
what the body looks like just because it gets

00:21:09.679 --> 00:21:10.279
truncated,

00:21:10.819 --> 00:21:12.339
in the output viewing here.

00:21:12.579 --> 00:21:13.979
So what we're going to do is we're going to create

00:21:13.979 --> 00:21:15.939
a subsequent step that's going to save

00:21:16.659 --> 00:21:16.979
one,

00:21:16.979 --> 00:21:19.219
the output of this model and then two,

00:21:19.219 --> 00:21:21.699
we're also going to be dumping this data into R2.

00:21:21.859 --> 00:21:23.859
So we're going to take all the HTML data and the

00:21:23.859 --> 00:21:25.379
body data and we're going to stick it in there.

00:21:25.539 --> 00:21:26.189
Just so,

00:21:26.359 --> 00:21:27.319
if we needed to,

00:21:27.319 --> 00:21:28.879
we could build further like,

00:21:28.879 --> 00:21:31.079
data services on top of the data that gets stuffed

00:21:31.079 --> 00:21:32.039
in R2 to like,

00:21:32.039 --> 00:21:32.759
evaluate,

00:21:32.759 --> 00:21:34.159
make sure everything's working as expected.

00:21:34.159 --> 00:21:35.919
And then also for debugging use cases,

00:21:35.919 --> 00:21:36.639
we can see like,

00:21:36.639 --> 00:21:37.039
okay,

00:21:37.039 --> 00:21:38.919
is our browser rendering actually pulling all the

00:21:38.919 --> 00:21:39.639
data that it needs?

00:21:39.639 --> 00:21:39.839
Or,

00:21:39.839 --> 00:21:39.999
like,

00:21:39.999 --> 00:21:41.289
are we actually not rendering

00:21:41.639 --> 00:21:42.999
the text on a web page as expected?

00:21:43.159 --> 00:21:44.799
So let's go ahead and get into like,

00:21:44.799 --> 00:21:46.239
the next few steps of this workflow.

00:21:46.239 --> 00:21:47.439
And this is kind of why workflows are really

00:21:47.439 --> 00:21:47.829
powerful.

00:21:47.829 --> 00:21:49.559
you can build a sequence of things that kind of

00:21:49.559 --> 00:21:51.698
like unlock capabilities for a SaaS production.



---



---

## Transcript not available##

---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.039 --> 00:00:00.279
All right,

00:00:00.279 --> 00:00:02.839
so now that we successfully have created this step

00:00:02.839 --> 00:00:05.999
that saves the output of our AI model into our

00:00:05.999 --> 00:00:06.919
database table,

00:00:07.159 --> 00:00:09.119
we're also going to want to create a step that

00:00:09.119 --> 00:00:11.239
takes the entire output from

00:00:11.559 --> 00:00:13.279
the collect destination info,

00:00:13.279 --> 00:00:15.239
which is using browser rendering to scrape the

00:00:15.239 --> 00:00:16.039
content of a website.

00:00:16.199 --> 00:00:17.919
And we're going to want to stick it into object

00:00:17.919 --> 00:00:18.519
storage.

00:00:18.519 --> 00:00:20.039
So that's the last step here.

00:00:20.119 --> 00:00:20.479
Now,

00:00:20.479 --> 00:00:22.319
if you're not familiar with Object storage,

00:00:22.319 --> 00:00:23.087
our R2,

00:00:23.191 --> 00:00:23.659
S3,

00:00:23.889 --> 00:00:24.569
that's okay.

00:00:24.569 --> 00:00:25.529
I know a lot of like,

00:00:25.529 --> 00:00:26.849
people that are newer to web development.

00:00:26.849 --> 00:00:27.969
They don't really understand,

00:00:28.129 --> 00:00:28.529
you know,

00:00:28.529 --> 00:00:31.809
why when you should use object storage over your

00:00:31.809 --> 00:00:32.049
like,

00:00:32.049 --> 00:00:33.169
traditional database.

00:00:33.169 --> 00:00:33.569
Now,

00:00:33.739 --> 00:00:35.829
the way that I like to kind of conceptualize it is

00:00:36.069 --> 00:00:38.709
you typically want to use your database to store

00:00:38.869 --> 00:00:39.269
information

00:00:39.749 --> 00:00:41.589
that's kind of related to like the CRUD operations

00:00:41.589 --> 00:00:42.389
of your application.

00:00:42.389 --> 00:00:43.989
So some basic user information,

00:00:44.639 --> 00:00:46.369
attributes about things that they've done on a

00:00:46.369 --> 00:00:46.649
website,

00:00:47.039 --> 00:00:47.689
IDs.

00:00:47.689 --> 00:00:47.939
The,

00:00:48.009 --> 00:00:48.129
like,

00:00:48.129 --> 00:00:48.809
what we're doing here,

00:00:48.809 --> 00:00:51.209
we're kind of like storing like an ID and a time

00:00:51.209 --> 00:00:53.969
that an evaluation took place so we could create,

00:00:53.969 --> 00:00:54.409
you know,

00:00:54.409 --> 00:00:54.729
really,

00:00:54.809 --> 00:00:57.449
really rich features in our ui,

00:00:57.669 --> 00:00:59.389
that use information in this database.

00:00:59.389 --> 00:00:59.749
Now,

00:00:59.909 --> 00:01:01.789
databases can become much,

00:01:01.789 --> 00:01:04.589
much more expensive to maintain if you stuff very

00:01:04.589 --> 00:01:06.389
large amounts of data inside of them.

00:01:06.469 --> 00:01:06.869
And

00:01:07.279 --> 00:01:07.949
in order to,

00:01:07.949 --> 00:01:08.349
for one,

00:01:08.349 --> 00:01:09.949
from like a cost perspective and then two,

00:01:09.949 --> 00:01:11.429
from a performance perspective,

00:01:11.429 --> 00:01:13.429
if you're going to be storing like really large

00:01:13.509 --> 00:01:13.909
files,

00:01:13.909 --> 00:01:16.149
like videos or images or large like

00:01:16.509 --> 00:01:17.549
HTML documents,

00:01:17.549 --> 00:01:19.589
you're not going to usually want to stuff it

00:01:19.589 --> 00:01:21.709
inside of your Postgres database or MySQL or

00:01:21.709 --> 00:01:22.789
SQLite database.

00:01:22.789 --> 00:01:24.309
You're typically going to want to stuff that

00:01:24.309 --> 00:01:26.509
information in object storage and then in your

00:01:26.509 --> 00:01:28.989
database kind of have an ID that references,

00:01:29.489 --> 00:01:31.349
the object that is stored inside of object

00:01:31.349 --> 00:01:31.849
Storage.

00:01:31.849 --> 00:01:32.709
that way you can like,

00:01:32.709 --> 00:01:33.149
you know,

00:01:33.149 --> 00:01:35.389
have a query that shows here's all of the files

00:01:35.389 --> 00:01:37.269
and their names and then when you click on it,

00:01:37.269 --> 00:01:38.989
it can go to object storage and it can pull that

00:01:38.989 --> 00:01:39.509
whole thing.

00:01:39.669 --> 00:01:41.149
That's going to keep costs under control.

00:01:41.149 --> 00:01:42.589
It's also going to keep the performance of your

00:01:42.589 --> 00:01:43.229
database better.

00:01:43.229 --> 00:01:45.229
And you can kind of like think about your database

00:01:45.229 --> 00:01:47.269
as indexing information that's

00:01:47.569 --> 00:01:48.529
useful for the application,

00:01:48.529 --> 00:01:49.929
but it's not like the whole picture.

00:01:50.029 --> 00:01:50.749
you want larger files,

00:01:50.749 --> 00:01:52.509
you obviously should go somewhere else for that.

00:01:52.509 --> 00:01:52.869
So,

00:01:53.108 --> 00:01:55.422
Cloudflare has an offering called R2,

00:01:55.662 --> 00:01:58.622
which is their S3 compatible object storage.

00:01:58.622 --> 00:01:59.662
Now if you don't know S3,

00:01:59.742 --> 00:02:03.182
S3 is a product that is created by AWS

00:02:03.502 --> 00:02:05.542
and they've kind of like created a standard for

00:02:05.542 --> 00:02:07.702
how files can be stored in object storage.

00:02:07.702 --> 00:02:09.382
And you store them inside of these things called

00:02:09.382 --> 00:02:09.822
buckets.

00:02:09.982 --> 00:02:11.822
And inside of a bucket you can have a whole bunch

00:02:11.822 --> 00:02:12.982
of folders with subfolders.

00:02:12.982 --> 00:02:13.702
With subfolders.

00:02:13.702 --> 00:02:14.782
And then it has a file

00:02:15.162 --> 00:02:16.442
and it kind of gives you like,

00:02:16.522 --> 00:02:16.962
you know,

00:02:16.962 --> 00:02:18.562
flexible ways of saying oh,

00:02:18.562 --> 00:02:19.802
I want to find every

00:02:20.522 --> 00:02:23.162
file or every file that's in a folder that starts

00:02:23.162 --> 00:02:24.202
with like a specific value.

00:02:24.522 --> 00:02:26.442
And you can do that but you can't write really,

00:02:26.442 --> 00:02:28.562
really robust queries of like you know,

00:02:28.562 --> 00:02:29.722
scan all these files,

00:02:29.722 --> 00:02:30.602
join by this

00:02:30.792 --> 00:02:31.442
group by this.

00:02:31.442 --> 00:02:32.562
Like you're not going to have that much

00:02:32.562 --> 00:02:33.082
flexibility.

00:02:33.292 --> 00:02:34.242
so typically what you're,

00:02:34.242 --> 00:02:35.522
the access pattern that you're going to want,

00:02:35.522 --> 00:02:37.482
going to want that's Most performant with S3 is

00:02:37.482 --> 00:02:38.002
either like

00:02:38.562 --> 00:02:40.002
save a file in S3,

00:02:40.642 --> 00:02:43.562
retrieve a file knowing the specific ID or the

00:02:43.562 --> 00:02:45.922
specific path of a file that's stored inside of

00:02:45.922 --> 00:02:46.802
your object storage.

00:02:46.802 --> 00:02:50.242
S3 or R2 in our use case or like deleting,

00:02:50.242 --> 00:02:50.562
you know,

00:02:50.562 --> 00:02:52.052
the exact file that you want to delete.

00:02:52.182 --> 00:02:53.662
are typically how you want to do operations.

00:02:53.662 --> 00:02:55.262
Now you can do bulk operations but

00:02:55.642 --> 00:02:57.362
best practice to kind of like have your database

00:02:57.362 --> 00:02:59.882
keep track of things and then use you know,

00:02:59.882 --> 00:03:02.042
the references that you get from your database to

00:03:02.042 --> 00:03:04.682
go like update or pull or delete specific files.

00:03:04.682 --> 00:03:04.880
So

00:03:04.880 --> 00:03:05.841
you know this is S3.

00:03:05.841 --> 00:03:06.241
and

00:03:06.256 --> 00:03:07.253
Cloudflare has

00:03:07.293 --> 00:03:07.533
this,

00:03:07.533 --> 00:03:09.293
this alternative which is R2.

00:03:09.293 --> 00:03:10.653
This is their object storage.

00:03:10.653 --> 00:03:10.973
And

00:03:11.453 --> 00:03:13.453
the content of the website that you're actually

00:03:13.453 --> 00:03:14.413
viewing this course on.

00:03:14.653 --> 00:03:17.153
A lot of the information is stored inside of R2.

00:03:17.312 --> 00:03:19.673
now we can say like I think they actually have a

00:03:19.673 --> 00:03:19.953
website,

00:03:20.193 --> 00:03:20.913
R2

00:03:21.713 --> 00:03:22.993
versus S3.

00:03:23.157 --> 00:03:23.557
And

00:03:23.737 --> 00:03:24.777
Cloudflare kind of put this out.

00:03:24.777 --> 00:03:26.697
So like they kind of break down like the pricing

00:03:26.697 --> 00:03:27.417
comparisons

00:03:27.737 --> 00:03:29.417
of Cloudflare versus R2.

00:03:29.417 --> 00:03:30.297
And you can see like

00:03:31.207 --> 00:03:31.847
Cloudflare,

00:03:32.087 --> 00:03:32.567
you know,

00:03:32.567 --> 00:03:33.127
storage,

00:03:33.127 --> 00:03:34.327
they're kind of breaking it down.

00:03:35.177 --> 00:03:36.497
so they're breaking it down.

00:03:36.497 --> 00:03:37.657
I think this is the free tier.

00:03:37.657 --> 00:03:39.377
So AWS has a free tier.

00:03:39.377 --> 00:03:41.057
Cloudflare has a free tier that has like,

00:03:41.057 --> 00:03:41.937
it's more generous.

00:03:41.937 --> 00:03:44.057
So you have like more class A operations

00:03:44.377 --> 00:03:46.057
like putting information in

00:03:46.457 --> 00:03:46.857
or

00:03:47.327 --> 00:03:49.147
class B operations getting information out of

00:03:49.147 --> 00:03:49.867
object storage.

00:03:49.867 --> 00:03:51.747
So they're saying like they give you 10 million

00:03:51.747 --> 00:03:54.467
per month for free where S3 only gives you 20,000.

00:03:54.627 --> 00:03:55.667
And then data transfer.

00:03:55.667 --> 00:03:57.907
This is like the big thing about R2 for data

00:03:57.907 --> 00:03:58.307
transfer.

00:03:58.307 --> 00:03:58.987
They don't bill you.

00:03:58.987 --> 00:03:59.787
Which is crazy.

00:03:59.787 --> 00:04:00.627
It really is crazy.

00:04:00.627 --> 00:04:02.047
That they don't bill you where like

00:04:02.397 --> 00:04:04.037
Amazon basically for data transfer,

00:04:04.037 --> 00:04:05.757
they're going to like have the amount of data

00:04:05.757 --> 00:04:06.317
that's transferred,

00:04:06.317 --> 00:04:07.317
they're going to charge for that.

00:04:07.317 --> 00:04:09.797
Now the pricing after the free tier you can do

00:04:09.797 --> 00:04:10.397
this comparison.

00:04:10.397 --> 00:04:12.037
And this is kind of the main thing like what

00:04:12.037 --> 00:04:13.877
everybody loves about Cloudflare is egress is

00:04:13.877 --> 00:04:14.037
free,

00:04:14.037 --> 00:04:15.037
which is kind of crazy.

00:04:15.117 --> 00:04:15.917
Whereas like they're,

00:04:15.917 --> 00:04:16.677
they're charging not,

00:04:16.677 --> 00:04:18.317
they're charging 0.09 for

00:04:18.547 --> 00:04:19.587
per gigabyte.

00:04:19.587 --> 00:04:21.667
So it can get really expensive if you're moving

00:04:21.747 --> 00:04:23.787
tons of data in and out of your object storage.

00:04:23.787 --> 00:04:26.987
But pricing wise Cloudflare does beat S3 which is

00:04:26.987 --> 00:04:27.347
awesome

00:04:27.727 --> 00:04:28.447
because you know,

00:04:28.687 --> 00:04:29.407
AWS,

00:04:30.107 --> 00:04:31.947
S3 kind of pioneered this space.

00:04:31.947 --> 00:04:33.947
But Cloudflare is able to create a compatible

00:04:33.947 --> 00:04:35.387
product that beats them in pricing.

00:04:35.387 --> 00:04:37.744
Now this product does require a credit card

00:04:37.744 --> 00:04:38.738
but as you can see here,

00:04:38.738 --> 00:04:39.498
you get 10

00:04:40.068 --> 00:04:41.108
10 gigabytes for free.

00:04:41.108 --> 00:04:42.828
So you're probably not ever going to be billed

00:04:42.828 --> 00:04:43.908
specifically for this project.

00:04:43.908 --> 00:04:46.508
But if you have like heavier workloads that you're

00:04:46.508 --> 00:04:46.788
using,

00:04:46.948 --> 00:04:47.428
you know,

00:04:47.428 --> 00:04:48.548
after this free tier,

00:04:48.548 --> 00:04:50.108
usage based billing does kick in.

00:04:50.108 --> 00:04:51.748
So you have 10 gigabytes free,

00:04:51.888 --> 00:04:53.308
100 or 1 million

00:04:53.788 --> 00:04:54.668
class A operation.

00:04:54.668 --> 00:04:55.708
So put operations

00:04:56.028 --> 00:04:57.488
and then they charge like per

00:04:57.828 --> 00:04:59.588
additional million operations and then class B

00:04:59.588 --> 00:05:00.148
operations,

00:05:00.588 --> 00:05:02.088
for which is reading files,

00:05:02.608 --> 00:05:05.348
after the first 10 million 36 cents per additional

00:05:05.348 --> 00:05:06.188
million requests.

00:05:06.188 --> 00:05:08.028
So I'm going to go ahead and put in my credit card

00:05:08.028 --> 00:05:09.348
information into here and then

00:05:09.408 --> 00:05:11.590
we'll sync back after I do that.

00:05:11.644 --> 00:05:13.724
So after you put in your credit card information

00:05:13.724 --> 00:05:15.724
or just basically say you want your account to

00:05:15.724 --> 00:05:16.764
have access to R2,

00:05:16.924 --> 00:05:18.644
you're going to be brought to a page that looks

00:05:18.644 --> 00:05:19.084
like this.

00:05:19.824 --> 00:05:21.504
and from here what we're going to do is we're

00:05:21.504 --> 00:05:22.184
going to create a bucket.

00:05:22.184 --> 00:05:23.784
And a bucket is going to contain a whole bunch of

00:05:23.784 --> 00:05:25.734
files and files inside of folders that,

00:05:25.884 --> 00:05:26.124
that

00:05:26.326 --> 00:05:26.706
we

00:05:27.026 --> 00:05:27.826
insert into,

00:05:27.906 --> 00:05:28.626
from our,

00:05:28.671 --> 00:05:31.137
from our workflow after we extract all of the

00:05:31.657 --> 00:05:34.177
data and HTML data from the browser rendering.

00:05:34.177 --> 00:05:35.817
So we're going to go ahead and say create this

00:05:35.817 --> 00:05:36.337
bucket

00:05:36.736 --> 00:05:38.817
and I'm going to call this Smart

00:05:38.995 --> 00:05:39.674
Links

00:05:40.074 --> 00:05:40.634
stage,

00:05:40.654 --> 00:05:42.514
or maybe we'll call this Smart Links

00:05:42.914 --> 00:05:44.074
Eval stage.

00:05:44.074 --> 00:05:45.674
And the reasons why I'm saying stage is because

00:05:45.674 --> 00:05:47.234
later in this course we're going to be

00:05:47.654 --> 00:05:49.174
doing a production version of this application.

00:05:49.174 --> 00:05:50.894
So you can kind of manage like two different types

00:05:50.894 --> 00:05:51.534
of deployments,

00:05:51.804 --> 00:05:53.244
and then there's some different like

00:05:54.104 --> 00:05:54.464
here.

00:05:54.464 --> 00:05:55.904
So you have automatic

00:05:55.944 --> 00:05:57.564
versus specific jurisdiction.

00:05:57.564 --> 00:05:59.204
R2 buckets can be restricted to a specific

00:05:59.204 --> 00:06:00.764
jurisdiction to meet data requirements.

00:06:00.764 --> 00:06:02.014
So like a lot of regulations,

00:06:02.544 --> 00:06:05.224
inside of Europe for GDPR you have to store data

00:06:05.464 --> 00:06:06.784
specifically where that user is.

00:06:06.784 --> 00:06:08.464
So you could go this route and you could say what

00:06:08.464 --> 00:06:09.264
region you want it in.

00:06:09.264 --> 00:06:11.544
It looks like they only do EU because of gdpr,

00:06:11.544 --> 00:06:12.504
but we're.

00:06:12.504 --> 00:06:14.184
I'm in the US so I'm really not going to worry

00:06:14.184 --> 00:06:15.024
about that at this time.

00:06:15.024 --> 00:06:17.024
And this is also just kind of like a course and

00:06:17.024 --> 00:06:18.414
this application isn't going to be used by any,

00:06:18.484 --> 00:06:18.764
anybody.

00:06:18.764 --> 00:06:19.044
But

00:06:19.454 --> 00:06:19.814
yeah,

00:06:19.814 --> 00:06:20.294
you can do that.

00:06:20.294 --> 00:06:21.534
And then they also have this

00:06:22.304 --> 00:06:23.944
they also have this feature called Infrequent

00:06:23.944 --> 00:06:24.624
Access where

00:06:25.024 --> 00:06:25.424
you

00:06:26.114 --> 00:06:28.034
it's recommended for objects that will be accessed

00:06:28.034 --> 00:06:28.754
less than once a month.

00:06:28.754 --> 00:06:29.714
And I do think that

00:06:29.804 --> 00:06:31.594
the pricing differs for this is actually cheaper

00:06:31.594 --> 00:06:33.034
if you're using Infrequent Access.

00:06:33.384 --> 00:06:34.604
but if you're using it frequently,

00:06:34.604 --> 00:06:35.844
I think the pricing is more.

00:06:35.924 --> 00:06:36.924
It's also in beta.

00:06:36.924 --> 00:06:37.924
We're not going to mess with this,

00:06:37.924 --> 00:06:40.244
but this type of workload actually might work

00:06:40.244 --> 00:06:40.644
because

00:06:41.044 --> 00:06:41.404
you know,

00:06:41.404 --> 00:06:44.084
we probably don't have to retrieve the evaluation

00:06:44.084 --> 00:06:45.524
data that we save very often.

00:06:46.034 --> 00:06:46.594
So this might,

00:06:46.594 --> 00:06:48.194
in the future when it's not in beta for this type

00:06:48.194 --> 00:06:49.634
of use case actually might be useful.

00:06:49.634 --> 00:06:51.514
But for now we're just going to be using the

00:06:51.514 --> 00:06:53.154
storage class standard and we're going to go ahead

00:06:53.154 --> 00:06:53.830
and create that bucket.

00:06:53.830 --> 00:06:55.212
Now once that bucket is created,

00:06:55.212 --> 00:06:56.012
you could use

00:06:56.212 --> 00:06:58.552
third party libraries because this is S3

00:06:58.552 --> 00:06:59.152
compatible

00:06:59.472 --> 00:06:59.872
to

00:07:00.532 --> 00:07:02.802
essentially like use those libraries to

00:07:03.122 --> 00:07:05.122
save data inside of your object storage.

00:07:05.122 --> 00:07:06.922
But we're not going to really worry about that

00:07:06.922 --> 00:07:08.762
because since we're working inside of the worker

00:07:08.762 --> 00:07:09.522
ecosystem,

00:07:09.842 --> 00:07:10.802
integrating with

00:07:11.412 --> 00:07:13.732
R2 object storage is so insanely seamless.

00:07:13.732 --> 00:07:16.012
It's actually like kind of crazy how easy it is to

00:07:16.012 --> 00:07:16.412
work with.

00:07:16.412 --> 00:07:18.172
So we're going to go ahead and create the name

00:07:18.172 --> 00:07:20.572
that we've defined for the specific bucket and

00:07:20.572 --> 00:07:22.292
we'll head back to our code base and we're going

00:07:22.292 --> 00:07:25.052
to go to our wrangler JSON C file inside of our

00:07:25.052 --> 00:07:25.652
data service.

00:07:26.052 --> 00:07:28.012
Now what I'm going to do is I'm going to say

00:07:28.012 --> 00:07:28.852
underneath

00:07:29.272 --> 00:07:29.672
the

00:07:30.152 --> 00:07:31.192
AI binding,

00:07:31.272 --> 00:07:33.232
I'm going to add another binding called R2

00:07:33.232 --> 00:07:33.752
buckets.

00:07:33.992 --> 00:07:36.392
And all we need to do is we need to give it a

00:07:36.392 --> 00:07:37.912
binding name and we'll just call this

00:07:38.162 --> 00:07:38.602
bucket.

00:07:38.602 --> 00:07:39.442
Keep it easy

00:07:40.002 --> 00:07:41.602
and then we need to specify a name.

00:07:42.722 --> 00:07:43.922
Now you could,

00:07:44.242 --> 00:07:45.282
depending on your,

00:07:45.282 --> 00:07:47.042
your workload for local development,

00:07:47.042 --> 00:07:49.522
you could enable experimental remote so,

00:07:49.772 --> 00:07:51.732
you would be able to like actually pull from that

00:07:51.732 --> 00:07:53.292
bucket while developing.

00:07:53.292 --> 00:07:54.692
But we're not going to worry about that here

00:07:54.692 --> 00:07:56.092
because this is just something we're going to kind

00:07:56.092 --> 00:07:57.042
of do after the fact.

00:07:57.402 --> 00:07:59.842
it's not going to be directly integrated into

00:07:59.842 --> 00:08:00.162
like,

00:08:00.162 --> 00:08:02.802
our application in terms of like reading files.

00:08:02.802 --> 00:08:03.162
So,

00:08:03.422 --> 00:08:04.662
this is all we have to do here.

00:08:04.662 --> 00:08:07.422
And then I'm already in the data service project,

00:08:07.662 --> 00:08:10.302
so I'm going to say pnpm run CF

00:08:11.502 --> 00:08:12.222
type gen.

00:08:12.748 --> 00:08:14.508
Now that type should be generated.

00:08:14.508 --> 00:08:16.548
What we're going to see is we have this bucket

00:08:16.548 --> 00:08:19.548
type here that is of the type R2 bucket.

00:08:19.948 --> 00:08:22.864
And if we head back over to our workflow,

00:08:22.864 --> 00:08:24.536
we're going to create one last step here.

00:08:24.536 --> 00:08:26.776
And this last step is going to be saving the

00:08:26.776 --> 00:08:27.856
information into R2.

00:08:27.856 --> 00:08:29.536
So we're going to create a step that's called I'm

00:08:29.536 --> 00:08:30.476
going to delete this log.

00:08:30.476 --> 00:08:31.916
We actually don't really need it anymore.

00:08:32.576 --> 00:08:35.496
this is going to be called Backup destination HTML

00:08:35.496 --> 00:08:36.176
in R2.

00:08:37.778 --> 00:08:40.915
And what we're going to do here is we are going to

00:08:41.475 --> 00:08:41.875
say,

00:08:42.625 --> 00:08:44.135
we're going to store everything based upon the

00:08:44.135 --> 00:08:44.735
account id.

00:08:44.975 --> 00:08:46.295
So everything will be segmented,

00:08:46.295 --> 00:08:48.055
kind of grouped inside of a folder based on an

00:08:48.055 --> 00:08:48.655
account id.

00:08:48.975 --> 00:08:51.775
We get that account ID from our payload of this

00:08:51.775 --> 00:08:52.415
workflow.

00:08:53.385 --> 00:08:56.025
Then we are going to basically specify a path.

00:08:56.185 --> 00:08:57.945
So this is going to be a path,

00:08:58.065 --> 00:09:00.305
inside of our bucket that our

00:09:00.625 --> 00:09:01.745
file is going to live.

00:09:01.985 --> 00:09:03.665
And what we're able to do here is I'm just going

00:09:03.665 --> 00:09:05.185
to basically say R2 path is going to be

00:09:05.185 --> 00:09:06.065
evaluations.

00:09:06.065 --> 00:09:07.545
So we're creating like a folder called

00:09:07.545 --> 00:09:08.385
evaluations,

00:09:08.464 --> 00:09:10.345
and then we're creating a folder inside of that

00:09:10.345 --> 00:09:11.345
with the account id.

00:09:11.585 --> 00:09:13.745
And then we're creating a specific,

00:09:13.845 --> 00:09:14.125
another.

00:09:14.205 --> 00:09:15.805
We're creating another folder,

00:09:16.395 --> 00:09:17.195
or a file,

00:09:18.305 --> 00:09:18.545
that

00:09:18.945 --> 00:09:20.585
says evaluation ID.

00:09:20.585 --> 00:09:23.545
Now we could say like.HTML if we wanted to,

00:09:23.545 --> 00:09:25.625
but I don't typically like to give it those

00:09:25.625 --> 00:09:25.985
because,

00:09:27.105 --> 00:09:28.505
it just isn't really necessary,

00:09:28.505 --> 00:09:29.385
depending on your use case.

00:09:29.385 --> 00:09:31.265
But so we're basically just going to be dumping it

00:09:31.265 --> 00:09:33.905
inside of a file called Evaluation id.

00:09:34.065 --> 00:09:34.465
Now

00:09:34.785 --> 00:09:36.065
where do we get this id?

00:09:36.225 --> 00:09:38.385
We got it from this step right here,

00:09:38.465 --> 00:09:40.705
which saved the information into the database.

00:09:41.025 --> 00:09:41.745
This query

00:09:42.235 --> 00:09:43.275
created a random id,

00:09:43.915 --> 00:09:44.395
saved,

00:09:44.635 --> 00:09:46.475
inserted that information into our table,

00:09:46.475 --> 00:09:48.355
and then return that ID that was randomly

00:09:48.355 --> 00:09:48.875
generated.

00:09:49.035 --> 00:09:51.075
So essentially what we're going to be able to do,

00:09:51.075 --> 00:09:52.955
because this ID and this ID are going to be the

00:09:52.955 --> 00:09:53.155
same,

00:09:53.155 --> 00:09:55.395
it's going to be very easy for us to have like a

00:09:55.395 --> 00:09:58.075
SQL query that gives us all of our IDs,

00:09:58.115 --> 00:09:58.995
for our evaluations.

00:09:58.995 --> 00:10:01.675
And then we can go fetch those specific evaluation

00:10:01.675 --> 00:10:04.155
like HTML files based upon

00:10:04.345 --> 00:10:07.055
based upon the information that is saved into R2.

00:10:07.055 --> 00:10:07.415
Now

00:10:07.925 --> 00:10:11.765
we could like further just say HTML here and then

00:10:11.765 --> 00:10:13.222
I'll call this like r2path

00:10:13.438 --> 00:10:14.318
HTML.

00:10:14.318 --> 00:10:16.238
And then we could basically say like

00:10:17.418 --> 00:10:17.658
body,

00:10:19.338 --> 00:10:20.298
body text.

00:10:20.298 --> 00:10:21.338
And then this could be

00:10:22.138 --> 00:10:22.537
body,

00:10:23.952 --> 00:10:25.432
text actually might do this.

00:10:25.432 --> 00:10:27.672
This is going to be a little bit easier for us to

00:10:27.672 --> 00:10:28.832
kind of parse and read through.

00:10:29.212 --> 00:10:30.652
and then all we have to do.

00:10:30.652 --> 00:10:32.172
And this is kind of like the craziness of

00:10:32.612 --> 00:10:33.852
R2 to save data.

00:10:33.852 --> 00:10:36.452
You just say await this EMV.

00:10:36.852 --> 00:10:39.532
Now we have bucket and we're going to put the

00:10:39.532 --> 00:10:39.812
information

00:10:40.292 --> 00:10:42.132
at our R2 path,

00:10:42.462 --> 00:10:43.392
HTML path.

00:10:43.392 --> 00:10:45.272
So this is the path that is going to live at.

00:10:45.352 --> 00:10:47.991
And then we're going to say our collected data

00:10:47.991 --> 00:10:48.392
here

00:10:48.792 --> 00:10:50.672
is going to be the HTML.

00:10:50.672 --> 00:10:52.552
So this is just uploading that string

00:10:52.632 --> 00:10:53.512
representation

00:10:53.892 --> 00:10:55.572
of that HTML file.

00:10:55.892 --> 00:10:57.492
And then we're going to do a similar thing here,

00:10:57.492 --> 00:10:57.812
this

00:10:58.452 --> 00:10:59.012
bucket

00:10:59.522 --> 00:11:00.082
dot put.

00:11:00.322 --> 00:11:02.642
And then what we can do is we can say R2

00:11:03.362 --> 00:11:04.162
body text.

00:11:04.206 --> 00:11:07.038
And then we're going to be passing in the collect

00:11:07.038 --> 00:11:08.838
data dot body text.

00:11:09.718 --> 00:11:11.638
Now we're going to go ahead and deploy this again.

00:11:14.518 --> 00:11:17.838
And while this is deploying I am going to head

00:11:17.838 --> 00:11:19.318
back over to our

00:11:19.958 --> 00:11:20.807
workflows.

00:11:20.807 --> 00:11:20.985
So

00:11:21.175 --> 00:11:22.135
I'll do it in here.

00:11:22.135 --> 00:11:22.413
So

00:11:22.413 --> 00:11:23.468
go to workflows.

00:11:23.468 --> 00:11:25.457
I'm going to open up this specific workflow

00:11:26.097 --> 00:11:29.017
and I'm just going to copy the input that was the

00:11:29.017 --> 00:11:30.149
parameters that were passed in.

00:11:30.149 --> 00:11:31.445
It looks like this deployed.

00:11:32.045 --> 00:11:33.565
we can now see that

00:11:33.885 --> 00:11:36.605
we should be able to see that it has access to

00:11:36.925 --> 00:11:37.605
our bucket.

00:11:37.605 --> 00:11:37.845
Yep,

00:11:37.845 --> 00:11:39.165
it has access to a bucket here.

00:11:40.365 --> 00:11:41.805
And I'm going to trigger a new one,

00:11:41.965 --> 00:11:42.924
a new workflow

00:11:42.924 --> 00:11:44.332
and it's going to trigger that instance.

00:11:44.412 --> 00:11:47.372
Now this is going to run and we should see this

00:11:47.372 --> 00:11:48.852
information flow into our database.

00:11:48.852 --> 00:11:50.712
So when this is done we should see a

00:11:50.932 --> 00:11:52.673
second entry into this table

00:11:52.673 --> 00:11:55.642
and we should also see a file be populated inside

00:11:55.642 --> 00:11:56.322
of our

00:11:56.572 --> 00:11:58.172
R2 object storage bucket.

00:11:58.172 --> 00:11:59.292
Smart links eval.

00:11:59.452 --> 00:11:59.684
So

00:11:59.684 --> 00:12:01.688
let's just give this a second to finish running

00:12:01.688 --> 00:12:02.778
and then we will

00:12:02.868 --> 00:12:06.486
check back the database and the R2UM storage.

00:12:06.486 --> 00:12:06.772
All right,

00:12:06.772 --> 00:12:07.692
so this completed.

00:12:07.822 --> 00:12:10.152
so we can see that our AI basically said the

00:12:10.152 --> 00:12:11.152
status is unknown.

00:12:11.942 --> 00:12:12.182
We

00:12:12.502 --> 00:12:14.982
should have a second record inside of our table

00:12:14.982 --> 00:12:15.222
here.

00:12:15.222 --> 00:12:15.582
Yep.

00:12:15.582 --> 00:12:16.902
So we have a second record into here.

00:12:17.062 --> 00:12:18.742
Now if we head over to our

00:12:19.402 --> 00:12:20.442
R2 bucket,

00:12:20.602 --> 00:12:22.962
we'll refresh this and we should see now we have

00:12:22.962 --> 00:12:24.962
evaluations inside evaluations.

00:12:24.962 --> 00:12:26.151
We have this test account ID

00:12:26.151 --> 00:12:27.849
and then we have a,

00:12:28.469 --> 00:12:29.149
HTML.

00:12:29.149 --> 00:12:30.364
So this is the raw HTML.

00:12:30.500 --> 00:12:32.100
And then we also have,

00:12:32.100 --> 00:12:33.060
if we go back,

00:12:33.777 --> 00:12:35.497
we should go over to the body.

00:12:35.497 --> 00:12:36.937
I just want to look at the body text.

00:12:36.937 --> 00:12:38.977
So this will be the body text file.

00:12:39.697 --> 00:12:41.697
And I'm going to go ahead and download that.

00:12:41.706 --> 00:12:43.816
We can open that text file and now what we can

00:12:43.816 --> 00:12:44.096
see.

00:12:44.096 --> 00:12:46.296
So this is the information that's being extracted.

00:12:46.296 --> 00:12:49.216
So it actually does look like the browser

00:12:49.216 --> 00:12:51.936
rendering isn't pulling the entire information

00:12:52.176 --> 00:12:52.576
from,

00:12:53.096 --> 00:12:54.016
from AliExpress.

00:12:54.016 --> 00:12:56.176
And what I think's happening is I think AliExpress

00:12:56.176 --> 00:12:58.076
is like recognizing that this is a bottom

00:12:58.466 --> 00:12:59.746
and they're just limiting that information.

00:13:00.626 --> 00:13:02.626
so it's just not useful for us.

00:13:02.626 --> 00:13:02.986
So like,

00:13:02.986 --> 00:13:04.506
this is going to be kind of an issue with browser

00:13:04.506 --> 00:13:05.306
rendering just because,

00:13:05.306 --> 00:13:05.666
like,

00:13:05.906 --> 00:13:06.466
you know,

00:13:06.626 --> 00:13:08.666
websites don't want a whole bunch of bots scraping

00:13:08.666 --> 00:13:08.946
them.

00:13:08.976 --> 00:13:10.846
it's going to kind of be like a constant fight of

00:13:10.846 --> 00:13:13.806
trying to figure out how to best like scrape

00:13:13.806 --> 00:13:16.166
websites and detect if you're being blocked or

00:13:16.166 --> 00:13:16.406
not.

00:13:16.406 --> 00:13:17.766
And there might have been stuff in like the

00:13:17.766 --> 00:13:18.606
response from,

00:13:18.766 --> 00:13:20.926
from AliExpress indicating that,

00:13:21.166 --> 00:13:21.606
you know,

00:13:21.606 --> 00:13:22.326
we're being blocked.

00:13:22.326 --> 00:13:23.926
But what this has done is it's just basically

00:13:23.926 --> 00:13:24.286
said,

00:13:24.446 --> 00:13:24.806
you know,

00:13:24.806 --> 00:13:26.046
we don't have all that information.

00:13:26.046 --> 00:13:27.326
And just to double check,

00:13:27.726 --> 00:13:28.606
let's head over

00:13:29.066 --> 00:13:29.136
to,

00:13:29.230 --> 00:13:30.482
let's head over to the HTML

00:13:30.482 --> 00:13:32.251
and I'm just going to download this guy as well.

00:13:33.218 --> 00:13:33.658
Yeah,

00:13:33.658 --> 00:13:34.578
so this is actually,

00:13:34.578 --> 00:13:36.538
this has a lot of information in here.

00:13:36.538 --> 00:13:37.538
I wonder if,

00:13:37.583 --> 00:13:39.019
I wonder if we have.

00:13:39.179 --> 00:13:41.899
So we should see some text like this.

00:13:41.899 --> 00:13:43.886
I would expect that text to be into here.

00:13:46.086 --> 00:13:46.326
Yeah,

00:13:46.326 --> 00:13:47.366
it looks like it's not in there.

00:13:47.366 --> 00:13:47.966
So I do think,

00:13:47.966 --> 00:13:49.646
like if we were to render this page,

00:13:49.646 --> 00:13:50.006
which

00:13:50.406 --> 00:13:51.846
probably can actually do.

00:13:51.926 --> 00:13:53.926
So I'm just going to create like a test file,

00:13:54.566 --> 00:13:56.566
t.HTML,

00:13:56.966 --> 00:13:57.898
put that in there.

00:13:58.304 --> 00:13:58.944
and then

00:13:59.584 --> 00:14:00.809
I'm going to copy the path,

00:14:00.809 --> 00:14:01.887
head over to the browser.

00:14:02.084 --> 00:14:03.444
that's not rendering as I expected,

00:14:03.684 --> 00:14:05.484
but it does look like it's not pulling all that

00:14:05.484 --> 00:14:05.764
information.

00:14:05.764 --> 00:14:07.564
And so we might be able to tweak the browser

00:14:07.564 --> 00:14:08.204
rendering a little bit.

00:14:08.204 --> 00:14:08.644
And I would,

00:14:08.644 --> 00:14:10.524
I would like encourage you to go into Puppeteer

00:14:10.524 --> 00:14:11.364
and see all the features.

00:14:11.364 --> 00:14:12.964
Maybe there's something else that we can wait for

00:14:12.964 --> 00:14:15.364
to like ensure all of the text document has

00:14:15.364 --> 00:14:16.164
rendered as well.

00:14:16.484 --> 00:14:16.883
But,

00:14:17.204 --> 00:14:18.404
just to kind of recap here,

00:14:18.963 --> 00:14:21.255
we have this workflow with multiple steps.

00:14:22.015 --> 00:14:24.415
we're scraping data from browser rendering.

00:14:24.415 --> 00:14:27.015
We're evaluating the content of a web page through

00:14:27.015 --> 00:14:27.495
AI,

00:14:27.575 --> 00:14:29.775
we are saving some information into our database

00:14:29.775 --> 00:14:31.715
and then finally we are sending this information

00:14:31.795 --> 00:14:32.835
into R2.

00:14:32.995 --> 00:14:33.395
So,

00:14:33.935 --> 00:14:36.735
we've kind of gone through like an entire workflow

00:14:36.735 --> 00:14:37.935
with multiple steps.

00:14:37.935 --> 00:14:40.175
And we have gone through this process of,

00:14:40.855 --> 00:14:41.215
actually,

00:14:41.935 --> 00:14:42.455
you know,

00:14:42.455 --> 00:14:43.015
being able to,

00:14:43.015 --> 00:14:43.175
like,

00:14:43.175 --> 00:14:45.255
run these manually inside of the cloudflare ui and

00:14:45.255 --> 00:14:47.575
you can evaluate each step here and you can kind

00:14:47.575 --> 00:14:48.495
of monitor that way.

00:14:48.495 --> 00:14:48.815
But

00:14:49.215 --> 00:14:51.735
that isn't totally useful for us just because

00:14:51.735 --> 00:14:52.375
you're not going to,

00:14:52.375 --> 00:14:52.575
like,

00:14:52.575 --> 00:14:52.935
you know,

00:14:52.935 --> 00:14:54.655
build a product where you're manually running

00:14:54.655 --> 00:14:55.855
these things inside of the ui.

00:14:55.855 --> 00:14:57.935
You're going to want to programmatically run these

00:14:57.935 --> 00:14:58.895
evaluations.

00:14:58.975 --> 00:14:59.375
So,

00:14:59.815 --> 00:15:01.215
what we're going to be doing is we're going to

00:15:01.215 --> 00:15:03.855
basically be using durable objects to schedule out

00:15:03.855 --> 00:15:05.175
these workflows to run,

00:15:05.415 --> 00:15:07.375
and then from there we can determine what type of

00:15:07.375 --> 00:15:09.255
business logic we want to say.

00:15:09.255 --> 00:15:09.495
Like,

00:15:09.495 --> 00:15:11.255
when something happens on our platform,

00:15:11.655 --> 00:15:12.055
what

00:15:12.375 --> 00:15:14.575
encourages or what basically dictates the running

00:15:14.575 --> 00:15:15.255
of these workflows?

00:15:15.255 --> 00:15:15.455
You know,

00:15:15.455 --> 00:15:17.135
maybe the user is going to be a paid user,

00:15:17.135 --> 00:15:17.975
then this will run.

00:15:18.295 --> 00:15:19.615
Maybe it runs for every link,

00:15:19.615 --> 00:15:20.535
which we probably wouldn't want.

00:15:20.535 --> 00:15:21.295
Every link click,

00:15:21.295 --> 00:15:22.575
which we wouldn't want to do because that'd be

00:15:22.575 --> 00:15:23.015
really expensive.

00:15:23.015 --> 00:15:23.695
So maybe we'd say,

00:15:23.695 --> 00:15:23.935
like,

00:15:23.935 --> 00:15:25.095
if a link is clicked,

00:15:25.775 --> 00:15:26.735
we will run

00:15:27.455 --> 00:15:30.015
once every week or once every day or once every

00:15:30.015 --> 00:15:30.215
month.

00:15:30.215 --> 00:15:30.535
You know,

00:15:30.535 --> 00:15:30.735
like,

00:15:30.735 --> 00:15:31.255
that kind of,

00:15:31.255 --> 00:15:31.415
like,

00:15:31.415 --> 00:15:33.455
logic can be programmed out inside of a durable

00:15:33.455 --> 00:15:33.895
object.

00:15:33.895 --> 00:15:35.375
So that's kind of going to be the next section of

00:15:35.375 --> 00:15:35.855
this course.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.018 --> 00:00:02.298
Now before we move into durable objects,

00:00:02.298 --> 00:00:05.018
we're going to want to wire the evaluation data

00:00:05.018 --> 00:00:07.978
that we are saving into our user application.

00:00:07.978 --> 00:00:10.018
So the UI component of our project.

00:00:10.418 --> 00:00:13.058
So let's just CD over to our user application

00:00:13.218 --> 00:00:13.898
pnpm,

00:00:13.898 --> 00:00:14.498
run dev,

00:00:14.578 --> 00:00:16.498
boot this guy up and I'll show you exactly what I

00:00:16.498 --> 00:00:16.978
mean here.

00:00:16.978 --> 00:00:18.658
So this guy gets running.

00:00:18.658 --> 00:00:20.338
Let's head over to our dashboard and what we're

00:00:20.338 --> 00:00:23.378
going to notice here is that there are kind of two

00:00:23.378 --> 00:00:25.138
sections that are utilizing the

00:00:26.108 --> 00:00:26.828
evaluation

00:00:27.618 --> 00:00:29.818
the evaluation methods that we've defined inside

00:00:29.818 --> 00:00:30.938
of our data ops.

00:00:30.938 --> 00:00:34.258
So instead of our data ops package we have this

00:00:34.258 --> 00:00:34.658
query,

00:00:34.908 --> 00:00:37.378
we have these queries for evaluations and we had

00:00:37.378 --> 00:00:39.698
this like add evaluation that is being added from

00:00:39.698 --> 00:00:40.338
our queue.

00:00:40.578 --> 00:00:42.098
But we also added a

00:00:43.148 --> 00:00:45.348
get not available evaluations and then get

00:00:45.348 --> 00:00:46.068
evaluations.

00:00:46.068 --> 00:00:47.948
This kind of just returns like the Most

00:00:47.978 --> 00:00:50.868
recent 25 evaluations and then also allows us to

00:00:51.108 --> 00:00:51.838
fill filter

00:00:52.058 --> 00:00:53.598
by like a created before date.

00:00:53.678 --> 00:00:56.718
So what we're going to want to do here is

00:00:57.278 --> 00:00:57.298
kind

00:00:57.418 --> 00:00:59.338
of identify exactly where we're going to be

00:00:59.338 --> 00:00:59.778
updating.

00:00:59.858 --> 00:01:02.058
So we have the section with problematic links

00:01:02.058 --> 00:01:03.658
right now this is just kind of hard coded stuff.

00:01:03.658 --> 00:01:06.498
And then we also have this evaluations

00:01:07.218 --> 00:01:07.258
dashboard

00:01:07.718 --> 00:01:08.638
here which,

00:01:08.638 --> 00:01:09.858
or this evaluations

00:01:09.988 --> 00:01:11.988
section in the dashboard which just is going to

00:01:11.988 --> 00:01:13.108
allow like for pagination.

00:01:13.108 --> 00:01:15.028
Every single time evaluations run they'll show up

00:01:15.028 --> 00:01:15.188
here.

00:01:15.188 --> 00:01:16.588
We can kind of like inspect them.

00:01:16.588 --> 00:01:18.868
So if we head over to our user application,

00:01:19.248 --> 00:01:20.128
inside of

00:01:20.798 --> 00:01:23.798
the worker TRPC routes we have our evaluations

00:01:23.798 --> 00:01:24.038
route.

00:01:24.038 --> 00:01:26.038
And I know it's been a while in the course since

00:01:26.038 --> 00:01:27.158
we've actually worked on the ui,

00:01:27.158 --> 00:01:29.238
but this is kind of a section where we can

00:01:29.238 --> 00:01:31.158
actually start wiring the data that the backend is

00:01:31.158 --> 00:01:32.438
generating into the ui.

00:01:32.438 --> 00:01:32.798
So

00:01:32.908 --> 00:01:34.678
right now this is just returning dummy data.

00:01:34.678 --> 00:01:36.878
So there's this problematic destinations

00:01:37.458 --> 00:01:38.738
route which is

00:01:38.828 --> 00:01:40.788
returning this dummy data that looks like this

00:01:41.648 --> 00:01:44.128
kind of an array of like the evaluation

00:01:44.128 --> 00:01:44.488
information.

00:01:44.808 --> 00:01:48.008
So what we can do is we can import both of the

00:01:48.328 --> 00:01:49.528
methods that we have

00:01:49.888 --> 00:01:51.648
or both of the queries that we've defined

00:01:51.838 --> 00:01:52.768
inside of our

00:01:53.248 --> 00:01:54.448
data ops package.

00:01:54.448 --> 00:01:55.728
So I'm just going to go ahead and do that here.

00:01:55.728 --> 00:01:56.768
I'm going to delete this

00:01:57.006 --> 00:01:57.406
and

00:01:58.916 --> 00:02:02.716
from here we can basically say let's do get not

00:02:02.716 --> 00:02:03.076
available

00:02:03.666 --> 00:02:05.256
evaluations because that's what this query does.

00:02:05.256 --> 00:02:06.456
It basically just looks for

00:02:07.026 --> 00:02:08.916
evaluations that were tagged as not available.

00:02:09.076 --> 00:02:09.476
And

00:02:10.036 --> 00:02:11.156
we can call it,

00:02:11.156 --> 00:02:12.996
it looks like it's going to take some information

00:02:13.076 --> 00:02:13.436
here.

00:02:13.436 --> 00:02:16.146
So it takes an account ID which we,

00:02:16.296 --> 00:02:18.296
we can simply get from our context.

00:02:18.536 --> 00:02:19.656
So this is the context

00:02:20.316 --> 00:02:23.516
that we're defining in trpc and we have a

00:02:23.996 --> 00:02:26.076
user info and we have a user id.

00:02:26.076 --> 00:02:28.076
Right now we're just using user ID for that

00:02:28.076 --> 00:02:28.436
filter.

00:02:28.436 --> 00:02:30.316
That's kind of what we're using as a proxy for

00:02:30.316 --> 00:02:30.956
account id.

00:02:31.676 --> 00:02:32.075
And

00:02:32.396 --> 00:02:35.516
we come over here and we should notice that in our

00:02:35.516 --> 00:02:36.236
dashboard

00:02:36.306 --> 00:02:38.782
this takes a little bit to load just because we

00:02:38.782 --> 00:02:39.472
are using the

00:02:40.482 --> 00:02:42.002
the proxy to D1.

00:02:42.002 --> 00:02:43.762
So we're using the experimental feature.

00:02:44.162 --> 00:02:46.882
I do expect it to load a bit faster than this

00:02:46.882 --> 00:02:47.090
though.

00:02:47.627 --> 00:02:49.587
So this actually wasn't loading because I wasn't

00:02:49.587 --> 00:02:50.867
logged into my Cloudflare account.

00:02:50.867 --> 00:02:53.187
But now that I logged in we can see that this

00:02:53.187 --> 00:02:53.947
loads and

00:02:54.347 --> 00:02:56.347
we don't have any problematic links in here.

00:02:56.347 --> 00:02:59.227
That is just because our evaluations haven't

00:02:59.647 --> 00:03:01.047
tagged anything as a problematic link.

00:03:01.047 --> 00:03:04.047
So the second in evaluation runs where the product

00:03:04.047 --> 00:03:05.647
is like tagged as

00:03:05.767 --> 00:03:06.827
item not found or something.

00:03:06.827 --> 00:03:09.067
It's going to show up into here and we're also

00:03:09.067 --> 00:03:10.747
going to head over to evaluations because we have

00:03:10.747 --> 00:03:13.187
some dummy data here and we're just going to

00:03:13.187 --> 00:03:16.587
simply replace this dummy data that is right here.

00:03:16.907 --> 00:03:19.907
We're going to grab our context and it looks like

00:03:19.907 --> 00:03:21.147
this method is taking

00:03:21.877 --> 00:03:23.917
the account id so we can basically say

00:03:23.917 --> 00:03:27.267
ctx.user.user id

00:03:28.034 --> 00:03:28.434
and

00:03:28.786 --> 00:03:31.512
we will make sure we just await that method

00:03:31.512 --> 00:03:32.192
obviously.

00:03:32.314 --> 00:03:33.194
same for this one.

00:03:33.194 --> 00:03:35.354
It looks like I wasn't awaiting that as well.

00:03:35.434 --> 00:03:35.675
So.

00:03:35.675 --> 00:03:36.062
All right,

00:03:36.062 --> 00:03:37.662
so no evaluations found

00:03:37.844 --> 00:03:38.146
that.

00:03:38.360 --> 00:03:40.760
And the reason no evaluations are no,

00:03:40.910 --> 00:03:42.510
not found here is because

00:03:42.910 --> 00:03:45.270
if we head over to our Cloudflare dashboard is

00:03:45.270 --> 00:03:46.199
kind of want to like,

00:03:46.199 --> 00:03:46.378
just.

00:03:46.378 --> 00:03:48.298
So I just want to show you this just so you're not

00:03:48.298 --> 00:03:48.458
like,

00:03:48.458 --> 00:03:48.658
hey,

00:03:48.658 --> 00:03:49.698
this isn't working as expected.

00:03:49.778 --> 00:03:51.458
So basically what's happening is

00:03:51.778 --> 00:03:53.858
we have kind of hard coded a

00:03:54.098 --> 00:03:55.298
in our SQL database.

00:03:55.298 --> 00:03:57.218
We've hard coded a account ID

00:03:57.778 --> 00:04:00.058
that is not the one that is hard coded in our

00:04:00.058 --> 00:04:00.698
project right now.

00:04:00.698 --> 00:04:01.680
So this is just kind of like

00:04:01.680 --> 00:04:02.772
the things that you're going to go through during

00:04:02.772 --> 00:04:04.252
development just to kind of make things work.

00:04:04.252 --> 00:04:05.612
But we can say select

00:04:06.252 --> 00:04:07.212
star from

00:04:07.872 --> 00:04:09.311
destination evaluations

00:04:09.518 --> 00:04:12.069
and from here we can see that this is the account

00:04:12.069 --> 00:04:14.589
ID that we are using test account id.

00:04:14.853 --> 00:04:16.693
and that is not what is hard coded in our project

00:04:16.693 --> 00:04:17.453
for user id.

00:04:17.453 --> 00:04:18.773
But later we're not going to worry about this

00:04:18.773 --> 00:04:20.253
because we're going to build out auth and we're

00:04:20.253 --> 00:04:21.893
going to actually be able to pull those account

00:04:21.893 --> 00:04:23.613
IDs based upon the user.

00:04:23.613 --> 00:04:24.013
So,

00:04:24.273 --> 00:04:25.113
we reload this guy.

00:04:25.113 --> 00:04:27.200
We should see a few evaluations into here.

00:04:27.208 --> 00:04:27.448
All right.

00:04:27.448 --> 00:04:29.368
Make sure that I'm actually typing test account id

00:04:29.928 --> 00:04:32.968
now we can see that we have the test that we have.

00:04:32.968 --> 00:04:33.288
The,

00:04:34.678 --> 00:04:36.438
actual evaluations that have ran,

00:04:36.598 --> 00:04:38.038
they pull through into here.

00:04:38.118 --> 00:04:40.158
So these both have been tagged with unknown

00:04:40.158 --> 00:04:40.478
status.

00:04:40.478 --> 00:04:41.838
And as we run more evaluations,

00:04:41.838 --> 00:04:43.298
we're going to get different statuses here,

00:04:43.508 --> 00:04:45.388
to kind of prove out the concept of how this is

00:04:45.388 --> 00:04:45.668
working.

00:04:45.748 --> 00:04:46.148
So,

00:04:46.338 --> 00:04:47.138
that's pretty cool.

00:04:47.138 --> 00:04:48.138
So you can see when it ran,

00:04:48.138 --> 00:04:51.018
you can see the reason as to why the AI tagged it

00:04:51.018 --> 00:04:52.258
as unknown status.

00:04:52.958 --> 00:04:53.198
And,

00:04:53.358 --> 00:04:54.778
also you were able to have like,

00:04:54.778 --> 00:04:56.458
the URL of the actual page that was,

00:04:56.458 --> 00:04:56.898
ran.

00:04:56.898 --> 00:04:59.458
So I do expect this to tag it as like,

00:04:59.458 --> 00:05:00.298
product not found.

00:05:00.298 --> 00:05:00.818
So I think,

00:05:01.098 --> 00:05:02.638
we're going to probably dive a little bit deeper

00:05:02.638 --> 00:05:04.118
into the workflow itself.

00:05:04.118 --> 00:05:06.438
But I would also suggest you just kind of dive

00:05:06.438 --> 00:05:07.518
into Puppeteer to like,

00:05:07.518 --> 00:05:09.638
make sure the browser rendering is also,

00:05:10.178 --> 00:05:11.258
Everything is working there.

00:05:11.258 --> 00:05:12.920
But we'll kind of circle back on this

00:05:13.003 --> 00:05:13.403
now.

00:05:14.363 --> 00:05:16.683
at this point we're able to basically say,

00:05:16.683 --> 00:05:17.083
hey,

00:05:17.083 --> 00:05:18.133
for from end to end,

00:05:18.213 --> 00:05:19.893
we track link clicks,

00:05:20.053 --> 00:05:21.813
we run evaluations manually,

00:05:21.973 --> 00:05:23.333
we get that evaluation data,

00:05:23.333 --> 00:05:24.253
we save it in R2,

00:05:24.253 --> 00:05:25.773
we save it in our D1 database,

00:05:25.773 --> 00:05:27.493
and then we actually are able to wire that into

00:05:27.493 --> 00:05:28.053
our ui.

00:05:28.053 --> 00:05:30.573
So it's kind of like a holistic project that's

00:05:30.573 --> 00:05:32.813
coming together from front end to back and back to

00:05:32.813 --> 00:05:33.253
front end.

00:05:33.412 --> 00:05:33.813
So,

00:05:34.043 --> 00:05:34.773
this next section,

00:05:34.773 --> 00:05:36.013
we're actually going to start

00:05:36.333 --> 00:05:36.893
manual,

00:05:36.893 --> 00:05:38.653
or we're going to actually start building out the

00:05:38.653 --> 00:05:40.253
programmatic logic of how to

00:05:40.573 --> 00:05:42.453
determine when we're going to run evaluations

00:05:42.453 --> 00:05:44.293
using durable objects to do that in a more

00:05:44.293 --> 00:05:45.017
intelligent way.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.060 --> 00:00:00.340
All right,

00:00:00.340 --> 00:00:02.500
so one really quick update on the browser

00:00:02.500 --> 00:00:03.580
rendering side of things.

00:00:04.100 --> 00:00:04.500
I,

00:00:04.500 --> 00:00:07.500
we're continuously getting this unknown status and

00:00:07.500 --> 00:00:09.060
when you look at the HTML of the page,

00:00:09.140 --> 00:00:11.460
it's not actually pulling that full,

00:00:11.700 --> 00:00:12.179
you know,

00:00:12.179 --> 00:00:14.140
like the full web page and actually showing if

00:00:14.140 --> 00:00:15.460
it's like available or not.

00:00:15.460 --> 00:00:18.020
And I was kind of like trying to debug that

00:00:18.020 --> 00:00:18.340
process,

00:00:18.340 --> 00:00:20.060
but then I realized because you're browser

00:00:20.060 --> 00:00:21.380
rendering using Puppeteer,

00:00:21.380 --> 00:00:23.310
you can also take screenshots of,

00:00:23.540 --> 00:00:25.420
of the output of a browser render,

00:00:25.420 --> 00:00:26.460
which is actually pretty cool.

00:00:26.460 --> 00:00:28.740
So I thought to add this really quick and then you

00:00:28.740 --> 00:00:30.180
can also add this on your end if you'd like.

00:00:30.180 --> 00:00:31.300
But it's not necessary,

00:00:31.300 --> 00:00:32.500
it's not necessary for this course,

00:00:32.500 --> 00:00:34.340
but just kind of wanted to walk you through what I

00:00:34.340 --> 00:00:34.740
did here.

00:00:34.740 --> 00:00:36.660
So basically this is our

00:00:37.700 --> 00:00:39.780
this is our browser rendering logic.

00:00:39.860 --> 00:00:41.660
And before we were just like loading the page,

00:00:41.660 --> 00:00:42.500
getting idle,

00:00:42.500 --> 00:00:44.580
getting some information from the page here and

00:00:44.580 --> 00:00:45.380
then returning it,

00:00:45.540 --> 00:00:47.940
I also added these two lines of code which is

00:00:47.940 --> 00:00:49.860
basically what we're saying is we're going to take

00:00:49.860 --> 00:00:50.740
a screenshot

00:00:51.310 --> 00:00:52.030
of the,

00:00:52.180 --> 00:00:54.650
we're going to take a screenshot of the page after

00:00:54.650 --> 00:00:55.450
it's loaded.

00:00:55.930 --> 00:00:58.930
And then what I'm doing here is I'm basically like

00:00:58.930 --> 00:01:00.810
saving it as a base 64,

00:01:01.140 --> 00:01:01.730
encoding

00:01:02.130 --> 00:01:04.450
and you can just create a data URL with that

00:01:04.450 --> 00:01:05.490
base64 encoding,

00:01:05.490 --> 00:01:07.490
which is just like a very

00:01:07.810 --> 00:01:10.720
long encoded string that represents an image.

00:01:10.910 --> 00:01:12.390
it's kind of a lower level concept,

00:01:12.390 --> 00:01:13.390
but it's also pretty cool.

00:01:13.390 --> 00:01:14.910
So what I've done here is I've

00:01:15.020 --> 00:01:18.090
I'm returning the screenshot data URL and then

00:01:18.090 --> 00:01:19.383
inside of our workflow,

00:01:19.416 --> 00:01:21.316
the very last step where we're saving data into

00:01:21.316 --> 00:01:21.796
R2,

00:01:22.116 --> 00:01:24.276
before we were just taking the HTML and the body.

00:01:24.596 --> 00:01:27.156
But what I'm also doing is I'm also basically

00:01:27.156 --> 00:01:29.676
creating a path specifically for screenshots and

00:01:29.676 --> 00:01:30.956
this is going to really help debug because

00:01:30.956 --> 00:01:31.516
sometimes you know,

00:01:31.516 --> 00:01:33.916
you get like I am a robot pop up and you're not

00:01:33.916 --> 00:01:34.916
able to pass through.

00:01:35.316 --> 00:01:36.916
Most websites are doing that these days.

00:01:36.916 --> 00:01:37.736
they're kind of protected.

00:01:37.736 --> 00:01:39.696
So like a product like this would be actually

00:01:39.696 --> 00:01:39.936
very,

00:01:39.936 --> 00:01:42.056
very hard to build in production just because,

00:01:42.056 --> 00:01:42.496
you know,

00:01:42.496 --> 00:01:42.896
it's

00:01:43.466 --> 00:01:44.527
the type of scenario

00:01:44.793 --> 00:01:47.793
where most companies are now kind of like getting

00:01:47.793 --> 00:01:48.263
much better at

00:01:48.313 --> 00:01:49.553
protecting their websites from bots.

00:01:49.553 --> 00:01:51.993
And honestly in production selling a product like

00:01:51.993 --> 00:01:52.273
this,

00:01:52.433 --> 00:01:52.993
you know,

00:01:53.073 --> 00:01:54.873
I don't necessarily know the legalities around

00:01:54.873 --> 00:01:55.473
scraping

00:01:55.483 --> 00:01:56.073
websites.

00:01:56.073 --> 00:01:57.512
So there is kind of that caveat.

00:01:57.512 --> 00:02:00.153
But what we do here is we take the screenshot,

00:02:00.483 --> 00:02:01.733
that big data URL,

00:02:01.893 --> 00:02:04.733
I'm just kind of parsing out this encoding of that

00:02:04.733 --> 00:02:05.653
base 64,

00:02:05.733 --> 00:02:08.613
so technically we probably don't need to even

00:02:08.613 --> 00:02:10.373
include it in that string output.

00:02:11.443 --> 00:02:12.563
and then I am

00:02:13.123 --> 00:02:13.143
creating,

00:02:13.473 --> 00:02:16.913
a buffer from that base64 encoded version,

00:02:16.913 --> 00:02:18.353
like representation of the image.

00:02:18.513 --> 00:02:20.833
And then we're just simply uploading it to

00:02:21.473 --> 00:02:21.873
the.

00:02:21.953 --> 00:02:23.313
We're uploading it to R2.

00:02:23.313 --> 00:02:23.633
Now,

00:02:23.633 --> 00:02:24.993
from the R2 side of things,

00:02:25.153 --> 00:02:28.073
what we can do is we can go ahead and look at the

00:02:28.073 --> 00:02:28.553
output.

00:02:28.553 --> 00:02:28.953
So I,

00:02:28.953 --> 00:02:30.393
I did run this workflow one time.

00:02:30.393 --> 00:02:31.793
I'm not going to kind of waste your time and go

00:02:31.793 --> 00:02:33.473
through that process because you already know how.

00:02:33.633 --> 00:02:35.473
But if we go to the screenshots and we see the

00:02:35.473 --> 00:02:36.673
output of that screenshot,

00:02:36.753 --> 00:02:37.913
what we can see is like,

00:02:37.913 --> 00:02:39.713
it's actually throwing a network idle issue.

00:02:40.033 --> 00:02:41.853
basically I think what they're doing on their end

00:02:41.853 --> 00:02:43.673
is they're trying to det if it is a bot and then

00:02:43.673 --> 00:02:45.433
they throw this error and they want to see if

00:02:45.433 --> 00:02:45.953
you'll actually

00:02:46.273 --> 00:02:46.913
reload.

00:02:47.463 --> 00:02:49.303
so I think in the world of AI,

00:02:49.303 --> 00:02:51.303
you could probably programmatically build out

00:02:51.303 --> 00:02:52.383
workflows where like,

00:02:52.383 --> 00:02:55.423
you take the context of the page and then AI is

00:02:55.423 --> 00:02:55.583
like,

00:02:55.583 --> 00:02:55.903
oh,

00:02:55.903 --> 00:02:57.703
it looks like there's a button to try to reload.

00:02:57.703 --> 00:02:58.903
I'm going to try to reload that.

00:02:58.903 --> 00:02:59.103
So,

00:02:59.103 --> 00:02:59.263
like,

00:02:59.263 --> 00:03:01.383
this whole agentic space that we're in,

00:03:01.383 --> 00:03:02.133
there's a lot of like,

00:03:02.133 --> 00:03:03.733
feasible things that you could build to like,

00:03:03.733 --> 00:03:04.093
you know,

00:03:04.093 --> 00:03:05.093
in a very intelligent way,

00:03:05.093 --> 00:03:05.813
try to like,

00:03:06.053 --> 00:03:07.653
get the information that you want on the page.

00:03:07.653 --> 00:03:09.253
That's what a lot of these AI providers are

00:03:09.253 --> 00:03:09.813
already doing.

00:03:10.533 --> 00:03:11.133
so for now,

00:03:11.133 --> 00:03:11.453
like,

00:03:11.453 --> 00:03:11.967
just note

00:03:12.014 --> 00:03:12.364
this.

00:03:12.551 --> 00:03:14.110
the reason why we're getting the unknown status is

00:03:14.110 --> 00:03:16.910
because AliExpress is giving this error from our

00:03:16.910 --> 00:03:17.910
browser renderer.

00:03:17.990 --> 00:03:18.320
So,

00:03:18.320 --> 00:03:18.710
you might,

00:03:18.710 --> 00:03:19.870
you may or may not get this,

00:03:19.870 --> 00:03:22.070
but what is cool now is in our pipeline.

00:03:22.070 --> 00:03:24.030
We now have a way of actually taking a screenshot

00:03:24.030 --> 00:03:25.990
of that image so we can actually visually debug

00:03:25.990 --> 00:03:28.070
what is happening behind the scenes in that

00:03:28.070 --> 00:03:28.734
browser rendering.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.092 --> 00:00:02.172
One quick update for the destination evaluation

00:00:02.172 --> 00:00:02.892
workflow.

00:00:03.292 --> 00:00:03.342
This,

00:00:03.432 --> 00:00:04.752
was pointed out to me by a student.

00:00:04.752 --> 00:00:06.032
This is an error that they are facing.

00:00:06.032 --> 00:00:08.152
And I do think that this potentially could be

00:00:08.152 --> 00:00:09.392
something that you encounter as well.

00:00:09.662 --> 00:00:11.702
basically there's this error at the very first

00:00:11.702 --> 00:00:14.262
step of the workflow that says the maximum allowed

00:00:14.262 --> 00:00:15.822
size is 1 MB.

00:00:15.902 --> 00:00:16.302
Now

00:00:16.622 --> 00:00:17.622
this very first step,

00:00:17.622 --> 00:00:18.862
what it's doing is it is

00:00:19.182 --> 00:00:19.302
using,

00:00:19.302 --> 00:00:21.582
browser rendering to render a page and it's

00:00:21.582 --> 00:00:23.582
collecting the HTML and then it's returning that.

00:00:23.582 --> 00:00:23.812
And,

00:00:23.882 --> 00:00:26.242
and then basically what's happening is that HTML

00:00:26.242 --> 00:00:28.602
and some other data is being passed to this saved

00:00:28.682 --> 00:00:29.482
step state.

00:00:29.562 --> 00:00:32.402
So this variable is basically being persisted

00:00:32.402 --> 00:00:33.202
across the workflow.

00:00:33.202 --> 00:00:35.392
And then Cloudflare is storing this on their end,

00:00:35.392 --> 00:00:36.482
inside of a durable object.

00:00:36.482 --> 00:00:39.002
Now they put some limits for the size that this

00:00:39.002 --> 00:00:39.322
could be.

00:00:39.322 --> 00:00:41.522
So the size of the response here for what can be

00:00:41.522 --> 00:00:41.922
saved,

00:00:42.372 --> 00:00:43.082
there's a limit.

00:00:43.082 --> 00:00:44.042
And that limit,

00:00:44.042 --> 00:00:44.722
like we showed,

00:00:44.722 --> 00:00:45.482
is one mb.

00:00:45.642 --> 00:00:48.082
And this should in theory be plenty if it's just

00:00:48.082 --> 00:00:49.402
like an HTML page.

00:00:49.402 --> 00:00:51.562
But because I also added the,

00:00:51.692 --> 00:00:53.192
last step of basically

00:00:53.802 --> 00:00:55.562
grabbing a screenshot of the page,

00:00:55.722 --> 00:00:57.802
it is possible that you could exceed this.

00:00:57.962 --> 00:01:00.122
So I did put in a really quick fix here.

00:01:00.122 --> 00:01:02.002
So this is basically the code that you're going to

00:01:02.002 --> 00:01:02.282
see,

00:01:02.402 --> 00:01:02.992
where we

00:01:03.312 --> 00:01:04.432
grab that page data,

00:01:04.672 --> 00:01:05.792
do the AI step,

00:01:06.132 --> 00:01:08.762
save the data into the database and this returns

00:01:08.762 --> 00:01:09.762
an evaluation id.

00:01:09.922 --> 00:01:12.802
And then we back all that data back up into R2.

00:01:12.802 --> 00:01:13.142
Now,

00:01:13.142 --> 00:01:15.082
I did do a little patch here that I'll go over and

00:01:15.082 --> 00:01:16.322
I'll share this code as well.

00:01:16.322 --> 00:01:18.162
But essentially the very first step,

00:01:18.642 --> 00:01:21.722
we are going to be creating an evaluation id and

00:01:21.722 --> 00:01:24.882
then we will be running our destination URL step.

00:01:25.042 --> 00:01:27.562
And essentially this last section where we're

00:01:27.562 --> 00:01:29.202
saving this data into R2,

00:01:29.672 --> 00:01:31.242
we're doing that inside of this step.

00:01:31.242 --> 00:01:33.642
This way we don't have to return like the image

00:01:33.642 --> 00:01:34.162
and stuff,

00:01:34.752 --> 00:01:37.122
as an output here from the first step.

00:01:37.122 --> 00:01:38.242
So we're just running through,

00:01:38.562 --> 00:01:40.242
we're creating our paths.

00:01:41.202 --> 00:01:43.922
we're saving this into our R2 bucket.

00:01:44.002 --> 00:01:45.802
And then the only thing that we're returning is

00:01:45.802 --> 00:01:47.722
we're returning the text of the page.

00:01:47.722 --> 00:01:49.042
Not even the whole HTML,

00:01:49.042 --> 00:01:49.642
just the text.

00:01:49.642 --> 00:01:50.392
So that's going to be,

00:01:50.622 --> 00:01:51.062
that should be,

00:01:51.062 --> 00:01:51.302
well,

00:01:51.302 --> 00:01:51.902
well under,

00:01:52.012 --> 00:01:52.622
one and B.

00:01:52.622 --> 00:01:54.622
And if you ever come across a scenario where for

00:01:54.622 --> 00:01:56.462
some reason the text exceeds that limit,

00:01:56.462 --> 00:01:57.262
then you could also,

00:01:57.262 --> 00:01:57.742
you know,

00:01:58.702 --> 00:01:58.712
not,

00:01:58.712 --> 00:02:00.702
return it here and then you could pull it from R2

00:02:00.702 --> 00:02:00.902
later.

00:02:00.902 --> 00:02:02.542
But I don't think that's ever really going to be a

00:02:02.542 --> 00:02:03.102
valid concern.

00:02:03.262 --> 00:02:06.022
And then we are returning the evaluation ID as

00:02:06.022 --> 00:02:06.302
well.

00:02:06.542 --> 00:02:08.180
So the AI step is the same here.

00:02:08.182 --> 00:02:08.822
And then,

00:02:09.082 --> 00:02:11.722
the very last step is saving in the database.

00:02:11.722 --> 00:02:14.762
So we're basically yanking out this R2 step,

00:02:15.242 --> 00:02:16.722
putting it inside of this first step.

00:02:16.722 --> 00:02:18.322
So there is kind of a lot happening in this step

00:02:18.322 --> 00:02:18.882
of the workflow,

00:02:18.882 --> 00:02:19.642
but that's totally fine.

00:02:19.642 --> 00:02:21.482
There's really no issue with this type of design.

00:02:22.122 --> 00:02:22.762
And then,

00:02:22.822 --> 00:02:25.702
the very last step is saving the evaluation and

00:02:25.702 --> 00:02:27.382
we're creating the evaluation id.

00:02:27.382 --> 00:02:30.941
So I updated this add evaluation function we used

00:02:30.941 --> 00:02:33.022
to create the ID randomly here,

00:02:33.262 --> 00:02:35.102
insert it into our database and return it.

00:02:35.342 --> 00:02:38.062
Now that random ID is being passed in at the top

00:02:38.062 --> 00:02:39.142
level of this function.

00:02:39.142 --> 00:02:40.462
So there's the two changes here,

00:02:40.462 --> 00:02:42.302
there's the small update to this workflow,

00:02:43.272 --> 00:02:45.832
then there is the removal of that step and

00:02:45.832 --> 00:02:47.952
basically making it so we pass in this id.

00:02:47.952 --> 00:02:48.992
So I'm going to share this code.

00:02:48.992 --> 00:02:50.582
This should be a really easy fix on your end.

00:02:50.932 --> 00:02:51.692
Hope this helps.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.018 --> 00:00:00.298
Alright,

00:00:00.298 --> 00:00:02.178
so this next section of the course is where we're

00:00:02.178 --> 00:00:03.858
going to be getting into durable objects.

00:00:03.858 --> 00:00:06.738
And durable objects to a lot of developers and a

00:00:06.738 --> 00:00:08.538
lot of people that are new to the Cloudflare

00:00:08.538 --> 00:00:11.098
ecosystem are a bit confusing and kind of hard to

00:00:11.098 --> 00:00:11.778
reason about.

00:00:12.328 --> 00:00:14.488
and I do think it's kind of justified that

00:00:14.488 --> 00:00:14.968
confusion.

00:00:14.968 --> 00:00:16.048
When I first looked at it,

00:00:16.048 --> 00:00:17.768
it didn't make total sense to me.

00:00:17.768 --> 00:00:19.928
I had to dive pretty deep to get a good

00:00:19.928 --> 00:00:21.968
understanding about what durable objects are,

00:00:22.418 --> 00:00:22.978
how to use them,

00:00:22.978 --> 00:00:23.778
when to use them.

00:00:23.858 --> 00:00:26.938
And now I honestly think that they are a part of

00:00:26.938 --> 00:00:28.018
my stack that

00:00:28.338 --> 00:00:30.018
allow me to solve really,

00:00:30.018 --> 00:00:32.738
really challenging problems in a pretty simple

00:00:32.738 --> 00:00:33.018
way.

00:00:33.018 --> 00:00:34.738
And we'll kind of get into why.

00:00:34.998 --> 00:00:37.078
but in order to kind of understand why and

00:00:37.558 --> 00:00:39.158
why we're going to be using them in the course and

00:00:39.158 --> 00:00:39.798
how they work,

00:00:40.038 --> 00:00:43.158
let's go over a high level data flow of our

00:00:43.158 --> 00:00:43.958
service right now.

00:00:43.958 --> 00:00:44.358
So,

00:00:44.698 --> 00:00:46.938
if you're somebody that's kind of coming from the

00:00:47.258 --> 00:00:47.818
AI,

00:00:47.818 --> 00:00:48.818
like coding world,

00:00:48.818 --> 00:00:50.218
you kind of got into coding

00:00:50.688 --> 00:00:51.208
through AI,

00:00:51.208 --> 00:00:52.848
that's when you really started picking things up.

00:00:52.848 --> 00:00:54.608
You're probably used to just kind of like,

00:00:55.298 --> 00:00:57.778
just building on top of a web framework and never

00:00:57.778 --> 00:01:00.098
really thinking about too much about the server

00:01:00.098 --> 00:01:02.008
and dataflow and state management and stuff.

00:01:02.008 --> 00:01:03.398
or even if you're just a web,

00:01:03.398 --> 00:01:05.677
like a full stack developer that primarily focuses

00:01:05.677 --> 00:01:06.198
on the front end,

00:01:06.198 --> 00:01:08.118
the back inside might be a little bit,

00:01:08.188 --> 00:01:09.198
cumbersome to

00:01:09.420 --> 00:01:10.060
dive into,

00:01:10.140 --> 00:01:10.980
or maybe,

00:01:10.980 --> 00:01:11.420
you know,

00:01:11.420 --> 00:01:12.420
daunting to dive into.

00:01:12.420 --> 00:01:14.340
But if you just look at the data flow that we

00:01:14.340 --> 00:01:15.100
built out so far,

00:01:15.390 --> 00:01:16.510
nothing's been too complicated.

00:01:16.510 --> 00:01:18.630
It's all kind of like pretty easy to reason about.

00:01:18.630 --> 00:01:20.240
But we have a lot going on here.

00:01:20.240 --> 00:01:21.070
we have a UI

00:01:21.470 --> 00:01:21.870
that,

00:01:21.870 --> 00:01:22.270
you know,

00:01:22.270 --> 00:01:24.230
shipped to the client and then the requests are

00:01:24.230 --> 00:01:25.910
sent up to a backend that's running on a worker.

00:01:25.910 --> 00:01:28.070
And we're using TRPC to make sure things are type

00:01:28.070 --> 00:01:28.510
safe.

00:01:28.510 --> 00:01:30.470
And then TRPC right now is just literally

00:01:30.470 --> 00:01:32.420
interfacing with our database directly right here.

00:01:32.520 --> 00:01:34.160
and it's sticking some data into the database,

00:01:34.160 --> 00:01:35.960
sometimes it's pulling data from the database to

00:01:35.960 --> 00:01:37.080
render that into the UI.

00:01:37.623 --> 00:01:40.663
And then once we create our links with destination

00:01:40.743 --> 00:01:41.463
URLs,

00:01:41.733 --> 00:01:44.263
we have a HONO API that is just really simply,

00:01:44.563 --> 00:01:44.883
you know,

00:01:44.883 --> 00:01:46.403
taking that link id,

00:01:46.563 --> 00:01:48.083
looking up the corresponding

00:01:48.563 --> 00:01:51.523
URLs based upon the region that the user is in,

00:01:51.683 --> 00:01:53.723
and then it is redirecting them to that

00:01:53.723 --> 00:01:54.163
destination.

00:01:54.243 --> 00:01:54.803
And then,

00:01:55.053 --> 00:01:56.743
in the background it's taking that information

00:01:56.823 --> 00:01:58.743
that it collects for the click link and it's

00:01:58.743 --> 00:01:59.863
sending it over to a queue.

00:02:00.182 --> 00:02:01.063
And then the queue,

00:02:01.503 --> 00:02:04.023
is being consumed by a consumer that lives in the

00:02:04.023 --> 00:02:06.663
same project that actually hosts this Hono API.

00:02:06.663 --> 00:02:07.863
They're kind of separate entities,

00:02:07.863 --> 00:02:08.863
but they're in the same project.

00:02:09.023 --> 00:02:10.983
This consumer could be moved to another service

00:02:10.983 --> 00:02:11.423
separately,

00:02:11.423 --> 00:02:12.503
but there's no need.

00:02:12.503 --> 00:02:14.163
There's really no reason to have more than two,

00:02:14.313 --> 00:02:14.793
two services,

00:02:14.953 --> 00:02:16.873
these two services in our application.

00:02:16.873 --> 00:02:18.233
So I hope this makes sense so far.

00:02:18.633 --> 00:02:19.033
Now

00:02:19.573 --> 00:02:20.893
is really high level data flow.

00:02:20.893 --> 00:02:22.973
And I kind of skipped over things like right here

00:02:22.973 --> 00:02:23.533
we're using,

00:02:23.753 --> 00:02:24.243
cloudwork,

00:02:24.243 --> 00:02:24.963
KV and stuff,

00:02:24.963 --> 00:02:26.243
but this is just high level stuff.

00:02:26.563 --> 00:02:26.963
Now,

00:02:27.693 --> 00:02:30.453
on this side we have our workflow and our workflow

00:02:30.453 --> 00:02:33.093
is doing some browser rendering and it's using AI

00:02:33.093 --> 00:02:34.333
to detect stuff,

00:02:34.493 --> 00:02:36.813
saving some data into our database and then it is

00:02:36.813 --> 00:02:38.413
saving some information into R2.

00:02:38.653 --> 00:02:40.813
And so far what we have been doing is we've been

00:02:40.813 --> 00:02:42.973
manually triggering this workflow via the ui,

00:02:42.973 --> 00:02:44.253
the cloudflare dashboard.

00:02:44.723 --> 00:02:44.963
Now

00:02:45.063 --> 00:02:47.431
what we want to do is we want to find a way

00:02:47.751 --> 00:02:50.871
to trigger this workflow programmatically and it

00:02:50.871 --> 00:02:54.071
has to kind of fit inside of the data flow within

00:02:54.151 --> 00:02:55.881
our ecosystem that we've built out.

00:02:56.031 --> 00:02:56.360
now

00:02:56.360 --> 00:02:58.366
there's a lot of ways to do this and there's no

00:02:58.366 --> 00:02:59.966
right or wrong way to do this,

00:02:59.966 --> 00:03:00.366
but

00:03:00.846 --> 00:03:01.566
a lot of

00:03:01.966 --> 00:03:03.806
the structure of how we're going to build this out

00:03:03.806 --> 00:03:06.606
is going to depend upon the business logic that we

00:03:06.606 --> 00:03:07.326
want to implement.

00:03:07.647 --> 00:03:10.007
Now this layer of the workflow is the most

00:03:10.007 --> 00:03:10.767
expensive

00:03:12.267 --> 00:03:14.467
of our stack right now because we have AI,

00:03:14.467 --> 00:03:15.307
we have browser rendering,

00:03:15.307 --> 00:03:17.187
we're saving like heavy files into R2.

00:03:17.187 --> 00:03:18.227
So this is like,

00:03:18.227 --> 00:03:19.386
it's not crazy expensive,

00:03:19.386 --> 00:03:19.907
but it's,

00:03:19.907 --> 00:03:20.267
it's,

00:03:20.267 --> 00:03:22.067
we're definitely not going to want to run the

00:03:22.067 --> 00:03:24.667
workflow every single time we get a link click.

00:03:24.667 --> 00:03:25.547
That'd be crazy,

00:03:25.547 --> 00:03:25.907
right?

00:03:26.227 --> 00:03:28.307
What we're going to want to do is we're going to

00:03:28.307 --> 00:03:30.677
want to find a way in this section to,

00:03:30.747 --> 00:03:31.547
to basically say,

00:03:31.547 --> 00:03:31.947
hey,

00:03:32.427 --> 00:03:33.627
I want to,

00:03:34.107 --> 00:03:34.667
you know,

00:03:34.747 --> 00:03:35.987
listen to the link clicks.

00:03:35.987 --> 00:03:37.467
Because the consumer right now is listening to

00:03:37.467 --> 00:03:38.187
link clicks

00:03:38.587 --> 00:03:41.267
and then given a certain period of time or some

00:03:41.267 --> 00:03:41.907
type of like,

00:03:41.907 --> 00:03:42.427
logic.

00:03:42.427 --> 00:03:45.627
So let's say for now we say we're going to get a

00:03:45.627 --> 00:03:46.267
link click

00:03:46.586 --> 00:03:48.827
and in three days from now

00:03:49.147 --> 00:03:50.187
we're going to run

00:03:50.507 --> 00:03:50.907
a

00:03:51.467 --> 00:03:52.747
workflow for

00:03:52.933 --> 00:03:55.229
that specific link click and all of the other link

00:03:55.229 --> 00:03:57.229
clicks that I received for the same destination

00:03:57.229 --> 00:03:57.829
URL

00:03:58.329 --> 00:03:58.729
one time.

00:03:58.889 --> 00:03:59.609
So basically,

00:03:59.689 --> 00:04:03.449
one link could be clicked 500 times and it could

00:04:03.449 --> 00:04:04.009
go to

00:04:04.329 --> 00:04:06.489
the same destination in this example.

00:04:06.969 --> 00:04:08.849
And instead of running this workflow for that

00:04:08.849 --> 00:04:11.289
exact Same destination URL 500 times,

00:04:11.289 --> 00:04:12.649
we're just going to basically say,

00:04:12.649 --> 00:04:13.049
hey,

00:04:13.289 --> 00:04:15.609
set a timer for this specific destination

00:04:15.929 --> 00:04:18.409
three days into the future and then trigger this

00:04:18.409 --> 00:04:19.049
workflow.

00:04:19.249 --> 00:04:19.609
so that,

00:04:19.609 --> 00:04:21.369
that's just kind of like a really simple way.

00:04:21.769 --> 00:04:24.249
at this layer we could have some enhanced

00:04:24.409 --> 00:04:26.969
functionality where we will run,

00:04:28.329 --> 00:04:30.289
where we will run like health checks for

00:04:30.289 --> 00:04:32.409
destination URLs that get link clicks,

00:04:32.809 --> 00:04:33.311
you know,

00:04:33.311 --> 00:04:33.938
10 days,

00:04:34.098 --> 00:04:34.818
every 10 days.

00:04:35.058 --> 00:04:36.818
And if the user is paid,

00:04:36.818 --> 00:04:39.018
then maybe we do it every day if a link is

00:04:39.018 --> 00:04:39.458
clicked.

00:04:39.618 --> 00:04:42.418
Or maybe we have really advanced state management

00:04:42.418 --> 00:04:45.738
logic where if it's the first time that we get a

00:04:45.738 --> 00:04:47.938
link click for a specific destination URL,

00:04:48.098 --> 00:04:49.658
we'll go ahead and run that workflow,

00:04:49.658 --> 00:04:50.498
make sure it's healthy.

00:04:50.898 --> 00:04:51.458
And then

00:04:51.648 --> 00:04:52.528
once we run it once,

00:04:52.768 --> 00:04:54.128
we'll set another timer

00:04:54.448 --> 00:04:54.648
a

00:04:54.648 --> 00:04:55.428
day into the future

00:04:55.828 --> 00:04:57.468
or the next time we get the link click for the

00:04:57.468 --> 00:04:58.068
same destination,

00:04:58.388 --> 00:04:59.988
we'll set it for one day into the future

00:05:00.308 --> 00:05:01.268
just so we can like,

00:05:01.268 --> 00:05:03.468
basically not run this workflow unnecessarily too

00:05:03.468 --> 00:05:04.068
many times.

00:05:04.388 --> 00:05:06.948
But we can also kind of like build out a lot of

00:05:07.187 --> 00:05:10.268
really sophisticated logic to determine when this

00:05:10.268 --> 00:05:11.268
workflow should be run.

00:05:11.748 --> 00:05:13.788
Now that's ultimately what we're going to be able

00:05:13.788 --> 00:05:15.828
to accomplish with durable objects.

00:05:15.828 --> 00:05:16.027
Now

00:05:16.130 --> 00:05:17.650
our use case is going to be pretty simple.

00:05:17.810 --> 00:05:19.250
We're just going to be using like,

00:05:19.250 --> 00:05:19.930
state to keep,

00:05:19.930 --> 00:05:22.210
we're going to keep Track of like some specific

00:05:22.210 --> 00:05:24.130
information that we gleaned from a link click.

00:05:24.450 --> 00:05:26.690
And then in the future we're just going to set

00:05:26.690 --> 00:05:27.530
some timer to say,

00:05:27.530 --> 00:05:27.770
hey,

00:05:27.770 --> 00:05:29.090
in the future let's run this workflow,

00:05:29.090 --> 00:05:29.913
make sure everything's good.

00:05:29.913 --> 00:05:32.694
and the reason why durable objects make sense for

00:05:32.694 --> 00:05:35.094
this specific implementation to solve this problem

00:05:35.494 --> 00:05:38.414
is because durable objects have really two things

00:05:38.414 --> 00:05:39.174
that we care about.

00:05:39.644 --> 00:05:40.844
They can keep track of state

00:05:42.444 --> 00:05:42.844
and

00:05:43.000 --> 00:05:43.804
they have an alarm,

00:05:43.804 --> 00:05:44.116
which,

00:05:44.293 --> 00:05:46.341
which is ultimately just some type of scheduling

00:05:46.341 --> 00:05:46.941
mechanism.

00:05:47.021 --> 00:05:48.621
So we can do those two things.

00:05:48.621 --> 00:05:50.741
We can keep track of state and then we can say in

00:05:50.741 --> 00:05:51.661
a certain period of time,

00:05:52.061 --> 00:05:52.781
wake up

00:05:53.181 --> 00:05:54.541
and run some logic.

00:05:54.541 --> 00:05:56.735
And we have context to that state.

00:05:56.735 --> 00:05:57.969
And what makes it really cool

00:05:58.289 --> 00:05:58.689
is

00:05:59.269 --> 00:06:00.709
we have the state and we have an alarm,

00:06:00.709 --> 00:06:03.749
but we essentially create an instance of a durable

00:06:03.749 --> 00:06:07.629
object for every single destination link that gets

00:06:07.629 --> 00:06:07.784
clicked.

00:06:07.784 --> 00:06:08.617
And it's very cheap.

00:06:08.617 --> 00:06:08.877
So like,

00:06:08.877 --> 00:06:10.837
you're not necessarily billed on how many

00:06:11.077 --> 00:06:13.677
instances of a durable object are out there.

00:06:13.677 --> 00:06:15.957
So if you imagine this application scales,

00:06:16.197 --> 00:06:19.517
we have 10 million link clicks all to different

00:06:19.517 --> 00:06:20.357
destinations.

00:06:20.437 --> 00:06:22.797
There could be 10,000 instances of a durable

00:06:22.797 --> 00:06:23.237
object,

00:06:23.397 --> 00:06:24.997
all with their independent state

00:06:25.587 --> 00:06:26.947
and their independent alarm,

00:06:27.507 --> 00:06:30.587
managing the lifecycle of running these workflows.

00:06:30.587 --> 00:06:32.427
And I know this is probably still a little bit

00:06:32.427 --> 00:06:33.107
confusing if

00:06:33.637 --> 00:06:34.847
you've never used durable objects.

00:06:34.847 --> 00:06:36.527
And that's okay because as we get into the code,

00:06:36.527 --> 00:06:38.047
things are going to make a lot more sense.

00:06:38.127 --> 00:06:40.527
But just kind of think from this really high level

00:06:40.606 --> 00:06:41.407
first you know,

00:06:41.567 --> 00:06:42.687
you're keeping track of state.

00:06:42.767 --> 00:06:45.047
So there's kind of like a storage database device

00:06:45.047 --> 00:06:46.287
inside of a durable object.

00:06:46.447 --> 00:06:49.327
You're able to create instances of a durable

00:06:49.327 --> 00:06:51.087
object based upon your business logic.

00:06:51.287 --> 00:06:52.047
In our situation,

00:06:52.047 --> 00:06:53.207
it's going to be a destination.

00:06:54.017 --> 00:06:57.667
URL is what like makes a durable object unique.

00:06:57.987 --> 00:07:00.467
And we have the ability to schedule something into

00:07:00.467 --> 00:07:02.787
the future so we can run some code at some given

00:07:02.787 --> 00:07:04.147
point in time into the future.

00:07:04.227 --> 00:07:05.267
Now before

00:07:05.747 --> 00:07:07.267
we go into the code,

00:07:07.587 --> 00:07:10.067
I do have two videos out that I'm actually pretty

00:07:10.067 --> 00:07:10.427
proud of.

00:07:10.427 --> 00:07:11.507
This video about,

00:07:11.637 --> 00:07:13.410
durable objects starts

00:07:13.810 --> 00:07:15.890
really general but goes very deep,

00:07:16.120 --> 00:07:18.720
specifically for use cases that are kind of like

00:07:18.720 --> 00:07:20.840
managing state and running code inside of a

00:07:20.840 --> 00:07:21.492
durable object.

00:07:21.516 --> 00:07:22.396
So I would suggest,

00:07:22.616 --> 00:07:24.616
watching this one first and then later throughout

00:07:24.616 --> 00:07:24.936
the course.

00:07:24.936 --> 00:07:26.696
We're actually going to be using durable objects

00:07:26.696 --> 00:07:27.776
to manage state between

00:07:28.096 --> 00:07:28.896
websockets,

00:07:28.896 --> 00:07:30.136
between client and server,

00:07:30.136 --> 00:07:30.456
and

00:07:31.016 --> 00:07:32.856
technically multiple types of users.

00:07:32.856 --> 00:07:33.176
So

00:07:33.456 --> 00:07:34.776
this video actually does that.

00:07:34.776 --> 00:07:36.376
We build out the

00:07:37.176 --> 00:07:38.956
real time ability to like

00:07:39.356 --> 00:07:40.916
in real time see what somebody else is doing

00:07:40.916 --> 00:07:43.596
inside of excelidraw we kind of go through that in

00:07:43.596 --> 00:07:43.956
that video.

00:07:43.956 --> 00:07:44.876
This one is longer.

00:07:45.276 --> 00:07:46.476
It's not necessary to watch.

00:07:46.476 --> 00:07:47.596
But these two videos,

00:07:47.596 --> 00:07:47.796
I think,

00:07:47.796 --> 00:07:48.076
are really,

00:07:48.076 --> 00:07:49.796
really good explanations of how to use durable

00:07:49.796 --> 00:07:51.356
objects and why you would want to use them.

00:07:51.596 --> 00:07:53.676
So I'm going to link to these in the description

00:07:53.676 --> 00:07:54.196
of this video.

00:07:54.196 --> 00:07:55.676
But in this next video,

00:07:55.676 --> 00:07:57.356
we're actually going to start diving deep into the

00:07:57.356 --> 00:07:57.517
code.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.530 --> 00:00:00.650
Now,

00:00:00.650 --> 00:00:03.010
durable objects are the type of product where to

00:00:03.010 --> 00:00:03.970
really understand it,

00:00:03.970 --> 00:00:05.730
the best thing you can do is just like read

00:00:05.730 --> 00:00:07.970
through the docs in detail and try to understand

00:00:07.970 --> 00:00:10.130
absolutely everything about it and then just start

00:00:10.130 --> 00:00:11.010
building on top of it.

00:00:11.010 --> 00:00:13.450
Because it is a product that has a lot of

00:00:13.450 --> 00:00:13.970
features,

00:00:13.970 --> 00:00:16.490
and a lot of the features can kind of be hard to

00:00:16.490 --> 00:00:18.250
make sense of up until you use it.

00:00:18.250 --> 00:00:20.330
Which is why we're doing this in the course is

00:00:20.330 --> 00:00:21.290
just so you know,

00:00:21.290 --> 00:00:23.050
you'll have the muscle memory of actually being

00:00:23.050 --> 00:00:23.770
able to build something,

00:00:23.770 --> 00:00:25.570
deploy durable objects and see how it,

00:00:25.570 --> 00:00:26.210
how it works,

00:00:26.840 --> 00:00:27.880
implementing your own thing.

00:00:27.960 --> 00:00:28.360
So

00:00:28.640 --> 00:00:30.880
to get started we can just kind of like go through

00:00:30.880 --> 00:00:32.800
a few of the concepts that they have here.

00:00:32.800 --> 00:00:33.200
So

00:00:33.420 --> 00:00:35.670
to use a durable object inside of your code base,

00:00:35.670 --> 00:00:37.630
you're basically going to create a class that you

00:00:37.630 --> 00:00:39.270
define that extends a durable object.

00:00:39.270 --> 00:00:41.709
And this durable object class has access to all

00:00:41.709 --> 00:00:45.110
the durable object APIs that manage state alarms

00:00:45.190 --> 00:00:45.590
and

00:00:45.810 --> 00:00:47.170
in memory variables,

00:00:47.330 --> 00:00:48.850
WebSockets and whatnot.

00:00:48.850 --> 00:00:51.490
On top of Cloudflare's durable object platform,

00:00:51.910 --> 00:00:54.190
Now this class actually isn't doing anything right

00:00:54.190 --> 00:00:54.430
now,

00:00:54.430 --> 00:00:54.790
Has function Object() { [native code] }.

00:00:54.790 --> 00:00:55.150
function Object() { [native code] }.

00:00:55.150 --> 00:00:55.990
It takes in the state,

00:00:56.070 --> 00:00:57.110
passes it into super,

00:00:57.110 --> 00:00:58.990
but there's really nothing happening here.

00:00:58.990 --> 00:00:59.350
Now

00:00:59.930 --> 00:01:01.370
what you're going to notice is

00:01:01.407 --> 00:01:03.302
when you're working with durable objects,

00:01:03.302 --> 00:01:05.222
you kind of have like two ways of managing state.

00:01:05.302 --> 00:01:05.862
You have

00:01:06.342 --> 00:01:09.702
managing state like in memory and then you have

00:01:10.132 --> 00:01:12.412
actual like storage where you can also backup

00:01:12.412 --> 00:01:12.692
state.

00:01:12.852 --> 00:01:16.412
So a example of managing state and memory is like

00:01:16.412 --> 00:01:16.692
this.

00:01:17.312 --> 00:01:19.356
Basically you have an example where

00:01:19.388 --> 00:01:21.588
you define like at the top level of the class,

00:01:21.588 --> 00:01:23.268
a value called initialized.

00:01:23.348 --> 00:01:25.508
And then when the constructor is called for the

00:01:25.508 --> 00:01:26.028
very first time,

00:01:26.028 --> 00:01:27.868
if you're not familiar with object oriented

00:01:27.868 --> 00:01:28.388
programming,

00:01:28.468 --> 00:01:31.508
when this class is instantiated or created for the

00:01:31.508 --> 00:01:31.908
first time,

00:01:33.438 --> 00:01:35.278
this constructor is going to execute.

00:01:35.358 --> 00:01:37.198
And when this constructor executes,

00:01:37.438 --> 00:01:38.638
it's going to set,

00:01:38.798 --> 00:01:40.158
initialize to true.

00:01:40.238 --> 00:01:42.558
So you could define another method in here that

00:01:42.558 --> 00:01:44.838
like checks if it's initialized or not and it'd be

00:01:44.838 --> 00:01:45.918
referencing this variable.

00:01:46.458 --> 00:01:48.498
Now I mean this is kind of a useless example in my

00:01:48.498 --> 00:01:48.858
opinion.

00:01:48.858 --> 00:01:49.178
But

00:01:49.625 --> 00:01:51.585
when this durable object shuts down due to

00:01:51.585 --> 00:01:52.265
inactivity,

00:01:52.425 --> 00:01:54.265
because durable objects aren't on forever,

00:01:54.665 --> 00:01:55.105
they're,

00:01:55.105 --> 00:01:56.945
they do some type of like compute and then if

00:01:56.945 --> 00:01:58.545
they're not being used they'll be shut down and

00:01:58.545 --> 00:02:00.065
the next time they're accessed they'll start back

00:02:00.065 --> 00:02:02.465
up and the next time this is accessed it's going

00:02:02.465 --> 00:02:02.665
to,

00:02:02.665 --> 00:02:05.145
it's going to be false up until it's initialized.

00:02:05.365 --> 00:02:07.645
so you can imagine a scenario where you have like

00:02:07.645 --> 00:02:09.525
a counter variable here starts at zero.

00:02:10.555 --> 00:02:13.275
and then every single time it's so every single

00:02:13.275 --> 00:02:15.395
time a method is hit and increments by one and

00:02:15.395 --> 00:02:16.395
then when it shuts down

00:02:16.955 --> 00:02:18.555
it's going to start back at zero.

00:02:18.795 --> 00:02:20.315
Now if you want to persist state,

00:02:20.555 --> 00:02:21.995
this is kind of what they're doing here.

00:02:22.515 --> 00:02:24.075
you have two ways of persisting state.

00:02:24.155 --> 00:02:25.755
You have a basic key,

00:02:25.955 --> 00:02:26.965
key value back,

00:02:26.965 --> 00:02:28.125
durable object class.

00:02:28.365 --> 00:02:30.685
So it's just like a really basic here's a key,

00:02:30.685 --> 00:02:32.325
here's a value and that's how you're keeping track

00:02:32.325 --> 00:02:32.765
of state.

00:02:32.845 --> 00:02:34.805
And then they have a more sophisticated

00:02:34.805 --> 00:02:37.205
implementation that's kind of backed by SQLite.

00:02:37.205 --> 00:02:38.325
So you can actually define,

00:02:38.325 --> 00:02:39.405
you can create tables,

00:02:39.485 --> 00:02:40.765
you can store data in the tables,

00:02:40.765 --> 00:02:41.005
you

00:02:41.385 --> 00:02:43.545
queries against the data in the tables and all of

00:02:43.545 --> 00:02:45.185
that can be managed inside of a durable object.

00:02:45.185 --> 00:02:46.625
So you can think about it like if you have a

00:02:46.625 --> 00:02:48.265
durable object for each user,

00:02:48.425 --> 00:02:50.705
each user can have their own SQLite database.

00:02:50.705 --> 00:02:52.745
It's a really interesting implementation.

00:02:52.745 --> 00:02:54.625
And in the next section we're actually going to be

00:02:54.625 --> 00:02:55.225
using this

00:02:55.445 --> 00:02:58.085
along with websockets to really like get,

00:02:58.605 --> 00:03:01.685
to really like do some advanced state tracking

00:03:01.685 --> 00:03:03.005
with link clicks.

00:03:03.005 --> 00:03:05.125
But for now we're just going to start with a key

00:03:05.125 --> 00:03:05.735
value backed

00:03:05.735 --> 00:03:06.305
durable object.

00:03:06.305 --> 00:03:08.065
Just because it's like really easy to get into

00:03:08.465 --> 00:03:10.785
Now an example of how you could use this is

00:03:11.025 --> 00:03:13.305
essentially you have a method called increment and

00:03:13.305 --> 00:03:14.385
every single time this is called,

00:03:14.625 --> 00:03:16.705
it's going to go to the storage and it's going to

00:03:16.705 --> 00:03:17.185
get a value.

00:03:17.185 --> 00:03:19.145
If the value hasn't been defined ever,

00:03:19.145 --> 00:03:21.665
it'll default to 0 and then it will be incremented

00:03:21.665 --> 00:03:23.385
by 1 and then it's going to be put back into

00:03:23.385 --> 00:03:23.824
storage.

00:03:23.824 --> 00:03:25.105
So every single time this is called,

00:03:25.105 --> 00:03:26.705
it's going to be incremented by one.

00:03:26.705 --> 00:03:27.052
Now

00:03:27.070 --> 00:03:29.080
you could also technically define value at the top

00:03:29.080 --> 00:03:30.920
level of this class in memory and then the

00:03:30.920 --> 00:03:32.320
constructor could pull

00:03:32.920 --> 00:03:34.600
value and then default it to zero.

00:03:35.050 --> 00:03:37.260
and then whenever you like use the value.

00:03:37.340 --> 00:03:39.340
Instead of like pulling value from storage,

00:03:39.340 --> 00:03:42.220
you can actually reference it as the in memory

00:03:42.220 --> 00:03:42.510
state

00:03:42.840 --> 00:03:43.160
and we'll,

00:03:43.160 --> 00:03:45.040
we'll get into like how that looks and how we use

00:03:45.040 --> 00:03:45.320
that,

00:03:45.830 --> 00:03:46.300
coming up.

00:03:46.300 --> 00:03:48.460
But those are kind of like the important things to

00:03:48.460 --> 00:03:48.660
know.

00:03:48.660 --> 00:03:51.340
You have in memory state that doesn't persist

00:03:51.340 --> 00:03:51.860
through the,

00:03:51.860 --> 00:03:54.100
that doesn't persist when a durable object shuts

00:03:54.100 --> 00:03:54.380
down.

00:03:54.380 --> 00:03:55.420
And what you have,

00:03:55.420 --> 00:03:56.380
you also have

00:03:57.320 --> 00:03:58.640
storage that persist state

00:03:59.180 --> 00:03:59.620
throughout,

00:03:59.620 --> 00:03:59.980
like

00:04:00.110 --> 00:04:02.430
the killing of this durable object instance.

00:04:02.430 --> 00:04:04.030
So the next time it turns on you can actually

00:04:04.270 --> 00:04:05.470
recoup that state.

00:04:05.710 --> 00:04:06.780
So it's pretty cool.

00:04:07.530 --> 00:04:07.930
now

00:04:08.490 --> 00:04:10.250
the other thing that they talk about is alarms.

00:04:10.800 --> 00:04:13.050
they just give you some of the ergonomics of how

00:04:13.050 --> 00:04:14.050
to manage alarms.

00:04:14.050 --> 00:04:16.490
Alarms are basically just going to take like an

00:04:16.490 --> 00:04:17.850
epoch millie timestamp.

00:04:17.850 --> 00:04:19.890
So you have like date time,

00:04:19.890 --> 00:04:21.250
date now which is

00:04:21.810 --> 00:04:23.490
you know like the current time

00:04:24.110 --> 00:04:25.550
usually in UTC time,

00:04:25.740 --> 00:04:26.670
plus 10

00:04:27.150 --> 00:04:27.710
seconds.

00:04:27.710 --> 00:04:28.910
Seconds is in thousands.

00:04:28.910 --> 00:04:30.670
So like this is basically saying

00:04:31.230 --> 00:04:33.710
set an alarm 10 seconds from now and then the

00:04:33.710 --> 00:04:35.710
durable object is going to be triggered.

00:04:36.030 --> 00:04:36.430
This,

00:04:36.510 --> 00:04:38.910
whatever logic is defined inside of this alarm

00:04:38.910 --> 00:04:39.390
function

00:04:39.790 --> 00:04:42.150
is going to be triggered 10 seconds from this

00:04:42.150 --> 00:04:42.830
period of time.

00:04:42.910 --> 00:04:43.310
So

00:04:43.540 --> 00:04:45.190
we're going to be using this and we're going to

00:04:45.190 --> 00:04:48.030
like use it in a way that's a little bit easier to

00:04:48.030 --> 00:04:49.110
understand and reason about.

00:04:49.110 --> 00:04:49.870
I don't love

00:04:50.390 --> 00:04:52.630
like having hard coded 1000 seconds here.

00:04:52.630 --> 00:04:54.630
I think this is kind of like hard to

00:04:55.000 --> 00:04:57.080
just visually look at and know exactly what's

00:04:57.080 --> 00:04:57.560
going on.

00:04:57.640 --> 00:04:58.040
But

00:04:58.380 --> 00:05:00.060
these are just kind of like the things to look at.

00:05:00.060 --> 00:05:02.380
I would suggest reading through the documentation

00:05:02.540 --> 00:05:04.540
really try to grasp this because durable objects

00:05:04.540 --> 00:05:06.500
can really transform the products you're able to

00:05:06.500 --> 00:05:08.700
build without having to reach to tons of different

00:05:08.700 --> 00:05:11.580
providers to manage state in a really complicated

00:05:11.580 --> 00:05:12.420
data ecosystem.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.090 --> 00:00:00.490
alright,

00:00:00.490 --> 00:00:02.210
so now let's start building out our durable

00:00:02.210 --> 00:00:02.730
object.

00:00:02.810 --> 00:00:04.290
What we're going to do is we're going to make

00:00:04.290 --> 00:00:04.530
sure,

00:00:04.530 --> 00:00:07.050
sure we head over to the data service project,

00:00:07.610 --> 00:00:10.130
head over to Source and then now we're going to

00:00:10.130 --> 00:00:11.610
create a new folder called

00:00:12.090 --> 00:00:12.730
Durable

00:00:15.530 --> 00:00:16.330
Objects.

00:00:16.490 --> 00:00:17.039
All right.

00:00:17.329 --> 00:00:19.329
this specific durable object,

00:00:19.649 --> 00:00:21.289
what we can do is we can basically,

00:00:21.289 --> 00:00:22.929
I think we're going to name it something along the

00:00:22.929 --> 00:00:24.769
lines of Evaluation Scheduler

00:00:25.399 --> 00:00:28.039
because the core goal of this durable object is to

00:00:28.039 --> 00:00:30.519
schedule out when the evaluation workflow should

00:00:30.519 --> 00:00:30.839
run.

00:00:30.919 --> 00:00:34.439
So I'm going to say Evaluation Scheduler TS

00:00:34.632 --> 00:00:35.243
and to

00:00:35.723 --> 00:00:36.923
as like kind of just,

00:00:36.923 --> 00:00:37.643
just getting started.

00:00:37.643 --> 00:00:39.443
What I want to do is I want to just build out a

00:00:39.443 --> 00:00:42.643
base class with just a really simple like counter

00:00:42.643 --> 00:00:43.163
logic.

00:00:43.163 --> 00:00:45.083
Just so if you've never worked with durable

00:00:45.083 --> 00:00:45.723
objects before

00:00:46.123 --> 00:00:46.923
you can understand

00:00:47.243 --> 00:00:47.353
at

00:00:47.353 --> 00:00:47.663
like

00:00:48.063 --> 00:00:50.543
the core level how state is managed

00:00:50.793 --> 00:00:52.673
inside of a durable object and then how they can

00:00:52.673 --> 00:00:53.313
be useful.

00:00:53.313 --> 00:00:55.273
So what we're going to do is we're importing

00:00:55.273 --> 00:00:56.073
Durable Object from

00:00:56.073 --> 00:00:57.173
the Cloudflare Workers

00:00:57.493 --> 00:00:58.053
package.

00:00:58.693 --> 00:01:00.853
We're going to extend Durable object here

00:01:02.053 --> 00:01:02.693
and then

00:01:03.093 --> 00:01:05.173
what I'm going to do is basically

00:01:05.568 --> 00:01:06.793
create a function Object() { [native code] }.

00:01:07.433 --> 00:01:10.713
This  is going to be called when the durable

00:01:10.713 --> 00:01:12.873
object is instantiated and I'll show you what that

00:01:12.873 --> 00:01:14.153
means in just a minute.

00:01:14.153 --> 00:01:14.633
If you

00:01:14.963 --> 00:01:16.763
are not super familiar with object oriented

00:01:16.763 --> 00:01:17.158
programming

00:01:17.260 --> 00:01:19.500
and inside of our

00:01:20.300 --> 00:01:21.180
as part of

00:01:21.290 --> 00:01:21.640
Java,

00:01:21.640 --> 00:01:22.443
the JavaScript

00:01:22.443 --> 00:01:23.271
way of doing things,

00:01:23.271 --> 00:01:24.231
you have to call super

00:01:25.031 --> 00:01:27.191
pass in the context and the environment.

00:01:28.471 --> 00:01:30.311
You shouldn't have any more type errors at this

00:01:30.311 --> 00:01:30.631
point.

00:01:30.951 --> 00:01:33.031
And then what we're going to do is at the top

00:01:33.031 --> 00:01:35.831
level let's just define a variable called count.

00:01:36.791 --> 00:01:39.431
And count is going to be a number

00:01:40.011 --> 00:01:41.771
and it's just going to default to

00:01:42.651 --> 00:01:43.051
zero.

00:01:43.236 --> 00:01:43.636
And

00:01:44.356 --> 00:01:46.556
on top of that what we're going to do is inside of

00:01:46.556 --> 00:01:49.756
this  when the storable object starts for the very

00:01:49.756 --> 00:01:50.356
first time,

00:01:50.516 --> 00:01:52.836
we are going to go fetch

00:01:53.156 --> 00:01:53.556
count

00:01:54.276 --> 00:01:55.316
from storage.

00:01:55.396 --> 00:01:57.156
So you can imagine a scenario where

00:01:57.476 --> 00:02:00.156
count is incremented and then the durable object

00:02:00.156 --> 00:02:02.556
goes down because of due to inactivity and then

00:02:02.556 --> 00:02:03.156
it's hit again.

00:02:03.156 --> 00:02:04.916
We're going to want to recover the last known

00:02:04.996 --> 00:02:05.396
count.

00:02:05.798 --> 00:02:06.918
So the context,

00:02:06.918 --> 00:02:08.198
the durable object state

00:02:08.838 --> 00:02:09.718
has a

00:02:10.190 --> 00:02:12.870
method called block concurrency while which

00:02:12.870 --> 00:02:15.590
basically means no other action is going to be

00:02:15.590 --> 00:02:17.470
happening inside of this durable object

00:02:17.870 --> 00:02:18.990
while this is running.

00:02:18.990 --> 00:02:20.590
This just makes it so you don't have

00:02:20.990 --> 00:02:23.150
other requests going to your durable object trying

00:02:23.150 --> 00:02:23.950
to access data

00:02:24.270 --> 00:02:26.150
while this is running because you don't want a

00:02:26.150 --> 00:02:28.270
scenario where you get some type of race conflict.

00:02:29.270 --> 00:02:30.230
now what

00:02:30.700 --> 00:02:32.940
going to do is I'm going to say this dot count

00:02:33.180 --> 00:02:35.340
because we've defined this at the top level of a

00:02:35.340 --> 00:02:35.580
class,

00:02:35.580 --> 00:02:36.780
it's now part of

00:02:37.180 --> 00:02:37.900
this class

00:02:38.540 --> 00:02:40.220
and we're going to say await

00:02:40.290 --> 00:02:43.696
ctx.storage.get

00:02:44.656 --> 00:02:46.016
and we're just going to get

00:02:46.576 --> 00:02:46.976
count.

00:02:47.456 --> 00:02:49.296
Now the very first time this runs

00:02:49.776 --> 00:02:52.256
it's never going to actually be there.

00:02:52.496 --> 00:02:54.096
So if it's not there,

00:02:54.256 --> 00:02:56.456
what we want to do is we just want to return this

00:02:56.456 --> 00:02:57.216
dot count

00:02:57.976 --> 00:02:59.656
because we are defaulting it to zero.

00:02:59.736 --> 00:03:02.296
We could also just say zero but since we're

00:03:02.296 --> 00:03:04.256
defaulting it to zero this is probably a better

00:03:04.256 --> 00:03:04.571
pattern.

00:03:04.764 --> 00:03:07.004
So now let's go define a method called increment

00:03:07.084 --> 00:03:09.764
that's going to increment the count by one every

00:03:09.764 --> 00:03:11.084
single time that it is called.

00:03:11.964 --> 00:03:14.404
So we're going to say increment and what we can do

00:03:14.404 --> 00:03:15.964
is we can say this dot count

00:03:17.244 --> 00:03:18.124
plus plus

00:03:18.844 --> 00:03:20.444
and then we're going to await

00:03:20.794 --> 00:03:23.914
this dot ctx dot storage

00:03:26.775 --> 00:03:30.375
dot put and then we're going to put into our count

00:03:32.495 --> 00:03:33.695
key value store

00:03:34.015 --> 00:03:36.255
this dot count so the incremented value.

00:03:37.496 --> 00:03:39.896
Alright so we've been able to quickly build out

00:03:40.136 --> 00:03:42.536
just a very simple dummy class.

00:03:42.536 --> 00:03:44.846
Now we're going to actually remove this and this,

00:03:44.996 --> 00:03:45.876
this and this later

00:03:46.196 --> 00:03:48.876
I just want to illustrate how state is managed.

00:03:48.876 --> 00:03:49.876
So just to recap,

00:03:49.956 --> 00:03:53.156
we have a in memory value variable called count.

00:03:53.396 --> 00:03:56.156
It is going to be backed up by storage whenever

00:03:56.156 --> 00:03:56.876
it's incremented.

00:03:56.876 --> 00:03:58.356
We're also going to be flushing it

00:03:58.676 --> 00:03:59.076
to

00:04:00.126 --> 00:04:02.766
to our storage in this value called count.

00:04:02.926 --> 00:04:05.166
Now we can also say async

00:04:05.376 --> 00:04:05.736
get

00:04:06.056 --> 00:04:06.456
count

00:04:07.656 --> 00:04:09.456
and what this is going to do is this is just going

00:04:09.456 --> 00:04:10.136
to say return

00:04:11.556 --> 00:04:12.916
this dot count.

00:04:14.110 --> 00:04:15.910
Now notice we're not actually having to go to

00:04:15.910 --> 00:04:18.030
storage for this operation and the reason we don't

00:04:18.030 --> 00:04:19.510
have to go to storage for this operation is

00:04:19.510 --> 00:04:21.990
because this count value in memory is always the

00:04:21.990 --> 00:04:23.258
most up to date version of it.

00:04:23.258 --> 00:04:25.522
But then if the durable object is shut off and we

00:04:25.522 --> 00:04:28.282
lose these in memory variables once it started up

00:04:28.282 --> 00:04:29.362
once again we're able to

00:04:29.912 --> 00:04:31.978
we're able to pull that count from storage again.

00:04:32.190 --> 00:04:34.830
So now let's actually use the storable object

00:04:34.830 --> 00:04:35.870
inside of our code.

00:04:35.870 --> 00:04:37.430
The first thing that we're going to want to do is

00:04:37.430 --> 00:04:41.550
we want to head over to the wrangler JSON file and

00:04:41.550 --> 00:04:42.510
just like the other

00:04:43.220 --> 00:04:45.060
dependencies inside of our application,

00:04:45.300 --> 00:04:47.620
we can just simply add it into our

00:04:48.000 --> 00:04:48.920
wrangler JSON.

00:04:49.240 --> 00:04:51.560
So there's going to be a section called Durable

00:04:51.560 --> 00:04:52.029
Objects.

00:04:52.742 --> 00:04:54.822
Now a binding is going to take a name

00:04:55.142 --> 00:04:56.342
and a class name.

00:04:56.422 --> 00:04:59.462
So what we can say for the binding name,

00:04:59.542 --> 00:05:00.742
let's just call this,

00:05:01.002 --> 00:05:02.362
we're just going to call this evaluation

00:05:02.362 --> 00:05:03.082
scheduler,

00:05:03.082 --> 00:05:04.042
all caps.

00:05:04.042 --> 00:05:05.242
So I'm just going to say.

00:05:15.271 --> 00:05:17.231
And then also we're going to have to define the

00:05:17.231 --> 00:05:17.911
class name.

00:05:17.991 --> 00:05:20.191
So this is the actual class name that we've

00:05:20.191 --> 00:05:20.791
defined here.

00:05:22.541 --> 00:05:24.622
And then the last thing that we have to do is we

00:05:24.622 --> 00:05:26.102
have to define a migration.

00:05:26.422 --> 00:05:29.102
So essentially when a durable object is deployed

00:05:29.102 --> 00:05:29.782
for the first time,

00:05:29.782 --> 00:05:30.422
or you make

00:05:30.852 --> 00:05:33.282
substantial changes to like the actual class name,

00:05:33.282 --> 00:05:34.602
or if you want to delete a class,

00:05:35.082 --> 00:05:37.682
you have to also specify that inside of a

00:05:37.682 --> 00:05:38.842
migrations tag.

00:05:38.922 --> 00:05:39.322
So

00:05:39.582 --> 00:05:41.142
this is mainly just something that you have to do

00:05:41.142 --> 00:05:41.982
the very first time.

00:05:41.982 --> 00:05:43.322
So what we're going to do is we're going to say

00:05:43.322 --> 00:05:44.002
migrations,

00:05:44.402 --> 00:05:45.602
you have to give it a tag.

00:05:45.962 --> 00:05:49.022
this is just like a version essentially of that

00:05:49.022 --> 00:05:50.462
durable object that's being deployed.

00:05:50.462 --> 00:05:50.782
So

00:05:51.742 --> 00:05:53.862
the best convention that I've been able to follow

00:05:53.862 --> 00:05:56.222
is just you kind of say like V1 for the tag.

00:05:56.462 --> 00:05:59.502
And then what this is is this is a new class.

00:05:59.582 --> 00:06:02.782
So this specific durable object is only using the

00:06:03.022 --> 00:06:03.822
kv,

00:06:04.022 --> 00:06:04.782
storage backing.

00:06:04.782 --> 00:06:06.842
It's not using the SQL Light packet,

00:06:06.842 --> 00:06:07.322
backing.

00:06:07.322 --> 00:06:09.082
So you notice here we have

00:06:09.882 --> 00:06:10.602
two different types.

00:06:10.602 --> 00:06:11.082
We have,

00:06:11.162 --> 00:06:11.482
well,

00:06:11.482 --> 00:06:12.642
you can say delete classes,

00:06:12.642 --> 00:06:13.442
new classes,

00:06:13.442 --> 00:06:14.402
rename classes,

00:06:14.402 --> 00:06:15.682
new SQLite classes.

00:06:15.682 --> 00:06:18.322
We're just going to be using the new classes and

00:06:18.322 --> 00:06:20.602
then we just put in that class name here.

00:06:23.091 --> 00:06:23.731
Okay,

00:06:23.891 --> 00:06:25.851
so the last thing that we're going to have to do

00:06:25.851 --> 00:06:28.131
is we have to basically grab that class name.

00:06:28.371 --> 00:06:30.771
Let's head over to index ts

00:06:31.171 --> 00:06:33.371
and similar to what we've done with workflows is

00:06:33.371 --> 00:06:34.771
we're going to export

00:06:35.171 --> 00:06:36.531
that specific class name

00:06:37.011 --> 00:06:37.411
from

00:06:40.861 --> 00:06:41.981
Durable Objects

00:06:42.698 --> 00:06:44.058
Evaluation Scheduler.

00:06:45.070 --> 00:06:47.630
Then make sure we are CD'd into our

00:06:47.950 --> 00:06:48.670
data service

00:06:49.149 --> 00:06:51.430
package or our data service application.

00:06:51.430 --> 00:06:53.070
So apps data service.

00:06:54.509 --> 00:06:58.349
And then I'm going to say PMPM run CF type gen.

00:06:58.620 --> 00:06:59.020
All right,

00:06:59.100 --> 00:07:01.980
so now we have this evaluation scheduler.

00:07:02.060 --> 00:07:03.900
And what's cool about this is,

00:07:04.320 --> 00:07:07.340
because it is all imported into that index ts,

00:07:07.820 --> 00:07:08.220
the

00:07:08.600 --> 00:07:11.420
C of type gin library is able to essentially pull

00:07:11.420 --> 00:07:12.140
that class name.

00:07:12.140 --> 00:07:13.980
So we are able to get the exact

00:07:14.380 --> 00:07:16.700
methods that we defined that we can call inside of

00:07:16.700 --> 00:07:17.060
the code.

00:07:17.060 --> 00:07:18.540
And I'll show you what that means right now.

00:07:18.540 --> 00:07:18.940
So,

00:07:19.910 --> 00:07:21.630
going to want to actually call this method from

00:07:21.630 --> 00:07:22.230
our code.

00:07:22.310 --> 00:07:24.670
And right now we're just going to stand up a super

00:07:24.670 --> 00:07:25.270
dummy,

00:07:25.350 --> 00:07:26.390
get endpoint

00:07:26.710 --> 00:07:29.830
which ultimately is just going to call our durable

00:07:29.830 --> 00:07:30.310
object,

00:07:30.710 --> 00:07:31.430
increment it,

00:07:31.430 --> 00:07:32.710
then return the current value.

00:07:32.950 --> 00:07:33.350
So,

00:07:35.344 --> 00:07:37.024
so let's go ahead and do that now.

00:07:37.184 --> 00:07:39.824
So ultimately what we are going to do is we are

00:07:39.824 --> 00:07:40.544
going to create another

00:07:41.264 --> 00:07:42.064
get route.

00:07:42.294 --> 00:07:43.044
I'm just saying do,

00:07:43.044 --> 00:07:43.404
which

00:07:44.154 --> 00:07:45.434
stands for durable object.

00:07:45.754 --> 00:07:47.354
And we're going to pass in an id.

00:07:47.434 --> 00:07:47.794
Actually,

00:07:47.794 --> 00:07:48.874
let's just call this name,

00:07:48.874 --> 00:07:50.074
it'll make it a little bit

00:07:50.394 --> 00:07:51.114
more clear.

00:07:51.294 --> 00:07:52.314
we're going to call this name.

00:07:52.954 --> 00:07:53.594
And then

00:07:54.234 --> 00:07:56.714
in order to access that durable object,

00:07:56.714 --> 00:07:58.514
the first thing that you're going to want to do is

00:07:58.514 --> 00:08:01.114
you're going to want to get a durable object id so

00:08:01.114 --> 00:08:02.554
you can fetch the specific

00:08:02.874 --> 00:08:04.434
instance of a durable object.

00:08:04.434 --> 00:08:06.554
So we're going to say do ID

00:08:06.874 --> 00:08:07.434
equals

00:08:08.714 --> 00:08:10.794
and then we're going to say C EMV

00:08:13.655 --> 00:08:14.895
Evaluation Scheduler.

00:08:14.895 --> 00:08:16.695
That's our durable object binding name.

00:08:16.935 --> 00:08:19.135
And then we have a few different objects or a few

00:08:19.135 --> 00:08:20.055
different options here.

00:08:20.135 --> 00:08:22.715
GET is what you call when you have a durable

00:08:22.715 --> 00:08:23.400
object id.

00:08:23.535 --> 00:08:23.935
Now

00:08:24.335 --> 00:08:26.735
what we are going to want to do is we're going to

00:08:26.735 --> 00:08:29.935
want to either use ID from name or ID from string.

00:08:30.095 --> 00:08:32.295
Now the ID from string is like a hex

00:08:32.295 --> 00:08:34.655
representation of an actual durable object

00:08:34.655 --> 00:08:35.375
instance id.

00:08:36.245 --> 00:08:38.605
Usually there's not a ton of use cases to use

00:08:38.605 --> 00:08:38.805
this,

00:08:38.805 --> 00:08:40.005
but I have seen a few.

00:08:40.085 --> 00:08:41.885
Typically what happens is you have your own

00:08:41.885 --> 00:08:42.805
internal id

00:08:43.205 --> 00:08:44.565
and that ID could be a name,

00:08:44.565 --> 00:08:45.445
it could be a URL,

00:08:45.445 --> 00:08:45.775
it could be a,

00:08:45.775 --> 00:08:47.665
GUID that you've defined inside of your business

00:08:47.665 --> 00:08:48.185
application.

00:08:48.185 --> 00:08:49.745
And in those scenarios where it's something that

00:08:49.745 --> 00:08:51.385
you've defined on your end

00:08:51.785 --> 00:08:53.705
that is supposed to map to a single instance of a

00:08:53.705 --> 00:08:54.505
durable object,

00:08:54.665 --> 00:08:56.425
you're going to want to say ID from name.

00:08:56.505 --> 00:08:58.185
And what we're going to do is we're going to pass

00:08:58.185 --> 00:08:59.385
in the name here

00:08:59.733 --> 00:09:02.173
and then this is going to return a durable object

00:09:02.173 --> 00:09:02.493
id.

00:09:03.203 --> 00:09:03.813
it's this,

00:09:04.193 --> 00:09:05.873
it is this type right here.

00:09:05.953 --> 00:09:07.713
So from there we can say stub,

00:09:07.873 --> 00:09:10.073
this is the convention that Cloudflare has in

00:09:10.073 --> 00:09:10.633
their docs,

00:09:10.633 --> 00:09:12.113
which is basically just like

00:09:12.593 --> 00:09:14.593
the instance of a durable object.

00:09:14.593 --> 00:09:16.193
And we can say C EMV

00:09:17.473 --> 00:09:18.833
Valuation Scheduler,

00:09:18.993 --> 00:09:19.393
get,

00:09:19.633 --> 00:09:21.873
and we'll pass in that durable object id.

00:09:22.913 --> 00:09:23.313
Now

00:09:23.713 --> 00:09:26.593
from there what you're going to notice is stub

00:09:27.073 --> 00:09:28.113
now gives us access

00:09:28.433 --> 00:09:28.833
to

00:09:29.853 --> 00:09:30.053
get,

00:09:30.053 --> 00:09:31.093
count and increment.

00:09:31.093 --> 00:09:33.053
These are the methods that we've defined inside of

00:09:33.053 --> 00:09:33.913
our durable object.

00:09:33.913 --> 00:09:36.073
And these are all asynchronous because when you

00:09:36.073 --> 00:09:38.153
interface with the durable object for methods that

00:09:38.153 --> 00:09:38.593
you call,

00:09:38.593 --> 00:09:39.953
they're going to be,

00:09:40.883 --> 00:09:42.083
async so

00:09:42.483 --> 00:09:44.443
what we're going to do is we're going to first say

00:09:44.443 --> 00:09:45.043
await

00:09:46.402 --> 00:09:47.762
stub.increment

00:09:48.802 --> 00:09:51.282
and then we're going to basically say count

00:09:55.532 --> 00:09:55.932
equals

00:09:57.212 --> 00:09:57.852
await

00:09:58.572 --> 00:09:59.852
stub.get.

00:09:59.852 --> 00:10:01.452
now technically we could just return

00:10:02.172 --> 00:10:02.972
the count here,

00:10:02.972 --> 00:10:05.012
but I just want to show you how we can access both

00:10:05.012 --> 00:10:05.822
of these methods here.

00:10:05.856 --> 00:10:06.376
and then

00:10:06.598 --> 00:10:08.038
last thing that we're going to do is we're going

00:10:08.038 --> 00:10:09.158
to return this guy right here.

00:10:11.381 --> 00:10:13.901
So we're just basically passing in count into the

00:10:13.901 --> 00:10:14.421
response.

00:10:14.501 --> 00:10:15.541
So this is the

00:10:15.861 --> 00:10:17.821
way that you can interface with a durable object.

00:10:17.821 --> 00:10:19.841
Now you can do this behind an API or you can do

00:10:19.841 --> 00:10:20.801
this within a workflow,

00:10:20.801 --> 00:10:23.161
or you can do this within a queue consumer or

00:10:23.161 --> 00:10:24.361
really wherever you want.

00:10:24.361 --> 00:10:26.521
Like the convention is going to be the same.

00:10:26.521 --> 00:10:28.281
You're going to be accessing your durable object

00:10:28.281 --> 00:10:29.121
via the binding,

00:10:29.201 --> 00:10:30.801
you're going to be getting the id,

00:10:31.121 --> 00:10:33.441
you're going to be passing the ID into this get

00:10:33.441 --> 00:10:35.601
call that's going to give you the actual durable

00:10:35.601 --> 00:10:39.041
object instance that is unique based upon a given

00:10:39.201 --> 00:10:40.961
ID that you pass into here.

00:10:41.361 --> 00:10:44.001
And then you have access to the logic that you've

00:10:44.001 --> 00:10:45.081
defined inside of the class.

00:10:45.081 --> 00:10:46.001
So in our situation,

00:10:46.541 --> 00:10:48.461
increment and get count,

00:10:48.781 --> 00:10:49.661
which is right here.

00:10:49.981 --> 00:10:51.461
And we're just returning that for,

00:10:51.461 --> 00:10:52.121
this use case.

00:10:52.121 --> 00:10:55.401
Now I'm going to say PMPM run dev because you can

00:10:55.401 --> 00:10:57.121
run this locally with no issues.

00:10:58.266 --> 00:11:00.169
It looks like I have to wrangler login.

00:11:01.858 --> 00:11:04.418
Now I can do pnpm run dev.

00:11:04.518 --> 00:11:04.998
All right,

00:11:04.998 --> 00:11:07.038
so now what we're going to do is we will be

00:11:07.038 --> 00:11:08.198
heading over to

00:11:09.198 --> 00:11:09.438
a.

00:11:09.678 --> 00:11:11.518
Let's just head over to our browser

00:11:12.996 --> 00:11:15.750
and then we're going to say durable object and

00:11:15.750 --> 00:11:17.230
we're going to say test name one.

00:11:17.230 --> 00:11:17.990
Or yeah,

00:11:17.990 --> 00:11:19.110
let's say durable object

00:11:19.590 --> 00:11:21.030
and we're just going to say test

00:11:21.402 --> 00:11:21.802
one.

00:11:23.322 --> 00:11:23.722
All right,

00:11:23.722 --> 00:11:25.002
so now we have a count of.

00:11:25.242 --> 00:11:26.594
We have a count of one.

00:11:26.622 --> 00:11:27.742
We're going to keep hitting this.

00:11:28.302 --> 00:11:28.862
Okay,

00:11:29.342 --> 00:11:31.579
now let's say test two here.

00:11:31.579 --> 00:11:32.652
Notice it goes back to.

00:11:33.292 --> 00:11:33.692
Oh,

00:11:33.692 --> 00:11:36.012
I didn't do so Test two right here.

00:11:36.492 --> 00:11:37.892
Now it goes back to count one.

00:11:37.892 --> 00:11:38.332
Increment,

00:11:38.332 --> 00:11:38.732
increment,

00:11:38.732 --> 00:11:39.212
increment.

00:11:39.452 --> 00:11:41.371
Let's head back over to test one.

00:11:41.371 --> 00:11:43.132
And what we're going to notice is we're going to

00:11:43.132 --> 00:11:44.332
basically be able to

00:11:45.772 --> 00:11:49.012
retrieve the last known number incremented by one.

00:11:49.012 --> 00:11:49.692
So 16.

00:11:50.092 --> 00:11:51.212
Let's go to test two,

00:11:52.178 --> 00:11:52.818
back to seven.

00:11:52.898 --> 00:11:54.498
So now when we hit test one again,

00:11:54.498 --> 00:11:55.538
it should be 17.

00:11:56.818 --> 00:11:57.458
There we go.

00:11:57.458 --> 00:12:00.098
So essentially what's happening here is we are

00:12:00.098 --> 00:12:02.938
able to access a unique instance of a durable

00:12:02.938 --> 00:12:03.378
object.

00:12:03.378 --> 00:12:04.418
Based upon an ID

00:12:05.058 --> 00:12:06.818
or the name that we pass into here,

00:12:07.138 --> 00:12:08.898
and we're able to retrieve the state.

00:12:08.978 --> 00:12:09.778
So in this situation,

00:12:09.778 --> 00:12:12.058
there's two instances of that durable object that

00:12:12.058 --> 00:12:13.298
live inside of our

00:12:13.778 --> 00:12:13.788
application,

00:12:14.678 --> 00:12:15.558
that persist.

00:12:15.638 --> 00:12:16.038
So,

00:12:16.468 --> 00:12:17.508
test one and test two.

00:12:17.508 --> 00:12:19.748
Now obviously this could be whatever you want.

00:12:19.748 --> 00:12:21.028
You can have as many instances,

00:12:21.288 --> 00:12:23.808
as you want inside of your business application or

00:12:23.808 --> 00:12:24.888
inside of your business logic.

00:12:24.888 --> 00:12:27.088
There is no limit to the number of instances of

00:12:27.088 --> 00:12:28.568
durable objects that you can create.

00:12:28.648 --> 00:12:30.168
So I hope this makes sense.

00:12:30.458 --> 00:12:31.630
in the next part of this,

00:12:31.790 --> 00:12:32.750
in the next section,

00:12:32.750 --> 00:12:34.910
we're going to be going deeper into building out

00:12:34.910 --> 00:12:37.230
the actual evaluation scheduler,

00:12:37.230 --> 00:12:39.030
and we're going to be removing this state and

00:12:39.030 --> 00:12:39.390
whatnot.

00:12:39.390 --> 00:12:41.030
But I do think it's really important just to kind

00:12:41.030 --> 00:12:41.310
of like,

00:12:41.310 --> 00:12:42.310
at a very base level,

00:12:42.310 --> 00:12:43.710
understand that you have a

00:12:44.060 --> 00:12:44.900
durable object,

00:12:44.900 --> 00:12:46.460
or so you basically have some type of,

00:12:46.460 --> 00:12:46.700
like,

00:12:46.700 --> 00:12:49.660
durable execution that is able to run code and

00:12:49.660 --> 00:12:50.540
keep track of state,

00:12:50.780 --> 00:12:53.540
and you're able to define that at a grain of your

00:12:53.540 --> 00:12:54.380
business logic.

00:12:54.380 --> 00:12:55.620
So in this situation,

00:12:55.620 --> 00:12:56.140
whatever,

00:12:56.620 --> 00:12:59.819
whatever data that we pass into this URL becomes a

00:12:59.819 --> 00:13:00.940
new instance,

00:13:00.940 --> 00:13:02.780
and then we can retrieve instances

00:13:03.420 --> 00:13:04.300
based upon,

00:13:04.450 --> 00:13:05.704
the uniqueness of Test 1,

00:13:05.749 --> 00:13:06.180
Test 2,

00:13:06.180 --> 00:13:07.260
or whatever we put here.

00:13:07.730 --> 00:13:09.920
and then from there we're able to manage the state

00:13:10.450 --> 00:13:10.930
like this,

00:13:11.170 --> 00:13:12.850
and we're able to define our own

00:13:13.250 --> 00:13:14.610
business logic on top of that.

00:13:14.610 --> 00:13:16.530
So we're able to write our own code to interact

00:13:16.530 --> 00:13:17.250
with that state.

00:13:17.570 --> 00:13:17.810
Now,

00:13:17.810 --> 00:13:20.850
if it's still not super clear why this is useful,

00:13:20.930 --> 00:13:22.850
it's going to make more sense as we kind of

00:13:22.850 --> 00:13:24.050
progress throughout this section.

00:13:24.050 --> 00:13:26.089
But I would say just get used to this.

00:13:26.089 --> 00:13:27.570
If you've never worked with durable objects

00:13:27.570 --> 00:13:27.810
before,

00:13:28.130 --> 00:13:29.570
really think about how you're,

00:13:29.590 --> 00:13:30.630
interfacing with the class,

00:13:30.630 --> 00:13:31.790
how you're interfacing with state,

00:13:31.790 --> 00:13:33.710
and then play around with this just so it can kind

00:13:33.710 --> 00:13:34.350
of solidify.

00:13:34.350 --> 00:13:35.310
And in the next video,

00:13:35.310 --> 00:13:36.910
we're actually going to build out some of the

00:13:37.070 --> 00:13:39.470
scheduling logic to trigger our,

00:13:40.060 --> 00:13:41.420
workflows based upon

00:13:42.220 --> 00:13:44.564
logic that we define inside of our durable object.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.066 --> 00:00:00.626
Alright,

00:00:00.626 --> 00:00:02.066
so let's enhance the

00:00:02.386 --> 00:00:05.146
durable object to contain the business logic

00:00:05.146 --> 00:00:07.906
needed to manage the running of our evaluation

00:00:07.906 --> 00:00:08.546
workflow.

00:00:08.546 --> 00:00:10.146
So the very first thing that I'm going to do here

00:00:10.146 --> 00:00:11.666
is delete this.

00:00:11.666 --> 00:00:13.026
We no longer need

00:00:13.346 --> 00:00:14.706
this specific route.

00:00:14.706 --> 00:00:16.546
It's just kind of a dummy temporary route.

00:00:17.016 --> 00:00:19.126
this is just going to clean things up and let's

00:00:19.126 --> 00:00:19.966
delete count,

00:00:20.366 --> 00:00:21.566
and let's delete

00:00:21.913 --> 00:00:23.673
Any other reference to count here.

00:00:23.673 --> 00:00:27.193
We also don't need increment or get count anymore.

00:00:27.673 --> 00:00:30.633
So essentially what we want is we want to build a

00:00:30.633 --> 00:00:32.953
durable object that fits into the system this way.

00:00:32.953 --> 00:00:36.233
So imagine you have some user over here and this

00:00:36.233 --> 00:00:36.793
user

00:00:37.143 --> 00:00:39.903
clicks on a link and it goes to our Hono API.

00:00:39.903 --> 00:00:41.463
And our Hono API looks up

00:00:41.783 --> 00:00:45.703
the specific redirect URL for that given link id.

00:00:46.413 --> 00:00:49.093
it redirects that user so that user is able to

00:00:49.093 --> 00:00:50.093
basically say okay yeah,

00:00:50.093 --> 00:00:50.923
I'm going to go to this

00:00:51.283 --> 00:00:53.603
new destination and in the background we're

00:00:53.603 --> 00:00:55.803
writing some information to the queue and we're

00:00:55.803 --> 00:00:57.963
writing this specific information to the queue.

00:00:57.963 --> 00:00:58.563
We're saying

00:00:59.313 --> 00:01:02.433
we're passing in the country the destination which

00:01:02.433 --> 00:01:04.873
is the actual like redirect URL,

00:01:04.873 --> 00:01:05.793
the account id,

00:01:05.793 --> 00:01:06.393
latitude,

00:01:06.393 --> 00:01:06.832
longitude,

00:01:06.832 --> 00:01:08.273
some other additional information here.

00:01:08.673 --> 00:01:10.413
that information is going onto our queue,

00:01:10.413 --> 00:01:12.533
it's being saved in a database and then,

00:01:12.613 --> 00:01:14.173
or it's being picked up by a consumer,

00:01:14.173 --> 00:01:15.973
it's being saved into a database and then

00:01:16.603 --> 00:01:18.203
from there we're going to want to build some

00:01:18.203 --> 00:01:18.603
extra,

00:01:18.603 --> 00:01:22.643
some extra logic and that the new bit of logic

00:01:22.643 --> 00:01:25.003
that we're going to be adding is this durable

00:01:25.003 --> 00:01:26.043
object that

00:01:26.363 --> 00:01:29.763
basically looks at a given destination URL and

00:01:29.763 --> 00:01:31.683
then is able to run a workflow based upon that

00:01:31.683 --> 00:01:32.843
destination URL.

00:01:32.843 --> 00:01:33.243
So

00:01:33.783 --> 00:01:35.983
from here we can build out business logic to say

00:01:35.983 --> 00:01:36.223
hey,

00:01:36.223 --> 00:01:37.303
whenever we get a link,

00:01:37.303 --> 00:01:37.663
click,

00:01:37.663 --> 00:01:39.903
let's wait three days or let's wait two minutes or

00:01:39.903 --> 00:01:40.903
let's wait seven days.

00:01:41.543 --> 00:01:43.463
Let's check if the user is

00:01:44.443 --> 00:01:44.683
of,

00:01:44.923 --> 00:01:46.923
is a premium user and they're paying for the

00:01:46.923 --> 00:01:48.363
service because maybe you could say like

00:01:48.363 --> 00:01:49.963
evaluations are only a

00:01:50.893 --> 00:01:51.773
a premium

00:01:52.413 --> 00:01:52.423
feature,

00:01:52.673 --> 00:01:53.673
within the application.

00:01:53.673 --> 00:01:56.273
So this is kind of where all that logic can live

00:01:56.273 --> 00:01:58.793
and it can be very self contained and easy to

00:01:58.793 --> 00:01:59.793
manage and roll out.

00:01:59.953 --> 00:02:02.193
So what we're going to want to do is we're going

00:02:02.193 --> 00:02:03.873
to want to head back over to our evaluation

00:02:03.953 --> 00:02:06.273
scheduler and then I have an interface that we,

00:02:06.273 --> 00:02:07.313
that I've created

00:02:07.793 --> 00:02:08.193
called

00:02:08.873 --> 00:02:09.453
click data

00:02:10.173 --> 00:02:12.573
and this just contains some specific information

00:02:12.893 --> 00:02:14.750
about a given link click,

00:02:14.901 --> 00:02:16.021
we get an account ID

00:02:16.341 --> 00:02:17.061
Link id,

00:02:17.221 --> 00:02:18.501
destination URL,

00:02:18.581 --> 00:02:20.181
destination country code.

00:02:20.591 --> 00:02:22.191
now what we're going to want to do is we're going

00:02:22.191 --> 00:02:24.351
to want to define a top level property of this

00:02:24.351 --> 00:02:24.671
class

00:02:25.151 --> 00:02:25.551
called

00:02:26.131 --> 00:02:26.851
click data,

00:02:26.851 --> 00:02:29.011
which is either of this type click data

00:02:29.411 --> 00:02:30.863
or it is undefined.

00:02:31.146 --> 00:02:33.146
Now we can also inside of this

00:02:33.749 --> 00:02:35.909
inside of our block concurrency while

00:02:36.229 --> 00:02:37.509
we can go grab that data.

00:02:37.909 --> 00:02:38.309
And

00:02:39.029 --> 00:02:41.429
when this durable object is utilized for the very

00:02:41.429 --> 00:02:41.949
first time,

00:02:41.949 --> 00:02:43.509
this is going to be undefined,

00:02:43.509 --> 00:02:47.149
which is why we have it of the type click data or

00:02:47.149 --> 00:02:47.909
undefined.

00:02:48.389 --> 00:02:51.349
Now we can add an additional method to this class

00:02:51.589 --> 00:02:51.989
called

00:02:52.529 --> 00:02:53.690
Collect link click.

00:02:54.496 --> 00:02:56.606
Now collect link click is going to take

00:02:56.606 --> 00:02:57.642
a account id,

00:02:57.722 --> 00:02:58.482
a link id,

00:02:58.482 --> 00:03:01.082
a destination URL and a destination country code.

00:03:01.082 --> 00:03:02.652
The same information that's going to go here.

00:03:02.652 --> 00:03:03.198
And then

00:03:03.758 --> 00:03:05.918
we can just kind of prepare this information

00:03:06.318 --> 00:03:06.958
in a

00:03:08.119 --> 00:03:08.619
variable

00:03:08.664 --> 00:03:10.340
and then let's just say,

00:03:10.980 --> 00:03:13.380
let's just save this into our in memory object.

00:03:13.380 --> 00:03:13.607
So

00:03:13.607 --> 00:03:14.027
you know what,

00:03:14.027 --> 00:03:15.947
what we could probably do is we could probably

00:03:15.947 --> 00:03:16.747
just go like this,

00:03:17.067 --> 00:03:18.587
keep it a little bit more clean.

00:03:19.869 --> 00:03:20.349
Okay.

00:03:21.069 --> 00:03:21.709
And then

00:03:22.189 --> 00:03:25.469
so we're basically saving this data into our

00:03:25.469 --> 00:03:26.029
clink,

00:03:26.109 --> 00:03:27.069
click data,

00:03:28.329 --> 00:03:28.969
property

00:03:29.369 --> 00:03:30.409
that is in memory.

00:03:30.729 --> 00:03:32.649
And then we're also going to want to make sure we

00:03:32.649 --> 00:03:33.849
flush this to

00:03:35.319 --> 00:03:36.919
we flush this to storage.

00:03:36.999 --> 00:03:37.310
So

00:03:39.072 --> 00:03:40.592
make sure we reference this.

00:03:40.752 --> 00:03:43.152
So we're setting this data and then we're passing

00:03:43.152 --> 00:03:44.912
it into our storage.

00:03:45.270 --> 00:03:47.341
Now once we have this information saved,

00:03:47.341 --> 00:03:48.301
what do we do?

00:03:48.541 --> 00:03:48.941
Like

00:03:49.341 --> 00:03:51.181
we're going to want to run a workflow.

00:03:51.421 --> 00:03:53.701
Now we could just basically like come into here

00:03:53.701 --> 00:03:55.421
and say this.emv.

00:03:57.985 --> 00:04:00.265
and in order to get our type hinting,

00:04:00.265 --> 00:04:02.785
we're going to want to make sure we pass our EMV

00:04:02.865 --> 00:04:05.065
as a generic at the top level of this.

00:04:05.065 --> 00:04:06.625
So we can basically say emv.

00:04:07.505 --> 00:04:09.585
Now what we're able to do is we're able to say

00:04:12.245 --> 00:04:12.965
evaluation,

00:04:14.405 --> 00:04:15.085
what do we call it?

00:04:15.085 --> 00:04:17.605
Evaluation workflow I think was the name

00:04:19.225 --> 00:04:20.945
Destination evaluation workflow.

00:04:20.945 --> 00:04:22.985
And then we could say create and we could run,

00:04:23.065 --> 00:04:24.745
we could pass in some data into here.

00:04:24.745 --> 00:04:25.145
Now

00:04:25.465 --> 00:04:25.865
this,

00:04:26.025 --> 00:04:26.505
you know,

00:04:26.505 --> 00:04:27.225
like would work,

00:04:27.225 --> 00:04:29.345
but basically what would happen is we'd be running

00:04:29.345 --> 00:04:29.625
this

00:04:29.796 --> 00:04:31.874
workflow every single link click that we got and

00:04:31.874 --> 00:04:34.034
it would be expensive and really unnecessary.

00:04:34.034 --> 00:04:37.034
So this is the perfect use case for alarms where

00:04:37.034 --> 00:04:39.514
we could get some data in our durable object and

00:04:39.514 --> 00:04:40.674
then we can manage and say,

00:04:40.674 --> 00:04:41.074
hey,

00:04:41.074 --> 00:04:43.354
in two days from now and five days from now and 10

00:04:43.354 --> 00:04:44.034
minutes from now,

00:04:44.484 --> 00:04:45.444
I want to run

00:04:46.074 --> 00:04:48.954
an alarm that like executes some code and the code

00:04:48.954 --> 00:04:50.754
that's going to be executed is the creation of

00:04:50.754 --> 00:04:51.594
that workflow,

00:04:51.674 --> 00:04:51.954
so,

00:04:51.954 --> 00:04:52.234
or

00:04:52.714 --> 00:04:55.314
of that specific destination evaluation workflow.

00:04:55.314 --> 00:04:55.674
So,

00:04:55.984 --> 00:04:56.638
what we could do

00:04:56.914 --> 00:04:59.154
is we can grab our alarm.

00:04:59.394 --> 00:05:01.794
So inside of the context,

00:05:02.994 --> 00:05:04.194
inside of storage,

00:05:04.434 --> 00:05:05.234
there's also

00:05:05.554 --> 00:05:05.954
this,

00:05:06.394 --> 00:05:06.874
property

00:05:07.534 --> 00:05:08.294
called alarm.

00:05:08.294 --> 00:05:10.414
And we can get the alarm

00:05:10.894 --> 00:05:13.854
and this is going to be a number or it's going to

00:05:13.854 --> 00:05:14.374
be null.

00:05:14.374 --> 00:05:15.254
And if it's null,

00:05:15.254 --> 00:05:17.814
that means no alarm is currently set for this

00:05:17.814 --> 00:05:18.734
durable object.

00:05:18.814 --> 00:05:20.894
So if there is no alarm,

00:05:23.820 --> 00:05:25.380
what we can do is we can say,

00:05:25.380 --> 00:05:28.060
let's wait a certain period of time from now.

00:05:28.060 --> 00:05:29.320
So I can say constant,

00:05:30.080 --> 00:05:30.320
10

00:05:31.022 --> 00:05:31.742
seconds.

00:05:31.864 --> 00:05:34.904
And I'm using a moment library.

00:05:34.904 --> 00:05:38.344
You can use like date dot now and then you can

00:05:38.344 --> 00:05:38.584
like,

00:05:38.584 --> 00:05:39.064
plus,

00:05:39.224 --> 00:05:39.784
you know,

00:05:40.264 --> 00:05:41.304
however many,

00:05:41.744 --> 00:05:42.324
however many,

00:05:42.324 --> 00:05:42.684
like

00:05:43.164 --> 00:05:45.804
epoch milliseconds are going to be,

00:05:45.884 --> 00:05:46.324
you know,

00:05:46.324 --> 00:05:47.724
10 seconds from the current time.

00:05:47.884 --> 00:05:50.204
But moment makes it a lot easier in my opinion.

00:05:50.204 --> 00:05:51.724
So we can say moment,

00:05:52.744 --> 00:05:53.784
and then I'm going to say

00:05:54.184 --> 00:05:56.184
this means moment dot now and this is going to be

00:05:56.184 --> 00:05:58.024
in utc and we can say add,

00:05:58.944 --> 00:06:00.704
three or let's add ten.

00:06:01.424 --> 00:06:03.824
And the unit is going to be seconds.

00:06:05.024 --> 00:06:06.464
And then what you want to do,

00:06:06.464 --> 00:06:08.064
because this is not going to be,

00:06:08.064 --> 00:06:09.664
this is going to be a type moment,

00:06:09.744 --> 00:06:11.744
we're going to need to make sure we say value of

00:06:11.904 --> 00:06:13.624
and that's going to convert that into like an

00:06:13.624 --> 00:06:14.544
epoch milli

00:06:14.584 --> 00:06:15.084
timestamp,

00:06:15.084 --> 00:06:16.684
which is a numeric value.

00:06:17.164 --> 00:06:19.244
Then the last thing you do is you say await

00:06:19.864 --> 00:06:23.104
this.uhctx.uhstorage.

00:06:23.104 --> 00:06:25.864
set alarm and then you're going to pass in this

00:06:25.864 --> 00:06:26.184
time.

00:06:26.184 --> 00:06:28.664
So right now we're just adding an alarm 10 seconds

00:06:28.664 --> 00:06:29.064
from now,

00:06:29.304 --> 00:06:29.944
and then,

00:06:30.424 --> 00:06:30.684
later,

00:06:30.684 --> 00:06:31.084
you know,

00:06:31.084 --> 00:06:32.324
we're going to kind of tweak this time.

00:06:32.324 --> 00:06:32.644
Now,

00:06:32.884 --> 00:06:33.684
this logic,

00:06:33.684 --> 00:06:35.484
you could like set an alarm and you could

00:06:35.484 --> 00:06:37.364
basically check if the user is paid or not.

00:06:37.744 --> 00:06:38.944
you do a lot of stuff here.

00:06:39.024 --> 00:06:41.904
Or you could also push that into the alarm

00:06:41.904 --> 00:06:42.184
function,

00:06:42.184 --> 00:06:43.464
which we're going to build out right now.

00:06:43.464 --> 00:06:45.024
There's a lot of different ways of doing this.

00:06:45.024 --> 00:06:46.624
I'm just kind of keeping this simple just so you

00:06:46.624 --> 00:06:47.024
can understand,

00:06:47.104 --> 00:06:48.144
like add,

00:06:48.574 --> 00:06:49.214
a base level,

00:06:49.694 --> 00:06:51.454
what the alarm is and how to use it.

00:06:51.454 --> 00:06:54.734
So now let's actually utilize the alarm method.

00:06:55.184 --> 00:06:57.984
so if we want to capture when this alarm fires 10

00:06:57.984 --> 00:06:59.024
seconds into the future,

00:06:59.424 --> 00:07:00.944
what we're going to want to do is we're going to

00:07:00.944 --> 00:07:02.944
want to capture that so we can say alarm.

00:07:03.424 --> 00:07:05.824
And you do get some additional properties like you

00:07:05.824 --> 00:07:07.704
can pass in some alarm information here.

00:07:07.704 --> 00:07:09.504
We're not going to really worry about that.

00:07:09.824 --> 00:07:12.184
We're just going to be triggering the alarm and

00:07:12.184 --> 00:07:14.704
then we can basically say console log,

00:07:16.139 --> 00:07:18.379
the evaluation scheduler alarm triggered.

00:07:18.539 --> 00:07:18.939
So

00:07:19.769 --> 00:07:21.539
from there it's basically going to say,

00:07:21.539 --> 00:07:21.899
all right,

00:07:21.899 --> 00:07:22.659
we're going to

00:07:23.139 --> 00:07:25.819
run this code when the alarm triggers 10 seconds

00:07:25.819 --> 00:07:26.420
into the future

00:07:26.791 --> 00:07:27.071
now.

00:07:27.071 --> 00:07:28.391
So when this alarm fires,

00:07:28.711 --> 00:07:30.471
we can trigger this,

00:07:30.471 --> 00:07:31.671
we can trigger our workflow.

00:07:31.671 --> 00:07:35.031
So we can say await this EMV.

00:07:35.831 --> 00:07:37.671
destination evaluation workflow.

00:07:37.671 --> 00:07:40.391
So we're grabbing our workflow that runs all of

00:07:40.391 --> 00:07:42.551
the steps to actually check if a web page is

00:07:42.551 --> 00:07:43.191
healthy or not.

00:07:43.351 --> 00:07:43.911
And then

00:07:44.211 --> 00:07:46.851
in order to programmatically trigger the workflow,

00:07:47.091 --> 00:07:48.211
you can say create.

00:07:49.011 --> 00:07:51.171
Now what we're going to notice here is create

00:07:52.051 --> 00:07:54.451
is basically saying you have like the,

00:07:54.451 --> 00:07:56.931
you have optional options into here and

00:07:57.491 --> 00:07:59.891
the workflow create options are unknown.

00:07:59.970 --> 00:08:01.571
Now the reason why it's unknown

00:08:01.891 --> 00:08:03.771
because technically we are going to be passing in

00:08:03.771 --> 00:08:04.611
data into create.

00:08:04.611 --> 00:08:05.851
We're going to be passing in some of this

00:08:05.851 --> 00:08:06.931
information into create.

00:08:07.411 --> 00:08:09.531
But this isn't type hinted for us.

00:08:09.531 --> 00:08:09.741
It's.

00:08:09.811 --> 00:08:11.971
And this isn't type hinted for us just because of

00:08:12.461 --> 00:08:13.421
the specific,

00:08:14.163 --> 00:08:17.290
the specific type inside of our workflow that we

00:08:17.290 --> 00:08:18.050
have defined.

00:08:18.130 --> 00:08:20.530
So notice that we have these params that we pass

00:08:20.530 --> 00:08:24.450
in and this makes it so our params in our payload

00:08:24.530 --> 00:08:25.490
are all typed.

00:08:25.890 --> 00:08:27.250
Now if we drill into that,

00:08:27.570 --> 00:08:30.370
I've defined this inside of a

00:08:30.690 --> 00:08:32.240
file called ServiceBindings

00:08:32.240 --> 00:08:32.990
d ts

00:08:33.240 --> 00:08:36.240
and what that does is it creates a EMV which

00:08:36.240 --> 00:08:39.680
extends the Cloudflare EMV which is inside of this

00:08:39.680 --> 00:08:40.800
worker configuration.

00:08:40.800 --> 00:08:42.600
So you notice we have this.

00:08:42.680 --> 00:08:45.480
So the reason why I've created the secondary

00:08:45.480 --> 00:08:46.520
service bindings

00:08:46.720 --> 00:08:50.220
type file is for this specific situation where

00:08:50.220 --> 00:08:52.820
there are input properties inside of a workflow

00:08:53.060 --> 00:08:54.820
that we are not able to

00:08:55.700 --> 00:08:55.800
get

00:08:55.880 --> 00:08:58.440
type hints inside of our code just because

00:08:59.000 --> 00:09:01.120
this workflow isn't able to pick up that specific,

00:09:01.120 --> 00:09:02.640
like the specific input types.

00:09:02.640 --> 00:09:05.120
So what I like to do is I like to basically take

00:09:05.120 --> 00:09:05.640
this guy

00:09:06.067 --> 00:09:06.534
and this,

00:09:06.534 --> 00:09:07.814
this file is auto generated.

00:09:07.814 --> 00:09:08.294
So you never,

00:09:08.294 --> 00:09:10.534
you never want to modify anything inside of here.

00:09:10.614 --> 00:09:11.334
But because

00:09:11.894 --> 00:09:14.614
this interface extends our cloudflare emv,

00:09:14.694 --> 00:09:17.454
what we can do is we can also override our

00:09:17.454 --> 00:09:19.334
destination evaluation workflow.

00:09:19.770 --> 00:09:21.250
And once we have this set up,

00:09:21.250 --> 00:09:23.290
what we're going to notice is when we head back

00:09:23.290 --> 00:09:24.810
over to our alarm

00:09:25.290 --> 00:09:27.050
that is actually creating this workflow,

00:09:27.210 --> 00:09:28.570
we can pass in this data.

00:09:28.570 --> 00:09:29.450
So we can say

00:09:29.770 --> 00:09:30.650
params

00:09:31.050 --> 00:09:34.130
and params is going to be basically giving us a

00:09:34.130 --> 00:09:37.050
type error because it knows that we are missing

00:09:37.050 --> 00:09:39.690
the following properties from our destination

00:09:40.170 --> 00:09:40.810
status

00:09:41.000 --> 00:09:42.200
evaluation param.

00:09:42.280 --> 00:09:42.425
So

00:09:42.425 --> 00:09:44.810
from here Essentially what we can do is we can

00:09:44.810 --> 00:09:46.210
pass in this information that's needed.

00:09:46.210 --> 00:09:46.930
So we need a link ID,

00:09:46.930 --> 00:09:47.720
a destination and

00:09:47.720 --> 00:09:48.370
account ID.

00:09:48.530 --> 00:09:49.650
So we can say

00:09:50.140 --> 00:09:55.140
link ID is going to be this.link click data.link

00:09:55.140 --> 00:09:55.420
ID.

00:09:55.896 --> 00:09:56.480
Oh yeah,

00:09:56.480 --> 00:09:58.640
and one additional thing that I want to do is I

00:09:58.640 --> 00:09:59.120
basically,

00:09:59.280 --> 00:10:01.200
I want to pull this out so we can say

00:10:01.520 --> 00:10:02.320
click data

00:10:03.440 --> 00:10:04.080
equals

00:10:04.550 --> 00:10:04.950
this

00:10:05.270 --> 00:10:06.230
dot click data.

00:10:06.710 --> 00:10:09.150
And because click data can be undefined,

00:10:09.150 --> 00:10:10.786
we're basically going to say if

00:10:11.642 --> 00:10:12.042
not

00:10:12.952 --> 00:10:15.432
click data for now let's just throw an error.

00:10:20.792 --> 00:10:21.192
Because

00:10:21.672 --> 00:10:23.832
this alarm should never be triggered if we have

00:10:23.832 --> 00:10:24.552
never set,

00:10:25.272 --> 00:10:28.351
if we have never set our click data inside of this

00:10:28.351 --> 00:10:28.751
method.

00:10:28.751 --> 00:10:29.112
So

00:10:29.432 --> 00:10:31.512
this is just kind of like a application

00:10:31.752 --> 00:10:33.112
implementation specific

00:10:33.212 --> 00:10:34.112
logic that we have.

00:10:34.112 --> 00:10:34.952
So we can say

00:10:35.312 --> 00:10:35.672
click

00:10:35.992 --> 00:10:36.392
data

00:10:36.952 --> 00:10:37.832
not set.

00:10:37.992 --> 00:10:38.752
Now you know,

00:10:38.752 --> 00:10:40.632
in a production system what you'd probably want to

00:10:40.632 --> 00:10:41.912
do is you'd probably want to

00:10:42.712 --> 00:10:42.772
catch

00:10:42.932 --> 00:10:44.952
this error error and then you know,

00:10:44.952 --> 00:10:47.512
send it to like whatever service you're using for

00:10:47.512 --> 00:10:48.152
like tracing.

00:10:48.152 --> 00:10:50.112
So you could send it like post hog and you could

00:10:50.112 --> 00:10:51.832
see those errors and you could build alerting

00:10:51.832 --> 00:10:53.352
because this is something that should never

00:10:53.352 --> 00:10:53.672
happen.

00:10:53.912 --> 00:10:54.712
But now

00:10:55.032 --> 00:10:57.512
what we can do is we can basically remove this

00:10:57.832 --> 00:11:00.032
so we can reference the click data that we've

00:11:00.032 --> 00:11:00.996
pulled out at this level

00:11:00.996 --> 00:11:01.265
and

00:11:01.585 --> 00:11:02.865
we can basically say

00:11:03.075 --> 00:11:03.555
link.

00:11:04.115 --> 00:11:06.835
We can say account ID is going to be clickdata

00:11:06.995 --> 00:11:07.795
account ID

00:11:08.385 --> 00:11:11.145
and then the destination URL is going to be click

00:11:11.145 --> 00:11:12.645
data.um,

00:11:12.865 --> 00:11:15.265
no destination URL right here.

00:11:15.265 --> 00:11:15.665
So

00:11:16.225 --> 00:11:18.545
from here we're able to trigger this workflow and

00:11:18.625 --> 00:11:20.225
we're able to make this so it is

00:11:20.475 --> 00:11:21.015
typed.

00:11:21.015 --> 00:11:23.375
So like if we have a property that is supposed to

00:11:23.375 --> 00:11:23.735
be in here,

00:11:23.735 --> 00:11:24.615
it's going to throw an error,

00:11:24.615 --> 00:11:25.535
which is really nice.

00:11:25.615 --> 00:11:26.015
So

00:11:26.495 --> 00:11:28.295
from here this is kind of recap what we've done

00:11:28.295 --> 00:11:31.535
before we deploy this guy is we have a,

00:11:31.615 --> 00:11:32.895
we have our durable object.

00:11:33.055 --> 00:11:34.775
We have some data that's going to be passed into

00:11:34.775 --> 00:11:35.615
our durable object.

00:11:35.615 --> 00:11:36.975
That data is defined

00:11:37.355 --> 00:11:39.505
in at the top level property of this class

00:11:39.825 --> 00:11:42.385
and then it is also backed up into storage.

00:11:42.465 --> 00:11:44.862
When the class starts up for the very first time,

00:11:44.954 --> 00:11:46.954
we pull the click data

00:11:47.164 --> 00:11:48.754
from storage and we save it.

00:11:48.994 --> 00:11:49.554
And then

00:11:49.732 --> 00:11:51.161
whenever we get a link click,

00:11:51.161 --> 00:11:53.121
we call this method and we pass in that

00:11:53.121 --> 00:11:55.201
information from a link click into

00:11:55.761 --> 00:11:56.161
this

00:11:56.541 --> 00:11:57.661
into this method.

00:11:57.981 --> 00:11:59.981
It gets saved in memory

00:12:00.321 --> 00:12:02.521
and it also gets backed up into store into

00:12:02.521 --> 00:12:03.041
storage.

00:12:03.041 --> 00:12:05.521
Then we grab an alarm and we basically say if

00:12:05.521 --> 00:12:07.281
there is no alarm scheduled into the future,

00:12:07.681 --> 00:12:09.041
let's schedule it out right now.

00:12:09.041 --> 00:12:10.481
We're doing 10 seconds in the future,

00:12:10.481 --> 00:12:11.801
we're probably going to change this to like three

00:12:11.801 --> 00:12:12.361
days or something.

00:12:12.361 --> 00:12:12.801
Just so,

00:12:12.801 --> 00:12:13.841
like every three days,

00:12:13.841 --> 00:12:14.681
if we get a link,

00:12:14.681 --> 00:12:15.441
click for a destination,

00:12:15.441 --> 00:12:16.560
we'll do an evaluation.

00:12:16.881 --> 00:12:17.721
You could even do,

00:12:17.721 --> 00:12:18.121
you know,

00:12:18.121 --> 00:12:20.441
more like tricky stuff where it's like if there is

00:12:20.441 --> 00:12:21.081
no alarm,

00:12:21.081 --> 00:12:22.881
just set an alarm 10 seconds from now.

00:12:22.881 --> 00:12:26.081
And then if we have run an evaluation for a link,

00:12:26.081 --> 00:12:26.481
click,

00:12:26.881 --> 00:12:27.361
one time.

00:12:27.441 --> 00:12:28.641
Let's not do it,

00:12:29.041 --> 00:12:31.281
let's not do it like more than once every seven

00:12:31.281 --> 00:12:31.561
days.

00:12:31.561 --> 00:12:33.641
So all that logic can live inside of this durable

00:12:33.641 --> 00:12:33.961
object.

00:12:33.961 --> 00:12:34.321
For now,

00:12:34.321 --> 00:12:35.921
just very simple scheduling.

00:12:35.921 --> 00:12:36.961
10 seconds into the future,

00:12:37.201 --> 00:12:38.481
10 seconds into the future,

00:12:38.801 --> 00:12:41.481
a durable object is going to trigger the alarm,

00:12:41.481 --> 00:12:43.201
which means this method is called.

00:12:43.361 --> 00:12:45.401
And this method is grabbing our link,

00:12:45.401 --> 00:12:45.921
click data,

00:12:45.921 --> 00:12:47.121
making sure that we have it,

00:12:47.201 --> 00:12:49.241
and then it is passing that information into our

00:12:49.241 --> 00:12:49.641
workflow.

00:12:49.641 --> 00:12:50.668
And our workflow should run.

00:12:50.669 --> 00:12:51.903
So now before we deploy,

00:12:51.983 --> 00:12:54.343
we have to make sure that this durable object is

00:12:54.343 --> 00:12:56.223
integrated into our queue system.

00:12:56.543 --> 00:12:59.583
So essentially once we get to the step it's picked

00:12:59.583 --> 00:13:00.543
up by the consumer,

00:13:00.543 --> 00:13:02.263
we're going to want to make sure the consumer has

00:13:02.263 --> 00:13:04.343
access to that durable object and creates a

00:13:04.343 --> 00:13:06.783
durable object instance and passes data into it.

00:13:06.863 --> 00:13:09.063
So what we're going to do is we can head over to

00:13:09.063 --> 00:13:11.183
our queue handler and we have this link click.

00:13:11.823 --> 00:13:12.223
now

00:13:12.863 --> 00:13:14.823
for now what I'm going to do is I'm just going to

00:13:14.823 --> 00:13:15.263
basically,

00:13:16.313 --> 00:13:17.513
put this inside of here.

00:13:17.513 --> 00:13:19.633
We probably pull it out into a method in a minute,

00:13:19.633 --> 00:13:21.873
but we can follow the same convention that we did

00:13:21.873 --> 00:13:23.673
in the last video to get our durable object.

00:13:23.673 --> 00:13:26.313
So we're basically going to get a durable object

00:13:26.313 --> 00:13:26.713
id

00:13:27.193 --> 00:13:29.993
and that durable object ID is going to be some,

00:13:30.073 --> 00:13:33.473
is going to contain the destination URL and the

00:13:33.473 --> 00:13:34.233
link id

00:13:34.553 --> 00:13:35.353
for a given,

00:13:36.353 --> 00:13:38.153
for a given event into here.

00:13:38.153 --> 00:13:38.513
So

00:13:38.937 --> 00:13:40.297
we can basically say

00:13:40.474 --> 00:13:41.734
emv dot

00:13:42.854 --> 00:13:44.374
evaluation scheduler.

00:13:44.454 --> 00:13:44.854
And

00:13:45.254 --> 00:13:47.414
I just realized that this is spelled wrong.

00:13:47.994 --> 00:13:48.794
should be an E.

00:13:48.794 --> 00:13:49.144
Okay,

00:13:49.144 --> 00:13:49.874
whatever you can,

00:13:49.874 --> 00:13:50.794
we can change this later.

00:13:50.804 --> 00:13:53.264
and then we're going to say ID from name ID from

00:13:53.264 --> 00:13:54.624
name is going to take in

00:13:55.344 --> 00:13:55.744
our

00:13:56.624 --> 00:13:56.644
event,

00:13:56.644 --> 00:13:59.914
uh.event.data.

00:14:01.267 --> 00:14:04.537
ID

00:14:05.177 --> 00:14:07.737
and then it's also going to get our destination

00:14:07.817 --> 00:14:08.497
URL.

00:14:08.497 --> 00:14:09.417
So we can say

00:14:10.217 --> 00:14:12.617
event.data.

00:14:13.097 --> 00:14:13.737
destination.

00:14:14.057 --> 00:14:16.937
So this is going to be unique based upon a link ID

00:14:17.097 --> 00:14:19.337
and a destination URL.

00:14:20.217 --> 00:14:21.577
Then now that we have that

00:14:22.287 --> 00:14:23.407
terrible object id,

00:14:23.407 --> 00:14:24.607
let's create a stub which is,

00:14:24.757 --> 00:14:27.077
is an instance of our durable object and we can

00:14:27.077 --> 00:14:28.889
basically say v.uh

00:14:28.889 --> 00:14:31.561
v.uh evaluation scheduler,

00:14:32.041 --> 00:14:32.441
get

00:14:32.761 --> 00:14:34.521
pass in our durable object ID.

00:14:35.745 --> 00:14:37.024
Now that we have the stub,

00:14:37.185 --> 00:14:37.545
let's

00:14:38.425 --> 00:14:41.945
stub.collect link click.

00:14:42.425 --> 00:14:43.505
Now collect link click.

00:14:43.505 --> 00:14:44.345
Takes an account ID,

00:14:44.345 --> 00:14:45.145
a link ID,

00:14:45.305 --> 00:14:46.425
destination URL,

00:14:46.865 --> 00:14:47.745
a country code.

00:14:47.745 --> 00:14:48.145
So

00:14:48.465 --> 00:14:50.625
we can come in and we can say,

00:14:51.625 --> 00:14:53.498
first thing is going to be data.event.data.account

00:14:53.498 --> 00:14:53.799
data.event.data.account

00:14:54.539 --> 00:14:57.869
ID.

00:14:57.918 --> 00:15:02.740
And we're going to say event data.the ID which is

00:15:02.740 --> 00:15:05.408
our link ID event data.

00:15:05.672 --> 00:15:06.860
Destination

00:15:07.740 --> 00:15:08.700
and then event

00:15:09.020 --> 00:15:10.870
data.country.

00:15:11.270 --> 00:15:13.190
and it looks like country is optional.

00:15:13.430 --> 00:15:13.830
So

00:15:13.874 --> 00:15:14.298
if it,

00:15:14.298 --> 00:15:15.258
if we don't have it,

00:15:15.258 --> 00:15:17.258
then we're basically just going to say

00:15:17.578 --> 00:15:17.978
or

00:15:21.414 --> 00:15:21.982
unknown.

00:15:22.942 --> 00:15:23.422
Cool.

00:15:23.502 --> 00:15:24.461
So now we have this,

00:15:24.461 --> 00:15:27.062
this data being passed into our durable object and

00:15:27.062 --> 00:15:29.022
our durable object is going to be triggered here.

00:15:29.182 --> 00:15:30.742
So the next thing that we're going to want to do

00:15:30.742 --> 00:15:32.342
is we're going to want to deploy and actually

00:15:32.342 --> 00:15:33.462
validate these changes.

00:15:33.462 --> 00:15:34.382
So data.

00:15:34.542 --> 00:15:36.502
So we're going to Get a URL,

00:15:36.502 --> 00:15:37.782
go to our Hono API.

00:15:37.862 --> 00:15:39.742
We're going to be redirected as the user,

00:15:39.742 --> 00:15:41.302
but in the background some data is going to be

00:15:41.302 --> 00:15:42.182
sent onto a queue.

00:15:42.182 --> 00:15:43.342
It's going to be put into a consumer,

00:15:43.342 --> 00:15:44.782
it's going to be saved into a database.

00:15:44.782 --> 00:15:47.422
Database is going to call a durable object.

00:15:47.422 --> 00:15:49.822
Durable object is going to manage an alarm that

00:15:49.822 --> 00:15:50.982
triggers our workflow.

00:15:51.062 --> 00:15:51.306
So

00:15:51.642 --> 00:15:52.122
hopefully,

00:15:52.122 --> 00:15:53.362
I mean this has kind of been a lot of code.

00:15:53.362 --> 00:15:54.442
Hopefully everything works.

00:15:54.602 --> 00:15:55.802
I suspect it will,

00:15:55.872 --> 00:15:57.102
let's say PNPM run

00:15:57.502 --> 00:15:58.669
deployment.

00:15:58.807 --> 00:15:59.167
Okay,

00:15:59.167 --> 00:16:01.367
we have successfully deployed this application.

00:16:01.367 --> 00:16:03.927
I'm going to head over to Cloudflare and I'm going

00:16:03.927 --> 00:16:06.167
to open our data service into

00:16:06.887 --> 00:16:08.007
its own tab.

00:16:08.967 --> 00:16:11.127
And then I'm also going to head over to workflows.

00:16:11.607 --> 00:16:12.007
Now

00:16:12.407 --> 00:16:14.647
I'm going to turn on real time log so we can see

00:16:14.647 --> 00:16:15.745
exactly what's happening here.

00:16:15.845 --> 00:16:18.645
And inside of our Smart Links user application,

00:16:18.805 --> 00:16:21.925
I just kind of went to one of the links that have

00:16:21.925 --> 00:16:23.685
like a legit URL associated with it.

00:16:23.685 --> 00:16:26.605
So this one specifically is going to redirect us

00:16:26.605 --> 00:16:27.717
to Google.

00:16:28.207 --> 00:16:30.607
so I'm going to basically come into here and I'm

00:16:30.607 --> 00:16:31.247
going to say

00:16:32.027 --> 00:16:32.827
data service.

00:16:32.987 --> 00:16:34.587
This should redirect us to Google.

00:16:35.227 --> 00:16:37.787
Now in here you can see that we got this link id.

00:16:38.337 --> 00:16:39.807
our queue should pick up really soon.

00:16:39.807 --> 00:16:41.287
Our queue just picked up really soon.

00:16:41.367 --> 00:16:44.007
10 seconds from now we should see a log that

00:16:44.567 --> 00:16:46.247
says our alarm is being triggered.

00:16:46.727 --> 00:16:49.447
And I'm going to come over to here and we should

00:16:49.447 --> 00:16:51.007
see this in just a few seconds.

00:16:51.007 --> 00:16:51.847
Another instance.

00:16:51.847 --> 00:16:53.447
So you can see one just queued up,

00:16:53.677 --> 00:16:54.237
which means

00:16:54.717 --> 00:16:55.917
it went through our

00:16:55.917 --> 00:16:57.327
it went through the entire flow.

00:16:57.487 --> 00:16:58.447
One just queued

00:16:59.117 --> 00:17:00.357
and the queue just finished.

00:17:00.357 --> 00:17:01.093
And you can see

00:17:01.233 --> 00:17:03.233
the last instances that we ran were actually

00:17:03.233 --> 00:17:05.713
yesterday and this one just barely triggered for

00:17:05.713 --> 00:17:06.033
today.

00:17:06.273 --> 00:17:08.633
So we come into here and we can see,

00:17:08.633 --> 00:17:09.153
oh look,

00:17:09.153 --> 00:17:09.793
the entire

00:17:10.453 --> 00:17:11.253
our entire

00:17:11.813 --> 00:17:13.253
workflow ran successfully.

00:17:13.333 --> 00:17:14.683
We rendered the page,

00:17:15.303 --> 00:17:17.523
we used AI to evaluate the page,

00:17:17.843 --> 00:17:18.243
we

00:17:18.643 --> 00:17:19.183
got the

00:17:19.323 --> 00:17:21.323
we saved the evaluation to the database and then

00:17:21.323 --> 00:17:22.923
we back some stuff up into R2.

00:17:23.163 --> 00:17:24.763
Now if we head over to R2

00:17:25.347 --> 00:17:26.707
we should be able to

00:17:27.027 --> 00:17:29.907
grab this ID that was saved into the database,

00:17:30.227 --> 00:17:32.947
head over to R2 and I want to see if we get that

00:17:33.247 --> 00:17:34.407
image that we've created.

00:17:34.407 --> 00:17:34.767
So

00:17:35.647 --> 00:17:37.247
so we can go to our evaluations,

00:17:37.247 --> 00:17:38.527
go to our specific

00:17:38.659 --> 00:17:38.919
account.

00:17:39.719 --> 00:17:41.319
So this is going to be this one.

00:17:41.639 --> 00:17:42.943
So this is the HTML.

00:17:42.943 --> 00:17:45.376
This is going to basically be HTML for Google.

00:17:45.376 --> 00:17:45.776
But

00:17:45.838 --> 00:17:48.487
because I added a screenshot logic,

00:17:48.487 --> 00:17:50.072
you should see that Google renders here.

00:17:50.072 --> 00:17:50.472
So yeah,

00:17:50.472 --> 00:17:51.592
we're able to pick up,

00:17:51.752 --> 00:17:54.392
render Google and it's able to actually like,

00:17:54.682 --> 00:17:54.962
you know,

00:17:54.962 --> 00:17:56.322
get that screenshot of what was rendered.

00:17:56.322 --> 00:17:57.082
So it's pretty cool.

00:17:57.082 --> 00:17:59.762
So we have essentially this entire pipeline built

00:17:59.762 --> 00:17:59.962
out.

00:17:59.962 --> 00:18:00.512
We have

00:18:00.512 --> 00:18:00.755
you know,

00:18:00.755 --> 00:18:01.555
just to recap,

00:18:01.555 --> 00:18:03.795
we have this logic that went to hono,

00:18:03.795 --> 00:18:06.635
redirected based upon the destination of a given

00:18:06.635 --> 00:18:07.315
link id,

00:18:07.395 --> 00:18:08.555
sent some data to a queue,

00:18:08.555 --> 00:18:09.715
a consumer picked it up,

00:18:09.795 --> 00:18:11.395
saved some data into a database,

00:18:11.475 --> 00:18:12.595
went into an alarm.

00:18:13.515 --> 00:18:16.395
we went to alarm and then the or to a durable

00:18:16.395 --> 00:18:16.675
object.

00:18:16.675 --> 00:18:18.715
Durable object said 10 seconds from now we're

00:18:18.715 --> 00:18:19.515
going to run a workflow.

00:18:19.515 --> 00:18:21.475
The workflow triggered and all of these steps went

00:18:21.475 --> 00:18:21.675
through.

00:18:21.675 --> 00:18:22.795
So at this point we have

00:18:23.195 --> 00:18:23.355
really,

00:18:23.355 --> 00:18:24.205
really advanced

00:18:24.555 --> 00:18:25.595
data pipeline.

00:18:25.755 --> 00:18:27.475
And you know you could just see like this is

00:18:27.475 --> 00:18:29.075
actually really simple but you could,

00:18:29.075 --> 00:18:29.995
this is so modular.

00:18:29.995 --> 00:18:31.555
You could extend this so you could come in,

00:18:31.555 --> 00:18:32.435
you could basically say like,

00:18:32.435 --> 00:18:32.675
okay,

00:18:32.675 --> 00:18:32.875
yeah,

00:18:32.875 --> 00:18:33.595
I've been running

00:18:33.955 --> 00:18:35.555
these workflows people for people,

00:18:35.555 --> 00:18:36.115
for free.

00:18:36.115 --> 00:18:38.035
I'm going to make this a paid product.

00:18:38.195 --> 00:18:40.355
So you could come into your durable object and you

00:18:40.355 --> 00:18:42.435
could add some additional logic to basically say

00:18:42.435 --> 00:18:43.715
like when the alarm triggers,

00:18:43.715 --> 00:18:45.235
let's go check the user's account,

00:18:45.235 --> 00:18:46.075
let's see if that,

00:18:46.075 --> 00:18:47.035
let's see if they're paid.

00:18:47.035 --> 00:18:48.505
And if they're not paid then you,

00:18:48.575 --> 00:18:48.775
you know,

00:18:48.775 --> 00:18:50.775
let's not run it and let's maybe send them an

00:18:50.775 --> 00:18:51.495
email and say like,

00:18:51.495 --> 00:18:51.775
hey,

00:18:51.775 --> 00:18:53.295
like you have ten,

00:18:53.575 --> 00:18:53.715
you,

00:18:53.715 --> 00:18:55.355
you've received like a hundred link clicks this

00:18:55.355 --> 00:18:55.635
month.

00:18:56.475 --> 00:18:57.035
you know,

00:18:57.035 --> 00:18:59.275
we have determined that a few of these links might

00:18:59.275 --> 00:18:59.755
not be

00:19:00.155 --> 00:19:01.275
working as expected.

00:19:01.435 --> 00:19:02.875
Would you like to enable,

00:19:03.504 --> 00:19:04.705
would you like to enable the,

00:19:04.705 --> 00:19:05.025
our

00:19:05.425 --> 00:19:05.985
AI,

00:19:06.225 --> 00:19:06.665
you know,

00:19:06.665 --> 00:19:08.945
our smart AI system to evaluate the,

00:19:08.945 --> 00:19:10.385
the web pages and whatnot.

00:19:10.385 --> 00:19:10.785
So like,

00:19:10.785 --> 00:19:12.385
there's a lot of stuff that you could do in here.

00:19:12.495 --> 00:19:13.775
it's really up to you to decide.

00:19:13.775 --> 00:19:15.655
But I do like designing this way because the

00:19:15.655 --> 00:19:16.975
entire system is really modular.

00:19:17.135 --> 00:19:18.735
If I want to manage scheduling,

00:19:18.735 --> 00:19:21.095
I can just like manage this durable object if I

00:19:21.095 --> 00:19:23.015
want to manage the features inside of a workflow.

00:19:23.015 --> 00:19:25.415
Because as you noticed like before we had a

00:19:25.415 --> 00:19:27.935
pipeline that would just get the HTML and would

00:19:27.935 --> 00:19:28.415
get the

00:19:29.345 --> 00:19:29.705
the,

00:19:29.705 --> 00:19:30.625
the body text,

00:19:30.945 --> 00:19:31.465
analyze,

00:19:31.465 --> 00:19:32.105
save in database,

00:19:32.105 --> 00:19:32.665
go to R2.

00:19:32.665 --> 00:19:33.305
But then I was like,

00:19:33.305 --> 00:19:33.505
oh,

00:19:33.505 --> 00:19:33.625
well,

00:19:33.625 --> 00:19:34.865
I want to debug what's happening.

00:19:34.945 --> 00:19:37.665
So I just enhanced the browser rendering aspect of

00:19:37.665 --> 00:19:40.365
it to also take a screenshot and then also save

00:19:40.365 --> 00:19:41.125
that into R2.

00:19:41.125 --> 00:19:42.685
So this entire system is very,

00:19:42.685 --> 00:19:43.845
very modular and it's really,

00:19:43.845 --> 00:19:44.885
really easy to maintain.

00:19:45.075 --> 00:19:47.035
so from here there's like a lot of directions that

00:19:47.035 --> 00:19:47.487
we can go.

00:19:47.487 --> 00:19:49.607
Now I do want to call out one thing just in case

00:19:49.607 --> 00:19:50.647
it wasn't super clear.

00:19:50.807 --> 00:19:51.207
Now

00:19:51.687 --> 00:19:54.007
we've set this alarm for 10 seconds.

00:19:54.167 --> 00:19:56.487
I want to probably say like,

00:19:56.487 --> 00:19:57.047
let's do

00:19:57.367 --> 00:19:58.327
24 hours

00:19:58.631 --> 00:19:59.705
or we'll just say one

00:20:00.025 --> 00:20:02.345
day and we're going to say 24

00:20:03.207 --> 00:20:03.447
hours

00:20:03.770 --> 00:20:04.789
and we're going to pass this in.

00:20:05.029 --> 00:20:06.949
Now the reason why we're doing it this way,

00:20:06.949 --> 00:20:07.989
in case it wasn't clear,

00:20:07.989 --> 00:20:10.349
is essentially what happens is when we get this

00:20:10.349 --> 00:20:11.909
link click and we go to Google,

00:20:12.229 --> 00:20:14.909
we could get that same link click from people all

00:20:14.909 --> 00:20:16.629
around the world going to the same destination.

00:20:16.709 --> 00:20:18.389
We could get 10,000 of them,

00:20:18.389 --> 00:20:19.829
we could get 20,000 of them,

00:20:19.989 --> 00:20:23.749
but we're only going to be running the workflow

00:20:23.829 --> 00:20:24.549
one time,

00:20:24.899 --> 00:20:26.129
in this 24 hour period.

00:20:26.289 --> 00:20:28.769
So this would make your system scale and it's

00:20:28.769 --> 00:20:30.089
really easy to basically say like,

00:20:30.089 --> 00:20:30.449
you know,

00:20:30.449 --> 00:20:32.988
I only want to run workflows for one destination

00:20:33.548 --> 00:20:34.268
URL,

00:20:34.398 --> 00:20:35.118
in a given

00:20:35.438 --> 00:20:37.038
window in a given period of time.

00:20:37.278 --> 00:20:38.878
Even if a link click gets

00:20:39.198 --> 00:20:41.718
500,000 clicks or 1 million clicks or you know,

00:20:41.718 --> 00:20:42.958
100 million clicks,

00:20:43.118 --> 00:20:44.558
you're not going to have to like,

00:20:44.718 --> 00:20:45.278
you know,

00:20:45.278 --> 00:20:47.678
have a workflow that is running so many times.

00:20:47.678 --> 00:20:49.758
So you're able to really control your spend and

00:20:49.758 --> 00:20:51.438
your logic here at this level,

00:20:51.438 --> 00:20:52.078
which is really,

00:20:52.078 --> 00:20:52.318
really,

00:20:52.318 --> 00:20:52.958
really nice.

00:20:53.079 --> 00:20:54.872
So now before we conclude this video,

00:20:54.952 --> 00:20:57.112
I want to take this logic

00:20:57.603 --> 00:20:58.963
and let's move this into

00:20:59.443 --> 00:21:00.883
its own function.

00:21:00.883 --> 00:21:03.283
So we have our helper functions and let's see what

00:21:03.283 --> 00:21:04.003
we have in there.

00:21:04.083 --> 00:21:07.203
So inside of our helper functions we have our

00:21:07.743 --> 00:21:08.443
route ops.

00:21:08.443 --> 00:21:09.963
I think that's kind of where we're going to want

00:21:09.963 --> 00:21:10.443
to put it.

00:21:10.443 --> 00:21:13.763
So right now link click is in Route Ops.

00:21:13.763 --> 00:21:15.523
I'm also going to create another

00:21:17.013 --> 00:21:19.013
class or another function into here.

00:21:19.013 --> 00:21:20.213
Let's just copy this guy.

00:21:20.373 --> 00:21:21.813
Let's go to Route Ops

00:21:22.213 --> 00:21:23.733
and let's say

00:21:24.213 --> 00:21:24.933
export,

00:21:26.858 --> 00:21:27.498
schedule,

00:21:28.361 --> 00:21:28.911
eval

00:21:29.871 --> 00:21:30.831
workflow.

00:21:31.071 --> 00:21:32.764
That's going to take an EMV

00:21:33.363 --> 00:21:35.083
and it's also going to be take,

00:21:35.083 --> 00:21:36.483
it's going to take link

00:21:36.963 --> 00:21:37.603
info.

00:21:44.693 --> 00:21:44.853
Oh,

00:21:44.853 --> 00:21:45.253
I forgot.

00:21:45.253 --> 00:21:46.613
This has to be an async

00:21:47.413 --> 00:21:48.053
function.

00:21:48.555 --> 00:21:50.430
Make sure that this is of the type emv.

00:21:50.830 --> 00:21:52.990
Then we can paste this stuff into here.

00:21:53.450 --> 00:21:53.850
and

00:21:54.410 --> 00:21:56.890
I think we can just call this event to make it

00:21:59.109 --> 00:21:59.332
cool.

00:21:59.340 --> 00:21:59.540
Yeah,

00:21:59.540 --> 00:22:01.860
I'm actually just going to call this link info and

00:22:01.860 --> 00:22:03.500
then we can say link info ID

00:22:04.460 --> 00:22:04.860
here.

00:22:09.907 --> 00:22:11.909
It actually looks like I'm referencing the wrong

00:22:11.909 --> 00:22:12.389
type here.

00:22:12.389 --> 00:22:15.029
This should actually be a link click message type.

00:22:15.029 --> 00:22:15.429
So

00:22:16.089 --> 00:22:17.849
let's just make sure we import that guy.

00:22:17.849 --> 00:22:20.249
And I'm just going to call this.

00:22:21.869 --> 00:22:22.429
just go back.

00:22:22.829 --> 00:22:24.189
I'm just going to undo these guys.

00:22:24.189 --> 00:22:25.709
We're going to keep this as event

00:22:26.189 --> 00:22:27.629
and I'm just going to say event

00:22:29.292 --> 00:22:30.651
and it's going to be

00:22:31.212 --> 00:22:31.612
the

00:22:32.332 --> 00:22:33.772
link click message type,

00:22:33.772 --> 00:22:35.012
make sure that is imported.

00:22:35.012 --> 00:22:36.412
Now this all should function.

00:22:36.412 --> 00:22:36.812
So,

00:22:37.272 --> 00:22:39.752
head back over to our link clicks,

00:22:40.232 --> 00:22:41.112
delete this stuff.

00:22:41.112 --> 00:22:43.032
And then we're just going to say await

00:22:44.152 --> 00:22:47.192
and we will pass in EMV and event

00:22:48.837 --> 00:22:50.217
and make sure it is imported.

00:22:50.217 --> 00:22:50.565
Cool.

00:22:50.725 --> 00:22:51.165
All right,

00:22:51.165 --> 00:22:53.445
so now we have a function that saves data into a

00:22:53.445 --> 00:22:53.925
database

00:22:54.325 --> 00:22:57.845
and then we have a method that basically schedules

00:22:57.845 --> 00:22:59.925
out our workflow for a given link click.

00:23:00.005 --> 00:23:01.565
So this is our queue handler,

00:23:01.565 --> 00:23:02.165
by the way,

00:23:02.165 --> 00:23:05.045
which is being utilized right inside of our

00:23:05.565 --> 00:23:06.013
consumer.

00:23:06.049 --> 00:23:06.449
Okay,

00:23:06.449 --> 00:23:08.289
so in this next video we're going to dive,

00:23:08.289 --> 00:23:09.936
we're going to be diving deeper into durable

00:23:09.936 --> 00:23:10.376
objects.

00:23:10.376 --> 00:23:11.936
We're actually going to start implementing some

00:23:11.936 --> 00:23:14.296
websockets and stuff for another feature now that

00:23:14.296 --> 00:23:15.616
we have a understanding of,

00:23:15.616 --> 00:23:16.096
you know,

00:23:16.096 --> 00:23:19.175
like the base class of a durable object and just,

00:23:19.175 --> 00:23:19.496
you know,

00:23:19.496 --> 00:23:21.536
like the very basics of how to

00:23:22.256 --> 00:23:22.296
utilize,

00:23:22.716 --> 00:23:23.676
it with storage,

00:23:23.676 --> 00:23:24.996
alarms and whatnot.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.060 --> 00:00:00.460
All right,

00:00:00.540 --> 00:00:03.820
so in this next section we're going to go go quite

00:00:03.820 --> 00:00:05.500
a bit deeper into durable objects.

00:00:05.500 --> 00:00:07.500
And we're going to be utilizing the Durable Object

00:00:07.500 --> 00:00:09.420
SQL API and WebSockets.

00:00:09.740 --> 00:00:11.980
The exact implementation that we're going to be

00:00:11.980 --> 00:00:14.060
building out is essentially this mapping feature.

00:00:14.060 --> 00:00:15.820
So you can see that you have a map of the world.

00:00:15.820 --> 00:00:18.380
You can kind of like break it down into regions as

00:00:18.380 --> 00:00:18.700
well.

00:00:18.940 --> 00:00:19.740
I wouldn't like,

00:00:19.740 --> 00:00:21.420
worry too much about the UI side of it.

00:00:21.420 --> 00:00:21.660
I,

00:00:21.660 --> 00:00:23.460
what I want to illustrate is how you would

00:00:23.460 --> 00:00:24.500
implement this on the back end.

00:00:24.500 --> 00:00:26.260
And essentially what's going to be happening is

00:00:26.260 --> 00:00:28.600
whenever a user around the world click clicks on a

00:00:28.600 --> 00:00:29.800
link in real time,

00:00:29.800 --> 00:00:31.000
right when they click that link,

00:00:31.080 --> 00:00:32.920
that you should be able to see that event,

00:00:33.110 --> 00:00:36.020
or that user as a little dot as to wherever they

00:00:36.020 --> 00:00:36.700
are in the world.

00:00:36.810 --> 00:00:38.120
I think it's a pretty cool use case.

00:00:38.120 --> 00:00:38.920
You could imagine

00:00:39.240 --> 00:00:41.520
building out a really sophisticated analytics

00:00:41.520 --> 00:00:41.720
tool.

00:00:41.720 --> 00:00:42.240
We're able,

00:00:42.240 --> 00:00:44.080
where you're able to track users that are clicking

00:00:44.080 --> 00:00:44.550
on links,

00:00:45.130 --> 00:00:45.850
on like a,

00:00:45.850 --> 00:00:46.210
you know,

00:00:46.210 --> 00:00:47.210
on a globe and stuff.

00:00:47.210 --> 00:00:48.570
But the actual like,

00:00:48.570 --> 00:00:49.770
UI of this is going to be very,

00:00:49.770 --> 00:00:50.330
very simple.

00:00:50.330 --> 00:00:52.010
We're going to go pretty deep on the back end

00:00:52.010 --> 00:00:52.410
though.

00:00:52.410 --> 00:00:52.810
Now,

00:00:52.890 --> 00:00:53.930
if you are

00:00:54.570 --> 00:00:55.850
a more experienced developer

00:00:56.170 --> 00:00:58.090
throughout like this implementation,

00:00:58.090 --> 00:01:00.290
what you're going to be thinking probably is like,

00:01:00.290 --> 00:01:00.530
wow,

00:01:00.530 --> 00:01:02.570
this is way overkill for what we're doing.

00:01:02.650 --> 00:01:04.410
And I would agree the,

00:01:04.410 --> 00:01:06.330
the core purpose of this section is actually to

00:01:06.330 --> 00:01:08.930
kind of like showcase how you would use the SQL

00:01:08.930 --> 00:01:11.970
API and also how you can use The Durable Objects

00:01:11.970 --> 00:01:14.650
WebSocket API in conjunction or separately.

00:01:15.400 --> 00:01:15.800
so like,

00:01:15.800 --> 00:01:17.240
I think this is like a really good,

00:01:17.700 --> 00:01:20.380
overview and implementation on how to build on top

00:01:20.380 --> 00:01:20.700
of it.

00:01:20.700 --> 00:01:22.940
But there are simpler ways to accomplish what

00:01:22.940 --> 00:01:23.620
we're accomplishing.

00:01:23.620 --> 00:01:24.820
One of those would just be like

00:01:25.180 --> 00:01:26.060
pulling your database,

00:01:26.060 --> 00:01:26.380
you know,

00:01:26.380 --> 00:01:28.180
every second to see if you got any new link

00:01:28.180 --> 00:01:28.460
clicks.

00:01:28.460 --> 00:01:30.420
I think that would be the better solution if you

00:01:30.420 --> 00:01:31.820
were to actually like roll this out.

00:01:31.820 --> 00:01:34.220
But WebSockets are really cool and there's a lot

00:01:34.220 --> 00:01:35.380
of use cases for them.

00:01:35.380 --> 00:01:37.220
So I do think that this is going to be some,

00:01:37.220 --> 00:01:38.940
a section where you're going to learn a lot.

00:01:39.020 --> 00:01:39.267
Now

00:01:39.267 --> 00:01:41.521
let's head over to our system system diagram to

00:01:41.521 --> 00:01:42.761
kind of see where this fits.

00:01:42.841 --> 00:01:45.561
So over here we have our ui and then this is our

00:01:45.561 --> 00:01:46.281
backend service.

00:01:46.281 --> 00:01:48.681
And our backend service like interfaces with a

00:01:48.681 --> 00:01:51.041
queue and it interfaces with our durable object

00:01:51.041 --> 00:01:51.401
for,

00:01:52.951 --> 00:01:54.431
for scheduling out our workflows.

00:01:54.431 --> 00:01:55.431
And then we have a workflow,

00:01:55.431 --> 00:01:55.751
right,

00:01:55.831 --> 00:01:58.311
and this is a user that clicks on a link and

00:01:58.871 --> 00:02:01.271
basically gets redirected to the correct

00:02:01.271 --> 00:02:01.751
destination.

00:02:02.471 --> 00:02:02.871
Now

00:02:02.991 --> 00:02:05.371
in the background we are sticking that data onto a

00:02:05.371 --> 00:02:05.592
queue.

00:02:05.592 --> 00:02:08.636
What we're also going to do is we are going to be

00:02:09.116 --> 00:02:10.876
sticking a durable object

00:02:11.436 --> 00:02:14.756
that is essentially a unique instance of a durable

00:02:14.756 --> 00:02:15.196
object

00:02:15.486 --> 00:02:16.526
at the account level.

00:02:16.686 --> 00:02:17.086
So

00:02:17.306 --> 00:02:19.406
you can imagine user has an account and anybody

00:02:19.406 --> 00:02:21.246
under that account would be able to unlock this

00:02:21.246 --> 00:02:22.326
feature where they see

00:02:22.786 --> 00:02:24.966
people click on links in real time on a map.

00:02:24.966 --> 00:02:26.006
Now when,

00:02:26.166 --> 00:02:26.566
when

00:02:26.766 --> 00:02:29.626
the Hono API is essentially proxy proxying that

00:02:29.626 --> 00:02:31.266
request or redirecting them back,

00:02:31.366 --> 00:02:32.846
they're going to write onto a queue and then

00:02:32.846 --> 00:02:33.606
immediately after

00:02:34.006 --> 00:02:35.686
they're also going to send some

00:02:35.866 --> 00:02:38.606
link click data to a durable object similar to

00:02:38.606 --> 00:02:39.246
what we're doing here.

00:02:39.246 --> 00:02:41.886
But we're going to bypass this queue step

00:02:41.886 --> 00:02:43.886
altogether just because it doesn't like

00:02:44.206 --> 00:02:45.486
there is going to be you

00:02:45.786 --> 00:02:48.186
few seconds delay from like when anything goes on

00:02:48.186 --> 00:02:49.426
to a queue to when it's consumed.

00:02:49.426 --> 00:02:50.986
And we want to try to make this a little bit more

00:02:50.986 --> 00:02:51.546
real time.

00:02:52.106 --> 00:02:54.826
Now from there the user will be able to use web,

00:02:54.826 --> 00:02:56.346
utilize websockets to

00:02:56.746 --> 00:02:58.906
see those changes in real time.

00:02:59.146 --> 00:03:02.066
Now every single time a link is clicked and it's

00:03:02.066 --> 00:03:03.306
stuck into a durable object,

00:03:03.386 --> 00:03:06.426
the durable Object has a SQLite back database

00:03:06.426 --> 00:03:08.426
attached with that specific instance.

00:03:08.506 --> 00:03:10.386
So we're also going to keep track of like the last

00:03:10.386 --> 00:03:11.706
100 link clicks

00:03:12.026 --> 00:03:12.426
and

00:03:12.966 --> 00:03:15.336
to kind of illustrate what that would look like.

00:03:15.336 --> 00:03:16.216
So you can imagine

00:03:16.616 --> 00:03:19.016
our backend service sends a link click to our

00:03:19.016 --> 00:03:19.976
durable object.

00:03:20.296 --> 00:03:22.336
Now our durable object would basically take this

00:03:22.336 --> 00:03:25.016
link click and then just imagine this as a table

00:03:25.016 --> 00:03:27.696
and this table has link ID account id,

00:03:27.696 --> 00:03:28.176
latitude,

00:03:28.176 --> 00:03:28.976
longitude and country.

00:03:28.976 --> 00:03:29.336
Right?

00:03:29.736 --> 00:03:31.256
Now when we get a link click,

00:03:31.376 --> 00:03:33.496
the durable object is going to back up that link

00:03:33.496 --> 00:03:35.439
click by inserting the data into a table.

00:03:35.439 --> 00:03:38.044
And then it is also going to send that data down

00:03:38.624 --> 00:03:40.064
to the UI via a websocket.

00:03:40.064 --> 00:03:41.104
It's going to push that information

00:03:41.584 --> 00:03:42.544
down right away.

00:03:43.104 --> 00:03:44.984
Now if there's multiple users,

00:03:44.984 --> 00:03:47.544
so imagine another user spins up this application

00:03:47.544 --> 00:03:49.418
essentially when they load this for the first time

00:03:49.578 --> 00:03:51.818
we should be able to say like hey,

00:03:52.058 --> 00:03:52.778
I'm online.

00:03:53.257 --> 00:03:56.058
The durable object recognizes a new user is online

00:03:56.218 --> 00:03:58.018
and then the durable object says okay,

00:03:58.018 --> 00:03:59.658
well what I'm going to do is I'm going to show

00:03:59.978 --> 00:04:00.618
the last

00:04:00.938 --> 00:04:03.498
50 link clicks or the last link clicks in the last

00:04:03.498 --> 00:04:05.498
hour or something and it's going to send all this

00:04:05.498 --> 00:04:06.138
data down

00:04:06.847 --> 00:04:07.258
via one

00:04:07.427 --> 00:04:09.747
WebSocket request right on startup

00:04:10.147 --> 00:04:11.187
to this user.

00:04:11.347 --> 00:04:11.747
Then

00:04:11.961 --> 00:04:14.961
that user's map will be populated and then every

00:04:14.961 --> 00:04:16.761
subsequent click that happens,

00:04:16.761 --> 00:04:18.201
it'll go into a durable object.

00:04:18.201 --> 00:04:20.681
The durable object will back it up and then it

00:04:20.681 --> 00:04:23.521
will cascade that request to all the clients.

00:04:23.521 --> 00:04:24.441
So it will send,

00:04:24.441 --> 00:04:26.441
basically it will send that link click information

00:04:26.441 --> 00:04:28.881
to this client and also this client at the exact

00:04:28.881 --> 00:04:29.201
same time.

00:04:29.201 --> 00:04:30.921
And if there's more than two clients,

00:04:31.081 --> 00:04:32.601
this could probably scale to

00:04:33.001 --> 00:04:35.081
I would say several hundred clients would most

00:04:35.081 --> 00:04:35.721
likely be

00:04:35.732 --> 00:04:37.562
but what this could scale to or probably more than

00:04:37.562 --> 00:04:38.322
that honestly.

00:04:38.402 --> 00:04:38.802
So

00:04:38.972 --> 00:04:41.332
I hope this kind of makes sense from like a really

00:04:41.412 --> 00:04:42.732
high level perspective.

00:04:42.732 --> 00:04:43.892
There's two things at play.

00:04:43.892 --> 00:04:44.692
There is a,

00:04:45.142 --> 00:04:47.592
there's a SQLite table that's keeping track of

00:04:47.592 --> 00:04:48.192
like the last

00:04:48.752 --> 00:04:50.312
n number of link clicks.

00:04:50.312 --> 00:04:50.992
That could be a hundred,

00:04:50.992 --> 00:04:51.792
it could be a thousand.

00:04:51.871 --> 00:04:54.552
It's not super important but essentially the

00:04:54.552 --> 00:04:56.592
durable object is going to have a few concepts of

00:04:56.592 --> 00:04:56.912
state.

00:04:56.912 --> 00:04:58.912
It'll have this table with this data,

00:04:59.072 --> 00:05:00.432
but it will also have,

00:05:00.912 --> 00:05:02.192
it'll keep track of

00:05:02.832 --> 00:05:04.303
the most recent link click

00:05:04.303 --> 00:05:04.681
and

00:05:05.081 --> 00:05:07.031
the oldest link click that way.

00:05:07.191 --> 00:05:10.031
Essentially what we could do is like when we're

00:05:10.031 --> 00:05:11.871
trying to clean up this table as it grows too

00:05:11.871 --> 00:05:12.071
large,

00:05:12.071 --> 00:05:13.431
when we delete records,

00:05:13.831 --> 00:05:15.671
it will be able to kind of say like okay,

00:05:15.671 --> 00:05:16.791
these guys got deleted.

00:05:17.111 --> 00:05:19.591
This is the oldest and this is the

00:05:19.811 --> 00:05:21.671
most recent and these will be called offsets.

00:05:21.671 --> 00:05:23.671
So it's going to keep track of these offsets as

00:05:23.671 --> 00:05:23.951
well.

00:05:24.491 --> 00:05:26.771
just to kind of like be able to manage the table

00:05:26.771 --> 00:05:27.131
data

00:05:27.761 --> 00:05:28.281
while the,

00:05:28.281 --> 00:05:30.641
while the durable object is also like doing other

00:05:30.641 --> 00:05:30.961
things.

00:05:30.961 --> 00:05:32.801
So there's going to be a few concepts of state.

00:05:32.801 --> 00:05:33.761
So you're going to have the

00:05:34.561 --> 00:05:34.591
most

00:05:34.741 --> 00:05:35.621
recent offset

00:05:35.941 --> 00:05:37.141
and the most recent offset,

00:05:37.141 --> 00:05:37.981
the oldest offset.

00:05:37.981 --> 00:05:40.141
You're going to have the actual like RAW table in

00:05:40.141 --> 00:05:40.501
the

00:05:40.691 --> 00:05:41.581
SQLite table.

00:05:41.581 --> 00:05:44.301
And then you're also going to have users

00:05:44.301 --> 00:05:45.781
essentially you're going to have like live

00:05:45.781 --> 00:05:46.701
sessions or

00:05:47.371 --> 00:05:50.331
live clients that are currently connected via

00:05:50.331 --> 00:05:51.971
websocket to a durable object.

00:05:51.971 --> 00:05:52.811
And that's going to be,

00:05:52.971 --> 00:05:55.291
that's going to be mostly managed by the durable

00:05:55.291 --> 00:05:57.331
objects built in APIs and we're going to build on

00:05:57.331 --> 00:05:57.891
top of that.

00:05:57.891 --> 00:05:58.161
So

00:05:58.551 --> 00:06:00.231
there's a few different concepts of state here.

00:06:00.261 --> 00:06:03.561
it's probably very hard to visualize exactly what

00:06:03.561 --> 00:06:04.921
this looks like and how it's going to be

00:06:04.921 --> 00:06:06.521
implemented just by looking at this.

00:06:06.521 --> 00:06:08.321
But I would just like keep note,

00:06:08.321 --> 00:06:08.881
we have state,

00:06:08.881 --> 00:06:09.641
we have SQL,

00:06:09.771 --> 00:06:12.691
SQLite table and then we also are going to be

00:06:12.691 --> 00:06:15.291
managing real time websocket connections.

00:06:15.561 --> 00:06:15.733
yeah,

00:06:15.733 --> 00:06:17.573
so that kind of sums up what we're going to be

00:06:17.573 --> 00:06:17.813
building.

00:06:18.053 --> 00:06:19.733
So now we're going to incrementally be building

00:06:19.733 --> 00:06:20.173
this out.

00:06:20.173 --> 00:06:21.208
So see you in the next one.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.028 --> 00:00:00.348
All right,

00:00:00.348 --> 00:00:01.628
to start off this build,

00:00:01.708 --> 00:00:04.108
let's head over to our data service application,

00:00:04.268 --> 00:00:06.828
go into source and we're going to be creating a

00:00:07.388 --> 00:00:08.988
new durable object.

00:00:09.228 --> 00:00:10.508
We can call this guy

00:00:11.388 --> 00:00:11.868
Link

00:00:12.347 --> 00:00:12.908
Click

00:00:14.108 --> 00:00:15.708
Tracker TS

00:00:15.838 --> 00:00:18.838
and essentially what we're going to want to do is

00:00:18.838 --> 00:00:20.238
we're going to want to just like before,

00:00:20.318 --> 00:00:21.438
we're going to import

00:00:21.758 --> 00:00:23.110
the durable object,

00:00:23.310 --> 00:00:24.590
probably import moment.

00:00:24.590 --> 00:00:26.070
We're not going to use it right away,

00:00:26.070 --> 00:00:27.350
but we will be using it.

00:00:27.350 --> 00:00:30.190
And then I'm going to create a base class

00:00:30.590 --> 00:00:32.990
called Link click Tracker.

00:00:34.190 --> 00:00:34.590
Now

00:00:35.570 --> 00:00:36.850
as we did before,

00:00:37.490 --> 00:00:41.090
we're going to set up a  and that  is going to

00:00:41.570 --> 00:00:42.450
pass in super.

00:00:42.530 --> 00:00:43.890
It's going to take our context.

00:00:43.890 --> 00:00:45.730
So this durable object context with the state,

00:00:45.810 --> 00:00:47.370
the emv pass it in the super.

00:00:47.370 --> 00:00:47.770
Okay,

00:00:47.770 --> 00:00:48.770
so now we have a

00:00:49.410 --> 00:00:50.290
base class here.

00:00:50.610 --> 00:00:52.610
Now the very first thing that we're going to focus

00:00:52.610 --> 00:00:55.010
on before we get into websockets is we're going to

00:00:55.010 --> 00:00:58.130
be getting the actual like link click data into a

00:00:58.130 --> 00:00:59.250
SQLite table.

00:00:59.650 --> 00:01:01.090
And the SQLite table,

00:01:01.170 --> 00:01:03.550
is just going to literally be like a sorted table

00:01:03.550 --> 00:01:05.870
that's kind of partitioned on the click time.

00:01:06.510 --> 00:01:08.510
So what we can do here is if you,

00:01:08.670 --> 00:01:10.510
if we come into context

00:01:10.990 --> 00:01:12.270
there is a storage

00:01:13.870 --> 00:01:16.750
and then storage does have a SQL property.

00:01:16.750 --> 00:01:18.990
Now just to kind of make this a little bit easier

00:01:18.990 --> 00:01:19.310
because

00:01:20.190 --> 00:01:21.950
we're going to be accessing it quite often.

00:01:22.270 --> 00:01:24.830
What I like to do is I like to define a

00:01:25.290 --> 00:01:27.510
Basically I like to pull out the SQL,

00:01:27.670 --> 00:01:29.030
the specific SQL,

00:01:29.130 --> 00:01:30.010
Storage API,

00:01:30.250 --> 00:01:32.930
define it at the top level of the class and is of

00:01:32.930 --> 00:01:34.970
the type SQL storage which is coming from the

00:01:34.970 --> 00:01:37.370
durable object Cloudflare workers library

00:01:37.830 --> 00:01:39.670
and then you can just simply say

00:01:40.230 --> 00:01:41.510
this dot SQL.

00:01:41.510 --> 00:01:43.750
So this is during startup equal CTX

00:01:44.230 --> 00:01:44.950
storage

00:01:45.350 --> 00:01:45.690
dot

00:01:45.690 --> 00:01:46.090
SQL.

00:01:46.970 --> 00:01:48.970
So this will just make it easier to access later.

00:01:49.850 --> 00:01:50.410
All right,

00:01:50.410 --> 00:01:50.810
so

00:01:51.210 --> 00:01:51.610
what,

00:01:51.930 --> 00:01:54.570
what I typically like to do very very first when

00:01:55.300 --> 00:01:58.980
building out a durable object that utilizes the

00:01:59.350 --> 00:02:00.480
SQLite API

00:02:00.959 --> 00:02:03.120
is I like to define the table

00:02:03.680 --> 00:02:04.680
at startup.

00:02:04.680 --> 00:02:06.960
So basically within this  now,

00:02:07.270 --> 00:02:09.030
if you notice when we say

00:02:09.350 --> 00:02:10.110
this.

00:02:10.110 --> 00:02:10.630
SQL,

00:02:10.790 --> 00:02:11.830
we're going to have

00:02:12.550 --> 00:02:15.510
an executable which basically allows us to execute

00:02:15.510 --> 00:02:16.870
a specific SQL query.

00:02:17.190 --> 00:02:18.990
So the first thing that we're going to do is we're

00:02:18.990 --> 00:02:21.590
going to create a table if it does not exist.

00:02:21.850 --> 00:02:23.290
so this is what this would look like.

00:02:23.290 --> 00:02:24.550
We would basically just say

00:02:25.404 --> 00:02:25.804
this

00:02:26.124 --> 00:02:26.684
dot.

00:02:26.844 --> 00:02:28.444
So what we say is this

00:02:28.534 --> 00:02:32.084
this dot execute is going to create a table if not

00:02:32.084 --> 00:02:32.564
exists.

00:02:32.564 --> 00:02:33.644
And we're going to call this

00:02:33.964 --> 00:02:35.204
Geolink clicks.

00:02:35.204 --> 00:02:36.804
This is going to take latitude,

00:02:36.804 --> 00:02:37.539
longitude,

00:02:37.539 --> 00:02:38.064
command country

00:02:38.464 --> 00:02:39.184
and time.

00:02:39.264 --> 00:02:40.064
So it's very,

00:02:40.304 --> 00:02:40.784
you know,

00:02:40.784 --> 00:02:42.704
there's not a lot of features of this

00:02:42.794 --> 00:02:43.544
specific table.

00:02:43.544 --> 00:02:45.664
It's just going to specifically capture these link

00:02:45.664 --> 00:02:46.416
clicks for us.

00:02:46.492 --> 00:02:47.612
Now because this,

00:02:47.692 --> 00:02:51.292
this durable object is going to have methods that

00:02:51.292 --> 00:02:53.132
ultimately query this table.

00:02:53.532 --> 00:02:55.612
What we're going to want to make sure we do is

00:02:55.612 --> 00:02:56.652
we're going to want to

00:02:57.132 --> 00:02:59.932
do this operation where we create the table if it

00:02:59.932 --> 00:03:00.652
does not exist

00:03:01.052 --> 00:03:02.412
inside of the

00:03:02.982 --> 00:03:04.102
block concurrency while.

00:03:04.102 --> 00:03:04.902
And the reason we,

00:03:04.902 --> 00:03:06.262
why we want to do this is because

00:03:06.582 --> 00:03:09.142
if we spin up a durable object and then another

00:03:09.822 --> 00:03:12.862
function that's running somewhere in our code also

00:03:13.262 --> 00:03:15.702
creates the same durable object instance and then

00:03:15.702 --> 00:03:17.902
calls a method like query database

00:03:18.221 --> 00:03:19.822
and that table doesn't exist yet,

00:03:19.822 --> 00:03:20.982
it's going to throw an error.

00:03:20.982 --> 00:03:23.902
So in order to block that from happening,

00:03:23.902 --> 00:03:25.822
what we're going to do is inside of this

00:03:26.572 --> 00:03:29.172
block concurrent while method we're just going to

00:03:29.172 --> 00:03:30.512
run that SQL object

00:03:30.862 --> 00:03:31.422
execute

00:03:31.802 --> 00:03:32.222
query.

00:03:32.222 --> 00:03:34.662
So this basically says the first time the table

00:03:34.662 --> 00:03:35.662
was ever created,

00:03:35.662 --> 00:03:37.542
this or the first time this durable object

00:03:37.542 --> 00:03:38.702
instance is created,

00:03:38.862 --> 00:03:40.462
this table will also be created.

00:03:40.462 --> 00:03:42.942
And then the next time this durable object

00:03:42.942 --> 00:03:44.288
instance is instantiated

00:03:44.288 --> 00:03:46.274
this is basically not going to do anything just

00:03:46.274 --> 00:03:48.228
because it will already have been created.

00:03:48.228 --> 00:03:50.217
Now the next thing we're going to want to do is

00:03:50.217 --> 00:03:51.937
just define a simple

00:03:52.217 --> 00:03:53.677
method that we'll extend later

00:03:53.997 --> 00:03:55.427
call called Add Link click.

00:03:55.587 --> 00:03:57.427
And all that this is going to do is it's going to

00:03:57.427 --> 00:03:59.347
take in the information that we want to add,

00:03:59.777 --> 00:04:03.177
that we want to add into the database and then

00:04:03.177 --> 00:04:04.977
we'll just literally insert a

00:04:05.667 --> 00:04:06.947
insert into query.

00:04:06.947 --> 00:04:07.347
Now

00:04:07.667 --> 00:04:09.747
best practice would be to kind of abstract

00:04:10.147 --> 00:04:12.387
these types of queries to,

00:04:12.947 --> 00:04:13.427
you know,

00:04:13.427 --> 00:04:14.787
like either an orm

00:04:15.267 --> 00:04:17.827
or maybe into other files or methods.

00:04:18.317 --> 00:04:18.622
but,

00:04:18.720 --> 00:04:19.840
but for the purpose of time,

00:04:19.920 --> 00:04:22.360
I just don't want to like get too distracted with

00:04:22.360 --> 00:04:24.280
a whole bunch of different dependencies because I

00:04:24.280 --> 00:04:26.120
know this is a section where some people might get

00:04:26.120 --> 00:04:27.920
lost and that's totally okay because this is a

00:04:27.920 --> 00:04:28.880
pretty advanced topic.

00:04:29.190 --> 00:04:30.800
one thing that you're going to know is we have

00:04:30.800 --> 00:04:31.840
these question marks.

00:04:31.840 --> 00:04:32.720
Now this

00:04:33.840 --> 00:04:37.400
this execute method takes in a query and then it

00:04:37.400 --> 00:04:39.640
takes in bindings and these bindings.

00:04:39.640 --> 00:04:42.080
Basically what it means is it's not like the same

00:04:42.080 --> 00:04:43.280
as your Cloudflare bindings.

00:04:43.280 --> 00:04:44.960
These bindings are ultimately just

00:04:45.712 --> 00:04:47.312
values that will be inserted in,

00:04:47.392 --> 00:04:48.792
in the order that they're defined.

00:04:48.792 --> 00:04:50.032
So latitude will be here,

00:04:50.512 --> 00:04:51.392
longitude,

00:04:51.472 --> 00:04:51.872
country,

00:04:52.432 --> 00:04:52.792
time.

00:04:52.792 --> 00:04:55.152
And this essentially just makes it so people can't

00:04:55.152 --> 00:04:56.672
like try to inject,

00:04:57.402 --> 00:05:00.042
inject dangerous SQL code into this query.

00:05:00.042 --> 00:05:02.202
Like you could imagine a user could basically type

00:05:02.202 --> 00:05:02.842
out like a,

00:05:03.602 --> 00:05:05.962
show me all tables or select all from some table

00:05:05.962 --> 00:05:08.002
and then they could stuff it inside of an inner,

00:05:08.002 --> 00:05:10.962
inner query and it could be pushed into a,

00:05:11.342 --> 00:05:12.982
it could be pushed into your SQL query and then

00:05:12.982 --> 00:05:14.782
all of a sudden like malicious code is running on

00:05:14.782 --> 00:05:15.182
your machine.

00:05:15.182 --> 00:05:17.022
So this just kind of prevents that from happening

00:05:17.022 --> 00:05:17.342
and

00:05:17.722 --> 00:05:20.522
just like a really safe way of managing your

00:05:20.842 --> 00:05:21.322
queries.

00:05:21.322 --> 00:05:21.812
They're called

00:05:22.292 --> 00:05:22.932
bindings.

00:05:22.979 --> 00:05:25.498
Now while we're talking about bindings and talking

00:05:25.498 --> 00:05:27.979
about ORMs and trying to find ways of making this

00:05:27.979 --> 00:05:28.899
a little bit cleaner,

00:05:29.139 --> 00:05:32.579
Drizzle does have some documentation about how to

00:05:32.579 --> 00:05:36.139
configure a durable object to basically utilize

00:05:36.139 --> 00:05:37.369
Drizzle directly.

00:05:37.369 --> 00:05:38.739
and then you're able to like

00:05:39.369 --> 00:05:41.289
migrate your table so you can kind of abstract

00:05:41.289 --> 00:05:43.449
away the like creation of the tables.

00:05:43.449 --> 00:05:46.409
And then also you can use Drizzle to like insert

00:05:46.409 --> 00:05:47.415
data into the table.

00:05:47.581 --> 00:05:49.101
I have played around with this.

00:05:49.241 --> 00:05:50.261
it works pretty well.

00:05:50.261 --> 00:05:52.821
Although I did have a lot of issues trying to get

00:05:52.821 --> 00:05:54.661
like the dynamic table migration.

00:05:54.661 --> 00:05:57.421
So like the creation of those tables to be done

00:05:57.421 --> 00:05:58.301
via Drizzle,

00:05:58.301 --> 00:06:00.361
I played around with it for a few hours and I

00:06:00.361 --> 00:06:02.481
ultimately just decided for like a use case like

00:06:02.481 --> 00:06:02.721
this.

00:06:02.721 --> 00:06:04.441
I'm okay writing this raw

00:06:04.851 --> 00:06:05.451
SQL stuff,

00:06:05.451 --> 00:06:07.011
but if I were to build a really,

00:06:07.011 --> 00:06:07.291
really,

00:06:07.291 --> 00:06:07.611
really,

00:06:07.611 --> 00:06:09.731
really advanced use case on top of the

00:06:10.141 --> 00:06:12.991
on top of durable objects with their SQL API,

00:06:13.151 --> 00:06:15.311
I would probably bring in another orm.

00:06:15.311 --> 00:06:16.911
So just keep that in mind and if you're ever doing

00:06:16.911 --> 00:06:17.151
something,

00:06:17.151 --> 00:06:18.871
you can go ahead and look into this because this

00:06:18.871 --> 00:06:20.031
is kind of cool where you can

00:06:20.381 --> 00:06:23.151
define Drizzle on top of your SQLite database that

00:06:23.151 --> 00:06:24.851
is provided by a durable object.

00:06:25.598 --> 00:06:26.158
Okay,

00:06:26.158 --> 00:06:29.278
so now that we have this add link click method,

00:06:29.328 --> 00:06:31.808
that's part of our class that saves the data into

00:06:31.808 --> 00:06:32.528
our table.

00:06:32.848 --> 00:06:33.718
I'm going to def

00:06:34.268 --> 00:06:36.028
a temporary fetch function.

00:06:36.228 --> 00:06:39.098
And all that this is going to do is it is going

00:06:39.098 --> 00:06:39.498
to.

00:06:39.818 --> 00:06:41.258
We can basically say

00:06:41.978 --> 00:06:43.498
it's going to have a request.

00:06:45.765 --> 00:06:47.948
All that is going to do is it defines a query

00:06:47.948 --> 00:06:50.788
where it says select everything from geolink

00:06:50.788 --> 00:06:51.188
clicks,

00:06:51.188 --> 00:06:52.348
limits it by 100.

00:06:52.938 --> 00:06:55.568
it uses this.ah SQL which we've defined at the top

00:06:55.568 --> 00:06:56.208
level here,

00:06:56.448 --> 00:06:58.048
to execute the query.

00:06:58.528 --> 00:07:00.808
Then it takes the cursor and converts those

00:07:00.808 --> 00:07:03.768
results into an array and then it returns those

00:07:03.768 --> 00:07:04.128
results

00:07:04.438 --> 00:07:07.028
in a JSON object or like in a JSON

00:07:07.528 --> 00:07:07.849
type.

00:07:07.849 --> 00:07:09.785
And the reason why I'M defining this here is

00:07:09.785 --> 00:07:12.225
because I want to illustrate how this actually

00:07:12.305 --> 00:07:12.935
works.

00:07:13.045 --> 00:07:13.445
so

00:07:13.765 --> 00:07:15.725
for now what we're going to do is we're also going

00:07:15.725 --> 00:07:17.745
to go back to our Hono API and,

00:07:17.815 --> 00:07:19.255
and we are going to build a

00:07:19.815 --> 00:07:19.835
dummy

00:07:20.155 --> 00:07:23.155
route that interfaces with this specific durable

00:07:23.155 --> 00:07:24.955
object so we can understand how this

00:07:25.865 --> 00:07:27.905
how this SQLite implementation is actually

00:07:27.905 --> 00:07:28.265
working.

00:07:28.653 --> 00:07:30.653
And before we build the Hono,

00:07:31.173 --> 00:07:32.693
before we build our honor route,

00:07:32.693 --> 00:07:34.453
we're going to head over to our

00:07:34.853 --> 00:07:36.293
Wrangler JSON C,

00:07:37.093 --> 00:07:38.453
make sure we have our

00:07:40.233 --> 00:07:40.873
class name

00:07:41.353 --> 00:07:44.233
and then we are going to create another binding in

00:07:44.233 --> 00:07:44.473
here

00:07:46.353 --> 00:07:48.513
and the class name is going to be that.

00:07:48.593 --> 00:07:50.953
And then what we can do is we can create the

00:07:50.953 --> 00:07:51.793
binding name

00:07:52.193 --> 00:07:53.553
which is going to be.

00:07:53.793 --> 00:07:55.233
We'll just call this Link

00:07:55.953 --> 00:07:56.513
click

00:07:57.633 --> 00:07:58.433
Tracker

00:07:59.793 --> 00:08:00.353
object.

00:08:01.473 --> 00:08:03.073
And then I'm also going to,

00:08:03.393 --> 00:08:04.833
inside of the migrations,

00:08:04.833 --> 00:08:06.753
I'm also going to basically say

00:08:07.898 --> 00:08:08.538
V2,

00:08:09.098 --> 00:08:10.698
I'm going to pass in the class name here

00:08:11.468 --> 00:08:14.548
and then we can head over to our index TS inside

00:08:14.548 --> 00:08:15.388
of our data service

00:08:15.948 --> 00:08:18.508
and then similarly we're going to want to export

00:08:18.588 --> 00:08:20.988
that specific class that we just defined,

00:08:27.908 --> 00:08:29.108
Link click tracker.

00:08:29.108 --> 00:08:29.668
Okay.

00:08:30.628 --> 00:08:31.108
Okay.

00:08:31.108 --> 00:08:32.708
So now that we have this

00:08:33.378 --> 00:08:35.498
this class exported in our index ts,

00:08:35.498 --> 00:08:38.178
we've also added the migrations into our

00:08:38.728 --> 00:08:40.248
wrangler JSON C.

00:08:40.248 --> 00:08:41.288
We've added the class.

00:08:41.288 --> 00:08:44.528
What we can do is we can CD into our apps data

00:08:44.528 --> 00:08:44.888
service.

00:08:44.888 --> 00:08:47.288
Make sure we're here pnpm run CF

00:08:47.688 --> 00:08:48.568
type gen

00:08:49.208 --> 00:08:50.608
that's going to this,

00:08:50.608 --> 00:08:52.768
that's going to add this new binding that we have

00:08:52.768 --> 00:08:55.368
access to called Link click tracker object.

00:08:55.808 --> 00:08:57.808
the reason why I gave this the name object is I

00:08:57.808 --> 00:08:59.688
just realized it's a lot easier to kind of like

00:08:59.688 --> 00:09:01.368
see when you're trying to access your bindings.

00:09:01.368 --> 00:09:03.208
I probably should have named this one object as

00:09:03.208 --> 00:09:03.488
well,

00:09:03.488 --> 00:09:05.168
the one that we did in the last section.

00:09:05.648 --> 00:09:08.448
Now what we can do is we can head over to our

00:09:09.193 --> 00:09:11.033
we can head over to our Hono app

00:09:11.913 --> 00:09:15.193
and inside of here I'm going to create a,

00:09:15.353 --> 00:09:16.793
another dummy route

00:09:17.757 --> 00:09:19.597
and we're basically going to say

00:09:20.756 --> 00:09:21.175
click.

00:09:22.202 --> 00:09:23.852
And that's going to take a,

00:09:23.932 --> 00:09:24.972
we'll call this a name

00:09:25.940 --> 00:09:28.370
and for now this is just going to return a C dot,

00:09:28.370 --> 00:09:31.320
JSON and we'll just return an empty JSON object

00:09:31.320 --> 00:09:31.800
for now.

00:09:32.120 --> 00:09:32.680
Okay,

00:09:32.680 --> 00:09:34.200
so now inside of here

00:09:34.760 --> 00:09:35.160
we

00:09:35.480 --> 00:09:38.680
have this section where we go and actually extract

00:09:38.950 --> 00:09:40.576
we send data to our queue.

00:09:40.876 --> 00:09:42.956
Ultimately what happens here is

00:09:43.356 --> 00:09:44.316
in the background,

00:09:44.556 --> 00:09:46.716
as we've kind of mentioned in the last videos,

00:09:46.716 --> 00:09:49.036
we are sending some data over to

00:09:49.876 --> 00:09:50.436
our queue.

00:09:50.436 --> 00:09:52.916
Now what happens here is going to allow for

00:09:52.916 --> 00:09:53.836
asynchronous functions,

00:09:53.836 --> 00:09:55.476
but we don't await inside of here.

00:09:55.886 --> 00:09:58.566
the downside of this is you're only able to stuff

00:09:58.566 --> 00:09:59.766
in one method.

00:09:59.766 --> 00:10:01.966
So basically any logic that happens in here,

00:10:01.966 --> 00:10:03.846
we're going to want to push it out into a single

00:10:03.846 --> 00:10:04.286
method.

00:10:04.686 --> 00:10:07.046
So what we can do is we can head over to Route

00:10:07.046 --> 00:10:07.366
Ops,

00:10:07.366 --> 00:10:09.246
we're going to put a lot of the logic for

00:10:09.826 --> 00:10:11.746
routing the link requests into here.

00:10:11.826 --> 00:10:14.306
So I already coded a lot of this out.

00:10:14.306 --> 00:10:16.266
So basically what we're going to do is we're going

00:10:16.266 --> 00:10:18.266
to take in the environment and that link click

00:10:18.266 --> 00:10:20.566
data that we're defining inside of our app right

00:10:20.566 --> 00:10:20.642
here.

00:10:20.642 --> 00:10:21.202
And then

00:10:22.242 --> 00:10:23.282
we will be

00:10:23.672 --> 00:10:25.992
first sending this data to the queue because it's

00:10:25.992 --> 00:10:27.512
most important to capture that information on the

00:10:27.512 --> 00:10:27.912
queue.

00:10:28.152 --> 00:10:29.432
And then we're going to go and

00:10:29.832 --> 00:10:33.192
get our durable object ID based upon the user's

00:10:33.192 --> 00:10:34.152
account ID

00:10:34.472 --> 00:10:37.112
or the account ID for that specific link.

00:10:37.432 --> 00:10:39.872
And then we're going to grab the stub based upon

00:10:39.872 --> 00:10:42.352
the durable object id and then we're going to just

00:10:42.352 --> 00:10:43.112
make sure that

00:10:43.242 --> 00:10:44.392
we have all the data that we need.

00:10:44.392 --> 00:10:46.872
Because when we are getting this request from,

00:10:47.482 --> 00:10:48.992
the Cloudflare headers,

00:10:49.622 --> 00:10:50.062
latitude,

00:10:50.062 --> 00:10:51.782
longitude and country are like

00:10:52.352 --> 00:10:53.492
possibly undefined.

00:10:53.572 --> 00:10:55.692
So we make sure we have all the data that we need

00:10:55.692 --> 00:10:56.772
for link tracking,

00:10:56.772 --> 00:10:59.052
from like a GEO data perspective.

00:10:59.292 --> 00:10:59.932
And if not,

00:10:59.932 --> 00:11:02.172
we return and if we do have this stuff,

00:11:02.172 --> 00:11:04.372
then we're just taking our stub and we're passing

00:11:04.372 --> 00:11:06.052
that data into Add Click,

00:11:06.052 --> 00:11:07.852
which is the method that we defined

00:11:07.947 --> 00:11:08.747
right here

00:11:09.067 --> 00:11:11.307
and it's inserting that data into our table.

00:11:11.467 --> 00:11:13.867
So this is how we're going to wire it into our

00:11:13.867 --> 00:11:14.187
system.

00:11:14.267 --> 00:11:16.027
Now I'm just going to make sure we can copy this

00:11:16.027 --> 00:11:16.427
guy

00:11:17.077 --> 00:11:19.637
and I'm going to replace this with that,

00:11:19.797 --> 00:11:21.397
make sure it's imported.

00:11:21.397 --> 00:11:24.517
We can say C EMV and then we'll also pass in the

00:11:24.517 --> 00:11:25.317
queue message.

00:11:25.717 --> 00:11:26.237
Okay,

00:11:26.237 --> 00:11:27.677
so this is going to be doing the same thing where

00:11:27.677 --> 00:11:28.877
it's sending the data to our queue,

00:11:28.877 --> 00:11:30.917
but it's also calling that durable object.

00:11:31.237 --> 00:11:32.437
Now that we have that done,

00:11:32.516 --> 00:11:34.677
let's head back over to this dummy,

00:11:34.947 --> 00:11:36.097
this dummy route that we're.

00:11:36.977 --> 00:11:38.817
We'll just call this click link

00:11:39.137 --> 00:11:39.697
click.

00:11:39.716 --> 00:11:42.090
And this is actually going to take an account id.

00:11:43.240 --> 00:11:44.170
I'm just going to go.

00:11:44.650 --> 00:11:46.250
So we can basically say

00:11:46.890 --> 00:11:47.290
const.

00:11:53.305 --> 00:11:56.585
We're going to pull our account ID from the param.

00:11:56.985 --> 00:11:59.265
And then similarly what we're going to want to do

00:11:59.265 --> 00:12:02.585
is we're going to want to go to our

00:12:03.335 --> 00:12:04.055
link click tracker.

00:12:04.055 --> 00:12:05.895
And you notice that we have this fetch handler.

00:12:05.895 --> 00:12:08.375
This fetch handler is built in to the durable

00:12:08.375 --> 00:12:10.135
object API and we're just implementing,

00:12:10.295 --> 00:12:11.255
getting a request,

00:12:11.255 --> 00:12:12.375
executing our query,

00:12:12.615 --> 00:12:13.575
pulling that data.

00:12:13.655 --> 00:12:15.895
So all we actually have to do here is

00:12:16.759 --> 00:12:18.999
similar to how we got our stub before,

00:12:19.319 --> 00:12:20.679
we're going to take the

00:12:20.999 --> 00:12:21.799
account id,

00:12:21.959 --> 00:12:23.359
we're going to pass that into here.

00:12:23.359 --> 00:12:25.559
So we're going to get a unique durable object ID

00:12:25.799 --> 00:12:27.979
based upon our unique duration account id

00:12:28.459 --> 00:12:31.339
and then we are going to get the stub

00:12:31.819 --> 00:12:35.419
and then the stub has a fetch handler and all that

00:12:35.419 --> 00:12:36.459
we need to return

00:12:36.779 --> 00:12:37.419
from a

00:12:37.679 --> 00:12:38.459
API route

00:12:38.859 --> 00:12:40.899
perspective is actually that fetch handler.

00:12:40.899 --> 00:12:42.299
So we can say

00:12:42.619 --> 00:12:44.096
we can basically come here and say

00:12:44.656 --> 00:12:45.176
wait,

00:12:45.176 --> 00:12:46.416
stub dot fetch

00:12:47.376 --> 00:12:48.976
and we can pass in C dot

00:12:50.096 --> 00:12:50.656
request

00:12:51.706 --> 00:12:52.655
dot raw

00:12:53.182 --> 00:12:55.342
and from here we're able to actually proxy that

00:12:55.662 --> 00:12:56.302
specific

00:12:56.432 --> 00:12:56.682
this,

00:12:57.162 --> 00:12:59.242
this request to our durable object.

00:12:59.242 --> 00:13:01.042
So we're just forwarding that request to a

00:13:01.042 --> 00:13:03.922
specific instance of our durable object and we are

00:13:03.922 --> 00:13:05.481
having our durable object take

00:13:05.952 --> 00:13:07.022
control of that

00:13:07.342 --> 00:13:08.014
response.

00:13:08.015 --> 00:13:08.358
All right,

00:13:08.358 --> 00:13:09.798
now before we deploy,

00:13:09.878 --> 00:13:13.038
one thing that I'm noticing here is I have a typo.

00:13:13.038 --> 00:13:16.438
I'm adding order by id but we actually don't have

00:13:16.438 --> 00:13:16.758
ID

00:13:17.108 --> 00:13:19.398
in this table so we don't want to do that.

00:13:20.148 --> 00:13:21.138
make sure we save that.

00:13:21.138 --> 00:13:22.458
And then another thing

00:13:22.668 --> 00:13:24.698
that I was just kind of scanning before deploying

00:13:24.698 --> 00:13:25.098
is

00:13:25.818 --> 00:13:28.218
you notice right here we have classes,

00:13:28.668 --> 00:13:29.068
but

00:13:29.548 --> 00:13:32.348
technically this is a SQLite backed class.

00:13:32.748 --> 00:13:33.148
So

00:13:34.016 --> 00:13:36.816
what we're going to want to do is make sure we say

00:13:36.976 --> 00:13:40.336
new SQLite classes for our link tracker.

00:13:40.886 --> 00:13:42.316
from there we should be able to deploy.

00:13:46.651 --> 00:13:50.011
And while this is deploying I'm just going to head

00:13:50.011 --> 00:13:52.091
over to our SQL D1.

00:13:52.173 --> 00:13:53.510
I'm going to go to explore data

00:13:53.830 --> 00:13:56.470
and then I'm going to say select star from

00:13:57.270 --> 00:13:58.390
link clicks

00:13:59.110 --> 00:13:59.510
order.

00:14:00.310 --> 00:14:01.830
Let's just make sure we can see what,

00:14:01.830 --> 00:14:02.470
what's there.

00:14:02.790 --> 00:14:03.270
Let's

00:14:03.670 --> 00:14:04.070
order

00:14:04.390 --> 00:14:04.790
by

00:14:06.500 --> 00:14:07.260
what do we got?

00:14:07.260 --> 00:14:07.620
Time.

00:14:07.860 --> 00:14:08.580
Click time.

00:14:10.100 --> 00:14:10.860
Descending.

00:14:10.860 --> 00:14:12.820
I just want to make sure we get the right account

00:14:12.900 --> 00:14:13.580
ID here.

00:14:13.580 --> 00:14:14.144
So it's 1,

00:14:14.180 --> 00:14:14.326
2,

00:14:14.362 --> 00:14:14.508
3,

00:14:14.544 --> 00:14:14.690
4,

00:14:14.727 --> 00:14:14.872
5,

00:14:14.909 --> 00:14:15.055
6,

00:14:15.091 --> 00:14:15.237
7,

00:14:15.273 --> 00:14:15.419
8,

00:14:15.456 --> 00:14:15.620
9.

00:14:16.460 --> 00:14:16.860
now

00:14:17.500 --> 00:14:18.540
you can grab your

00:14:19.230 --> 00:14:20.640
deployable URL right here

00:14:21.200 --> 00:14:23.440
and I'm just gonna go ahead and load that.

00:14:23.440 --> 00:14:25.840
And what we're gonna notice is we get an array

00:14:25.840 --> 00:14:28.230
with no values inside of it.

00:14:28.230 --> 00:14:29.580
and that's kind of by design because

00:14:30.220 --> 00:14:32.900
we haven't actually triggered this logic where we

00:14:32.900 --> 00:14:33.260
add

00:14:33.990 --> 00:14:35.360
where we insert data into

00:14:35.760 --> 00:14:36.560
the table.

00:14:36.720 --> 00:14:37.120
So

00:14:37.410 --> 00:14:38.650
when we call this fetch handler,

00:14:38.650 --> 00:14:41.450
when we procs it via our hono request we're not

00:14:41.450 --> 00:14:42.130
getting any data.

00:14:42.830 --> 00:14:45.070
But what we can do is we can head over to

00:14:45.980 --> 00:14:47.340
I think I just have some

00:14:48.320 --> 00:14:48.720
service.

00:14:48.880 --> 00:14:51.360
So this is going to do our redirect for us,

00:14:51.440 --> 00:14:52.320
go to Google.

00:14:52.320 --> 00:14:55.080
And then now when I hit this guy I do expect to

00:14:55.080 --> 00:14:55.760
have data in here.

00:14:55.760 --> 00:14:57.640
So notice we get some data in here.

00:14:57.640 --> 00:14:58.560
I'm going to do that again

00:14:59.680 --> 00:15:01.600
and we're going to come over here

00:15:01.864 --> 00:15:04.057
and load this guy and we have even more data.

00:15:04.057 --> 00:15:05.177
I'll even pretty that.

00:15:05.177 --> 00:15:05.577
So

00:15:05.997 --> 00:15:08.357
essentially this is pulling the data that is

00:15:08.357 --> 00:15:11.037
inside of our SQLite table right here.

00:15:11.037 --> 00:15:13.017
Now if we go to a different light like we change

00:15:13.017 --> 00:15:13.657
this right here,

00:15:13.817 --> 00:15:14.417
there's going,

00:15:14.417 --> 00:15:16.537
we're not going to have any data inside of that.

00:15:16.617 --> 00:15:17.017
So

00:15:17.697 --> 00:15:19.217
just to kind of recap what's happening,

00:15:19.217 --> 00:15:19.857
we have

00:15:20.417 --> 00:15:20.817
our,

00:15:21.537 --> 00:15:22.497
we have our

00:15:22.837 --> 00:15:23.867
link click up here

00:15:24.347 --> 00:15:25.867
that is going to hono.

00:15:25.867 --> 00:15:27.867
It's figuring out where it should redirect to

00:15:27.867 --> 00:15:28.987
Redirect in the background.

00:15:28.987 --> 00:15:31.227
It's sending some data to a queue and it's also

00:15:31.307 --> 00:15:34.067
adding that link to a durable object at the level

00:15:34.067 --> 00:15:34.747
of the account.

00:15:34.827 --> 00:15:35.867
So every single account

00:15:36.667 --> 00:15:37.667
contains his own link.

00:15:37.667 --> 00:15:38.187
Click data.

00:15:38.247 --> 00:15:40.107
so if you have another person that signs up,

00:15:40.487 --> 00:15:42.087
they'll have a different account and then that

00:15:42.087 --> 00:15:44.287
data will be isolated based upon durable objects.

00:15:44.287 --> 00:15:45.687
So this is all abstracted away

00:15:46.007 --> 00:15:47.927
in one function right here.

00:15:48.247 --> 00:15:50.247
Call capture link clicks and background.

00:15:50.567 --> 00:15:51.767
And then in our

00:15:52.027 --> 00:15:53.327
in our Hono app right here,

00:15:53.327 --> 00:15:54.527
we are able to

00:15:55.827 --> 00:15:57.027
that data into the background.

00:15:57.587 --> 00:15:57.987
This

00:15:58.387 --> 00:15:59.907
and then we have a dummy

00:16:00.267 --> 00:16:01.067
route right here.

00:16:01.067 --> 00:16:03.587
Link click where we pass in that account ID and

00:16:03.587 --> 00:16:05.347
we're getting a durable object based upon an

00:16:05.347 --> 00:16:07.227
account ID and we're passing the request

00:16:07.777 --> 00:16:10.257
directly through into our durable object,

00:16:10.417 --> 00:16:11.777
just kind of proxying that,

00:16:11.777 --> 00:16:12.657
selecting everything,

00:16:12.737 --> 00:16:15.457
limiting 100 and then we're returning that data.

00:16:15.617 --> 00:16:17.697
Now this actually doesn't matter.

00:16:17.697 --> 00:16:18.657
We don't need this

00:16:18.977 --> 00:16:20.577
and we don't need

00:16:21.887 --> 00:16:22.277
this,

00:16:22.947 --> 00:16:23.757
route as well.

00:16:23.997 --> 00:16:25.997
But just for the purpose of like understanding how

00:16:25.997 --> 00:16:26.357
this works,

00:16:26.357 --> 00:16:27.477
that's why I added it here.

00:16:27.477 --> 00:16:28.317
So I'm going to keep it in.

00:16:28.317 --> 00:16:28.707
I'm going to

00:16:28.907 --> 00:16:30.467
you'll be able to kind of copy this over and play

00:16:30.467 --> 00:16:30.987
around with it.

00:16:30.987 --> 00:16:32.907
But in the next video we're going to be deleting

00:16:32.907 --> 00:16:34.227
this stuff and we're going to actually start

00:16:34.227 --> 00:16:36.208
building out more of the sophisticated features.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.098 --> 00:00:00.658
All right,

00:00:00.898 --> 00:00:03.778
so let's get into the websocket aspect of this

00:00:03.778 --> 00:00:05.218
section of the course.

00:00:05.618 --> 00:00:07.058
Now before we get started,

00:00:07.728 --> 00:00:09.998
if you're totally new to websockets and durable

00:00:09.998 --> 00:00:10.518
objects,

00:00:10.518 --> 00:00:12.828
if you just literally Google or YouTube,

00:00:12.828 --> 00:00:13.518
durable objects,

00:00:13.518 --> 00:00:14.198
WebSockets,

00:00:14.358 --> 00:00:14.998
this video

00:00:15.318 --> 00:00:16.198
should be the,

00:00:16.278 --> 00:00:17.398
probably the first one.

00:00:17.638 --> 00:00:20.038
It's done pretty well for how niche it is and

00:00:20.438 --> 00:00:21.878
it goes into very,

00:00:21.878 --> 00:00:22.118
very,

00:00:22.118 --> 00:00:22.358
very,

00:00:22.358 --> 00:00:22.638
very,

00:00:22.638 --> 00:00:23.398
very deep

00:00:23.488 --> 00:00:25.338
detail for how the websockets work and,

00:00:25.408 --> 00:00:27.978
and you actually build out a real time Excalidraw,

00:00:28.528 --> 00:00:29.768
application on top of it.

00:00:29.768 --> 00:00:31.328
So within 40 minutes,

00:00:31.328 --> 00:00:31.968
honestly you'll,

00:00:31.968 --> 00:00:33.008
you'll take away a lot.

00:00:33.168 --> 00:00:35.008
Now we're going to cover the exact same things

00:00:35.008 --> 00:00:35.328
here,

00:00:35.598 --> 00:00:37.438
and we're going to go equally as deep.

00:00:37.438 --> 00:00:40.198
But I would say this is probably going to be like

00:00:40.198 --> 00:00:41.278
a more concise

00:00:41.568 --> 00:00:42.288
overview.

00:00:42.448 --> 00:00:44.008
So you could go watch that if you want,

00:00:44.008 --> 00:00:44.688
but you don't have to.

00:00:44.688 --> 00:00:45.088
Now,

00:00:45.758 --> 00:00:48.438
the very first thing with websockets to notice is

00:00:48.438 --> 00:00:51.038
the durable objects class has some

00:00:51.818 --> 00:00:54.258
different like helper functions that are built in.

00:00:54.258 --> 00:00:55.178
So like you have

00:00:55.498 --> 00:00:56.698
WebSocket close,

00:00:57.098 --> 00:00:57.738
you have

00:00:58.858 --> 00:01:00.218
WebSocket message

00:01:00.858 --> 00:01:01.898
and you have

00:01:02.872 --> 00:01:03.798
WebSocket error.

00:01:03.798 --> 00:01:05.398
So these are kind of events that happen

00:01:05.718 --> 00:01:06.278
typically

00:01:06.598 --> 00:01:08.478
like server side and client side.

00:01:08.478 --> 00:01:09.238
Like if a,

00:01:10.058 --> 00:01:12.378
if a websocket was to be closed on the

00:01:12.395 --> 00:01:13.294
client side of things,

00:01:13.294 --> 00:01:15.494
the server also knows that that is closed and then

00:01:15.494 --> 00:01:16.174
this will fire,

00:01:17.044 --> 00:01:19.684
if a message is sent from the client to the server

00:01:20.084 --> 00:01:22.444
this is going to trigger and then if there's an

00:01:22.444 --> 00:01:23.364
error in the websocket,

00:01:23.364 --> 00:01:24.164
this is going to trigger.

00:01:24.164 --> 00:01:24.484
Now

00:01:24.834 --> 00:01:25.054
the,

00:01:25.054 --> 00:01:27.694
the common convention for like basically being

00:01:27.694 --> 00:01:28.574
able to like,

00:01:28.734 --> 00:01:29.214
you know,

00:01:29.214 --> 00:01:31.614
manage websocket life cycle is you have a,

00:01:31.833 --> 00:01:34.360
you typically will have a client right here

00:01:35.080 --> 00:01:36.890
and you'll have a server and it

00:01:36.890 --> 00:01:39.320
will establish a two way connection

00:01:40.064 --> 00:01:41.984
and this connection stays persisted.

00:01:41.984 --> 00:01:43.264
So basically it does not close.

00:01:43.344 --> 00:01:43.904
And then

00:01:44.224 --> 00:01:45.504
you can have multiple clients.

00:01:45.504 --> 00:01:46.785
So these are clients over here.

00:01:46.986 --> 00:01:49.146
We'll just call this three clients for now.

00:01:49.157 --> 00:01:51.416
And each one of these three clients is going to

00:01:51.416 --> 00:01:51.976
have a

00:01:52.206 --> 00:01:53.896
is going to have a persistent connection.

00:01:55.016 --> 00:01:55.416
Now,

00:01:59.570 --> 00:02:01.970
now if this client sends a message over

00:02:02.450 --> 00:02:03.650
to the server,

00:02:03.890 --> 00:02:06.250
the server can read the message and determine what

00:02:06.250 --> 00:02:08.770
to do and typically it's going to like respond

00:02:09.010 --> 00:02:11.332
with another message back to the client.

00:02:11.332 --> 00:02:14.150
Now the server also keeps track of all the clients

00:02:14.150 --> 00:02:15.910
that are connected at a given point in time.

00:02:15.990 --> 00:02:18.790
So you could have a flow where you basically one

00:02:18.790 --> 00:02:20.390
client sends something over here

00:02:20.870 --> 00:02:21.710
and then the server says,

00:02:21.710 --> 00:02:21.990
okay,

00:02:21.990 --> 00:02:24.510
I want to relay that message to this one and this

00:02:24.510 --> 00:02:25.350
one at the same time.

00:02:25.430 --> 00:02:27.510
So this guy sends something and then this,

00:02:27.590 --> 00:02:28.710
the server pushes,

00:02:29.300 --> 00:02:31.580
the data back to these clients over here.

00:02:32.140 --> 00:02:33.900
So if you were to just basically have like some

00:02:33.900 --> 00:02:35.180
type of relay service,

00:02:35.260 --> 00:02:37.700
like the client sends data and then it sends it

00:02:37.700 --> 00:02:37.980
back,

00:02:38.220 --> 00:02:40.100
essentially the implementation would look like you

00:02:40.100 --> 00:02:40.380
would say,

00:02:40.380 --> 00:02:41.020
await

00:02:41.740 --> 00:02:46.180
websocket.send and you would send whatever message

00:02:46.180 --> 00:02:46.540
you want.

00:02:46.540 --> 00:02:46.740
So,

00:02:46.740 --> 00:02:46.900
like,

00:02:46.900 --> 00:02:48.300
we could just basically pass in,

00:02:48.880 --> 00:02:49.040
or,

00:02:49.040 --> 00:02:49.400
sorry,

00:02:49.400 --> 00:02:50.480
this is the wrong method.

00:02:50.640 --> 00:02:53.280
So this is on websocket message and you could pass

00:02:53.280 --> 00:02:55.840
in the message that was received.

00:02:56.160 --> 00:02:56.560
So

00:02:56.960 --> 00:02:58.480
essentially what would happen here,

00:02:58.480 --> 00:03:00.800
it looks like it wants an array or a string buffer

00:03:00.880 --> 00:03:02.560
and this one wants message.

00:03:02.560 --> 00:03:03.846
So basically it's going to say

00:03:03.846 --> 00:03:05.156
Just make sure that's async.

00:03:05.156 --> 00:03:05.596
Okay,

00:03:05.676 --> 00:03:05.954
so

00:03:05.954 --> 00:03:07.758
essentially what would happen here is when the

00:03:07.758 --> 00:03:09.838
client connects to the server and the client sends

00:03:09.838 --> 00:03:10.238
a message,

00:03:10.238 --> 00:03:12.158
that exact same message would be sent back to the

00:03:12.158 --> 00:03:12.508
client.

00:03:12.818 --> 00:03:13.058
Now,

00:03:13.218 --> 00:03:14.658
you could also access

00:03:15.218 --> 00:03:15.618
from

00:03:15.938 --> 00:03:17.938
the durable object context,

00:03:22.074 --> 00:03:23.615
you can get websockets.

00:03:24.335 --> 00:03:26.495
Now what this would do is essentially

00:03:31.305 --> 00:03:31.432
is,

00:03:31.432 --> 00:03:34.272
essentially this is an array of all of the

00:03:34.272 --> 00:03:35.952
websockets that are currently connected.

00:03:35.952 --> 00:03:37.752
So you could just loop through websockets.

00:03:38.372 --> 00:03:39.732
Then for each websocket,

00:03:49.762 --> 00:03:52.216
so for each of these specific websockets,

00:03:52.216 --> 00:03:52.656
you could,

00:03:52.656 --> 00:03:53.216
you know,

00:03:53.216 --> 00:03:53.576
say,

00:03:53.736 --> 00:03:54.456
await

00:03:55.976 --> 00:03:56.536
connection,

00:03:56.776 --> 00:03:57.176
send,

00:03:57.176 --> 00:03:58.896
and then you could send whatever message you

00:03:58.896 --> 00:03:59.496
wanted to send.

00:03:59.496 --> 00:04:01.656
So this would broadcast data to all of the

00:04:01.656 --> 00:04:02.016
clients.

00:04:02.096 --> 00:04:02.376
Now,

00:04:02.376 --> 00:04:03.416
you could also Compare,

00:04:03.416 --> 00:04:03.776
like

00:04:04.256 --> 00:04:06.576
this ID WS.

00:04:07.942 --> 00:04:08.642
You could technically,

00:04:08.642 --> 00:04:09.482
like compare

00:04:09.802 --> 00:04:11.082
this connection with

00:04:11.379 --> 00:04:13.219
the websocket that

00:04:13.699 --> 00:04:14.859
comes in on the message.

00:04:14.859 --> 00:04:16.019
And this is how you would know,

00:04:16.019 --> 00:04:16.259
like,

00:04:16.259 --> 00:04:16.579
if

00:04:16.979 --> 00:04:17.859
this connection

00:04:18.259 --> 00:04:18.819
equals

00:04:19.569 --> 00:04:20.649
this websocket,

00:04:20.649 --> 00:04:21.129
you know,

00:04:21.129 --> 00:04:22.929
like the person that sent the message

00:04:23.489 --> 00:04:25.849
is part of this connection that's being iterated

00:04:25.849 --> 00:04:26.009
through,

00:04:26.009 --> 00:04:26.409
then you could,

00:04:26.409 --> 00:04:26.569
like,

00:04:26.569 --> 00:04:27.529
maybe not send them data.

00:04:27.529 --> 00:04:28.329
So this is really just.

00:04:28.329 --> 00:04:29.689
I know this is probably a little bit confusing,

00:04:29.689 --> 00:04:31.289
but just kind of think about it,

00:04:31.289 --> 00:04:31.489
like,

00:04:31.489 --> 00:04:31.809
you,

00:04:31.979 --> 00:04:32.989
get a message here,

00:04:32.989 --> 00:04:35.549
and then you also get a specific websocket that

00:04:35.549 --> 00:04:36.069
sent it.

00:04:36.149 --> 00:04:38.469
But you could also call this method to get all of

00:04:38.469 --> 00:04:39.229
the connections.

00:04:39.229 --> 00:04:40.589
So all of the websockets that are currently

00:04:40.589 --> 00:04:42.269
connected or all the clients that are currently

00:04:42.269 --> 00:04:43.469
connected to your server.

00:04:43.469 --> 00:04:45.869
So that is like one basic thing of the API.

00:04:45.869 --> 00:04:48.429
And then these things fire whenever these events

00:04:48.429 --> 00:04:48.709
happen.

00:04:48.789 --> 00:04:49.869
So whenever an error happens,

00:04:49.869 --> 00:04:50.469
a Message happens,

00:04:50.469 --> 00:04:51.809
or WebSocket closes.

00:04:52.209 --> 00:04:52.609
Now,

00:04:52.929 --> 00:04:54.449
we're not going to worry too much about those

00:04:54.449 --> 00:04:54.889
right now.

00:04:54.889 --> 00:04:56.449
What we're going to do is we're going to come into

00:04:56.449 --> 00:04:58.609
our fetch handler and we're going to replace some

00:04:58.609 --> 00:04:59.329
of this stuff.

00:04:59.409 --> 00:04:59.809
So

00:05:00.749 --> 00:05:04.309
in order to like configure your durable object to

00:05:04.309 --> 00:05:05.389
actually be able to

00:05:05.679 --> 00:05:07.749
to actually be able to utilize WebSockets,

00:05:07.829 --> 00:05:10.109
there's kind of common convention the durable

00:05:10.109 --> 00:05:12.749
objects documentation has like this exact pattern.

00:05:12.749 --> 00:05:15.349
But you essentially create a websocket pair from

00:05:15.349 --> 00:05:15.659
this

00:05:16.529 --> 00:05:18.689
from this standard library websocket pair

00:05:19.089 --> 00:05:19.489
and

00:05:20.049 --> 00:05:22.449
then you're going to grab the value.

00:05:22.529 --> 00:05:24.449
So this is ultimately just an object

00:05:25.009 --> 00:05:25.569
index

00:05:25.889 --> 00:05:26.689
0 and 1.

00:05:26.689 --> 00:05:29.009
So you're grabbing WebSocket WebSocket

00:05:29.329 --> 00:05:29.729
and

00:05:30.129 --> 00:05:30.609
the first,

00:05:30.609 --> 00:05:30.929
the,

00:05:30.929 --> 00:05:34.529
the 0 index represents client and the second one

00:05:34.529 --> 00:05:36.369
or the first represents server.

00:05:36.529 --> 00:05:36.929
Now

00:05:38.069 --> 00:05:41.469
the durable object itself has the context and

00:05:41.469 --> 00:05:43.669
there's a method called Accept websocket.

00:05:43.749 --> 00:05:45.629
And when you pass the server into Accept

00:05:45.629 --> 00:05:46.389
websocket,

00:05:46.389 --> 00:05:49.249
this websocket connection is now going to be

00:05:49.249 --> 00:05:50.129
accepted by

00:05:50.619 --> 00:05:52.379
is now going to be accepted by the

00:05:53.069 --> 00:05:54.029
durable object.

00:05:54.029 --> 00:05:57.509
And it knows that this is the exact instance of

00:05:57.509 --> 00:05:59.309
the server that I should keep track of.

00:05:59.709 --> 00:06:01.909
Then from there what you're going to want to do is

00:06:01.909 --> 00:06:02.909
you're going to want to return

00:06:04.349 --> 00:06:05.709
a new response

00:06:06.909 --> 00:06:09.149
and that new response is not going to have any

00:06:09.149 --> 00:06:10.349
data that is returned.

00:06:10.669 --> 00:06:11.069
But

00:06:11.389 --> 00:06:11.949
in these

00:06:12.099 --> 00:06:14.939
in the actual like status and the type,

00:06:14.939 --> 00:06:16.379
what you're going to do is you're going to say the

00:06:16.379 --> 00:06:19.059
status is of the type 101 which is a

00:06:19.379 --> 00:06:20.329
WebSocket

00:06:20.329 --> 00:06:22.639
status which basically means connection must stay

00:06:22.639 --> 00:06:22.919
open,

00:06:22.919 --> 00:06:26.319
client should not close that status or close that

00:06:26.319 --> 00:06:26.759
connection.

00:06:26.999 --> 00:06:29.119
And then you're going to pass in WebSocket and

00:06:29.119 --> 00:06:30.279
then you'll pass the client.

00:06:30.679 --> 00:06:32.439
And what this does is this basically

00:06:32.729 --> 00:06:35.099
establishes a two way connection between a client

00:06:35.259 --> 00:06:36.308
and a server.

00:06:36.578 --> 00:06:36.818
Then

00:06:37.302 --> 00:06:39.679
from your like actual entry point.

00:06:39.759 --> 00:06:41.439
So we have this dummy thing right here.

00:06:41.919 --> 00:06:44.079
This now instead of taking a

00:06:44.479 --> 00:06:47.879
like a traditional get request is actually going

00:06:47.879 --> 00:06:48.239
to

00:06:48.539 --> 00:06:49.538
be able to proxy

00:06:49.803 --> 00:06:50.203
the

00:06:50.223 --> 00:06:51.443
to be able to proxy the

00:06:51.763 --> 00:06:55.083
web socket request and then there's going to be a

00:06:55.083 --> 00:06:57.203
two way persist persistent connection that is

00:06:57.203 --> 00:06:57.358
made.

00:06:57.510 --> 00:06:59.430
Now in order to actually ensure that this is

00:06:59.430 --> 00:07:01.390
indeed a websocket connection there's some

00:07:01.390 --> 00:07:02.900
additional things that you'll have to do.

00:07:02.900 --> 00:07:04.310
usually you'll do these manually.

00:07:04.310 --> 00:07:07.230
Like the example would be you need to check

00:07:07.300 --> 00:07:09.090
you need to like check the upgraded header

00:07:09.570 --> 00:07:11.330
and make sure that,

00:07:11.395 --> 00:07:12.828
and you have to make sure that the,

00:07:12.988 --> 00:07:15.468
that the header is indeed upgraded or

00:07:15.788 --> 00:07:18.428
if ensure that it is indeed a

00:07:18.598 --> 00:07:20.718
websocket connection from the header of the

00:07:20.718 --> 00:07:21.158
request

00:07:21.478 --> 00:07:23.558
and then from there this code should actually

00:07:24.208 --> 00:07:24.928
maintain a

00:07:24.988 --> 00:07:25.768
Steady connection,

00:07:25.928 --> 00:07:26.928
client to server.

00:07:26.928 --> 00:07:27.288
Now,

00:07:27.288 --> 00:07:29.528
what we're going to do for the purpose of this,

00:07:30.038 --> 00:07:31.158
for the purpose of this,

00:07:31.738 --> 00:07:32.458
example,

00:07:32.698 --> 00:07:35.498
what I'm going to do is I'm going to rename the

00:07:37.108 --> 00:07:38.388
path to Client

00:07:38.868 --> 00:07:41.828
socket and then I'm just going to take an account

00:07:41.828 --> 00:07:44.508
ID and we're basically just going to like do some

00:07:44.508 --> 00:07:46.228
dummy data for the account ID for now.

00:07:46.308 --> 00:07:48.468
We'll add this later to actually ensure that it

00:07:48.788 --> 00:07:49.908
is working as expected.

00:07:49.988 --> 00:07:50.388
But,

00:07:51.088 --> 00:07:52.608
I think later what we're going to be able to do is

00:07:52.608 --> 00:07:55.088
we'll be able to extract this from the

00:07:56.506 --> 00:07:57.041
You know what,

00:07:57.041 --> 00:07:59.121
I actually do think this is probably the better

00:07:59.121 --> 00:07:59.761
route for now.

00:07:59.761 --> 00:08:02.361
So we'll just basically say client socket

00:08:02.761 --> 00:08:05.241
and we will pass in an account

00:08:05.561 --> 00:08:06.441
ID here.

00:08:06.761 --> 00:08:07.182
All right.

00:08:07.564 --> 00:08:08.604
So I'm actually,

00:08:08.844 --> 00:08:11.884
instead of pulling the account as a parameter,

00:08:12.284 --> 00:08:13.244
I'm going to

00:08:13.804 --> 00:08:16.064
have it just say click socket is the

00:08:16.064 --> 00:08:18.224
path and then I'm going to extract it from the

00:08:18.224 --> 00:08:18.584
headers.

00:08:18.584 --> 00:08:20.744
And the reason why I'm doing this now is because

00:08:21.064 --> 00:08:23.304
in the future you might want to extend,

00:08:23.504 --> 00:08:23.984
some like,

00:08:23.984 --> 00:08:26.304
custom authentication at this level as well,

00:08:26.384 --> 00:08:28.064
and that would probably come from the header.

00:08:28.064 --> 00:08:29.664
So we're going to be grabbing that from the

00:08:29.664 --> 00:08:31.144
headers and then we're going to be proxying it

00:08:31.144 --> 00:08:31.424
through.

00:08:31.424 --> 00:08:34.064
So I think this is enough for the boilerplate of

00:08:34.064 --> 00:08:34.704
the setup.

00:08:34.824 --> 00:08:36.414
just to kind of recap what we have here,

00:08:36.894 --> 00:08:38.614
I would just make sure you get all the code ready

00:08:38.614 --> 00:08:39.454
for the next section,

00:08:39.454 --> 00:08:41.014
because essentially what we're going to do is

00:08:41.014 --> 00:08:42.814
we're going to integrate this into our ui,

00:08:43.254 --> 00:08:45.214
just to make sure that we're able to establish a

00:08:45.214 --> 00:08:46.214
connection with our,

00:08:46.864 --> 00:08:48.264
with our durable object,

00:08:48.264 --> 00:08:49.665
and then we'll kind of go from there.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.098 --> 00:00:00.658
All right,

00:00:00.898 --> 00:00:03.778
so let's get into the websocket aspect of this

00:00:03.778 --> 00:00:05.218
section of the course.

00:00:05.618 --> 00:00:07.058
Now before we get started,

00:00:07.728 --> 00:00:09.998
if you're totally new to websockets and durable

00:00:09.998 --> 00:00:10.518
objects,

00:00:10.518 --> 00:00:12.828
if you just literally Google or YouTube,

00:00:12.828 --> 00:00:13.518
durable objects,

00:00:13.518 --> 00:00:14.198
WebSockets,

00:00:14.358 --> 00:00:14.998
this video

00:00:15.318 --> 00:00:16.198
should be the,

00:00:16.278 --> 00:00:17.398
probably the first one.

00:00:17.638 --> 00:00:20.038
It's done pretty well for how niche it is and

00:00:20.438 --> 00:00:21.878
it goes into very,

00:00:21.878 --> 00:00:22.118
very,

00:00:22.118 --> 00:00:22.358
very,

00:00:22.358 --> 00:00:22.638
very,

00:00:22.638 --> 00:00:23.398
very deep

00:00:23.488 --> 00:00:25.338
detail for how the websockets work and,

00:00:25.408 --> 00:00:27.978
and you actually build out a real time Excalidraw,

00:00:28.528 --> 00:00:29.768
application on top of it.

00:00:29.768 --> 00:00:31.328
So within 40 minutes,

00:00:31.328 --> 00:00:31.968
honestly you'll,

00:00:31.968 --> 00:00:33.008
you'll take away a lot.

00:00:33.168 --> 00:00:35.008
Now we're going to cover the exact same things

00:00:35.008 --> 00:00:35.328
here,

00:00:35.598 --> 00:00:37.438
and we're going to go equally as deep.

00:00:37.438 --> 00:00:40.198
But I would say this is probably going to be like

00:00:40.198 --> 00:00:41.278
a more concise

00:00:41.568 --> 00:00:42.288
overview.

00:00:42.448 --> 00:00:44.008
So you could go watch that if you want,

00:00:44.008 --> 00:00:44.688
but you don't have to.

00:00:44.688 --> 00:00:45.088
Now,

00:00:45.758 --> 00:00:48.438
the very first thing with websockets to notice is

00:00:48.438 --> 00:00:51.038
the durable objects class has some

00:00:51.818 --> 00:00:54.258
different like helper functions that are built in.

00:00:54.258 --> 00:00:55.178
So like you have

00:00:55.498 --> 00:00:56.698
WebSocket close,

00:00:57.098 --> 00:00:57.738
you have

00:00:58.858 --> 00:01:00.218
WebSocket message

00:01:00.858 --> 00:01:01.898
and you have

00:01:02.872 --> 00:01:03.798
WebSocket error.

00:01:03.798 --> 00:01:05.398
So these are kind of events that happen

00:01:05.718 --> 00:01:06.278
typically

00:01:06.598 --> 00:01:08.478
like server side and client side.

00:01:08.478 --> 00:01:09.238
Like if a,

00:01:10.058 --> 00:01:12.378
if a websocket was to be closed on the

00:01:12.395 --> 00:01:13.294
client side of things,

00:01:13.294 --> 00:01:15.494
the server also knows that that is closed and then

00:01:15.494 --> 00:01:16.174
this will fire,

00:01:17.044 --> 00:01:19.684
if a message is sent from the client to the server

00:01:20.084 --> 00:01:22.444
this is going to trigger and then if there's an

00:01:22.444 --> 00:01:23.364
error in the websocket,

00:01:23.364 --> 00:01:24.164
this is going to trigger.

00:01:24.164 --> 00:01:24.484
Now

00:01:24.834 --> 00:01:25.054
the,

00:01:25.054 --> 00:01:27.694
the common convention for like basically being

00:01:27.694 --> 00:01:28.574
able to like,

00:01:28.734 --> 00:01:29.214
you know,

00:01:29.214 --> 00:01:31.614
manage websocket life cycle is you have a,

00:01:31.833 --> 00:01:34.360
you typically will have a client right here

00:01:35.080 --> 00:01:36.890
and you'll have a server and it

00:01:36.890 --> 00:01:39.320
will establish a two way connection

00:01:40.064 --> 00:01:41.984
and this connection stays persisted.

00:01:41.984 --> 00:01:43.264
So basically it does not close.

00:01:43.344 --> 00:01:43.904
And then

00:01:44.224 --> 00:01:45.504
you can have multiple clients.

00:01:45.504 --> 00:01:46.785
So these are clients over here.

00:01:46.986 --> 00:01:49.146
We'll just call this three clients for now.

00:01:49.157 --> 00:01:51.416
And each one of these three clients is going to

00:01:51.416 --> 00:01:51.976
have a

00:01:52.206 --> 00:01:53.896
is going to have a persistent connection.

00:01:55.016 --> 00:01:55.416
Now,

00:01:59.570 --> 00:02:01.970
now if this client sends a message over

00:02:02.450 --> 00:02:03.650
to the server,

00:02:03.890 --> 00:02:06.250
the server can read the message and determine what

00:02:06.250 --> 00:02:08.770
to do and typically it's going to like respond

00:02:09.010 --> 00:02:11.332
with another message back to the client.

00:02:11.332 --> 00:02:14.150
Now the server also keeps track of all the clients

00:02:14.150 --> 00:02:15.910
that are connected at a given point in time.

00:02:15.990 --> 00:02:18.790
So you could have a flow where you basically one

00:02:18.790 --> 00:02:20.390
client sends something over here

00:02:20.870 --> 00:02:21.710
and then the server says,

00:02:21.710 --> 00:02:21.990
okay,

00:02:21.990 --> 00:02:24.510
I want to relay that message to this one and this

00:02:24.510 --> 00:02:25.350
one at the same time.

00:02:25.430 --> 00:02:27.510
So this guy sends something and then this,

00:02:27.590 --> 00:02:28.710
the server pushes,

00:02:29.300 --> 00:02:31.580
the data back to these clients over here.

00:02:32.140 --> 00:02:33.900
So if you were to just basically have like some

00:02:33.900 --> 00:02:35.180
type of relay service,

00:02:35.260 --> 00:02:37.700
like the client sends data and then it sends it

00:02:37.700 --> 00:02:37.980
back,

00:02:38.220 --> 00:02:40.100
essentially the implementation would look like you

00:02:40.100 --> 00:02:40.380
would say,

00:02:40.380 --> 00:02:41.020
await

00:02:41.740 --> 00:02:46.180
websocket.send and you would send whatever message

00:02:46.180 --> 00:02:46.540
you want.

00:02:46.540 --> 00:02:46.740
So,

00:02:46.740 --> 00:02:46.900
like,

00:02:46.900 --> 00:02:48.300
we could just basically pass in,

00:02:48.880 --> 00:02:49.040
or,

00:02:49.040 --> 00:02:49.400
sorry,

00:02:49.400 --> 00:02:50.480
this is the wrong method.

00:02:50.640 --> 00:02:53.280
So this is on websocket message and you could pass

00:02:53.280 --> 00:02:55.840
in the message that was received.

00:02:56.160 --> 00:02:56.560
So

00:02:56.960 --> 00:02:58.480
essentially what would happen here,

00:02:58.480 --> 00:03:00.800
it looks like it wants an array or a string buffer

00:03:00.880 --> 00:03:02.560
and this one wants message.

00:03:02.560 --> 00:03:03.846
So basically it's going to say

00:03:03.846 --> 00:03:05.156
Just make sure that's async.

00:03:05.156 --> 00:03:05.596
Okay,

00:03:05.676 --> 00:03:05.954
so

00:03:05.954 --> 00:03:07.758
essentially what would happen here is when the

00:03:07.758 --> 00:03:09.838
client connects to the server and the client sends

00:03:09.838 --> 00:03:10.238
a message,

00:03:10.238 --> 00:03:12.158
that exact same message would be sent back to the

00:03:12.158 --> 00:03:12.508
client.

00:03:12.818 --> 00:03:13.058
Now,

00:03:13.218 --> 00:03:14.658
you could also access

00:03:15.218 --> 00:03:15.618
from

00:03:15.938 --> 00:03:17.938
the durable object context,

00:03:22.074 --> 00:03:23.615
you can get websockets.

00:03:24.335 --> 00:03:26.495
Now what this would do is essentially

00:03:31.305 --> 00:03:31.432
is,

00:03:31.432 --> 00:03:34.272
essentially this is an array of all of the

00:03:34.272 --> 00:03:35.952
websockets that are currently connected.

00:03:35.952 --> 00:03:37.752
So you could just loop through websockets.

00:03:38.372 --> 00:03:39.732
Then for each websocket,

00:03:49.762 --> 00:03:52.216
so for each of these specific websockets,

00:03:52.216 --> 00:03:52.656
you could,

00:03:52.656 --> 00:03:53.216
you know,

00:03:53.216 --> 00:03:53.576
say,

00:03:53.736 --> 00:03:54.456
await

00:03:55.976 --> 00:03:56.536
connection,

00:03:56.776 --> 00:03:57.176
send,

00:03:57.176 --> 00:03:58.896
and then you could send whatever message you

00:03:58.896 --> 00:03:59.496
wanted to send.

00:03:59.496 --> 00:04:01.656
So this would broadcast data to all of the

00:04:01.656 --> 00:04:02.016
clients.

00:04:02.096 --> 00:04:02.376
Now,

00:04:02.376 --> 00:04:03.416
you could also Compare,

00:04:03.416 --> 00:04:03.776
like

00:04:04.256 --> 00:04:06.576
this ID WS.

00:04:07.942 --> 00:04:08.642
You could technically,

00:04:08.642 --> 00:04:09.482
like compare

00:04:09.802 --> 00:04:11.082
this connection with

00:04:11.379 --> 00:04:13.219
the websocket that

00:04:13.699 --> 00:04:14.859
comes in on the message.

00:04:14.859 --> 00:04:16.019
And this is how you would know,

00:04:16.019 --> 00:04:16.259
like,

00:04:16.259 --> 00:04:16.579
if

00:04:16.979 --> 00:04:17.859
this connection

00:04:18.259 --> 00:04:18.819
equals

00:04:19.569 --> 00:04:20.649
this websocket,

00:04:20.649 --> 00:04:21.129
you know,

00:04:21.129 --> 00:04:22.929
like the person that sent the message

00:04:23.489 --> 00:04:25.849
is part of this connection that's being iterated

00:04:25.849 --> 00:04:26.009
through,

00:04:26.009 --> 00:04:26.409
then you could,

00:04:26.409 --> 00:04:26.569
like,

00:04:26.569 --> 00:04:27.529
maybe not send them data.

00:04:27.529 --> 00:04:28.329
So this is really just.

00:04:28.329 --> 00:04:29.689
I know this is probably a little bit confusing,

00:04:29.689 --> 00:04:31.289
but just kind of think about it,

00:04:31.289 --> 00:04:31.489
like,

00:04:31.489 --> 00:04:31.809
you,

00:04:31.979 --> 00:04:32.989
get a message here,

00:04:32.989 --> 00:04:35.549
and then you also get a specific websocket that

00:04:35.549 --> 00:04:36.069
sent it.

00:04:36.149 --> 00:04:38.469
But you could also call this method to get all of

00:04:38.469 --> 00:04:39.229
the connections.

00:04:39.229 --> 00:04:40.589
So all of the websockets that are currently

00:04:40.589 --> 00:04:42.269
connected or all the clients that are currently

00:04:42.269 --> 00:04:43.469
connected to your server.

00:04:43.469 --> 00:04:45.869
So that is like one basic thing of the API.

00:04:45.869 --> 00:04:48.429
And then these things fire whenever these events

00:04:48.429 --> 00:04:48.709
happen.

00:04:48.789 --> 00:04:49.869
So whenever an error happens,

00:04:49.869 --> 00:04:50.469
a Message happens,

00:04:50.469 --> 00:04:51.809
or WebSocket closes.

00:04:52.209 --> 00:04:52.609
Now,

00:04:52.929 --> 00:04:54.449
we're not going to worry too much about those

00:04:54.449 --> 00:04:54.889
right now.

00:04:54.889 --> 00:04:56.449
What we're going to do is we're going to come into

00:04:56.449 --> 00:04:58.609
our fetch handler and we're going to replace some

00:04:58.609 --> 00:04:59.329
of this stuff.

00:04:59.409 --> 00:04:59.809
So

00:05:00.749 --> 00:05:04.309
in order to like configure your durable object to

00:05:04.309 --> 00:05:05.389
actually be able to

00:05:05.679 --> 00:05:07.749
to actually be able to utilize WebSockets,

00:05:07.829 --> 00:05:10.109
there's kind of common convention the durable

00:05:10.109 --> 00:05:12.749
objects documentation has like this exact pattern.

00:05:12.749 --> 00:05:15.349
But you essentially create a websocket pair from

00:05:15.349 --> 00:05:15.659
this

00:05:16.529 --> 00:05:18.689
from this standard library websocket pair

00:05:19.089 --> 00:05:19.489
and

00:05:20.049 --> 00:05:22.449
then you're going to grab the value.

00:05:22.529 --> 00:05:24.449
So this is ultimately just an object

00:05:25.009 --> 00:05:25.569
index

00:05:25.889 --> 00:05:26.689
0 and 1.

00:05:26.689 --> 00:05:29.009
So you're grabbing WebSocket WebSocket

00:05:29.329 --> 00:05:29.729
and

00:05:30.129 --> 00:05:30.609
the first,

00:05:30.609 --> 00:05:30.929
the,

00:05:30.929 --> 00:05:34.529
the 0 index represents client and the second one

00:05:34.529 --> 00:05:36.369
or the first represents server.

00:05:36.529 --> 00:05:36.929
Now

00:05:38.069 --> 00:05:41.469
the durable object itself has the context and

00:05:41.469 --> 00:05:43.669
there's a method called Accept websocket.

00:05:43.749 --> 00:05:45.629
And when you pass the server into Accept

00:05:45.629 --> 00:05:46.389
websocket,

00:05:46.389 --> 00:05:49.249
this websocket connection is now going to be

00:05:49.249 --> 00:05:50.129
accepted by

00:05:50.619 --> 00:05:52.379
is now going to be accepted by the

00:05:53.069 --> 00:05:54.029
durable object.

00:05:54.029 --> 00:05:57.509
And it knows that this is the exact instance of

00:05:57.509 --> 00:05:59.309
the server that I should keep track of.

00:05:59.709 --> 00:06:01.909
Then from there what you're going to want to do is

00:06:01.909 --> 00:06:02.909
you're going to want to return

00:06:04.349 --> 00:06:05.709
a new response

00:06:06.909 --> 00:06:09.149
and that new response is not going to have any

00:06:09.149 --> 00:06:10.349
data that is returned.

00:06:10.669 --> 00:06:11.069
But

00:06:11.389 --> 00:06:11.949
in these

00:06:12.099 --> 00:06:14.939
in the actual like status and the type,

00:06:14.939 --> 00:06:16.379
what you're going to do is you're going to say the

00:06:16.379 --> 00:06:19.059
status is of the type 101 which is a

00:06:19.379 --> 00:06:20.329
WebSocket

00:06:20.329 --> 00:06:22.639
status which basically means connection must stay

00:06:22.639 --> 00:06:22.919
open,

00:06:22.919 --> 00:06:26.319
client should not close that status or close that

00:06:26.319 --> 00:06:26.759
connection.

00:06:26.999 --> 00:06:29.119
And then you're going to pass in WebSocket and

00:06:29.119 --> 00:06:30.279
then you'll pass the client.

00:06:30.679 --> 00:06:32.439
And what this does is this basically

00:06:32.729 --> 00:06:35.099
establishes a two way connection between a client

00:06:35.259 --> 00:06:36.308
and a server.

00:06:36.578 --> 00:06:36.818
Then

00:06:37.302 --> 00:06:39.679
from your like actual entry point.

00:06:39.759 --> 00:06:41.439
So we have this dummy thing right here.

00:06:41.919 --> 00:06:44.079
This now instead of taking a

00:06:44.479 --> 00:06:47.879
like a traditional get request is actually going

00:06:47.879 --> 00:06:48.239
to

00:06:48.539 --> 00:06:49.538
be able to proxy

00:06:49.803 --> 00:06:50.203
the

00:06:50.223 --> 00:06:51.443
to be able to proxy the

00:06:51.763 --> 00:06:55.083
web socket request and then there's going to be a

00:06:55.083 --> 00:06:57.203
two way persist persistent connection that is

00:06:57.203 --> 00:06:57.358
made.

00:06:57.510 --> 00:06:59.430
Now in order to actually ensure that this is

00:06:59.430 --> 00:07:01.390
indeed a websocket connection there's some

00:07:01.390 --> 00:07:02.900
additional things that you'll have to do.

00:07:02.900 --> 00:07:04.310
usually you'll do these manually.

00:07:04.310 --> 00:07:07.230
Like the example would be you need to check

00:07:07.300 --> 00:07:09.090
you need to like check the upgraded header

00:07:09.570 --> 00:07:11.330
and make sure that,

00:07:11.395 --> 00:07:12.828
and you have to make sure that the,

00:07:12.988 --> 00:07:15.468
that the header is indeed upgraded or

00:07:15.788 --> 00:07:18.428
if ensure that it is indeed a

00:07:18.598 --> 00:07:20.718
websocket connection from the header of the

00:07:20.718 --> 00:07:21.158
request

00:07:21.478 --> 00:07:23.558
and then from there this code should actually

00:07:24.208 --> 00:07:24.928
maintain a

00:07:24.988 --> 00:07:25.768
Steady connection,

00:07:25.928 --> 00:07:26.928
client to server.

00:07:26.928 --> 00:07:27.288
Now,

00:07:27.288 --> 00:07:29.528
what we're going to do for the purpose of this,

00:07:30.038 --> 00:07:31.158
for the purpose of this,

00:07:31.738 --> 00:07:32.458
example,

00:07:32.698 --> 00:07:35.498
what I'm going to do is I'm going to rename the

00:07:37.108 --> 00:07:38.388
path to Client

00:07:38.868 --> 00:07:41.828
socket and then I'm just going to take an account

00:07:41.828 --> 00:07:44.508
ID and we're basically just going to like do some

00:07:44.508 --> 00:07:46.228
dummy data for the account ID for now.

00:07:46.308 --> 00:07:48.468
We'll add this later to actually ensure that it

00:07:48.788 --> 00:07:49.908
is working as expected.

00:07:49.988 --> 00:07:50.388
But,

00:07:51.088 --> 00:07:52.608
I think later what we're going to be able to do is

00:07:52.608 --> 00:07:55.088
we'll be able to extract this from the

00:07:56.506 --> 00:07:57.041
You know what,

00:07:57.041 --> 00:07:59.121
I actually do think this is probably the better

00:07:59.121 --> 00:07:59.761
route for now.

00:07:59.761 --> 00:08:02.361
So we'll just basically say client socket

00:08:02.761 --> 00:08:05.241
and we will pass in an account

00:08:05.561 --> 00:08:06.441
ID here.

00:08:06.761 --> 00:08:07.182
All right.

00:08:07.564 --> 00:08:08.604
So I'm actually,

00:08:08.844 --> 00:08:11.884
instead of pulling the account as a parameter,

00:08:12.284 --> 00:08:13.244
I'm going to

00:08:13.804 --> 00:08:16.064
have it just say click socket is the

00:08:16.064 --> 00:08:18.224
path and then I'm going to extract it from the

00:08:18.224 --> 00:08:18.584
headers.

00:08:18.584 --> 00:08:20.744
And the reason why I'm doing this now is because

00:08:21.064 --> 00:08:23.304
in the future you might want to extend,

00:08:23.504 --> 00:08:23.984
some like,

00:08:23.984 --> 00:08:26.304
custom authentication at this level as well,

00:08:26.384 --> 00:08:28.064
and that would probably come from the header.

00:08:28.064 --> 00:08:29.664
So we're going to be grabbing that from the

00:08:29.664 --> 00:08:31.144
headers and then we're going to be proxying it

00:08:31.144 --> 00:08:31.424
through.

00:08:31.424 --> 00:08:34.064
So I think this is enough for the boilerplate of

00:08:34.064 --> 00:08:34.704
the setup.

00:08:34.824 --> 00:08:36.414
just to kind of recap what we have here,

00:08:36.894 --> 00:08:38.614
I would just make sure you get all the code ready

00:08:38.614 --> 00:08:39.454
for the next section,

00:08:39.454 --> 00:08:41.014
because essentially what we're going to do is

00:08:41.014 --> 00:08:42.814
we're going to integrate this into our ui,

00:08:43.254 --> 00:08:45.214
just to make sure that we're able to establish a

00:08:45.214 --> 00:08:46.214
connection with our,

00:08:46.864 --> 00:08:48.264
with our durable object,

00:08:48.264 --> 00:08:49.665
and then we'll kind of go from there.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.000 --> 00:00:00.436
All right,

00:00:00.436 --> 00:00:02.316
so now before we keep building this out,

00:00:02.476 --> 00:00:05.916
let's go ahead and ensure that this is all working

00:00:05.916 --> 00:00:07.956
locally and that our websocket connection is

00:00:07.956 --> 00:00:09.836
actually reaching our durable object.

00:00:09.916 --> 00:00:11.676
So what we can do is

00:00:11.996 --> 00:00:13.036
I'm going to

00:00:13.516 --> 00:00:15.196
open a new terminal here

00:00:15.756 --> 00:00:18.476
and I'm going to CD into user application.

00:00:18.716 --> 00:00:22.076
So let's just go back one CD user application

00:00:22.396 --> 00:00:24.236
and then I'm going to go ahead and run this guy.

00:00:24.236 --> 00:00:25.916
So pnpm run dev.

00:00:27.274 --> 00:00:27.514
Now

00:00:28.314 --> 00:00:30.034
in this side we're also in the data service

00:00:30.034 --> 00:00:30.554
application,

00:00:30.554 --> 00:00:32.274
so I'm going to go ahead and start this up as

00:00:32.274 --> 00:00:32.474
well.

00:00:32.474 --> 00:00:33.274
Pnpm.

00:00:39.274 --> 00:00:39.754
Alright,

00:00:39.754 --> 00:00:41.114
so now that both of these are running,

00:00:41.193 --> 00:00:43.474
what we're going to want to do is we're going to

00:00:43.474 --> 00:00:46.154
want to head over to our user application and

00:00:46.154 --> 00:00:48.154
inside of our user application we should have

00:00:48.154 --> 00:00:48.874
these hooks

00:00:49.274 --> 00:00:50.954
and there's a file called

00:00:51.302 --> 00:00:52.102
click sockets.

00:00:52.102 --> 00:00:54.062
Right now this is just kind of like a dummy hook

00:00:54.062 --> 00:00:55.062
that doesn't do anything.

00:00:55.062 --> 00:00:58.022
But ultimately what happens is inside of our

00:00:58.022 --> 00:00:58.662
dashboard

00:00:59.062 --> 00:01:02.662
we have these maps and these maps are utilizing a

00:01:03.062 --> 00:01:04.272
geoclick store,

00:01:04.272 --> 00:01:05.462
which is ultimately being

00:01:06.022 --> 00:01:07.012
powered by the,

00:01:07.232 --> 00:01:08.032
by our,

00:01:08.112 --> 00:01:09.712
our client socket.

00:01:09.712 --> 00:01:11.712
So we can go ahead and actually search

00:01:12.272 --> 00:01:14.632
inside of our project if you want to see exactly

00:01:14.632 --> 00:01:15.552
where this is utilized.

00:01:15.552 --> 00:01:15.872
But

00:01:16.522 --> 00:01:17.482
inside of our

00:01:17.742 --> 00:01:18.762
index ts,

00:01:18.842 --> 00:01:21.482
we are going to be establishing a connection

00:01:21.882 --> 00:01:23.242
at the root component.

00:01:23.242 --> 00:01:25.082
So essentially right when the component loads,

00:01:25.082 --> 00:01:26.602
we're going to try to reach out to our

00:01:26.782 --> 00:01:27.322
server.

00:01:27.322 --> 00:01:27.722
So

00:01:28.042 --> 00:01:29.962
let's just go ahead and look at this file.

00:01:29.962 --> 00:01:31.442
So right now it's not doing anything.

00:01:31.442 --> 00:01:33.482
And if you look at

00:01:33.962 --> 00:01:35.642
this guy running on localhost,

00:01:39.576 --> 00:01:40.976
I'm just going to make sure that this is running

00:01:40.976 --> 00:01:41.896
on Port 3000

00:01:42.284 --> 00:01:43.724
so we should be able to open this.

00:01:44.284 --> 00:01:45.652
Might take a second to load,

00:01:45.652 --> 00:01:46.707
but once it spins up,

00:01:46.707 --> 00:01:48.014
let's head over to our dashboard

00:01:48.014 --> 00:01:50.031
and what we're going to notice is there's this

00:01:50.031 --> 00:01:52.511
little flag right here that says disconnected.

00:01:52.871 --> 00:01:54.831
if we open up our

00:01:56.191 --> 00:01:58.591
console we can head over to the network tab as

00:01:58.591 --> 00:01:58.831
well.

00:01:59.561 --> 00:02:01.121
And what we're going to do is we're going to build

00:02:01.121 --> 00:02:04.241
out some logic to manage this web socket.

00:02:04.241 --> 00:02:06.201
Now I actually already have the code for that.

00:02:06.511 --> 00:02:07.941
this is just a bunch of boilerplate.

00:02:07.941 --> 00:02:09.741
I'll skim over it really quickly so you know

00:02:09.741 --> 00:02:10.301
what's happening.

00:02:10.301 --> 00:02:12.821
But don't pay too much attention because there are

00:02:12.821 --> 00:02:14.701
like also libraries that help you manage

00:02:14.851 --> 00:02:15.961
WebSocket connections.

00:02:15.961 --> 00:02:16.321
So

00:02:16.641 --> 00:02:18.601
essentially what we're doing is we're having a few

00:02:18.601 --> 00:02:19.721
different state variables.

00:02:19.721 --> 00:02:21.921
But the main focus here Is we have a

00:02:22.091 --> 00:02:22.921
websocket.

00:02:23.321 --> 00:02:23.721
Now

00:02:24.011 --> 00:02:25.811
when the component mounts for the very first time,

00:02:25.811 --> 00:02:27.451
what we do is we are going to

00:02:28.051 --> 00:02:31.631
pass in the path to our websocket and the host and

00:02:31.631 --> 00:02:33.311
the protocol which is going to be

00:02:34.311 --> 00:02:37.671
WS if you're developing locally and then websocket

00:02:37.671 --> 00:02:39.031
secure if you are

00:02:39.641 --> 00:02:41.721
if you are actually running in production and it's

00:02:41.721 --> 00:02:42.761
just basically looking at

00:02:43.161 --> 00:02:43.561
your

00:02:43.961 --> 00:02:45.001
window protocol.

00:02:45.001 --> 00:02:48.001
So like if you're like on HTTPs it's going to go

00:02:48.001 --> 00:02:48.921
to wwe.

00:02:48.921 --> 00:02:50.441
If not it will be wc.

00:02:50.441 --> 00:02:50.841
Now

00:02:51.251 --> 00:02:51.811
from here

00:02:52.022 --> 00:02:53.622
essentially on open

00:02:54.022 --> 00:02:56.102
we are just going to be setting that connected as

00:02:56.102 --> 00:02:56.502
true

00:02:57.062 --> 00:02:58.102
and then

00:02:58.412 --> 00:03:00.862
whenever it receives a message it's going to be

00:03:00.862 --> 00:03:03.342
getting that message from the server and it's

00:03:03.342 --> 00:03:04.502
going to be passing that data

00:03:04.972 --> 00:03:07.962
into an ad clicks which is ultimately going from

00:03:07.962 --> 00:03:09.402
this like Zustan store.

00:03:09.402 --> 00:03:10.762
So I know I'm covering a lot.

00:03:10.762 --> 00:03:12.282
These are all things that are kind of like beyond

00:03:12.282 --> 00:03:13.082
the scope of this course.

00:03:13.082 --> 00:03:15.602
But we do have this component that is managing

00:03:15.602 --> 00:03:17.362
state and then that state is going to be reflected

00:03:17.362 --> 00:03:18.202
through the application.

00:03:18.202 --> 00:03:20.002
So ultimately it's just being passed into this

00:03:20.492 --> 00:03:21.272
add clicks.

00:03:21.272 --> 00:03:23.472
there's a lot of videos out there on this library

00:03:23.472 --> 00:03:26.072
Zust and it is awesome for managing state across

00:03:26.072 --> 00:03:27.480
like a really big application.

00:03:28.318 --> 00:03:28.718
Now

00:03:29.318 --> 00:03:32.408
from here essentially like that's kind of like the

00:03:32.408 --> 00:03:33.248
core of what's happening.

00:03:33.248 --> 00:03:35.888
We're mostly just like connecting to a websocket

00:03:35.888 --> 00:03:37.888
and then whenever we get messages we're adding

00:03:37.888 --> 00:03:38.928
those messages to

00:03:39.448 --> 00:03:39.928
our state.

00:03:40.408 --> 00:03:42.328
Now since we're running this,

00:03:42.868 --> 00:03:44.768
since we're running our dev server

00:03:45.038 --> 00:03:46.718
or our backend service as well,

00:03:46.958 --> 00:03:48.478
this is going to be running on Port

00:03:48.728 --> 00:03:49.658
8787.

00:03:49.738 --> 00:03:51.778
So we can go ahead and we can just like paste this

00:03:51.778 --> 00:03:52.338
guy in here.

00:03:52.338 --> 00:03:54.298
For now we'll override our vite environment

00:03:54.458 --> 00:03:54.938
variable.

00:03:54.938 --> 00:03:56.618
For the time being we're just going to say

00:03:56.618 --> 00:03:58.218
localhost 8787.

00:03:59.705 --> 00:04:02.265
Now we can head back over to our client

00:04:02.265 --> 00:04:02.905
application.

00:04:02.985 --> 00:04:04.425
Looks like there was an issue here.

00:04:04.425 --> 00:04:04.825
Okay,

00:04:04.825 --> 00:04:06.281
so we'll reload this guy

00:04:06.348 --> 00:04:06.988
and then now

00:04:07.208 --> 00:04:09.328
and then what you're going to notice is you're

00:04:09.328 --> 00:04:11.688
going to see these sockets try to establish a

00:04:11.688 --> 00:04:13.128
connection and then it's just going to show as

00:04:13.128 --> 00:04:13.648
finished.

00:04:13.648 --> 00:04:13.968
And

00:04:14.368 --> 00:04:16.368
this is actually not the behavior that we're going

00:04:16.368 --> 00:04:16.688
for.

00:04:16.768 --> 00:04:20.129
the reason why is if you look at our dev server on

00:04:20.129 --> 00:04:20.609
this side,

00:04:20.609 --> 00:04:23.169
we're getting these 400 not found errors.

00:04:23.169 --> 00:04:24.489
And the reason is because

00:04:24.809 --> 00:04:26.729
we are not currently passing in

00:04:27.129 --> 00:04:29.409
a header when we're creating our socket

00:04:29.409 --> 00:04:29.849
connection.

00:04:30.169 --> 00:04:32.929
So if we head over to our app TS in our backend

00:04:32.929 --> 00:04:33.209
service,

00:04:33.859 --> 00:04:34.739
or our data service

00:04:35.059 --> 00:04:37.299
right here where we are grabbing the,

00:04:37.299 --> 00:04:37.559
the

00:04:37.559 --> 00:04:39.239
where we're grabbing the account ID

00:04:39.559 --> 00:04:40.879
from a header right now,

00:04:40.879 --> 00:04:42.599
let's just hard code it so we can

00:04:43.239 --> 00:04:44.999
see this actually make a full

00:04:45.099 --> 00:04:45.559
connection.

00:04:45.639 --> 00:04:46.839
So I'm just gonna say

00:04:50.823 --> 00:04:52.096
now when we reload this page,

00:04:52.096 --> 00:04:53.819
I suspect that this will connect.

00:04:54.202 --> 00:04:54.842
All right,

00:04:54.842 --> 00:04:57.002
so did you see that this went from not connected

00:04:57.002 --> 00:04:57.722
to connected

00:04:58.122 --> 00:04:58.682
on load.

00:04:58.842 --> 00:05:00.682
And this websocket connection,

00:05:00.682 --> 00:05:03.162
you're going to notice the time says pending.

00:05:03.642 --> 00:05:06.042
And this is basically what's happening here is

00:05:06.442 --> 00:05:08.682
it is just having this persistent connection that

00:05:08.682 --> 00:05:10.882
is maintained with the server and then you can see

00:05:10.882 --> 00:05:12.802
that we receive that and this connection has not

00:05:12.802 --> 00:05:13.482
closed yet.

00:05:14.712 --> 00:05:16.232
on our back inside of things.

00:05:16.312 --> 00:05:18.512
I do think it might be kind of cool to illustrate

00:05:18.512 --> 00:05:20.232
if we head over to our

00:05:21.442 --> 00:05:23.282
if we head over to our link tracker,

00:05:23.472 --> 00:05:24.912
this is our backend service,

00:05:24.992 --> 00:05:25.952
we can go ahead and

00:05:26.272 --> 00:05:26.672
say

00:05:27.012 --> 00:05:29.632
websocket error message or let's just say closed

00:05:29.632 --> 00:05:30.312
and we'll just say

00:05:30.632 --> 00:05:31.272
console

00:05:31.672 --> 00:05:32.072
log

00:05:33.912 --> 00:05:35.352
client closed.

00:05:35.736 --> 00:05:36.757
This guy should reload.

00:05:37.157 --> 00:05:37.797
Okay,

00:05:37.877 --> 00:05:38.757
looks like we are

00:05:39.477 --> 00:05:40.837
still connected over here.

00:05:41.077 --> 00:05:43.122
Now I'm going to go ahead and close this tab

00:05:43.155 --> 00:05:45.195
and you can see that we got this client closed

00:05:45.195 --> 00:05:45.475
event.

00:05:45.555 --> 00:05:47.155
Now we are establishing

00:05:47.815 --> 00:05:49.175
two connections

00:05:49.575 --> 00:05:51.375
during the load and that's just kind of how the

00:05:51.375 --> 00:05:52.535
dev server is behaving.

00:05:52.535 --> 00:05:53.895
When we actually deploy this

00:05:54.065 --> 00:05:54.795
we're going to,

00:05:54.795 --> 00:05:56.315
we're actually not going to have like two

00:05:56.315 --> 00:05:56.995
connections.

00:05:56.995 --> 00:05:57.395
So

00:05:57.865 --> 00:05:59.625
essentially like I think this should kind of

00:05:59.625 --> 00:06:01.625
illustrate though that we are able,

00:06:01.705 --> 00:06:02.065
oh,

00:06:02.065 --> 00:06:02.465
the reason,

00:06:02.465 --> 00:06:04.745
I guess we had two of those same windows open.

00:06:04.745 --> 00:06:05.145
But

00:06:05.590 --> 00:06:07.590
I think that this illustrates that we are able to

00:06:07.990 --> 00:06:09.270
come into our

00:06:09.730 --> 00:06:10.630
come into our

00:06:11.590 --> 00:06:14.630
user application and we have this websocket code

00:06:14.630 --> 00:06:16.430
that establishes a connection to this that is

00:06:16.430 --> 00:06:18.750
running locally and then that connection is able

00:06:18.750 --> 00:06:20.310
to actually go into our backend.

00:06:20.310 --> 00:06:22.350
So now we can actually start building out the more

00:06:22.350 --> 00:06:24.470
advanced websocket features on top of durable

00:06:24.470 --> 00:06:25.030
objects.

00:06:25.190 --> 00:06:26.790
But I do want to just

00:06:27.080 --> 00:06:29.490
revert this code because we are going to have vite

00:06:29.490 --> 00:06:30.570
and variables or

00:06:31.210 --> 00:06:34.010
environment variables that will basically pass in

00:06:34.010 --> 00:06:34.410
the

00:06:34.680 --> 00:06:36.560
that will basically pass in the host that we're

00:06:36.560 --> 00:06:37.440
going to be connecting to.

00:06:37.520 --> 00:06:38.800
And spoiler alert,

00:06:38.880 --> 00:06:41.400
we're actually not going to connect to our backend

00:06:41.400 --> 00:06:43.760
service directly from the client application.

00:06:43.760 --> 00:06:45.320
We're actually going to proxy it.

00:06:45.320 --> 00:06:47.600
So what I typically like to do as a,

00:06:47.840 --> 00:06:48.480
as a

00:06:48.650 --> 00:06:49.980
standard practice is

00:06:50.110 --> 00:06:52.683
I like to keep the user application and the

00:06:52.683 --> 00:06:54.483
operations that happen at this layer,

00:06:54.483 --> 00:06:54.763
like,

00:06:54.763 --> 00:06:57.513
very specific to the client application.

00:06:57.513 --> 00:06:59.753
So there's a separation between the data service.

00:06:59.753 --> 00:07:01.473
And the reason why is like,

00:07:01.473 --> 00:07:03.033
technically this is like two different things.

00:07:03.033 --> 00:07:05.073
You have a client that's running on the user's

00:07:05.073 --> 00:07:05.593
browser,

00:07:05.593 --> 00:07:07.353
and then you have your worker code,

00:07:07.433 --> 00:07:09.673
which right now is implementing trpc,

00:07:09.803 --> 00:07:10.993
and that's running on the server.

00:07:10.993 --> 00:07:12.193
So this is honestly,

00:07:12.193 --> 00:07:12.393
like,

00:07:12.393 --> 00:07:13.393
this is also server code.

00:07:13.393 --> 00:07:14.073
But these two,

00:07:14.073 --> 00:07:16.313
in my mind are kind of together in the sense of,

00:07:16.313 --> 00:07:16.633
like,

00:07:16.793 --> 00:07:19.193
they're very coupled in terms of the operations

00:07:19.193 --> 00:07:19.873
that are happening.

00:07:19.873 --> 00:07:20.113
So,

00:07:20.113 --> 00:07:20.393
like,

00:07:20.473 --> 00:07:22.183
CRUD operations are going this,

00:07:22.333 --> 00:07:22.818
this direction.

00:07:23.062 --> 00:07:26.062
And then also what I like to do in this scenario

00:07:26.062 --> 00:07:28.142
is we're going to establish a WebSocket

00:07:28.142 --> 00:07:28.582
connection,

00:07:29.062 --> 00:07:30.422
which is going to be two way,

00:07:30.422 --> 00:07:31.462
with this side

00:07:31.942 --> 00:07:33.542
and at this layer,

00:07:33.652 --> 00:07:34.502
on the server.

00:07:34.662 --> 00:07:36.342
Once we implement authentication,

00:07:36.662 --> 00:07:38.102
this layer right here

00:07:38.502 --> 00:07:40.782
is going to do the validation of,

00:07:40.782 --> 00:07:40.942
like,

00:07:40.942 --> 00:07:41.742
the user request.

00:07:41.742 --> 00:07:43.862
So all of the Auth logic will also be built at

00:07:43.862 --> 00:07:44.502
this layer,

00:07:45.172 --> 00:07:47.172
just to kind of like keep things really clean.

00:07:47.172 --> 00:07:48.612
And then if we need to

00:07:49.142 --> 00:07:50.862
reach out to the server for the WebSocket

00:07:50.862 --> 00:07:51.382
implementation,

00:07:51.382 --> 00:07:53.062
basically what we can do is we can

00:07:53.462 --> 00:07:53.862
then,

00:07:54.712 --> 00:07:55.912
proxy that request

00:07:56.232 --> 00:07:56.632
to

00:07:57.004 --> 00:07:57.991
our data service.

00:07:58.151 --> 00:07:59.351
And I'll show you how to do this.

00:07:59.351 --> 00:08:01.031
We'll do something called service bindings.

00:08:01.031 --> 00:08:02.671
This is a cloudflare feature where we can

00:08:02.671 --> 00:08:03.511
basically say,

00:08:03.830 --> 00:08:06.431
this service right here depends on this service,

00:08:06.431 --> 00:08:09.551
and you can proxy requests to it without it

00:08:09.551 --> 00:08:10.231
counting as,

00:08:10.231 --> 00:08:12.871
like an extra request to the service for billing

00:08:12.871 --> 00:08:13.311
purposes.

00:08:13.311 --> 00:08:14.071
So it's pretty cool.

00:08:14.281 --> 00:08:15.591
but this layer can like,

00:08:15.591 --> 00:08:16.471
authenticate the user,

00:08:16.471 --> 00:08:17.351
ensure that they should

00:08:17.641 --> 00:08:18.801
be seeing data that they are seeing,

00:08:18.801 --> 00:08:20.881
or they should be making a connection with a

00:08:20.881 --> 00:08:21.561
websocket.

00:08:21.561 --> 00:08:23.801
And then if that connection is okay,

00:08:23.881 --> 00:08:25.601
then you can go ahead and you can proxy that

00:08:25.601 --> 00:08:26.681
request to the service.

00:08:26.761 --> 00:08:27.841
So that just makes it.

00:08:27.841 --> 00:08:28.841
So we're not building like,

00:08:28.841 --> 00:08:29.161
Auth

00:08:29.481 --> 00:08:30.201
at this level,

00:08:30.281 --> 00:08:31.681
but then we're also like,

00:08:31.681 --> 00:08:32.081
you know,

00:08:32.081 --> 00:08:33.800
connecting directly to the service and we have to

00:08:33.800 --> 00:08:35.121
move the Auth into this service.

00:08:35.121 --> 00:08:36.761
And then let's say you built another service in

00:08:36.761 --> 00:08:37.161
the future.

00:08:37.161 --> 00:08:37.509
Like,

00:08:37.509 --> 00:08:38.112
you'd have to,

00:08:38.112 --> 00:08:38.272
like,

00:08:38.272 --> 00:08:39.192
build Auth into that.

00:08:39.192 --> 00:08:41.992
So I basically kind of like to make the data flow

00:08:42.662 --> 00:08:43.382
this direction.

00:08:43.462 --> 00:08:44.582
A user does something.

00:08:45.142 --> 00:08:46.702
This service is in charge of,

00:08:46.702 --> 00:08:46.902
like,

00:08:46.902 --> 00:08:47.382
ensuring,

00:08:47.712 --> 00:08:49.362
that the user is who they say they are and they

00:08:49.362 --> 00:08:50.282
can see what they can see.

00:08:50.282 --> 00:08:53.042
And if you ever need to go to the data service,

00:08:53.122 --> 00:08:55.242
you can just simply do that from the back inside

00:08:55.242 --> 00:08:55.602
of things.

00:08:55.672 --> 00:08:55.824
yeah,

00:08:55.824 --> 00:08:57.023
so that's the pattern that we're going to follow,

00:08:57.023 --> 00:08:59.104
and I'll show you how to do that later on.

00:08:59.104 --> 00:09:01.024
But now we're going to start actually building out

00:09:01.024 --> 00:09:01.384
the,

00:09:01.654 --> 00:09:04.934
the core behavior for how the websockets are going

00:09:04.934 --> 00:09:07.254
to relay the data to our client.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.076 --> 00:00:00.516
All right,

00:00:00.516 --> 00:00:03.236
let's go ahead and kill these applications that

00:00:03.236 --> 00:00:03.796
are running.

00:00:03.796 --> 00:00:06.196
I'm just going to move this over because we don't

00:00:06.196 --> 00:00:07.276
really need that for now.

00:00:07.786 --> 00:00:08.916
I'm going to purge these

00:00:09.396 --> 00:00:11.636
tabs for the time being and then

00:00:12.116 --> 00:00:14.236
right now we're going to mostly focus on the back

00:00:14.236 --> 00:00:14.476
end.

00:00:14.476 --> 00:00:15.396
So the data service.

00:00:15.636 --> 00:00:18.356
So let's head over to our data service

00:00:18.676 --> 00:00:20.196
and durable objects.

00:00:20.196 --> 00:00:21.316
Let's go into our

00:00:22.056 --> 00:00:22.976
link click tracker.

00:00:22.976 --> 00:00:25.376
So the next thing that we're going to do is we're

00:00:25.376 --> 00:00:28.056
going to actually build out that logic to send the

00:00:28.056 --> 00:00:30.416
link clicks to our client so they can show up on

00:00:30.416 --> 00:00:30.936
the screen.

00:00:31.096 --> 00:00:31.248
Now,

00:00:31.706 --> 00:00:33.666
essentially there's kind of a few different ways

00:00:33.666 --> 00:00:35.586
we can do it and the way that we're going to do it

00:00:35.586 --> 00:00:38.346
right now isn't necessarily like the absolute best

00:00:38.346 --> 00:00:39.306
solution possible,

00:00:39.306 --> 00:00:41.226
but I do think it's going to work and it's going

00:00:41.226 --> 00:00:42.586
to illustrate some concepts

00:00:42.746 --> 00:00:43.786
durable objects for us.

00:00:43.786 --> 00:00:46.586
So you know what we could do is we could at this

00:00:46.586 --> 00:00:46.906
level

00:00:47.196 --> 00:00:49.116
where whenever we add a link click,

00:00:49.276 --> 00:00:50.956
we could just simply like

00:00:51.466 --> 00:00:53.956
come into here and we could say like sockets

00:00:54.036 --> 00:00:54.596
equal,

00:00:55.146 --> 00:00:57.427
this.uh

00:00:57.945 --> 00:01:00.276
in.uhctx.

00:01:00.436 --> 00:01:00.836
get,

00:01:01.876 --> 00:01:02.835
get sockets.

00:01:03.236 --> 00:01:05.596
And then we could loop through the sockets one by

00:01:05.596 --> 00:01:07.476
one and send the,

00:01:07.876 --> 00:01:08.276
send,

00:01:08.276 --> 00:01:10.836
send this like link click event to each client

00:01:10.836 --> 00:01:11.956
that's currently connected.

00:01:12.546 --> 00:01:12.786
Now

00:01:13.106 --> 00:01:15.786
the downside here is if you imagine if you have

00:01:15.786 --> 00:01:18.346
like an enterprise level service where you are

00:01:18.346 --> 00:01:19.826
managing the link clicks for

00:01:20.466 --> 00:01:20.946
a very,

00:01:20.946 --> 00:01:21.186
very,

00:01:21.186 --> 00:01:21.906
very large,

00:01:22.066 --> 00:01:23.186
high volume company,

00:01:23.836 --> 00:01:24.236
and

00:01:24.716 --> 00:01:25.356
you have,

00:01:25.436 --> 00:01:28.076
let's say you have like every second you have,

00:01:28.156 --> 00:01:28.796
you know,

00:01:29.036 --> 00:01:31.156
5,000 clicks is what you're averaging.

00:01:31.156 --> 00:01:32.676
I don't really think that this service is

00:01:32.676 --> 00:01:33.756
necessarily going to do that.

00:01:33.756 --> 00:01:36.436
you wouldn't be using D1 as your database for

00:01:36.436 --> 00:01:36.636
that.

00:01:36.636 --> 00:01:36.956
But

00:01:37.436 --> 00:01:39.956
technically durable objects could scale in the,

00:01:40.026 --> 00:01:40.586
in that sense.

00:01:40.586 --> 00:01:42.546
You would just have to kind of like be a little

00:01:42.546 --> 00:01:44.146
bit methodical about how you implement it.

00:01:44.146 --> 00:01:46.266
So what we're going to actually do is we're going

00:01:46.266 --> 00:01:47.986
to kind of create a buffer and we're going to use

00:01:47.986 --> 00:01:50.506
a durable objects alarm to say whenever we get a

00:01:50.506 --> 00:01:52.506
link click we are going to go,

00:01:52.586 --> 00:01:54.546
we're going to like look two seconds into the

00:01:54.546 --> 00:01:54.826
future

00:01:55.226 --> 00:01:57.746
and then we're going to run an alarm and if alarm

00:01:57.746 --> 00:01:58.186
is set

00:01:58.586 --> 00:02:00.066
then we're not going to like,

00:02:00.066 --> 00:02:01.666
we're just going to save that data but we're not

00:02:01.666 --> 00:02:02.186
going to do anything.

00:02:02.186 --> 00:02:03.546
And that what's going to happen is like

00:02:03.866 --> 00:02:06.546
Instead of sending 5,000 events every second in

00:02:06.546 --> 00:02:07.546
this high volume,

00:02:07.966 --> 00:02:09.406
in this high Volume scenario.

00:02:09.646 --> 00:02:11.566
What you do is like you would just,

00:02:11.886 --> 00:02:13.566
you would wait for two seconds

00:02:13.886 --> 00:02:16.406
and then you would send like the buffer all those

00:02:16.406 --> 00:02:17.486
events down at once.

00:02:17.726 --> 00:02:19.326
So let's go ahead and

00:02:19.726 --> 00:02:20.446
kind of show,

00:02:20.526 --> 00:02:22.206
I'll show you exactly what we mean here.

00:02:22.206 --> 00:02:24.606
So what I'm going to do is I'm going to grab some

00:02:24.786 --> 00:02:25.706
the alarm code.

00:02:25.786 --> 00:02:28.026
So basically this is similar to the other durable

00:02:28.026 --> 00:02:31.026
objects where we are going to get an alarm and if

00:02:31.026 --> 00:02:33.306
we don't have an alarm we're just going to simply

00:02:33.916 --> 00:02:36.356
say let's set an alarm for two seconds into the

00:02:36.356 --> 00:02:36.596
future.

00:02:36.596 --> 00:02:39.196
That way our real time like data isn't delayed

00:02:39.196 --> 00:02:39.956
more than two seconds.

00:02:39.956 --> 00:02:41.956
Like that's not bad for like little specs to show

00:02:41.956 --> 00:02:42.636
up on a map.

00:02:43.006 --> 00:02:44.956
but this would help us scale in a scenario where

00:02:44.956 --> 00:02:46.396
we're not just like you know,

00:02:46.396 --> 00:02:48.236
overwhelming the data that's being sent to

00:02:48.236 --> 00:02:48.516
clients.

00:02:48.516 --> 00:02:49.876
We're kind of able to control that.

00:02:50.036 --> 00:02:50.436
So

00:02:51.156 --> 00:02:52.036
let's go like this

00:02:52.578 --> 00:02:55.138
and let's implement out the alarm.

00:02:55.138 --> 00:02:57.138
So basically the alarm is going to fire

00:02:59.770 --> 00:03:01.050
and when the alarm fires,

00:03:01.210 --> 00:03:02.570
right now it's just going to log it.

00:03:02.570 --> 00:03:04.610
But what we're going to want to do is we're going

00:03:04.610 --> 00:03:06.850
to want to grab our sockets and we're going to

00:03:06.850 --> 00:03:08.330
want to iterate through our sockets and we're

00:03:08.330 --> 00:03:09.210
going to send some data.

00:03:09.370 --> 00:03:11.930
So this is kind of like the crux of what it is.

00:03:12.250 --> 00:03:12.444
So

00:03:12.444 --> 00:03:13.497
let's grab our sockets

00:03:14.457 --> 00:03:17.297
so we can say this CTX get sockets.

00:03:17.297 --> 00:03:20.137
We're going to loop through each socket and then

00:03:20.377 --> 00:03:22.337
right now we don't have any data to send.

00:03:22.337 --> 00:03:24.337
But just imagine like right now we'd be sending

00:03:24.337 --> 00:03:24.937
empty data.

00:03:25.097 --> 00:03:25.497
So

00:03:26.174 --> 00:03:28.534
ideally the data that's passed into here is going

00:03:28.534 --> 00:03:29.474
to be a list of

00:03:29.474 --> 00:03:31.814
like a list of link click events that are going to

00:03:31.814 --> 00:03:32.974
be displayed on the ui.

00:03:32.974 --> 00:03:34.774
So this is going to send to each client.

00:03:34.934 --> 00:03:37.694
So typically only one client client is going to be

00:03:37.694 --> 00:03:38.014
connected.

00:03:38.014 --> 00:03:40.054
So there will only be one item in this array.

00:03:40.054 --> 00:03:42.534
But theoretically you could have multiple users

00:03:42.534 --> 00:03:44.654
under an organization all using this at once and

00:03:44.654 --> 00:03:46.054
this would cascade to all of them,

00:03:46.054 --> 00:03:46.994
which is a pretty cool

00:03:46.994 --> 00:03:48.554
which is pretty cool a way to implement

00:03:48.554 --> 00:03:49.274
WebSockets.

00:03:49.274 --> 00:03:49.634
Now

00:03:49.974 --> 00:03:51.354
there's a few different things here I'm just going

00:03:51.354 --> 00:03:52.354
to kind of like brush over.

00:03:52.354 --> 00:03:52.714
But

00:03:53.254 --> 00:03:54.934
I did mention earlier how

00:03:55.334 --> 00:03:57.434
we are going to have some type of

00:03:58.934 --> 00:04:00.574
Basically we're going to want to keep track of

00:04:00.574 --> 00:04:00.934
like

00:04:01.354 --> 00:04:04.354
the data that is in our SQLite table up here

00:04:04.434 --> 00:04:06.434
because we don't want this data to grow too Big

00:04:06.434 --> 00:04:08.434
like if there's a high volume client,

00:04:08.514 --> 00:04:10.794
we don't want them to have 3 million items in that

00:04:10.794 --> 00:04:11.274
database.

00:04:11.274 --> 00:04:13.194
We want to kind of limit it to like probably just

00:04:13.194 --> 00:04:14.594
a few hundred records at a time.

00:04:14.674 --> 00:04:17.074
Because you also don't want to send millions of

00:04:17.074 --> 00:04:18.474
objects over to the client,

00:04:18.474 --> 00:04:19.674
each client to like render.

00:04:19.674 --> 00:04:21.874
You probably want to keep that right around 100 or

00:04:21.874 --> 00:04:23.354
1000 depending on the use case.

00:04:23.354 --> 00:04:23.714
So

00:04:24.014 --> 00:04:25.454
essentially we're going to have references,

00:04:25.454 --> 00:04:27.134
we're going to have like a reference to

00:04:28.164 --> 00:04:29.684
like the last processed,

00:04:29.764 --> 00:04:31.604
the last processed offset

00:04:32.004 --> 00:04:33.524
and then the newest offset.

00:04:33.844 --> 00:04:36.804
And then during this two second buffer we're going

00:04:36.804 --> 00:04:37.444
to grab

00:04:38.004 --> 00:04:38.404
this

00:04:38.964 --> 00:04:40.924
like all of these records and we'll probably limit

00:04:40.924 --> 00:04:43.084
it to like 100 and we'll send them down to our

00:04:43.084 --> 00:04:43.524
clients.

00:04:44.244 --> 00:04:44.644
Now

00:04:45.124 --> 00:04:46.164
after that's done,

00:04:46.244 --> 00:04:47.364
we'll keep track of

00:04:47.684 --> 00:04:50.324
the most recent and this will become our last

00:04:50.404 --> 00:04:51.124
offset.

00:04:52.014 --> 00:04:54.174
And then every single time we add a new event,

00:04:54.734 --> 00:04:56.454
essentially what we'll be doing is we'll be

00:04:56.454 --> 00:04:58.734
looking at like the last like known event.

00:04:58.734 --> 00:05:01.094
So then every two seconds we'll just be sending

00:05:01.094 --> 00:05:03.134
like a buffer of these messages.

00:05:03.134 --> 00:05:05.094
So I have some code for that that we can go

00:05:05.094 --> 00:05:05.694
through right now.

00:05:05.694 --> 00:05:07.614
So first thing we're going to want to do is we're

00:05:07.614 --> 00:05:09.294
going to want to keep track of those offsets.

00:05:09.374 --> 00:05:11.854
So at the top level of our durable object,

00:05:12.094 --> 00:05:13.894
let's go ahead and define some in memory

00:05:13.894 --> 00:05:14.414
variables,

00:05:14.414 --> 00:05:17.134
most recent offset and last offset time.

00:05:17.454 --> 00:05:20.934
And then inside of our block while let's go ahead

00:05:20.934 --> 00:05:22.734
and just make sure we pull those from stor.

00:05:23.354 --> 00:05:24.634
So we are just grabbing

00:05:24.754 --> 00:05:27.194
least recent offset time and most recent offset

00:05:27.194 --> 00:05:30.034
time from storage and then we're saving it here

00:05:30.994 --> 00:05:33.154
and then we can go ahead and just set it.

00:05:33.154 --> 00:05:35.314
So I'm just going to say if

00:05:36.382 --> 00:05:38.222
should probably put this indented.

00:05:38.222 --> 00:05:41.182
So basically we're going to say if there,

00:05:41.662 --> 00:05:42.822
if this is undefined.

00:05:42.822 --> 00:05:44.302
So if this has never been set before,

00:05:44.302 --> 00:05:45.757
which it actually shouldn't be the key.

00:05:45.862 --> 00:05:46.182
So yeah,

00:05:46.182 --> 00:05:47.142
if this hasn't been set before,

00:05:47.142 --> 00:05:48.582
we're just going to default it to zero.

00:05:48.982 --> 00:05:52.102
We could technically also just like default it to

00:05:52.822 --> 00:05:53.702
this dot,

00:05:53.762 --> 00:05:55.242
least and this top most.

00:05:56.122 --> 00:05:57.248
I think this is also fine.

00:05:59.318 --> 00:06:00.878
Now what we're going to do,

00:06:00.878 --> 00:06:02.678
now that we are keeping track of offsets,

00:06:02.678 --> 00:06:04.278
we're going to have some helper methods.

00:06:04.278 --> 00:06:06.598
So inside of our alarm we're going to want to do a

00:06:06.598 --> 00:06:07.118
few things.

00:06:07.118 --> 00:06:08.918
We are going to want to grab

00:06:10.308 --> 00:06:11.428
an array of the recent

00:06:11.728 --> 00:06:14.228
of like the of recent clicks and we're going to

00:06:14.228 --> 00:06:17.062
use our most recent Offset time for that.

00:06:17.344 --> 00:06:20.184
So in order to get these link the link click data,

00:06:20.184 --> 00:06:22.384
since we're technically saving it in our table,

00:06:22.384 --> 00:06:24.864
we're going to pull it from our table and what I'm

00:06:24.864 --> 00:06:27.024
going to do is I'm going to create a new

00:06:27.344 --> 00:06:27.824
file

00:06:28.384 --> 00:06:30.064
inside of our helpers called

00:06:31.124 --> 00:06:32.104
durable queries.

00:06:32.864 --> 00:06:34.544
So we can head over to our helpers

00:06:35.024 --> 00:06:37.584
and let's just say durable queries ts

00:06:37.904 --> 00:06:39.584
and what this and what we're going to have,

00:06:39.584 --> 00:06:41.224
I'm just going to paste this in for the purpose of

00:06:41.224 --> 00:06:42.224
time and go over it.

00:06:42.224 --> 00:06:45.224
So essentially what we have here is we have a

00:06:45.224 --> 00:06:46.784
query that just selects

00:06:47.184 --> 00:06:47.784
latitude,

00:06:47.784 --> 00:06:48.303
longitude,

00:06:48.303 --> 00:06:49.104
country and time

00:06:49.424 --> 00:06:50.864
from geoclicks,

00:06:50.964 --> 00:06:53.924
geolink clicks and then it's filtering based upon

00:06:54.184 --> 00:06:55.874
where time is greater than a certain

00:06:56.274 --> 00:06:58.394
amount and a limit of an offset.

00:06:58.394 --> 00:06:59.314
So at

00:06:59.824 --> 00:07:01.624
the top level of this function we're going to be

00:07:01.624 --> 00:07:03.224
passing in a offset time.

00:07:03.224 --> 00:07:04.464
It's going to default to zero.

00:07:05.074 --> 00:07:06.824
and this is a scenario where you'd want to pull

00:07:06.824 --> 00:07:09.144
all of the link clicks inside of that table

00:07:09.464 --> 00:07:11.344
and then what we're going to do is we're going to

00:07:11.344 --> 00:07:12.264
limit it by 50,

00:07:12.414 --> 00:07:13.094
as a default.

00:07:13.094 --> 00:07:15.494
And then this could be kind of passed in from the

00:07:15.494 --> 00:07:16.614
user of this function.

00:07:16.614 --> 00:07:17.614
So the durable object,

00:07:17.614 --> 00:07:19.134
if we wanted to give like more,

00:07:19.134 --> 00:07:22.414
so like maybe 50 isn't enough like specs on a map,

00:07:22.414 --> 00:07:23.614
maybe we want a thousand,

00:07:23.614 --> 00:07:25.774
we could tweak this number as well when we use

00:07:25.774 --> 00:07:26.414
this function.

00:07:27.154 --> 00:07:28.914
and then essentially what we're going to be doing

00:07:28.914 --> 00:07:30.734
is we're going to be passing in this query query

00:07:30.734 --> 00:07:32.814
right here into our SQL storage

00:07:33.094 --> 00:07:33.534
query

00:07:33.854 --> 00:07:36.174
and then we're going to pass in the binding.

00:07:36.334 --> 00:07:38.094
So this is the filter for time,

00:07:38.334 --> 00:07:40.334
which is the offset time and then this is the

00:07:40.334 --> 00:07:41.734
filter for the limit.

00:07:42.214 --> 00:07:43.974
And then we're just doing a few different things

00:07:43.974 --> 00:07:44.254
here.

00:07:44.254 --> 00:07:45.174
I have a

00:07:45.534 --> 00:07:46.194
I have a

00:07:47.917 --> 00:07:48.957
a Zod

00:07:49.029 --> 00:07:51.828
schema that we've defined inside of our repo.

00:07:51.828 --> 00:07:53.148
You should already have it

00:07:53.418 --> 00:07:54.858
and if you don't have it,

00:07:55.258 --> 00:07:56.208
you really should have it.

00:07:56.218 --> 00:07:58.298
I'm just going to make sure if you don't have it,

00:07:58.378 --> 00:07:58.938
what we,

00:07:59.338 --> 00:07:59.818
what you.

00:07:59.818 --> 00:08:00.858
So you can see what it looks like.

00:08:00.858 --> 00:08:03.018
So it is going to be inside of

00:08:03.548 --> 00:08:03.948
our,

00:08:04.144 --> 00:08:06.837
inside of our Data Ops package.

00:08:07.317 --> 00:08:08.677
In Source Zod

00:08:08.997 --> 00:08:11.717
links we have this durable object

00:08:11.877 --> 00:08:14.097
link schema which you should have this already in

00:08:14.097 --> 00:08:14.377
there.

00:08:14.397 --> 00:08:16.227
and if you don't just go ahead and

00:08:16.547 --> 00:08:18.547
type this guy out and export it,

00:08:18.547 --> 00:08:18.867
build.

00:08:18.947 --> 00:08:19.347
But

00:08:19.827 --> 00:08:21.767
we're basically using that so we can have a very

00:08:21.767 --> 00:08:23.487
Structured type that is being

00:08:23.827 --> 00:08:25.577
sent over to the client.

00:08:25.657 --> 00:08:26.377
And then

00:08:27.097 --> 00:08:29.577
we're going to grab the very first item in that

00:08:29.577 --> 00:08:30.057
array

00:08:30.537 --> 00:08:33.777
and we're going to get the time default to zero if

00:08:33.777 --> 00:08:34.857
the array is empty.

00:08:35.097 --> 00:08:37.097
And then similarly we're going to go grab the last

00:08:37.097 --> 00:08:39.097
item in that array and we're going to

00:08:39.397 --> 00:08:40.787
grab the time and default.

00:08:41.277 --> 00:08:41.548
if,

00:08:41.680 --> 00:08:42.000
if there,

00:08:42.000 --> 00:08:44.280
if there is no items in this like array,

00:08:44.280 --> 00:08:45.760
meaning there are no link clicks,

00:08:45.760 --> 00:08:46.960
it'll default to zero.

00:08:47.040 --> 00:08:48.640
And what that's going to give us is this going to

00:08:48.640 --> 00:08:50.760
return this object where we have a list of our

00:08:50.760 --> 00:08:51.600
link objects,

00:08:51.680 --> 00:08:52.720
our link clicks.

00:08:52.960 --> 00:08:54.960
We have the most recent time and we have the

00:08:54.960 --> 00:08:55.560
oldest time.

00:08:55.560 --> 00:08:57.080
And this is going to help us keep track of those

00:08:57.080 --> 00:08:58.440
offsets that I mentioned before.

00:08:58.440 --> 00:08:59.835
So we can go ahead and save this,

00:08:59.835 --> 00:09:00.900
head back over here.

00:09:01.300 --> 00:09:01.700
And

00:09:02.000 --> 00:09:04.640
what we can do is we can say link click data and

00:09:04.640 --> 00:09:05.880
we're going to pass in this information.

00:09:06.200 --> 00:09:07.640
So link click data.

00:09:08.373 --> 00:09:08.813
So get,

00:09:08.813 --> 00:09:09.173
re.

00:09:09.653 --> 00:09:10.293
Get recent,

00:09:11.093 --> 00:09:14.373
get recent link clicks pass in our sequel,

00:09:14.863 --> 00:09:15.333
reference.

00:09:15.333 --> 00:09:17.973
And then we're going to pass in the most recent

00:09:18.053 --> 00:09:18.834
offset time.

00:09:20.441 --> 00:09:23.241
Then what we're going to do is we can define a

00:09:23.241 --> 00:09:27.121
function at our durable object level to flush our

00:09:27.121 --> 00:09:27.881
offset times.

00:09:27.881 --> 00:09:30.041
And what this is going to do is it's basically

00:09:30.041 --> 00:09:32.361
going to take like the most recent and our least

00:09:32.551 --> 00:09:33.621
recent offset time,

00:09:34.501 --> 00:09:34.981
set them

00:09:35.271 --> 00:09:37.611
in memory and then flush them into storage.

00:09:38.011 --> 00:09:40.731
Reason why we are doing this is just so like we

00:09:40.731 --> 00:09:42.811
can keep the sliding window of

00:09:43.081 --> 00:09:45.581
offsets as we buffered this data and send it to

00:09:45.581 --> 00:09:46.021
clients.

00:09:46.821 --> 00:09:47.221
Now,

00:09:48.671 --> 00:09:50.551
the way that we're going to use that is inside of

00:09:50.551 --> 00:09:52.831
our alarm based upon the link click data.

00:09:53.061 --> 00:09:53.331
the

00:09:53.362 --> 00:09:54.638
most recent time,

00:09:54.709 --> 00:09:57.269
the most recent time that was found from the

00:09:57.269 --> 00:09:59.989
actual data that we are processing will now become

00:09:59.989 --> 00:10:01.189
our new most recent time.

00:10:01.429 --> 00:10:04.149
And then our oldest time is going to also come

00:10:04.149 --> 00:10:05.509
from our link click data.

00:10:05.589 --> 00:10:08.629
So if we ever had like a burst of 20,000 link

00:10:08.629 --> 00:10:09.189
clicks,

00:10:09.429 --> 00:10:11.549
we don't need to keep all of that into memory.

00:10:11.549 --> 00:10:13.749
We're just going to grab that like little subset

00:10:13.749 --> 00:10:15.469
of whatever we define here.

00:10:15.469 --> 00:10:15.829
And

00:10:16.149 --> 00:10:16.949
we could define,

00:10:16.949 --> 00:10:17.189
right,

00:10:17.189 --> 00:10:18.309
it defaults to 50.

00:10:18.709 --> 00:10:20.749
This is like the limited number of records that

00:10:20.749 --> 00:10:21.589
are returned here.

00:10:21.829 --> 00:10:22.949
We could pass 100.

00:10:22.949 --> 00:10:23.829
It really doesn't matter.

00:10:23.829 --> 00:10:26.129
It's entirely up to the way that we want implement

00:10:26.129 --> 00:10:26.449
this.

00:10:27.120 --> 00:10:30.360
now the last thing that I want to do is I want to

00:10:30.360 --> 00:10:31.760
clean up our table.

00:10:31.840 --> 00:10:34.720
So if there's a scenario where you know,

00:10:34.720 --> 00:10:37.080
we get 50,000 link clicks and just a burst of like

00:10:37.080 --> 00:10:39.360
one processing unit like two seconds.

00:10:39.600 --> 00:10:41.400
I don't want to store a whole bunch of data in

00:10:41.400 --> 00:10:43.520
this SQLite database because there are limits

00:10:43.520 --> 00:10:43.840
there.

00:10:44.060 --> 00:10:47.140
I want to delete any of the records that we don't

00:10:47.140 --> 00:10:47.420
need.

00:10:47.580 --> 00:10:50.420
So what we can do is we can head back over to our

00:10:50.420 --> 00:10:51.340
durable queries

00:10:51.630 --> 00:10:52.510
and then we have a,

00:10:52.510 --> 00:10:54.110
we can define a query to delete.

00:10:54.110 --> 00:10:54.510
So

00:10:54.830 --> 00:10:57.790
all we have to do is we basically say delete link

00:10:57.790 --> 00:11:00.910
clicks before we pass in our reference to our SQL

00:11:01.260 --> 00:11:01.900
storage

00:11:02.380 --> 00:11:04.860
and then our SQL storage client and then we pass

00:11:04.860 --> 00:11:07.060
in a time and basically anything that is

00:11:07.060 --> 00:11:09.000
less than that time is going to be deleted.

00:11:09.560 --> 00:11:09.960
So

00:11:10.280 --> 00:11:13.280
we can then use this inside of our alarm and say

00:11:13.280 --> 00:11:13.880
await

00:11:14.684 --> 00:11:15.404
delete before

00:11:15.717 --> 00:11:15.957
and

00:11:17.267 --> 00:11:17.897
we can

00:11:18.210 --> 00:11:19.010
pass in

00:11:19.490 --> 00:11:21.650
the oldest time and the

00:11:21.970 --> 00:11:25.410
SQL reference so this dot SQL and then we're going

00:11:25.410 --> 00:11:27.490
to pass in click data oldest time.

00:11:27.650 --> 00:11:29.890
So this is going to just keep that

00:11:29.990 --> 00:11:32.050
table truncated with just the most recent like

00:11:32.050 --> 00:11:32.850
link clicks.

00:11:33.250 --> 00:11:35.650
And then one thing that I'm noticing here as I'm

00:11:35.650 --> 00:11:36.610
typing it out is

00:11:37.360 --> 00:11:40.280
essentially when we iterate through our sockets we

00:11:40.280 --> 00:11:41.440
can pass in our

00:11:42.420 --> 00:11:44.180
link click data dot clicks.

00:11:44.180 --> 00:11:46.020
This is really the data that we want to send over

00:11:46.020 --> 00:11:46.900
to each client.

00:11:47.060 --> 00:11:47.460
Now

00:11:47.860 --> 00:11:50.620
I don't know like these operations should be very

00:11:50.620 --> 00:11:51.220
very quick

00:11:51.620 --> 00:11:52.900
but at the same time

00:11:53.220 --> 00:11:54.740
we don't necessarily like,

00:11:55.060 --> 00:11:57.180
we want to get this data to the client as fast as

00:11:57.180 --> 00:11:57.460
possible.

00:11:57.860 --> 00:12:01.140
So what I would opt to do is say let's move our

00:12:01.940 --> 00:12:02.940
let's move our

00:12:03.500 --> 00:12:05.020
sending the data to the clients

00:12:05.660 --> 00:12:08.220
up a little bit in this logic chain.

00:12:09.360 --> 00:12:10.760
So we'll basically grab the link click,

00:12:10.760 --> 00:12:12.040
we'll grab some information about it,

00:12:12.040 --> 00:12:14.360
we'll send all that information to the client and

00:12:14.360 --> 00:12:16.200
then we'll go ahead and we'll start cleaning stuff

00:12:16.200 --> 00:12:16.440
up.

00:12:16.440 --> 00:12:17.760
So that's what's happening here.

00:12:17.760 --> 00:12:18.160
So

00:12:18.410 --> 00:12:20.940
I'm just gonna pause for just a second just so you

00:12:20.940 --> 00:12:22.140
can kind of look over this.

00:12:22.746 --> 00:12:25.066
But at this point we should be able to

00:12:25.706 --> 00:12:28.866
deploy these changes and then wire it up into our

00:12:28.866 --> 00:12:29.335
ui.

00:12:29.480 --> 00:12:31.240
So let's go ahead and deploy it.

00:12:33.800 --> 00:12:35.880
And while this is deploying what I'm going to do

00:12:35.880 --> 00:12:37.080
is I'm going to spin up this

00:12:37.515 --> 00:12:38.388
user application.

00:12:38.388 --> 00:12:40.668
So this is the front end application run dev.

00:12:41.788 --> 00:12:45.708
Then I'm going to copy our data service URL

00:12:46.428 --> 00:12:48.748
and I'm just going to head over temporarily.

00:12:48.748 --> 00:12:50.108
I'm going to head over to our

00:12:50.818 --> 00:12:52.578
our click socket code.

00:12:52.578 --> 00:12:53.778
So this is living in our front end.

00:12:53.778 --> 00:12:54.898
And right now we have this

00:12:55.538 --> 00:12:55.858
vite,

00:12:56.468 --> 00:12:57.668
we have basically this

00:12:58.068 --> 00:12:58.788
vite variable.

00:12:58.788 --> 00:13:01.188
I'm just Going to override it just for a little

00:13:01.188 --> 00:13:01.655
bit here.

00:13:01.746 --> 00:13:02.146
And

00:13:02.786 --> 00:13:03.586
I'm also,

00:13:03.586 --> 00:13:05.786
because this is actually the protocol is going to

00:13:05.786 --> 00:13:06.066
be

00:13:06.846 --> 00:13:07.566
wss.

00:13:07.726 --> 00:13:10.325
I'm just going to have this default also come over

00:13:10.325 --> 00:13:12.446
to WSS just for the time being.

00:13:13.166 --> 00:13:15.166
Now when we open up this application

00:13:15.646 --> 00:13:16.743
and we head over here,

00:13:16.791 --> 00:13:18.951
I'm going to open up and inspect our network

00:13:18.951 --> 00:13:19.446
traffic.

00:13:19.556 --> 00:13:21.460
Now you can notice that it went from disconnected

00:13:21.460 --> 00:13:22.100
to connected

00:13:22.500 --> 00:13:23.620
and we have

00:13:24.019 --> 00:13:24.420
our

00:13:25.120 --> 00:13:27.100
client connection established.

00:13:27.100 --> 00:13:28.740
So here's our client socket right here.

00:13:29.300 --> 00:13:31.860
Now what I'm going to do is I'm going to

00:13:34.430 --> 00:13:36.630
I'm going to use this link that we have.

00:13:36.630 --> 00:13:38.350
So this should redirect us to Google

00:13:39.070 --> 00:13:40.790
and then when we do that what you're going to

00:13:40.790 --> 00:13:42.470
notice is look at that,

00:13:42.470 --> 00:13:44.910
we have a spec pop up here.

00:13:45.150 --> 00:13:48.110
So we can also probably inspect the messages that

00:13:48.110 --> 00:13:48.590
came through.

00:13:48.670 --> 00:13:51.190
So if we come here you can see that we got this

00:13:51.190 --> 00:13:53.470
message sent from the client which is pretty cool.

00:13:53.470 --> 00:13:54.750
So these message,

00:13:54.910 --> 00:13:57.446
these messages went from our durable object

00:13:57.446 --> 00:13:59.144
to our client side code.

00:13:59.424 --> 00:14:00.464
And I'm just going to,

00:14:01.127 --> 00:14:03.287
just going to do that one more time.

00:14:03.527 --> 00:14:05.190
So I'm going to hit this one more time

00:14:05.301 --> 00:14:07.202
and you can see the spec actually got a little bit

00:14:07.202 --> 00:14:07.482
bigger.

00:14:07.482 --> 00:14:09.802
I put a little bit of logic into here to basically

00:14:09.802 --> 00:14:13.162
say like if there's dots that are close to each

00:14:13.162 --> 00:14:13.482
other,

00:14:13.722 --> 00:14:15.242
make those dots a little bit bigger.

00:14:15.242 --> 00:14:17.602
So the more users the larger that circle is going

00:14:17.602 --> 00:14:17.962
to be.

00:14:17.962 --> 00:14:21.082
Now if you also had a scenario where like

00:14:21.442 --> 00:14:22.202
you have a vpn,

00:14:22.202 --> 00:14:23.882
I'd say go connect to like a few different

00:14:23.882 --> 00:14:24.322
locations.

00:14:24.322 --> 00:14:25.802
I'll probably just do that really fast.

00:14:25.802 --> 00:14:26.582
Right now

00:14:27.142 --> 00:14:27.942
let's go to

00:14:29.062 --> 00:14:30.102
NordVPN.

00:14:31.928 --> 00:14:33.518
I'm going to click to connect to Malaysia.

00:14:33.518 --> 00:14:33.966
Really quick.

00:14:33.966 --> 00:14:34.868
Looks like I'm connected.

00:14:35.268 --> 00:14:36.468
I'm going to do this again

00:14:37.668 --> 00:14:38.068
and

00:14:38.468 --> 00:14:39.508
come back over here

00:14:39.908 --> 00:14:41.348
and we should see a,

00:14:41.908 --> 00:14:43.028
we should see a

00:14:43.888 --> 00:14:46.528
spec pop up if we come over to Asia.

00:14:47.810 --> 00:14:48.130
Oh,

00:14:48.210 --> 00:14:49.170
hasn't connected yet.

00:14:49.170 --> 00:14:49.730
That's why.

00:14:52.140 --> 00:14:52.529
All right,

00:14:52.529 --> 00:14:53.409
now I'm connected.

00:14:53.649 --> 00:14:55.249
So let's try that one more time.

00:14:55.409 --> 00:14:57.129
Data ops go to that link.

00:14:57.129 --> 00:14:59.369
This one will redirect us to LinkedIn because this

00:14:59.369 --> 00:14:59.744
is a

00:14:59.924 --> 00:15:01.334
a Malaysia based URL

00:15:01.432 --> 00:15:01.452
all

00:15:01.452 --> 00:15:01.592
right.

00:15:01.592 --> 00:15:02.312
And there we go.

00:15:02.312 --> 00:15:02.792
Yeah,

00:15:02.792 --> 00:15:04.432
it just took a second to show up.

00:15:04.432 --> 00:15:06.032
It was actually really small so I couldn't see it.

00:15:06.032 --> 00:15:06.312
But

00:15:06.792 --> 00:15:09.112
so you notice now we are on our VPN

00:15:09.512 --> 00:15:12.552
and we clicked on a link from

00:15:13.528 --> 00:15:15.208
we connect to a VPN in Malaysia,

00:15:15.208 --> 00:15:16.728
clicked on the link and then we got

00:15:17.008 --> 00:15:19.008
redirected to LinkedIn instead of Google because

00:15:19.008 --> 00:15:19.968
that's kind of what it was.

00:15:19.968 --> 00:15:21.688
And now you can see in Malaysia we have this

00:15:21.688 --> 00:15:23.288
little spec that's saying hey,

00:15:23.288 --> 00:15:23.848
we are,

00:15:23.848 --> 00:15:24.688
we had users here.

00:15:24.688 --> 00:15:26.688
And I'm going to do this one more time

00:15:28.048 --> 00:15:30.328
and we should see this link just got a little bit

00:15:30.328 --> 00:15:30.568
bigger.

00:15:30.568 --> 00:15:31.128
If you notice.

00:15:31.128 --> 00:15:32.448
It's probably kind of hard to see from here,

00:15:32.448 --> 00:15:33.208
but yeah,

00:15:33.208 --> 00:15:33.808
so it's working.

00:15:33.808 --> 00:15:34.208
Our.

00:15:34.368 --> 00:15:36.288
I'm going to disconnect from this again

00:15:36.453 --> 00:15:38.756
and I will do this one more time.

00:15:38.836 --> 00:15:39.316
Boom.

00:15:39.772 --> 00:15:42.692
Now I actually think what happens is when I change

00:15:42.692 --> 00:15:43.532
my vpn,

00:15:43.532 --> 00:15:45.652
I think that we are disconnecting and then

00:15:45.652 --> 00:15:46.252
reconnecting.

00:15:46.252 --> 00:15:46.482
But

00:15:46.482 --> 00:15:46.742
yeah,

00:15:46.742 --> 00:15:47.382
so this is,

00:15:47.436 --> 00:15:48.756
so this is working as expected.

00:15:48.836 --> 00:15:49.476
We have

00:15:49.856 --> 00:15:50.256
a,

00:15:50.816 --> 00:15:52.496
essentially the flow looks like this.

00:15:52.576 --> 00:15:53.536
We have a,

00:15:54.336 --> 00:15:55.616
we have a user that

00:15:55.956 --> 00:15:57.236
clicks on our link,

00:15:57.316 --> 00:15:58.156
goes to hono,

00:15:58.156 --> 00:16:00.076
API redirects to where they're supposed to be.

00:16:00.076 --> 00:16:01.316
This data sent to a queue.

00:16:01.316 --> 00:16:02.916
It's also sent to our durable object.

00:16:02.916 --> 00:16:05.916
Every two seconds our durable object is going to

00:16:05.916 --> 00:16:08.716
trigger an alarm and that's going to send data to

00:16:08.716 --> 00:16:10.716
the clients that are connected via websockets.

00:16:10.716 --> 00:16:12.836
Now those web sockets kind of look like this.

00:16:13.156 --> 00:16:13.716
You have

00:16:14.466 --> 00:16:16.386
a link click data that gets put into here.

00:16:16.866 --> 00:16:19.426
It is going to save that data into this table

00:16:19.826 --> 00:16:22.706
and alarm is going to manage these offsets just so

00:16:22.786 --> 00:16:24.986
the data can't grow infinitely inside of our

00:16:24.986 --> 00:16:25.266
table.

00:16:25.266 --> 00:16:27.576
And then in those two second buffer it's going to

00:16:27.806 --> 00:16:30.126
push that data to whatever client is connected.

00:16:30.286 --> 00:16:31.926
So I hope that makes sense.

00:16:31.926 --> 00:16:33.686
This is actually a super cool feature in my

00:16:33.686 --> 00:16:34.606
opinion and

00:16:34.636 --> 00:16:36.746
I do think it's a pretty good use case for durable

00:16:36.746 --> 00:16:37.146
objects.

00:16:37.146 --> 00:16:38.626
I think you're able to kind of holistically

00:16:38.626 --> 00:16:38.946
understand

00:16:39.506 --> 00:16:41.866
how this entire like thing works.

00:16:41.866 --> 00:16:43.346
Now just one last thing.

00:16:43.346 --> 00:16:46.146
I'm on my phone so I'm going to

00:16:47.068 --> 00:16:49.813
I'm going to hit this endpoint from my phone

00:16:50.293 --> 00:16:50.693
to.

00:16:51.070 --> 00:16:52.590
Let's move this over to

00:16:53.550 --> 00:16:54.350
Americas.

00:16:57.383 --> 00:16:58.463
Now when I hit enter,

00:16:58.463 --> 00:16:59.623
we should see it,

00:16:59.694 --> 00:17:01.574
we should see it pop up over in

00:17:01.974 --> 00:17:04.334
the US So you see right here we're able to see

00:17:04.334 --> 00:17:05.014
that little spec.

00:17:05.014 --> 00:17:07.454
That's where I am in the US and my phone's not on

00:17:07.454 --> 00:17:08.054
the vpn.

00:17:08.134 --> 00:17:09.134
So yeah,

00:17:09.134 --> 00:17:09.614
this is working.

00:17:09.614 --> 00:17:10.534
This is pretty cool.

00:17:11.950 --> 00:17:14.390
Now I would say before the next section I would

00:17:14.390 --> 00:17:16.790
just come into your client code and I would just

00:17:16.790 --> 00:17:19.310
make sure you revert this and you revert this.

00:17:19.500 --> 00:17:20.040
just for the

00:17:20.440 --> 00:17:21.880
the sake of getting things clean.

00:17:21.880 --> 00:17:23.560
And then in this next video we're actually going

00:17:23.560 --> 00:17:26.240
to start proxying the request from our worker

00:17:26.240 --> 00:17:28.760
that's associated with our UI application,

00:17:29.000 --> 00:17:30.600
and that's going to be proxy to our durable

00:17:30.600 --> 00:17:31.080
object.

00:17:31.160 --> 00:17:32.426
So catch on that one.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.039 --> 00:00:00.359
All right,

00:00:00.359 --> 00:00:02.639
so now that we've validated the websocket

00:00:02.639 --> 00:00:04.479
connection and that all of the features around

00:00:04.479 --> 00:00:05.639
that are working as expected,

00:00:06.199 --> 00:00:08.839
let's connect the front end application,

00:00:08.839 --> 00:00:10.359
the user facing application

00:00:10.919 --> 00:00:11.209
via

00:00:11.209 --> 00:00:13.899
service bindings to our data service so we can

00:00:13.899 --> 00:00:14.779
proxy that

00:00:14.809 --> 00:00:15.919
websocket connection.

00:00:16.079 --> 00:00:18.359
That way we're not hard coding like the actual

00:00:18.359 --> 00:00:21.479
backend URL into our client code.

00:00:21.479 --> 00:00:21.839
So

00:00:22.399 --> 00:00:23.839
first thing that we're going to do is inside of

00:00:23.839 --> 00:00:25.359
data service I have

00:00:26.550 --> 00:00:29.354
I have inside of our Hono app basically hard coded

00:00:29.354 --> 00:00:30.274
this account id.

00:00:30.354 --> 00:00:32.274
We're not going to want to do that anymore because

00:00:32.274 --> 00:00:34.674
we're going to want everything to flow as it's

00:00:34.674 --> 00:00:35.314
supposed to.

00:00:36.274 --> 00:00:38.904
So just go ahead and make sure that this is

00:00:38.904 --> 00:00:39.527
commented

00:00:39.625 --> 00:00:40.025
as

00:00:40.295 --> 00:00:40.845
correctly.

00:00:40.925 --> 00:00:43.045
We're grabbing account ID from the header now

00:00:43.045 --> 00:00:46.525
let's go ahead and clear PNPM run deploy our

00:00:46.525 --> 00:00:47.245
backend service.

00:00:47.573 --> 00:00:49.413
Now as for the front end service,

00:00:49.653 --> 00:00:52.693
what I'm going to do is I'm actually going to open

00:00:52.693 --> 00:00:55.973
this guy in a new cursor window just because it's

00:00:55.973 --> 00:00:57.763
going to be easier to navigate.

00:00:57.763 --> 00:00:59.653
we're not going to really touch the data service

00:00:59.813 --> 00:01:01.733
in this aspect of our

00:01:01.913 --> 00:01:02.673
in this section.

00:01:02.673 --> 00:01:03.753
So let's go ahead and say

00:01:04.153 --> 00:01:05.033
cursor.

00:01:05.593 --> 00:01:07.113
You also don't have to do this.

00:01:07.113 --> 00:01:07.593
This is just,

00:01:07.593 --> 00:01:08.473
this is totally optional.

00:01:08.473 --> 00:01:10.873
I just kind of like doing this because it's a

00:01:10.873 --> 00:01:12.313
little bit easier to work with.

00:01:12.553 --> 00:01:12.953
So

00:01:13.603 --> 00:01:15.043
I'm going to make sure that we can

00:01:17.043 --> 00:01:18.803
make this a bit bigger so you can see.

00:01:19.213 --> 00:01:19.523
okay,

00:01:19.523 --> 00:01:20.683
I'm going to close all of these.

00:01:20.899 --> 00:01:21.864
All right now

00:01:22.184 --> 00:01:24.304
what we're going to want to do is just kind of

00:01:24.304 --> 00:01:26.984
like talk through the data flow really quick.

00:01:27.064 --> 00:01:27.464
So

00:01:28.958 --> 00:01:31.438
so essentially we have our,

00:01:32.078 --> 00:01:34.278
we have this Hono application which actually is

00:01:34.278 --> 00:01:36.438
connected to our durable object and has the web

00:01:36.438 --> 00:01:36.958
sockets.

00:01:37.788 --> 00:01:41.148
Now currently we kind of hard coded the URL to

00:01:41.228 --> 00:01:43.628
this service and then it moved over to this

00:01:43.628 --> 00:01:45.708
durable object for the state management.

00:01:46.188 --> 00:01:48.268
What we're going to want to do is basically this

00:01:48.268 --> 00:01:50.388
TRPC side of our application.

00:01:50.388 --> 00:01:51.863
I think we have a better diagram here.

00:01:51.941 --> 00:01:54.261
We're basically going to want to have this layer

00:01:54.261 --> 00:01:55.701
do all of the authentication.

00:01:55.951 --> 00:01:57.841
so later we're actually going to build out an auth

00:01:57.841 --> 00:01:58.921
layer with better auth,

00:01:58.921 --> 00:02:00.671
so we can do sign in with Google and stuff.

00:02:00.671 --> 00:02:02.381
and then we're going to just move that connection

00:02:02.381 --> 00:02:04.701
proxy that connection over to our data service and

00:02:04.701 --> 00:02:06.061
we can do this via service bindings,

00:02:06.061 --> 00:02:08.801
meaning we don't have to like have our hard coded

00:02:09.121 --> 00:02:12.841
data service URL inside of this code and then you

00:02:12.841 --> 00:02:13.081
know,

00:02:13.081 --> 00:02:14.441
do a fetch call to it.

00:02:14.441 --> 00:02:16.481
We can actually just rely on a binding.

00:02:16.561 --> 00:02:19.841
So what this looks like is if we head over to

00:02:20.542 --> 00:02:22.110
if we head over to our

00:02:23.186 --> 00:02:24.706
wrangler JSON C,

00:02:24.946 --> 00:02:27.466
a service binding is another configuration inside

00:02:27.466 --> 00:02:30.226
of here where we can basically say we want our,

00:02:30.866 --> 00:02:31.826
we want our service,

00:02:32.066 --> 00:02:34.106
the one that we're currently working on to depend

00:02:34.106 --> 00:02:34.986
on another service.

00:02:34.986 --> 00:02:37.466
And in this situation it's just literally going to

00:02:37.466 --> 00:02:37.746
be

00:02:38.626 --> 00:02:39.026
our

00:02:39.826 --> 00:02:40.626
data service.

00:02:40.866 --> 00:02:43.106
So inside of here I'm just going to put in

00:02:44.866 --> 00:02:46.546
the binding is going to be back in service.

00:02:47.106 --> 00:02:50.186
The service name is the name inside of our data

00:02:50.186 --> 00:02:51.146
service that we've defined.

00:02:51.146 --> 00:02:52.466
So we call this data service.

00:02:52.706 --> 00:02:55.866
So you notice the name user application.

00:02:55.866 --> 00:02:57.946
Right now we're working in our user application we

00:02:57.946 --> 00:02:59.626
are now binding to our data service.

00:02:59.626 --> 00:03:01.346
So this is the name in the wrangler file.

00:03:01.346 --> 00:03:03.566
And then I'm also just doing a experimental remote

00:03:03.566 --> 00:03:05.526
because we've technically already deployed our

00:03:05.526 --> 00:03:08.286
data service so that's all running so we can

00:03:08.366 --> 00:03:10.846
actually connect to the deployed version

00:03:10.866 --> 00:03:11.756
when running locally,

00:03:11.756 --> 00:03:12.236
which is really,

00:03:12.236 --> 00:03:12.676
really cool.

00:03:12.676 --> 00:03:13.636
It didn't used to be that,

00:03:13.636 --> 00:03:14.396
that easy.

00:03:14.506 --> 00:03:16.714
next thing that we're going to do is we are going

00:03:16.714 --> 00:03:19.674
to say pnpm run CF type gin.

00:03:20.074 --> 00:03:22.674
This is going to generate a binding for our data

00:03:22.674 --> 00:03:23.034
service.

00:03:23.114 --> 00:03:24.874
Now if we head over to our

00:03:25.964 --> 00:03:28.164
worker configuration you're going to see that the

00:03:28.164 --> 00:03:30.245
backend service is literally just a fetcher.

00:03:31.562 --> 00:03:33.682
So interfacing with it is actually very very easy.

00:03:33.682 --> 00:03:34.022
and I'll,

00:03:34.022 --> 00:03:35.622
and we'll get to that in just a second.

00:03:35.862 --> 00:03:38.542
One other call out that I wanted to make is you

00:03:38.542 --> 00:03:39.862
notice inside of our worker.

00:03:39.862 --> 00:03:42.342
So this is the backend code of our user facing

00:03:42.342 --> 00:03:42.902
application.

00:03:43.062 --> 00:03:44.221
We just have this really,

00:03:44.221 --> 00:03:46.662
really simple fetch handler and this fetch handler

00:03:46.662 --> 00:03:47.222
is just

00:03:47.622 --> 00:03:50.342
looking if it's TRPC and then proxying that stuff

00:03:50.342 --> 00:03:51.102
to trpc.

00:03:51.102 --> 00:03:52.902
Now what we're also going to want to do is we're

00:03:52.902 --> 00:03:55.382
also going to want to like find our forward slash

00:03:55.542 --> 00:03:56.662
click socket.

00:03:56.662 --> 00:03:57.062
So

00:03:57.462 --> 00:03:57.942
click.

00:04:01.532 --> 00:04:03.172
And we're going to want to route everything from

00:04:03.172 --> 00:04:05.652
the click socket and we're going to proxy it to

00:04:05.652 --> 00:04:06.012
our

00:04:06.562 --> 00:04:08.282
to our data service and we're going to do a little

00:04:08.282 --> 00:04:08.762
bit more there.

00:04:08.762 --> 00:04:10.602
We're going to probably do some authentication and

00:04:10.602 --> 00:04:12.362
we're also going to like make sure we have the

00:04:12.362 --> 00:04:13.362
header set correctly.

00:04:13.362 --> 00:04:13.762
So

00:04:14.402 --> 00:04:17.642
what I like because this was just a really generic

00:04:17.642 --> 00:04:18.242
fetch handler,

00:04:18.242 --> 00:04:20.202
which is one thing in here I thought it was fine,

00:04:20.202 --> 00:04:21.682
let's just have it as a fetch handler.

00:04:21.682 --> 00:04:24.242
But now that we're actually doing like URL path

00:04:24.242 --> 00:04:25.202
name starts with this.

00:04:25.282 --> 00:04:27.522
URL path name starts with client socket.

00:04:27.602 --> 00:04:29.522
We're going to actually probably want to move this

00:04:29.522 --> 00:04:32.822
to a mesh managed way of doing routes and we can

00:04:32.822 --> 00:04:33.822
do that with Hono.

00:04:33.822 --> 00:04:35.022
So if you notice,

00:04:35.022 --> 00:04:37.062
in our data service we have our Hono application

00:04:37.062 --> 00:04:39.502
with all these routes defined and then we have our

00:04:39.502 --> 00:04:42.102
index and basically our fetch is just passing that

00:04:42.102 --> 00:04:43.182
data right off to

00:04:43.752 --> 00:04:44.432
fetch handler.

00:04:44.432 --> 00:04:45.872
And then we have a

00:04:46.192 --> 00:04:47.832
and we have Init db.

00:04:47.832 --> 00:04:50.112
Now this is actually extending a worker entry

00:04:50.112 --> 00:04:50.432
point.

00:04:50.752 --> 00:04:51.912
Totally fine way of doing it.

00:04:51.912 --> 00:04:53.232
This is my preferred way of doing it.

00:04:53.232 --> 00:04:56.152
In our client application we could do it the same

00:04:56.152 --> 00:04:56.352
way.

00:04:56.352 --> 00:04:57.712
We could do it exactly this way,

00:04:57.952 --> 00:04:59.812
but we could also just have like this,

00:04:59.962 --> 00:05:01.762
this fetch handler exported with no

00:05:01.762 --> 00:05:02.402
function Object() { [native code] }.

00:05:02.402 --> 00:05:03.042
Totally fine.

00:05:03.042 --> 00:05:04.922
So I'm just going to show this pattern for this

00:05:04.922 --> 00:05:05.402
example.

00:05:05.642 --> 00:05:07.802
Now I've already created this Hono app,

00:05:07.962 --> 00:05:08.722
very simple.

00:05:08.722 --> 00:05:10.282
Right now it's just looking

00:05:10.762 --> 00:05:12.173
everything at TRPC

00:05:12.173 --> 00:05:14.577
is going to route into this fetch handler right

00:05:14.577 --> 00:05:14.857
here.

00:05:15.337 --> 00:05:15.737
And

00:05:16.287 --> 00:05:18.527
it's doing the exact same thing that we're doing

00:05:18.527 --> 00:05:18.754
here.

00:05:18.754 --> 00:05:21.518
And then we're also going to add this click

00:05:21.518 --> 00:05:22.118
socket.

00:05:22.118 --> 00:05:23.948
Now what you're going to notice here is,

00:05:24.378 --> 00:05:25.738
I am grabbing some,

00:05:25.898 --> 00:05:27.258
I'm creating a headers,

00:05:27.778 --> 00:05:28.178
object.

00:05:28.418 --> 00:05:29.898
Then I'm setting account id.

00:05:29.898 --> 00:05:31.658
Right now we're still setting it manually because

00:05:31.658 --> 00:05:33.618
we haven't built out that authentication logic.

00:05:33.778 --> 00:05:36.338
And then I am creating a new request where I'm

00:05:36.338 --> 00:05:38.778
passing in the request that we received from the

00:05:38.778 --> 00:05:39.218
client

00:05:39.698 --> 00:05:41.378
into this new request object.

00:05:41.538 --> 00:05:43.898
And then also I'm passing in those headers and

00:05:43.898 --> 00:05:45.498
then this is where that binding happens.

00:05:45.498 --> 00:05:47.138
So instead of like just saying fetch

00:05:47.458 --> 00:05:50.338
or Axios or whatever your preferred fetch library

00:05:50.338 --> 00:05:50.658
is,

00:05:50.818 --> 00:05:52.018
what we're doing is we're saying,

00:05:52.158 --> 00:05:52.448
envy

00:05:52.958 --> 00:05:53.598
backend service

00:05:53.918 --> 00:05:54.478
fetch.

00:05:54.638 --> 00:05:56.838
And this is basically calling the fetch handler of

00:05:56.838 --> 00:05:57.638
our backend service.

00:05:57.638 --> 00:06:00.078
So it's literally calling this guy right here.

00:06:00.078 --> 00:06:02.078
So it's just proxying that request through.

00:06:02.078 --> 00:06:02.918
And there's very,

00:06:02.918 --> 00:06:03.198
very,

00:06:03.198 --> 00:06:05.678
very little added latency when you're doing this

00:06:05.678 --> 00:06:08.638
just because it's calling like code that's living

00:06:08.638 --> 00:06:09.518
next to each other,

00:06:09.538 --> 00:06:11.168
inside of Cloudflare's

00:06:11.488 --> 00:06:11.588
inside,

00:06:11.798 --> 00:06:13.198
of Cloudflare's like server farm.

00:06:13.278 --> 00:06:13.678
So

00:06:13.998 --> 00:06:15.998
this is all we have to do to proxy that request.

00:06:16.278 --> 00:06:18.518
and then what I'm going to do inside of our index

00:06:18.518 --> 00:06:18.975
ts,

00:06:19.036 --> 00:06:21.116
I'm just going to go ahead and say we can

00:06:21.116 --> 00:06:22.556
instantiate the database at this level,

00:06:22.556 --> 00:06:23.076
that's fine.

00:06:23.076 --> 00:06:24.316
And then I'm just going to say return

00:06:25.774 --> 00:06:29.374
app.fetch and then we'll pass in

00:06:30.564 --> 00:06:31.074
request

00:06:31.474 --> 00:06:34.834
and we'll pass in emv and we'll pass in context

00:06:35.714 --> 00:06:37.794
and it's going to mirror what we have done here.

00:06:38.594 --> 00:06:41.394
So we're just passing what's in here into here.

00:06:41.644 --> 00:06:42.694
and then this code should work.

00:06:42.694 --> 00:06:43.870
So we should be able to say,

00:06:44.146 --> 00:06:45.266
npm run

00:06:45.500 --> 00:06:45.900
dev.

00:06:46.325 --> 00:06:47.205
This should start up.

00:06:47.205 --> 00:06:49.405
And then I'm gonna also delete these guys just to

00:06:49.405 --> 00:06:50.371
clean this up a little bit.

00:06:50.912 --> 00:06:52.072
and just one thing.

00:06:52.072 --> 00:06:53.392
If you haven't set this yet,

00:06:53.872 --> 00:06:55.712
you're going to have to create a

00:06:56.032 --> 00:06:56.846
EMV file

00:06:56.846 --> 00:06:58.559
and this isn't going to be in the git repo.

00:06:58.559 --> 00:06:59.159
So you're going to say,

00:06:59.159 --> 00:07:01.639
you're going to create this EMV file at the root

00:07:01.639 --> 00:07:02.959
of your user application.

00:07:03.539 --> 00:07:04.739
Then you're going to say vite

00:07:05.219 --> 00:07:06.099
base host.

00:07:06.259 --> 00:07:06.939
For now,

00:07:06.939 --> 00:07:08.619
right now what we're going to do is we're just

00:07:08.619 --> 00:07:10.259
going to say localhost 3000

00:07:11.228 --> 00:07:13.788
and we should be able to open this guy up.

00:07:14.428 --> 00:07:15.515
Let's head over to

00:07:16.235 --> 00:07:16.635
app.

00:07:16.837 --> 00:07:19.033
I'll also inspect our network tab.

00:07:19.033 --> 00:07:19.374
Cool.

00:07:19.454 --> 00:07:19.854
So

00:07:20.204 --> 00:07:20.604
notice

00:07:21.004 --> 00:07:22.284
our client socket

00:07:22.604 --> 00:07:25.004
is actually making a request to.

00:07:25.724 --> 00:07:28.204
It's actually making a request to localhost 3000

00:07:28.280 --> 00:07:30.474
and that is being proxy to our backend service.

00:07:30.634 --> 00:07:32.554
So we are connected as we can see here.

00:07:32.794 --> 00:07:34.714
And then if I go to one of our,

00:07:34.874 --> 00:07:35.914
our URLs,

00:07:36.714 --> 00:07:38.074
it's gonna show up right there.

00:07:38.074 --> 00:07:38.794
So look at that.

00:07:38.794 --> 00:07:41.594
Now we have our little like map working.

00:07:41.754 --> 00:07:42.314
So the

00:07:42.634 --> 00:07:44.954
events are actually making its way from

00:07:45.604 --> 00:07:48.444
our link click to our backend service via

00:07:48.444 --> 00:07:49.244
WebSocket,

00:07:49.244 --> 00:07:50.404
back to our UI.

00:07:50.404 --> 00:07:51.644
So this is a really,

00:07:51.644 --> 00:07:53.844
really easy way of binding your backend to your

00:07:53.844 --> 00:07:54.244
front end.

00:07:54.244 --> 00:07:56.564
It was like such little code and honestly it's

00:07:56.564 --> 00:07:57.684
just working so perfectly.

00:07:57.684 --> 00:07:58.084
So

00:07:58.524 --> 00:07:59.284
now when you,

00:07:59.284 --> 00:08:00.284
when we deploy this,

00:08:00.284 --> 00:08:02.124
we're actually going to want to add,

00:08:02.424 --> 00:08:03.504
we're going to get into this later.

00:08:03.624 --> 00:08:05.164
we're going to be doing like DevOps.

00:08:05.624 --> 00:08:07.264
we're going to do automated deployments and stuff.

00:08:07.264 --> 00:08:08.944
We're going to manage environments in a really

00:08:08.944 --> 00:08:09.264
like,

00:08:09.264 --> 00:08:09.864
nice way.

00:08:09.864 --> 00:08:10.264
But

00:08:10.584 --> 00:08:11.384
what we're going,

00:08:11.384 --> 00:08:12.054
what we're doing

00:08:12.524 --> 00:08:13.084
right now,

00:08:13.164 --> 00:08:13.924
when we deploy,

00:08:13.924 --> 00:08:15.484
instead of deploying the local host,

00:08:15.724 --> 00:08:18.204
you're going to want to get the URL for your user

00:08:18.204 --> 00:08:18.764
application

00:08:19.084 --> 00:08:21.564
and you're going to want to put that in here as

00:08:21.564 --> 00:08:21.844
well.

00:08:21.844 --> 00:08:23.044
So I'm just going to put that here.

00:08:23.044 --> 00:08:23.404
Now

00:08:23.724 --> 00:08:26.586
this is our URL.workers.dev.

00:08:26.586 --> 00:08:27.583
URL.workers.dev.

00:08:28.550 --> 00:08:29.030
okay,

00:08:29.030 --> 00:08:31.030
so this is our base host.

00:08:32.730 --> 00:08:35.290
then we can say pnpm run deploy.

00:08:38.370 --> 00:08:40.850
You can ignore the code chunking for now,

00:08:40.850 --> 00:08:41.690
there's other ways to,

00:08:41.690 --> 00:08:41.890
like,

00:08:41.890 --> 00:08:42.670
make that smaller.

00:08:42.670 --> 00:08:44.140
you can kind of read through the documentation

00:08:44.140 --> 00:08:44.860
that they have here.

00:08:44.860 --> 00:08:45.860
This is just a warning.

00:08:45.940 --> 00:08:46.340
And

00:08:46.429 --> 00:08:47.629
now that we're deployed,

00:08:47.629 --> 00:08:48.766
we can open this guy up

00:08:49.021 --> 00:08:51.101
and let's go to our app

00:08:51.435 --> 00:08:53.281
and you can see that we're immediately connected.

00:08:53.601 --> 00:08:57.441
I'm gonna go do this redirect and take a look.

00:08:57.601 --> 00:09:00.081
We're now able to see that data pop up here in

00:09:00.081 --> 00:09:00.641
real time.

00:09:00.641 --> 00:09:01.881
So end to end,

00:09:01.881 --> 00:09:02.561
this is working.

00:09:02.651 --> 00:09:04.441
basically the entire UI is built out.

00:09:04.441 --> 00:09:05.681
The things that we do not have,

00:09:05.681 --> 00:09:07.081
which we're going to be doing towards the end of

00:09:07.081 --> 00:09:07.361
the course,

00:09:07.361 --> 00:09:07.931
is like,

00:09:08.171 --> 00:09:11.861
some of this data in our dashboard and is actually

00:09:11.861 --> 00:09:12.581
not legit.

00:09:12.581 --> 00:09:12.981
Like,

00:09:13.833 --> 00:09:15.929
like the active links here is not legit.

00:09:16.009 --> 00:09:17.329
The country breakdown,

00:09:17.329 --> 00:09:18.409
this is not legit.

00:09:18.809 --> 00:09:20.849
and I don't think that these metrics are legit,

00:09:20.849 --> 00:09:21.929
but we'll get to this later.

00:09:21.929 --> 00:09:22.329
So,

00:09:22.569 --> 00:09:23.109
for now,

00:09:23.109 --> 00:09:23.549
you know,

00:09:23.549 --> 00:09:24.029
end to end,

00:09:24.029 --> 00:09:25.029
this application is working.

00:09:25.029 --> 00:09:27.629
We have an entire ecosystem of data flow built

00:09:27.629 --> 00:09:27.909
out.

00:09:29.749 --> 00:09:30.149
And,

00:09:30.449 --> 00:09:32.409
we've implemented websockets where we're able to

00:09:32.409 --> 00:09:33.689
manage state on the back end.

00:09:33.689 --> 00:09:35.369
And just to kind of like illustrate this,

00:09:35.369 --> 00:09:37.209
let's open this guy into a new tab.

00:09:38.059 --> 00:09:38.619
New tab,

00:09:39.339 --> 00:09:40.459
reload this page.

00:09:41.179 --> 00:09:42.619
So we don't have anything,

00:09:42.939 --> 00:09:44.299
we don't have anything right now.

00:09:44.369 --> 00:09:45.779
and then I'm going to just go to

00:09:46.179 --> 00:09:46.779
that link,

00:09:46.779 --> 00:09:48.259
it's going to redirect to Google

00:09:48.659 --> 00:09:49.619
and look at that.

00:09:49.619 --> 00:09:50.979
It's cascaded to here.

00:09:51.299 --> 00:09:52.339
It's on this one

00:09:52.739 --> 00:09:53.939
and it's on this one.

00:09:54.319 --> 00:09:55.359
you were to do this on your phone,

00:09:55.359 --> 00:09:56.999
you'd also notice that that's the case.

00:09:56.999 --> 00:09:58.868
So WebSockets are working perfectly.

00:09:58.868 --> 00:09:59.259
All right,

00:09:59.259 --> 00:09:59.739
so now,

00:09:59.739 --> 00:10:01.299
before moving on to authentication,

00:10:01.299 --> 00:10:02.219
this next section,

00:10:02.219 --> 00:10:04.499
we're actually going to dive really deep into like

00:10:04.499 --> 00:10:05.739
the DevOps side of things.

00:10:05.979 --> 00:10:06.939
Automated deploy.

00:10:07.799 --> 00:10:09.679
Managing multiple versions of your application.

00:10:09.679 --> 00:10:11.839
You can have a stage and a production version

00:10:11.839 --> 00:10:13.079
version of your application,

00:10:13.239 --> 00:10:15.439
how we manage environment variables that way and

00:10:15.439 --> 00:10:15.999
so forth.

00:10:15.999 --> 00:10:17.559
So I think that this is actually a really

00:10:17.559 --> 00:10:19.159
requested aspect of the course.

00:10:19.159 --> 00:10:21.319
A lot of people don't know how to do this,

00:10:21.879 --> 00:10:23.719
like in a really good way with cloudflare.

00:10:23.719 --> 00:10:26.039
But I have a few workflows that I have built out

00:10:26.039 --> 00:10:26.359
that

00:10:26.839 --> 00:10:27.239
really,

00:10:27.419 --> 00:10:29.739
streamline the development process and allow me to

00:10:29.739 --> 00:10:30.659
develop in a safe way.

00:10:30.659 --> 00:10:32.179
So we're going to cover that before getting into

00:10:32.179 --> 00:10:32.979
the auth stuff.

00:10:32.979 --> 00:10:33.379
Oh yeah,

00:10:33.379 --> 00:10:33.899
we're also,

00:10:33.899 --> 00:10:34.779
we're going to go into,

00:10:35.969 --> 00:10:36.369
domains.

00:10:36.369 --> 00:10:37.929
So like domain routing and whatnot.

00:10:37.929 --> 00:10:39.569
So I'm going to go ahead and purchase a domain for

00:10:39.569 --> 00:10:39.969
this course,

00:10:39.969 --> 00:10:41.849
show you how to actually wire up your own domain

00:10:41.849 --> 00:10:43.169
so you're not using this anymore.

00:10:43.329 --> 00:10:44.249
And then from there,

00:10:44.249 --> 00:10:46.009
that's also going to give us the foundation to

00:10:46.009 --> 00:10:46.689
build on top of,

00:10:46.689 --> 00:10:47.809
so we can actually use,

00:10:47.839 --> 00:10:49.379
sign in with Google and better authenticity.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.146 --> 00:00:02.946
So throughout this course we have been appending

00:00:03.266 --> 00:00:06.226
the word stage to the end of resources that we

00:00:06.226 --> 00:00:06.546
create.

00:00:06.626 --> 00:00:08.866
And the reason we've done that is because

00:00:09.186 --> 00:00:11.306
essentially we're going to want to create some

00:00:11.306 --> 00:00:14.706
type of deployment mechanism where we can deploy

00:00:15.106 --> 00:00:17.506
two separate resources for lower environment

00:00:17.586 --> 00:00:17.946
stuff,

00:00:17.946 --> 00:00:20.066
meaning stage basically for testing and

00:00:20.066 --> 00:00:20.706
validating,

00:00:20.756 --> 00:00:22.746
to ensure like systems are functioning as normal.

00:00:22.746 --> 00:00:23.226
And then

00:00:23.836 --> 00:00:26.356
when those changes are good and we've truly

00:00:26.356 --> 00:00:28.236
validated them to be able to

00:00:28.616 --> 00:00:31.256
deploy them to a mirror of that environment for

00:00:31.256 --> 00:00:31.896
production.

00:00:31.976 --> 00:00:32.376
Now

00:00:32.776 --> 00:00:35.016
we're going to go through this process and what

00:00:35.596 --> 00:00:37.256
I just kind of want to like illustrate is there's

00:00:37.256 --> 00:00:38.616
a lot of different ways to

00:00:39.096 --> 00:00:39.816
do like

00:00:39.946 --> 00:00:42.536
CICD pipeline for continuous deployments which

00:00:42.536 --> 00:00:44.896
basically just means you have a way of auto

00:00:44.896 --> 00:00:47.176
deploying based upon some type of trigger.

00:00:47.176 --> 00:00:49.536
Now currently what we've been doing is we've been

00:00:49.536 --> 00:00:50.136
saying like

00:00:50.626 --> 00:00:51.026
pm,

00:00:51.426 --> 00:00:52.146
npm,

00:00:52.386 --> 00:00:52.786
run,

00:00:53.346 --> 00:00:53.986
deploy,

00:00:53.986 --> 00:00:54.386
right?

00:00:54.846 --> 00:00:56.726
and this has worked fine for our use case.

00:00:56.726 --> 00:00:58.646
But as you're working with the team and you're

00:00:58.646 --> 00:01:00.406
getting a little bit more professional and safe,

00:01:00.406 --> 00:01:02.006
you're going to want to have some type of

00:01:02.006 --> 00:01:03.486
mechanism that does this for you.

00:01:03.486 --> 00:01:03.886
And

00:01:04.206 --> 00:01:05.966
what I do find best for like

00:01:06.446 --> 00:01:08.686
even like starter projects that are very small,

00:01:08.846 --> 00:01:11.566
even projects that grow in size to a larger team

00:01:11.566 --> 00:01:12.766
and larger scale,

00:01:12.766 --> 00:01:15.246
GitHub Actions work very very well for this use

00:01:15.246 --> 00:01:15.446
case.

00:01:15.446 --> 00:01:16.126
Now there are

00:01:16.916 --> 00:01:18.996
more like enterprise level types of

00:01:19.446 --> 00:01:21.046
CICD pipeline tooling.

00:01:21.046 --> 00:01:24.486
But GitHub Actions really do work for like so many

00:01:24.486 --> 00:01:24.926
use cases.

00:01:24.926 --> 00:01:27.686
You'd really have to make a justification for like

00:01:27.686 --> 00:01:29.286
why it's not the case for your project.

00:01:29.546 --> 00:01:29.736
now

00:01:29.736 --> 00:01:31.061
you can imagine in GitHub

00:01:31.382 --> 00:01:33.342
we've really just like haven't done anything with

00:01:33.342 --> 00:01:35.382
branching but you could take your entire project

00:01:35.382 --> 00:01:37.142
and you could create a new branch for,

00:01:37.142 --> 00:01:39.382
for it and we'll just call this branch other.

00:01:39.622 --> 00:01:41.662
And then you could make it so you develop some

00:01:41.662 --> 00:01:43.862
changes and you push those changes to this branch

00:01:44.262 --> 00:01:44.552
and,

00:01:44.622 --> 00:01:46.262
and whenever you push this change to the branch

00:01:46.262 --> 00:01:48.302
you can configure your project to basically auto

00:01:48.302 --> 00:01:49.182
deploy for you,

00:01:49.252 --> 00:01:49.602
to

00:01:50.082 --> 00:01:52.482
a stage version of your application

00:01:52.802 --> 00:01:54.562
and you can continue to go through the cycle where

00:01:54.562 --> 00:01:55.002
you deploy,

00:01:55.002 --> 00:01:55.242
change,

00:01:55.242 --> 00:01:55.682
deploy,

00:01:55.682 --> 00:01:55.922
change,

00:01:55.922 --> 00:01:56.322
deploy,

00:01:56.322 --> 00:01:56.642
change.

00:01:56.932 --> 00:01:59.242
every time you push it's continuously deploying

00:01:59.242 --> 00:02:01.202
changes and then you can validate,

00:02:01.202 --> 00:02:02.922
make sure everything's running as expected and

00:02:02.922 --> 00:02:05.922
then when you're finally ready you can open a pull

00:02:05.922 --> 00:02:08.122
request and then merge those changes into your

00:02:08.122 --> 00:02:08.602
main branch.

00:02:08.602 --> 00:02:11.122
When that happens it can automatically trigger a

00:02:11.122 --> 00:02:12.002
prod deployment.

00:02:12.082 --> 00:02:15.042
So this is the flow that we're going to be setting

00:02:15.042 --> 00:02:15.362
up.

00:02:15.702 --> 00:02:17.662
but in order to do so we have to segment the

00:02:17.662 --> 00:02:20.422
resources in our Wrangler config to do that,

00:02:20.422 --> 00:02:21.622
to basically enable this.

00:02:21.702 --> 00:02:22.102
So,

00:02:22.502 --> 00:02:24.422
to do this is actually pretty simple.

00:02:24.662 --> 00:02:26.342
So what we're going to do is we're going to just

00:02:26.342 --> 00:02:27.302
close all this stuff.

00:02:27.462 --> 00:02:30.742
We really only care about our Wrangler files and

00:02:30.822 --> 00:02:32.102
the data service

00:02:32.742 --> 00:02:34.502
and the user service.

00:02:34.582 --> 00:02:37.022
So first thing that we're going to do is in the

00:02:37.022 --> 00:02:37.542
data service,

00:02:38.422 --> 00:02:41.302
if we head over to the Wrangler JSON C,

00:02:41.702 --> 00:02:43.302
you're going to notice there's like these things

00:02:43.302 --> 00:02:44.022
at the top level

00:02:44.562 --> 00:02:45.522
which are kind of global.

00:02:45.762 --> 00:02:46.162
The,

00:02:46.322 --> 00:02:49.202
the path to your config schema doesn't change.

00:02:49.442 --> 00:02:51.442
The name of your project isn't going to change.

00:02:51.442 --> 00:02:52.562
Like at the top level,

00:02:53.332 --> 00:02:55.012
the entry point's not going to change.

00:02:55.092 --> 00:02:56.612
Version node compatibility,

00:02:56.692 --> 00:02:59.452
observability being on or off doesn't necessarily

00:02:59.452 --> 00:02:59.812
change.

00:03:00.052 --> 00:03:01.332
But all this stuff where

00:03:01.652 --> 00:03:03.092
browser rendering is

00:03:03.212 --> 00:03:03.692
enabled,

00:03:03.692 --> 00:03:04.612
AI is enabled,

00:03:04.612 --> 00:03:05.532
R2 buckets

00:03:05.932 --> 00:03:08.372
specifically pointing to stage D1 database.

00:03:08.372 --> 00:03:11.012
So essentially what I'm going to do is I'm going

00:03:11.012 --> 00:03:12.492
to come down to the bottom of this

00:03:12.516 --> 00:03:13.934
and I'm just going to copy all this stuff.

00:03:15.742 --> 00:03:17.022
Then what we can do

00:03:17.422 --> 00:03:20.782
is basically just notice all we have is this from

00:03:20.782 --> 00:03:22.062
schema to observability.

00:03:22.782 --> 00:03:24.942
Then what you can do is you can say

00:03:25.262 --> 00:03:25.982
emv

00:03:26.702 --> 00:03:29.822
and inside of EMV you can provide your own custom

00:03:29.902 --> 00:03:30.302
key.

00:03:30.542 --> 00:03:31.202
So we'll,

00:03:31.272 --> 00:03:32.312
what we're going to say is we're going to say

00:03:32.312 --> 00:03:34.392
stage is our first custom one.

00:03:34.632 --> 00:03:35.912
And inside of Stage

00:03:36.792 --> 00:03:39.952
we can then create another object and paste all

00:03:39.952 --> 00:03:40.872
that stuff into here.

00:03:41.592 --> 00:03:42.712
So now everything

00:03:43.112 --> 00:03:45.952
that we had before that is specific to our

00:03:45.952 --> 00:03:46.232
environment

00:03:46.712 --> 00:03:48.792
is configured inside of Stage.

00:03:49.272 --> 00:03:51.912
Now if you go ahead and just try to deploy this,

00:03:52.712 --> 00:03:54.832
you're going to find that it actually doesn't pick

00:03:54.832 --> 00:03:55.752
up all of these,

00:03:55.872 --> 00:03:56.972
environment variables.

00:03:57.212 --> 00:03:59.012
And the reason why it doesn't pick up the

00:03:59.012 --> 00:04:01.092
environment variables is because our deploy script

00:04:01.092 --> 00:04:02.882
also has to reference that specific

00:04:03.191 --> 00:04:03.431
environment.

00:04:04.311 --> 00:04:05.591
So in order to do that,

00:04:05.831 --> 00:04:08.591
head over to your package JSON file and this

00:04:08.591 --> 00:04:09.311
deploy script.

00:04:09.311 --> 00:04:10.791
What we're going to do is we're going to say,

00:04:11.291 --> 00:04:11.851
stage

00:04:12.811 --> 00:04:13.451
deploy

00:04:13.510 --> 00:04:15.295
and then we are going to pass in

00:04:16.175 --> 00:04:16.575
dash,

00:04:16.575 --> 00:04:16.895
dash,

00:04:16.895 --> 00:04:17.215
env

00:04:18.415 --> 00:04:19.055
stage.

00:04:19.375 --> 00:04:21.935
So the name that we've defined for that specific

00:04:21.935 --> 00:04:22.255
env

00:04:22.458 --> 00:04:22.953
and then

00:04:23.273 --> 00:04:25.113
similarly what we can do here

00:04:25.644 --> 00:04:26.844
on our CF type gen,

00:04:27.404 --> 00:04:29.604
I guess it might make sense to illustrate this

00:04:29.604 --> 00:04:30.324
before I add it.

00:04:30.324 --> 00:04:32.284
So right now if we run pnpm,

00:04:32.284 --> 00:04:33.324
run CF

00:04:34.844 --> 00:04:35.564
type gen,

00:04:38.462 --> 00:04:40.662
we can head over to this config and what you're

00:04:40.662 --> 00:04:42.622
going to notice is all of a sudden our

00:04:42.942 --> 00:04:46.222
wrangler config EMV no longer has all of the

00:04:46.222 --> 00:04:47.182
information that we,

00:04:47.192 --> 00:04:49.122
that we currently need for our resources.

00:04:49.202 --> 00:04:50.982
Now that is because we,

00:04:51.212 --> 00:04:52.972
if you're going to have environments

00:04:53.372 --> 00:04:56.172
when you do your CF type gen when developing,

00:04:56.172 --> 00:04:57.612
this isn't something you have to do during

00:04:57.612 --> 00:04:58.252
deployments,

00:04:58.412 --> 00:05:01.572
but you're also going to want to pass in the EMV

00:05:01.572 --> 00:05:02.092
stage

00:05:02.572 --> 00:05:03.452
as a flag

00:05:03.932 --> 00:05:05.252
in this step as well.

00:05:05.252 --> 00:05:06.412
So you can pass that in.

00:05:06.732 --> 00:05:07.052
Now,

00:05:07.052 --> 00:05:08.092
when we run this,

00:05:08.172 --> 00:05:09.492
when we head over here now,

00:05:09.492 --> 00:05:12.492
you can notice all of our bindings are accessible

00:05:12.492 --> 00:05:13.130
at this level.

00:05:13.195 --> 00:05:13.595
Now,

00:05:13.595 --> 00:05:14.795
instead of running,

00:05:15.265 --> 00:05:16.705
PMPM Run Deploy,

00:05:17.175 --> 00:05:19.095
we will be running PMPM Run

00:05:19.495 --> 00:05:20.695
Stage Deploy.

00:05:20.855 --> 00:05:21.255
So

00:05:21.735 --> 00:05:24.215
I'm going to clear this out and say PNPM

00:05:25.495 --> 00:05:25.895
Run

00:05:27.015 --> 00:05:28.055
Stage Deploy.

00:05:28.722 --> 00:05:30.444
And that should go through the exact same process

00:05:30.444 --> 00:05:31.284
that we had before,

00:05:31.684 --> 00:05:34.244
but we're just specifically pointing it at stage.

00:05:35.171 --> 00:05:37.011
Now what we're going to see here is we're going to

00:05:37.011 --> 00:05:39.371
notice an error and these errors are honestly in

00:05:39.371 --> 00:05:39.891
my opinion,

00:05:39.891 --> 00:05:41.291
pretty easy to debug.

00:05:41.291 --> 00:05:42.951
You're going to get this exact same error when

00:05:42.951 --> 00:05:43.711
trying to deploy.

00:05:44.111 --> 00:05:46.311
Now the reason why you're getting this error is

00:05:46.311 --> 00:05:46.671
because,

00:05:47.311 --> 00:05:49.951
it is basically what it's saying is it's saying

00:05:49.951 --> 00:05:51.391
the queue name

00:05:51.711 --> 00:05:52.271
stage

00:05:52.671 --> 00:05:54.191
already has a consumer

00:05:54.671 --> 00:05:57.551
and a cloudflare queue can only have one consumer.

00:05:57.551 --> 00:05:59.311
So when we try to deploy this application,

00:05:59.631 --> 00:06:02.511
essentially what's happening is we have our,

00:06:03.406 --> 00:06:04.766
we had our data service

00:06:05.166 --> 00:06:07.406
and it created a new application called the Data

00:06:07.406 --> 00:06:08.286
Service Stage.

00:06:08.286 --> 00:06:09.726
Now since this is a lower environment,

00:06:09.886 --> 00:06:10.246
one,

00:06:10.246 --> 00:06:12.136
we don't necessarily care if this,

00:06:12.366 --> 00:06:12.606
this

00:06:12.866 --> 00:06:13.746
service like,

00:06:13.906 --> 00:06:15.106
is currently running,

00:06:15.186 --> 00:06:16.506
then what we can do,

00:06:16.506 --> 00:06:17.626
like there's two things we could do.

00:06:17.626 --> 00:06:20.306
We could unbind it from this application.

00:06:20.946 --> 00:06:22.426
But what I'm going to do is like,

00:06:22.426 --> 00:06:22.626
yeah,

00:06:22.626 --> 00:06:25.106
so we could essentially unbind it from the

00:06:25.766 --> 00:06:25.986
here

00:06:25.986 --> 00:06:26.720
at this level.

00:06:26.852 --> 00:06:29.532
But I'm just going to go ahead and entirely delete

00:06:29.532 --> 00:06:31.050
this service altogether

00:06:32.551 --> 00:06:35.864
and it says it has a dependency on our user

00:06:35.864 --> 00:06:36.424
application.

00:06:36.824 --> 00:06:37.224
So,

00:06:38.502 --> 00:06:38.862
yeah,

00:06:38.862 --> 00:06:40.462
so it's just going to mention that you can do it,

00:06:40.462 --> 00:06:41.222
but it will break.

00:06:41.382 --> 00:06:43.342
So I'm also going to be deleting our user

00:06:43.342 --> 00:06:44.154
application as well.

00:06:44.154 --> 00:06:47.514
it looks like it failed because it actually wants

00:06:47.514 --> 00:06:48.874
us to manually delete these.

00:06:48.874 --> 00:06:51.354
So I can just go ahead and say delete here,

00:06:52.648 --> 00:06:53.324
delete here,

00:06:54.256 --> 00:06:56.616
and then we're going to go ahead and delete the

00:06:56.616 --> 00:06:57.136
data service.

00:06:57.136 --> 00:06:58.856
Now if you're setting up a new project and you

00:06:58.856 --> 00:06:59.136
want

00:06:59.416 --> 00:07:00.316
branch versioning,

00:07:00.716 --> 00:07:02.636
I would suggest doing so,

00:07:03.716 --> 00:07:05.316
I would suggest doing so

00:07:05.876 --> 00:07:07.156
at the beginning of your project.

00:07:07.271 --> 00:07:07.551
But yeah,

00:07:07.551 --> 00:07:08.791
now we don't have that application.

00:07:08.791 --> 00:07:10.751
And I'm just going to go ahead and delete our user

00:07:10.751 --> 00:07:11.551
application as well,

00:07:11.551 --> 00:07:13.271
because we're going to basically be faced with the

00:07:13.271 --> 00:07:13.711
same thing.

00:07:13.711 --> 00:07:13.841
Or

00:07:13.841 --> 00:07:14.451
not the same thing,

00:07:14.451 --> 00:07:16.131
but we're going to have a new version of it

00:07:16.131 --> 00:07:16.531
running.

00:07:16.531 --> 00:07:16.614
So

00:07:16.614 --> 00:07:19.066
we can go ahead and say delete user application

00:07:20.275 --> 00:07:22.675
and let's go ahead and deploy this one more time.

00:07:23.062 --> 00:07:23.382
Cool.

00:07:23.462 --> 00:07:26.182
So this successfully deployed and now the URL

00:07:26.182 --> 00:07:27.942
you're going to notice is a little bit different.

00:07:28.102 --> 00:07:28.662
It is

00:07:28.982 --> 00:07:32.022
the same except it has dash stage at the end of

00:07:32.022 --> 00:07:32.182
it.

00:07:32.182 --> 00:07:34.502
And the name of the deployable is also like this.

00:07:34.742 --> 00:07:35.142
So

00:07:35.462 --> 00:07:38.062
we can also go to our user application,

00:07:38.062 --> 00:07:39.142
which I have right here,

00:07:39.702 --> 00:07:41.702
and I'm just going to go into our

00:07:42.972 --> 00:07:43.532
wrangler,

00:07:43.532 --> 00:07:44.420
JSON for that

00:07:44.420 --> 00:07:45.794
and do the exact same thing here.

00:07:45.794 --> 00:07:47.234
I'm going to copy these guys over.

00:07:49.794 --> 00:07:50.994
Then I'm going to say emv,

00:07:51.394 --> 00:07:52.354
then I'm going to say

00:07:52.994 --> 00:07:53.554
stage,

00:07:57.394 --> 00:07:58.994
then I'll paste this stuff in here.

00:07:59.467 --> 00:08:03.267
Now we should be able to also modify our package

00:08:03.267 --> 00:08:03.787
JSON.

00:08:04.267 --> 00:08:05.547
So we can just say,

00:08:07.317 --> 00:08:08.437
we can just say

00:08:09.157 --> 00:08:12.077
under deploy script or also CF type gin.

00:08:12.077 --> 00:08:14.517
We can say dash dash EMV stage

00:08:15.257 --> 00:08:16.777
and we'll do the same for our deploy

00:08:18.617 --> 00:08:21.257
and then we can go PMPM run.

00:08:24.057 --> 00:08:24.097
I'm

00:08:24.277 --> 00:08:24.957
going to call this

00:08:25.357 --> 00:08:26.717
stage Deploy.

00:08:27.597 --> 00:08:30.797
So PNPM run stage colon deploy.

00:08:32.157 --> 00:08:34.397
Now this is also going to be giving us a

00:08:34.877 --> 00:08:34.897
new

00:08:35.057 --> 00:08:35.697
URL.

00:08:35.857 --> 00:08:36.257
So

00:08:37.137 --> 00:08:39.217
what we're going to want to make sure we do is

00:08:39.217 --> 00:08:40.417
when we get that URL,

00:08:40.657 --> 00:08:40.907
we,

00:08:40.977 --> 00:08:42.497
we can also update our.

00:08:42.577 --> 00:08:42.897
Oh,

00:08:42.897 --> 00:08:44.417
it looks like we also got an error here.

00:08:44.577 --> 00:08:46.737
You have a specific environment stage,

00:08:47.137 --> 00:08:47.857
but are

00:08:48.337 --> 00:08:50.337
using redirect configuration,

00:08:51.067 --> 00:08:53.080
produced by a build tool such as vite.

00:08:53.540 --> 00:08:55.540
So after reading through their VITE

00:08:56.500 --> 00:08:58.740
documentation about environment variables,

00:08:59.060 --> 00:09:01.940
I learned that essentially you need to export a

00:09:01.940 --> 00:09:05.020
specific environment variable and then during that

00:09:05.020 --> 00:09:07.220
deployment you should be able to pick up on it.

00:09:07.220 --> 00:09:07.620
So

00:09:08.020 --> 00:09:10.020
what we can do here is in our,

00:09:11.122 --> 00:09:13.042
what we can do here is we can delete,

00:09:13.242 --> 00:09:14.782
EMV stage from our deploy.

00:09:15.182 --> 00:09:18.622
And then what I did is I added inside of my EMV

00:09:18.622 --> 00:09:19.102
file,

00:09:19.642 --> 00:09:21.422
this specific cloudflare environment.

00:09:23.293 --> 00:09:24.653
And then I said

00:09:25.133 --> 00:09:25.693
stage.

00:09:25.853 --> 00:09:28.053
So now from here your deployment should work.

00:09:28.053 --> 00:09:30.413
But I do think we might get one more error.

00:09:30.733 --> 00:09:32.573
So we'll say stage deploy

00:09:33.621 --> 00:09:36.101
and we got an error that it could not resolve the

00:09:36.101 --> 00:09:36.421
service,

00:09:37.621 --> 00:09:39.381
backend service binding.

00:09:39.781 --> 00:09:42.901
Now what I suspect is happening here is the

00:09:42.901 --> 00:09:46.181
service has actually changed the name so we can

00:09:46.181 --> 00:09:49.581
come into our Wrangler JSON C and then just make

00:09:49.581 --> 00:09:52.501
sure that this binding service name is also

00:09:52.901 --> 00:09:53.821
saying Stage,

00:09:53.821 --> 00:09:55.781
because that's the new service name that we have.

00:09:55.861 --> 00:09:58.021
So we'll try to deploy that one more time,

00:09:58.021 --> 00:09:59.940
and I do suspect this one will succeed.

00:09:59.940 --> 00:10:02.320
So that deployment did successfully succeed.

00:10:02.560 --> 00:10:04.240
And what you're going to notice is the

00:10:04.560 --> 00:10:06.880
domain name is actually slightly different because

00:10:06.880 --> 00:10:08.400
it has Stage appended on it.

00:10:08.560 --> 00:10:10.520
I'm just going to head over to our cloudflare

00:10:10.520 --> 00:10:12.240
environment and I'm going to go ahead and update

00:10:12.240 --> 00:10:12.560
that.

00:10:12.640 --> 00:10:14.320
So we now have

00:10:14.720 --> 00:10:16.080
Stage at the end of it.

00:10:16.080 --> 00:10:16.480
So

00:10:16.880 --> 00:10:17.920
we can go like this.

00:10:18.400 --> 00:10:19.949
And I'm going to deploy one more time.

00:10:19.949 --> 00:10:22.884
And then now what we should notice is we have a

00:10:23.524 --> 00:10:25.604
new version of that application up and running

00:10:25.964 --> 00:10:27.128
and we're able to hit it.

00:10:27.848 --> 00:10:29.128
We can go to the App

00:10:30.934 --> 00:10:32.728
and it looks like everything is working as

00:10:32.728 --> 00:10:33.048
expected.

00:10:33.288 --> 00:10:33.568
So,

00:10:33.568 --> 00:10:33.808
yeah,

00:10:33.808 --> 00:10:36.208
we successfully were able to kind of migrate this

00:10:36.208 --> 00:10:37.368
over to a Stage environment.

00:10:38.088 --> 00:10:39.208
Now in the next video,

00:10:39.208 --> 00:10:40.128
we're going to do the same thing,

00:10:40.128 --> 00:10:41.468
but we're going to do it for production

00:10:41.468 --> 00:10:41.748
environment.

00:10:41.828 --> 00:10:43.908
So we're also going to create a few new resources.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.114 --> 00:00:00.234
Now,

00:00:00.234 --> 00:00:01.954
for the production version of this application,

00:00:01.954 --> 00:00:04.754
I'm going to go ahead and open both wrangler files

00:00:04.754 --> 00:00:06.834
for the data service and the,

00:00:07.033 --> 00:00:07.739
and the

00:00:08.109 --> 00:00:09.229
user application.

00:00:09.389 --> 00:00:11.629
So what we can do is I'm just going to go ahead

00:00:11.629 --> 00:00:11.949
and

00:00:12.269 --> 00:00:13.709
copy the entire stage,

00:00:14.109 --> 00:00:14.959
paste it in,

00:00:14.959 --> 00:00:17.057
and then just simply rename it to

00:00:18.337 --> 00:00:18.977
production.

00:00:19.222 --> 00:00:21.382
And then we'll just work on the data service first

00:00:21.382 --> 00:00:22.662
because there's a lot more to it.

00:00:23.062 --> 00:00:25.302
Now we're just going to kind of run down and then

00:00:25.302 --> 00:00:27.462
whenever we come across something that needs a

00:00:27.542 --> 00:00:29.102
mirrored production resource,

00:00:29.102 --> 00:00:29.662
we'll do that.

00:00:29.662 --> 00:00:31.702
So the first thing is going to be our two buckets.

00:00:32.022 --> 00:00:33.222
We'll change this to

00:00:33.551 --> 00:00:34.991
production

00:00:35.488 --> 00:00:37.619
and then we can head over to Cloudflare

00:00:38.927 --> 00:00:39.014
and,

00:00:39.084 --> 00:00:41.164
and we can go to R2 and go ahead and create that

00:00:41.164 --> 00:00:41.523
guy.

00:00:41.523 --> 00:00:42.592
So create a bucket.

00:00:43.244 --> 00:00:43.908
Production.

00:00:44.468 --> 00:00:45.428
Create bucket.

00:00:45.674 --> 00:00:47.633
Now we can come down to our database and

00:00:47.633 --> 00:00:49.633
essentially we're going to want to create a

00:00:49.633 --> 00:00:52.513
production version of our database so we can come

00:00:52.513 --> 00:00:54.273
into the production version of our database.

00:00:54.439 --> 00:00:55.796
Just copy that name for now,

00:00:56.046 --> 00:00:56.470
type it out.

00:00:57.020 --> 00:00:58.900
We'll just go ahead and call this Smart Links

00:00:58.900 --> 00:00:59.500
Production.

00:00:59.900 --> 00:01:00.860
Go ahead and create.

00:01:01.133 --> 00:01:02.153
We can copy that id,

00:01:02.553 --> 00:01:03.673
head back over here,

00:01:03.753 --> 00:01:06.713
replace the production ID with our actual id

00:01:07.273 --> 00:01:09.913
and we're not going to be developing production in

00:01:09.913 --> 00:01:11.073
production locally.

00:01:11.073 --> 00:01:12.993
So I'm just going to remove the remote bindings

00:01:12.993 --> 00:01:13.433
feature,

00:01:13.633 --> 00:01:14.093
from these.

00:01:15.143 --> 00:01:17.983
We're similarly going to go create a key value

00:01:17.983 --> 00:01:19.783
pair so we can come up to KV

00:01:20.183 --> 00:01:22.583
Smart Links cache stage.

00:01:23.303 --> 00:01:24.183
So we'll say

00:01:24.983 --> 00:01:26.103
Smart Links

00:01:26.423 --> 00:01:27.143
cache

00:01:27.615 --> 00:01:28.895
and we'll call this also

00:01:30.415 --> 00:01:31.112
Production.

00:01:31.516 --> 00:01:33.663
And that's going to spit out an ID for us that we

00:01:33.663 --> 00:01:35.463
can copy and we can replace into here.

00:01:37.360 --> 00:01:38.880
we're going to have to do the same for our

00:01:39.231 --> 00:01:39.791
queue,

00:01:40.711 --> 00:01:41.531
for our queues.

00:01:41.851 --> 00:01:42.731
So we have

00:01:43.451 --> 00:01:46.491
smart links data queue and we have a dead letter

00:01:46.491 --> 00:01:46.891
queue.

00:01:46.891 --> 00:01:48.731
So we can head over to our queues

00:01:48.932 --> 00:01:50.772
and we can create a

00:01:51.854 --> 00:01:53.134
queue production.

00:01:55.210 --> 00:01:56.290
While this is creating,

00:01:56.290 --> 00:01:57.610
I'm just going to go ahead and

00:01:58.250 --> 00:01:59.130
replace that,

00:01:59.610 --> 00:02:00.890
replace that one.

00:02:03.357 --> 00:02:03.880
And then

00:02:04.280 --> 00:02:06.040
we can replace this right here.

00:02:06.269 --> 00:02:09.697
and then we also have a smart links dead letter

00:02:09.697 --> 00:02:10.529
queue as well.

00:02:10.689 --> 00:02:12.314
So we can create the dead letter

00:02:14.033 --> 00:02:16.566
and our dead letter Q for production.

00:02:16.566 --> 00:02:18.606
We're going to want to mirror it and we can just

00:02:18.606 --> 00:02:20.566
go ahead and we can turn off our,

00:02:20.812 --> 00:02:21.400
consumption.

00:02:21.400 --> 00:02:22.646
So it should be under messages.

00:02:22.646 --> 00:02:23.046
Actually,

00:02:23.446 --> 00:02:25.126
status is going to be paused

00:02:26.086 --> 00:02:27.606
so we can come back into here,

00:02:27.846 --> 00:02:30.366
make sure that where we're using dead letter queue

00:02:30.366 --> 00:02:31.126
for production

00:02:31.606 --> 00:02:32.886
is just going to be called

00:02:33.365 --> 00:02:34.406
production as well.

00:02:35.875 --> 00:02:38.275
And then let's go take a look at our

00:02:38.595 --> 00:02:39.315
workflow.

00:02:39.315 --> 00:02:41.635
So from the durable objects and workflows

00:02:41.635 --> 00:02:42.195
perspective,

00:02:42.755 --> 00:02:44.995
it actually is going to be a little bit easier,

00:02:44.995 --> 00:02:45.475
I think.

00:02:45.635 --> 00:02:46.035
So.

00:02:46.825 --> 00:02:49.225
I do suspect when we deploy this,

00:02:49.765 --> 00:02:52.005
when we deploy this data service project,

00:02:52.565 --> 00:02:55.765
those workflows should actually get a new name,

00:02:55.845 --> 00:02:56.645
I would suspect.

00:02:56.645 --> 00:02:58.822
So let's go ahead and look at our stage workflows.

00:02:58.822 --> 00:02:59.084
Yeah,

00:02:59.084 --> 00:03:01.204
so we actually might want to just come into here

00:03:01.444 --> 00:03:03.684
and give our workflow

00:03:04.283 --> 00:03:04.523
name.

00:03:04.603 --> 00:03:05.803
We'll call this also

00:03:07.403 --> 00:03:08.105
Production.

00:03:08.105 --> 00:03:09.988
Now that should be good

00:03:10.308 --> 00:03:10.948
from the

00:03:11.268 --> 00:03:12.868
production pipeline perspective.

00:03:13.188 --> 00:03:15.588
we're going to do one manual deploy to production

00:03:15.588 --> 00:03:17.227
just to make sure everything's working as

00:03:17.227 --> 00:03:17.508
expected.

00:03:17.828 --> 00:03:19.988
So I'm going to go ahead and add

00:03:21.328 --> 00:03:22.848
a production deploy here

00:03:28.600 --> 00:03:30.760
and we'll just call this production

00:03:34.280 --> 00:03:36.360
CD into our apps

00:03:36.760 --> 00:03:38.840
data service PMPM run.

00:03:43.953 --> 00:03:45.633
So that deployment went through as expected.

00:03:46.193 --> 00:03:49.633
Let's also head over to our wrangler JSON C for

00:03:49.873 --> 00:03:50.273
our

00:03:51.263 --> 00:03:52.303
user application.

00:03:52.703 --> 00:03:54.303
This one's going to be a little bit lighter

00:03:54.303 --> 00:03:54.703
weight,

00:03:54.943 --> 00:03:57.423
so I'm just going to go ahead and copy this guy

00:03:57.503 --> 00:03:57.903
again.

00:03:59.263 --> 00:04:00.383
Instead of stage,

00:04:00.383 --> 00:04:01.423
we will call this

00:04:04.623 --> 00:04:05.299
production

00:04:05.734 --> 00:04:05.974
our

00:04:06.454 --> 00:04:07.254
database.

00:04:07.414 --> 00:04:11.094
We can actually grab that D1 database ID from our

00:04:11.094 --> 00:04:12.134
production side.

00:04:12.294 --> 00:04:12.694
So

00:04:14.004 --> 00:04:16.004
we got this good right here.

00:04:16.478 --> 00:04:18.094
We can go ahead and put that into here.

00:04:18.894 --> 00:04:21.534
And then we're also going to want to change our

00:04:21.694 --> 00:04:22.898
production flag here.

00:04:26.854 --> 00:04:28.454
Going to CD into user application.

00:04:32.277 --> 00:04:32.997
Okay,

00:04:33.077 --> 00:04:35.397
so to get this to also work into production,

00:04:35.397 --> 00:04:37.477
let's take a look at

00:04:37.637 --> 00:04:38.517
the package JSON.

00:04:38.517 --> 00:04:39.917
A few different things we're going to have to do

00:04:39.917 --> 00:04:40.157
here.

00:04:40.157 --> 00:04:41.957
What we are first going to want to do is we're

00:04:41.957 --> 00:04:43.637
going to want to specify a build script

00:04:44.197 --> 00:04:45.477
specifically for

00:04:46.417 --> 00:04:47.917
specifically for production.

00:04:48.207 --> 00:04:49.567
And what's going to happen is we're going to say

00:04:49.567 --> 00:04:51.367
vite build and we're going to pass in a mode

00:04:51.367 --> 00:04:51.967
production.

00:04:51.967 --> 00:04:53.007
Now because we're using vite,

00:04:53.007 --> 00:04:54.527
it's going to be slightly different than the other

00:04:54.527 --> 00:04:54.847
environment,

00:04:54.927 --> 00:04:57.207
which is kind of why I wanted to have this project

00:04:57.207 --> 00:05:00.127
set up to use both vite and a normal wrangler

00:05:00.127 --> 00:05:00.847
configuration.

00:05:01.957 --> 00:05:02.317
yeah,

00:05:02.317 --> 00:05:03.837
so we have this build script which builds with

00:05:03.837 --> 00:05:04.517
mode production.

00:05:04.517 --> 00:05:05.557
Then it runs ts.

00:05:05.637 --> 00:05:07.757
Now what we're going to do is we're also going to

00:05:07.757 --> 00:05:08.117
say

00:05:09.487 --> 00:05:12.647
we're going to basically say deploy Production.

00:05:12.647 --> 00:05:13.087
Deploy

00:05:14.197 --> 00:05:15.157
is going to run

00:05:16.597 --> 00:05:19.637
production colon build and then call wrangler

00:05:19.637 --> 00:05:20.197
deploy.

00:05:20.437 --> 00:05:21.797
Now that's one of the things.

00:05:21.797 --> 00:05:22.837
Another thing that I noticed,

00:05:22.837 --> 00:05:24.117
if you're following along typing,

00:05:24.117 --> 00:05:26.117
I actually had a typo here in this environment.

00:05:26.357 --> 00:05:27.397
So just make sure that

00:05:27.717 --> 00:05:30.037
this is spelled production correctly.

00:05:30.597 --> 00:05:30.997
And

00:05:31.817 --> 00:05:34.177
the last thing we have to do is basically we have

00:05:34.177 --> 00:05:35.177
to take our

00:05:36.457 --> 00:05:38.457
EMV file and create a new one called

00:05:39.037 --> 00:05:40.477
EMV dot production

00:05:40.797 --> 00:05:43.277
and then we can pass in our cloudflare EMV

00:05:43.437 --> 00:05:46.717
production here and then also we can have our

00:05:46.797 --> 00:05:48.077
production host

00:05:48.477 --> 00:05:49.117
as well.

00:05:49.117 --> 00:05:51.757
So from here if we say pnpm run,

00:05:53.067 --> 00:05:53.787
production

00:05:54.187 --> 00:05:54.906
deploy.

00:05:55.467 --> 00:05:56.780
Just going to deploy this one time

00:05:57.182 --> 00:05:58.062
now that went through.

00:05:58.142 --> 00:06:00.382
We can go ahead and open this guy up,

00:06:00.622 --> 00:06:01.342
take a look,

00:06:01.422 --> 00:06:03.022
make sure everything's working as expected.

00:06:03.182 --> 00:06:04.382
So this deployed,

00:06:05.022 --> 00:06:05.102
we

00:06:05.162 --> 00:06:06.242
can head over to app.

00:06:06.502 --> 00:06:08.642
looks like something actually went wrong here.

00:06:08.642 --> 00:06:09.602
Let's take a look.

00:06:09.682 --> 00:06:10.202
Oh yes,

00:06:10.202 --> 00:06:11.922
this is actually something I did want to get to.

00:06:11.922 --> 00:06:12.322
So

00:06:12.642 --> 00:06:14.282
we created our D1 database,

00:06:14.282 --> 00:06:15.122
a brand new one,

00:06:15.122 --> 00:06:16.482
but we don't have any tables yet.

00:06:16.562 --> 00:06:18.642
So no doubt this doesn't work.

00:06:19.322 --> 00:06:21.282
So what we want to do is we're basically going to

00:06:21.282 --> 00:06:23.362
want to recreate those exact same tables that we

00:06:23.362 --> 00:06:23.642
have.

00:06:24.202 --> 00:06:24.602
And

00:06:25.422 --> 00:06:26.622
I know we have,

00:06:26.622 --> 00:06:27.302
we have the

00:06:27.302 --> 00:06:28.896
SQL statements in our code like

00:06:28.896 --> 00:06:31.109
up further when we actually created that where we

00:06:31.109 --> 00:06:31.949
created the tables.

00:06:31.949 --> 00:06:32.309
But

00:06:32.629 --> 00:06:34.309
I want to show you something that's pretty cool

00:06:34.309 --> 00:06:35.349
that you can do with Drizzle.

00:06:35.349 --> 00:06:36.949
So let's head over to

00:06:39.429 --> 00:06:40.549
our packages,

00:06:40.629 --> 00:06:43.269
application or packages and then headed to Data

00:06:43.269 --> 00:06:43.829
Ops.

00:06:45.329 --> 00:06:46.929
Now inside of Data Ops,

00:06:46.938 --> 00:06:50.405
inside of Data Ops we have a Drizzle configuration

00:06:50.405 --> 00:06:52.725
that is configured for our D1 database.

00:06:53.125 --> 00:06:55.605
Now we also have a

00:06:57.080 --> 00:06:58.964
we also have our Drizzle out

00:06:59.364 --> 00:07:01.204
which has these SQL statements.

00:07:01.604 --> 00:07:03.564
Now what I'm going to do is I'm just going to go

00:07:03.564 --> 00:07:04.084
ahead and

00:07:04.404 --> 00:07:05.044
delete.

00:07:05.243 --> 00:07:06.923
I think we can go ahead and delete this entire

00:07:06.923 --> 00:07:07.243
thing

00:07:08.330 --> 00:07:09.770
and then we're just going to do this one more time

00:07:09.770 --> 00:07:11.290
again saying pnpm run

00:07:11.610 --> 00:07:12.170
poll

00:07:12.570 --> 00:07:14.970
and that's going to call our pull Drizzle poll

00:07:14.970 --> 00:07:15.370
script

00:07:15.690 --> 00:07:17.010
and then it's going to output this.

00:07:17.010 --> 00:07:19.370
So it's going to give us a fresh copy of our

00:07:19.770 --> 00:07:22.570
SQL DDL so our create statements and whatnot.

00:07:22.570 --> 00:07:22.890
So

00:07:23.210 --> 00:07:23.810
we can.

00:07:23.810 --> 00:07:24.130
Oh,

00:07:24.130 --> 00:07:25.450
I'm in the wrong application here.

00:07:25.450 --> 00:07:27.370
So we can head back over to Drizzle out,

00:07:28.060 --> 00:07:29.420
take a look at what we have here.

00:07:29.900 --> 00:07:31.226
So we have these queries.

00:07:31.434 --> 00:07:32.862
So let's copy these guys over

00:07:33.323 --> 00:07:35.902
and let's hope that this format works for us.

00:07:35.902 --> 00:07:37.462
But we can go over to our

00:07:38.162 --> 00:07:38.801
worker.

00:07:39.222 --> 00:07:39.402
no,

00:07:39.402 --> 00:07:41.002
I'll go over to Storage and databases,

00:07:41.242 --> 00:07:42.202
head to our

00:07:42.682 --> 00:07:43.802
production instance.

00:07:43.944 --> 00:07:44.174
No,

00:07:44.254 --> 00:07:45.094
wrong guy here.

00:07:45.094 --> 00:07:46.414
I went to KV SQL

00:07:46.734 --> 00:07:48.444
head over to our Smart Links production.

00:07:48.444 --> 00:07:50.258
We can go ahead and explore data.

00:07:50.418 --> 00:07:52.498
We'll paste these guys in there and hit run.

00:07:52.560 --> 00:07:55.040
Looks like it's having a hard time creating this

00:07:55.280 --> 00:07:55.920
index.

00:07:56.143 --> 00:07:56.407
Oh,

00:07:56.407 --> 00:07:58.207
I think I know exactly what's happening here.

00:07:58.207 --> 00:08:00.927
So we are just going to want to start one by one.

00:08:01.087 --> 00:08:02.367
So let's run this guy,

00:08:03.043 --> 00:08:04.120
let's run this guy.

00:08:04.614 --> 00:08:05.414
Run this guy.

00:08:05.478 --> 00:08:06.346
And then finally,

00:08:06.346 --> 00:08:07.626
let's run this last one.

00:08:08.666 --> 00:08:09.266
Got it.

00:08:09.266 --> 00:08:09.706
Okay,

00:08:09.706 --> 00:08:10.866
so now our tables are working.

00:08:10.866 --> 00:08:12.906
Let's head back over to our production ui,

00:08:13.466 --> 00:08:14.226
reload this.

00:08:14.226 --> 00:08:16.586
And everything is working as expected once again,

00:08:16.586 --> 00:08:17.546
which is awesome.

00:08:17.626 --> 00:08:18.026
So,

00:08:18.266 --> 00:08:18.786
yep.

00:08:18.786 --> 00:08:20.666
So our websockets are connected.

00:08:20.906 --> 00:08:23.146
We're able to successfully pull data.

00:08:23.526 --> 00:08:25.206
and this is still dummy data.

00:08:25.206 --> 00:08:26.006
Towards the end of the course,

00:08:26.006 --> 00:08:27.366
we'll actually fill out the rest of this.

00:08:27.366 --> 00:08:27.686
But

00:08:28.086 --> 00:08:30.526
now we have successfully created a production

00:08:30.526 --> 00:08:30.806
environment

00:08:31.346 --> 00:08:33.706
and a stage environment so we can develop on stage

00:08:33.706 --> 00:08:35.506
and then we can deploy to production.

00:08:36.326 --> 00:08:38.126
what we're going to do is we're going to set up

00:08:38.126 --> 00:08:38.486
our,

00:08:38.686 --> 00:08:40.086
CI CD pipelines.

00:08:40.406 --> 00:08:43.326
So we're going to set up our automated builds that

00:08:43.326 --> 00:08:44.406
are going to be triggered from,

00:08:44.486 --> 00:08:45.466
GitHub pushes.

00:08:45.546 --> 00:08:46.686
So let's go ahead and do that.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.076 --> 00:00:00.436
All right,

00:00:00.436 --> 00:00:02.636
so now to create automated deploys,

00:00:02.716 --> 00:00:05.756
let's go ahead and start with our user application

00:00:05.756 --> 00:00:06.316
stage.

00:00:06.380 --> 00:00:09.246
We can head over to Settings and there's a section

00:00:09.246 --> 00:00:09.846
called Build,

00:00:09.846 --> 00:00:11.248
which is currently in beta.

00:00:11.613 --> 00:00:13.253
You're going to want to go ahead and connect your

00:00:13.253 --> 00:00:13.967
GitHub repo.

00:00:14.366 --> 00:00:16.486
So this is going to give you an overview as to

00:00:16.486 --> 00:00:19.246
what Cloudflare is able to do and has access to.

00:00:19.406 --> 00:00:19.806
Now,

00:00:20.786 --> 00:00:21.986
there's two things you can do.

00:00:21.986 --> 00:00:23.906
You can give it access to all repositories,

00:00:23.906 --> 00:00:26.786
or you can do it just select repositories.

00:00:26.866 --> 00:00:27.266
So

00:00:27.666 --> 00:00:30.426
for this purpose I'm just going to go ahead and

00:00:30.426 --> 00:00:32.226
say specifically the

00:00:32.536 --> 00:00:34.256
repository that we are working in,

00:00:34.256 --> 00:00:36.216
which is called Full Stack on Cloudflare.

00:00:38.102 --> 00:00:39.736
From here we can go ahead and save.

00:00:39.842 --> 00:00:40.473
All right,

00:00:40.633 --> 00:00:42.473
now what we're going to do is we're going to allow

00:00:42.473 --> 00:00:43.803
it to act on our behalf

00:00:43.803 --> 00:00:45.154
and then you're going to be taken to this

00:00:45.154 --> 00:00:46.852
configuration on this side right here.

00:00:46.852 --> 00:00:48.278
So there's a few different things that we care

00:00:48.278 --> 00:00:48.918
about here.

00:00:48.918 --> 00:00:50.878
And because we're working in a mono repo,

00:00:50.878 --> 00:00:52.878
this configuration is going to be a little bit

00:00:52.878 --> 00:00:54.838
different from what you are seeing in the

00:00:54.838 --> 00:00:56.118
Cloudflare documentation.

00:00:56.278 --> 00:00:56.678
So,

00:00:56.968 --> 00:00:59.098
basically what it's asking is it wants us to look

00:00:59.098 --> 00:01:00.338
for a specific branch

00:01:00.818 --> 00:01:03.058
and then it also wants us to

00:01:03.548 --> 00:01:04.598
provide a build command,

00:01:04.598 --> 00:01:06.038
which it does this by default,

00:01:06.038 --> 00:01:07.908
but we're actually going to end up changing that

00:01:08.058 --> 00:01:08.134
that.

00:01:08.227 --> 00:01:08.627
Now,

00:01:08.677 --> 00:01:11.147
this type of git configuration doesn't give us

00:01:11.147 --> 00:01:13.027
like a ton of flexibility,

00:01:13.187 --> 00:01:14.627
but it does give us enough.

00:01:15.347 --> 00:01:15.747
So,

00:01:16.307 --> 00:01:17.587
it's going to work for this use case.

00:01:17.587 --> 00:01:18.867
But just know if you want to get,

00:01:18.867 --> 00:01:20.426
do something like incredibly custom,

00:01:20.426 --> 00:01:21.307
you could always create GitHub,

00:01:21.367 --> 00:01:23.287
actions and you could pass in cloud flares,

00:01:23.287 --> 00:01:25.887
API keys to authenticate and do builds that way.

00:01:25.887 --> 00:01:27.687
But what we're going to do is I'm actually just

00:01:27.687 --> 00:01:28.527
going to cancel this

00:01:29.197 --> 00:01:31.844
and I want to head back over to our code base

00:01:31.844 --> 00:01:33.862
and what we're going to do is we're actually going

00:01:33.862 --> 00:01:35.302
to CD back to the root

00:01:39.782 --> 00:01:42.102
and then I'm going to create a branch that.

00:01:42.422 --> 00:01:43.662
So if you look at this,

00:01:43.662 --> 00:01:44.262
we have

00:01:46.757 --> 00:01:47.397
to get

00:01:48.277 --> 00:01:48.917
branch.

00:01:49.477 --> 00:01:50.677
So we currently have

00:01:51.497 --> 00:01:53.657
I'm going to go ahead and create a branch called

00:01:54.387 --> 00:01:54.587
dev.

00:01:54.587 --> 00:01:55.427
So I'm going to say

00:01:55.987 --> 00:02:00.027
git checkout dash B which creates the branch and

00:02:00.027 --> 00:02:00.867
we're going to call this,

00:02:01.427 --> 00:02:03.147
actually we'll call this stage to keep things

00:02:03.147 --> 00:02:03.827
consistent.

00:02:04.147 --> 00:02:05.827
So now we are devving on stage.

00:02:05.907 --> 00:02:08.227
So essentially what we can do is we can have,

00:02:08.307 --> 00:02:11.187
we can say whenever we merge into a branch called

00:02:11.187 --> 00:02:11.667
Stage.

00:02:11.987 --> 00:02:13.907
It's going to trigger that stage build and then

00:02:13.907 --> 00:02:16.227
when we merge those changes from Stage into our

00:02:16.227 --> 00:02:18.307
main branch and that's going to do the production

00:02:18.307 --> 00:02:18.627
build.

00:02:18.707 --> 00:02:21.587
So we can head back over to our cloudflare,

00:02:21.837 --> 00:02:22.077
project.

00:02:22.717 --> 00:02:24.517
I'm just going to make sure we're in the right

00:02:24.517 --> 00:02:24.757
thing.

00:02:24.757 --> 00:02:27.117
User application stage is what I'm going to care

00:02:27.117 --> 00:02:27.357
about.

00:02:27.357 --> 00:02:28.877
First we'll head over to Settings.

00:02:29.567 --> 00:02:30.517
we can say

00:02:31.557 --> 00:02:32.357
builds

00:02:32.392 --> 00:02:32.956
Connect.

00:02:33.021 --> 00:02:34.541
We're going to look at this

00:02:34.861 --> 00:02:35.741
repository.

00:02:36.301 --> 00:02:37.501
We are going to

00:02:37.821 --> 00:02:39.942
see if it can't pull in the new ones.

00:02:39.942 --> 00:02:41.310
I might have to push some changes.

00:02:41.310 --> 00:02:42.870
I'm just going to go to a readme

00:02:44.460 --> 00:02:45.580
and I'm going to add some

00:02:45.980 --> 00:02:46.620
stuff here.

00:03:04.125 --> 00:03:04.525
All right,

00:03:04.525 --> 00:03:07.165
so now we have our stage branch pop up right here.

00:03:07.325 --> 00:03:09.725
So I'm going to go ahead and select Stage branch.

00:03:09.725 --> 00:03:12.525
And then what we can do is we can look at our,

00:03:13.175 --> 00:03:14.215
we can look at our

00:03:14.565 --> 00:03:17.765
package JSON at the very root of our application.

00:03:17.776 --> 00:03:19.553
And you're going to notice that I have a few

00:03:19.553 --> 00:03:20.953
things already defined here,

00:03:20.973 --> 00:03:23.433
that we went over at the beginning of the course.

00:03:23.673 --> 00:03:25.712
Now these things are going to change slightly.

00:03:25.712 --> 00:03:27.593
So what we're going to want to do is we're going

00:03:27.593 --> 00:03:28.233
to want to say,

00:03:29.043 --> 00:03:29.603
stage

00:03:30.083 --> 00:03:31.083
build package.

00:03:31.083 --> 00:03:31.443
Actually,

00:03:31.523 --> 00:03:32.603
we don't need to do that.

00:03:32.603 --> 00:03:33.923
That can just be build package.

00:03:33.923 --> 00:03:36.603
Now we're going to add a few additional scripts.

00:03:36.603 --> 00:03:39.683
We're going to first add a script to build our

00:03:39.683 --> 00:03:40.483
user applic

00:03:41.023 --> 00:03:41.983
for the stage.

00:03:41.998 --> 00:03:45.502
So we will be adding a stage dot deploy or stage

00:03:45.502 --> 00:03:47.502
colon deploy front end.

00:03:47.502 --> 00:03:49.182
And what that's going to do is it's going to say

00:03:49.342 --> 00:03:51.022
pnpm run build package,

00:03:51.022 --> 00:03:52.342
which runs this command.

00:03:52.342 --> 00:03:54.142
So it builds our data ops,

00:03:54.302 --> 00:03:56.222
our queries and whatnot.

00:03:56.222 --> 00:03:59.342
And then we say and PNPM filter find the user

00:03:59.342 --> 00:03:59.862
application.

00:03:59.862 --> 00:04:00.862
And then it's going to run

00:04:01.342 --> 00:04:02.702
stage deploy.

00:04:03.102 --> 00:04:04.702
So I'm going to go ahead.

00:04:04.782 --> 00:04:05.982
So right now we are on

00:04:06.302 --> 00:04:07.342
our dev branch,

00:04:07.742 --> 00:04:08.302
which is good.

00:04:08.382 --> 00:04:10.702
So I'm going to go ahead and add these changes.

00:04:20.455 --> 00:04:21.815
I'm going to go ahead and push them.

00:04:27.082 --> 00:04:27.722
Okay,

00:04:27.802 --> 00:04:28.202
so

00:04:28.682 --> 00:04:30.242
now that that is done,

00:04:30.242 --> 00:04:31.682
these changes are pushed.

00:04:31.682 --> 00:04:32.322
I'm going to hit.

00:04:32.322 --> 00:04:34.014
I'm going to grab this command right here

00:04:34.150 --> 00:04:36.910
and then it's going to give us the option to

00:04:36.910 --> 00:04:37.910
provide a,

00:04:38.320 --> 00:04:38.510
to

00:04:38.990 --> 00:04:39.870
provide a

00:04:39.962 --> 00:04:41.022
deploy command.

00:04:41.022 --> 00:04:42.832
So we should be able to say

00:04:43.722 --> 00:04:45.242
pmpm run

00:04:46.042 --> 00:04:47.882
stage front end deploy.

00:04:48.042 --> 00:04:48.336
So

00:04:48.602 --> 00:04:49.322
let's just.

00:04:50.711 --> 00:04:51.111
All right,

00:04:51.111 --> 00:04:52.951
so let's just make sure everything here is good.

00:04:53.104 --> 00:04:55.254
I hope PNPM actually works with this.

00:04:55.494 --> 00:04:57.174
Now make sure we have all here.

00:04:57.174 --> 00:04:58.171
Let's go ahead and connect.

00:04:58.171 --> 00:04:58.588
All right,

00:04:58.588 --> 00:05:01.068
so now we have this build so we can head over to

00:05:01.068 --> 00:05:03.108
deployments and head back to our code base.

00:05:03.458 --> 00:05:05.178
I'm just going to go modify the readme a little

00:05:05.178 --> 00:05:06.738
bit again and I'm going to

00:05:07.058 --> 00:05:07.698
say git,

00:05:07.698 --> 00:05:08.018
add,

00:05:08.098 --> 00:05:08.578
git

00:05:08.978 --> 00:05:09.618
commit

00:05:10.338 --> 00:05:10.738
change,

00:05:13.138 --> 00:05:13.858
read me,

00:05:14.658 --> 00:05:15.058
get

00:05:16.578 --> 00:05:17.058
push

00:05:18.418 --> 00:05:19.218
origin

00:05:19.938 --> 00:05:20.498
stage.

00:05:21.298 --> 00:05:22.498
So that gets pushed.

00:05:22.578 --> 00:05:24.898
Now we should see an attempt

00:05:25.218 --> 00:05:25.618
of

00:05:25.938 --> 00:05:26.058
a,

00:05:26.058 --> 00:05:27.078
deploy come through

00:05:27.478 --> 00:05:28.118
right here.

00:05:28.330 --> 00:05:28.610
All right,

00:05:28.610 --> 00:05:29.170
so look at that.

00:05:29.170 --> 00:05:30.490
A build is in progress.

00:05:30.490 --> 00:05:33.330
So that was automatically picked up when we pushed

00:05:33.330 --> 00:05:34.570
our changes to stage.

00:05:34.572 --> 00:05:36.515
But it does look like we had a fail.

00:05:36.595 --> 00:05:38.038
And why is it failing?

00:05:38.039 --> 00:05:40.639
So it looks like we're failing with an issue

00:05:40.639 --> 00:05:42.119
saying there's no node modules.

00:05:42.269 --> 00:05:44.349
so I do think we need to add the installation

00:05:44.349 --> 00:05:44.869
script.

00:05:44.869 --> 00:05:47.189
So I'm just going to go ahead and play around with

00:05:47.189 --> 00:05:48.949
this just to make sure everything's going to work

00:05:48.949 --> 00:05:49.389
as expected.

00:05:50.189 --> 00:05:52.669
So we should be able to say PNPM I

00:05:53.849 --> 00:05:56.289
which is going to install and then P and then pnpm

00:05:56.289 --> 00:05:58.849
run build and then PNPM filter.

00:05:58.849 --> 00:06:00.169
So that should be able to install everything

00:06:00.169 --> 00:06:01.329
inside of the mono repo.

00:06:01.329 --> 00:06:01.849
Let's just.

00:06:02.249 --> 00:06:04.089
I hope this works.

00:06:04.239 --> 00:06:06.479
a lot of times when you're doing these types of

00:06:06.479 --> 00:06:07.119
DevOps stuff,

00:06:07.119 --> 00:06:08.199
setups for the first time,

00:06:08.199 --> 00:06:09.879
you're going to want to like kind of iterate and

00:06:09.879 --> 00:06:10.559
play around with it.

00:06:10.559 --> 00:06:12.559
But I am glad we're able to see some failures.

00:06:12.559 --> 00:06:13.559
So you know,

00:06:13.559 --> 00:06:15.359
we can illustrate how to debug this.

00:06:15.439 --> 00:06:17.099
I do think that that's actually pretty useful.

00:06:17.739 --> 00:06:19.339
So let's go ahead and push that to stage

00:06:20.449 --> 00:06:20.689
and

00:06:21.169 --> 00:06:23.569
we should see another build over here

00:06:23.648 --> 00:06:24.410
get picked up.

00:06:24.676 --> 00:06:25.956
We can view this build.

00:06:26.163 --> 00:06:27.453
So it's going through cloning,

00:06:27.453 --> 00:06:28.333
repository,

00:06:29.047 --> 00:06:29.921
installing

00:06:30.321 --> 00:06:31.921
tools and dependencies.

00:06:32.081 --> 00:06:35.281
It's going through cloudflare's global Edge

00:06:35.281 --> 00:06:35.601
network.

00:06:35.798 --> 00:06:36.198
look at that.

00:06:36.198 --> 00:06:37.838
We're installing our dependencies.

00:06:38.284 --> 00:06:40.204
The node modules are resolving

00:06:40.863 --> 00:06:40.883
and

00:06:41.063 --> 00:06:42.823
we did get one more error.

00:06:42.823 --> 00:06:44.943
This error looks to be kind of another thing

00:06:44.943 --> 00:06:45.623
that's specific.

00:06:45.623 --> 00:06:46.503
It looks like it says

00:06:47.003 --> 00:06:47.723
typescript.

00:06:48.113 --> 00:06:49.343
TSC is not found.

00:06:49.423 --> 00:06:51.303
So this command that we're actually running,

00:06:51.303 --> 00:06:52.543
it looks like it isn't

00:06:52.913 --> 00:06:53.683
installed

00:06:54.163 --> 00:06:56.083
on their build time dependency.

00:06:56.243 --> 00:06:58.523
I think I have it installed globally which is why

00:06:58.523 --> 00:06:59.683
this is working for me.

00:06:59.683 --> 00:07:02.483
So I'm going to go ahead and add that to

00:07:03.013 --> 00:07:03.983
package JSON.

00:07:03.983 --> 00:07:04.942
So at the root

00:07:04.942 --> 00:07:06.446
we're going to add TSC.

00:07:07.886 --> 00:07:11.726
So we should be able to say PNPM add TypeScript

00:07:11.976 --> 00:07:13.256
with a dev dependency.

00:07:13.256 --> 00:07:15.416
And this is one caveat when working in a

00:07:15.736 --> 00:07:16.376
workspace,

00:07:16.376 --> 00:07:17.368
a PNPM workspace.

00:07:17.368 --> 00:07:20.012
It wants you to specify a flag called

00:07:20.572 --> 00:07:21.732
workspace root,

00:07:21.732 --> 00:07:23.612
just so it knows that like,

00:07:23.692 --> 00:07:26.092
so you know that you're installing a dependency at

00:07:26.092 --> 00:07:27.932
the root and it's actually not inside of these

00:07:27.932 --> 00:07:28.492
modules.

00:07:28.492 --> 00:07:30.212
So let's see if this works.

00:07:30.212 --> 00:07:31.132
I'm going to go ahead and

00:07:31.612 --> 00:07:32.012
add.

00:07:32.252 --> 00:07:33.452
I'm going to go ahead and

00:07:34.081 --> 00:07:34.561
push,

00:07:34.881 --> 00:07:36.881
push these changes one last time

00:07:37.511 --> 00:07:38.641
or hopefully one last time

00:07:38.678 --> 00:07:39.998
and head back over here.

00:07:39.998 --> 00:07:41.078
Let's look at this build.

00:07:41.558 --> 00:07:43.958
A build should be picked up right now.

00:07:44.558 --> 00:07:44.958
And

00:07:45.438 --> 00:07:47.318
I'm just going to go ahead and pause until we get

00:07:47.318 --> 00:07:47.858
to the end of this.

00:07:47.858 --> 00:07:49.460
And it looks like that did the trick.

00:07:49.460 --> 00:07:51.820
So we have successfully built and deployed

00:07:52.140 --> 00:07:54.060
from deploying to our stage,

00:07:54.220 --> 00:07:54.460
branch,

00:07:54.460 --> 00:07:55.300
which is pretty cool.

00:07:55.700 --> 00:07:58.660
So let's go mirror the same thing for our

00:07:59.510 --> 00:08:01.110
for our production version of it.

00:08:01.110 --> 00:08:03.030
Let's also add a production script into here

00:08:06.576 --> 00:08:08.096
and we're going to call this

00:08:09.296 --> 00:08:10.096
production

00:08:10.160 --> 00:08:10.702
deploy.

00:08:10.815 --> 00:08:12.375
it's going to do the similar thing.

00:08:12.375 --> 00:08:13.975
It's just going to run the

00:08:15.680 --> 00:08:16.400
production,

00:08:16.500 --> 00:08:17.100
specific

00:08:17.186 --> 00:08:18.187
deploy command.

00:08:18.427 --> 00:08:18.827
Now

00:08:18.988 --> 00:08:20.288
we can go ahead and copy this guy.

00:08:20.288 --> 00:08:22.627
I'm going to make sure that this is in our code

00:08:22.627 --> 00:08:23.027
base.

00:08:23.027 --> 00:08:23.907
So we can say

00:08:27.747 --> 00:08:28.147
added

00:08:28.707 --> 00:08:29.107
prod

00:08:29.907 --> 00:08:30.307
build

00:08:31.321 --> 00:08:32.796
pnpm run

00:08:34.236 --> 00:08:36.236
push origin stage.

00:08:36.636 --> 00:08:36.996
Sorry,

00:08:36.996 --> 00:08:37.714
not pnpm

00:08:38.352 --> 00:08:38.832
git

00:08:40.422 --> 00:08:41.462
push origin stage.

00:08:42.342 --> 00:08:42.862
Okay,

00:08:42.862 --> 00:08:45.502
let's head back over to our settings in our user

00:08:45.502 --> 00:08:46.022
application

00:08:46.582 --> 00:08:48.902
and then come over to our

00:08:50.306 --> 00:08:51.707
we'll head over to our

00:08:52.107 --> 00:08:54.027
production version of the user application,

00:08:54.027 --> 00:08:54.916
head over to settings,

00:08:55.316 --> 00:08:56.452
we can go to builds

00:08:56.452 --> 00:08:57.475
and we can connect,

00:08:57.625 --> 00:08:59.147
we can connect this application

00:08:59.147 --> 00:09:01.991
and this is going to trigger when we deploy to the

00:09:01.991 --> 00:09:02.751
main branch.

00:09:02.991 --> 00:09:03.391
So

00:09:04.161 --> 00:09:06.001
I'm going to go ahead and add

00:09:06.574 --> 00:09:07.454
PMPM

00:09:09.854 --> 00:09:10.254
run

00:09:10.974 --> 00:09:13.054
production deploy front end.

00:09:13.054 --> 00:09:14.654
So that's going to trigger our production.

00:09:15.134 --> 00:09:17.214
And let's just make sure that this is for.

00:09:17.934 --> 00:09:20.654
This is only going to be for production branches

00:09:20.924 --> 00:09:22.989
and everything else should be the same.

00:09:23.549 --> 00:09:24.749
So we connect this.

00:09:24.944 --> 00:09:27.114
I'm going to go to deployments here and then

00:09:27.994 --> 00:09:29.594
we can open up GitHub.

00:09:29.914 --> 00:09:32.354
I'm going to open up GitHub and go to my own

00:09:32.354 --> 00:09:33.594
personal GitHub account

00:09:35.354 --> 00:09:35.754
and

00:09:36.154 --> 00:09:37.311
come to this repo

00:09:37.598 --> 00:09:40.198
and then we are going to go ahead and compare and

00:09:40.198 --> 00:09:40.638
pull.

00:09:41.118 --> 00:09:43.638
So I'm going to make sure that this gets merged

00:09:43.638 --> 00:09:44.718
into the right

00:09:45.358 --> 00:09:46.158
main branch.

00:09:46.318 --> 00:09:48.638
So this is going to go from stage to main.

00:09:49.528 --> 00:09:50.168
Open this pr

00:09:51.698 --> 00:09:53.218
now we can see that

00:09:53.618 --> 00:09:54.338
we have

00:09:54.758 --> 00:09:55.223
All right,

00:09:55.223 --> 00:09:57.183
so right now the stage one is still building.

00:09:57.263 --> 00:09:58.983
So this is a cool thing that gets injected.

00:09:58.983 --> 00:10:00.723
Basically it's going to wait for this

00:10:00.723 --> 00:10:02.183
this guy to Fully deploy.

00:10:02.423 --> 00:10:04.023
But these are our changes.

00:10:04.023 --> 00:10:05.623
Our changes are going to be a bunch of readme

00:10:05.623 --> 00:10:07.143
stuff and some configuration,

00:10:07.200 --> 00:10:09.760
but I'm just going to go ahead and merge this guy.

00:10:09.840 --> 00:10:11.371
So confirm merge.

00:10:11.704 --> 00:10:13.984
Now when we come to this production version,

00:10:13.984 --> 00:10:15.384
it looks like a new build kicked off.

00:10:15.544 --> 00:10:15.944
So

00:10:16.344 --> 00:10:18.264
this basically what happened is

00:10:18.354 --> 00:10:20.924
we merged our stage branch into our production

00:10:20.924 --> 00:10:21.284
branch

00:10:21.684 --> 00:10:23.444
and we can go ahead and view this build now.

00:10:23.444 --> 00:10:25.124
I suspect that this will work because we kind of

00:10:25.124 --> 00:10:26.564
flushed out all the kinks with

00:10:27.173 --> 00:10:29.459
we fleshed out all the kinks with the

00:10:30.660 --> 00:10:31.922
the staging branch.

00:10:32.082 --> 00:10:33.682
So this should deploy as expected.

00:10:33.886 --> 00:10:36.588
So this production build also was successful.

00:10:37.221 --> 00:10:39.221
Now when this finishes building,

00:10:39.221 --> 00:10:41.101
what you're going to notice is if you actually try

00:10:41.101 --> 00:10:42.181
to use this application,

00:10:42.341 --> 00:10:44.981
you're going to get a error over here.

00:10:45.621 --> 00:10:47.861
And the reason we're going to get an error when we

00:10:47.861 --> 00:10:50.701
navigate over to app is actually because our

00:10:50.701 --> 00:10:52.641
environment variables for build,

00:10:52.881 --> 00:10:55.561
we're not actually set up inside of the build

00:10:55.561 --> 00:10:56.081
itself.

00:10:56.161 --> 00:10:58.481
So when we head over here you're going to notice

00:10:58.481 --> 00:10:59.921
something went wrong with the application.

00:11:00.161 --> 00:11:03.281
Now this is due to the fact that this is a vite

00:11:03.281 --> 00:11:05.841
built built based application and

00:11:06.161 --> 00:11:07.841
what essentially what we're,

00:11:07.841 --> 00:11:09.521
we're having happen here is

00:11:09.681 --> 00:11:11.581
inside of our user application we have these

00:11:11.581 --> 00:11:13.981
environment variables and these environment

00:11:14.061 --> 00:11:17.341
variables are not being pushed to our GitHub repo

00:11:17.341 --> 00:11:18.301
as they shouldn't be.

00:11:18.471 --> 00:11:20.791
but essentially these are being injected into the

00:11:20.791 --> 00:11:23.551
code during build and this is also being used to

00:11:23.551 --> 00:11:24.791
basically instruct the

00:11:25.241 --> 00:11:27.531
Build compiler to know that like it actually needs

00:11:27.531 --> 00:11:29.811
to look at the Cloudflare environments stage.

00:11:29.891 --> 00:11:31.571
So what we're going to do,

00:11:31.651 --> 00:11:33.091
and there's a really easy fix

00:11:33.490 --> 00:11:35.091
is we're going to head over to

00:11:35.491 --> 00:11:36.931
our production application

00:11:37.251 --> 00:11:38.811
and after I do this for production,

00:11:38.811 --> 00:11:40.811
you can also do this on your own time for Stage

00:11:40.811 --> 00:11:42.451
because Stage is going to have the exact same

00:11:42.451 --> 00:11:42.771
issue.

00:11:42.851 --> 00:11:43.741
head over to Settings,

00:11:44.451 --> 00:11:45.731
come over to our,

00:11:46.940 --> 00:11:47.900
over to the

00:11:50.130 --> 00:11:51.140
variables and secrets.

00:11:51.140 --> 00:11:52.860
These are the variables and secrets that are part

00:11:52.860 --> 00:11:53.300
of build.

00:11:53.300 --> 00:11:55.380
These are not the variables and secrets that are

00:11:55.380 --> 00:11:56.980
part of like your worker.

00:11:57.060 --> 00:11:58.580
These are server side

00:11:58.770 --> 00:12:01.440
secrets and variables and these are build time.

00:12:01.440 --> 00:12:03.520
So these are specifically for when the application

00:12:03.520 --> 00:12:04.190
is built.

00:12:04.660 --> 00:12:05.380
so very,

00:12:05.380 --> 00:12:07.220
very very important to know the difference between

00:12:07.220 --> 00:12:07.700
these two.

00:12:08.070 --> 00:12:09.350
You can go ahead and you can add,

00:12:09.990 --> 00:12:11.990
go to your production emv,

00:12:11.990 --> 00:12:14.350
let's just grab our host and then when we add a

00:12:14.350 --> 00:12:15.590
route we'll do the same thing.

00:12:16.420 --> 00:12:17.250
that's going to be the value.

00:12:17.330 --> 00:12:20.290
We'll make sure we grab the correct variable name

00:12:20.610 --> 00:12:22.330
and then we're also going to pass in the

00:12:22.330 --> 00:12:23.090
Cloudflare environment.

00:12:23.660 --> 00:12:25.500
we actually don't need to encrypt that.

00:12:25.740 --> 00:12:27.350
So I'm going to go ahead and save

00:12:27.350 --> 00:12:29.398
and then we will go here again

00:12:29.530 --> 00:12:32.078
and we're going to say Cloudflare EMV is going to

00:12:32.078 --> 00:12:32.750
be production

00:12:33.057 --> 00:12:33.537
save.

00:12:34.177 --> 00:12:35.857
Now I'm going to head back to GitHub.

00:12:36.417 --> 00:12:37.857
I pushed a change

00:12:38.177 --> 00:12:39.457
to this branch,

00:12:39.697 --> 00:12:40.097
so

00:12:40.897 --> 00:12:41.297
should

00:12:43.120 --> 00:12:44.320
we should be able to open another

00:12:44.640 --> 00:12:45.040
pr.

00:12:45.200 --> 00:12:46.520
So pull requests,

00:12:46.520 --> 00:12:47.120
new pr.

00:12:47.407 --> 00:12:48.717
I'm going to say I want

00:12:49.034 --> 00:12:50.234
I want to merge into

00:12:51.034 --> 00:12:53.434
main here and this is going to be coming from

00:12:53.434 --> 00:12:53.834
stage.

00:12:54.018 --> 00:12:55.746
Now I'm just going to go ahead and complete this

00:12:55.746 --> 00:12:56.626
pull request

00:12:56.953 --> 00:12:58.153
and as this merges

00:12:58.473 --> 00:12:59.833
we can come back to

00:13:00.153 --> 00:13:02.353
our production application for our user

00:13:02.353 --> 00:13:02.873
application,

00:13:02.874 --> 00:13:05.328
go to deployments and we're going to see a build

00:13:05.328 --> 00:13:06.488
is currently in progress.

00:13:06.968 --> 00:13:08.648
We can go ahead and view this build.

00:13:08.648 --> 00:13:10.808
I'm going to pause and come to the end of it

00:13:11.128 --> 00:13:11.158
all.

00:13:11.168 --> 00:13:11.368
right,

00:13:11.368 --> 00:13:13.608
so this build and deployment went through

00:13:13.768 --> 00:13:14.568
successfully.

00:13:14.568 --> 00:13:16.688
So we can head back over to our production

00:13:16.688 --> 00:13:18.008
instance of our application

00:13:18.738 --> 00:13:19.698
and this should work.

00:13:19.938 --> 00:13:21.058
Everything's working as expected.

00:13:21.378 --> 00:13:21.778
So,

00:13:22.218 --> 00:13:22.938
just to kind of recap,

00:13:22.938 --> 00:13:24.058
because I know there is a lot,

00:13:24.058 --> 00:13:26.898
but basically what we did is we connected to both

00:13:27.058 --> 00:13:28.418
instances of our application,

00:13:28.418 --> 00:13:29.138
the stage

00:13:29.458 --> 00:13:30.498
and the production.

00:13:31.138 --> 00:13:31.538
We

00:13:32.628 --> 00:13:34.068
we connected our GitHub account

00:13:34.468 --> 00:13:35.748
and then we configured

00:13:36.128 --> 00:13:39.928
a build to basically say we are going to run a

00:13:40.328 --> 00:13:41.368
specific command,

00:13:41.528 --> 00:13:43.248
which is this command right here,

00:13:43.248 --> 00:13:44.568
pnpm run production,

00:13:45.628 --> 00:13:45.948
deploy,

00:13:45.948 --> 00:13:46.379
front end.

00:13:46.405 --> 00:13:49.685
And that is coming from the root of our mono repo

00:13:49.685 --> 00:13:52.045
where we specified a very custom build script that

00:13:52.045 --> 00:13:53.285
basically installs everything.

00:13:53.445 --> 00:13:54.965
It builds our package

00:13:55.365 --> 00:13:57.805
and then it filters user application and runs

00:13:57.805 --> 00:13:58.525
production build.

00:13:58.525 --> 00:14:00.725
And the production build is coming from

00:14:01.125 --> 00:14:03.605
our user application package JSON,

00:14:03.605 --> 00:14:06.565
which is literally just saying we are going to

00:14:06.805 --> 00:14:08.205
build and deploy.

00:14:08.525 --> 00:14:08.925
Now

00:14:09.195 --> 00:14:09.875
I know it was a lot,

00:14:09.875 --> 00:14:11.275
but it's actually not that complicated.

00:14:11.275 --> 00:14:13.235
It's just a lot of configuration and just like

00:14:13.235 --> 00:14:13.795
messing with things,

00:14:13.795 --> 00:14:14.955
making sure everything works.

00:14:14.955 --> 00:14:18.115
So this isn't necessarily important to configure

00:14:18.115 --> 00:14:20.235
for the purpose of this app for this course,

00:14:20.315 --> 00:14:22.395
but as you're building out your own projects,

00:14:22.395 --> 00:14:23.995
when you set things up for the very first time,

00:14:23.995 --> 00:14:25.835
I would suggest just doing this at the very

00:14:25.835 --> 00:14:26.315
beginning,

00:14:26.315 --> 00:14:27.835
then you never have to worry about it again.

00:14:27.975 --> 00:14:29.315
it just kind of like works from there,

00:14:29.315 --> 00:14:31.075
but for the rest of this course we're just going

00:14:31.075 --> 00:14:32.795
to be deploying from the terminal just because

00:14:32.795 --> 00:14:34.115
that's going to be a lot faster for us.

00:14:34.115 --> 00:14:35.475
We don't have to continuously like push our

00:14:35.475 --> 00:14:36.995
changes and merge and whatnot.

00:14:37.015 --> 00:14:37.415
so,

00:14:37.655 --> 00:14:40.095
on your own time I would say go ahead and do the

00:14:40.095 --> 00:14:42.455
same type of configuration for the data service.

00:14:42.455 --> 00:14:44.255
Data service is going to be a very similar thing.

00:14:44.255 --> 00:14:45.255
You're just going to

00:14:45.315 --> 00:14:47.995
We already have our production deploy scripts

00:14:47.995 --> 00:14:49.275
defined here at this level.

00:14:49.435 --> 00:14:51.755
So at the root of our package JSON,

00:14:52.075 --> 00:14:55.475
you'll also basically say stage deploy Data

00:14:55.475 --> 00:14:57.035
service or Stage deploy.

00:14:57.035 --> 00:14:57.315
Yeah,

00:14:57.315 --> 00:14:57.915
Data service.

00:14:57.915 --> 00:14:58.395
And then,

00:14:58.695 --> 00:14:59.915
production deploy Data service.

00:14:59.915 --> 00:15:01.275
And you'll specify your own

00:15:01.825 --> 00:15:02.225
script here,

00:15:02.225 --> 00:15:03.065
which is going to be similar.

00:15:03.065 --> 00:15:04.585
It's going to have an install,

00:15:04.585 --> 00:15:06.625
it's also going to have a run package build and

00:15:06.625 --> 00:15:07.905
it's going to pass through

00:15:08.395 --> 00:15:10.275
to the data service application.

00:15:10.275 --> 00:15:10.915
That's the only difference.

00:15:10.915 --> 00:15:12.155
And then you'll just have to make sure that you

00:15:12.155 --> 00:15:13.995
connect the GitHub or you,

00:15:14.235 --> 00:15:17.675
you configure the build on inside of Cloudflare

00:15:17.675 --> 00:15:19.115
and then everything will work as expected.

00:15:19.515 --> 00:15:20.635
So I know that was a lot.

00:15:20.635 --> 00:15:21.195
It was a lot.

00:15:21.195 --> 00:15:21.915
It was long winded.

00:15:21.915 --> 00:15:23.675
It's kind of a long video for just configuration

00:15:23.675 --> 00:15:23.915
stuff.

00:15:23.915 --> 00:15:25.635
But in this next video we're actually going to get

00:15:25.635 --> 00:15:27.915
to managing our own domains,

00:15:27.915 --> 00:15:29.395
which is really the most important thing when

00:15:29.395 --> 00:15:30.955
you're building a service is that like it's

00:15:30.955 --> 00:15:32.475
branded for your own thing and you're not using

00:15:32.475 --> 00:15:33.025
CloudFL

00:15:33.575 --> 00:15:35.045
dev randomly generated,

00:15:35.045 --> 00:15:35.635
URL.

00:15:35.635 --> 00:15:37.155
So that's what we're going to do in this next

00:15:37.155 --> 00:15:39.115
section and it's not required for the course.

00:15:39.205 --> 00:15:40.485
you don't have to buy a domain,

00:15:40.485 --> 00:15:42.645
but if you do have a domain and you're interested

00:15:42.645 --> 00:15:43.165
in this process,

00:15:43.165 --> 00:15:44.725
I'm just going to walk through the entire thing

00:15:44.725 --> 00:15:46.605
for us and then kind of show us how that wires

00:15:46.605 --> 00:15:49.445
into our stage build and our production build.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.098 --> 00:00:00.498
All right,

00:00:00.498 --> 00:00:02.178
so now let's talk about domains.

00:00:02.338 --> 00:00:02.618
So,

00:00:02.618 --> 00:00:02.858
I mean,

00:00:02.858 --> 00:00:04.818
this is kind of really what Cloudflare is known

00:00:04.818 --> 00:00:05.138
for.

00:00:05.138 --> 00:00:06.138
They have a very,

00:00:06.138 --> 00:00:07.298
very great DNS,

00:00:07.548 --> 00:00:08.188
cdn.

00:00:08.188 --> 00:00:09.788
You can manage your domains through them.

00:00:10.268 --> 00:00:10.508
Now,

00:00:10.508 --> 00:00:13.508
I do think most people that utilize Cloudflare,

00:00:13.508 --> 00:00:14.108
they actually

00:00:14.588 --> 00:00:17.308
go through this domain process where they transfer

00:00:17.308 --> 00:00:18.828
their domains to Cloudflare.

00:00:19.358 --> 00:00:22.678
so a lot of people will buy domains@namecheap.com

00:00:22.678 --> 00:00:24.718
or GoDaddy or really wherever,

00:00:24.718 --> 00:00:25.678
and that's really fine.

00:00:25.678 --> 00:00:26.278
You can do that.

00:00:26.278 --> 00:00:27.598
You just literally sear

00:00:28.378 --> 00:00:29.378
namecheapcloudflare.

00:00:29.378 --> 00:00:31.458
And there will be tons of videos to show you how

00:00:31.458 --> 00:00:31.738
to,

00:00:32.588 --> 00:00:34.908
to move your domain name to basically allow,

00:00:35.138 --> 00:00:36.748
Cloudflare's DNS to manage it.

00:00:37.388 --> 00:00:37.708
Now,

00:00:37.708 --> 00:00:39.668
what we're gonna do for the purpose of this course

00:00:39.668 --> 00:00:41.348
is we're just gonna literally buy our domain

00:00:41.348 --> 00:00:42.028
through Cloudflare,

00:00:42.028 --> 00:00:43.347
so under domain registrations,

00:00:43.347 --> 00:00:45.468
we can go to register domains.

00:00:45.628 --> 00:00:48.588
And I have a little stupid domain name that I

00:00:48.588 --> 00:00:49.548
think should be available.

00:00:49.642 --> 00:00:52.102
smart link with no vals and no n,

00:00:52.102 --> 00:00:53.382
because the one with the N is taken.

00:00:53.522 --> 00:00:54.702
this is available for $10.

00:00:54.702 --> 00:00:56.262
I'm probably just gonna stash this domain name

00:00:56.262 --> 00:00:57.022
after because I really

00:00:57.322 --> 00:00:57.722
care about it.

00:00:57.722 --> 00:00:59.842
But I just want to show you all the process of

00:00:59.842 --> 00:01:01.682
actually onboarding a domain and using it.

00:01:01.682 --> 00:01:03.562
So we're going to go ahead and purchase that

00:01:03.962 --> 00:01:04.362
and,

00:01:04.742 --> 00:01:05.942
fill out this information.

00:01:06.182 --> 00:01:07.822
I'm going to pause the video,

00:01:07.822 --> 00:01:09.702
and then we'll come back after the purchase is

00:01:09.702 --> 00:01:10.176
successful.

00:01:10.202 --> 00:01:10.762
All right,

00:01:10.762 --> 00:01:12.602
so once the purchase is done,

00:01:12.922 --> 00:01:14.682
it'll give you some information about,

00:01:15.302 --> 00:01:16.342
about the domain,

00:01:17.222 --> 00:01:18.582
who the register is,

00:01:18.742 --> 00:01:19.382
and then

00:01:20.692 --> 00:01:22.612
now what we're going to do is we can.

00:01:22.612 --> 00:01:23.972
If you just go to account home

00:01:23.983 --> 00:01:25.947
when you buy a domain or you have a domain that

00:01:25.947 --> 00:01:26.787
you are you,

00:01:27.027 --> 00:01:28.867
that you have onboarded onto Cloudflare,

00:01:28.867 --> 00:01:31.347
you'll be able to see that it is available here.

00:01:31.417 --> 00:01:34.167
so from there we can actually directly configure

00:01:34.167 --> 00:01:35.447
this inside of our worker,

00:01:35.447 --> 00:01:36.367
and we can,

00:01:36.837 --> 00:01:39.437
have our worker code point at this domain instead

00:01:39.437 --> 00:01:40.437
of our actual,

00:01:40.437 --> 00:01:40.757
like,

00:01:40.757 --> 00:01:42.517
instead of that randomly generated

00:01:42.837 --> 00:01:43.547
domain that,

00:01:43.547 --> 00:01:44.517
Cloudflare gave us.

00:01:44.517 --> 00:01:45.528
So let's go ahead and do that.

00:01:45.648 --> 00:01:45.768
Now,

00:01:45.768 --> 00:01:47.648
before we configure this domain,

00:01:47.888 --> 00:01:49.488
inside of our worker,

00:01:49.488 --> 00:01:51.688
a few things that I do want to call out that are

00:01:51.688 --> 00:01:52.448
nice is,

00:01:52.928 --> 00:01:55.008
there's so much that you can do in terms of like

00:01:55.008 --> 00:01:57.168
networking and networking configurations.

00:01:58.288 --> 00:01:59.008
I would say,

00:01:59.008 --> 00:02:00.448
at least if you're going to do,

00:02:01.408 --> 00:02:03.608
I would say for sure what you should do is you

00:02:03.608 --> 00:02:05.368
should come over to these cloudflare rules and

00:02:05.368 --> 00:02:05.648
then,

00:02:06.048 --> 00:02:08.328
I mean I think almost every single use case

00:02:08.328 --> 00:02:10.128
you're going to want to do automatic redirects

00:02:10.128 --> 00:02:11.728
from HTTP to HTTPs.

00:02:11.808 --> 00:02:12.608
So you can come in,

00:02:12.608 --> 00:02:13.648
you can go ahead and create that

00:02:13.948 --> 00:02:16.348
and we can basically say we're going to apply it

00:02:16.348 --> 00:02:18.348
for all incoming requests,

00:02:19.708 --> 00:02:21.388
and we can go ahead and deploy that.

00:02:21.628 --> 00:02:24.148
So basically this is going to not be at the worker

00:02:24.148 --> 00:02:26.468
level but be at the network level before the code

00:02:26.468 --> 00:02:27.388
reaches our worker.

00:02:27.388 --> 00:02:28.588
Everything's going to be,

00:02:29.088 --> 00:02:32.708
redirected to HTTPs just to keep that clean for

00:02:32.708 --> 00:02:32.912
us.

00:02:32.958 --> 00:02:35.718
Configuring a domain in your worker is actually

00:02:35.718 --> 00:02:37.718
pretty straightforward once you've bought your

00:02:37.718 --> 00:02:40.158
domain and have it onboarded onto cloudflare.

00:02:40.318 --> 00:02:40.718
So

00:02:41.028 --> 00:02:42.338
there's kind of two concepts here.

00:02:42.338 --> 00:02:44.338
There's custom domains and there's routes.

00:02:44.898 --> 00:02:47.178
Custom domains are basically just like an entire

00:02:47.178 --> 00:02:47.618
domain,

00:02:47.618 --> 00:02:50.058
whether it be a subdomain or just like the normal

00:02:50.058 --> 00:02:51.298
domain with no subdomain.

00:02:51.628 --> 00:02:54.978
and it applies to all the paths on a given domain.

00:02:54.978 --> 00:02:56.978
So you can just think about it if it's just like

00:02:57.358 --> 00:02:58.158
I want to have

00:02:58.478 --> 00:03:01.078
everything from example.com to route to a worker

00:03:01.078 --> 00:03:03.438
or shop dot example.com to route to a specific

00:03:03.438 --> 00:03:03.918
worker.

00:03:03.918 --> 00:03:04.318
Now

00:03:04.838 --> 00:03:06.638
and this is what the configuration would look like

00:03:06.638 --> 00:03:07.078
as well.

00:03:07.528 --> 00:03:09.648
the other option is routes and I'm going to show

00:03:09.648 --> 00:03:10.928
you kind of how to configure both.

00:03:10.928 --> 00:03:12.447
We're going to start with custom domains,

00:03:12.447 --> 00:03:14.408
but routes are a little bit more

00:03:14.728 --> 00:03:16.348
you have to be a little bit more methodical about

00:03:16.348 --> 00:03:18.388
it because you're ultimately allowing this

00:03:18.388 --> 00:03:19.668
wildcard character to say

00:03:20.068 --> 00:03:22.508
everything at a certain path is going to be routed

00:03:22.508 --> 00:03:23.108
to some

00:03:23.388 --> 00:03:24.658
to a specific worker.

00:03:24.658 --> 00:03:27.178
So you could say like everything at.

00:03:27.638 --> 00:03:28.038
In this

00:03:28.358 --> 00:03:30.598
diagram they say like everything at auth

00:03:30.998 --> 00:03:33.118
is going to go to a specific server or everything

00:03:33.118 --> 00:03:34.518
at forward slash API.

00:03:34.518 --> 00:03:37.318
Or you could even do wildcards on like a given

00:03:37.318 --> 00:03:38.518
subdomain as well.

00:03:38.898 --> 00:03:41.138
it's like you could basically say in this example

00:03:41.458 --> 00:03:44.258
everything@starexample.com is going to

00:03:44.718 --> 00:03:46.758
route to like a specific worker.

00:03:46.826 --> 00:03:50.586
So let's start by configuring a custom domain in

00:03:50.586 --> 00:03:51.306
our application.

00:03:51.386 --> 00:03:53.186
So what I'm going to do is I'm going to go over to

00:03:53.186 --> 00:03:54.356
user application and,

00:03:54.506 --> 00:03:56.306
and I'm going to first actually go to the

00:03:56.306 --> 00:03:58.506
production side of things and I actually have this

00:03:58.506 --> 00:03:59.126
coded out.

00:03:59.126 --> 00:04:00.726
But what we can do is we can also

00:04:01.906 --> 00:04:02.746
start from scratch.

00:04:02.826 --> 00:04:04.586
So you like above.

00:04:04.586 --> 00:04:04.986
I would.

00:04:04.986 --> 00:04:07.186
I usually like to do it at the top level of a

00:04:07.186 --> 00:04:07.466
given

00:04:08.136 --> 00:04:08.536
environment.

00:04:09.256 --> 00:04:11.656
You can basically say routes and then inside of

00:04:11.656 --> 00:04:13.496
routes is going to take an object of either

00:04:13.816 --> 00:04:15.896
custom domain configurations or

00:04:16.836 --> 00:04:17.996
route configuration.

00:04:17.996 --> 00:04:19.396
So we'll start with custom domain.

00:04:19.396 --> 00:04:22.196
So we can basically say custom domain is true

00:04:23.156 --> 00:04:23.396
and

00:04:24.036 --> 00:04:24.436
the,

00:04:26.062 --> 00:04:27.662
the pattern is going to be

00:04:27.982 --> 00:04:29.582
our specific domain.

00:04:29.662 --> 00:04:33.102
So smrtlk.com

00:04:34.382 --> 00:04:35.422
now from here

00:04:35.822 --> 00:04:38.142
literally all you have to do is if you go into

00:04:38.142 --> 00:04:38.462
your

00:04:38.862 --> 00:04:38.952
user

00:04:39.202 --> 00:04:40.162
application directory,

00:04:40.162 --> 00:04:41.722
the next time you deploy pnpm,

00:04:41.722 --> 00:04:42.002
run

00:04:42.322 --> 00:04:43.922
Production deploy,

00:04:45.738 --> 00:04:47.498
what you're going to notice at the end is it's

00:04:47.498 --> 00:04:49.098
going to give you a specific

00:04:50.328 --> 00:04:52.248
URL to use to view your

00:04:52.428 --> 00:04:53.948
worker that Isn't the.

00:04:54.988 --> 00:04:56.871
That isn't the Cloudflare provided one.

00:04:56.871 --> 00:05:00.662
So you can notice now the domain is Smartlink and

00:05:00.662 --> 00:05:03.782
this will likely take a little bit of time

00:05:04.182 --> 00:05:06.102
once you deploy for the first time.

00:05:07.362 --> 00:05:09.602
it doesn't for me because I previously deployed,

00:05:09.602 --> 00:05:12.202
but it might take 10 minutes for yours to actually

00:05:12.202 --> 00:05:14.002
show up and be working as expected.

00:05:14.352 --> 00:05:15.202
which is totally okay.

00:05:15.202 --> 00:05:16.842
Just sometimes takes a little bit of time for the

00:05:16.842 --> 00:05:17.882
DNS to propagate.

00:05:17.882 --> 00:05:20.042
But what you can see is like we're able to go to

00:05:20.042 --> 00:05:22.242
our custom domain now and we can

00:05:22.882 --> 00:05:24.962
go to app and we can see everything inside of the

00:05:24.962 --> 00:05:25.282
app.

00:05:25.442 --> 00:05:25.842
So

00:05:26.112 --> 00:05:26.672
this is,

00:05:26.832 --> 00:05:27.592
this is essentially,

00:05:27.592 --> 00:05:29.552
basically saying everything at this home page is

00:05:29.552 --> 00:05:30.592
going to be routed here.

00:05:30.672 --> 00:05:33.252
Now we can also do is we can come into

00:05:33.562 --> 00:05:33.992
stage

00:05:34.472 --> 00:05:35.992
and I'm going to do a similar thing.

00:05:36.392 --> 00:05:37.192
I'm going to go

00:05:37.592 --> 00:05:38.072
routes

00:05:39.512 --> 00:05:42.232
and then inside of routes I'm going to say custom

00:05:42.232 --> 00:05:43.512
domain is also true

00:05:43.606 --> 00:05:44.001
but

00:05:44.481 --> 00:05:46.481
the pattern is actually going to be

00:05:46.881 --> 00:05:50.401
stage.smartlink.com

00:05:51.681 --> 00:05:53.841
and then I'm going to PNPM run

00:05:54.506 --> 00:05:55.146
stage

00:05:56.556 --> 00:05:57.036
deploy.

00:05:59.714 --> 00:06:01.074
Now when this is done,

00:06:01.764 --> 00:06:03.364
we should be able to access

00:06:03.872 --> 00:06:06.680
our service at Stage Smartlink.

00:06:07.560 --> 00:06:10.250
Now this error actually to me indicates that

00:06:10.570 --> 00:06:11.770
this deployment didn't work.

00:06:11.850 --> 00:06:14.850
And what we're going to notice here is the link

00:06:14.850 --> 00:06:17.050
that it gave us at the end of our deploy actually

00:06:17.050 --> 00:06:19.290
is pointing@smartlink.com so

00:06:19.610 --> 00:06:22.650
one thing that I'm noticing here in our specific

00:06:22.730 --> 00:06:24.250
build script for Stage,

00:06:24.890 --> 00:06:26.970
essentially what we're going to want to do is

00:06:26.970 --> 00:06:29.170
we're going to want to also pass in a flag the

00:06:29.170 --> 00:06:31.130
same way we're doing for this production build.

00:06:31.210 --> 00:06:33.530
So inside of our normal build

00:06:34.010 --> 00:06:35.930
I'm just basically going to say

00:06:37.608 --> 00:06:38.968
build is going to run

00:06:40.808 --> 00:06:41.334
mode,

00:06:42.534 --> 00:06:42.934
development.

00:06:45.894 --> 00:06:47.854
We'll deploy that one more time and see if it goes

00:06:47.854 --> 00:06:48.110
through.

00:06:48.110 --> 00:06:48.572
All right?

00:06:48.572 --> 00:06:49.052
Yeah,

00:06:49.052 --> 00:06:50.852
so just make sure that you have these

00:06:50.852 --> 00:06:51.932
configured properly.

00:06:51.932 --> 00:06:54.012
The configuration is kind of always a tedious

00:06:54.012 --> 00:06:54.292
thing.

00:06:54.292 --> 00:06:54.612
But

00:06:55.672 --> 00:06:58.632
so now you can see the output of this says stage

00:06:58.632 --> 00:06:59.752
smartlink.com

00:07:00.055 --> 00:07:01.415
we can head on over to that

00:07:03.259 --> 00:07:05.099
and it is working as expected.

00:07:05.419 --> 00:07:07.299
Now one thing you're going to notice both on our

00:07:07.299 --> 00:07:08.299
production deploy

00:07:09.099 --> 00:07:09.978
and our

00:07:11.259 --> 00:07:11.319
stage

00:07:11.599 --> 00:07:14.759
deploy is this disconnected is actually showing as

00:07:14.759 --> 00:07:15.439
disconnected.

00:07:15.639 --> 00:07:17.559
websocket's not actually connecting to our server.

00:07:17.559 --> 00:07:18.319
And that is because

00:07:18.799 --> 00:07:19.199
the

00:07:19.869 --> 00:07:21.909
previously configured domain that we kind of have

00:07:21.909 --> 00:07:23.629
hard coded in our code base is

00:07:24.330 --> 00:07:24.689
is.

00:07:24.769 --> 00:07:26.769
We can take a look at our.

00:07:26.769 --> 00:07:28.129
We head over to our workers,

00:07:30.041 --> 00:07:31.536
we can go to user application

00:07:31.570 --> 00:07:34.970
and what we can notice is this previous domain now

00:07:34.970 --> 00:07:35.650
is inactive.

00:07:35.650 --> 00:07:37.130
We're actually not able to use it.

00:07:37.130 --> 00:07:37.550
and we're,

00:07:37.550 --> 00:07:39.270
and we're actually using this custom

00:07:39.810 --> 00:07:40.210
domain.

00:07:40.210 --> 00:07:42.290
So in our build as well,

00:07:42.530 --> 00:07:45.090
we're going to want to update our variables here.

00:07:45.590 --> 00:07:47.130
so we're going to want to basically come in and

00:07:47.130 --> 00:07:48.010
we're going to want to say

00:07:48.490 --> 00:07:48.890
our

00:07:49.450 --> 00:07:52.450
base host is no longer that one that's provided by

00:07:52.450 --> 00:07:53.130
Cloudflare

00:07:53.610 --> 00:07:55.330
and is staged Smart Link.

00:07:55.330 --> 00:07:56.250
And I'm going to save that

00:07:56.272 --> 00:07:58.222
and then I'm also going to go over to our

00:07:59.362 --> 00:08:00.002
version of it.

00:08:00.002 --> 00:08:01.842
I'm going to do the update there as well.

00:08:02.002 --> 00:08:02.402
So

00:08:02.972 --> 00:08:04.092
our vite based,

00:08:04.172 --> 00:08:04.732
you are

00:08:05.372 --> 00:08:07.692
based host is now going to be

00:08:08.092 --> 00:08:09.256
smartlink.com

00:08:09.256 --> 00:08:11.814
and then I'm also going to make sure I have that

00:08:11.814 --> 00:08:15.254
updated inside of our EMV files just so if we

00:08:15.254 --> 00:08:18.374
deploy locally and not from the actual build,

00:08:18.854 --> 00:08:20.934
all of these variables are going to be

00:08:21.154 --> 00:08:22.274
propagated as expected.

00:08:22.514 --> 00:08:24.314
So make sure this is stage.

00:08:24.314 --> 00:08:26.114
We're going to make sure that this one is just the

00:08:26.114 --> 00:08:27.274
normal base URL.

00:08:27.274 --> 00:08:29.074
Now this is kind of one thing to note.

00:08:29.394 --> 00:08:31.154
You should probably pick if you're actually

00:08:31.684 --> 00:08:33.804
building for a production application,

00:08:33.804 --> 00:08:35.124
you should kind of pick how you're going to do

00:08:35.124 --> 00:08:35.284
this.

00:08:35.284 --> 00:08:35.844
I would suggest

00:08:36.484 --> 00:08:39.244
not ever actually deploying from your local just

00:08:39.244 --> 00:08:39.524
because

00:08:39.924 --> 00:08:41.484
you're going to have to make sure all of the

00:08:41.484 --> 00:08:43.844
variables are configured inside of here,

00:08:44.221 --> 00:08:46.420
like the correct way and then also inside the

00:08:46.420 --> 00:08:48.221
Cloudflare and like keeping those things aligned

00:08:48.221 --> 00:08:49.021
can be very tedious.

00:08:49.021 --> 00:08:50.781
But just for the purpose of time,

00:08:51.181 --> 00:08:52.541
I'm going to be deploying,

00:08:52.661 --> 00:08:53.809
I'm going to be deploying

00:08:53.809 --> 00:08:54.750
from the cli,

00:08:54.750 --> 00:08:57.170
but I would just say rely on the build deploys

00:08:57.170 --> 00:08:58.610
if you're actually building for production.

00:09:00.153 --> 00:09:00.553
All right,

00:09:00.793 --> 00:09:01.833
so that went through.

00:09:02.233 --> 00:09:04.793
We should be able to head back over to our

00:09:05.833 --> 00:09:05.913
stage,

00:09:05.913 --> 00:09:08.673
um.smartlink.com reload that guy.

00:09:08.673 --> 00:09:09.753
And now we are connected.

00:09:09.993 --> 00:09:11.283
I'm just going to go ahead and deploy the

00:09:11.283 --> 00:09:12.593
production version of this as well.

00:09:15.763 --> 00:09:17.923
And while that's going we can also take a look at

00:09:17.923 --> 00:09:18.243
our

00:09:18.283 --> 00:09:19.763
we can also take a look at our data service.

00:09:21.283 --> 00:09:21.683
So

00:09:22.163 --> 00:09:24.043
to start with we're also going to do a custom

00:09:24.043 --> 00:09:24.803
domain here

00:09:25.763 --> 00:09:26.963
and I'm going to

00:09:27.843 --> 00:09:30.323
come to our wrangler JSON for our data service

00:09:30.803 --> 00:09:32.323
and I'm going to start with production.

00:09:32.403 --> 00:09:33.443
We can go route

00:09:35.123 --> 00:09:36.563
and inside of routes.

00:09:36.643 --> 00:09:37.283
Let's take a,

00:09:37.283 --> 00:09:39.203
let's go custom domain is going to be true

00:09:39.863 --> 00:09:42.183
and what I'm going to say is this is going to be

00:09:42.583 --> 00:09:45.543
go.smartlink.com

00:09:46.263 --> 00:09:48.423
so this is going to be the short link that we use

00:09:48.634 --> 00:09:49.034
and

00:09:49.104 --> 00:09:51.014
I just have to make sure I'm providing it the

00:09:51.014 --> 00:09:51.765
actual pattern here.

00:09:52.666 --> 00:09:54.586
And we can go ahead and say pnpm,

00:09:54.586 --> 00:09:54.906
run,

00:09:55.946 --> 00:09:56.626
production,

00:09:56.626 --> 00:09:57.226
deploy.

00:09:58.046 --> 00:09:58.526
All right,

00:09:58.926 --> 00:10:01.246
so that successfully deployed.

00:10:02.076 --> 00:10:03.636
I'm just gonna base.

00:10:03.636 --> 00:10:04.436
So this is a.

00:10:04.436 --> 00:10:07.076
This used to be the redirect URL that we would

00:10:07.076 --> 00:10:07.356
use,

00:10:07.356 --> 00:10:10.036
but now it's no longer working because we are

00:10:10.036 --> 00:10:11.276
actually using a,

00:10:11.996 --> 00:10:13.796
we have our own domain associated with this.

00:10:13.796 --> 00:10:14.476
So I'm going to go

00:10:14.926 --> 00:10:18.606
go.smartlink.com

00:10:19.218 --> 00:10:21.658
and it looks like the destination is not found and

00:10:21.658 --> 00:10:23.378
that is because this destination actually doesn't

00:10:23.378 --> 00:10:23.778
exist.

00:10:23.788 --> 00:10:25.628
because we haven't done any of them in production.

00:10:25.628 --> 00:10:27.348
So we could also come into stage.

00:10:27.348 --> 00:10:29.108
So I'm going to do the same thing inside of stage

00:10:29.214 --> 00:10:30.414
and I'm going to go routes

00:10:32.252 --> 00:10:34.092
and inside of routes we can say

00:10:36.012 --> 00:10:37.292
custom domain is true.

00:10:38.812 --> 00:10:40.252
Pattern is going to be

00:10:41.322 --> 00:10:42.842
This is where we're going to make it a little bit

00:10:42.842 --> 00:10:43.042
different.

00:10:43.042 --> 00:10:50.922
So we're going to say go-stage.smartlink.com

00:10:52.281 --> 00:10:54.281
and I'm going to go ahead and PNPM

00:10:54.921 --> 00:10:55.321
run

00:10:56.361 --> 00:10:56.881
stage,

00:10:56.881 --> 00:10:57.481
deploy

00:10:59.255 --> 00:11:01.335
and we're going to go to go

00:11:01.655 --> 00:11:02.935
and I'm going to say dash

00:11:03.300 --> 00:11:03.644
So

00:11:04.449 --> 00:11:05.330
we called this

00:11:06.130 --> 00:11:06.530
go

00:11:07.090 --> 00:11:07.570
stage.

00:11:07.570 --> 00:11:08.050
So go

00:11:08.690 --> 00:11:10.290
stage smartlink.com

00:11:10.337 --> 00:11:13.617
and it looks like the DNS is still propagating,

00:11:13.777 --> 00:11:16.577
so we're going to give it just two more minutes.

00:11:16.847 --> 00:11:17.207
All right,

00:11:17.207 --> 00:11:17.967
it just went through.

00:11:17.967 --> 00:11:20.207
So it took about just less than a minute for the

00:11:20.207 --> 00:11:21.287
DNS to fully,

00:11:21.287 --> 00:11:22.087
register this.

00:11:22.087 --> 00:11:22.647
But now

00:11:23.047 --> 00:11:24.327
this redirects to Google,

00:11:24.327 --> 00:11:24.887
which is expected.

00:11:25.127 --> 00:11:25.527
So,

00:11:25.767 --> 00:11:27.227
we have our custom domains working,

00:11:27.467 --> 00:11:29.787
but now what if we wanted to do something more

00:11:29.787 --> 00:11:32.507
along the lines of like we wanted our smart link

00:11:32.507 --> 00:11:34.507
to actually be very short and we didn't want to

00:11:34.507 --> 00:11:35.787
have some type of subdomain.

00:11:35.867 --> 00:11:36.967
We could also do that.

00:11:36.967 --> 00:11:38.367
and there's a few different strategies here.

00:11:38.367 --> 00:11:40.367
So what we're going to do is we're going to first

00:11:40.367 --> 00:11:41.287
basically say,

00:11:41.467 --> 00:11:42.187
we're going to change

00:11:42.587 --> 00:11:43.467
custom domain.

00:11:43.467 --> 00:11:44.987
We're going to call this zone name

00:11:45.657 --> 00:11:47.337
and the zone is just the,

00:11:48.857 --> 00:11:49.108
the

00:11:49.298 --> 00:11:52.098
domain name that you have onboarded to Cloudflare.

00:11:52.338 --> 00:11:54.538
And then the pattern is going to be something like

00:11:54.538 --> 00:11:54.778
this.

00:11:54.778 --> 00:11:56.658
So we're going to basically say smart link.

00:11:57.058 --> 00:11:58.577
Now if you do star,

00:11:58.738 --> 00:12:01.378
this is going to cause some misconfiguration

00:12:01.458 --> 00:12:02.338
because your

00:12:02.738 --> 00:12:05.858
user application is also configured to basically

00:12:05.858 --> 00:12:07.058
have anything at smart.

00:12:07.138 --> 00:12:07.808
At smart,

00:12:07.938 --> 00:12:08.538
smart link.

00:12:08.538 --> 00:12:08.978
So like,

00:12:09.058 --> 00:12:11.498
this is where the business logic of your

00:12:11.498 --> 00:12:13.058
application is really important.

00:12:13.218 --> 00:12:14.338
Like for our,

00:12:15.218 --> 00:12:16.698
for our smart Links.

00:12:16.698 --> 00:12:18.658
We're just having these like random,

00:12:19.580 --> 00:12:21.076
we're just having these like random,

00:12:25.050 --> 00:12:25.950
these random

00:12:26.160 --> 00:12:27.920
specific IDs at the very end.

00:12:28.250 --> 00:12:28.490
And

00:12:29.210 --> 00:12:31.610
this kind of makes pattern matching really tricky.

00:12:31.690 --> 00:12:33.690
So you can imagine that we have.

00:12:34.890 --> 00:12:34.920
You

00:12:35.040 --> 00:12:37.320
can imagine that like if we were to basically say

00:12:37.320 --> 00:12:37.960
all of our

00:12:37.981 --> 00:12:40.780
short links are going to start with like the same

00:12:41.018 --> 00:12:41.588
prefix,

00:12:41.987 --> 00:12:43.108
you could say like,

00:12:43.748 --> 00:12:45.148
like whatever prefix.

00:12:45.148 --> 00:12:46.350
Let's just say you have like

00:12:46.354 --> 00:12:47.024
smt

00:12:47.504 --> 00:12:50.584
and then everything after SMT is going to be

00:12:50.584 --> 00:12:52.344
specific to like your smart link.

00:12:52.344 --> 00:12:52.664
You know,

00:12:52.664 --> 00:12:53.944
you could do something like that or you could say

00:12:53.944 --> 00:12:54.944
they all start with R.

00:12:55.104 --> 00:12:57.324
This would just be tricky because if you had a,

00:12:57.724 --> 00:13:00.004
a specific path in your application that started

00:13:00.004 --> 00:13:00.564
with R,

00:13:00.564 --> 00:13:02.364
it would go to the backend service and not the

00:13:02.364 --> 00:13:02.924
front end service.

00:13:02.924 --> 00:13:05.244
So this is kind of where things get a little bit,

00:13:05.524 --> 00:13:07.274
tricky and you kind of have to commit to the

00:13:07.274 --> 00:13:08.514
pattern that you're going to want to follow.

00:13:08.754 --> 00:13:09.674
For our use case,

00:13:09.674 --> 00:13:11.114
what I'm going to do is I'm just going to head

00:13:11.114 --> 00:13:13.074
over to our data service

00:13:13.634 --> 00:13:15.794
and I'll go to the HONO application and

00:13:15.794 --> 00:13:18.434
essentially our redirect service is just looking

00:13:18.434 --> 00:13:20.114
at like the base path.

00:13:20.434 --> 00:13:22.114
But what I'm going to do is I'm going to say

00:13:22.354 --> 00:13:22.914
anything.

00:13:23.414 --> 00:13:25.254
We're just going to call this R for now.

00:13:27.334 --> 00:13:30.534
So anything at forward slash R is going to be

00:13:30.534 --> 00:13:33.974
redirected to our link service so we can come back

00:13:33.974 --> 00:13:35.254
to our Wrangler JSON

00:13:35.734 --> 00:13:37.014
and we're going to say R

00:13:37.334 --> 00:13:38.854
forward slash star.

00:13:39.254 --> 00:13:41.374
So anything with this path is actually going to be

00:13:41.374 --> 00:13:42.374
treated as a short link.

00:13:42.374 --> 00:13:44.414
And I mean it's not ideal that you have this path

00:13:44.414 --> 00:13:44.694
here.

00:13:44.944 --> 00:13:46.624
it would be nice if you just had like a random

00:13:46.624 --> 00:13:47.544
configuration here.

00:13:47.544 --> 00:13:49.864
So this just kind of gets into how like you decide

00:13:49.864 --> 00:13:51.104
to configure your routes.

00:13:51.104 --> 00:13:51.504
But,

00:13:52.074 --> 00:13:52.714
this should work.

00:13:52.714 --> 00:13:54.154
So I'm going to basically say,

00:13:54.324 --> 00:13:56.204
this is actually technically stage.

00:13:56.284 --> 00:13:58.524
So I'm still going to have stage here,

00:13:59.004 --> 00:14:00.204
which is totally okay.

00:14:00.444 --> 00:14:02.364
I'm going to copy this route over

00:14:03.004 --> 00:14:05.684
and we can come over to our production version of

00:14:05.684 --> 00:14:05.964
it.

00:14:05.964 --> 00:14:07.004
Just close this guy

00:14:07.488 --> 00:14:07.888
and

00:14:08.368 --> 00:14:09.168
I can

00:14:09.808 --> 00:14:10.208
say

00:14:10.578 --> 00:14:12.338
instead of stage we'll just go like this.

00:14:12.418 --> 00:14:12.818
So

00:14:13.698 --> 00:14:16.058
anything at forward slash R is going to direct

00:14:16.058 --> 00:14:16.378
there.

00:14:16.378 --> 00:14:18.338
I'm going to deploy stage because we actually have

00:14:18.338 --> 00:14:19.490
data in stage right now.

00:14:20.344 --> 00:14:20.824
All right,

00:14:20.984 --> 00:14:22.264
so our link is now

00:14:23.154 --> 00:14:24.914
R forward slash star.

00:14:24.994 --> 00:14:26.354
So instead of go

00:14:27.234 --> 00:14:27.994
dash stage,

00:14:27.994 --> 00:14:29.234
it's just going to be stage

00:14:30.250 --> 00:14:31.857
and then it's going to be R

00:14:32.897 --> 00:14:35.377
and then it's going to be the ID the link ID

00:14:35.572 --> 00:14:37.005
and that also goes to Google.

00:14:37.005 --> 00:14:37.365
So

00:14:37.765 --> 00:14:38.005
this is,

00:14:38.005 --> 00:14:39.765
this is how you do pattern matching with routes

00:14:39.765 --> 00:14:41.405
and you know you could build a really

00:14:41.405 --> 00:14:43.125
sophisticated service based upon that.

00:14:43.125 --> 00:14:45.765
But like a typical pattern that I have is like I

00:14:45.765 --> 00:14:49.125
have some API that has a bunch of backend logic on

00:14:49.125 --> 00:14:49.525
top of it.

00:14:49.525 --> 00:14:51.445
So I usually just say like anything forward slash

00:14:51.445 --> 00:14:54.645
API is going to go to like my data service and

00:14:54.645 --> 00:14:56.685
then everything else is going to like be managed

00:14:56.685 --> 00:14:57.205
by my

00:14:57.435 --> 00:14:58.185
front end service.

00:14:58.345 --> 00:14:58.745
So

00:14:58.955 --> 00:15:00.805
this is really up to you how you want to configure

00:15:00.805 --> 00:15:03.085
it and it's just worth playing around with because

00:15:03.085 --> 00:15:04.925
it can be a little bit tricky to like get the

00:15:04.925 --> 00:15:05.885
perfect configuration.

00:15:05.885 --> 00:15:07.485
But at the end of the day you really can build

00:15:07.485 --> 00:15:08.205
whatever you want.

00:15:08.365 --> 00:15:11.625
So in a nutshell that is custom domains and

00:15:11.785 --> 00:15:13.025
onboarding subdomains.

00:15:13.025 --> 00:15:13.865
So now from here,

00:15:14.265 --> 00:15:16.025
now that we kind of own our own domains,

00:15:16.025 --> 00:15:18.135
what we can do is we can start building out the

00:15:18.295 --> 00:15:18.935
actual

00:15:19.705 --> 00:15:21.515
we can start building out the actual like

00:15:21.515 --> 00:15:23.675
authentication of our application because you

00:15:23.675 --> 00:15:23.915
know,

00:15:23.915 --> 00:15:26.155
we have a real domain that we can go register with

00:15:26.155 --> 00:15:27.195
like Google and GitHub,

00:15:27.195 --> 00:15:29.155
whoever our auth provider is going to be.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.060 --> 00:00:00.340
All right,

00:00:00.340 --> 00:00:01.660
so let's talk about authentication.

00:00:01.820 --> 00:00:02.140
Now.

00:00:02.140 --> 00:00:04.180
Before we roll out authentication into our

00:00:04.180 --> 00:00:04.700
application,

00:00:04.700 --> 00:00:07.020
I do think that we should understand a few of

00:00:07.020 --> 00:00:09.740
these concepts just so we can like make sure we're

00:00:09.740 --> 00:00:10.820
all talking about the same things.

00:00:10.820 --> 00:00:13.100
And if you're really new to

00:00:13.370 --> 00:00:15.290
like the authentication space and building this

00:00:15.290 --> 00:00:15.890
kind of stuff out,

00:00:15.890 --> 00:00:16.850
I think this will be useful.

00:00:16.850 --> 00:00:17.290
So like,

00:00:17.450 --> 00:00:19.090
there's a few different components that you're

00:00:19.090 --> 00:00:19.690
going to notice.

00:00:19.940 --> 00:00:22.220
but all of these components working together is

00:00:22.220 --> 00:00:23.900
kind of like what builds out your authentication

00:00:23.900 --> 00:00:24.260
system.

00:00:24.340 --> 00:00:24.740
Now,

00:00:25.220 --> 00:00:27.220
one of like if you're kind of more on the front

00:00:27.220 --> 00:00:27.940
end side of things,

00:00:27.940 --> 00:00:29.860
you are probably used to like authentication

00:00:29.860 --> 00:00:30.260
hooks.

00:00:30.260 --> 00:00:30.860
So these are,

00:00:30.860 --> 00:00:32.700
these are basically like in React,

00:00:32.700 --> 00:00:34.150
they're just like stateful hooks,

00:00:34.150 --> 00:00:34.960
and other frameworks.

00:00:34.960 --> 00:00:37.600
They're basically just like reusable front end

00:00:37.600 --> 00:00:41.320
code that allows you to see like information about

00:00:41.320 --> 00:00:41.800
a user.

00:00:41.800 --> 00:00:43.080
You can know their user id,

00:00:43.160 --> 00:00:44.920
you can see if they're signed in or not.

00:00:45.360 --> 00:00:47.680
on like the web page itself.

00:00:47.680 --> 00:00:48.920
And then on the webpage,

00:00:48.920 --> 00:00:49.840
if you're doing like

00:00:50.280 --> 00:00:51.240
client side routing,

00:00:51.560 --> 00:00:53.240
navigating pages via the client,

00:00:53.240 --> 00:00:54.600
you can basically check like,

00:00:54.600 --> 00:00:56.360
is this user allowed to see this page?

00:00:56.360 --> 00:00:56.720
If not,

00:00:56.720 --> 00:00:56.920
like,

00:00:56.920 --> 00:00:57.960
don't show them that page.

00:00:57.960 --> 00:00:58.360
But

00:00:58.680 --> 00:01:01.080
the client side hooks are kind of useless without

00:01:01.240 --> 00:01:03.960
a backend service that is actually authenticating

00:01:03.960 --> 00:01:04.520
that user.

00:01:04.520 --> 00:01:06.600
And that's kind of where this layer comes in.

00:01:06.680 --> 00:01:07.080
Now

00:01:08.110 --> 00:01:11.230
a basic flow is like a UI is going to

00:01:11.550 --> 00:01:14.430
pass in some information about the client to a

00:01:14.430 --> 00:01:14.910
server

00:01:15.250 --> 00:01:15.490
and

00:01:15.970 --> 00:01:18.501
the server that is handling like authentication

00:01:18.501 --> 00:01:20.767
is going to have its logic of if it's like looking

00:01:20.767 --> 00:01:21.447
at a password,

00:01:21.447 --> 00:01:23.367
it's going to compare the password hash for what a

00:01:23.367 --> 00:01:23.747
user,

00:01:24.247 --> 00:01:25.127
was able to,

00:01:25.607 --> 00:01:27.607
for what the user is able to pass over and then

00:01:27.607 --> 00:01:28.807
like see if that user

00:01:29.127 --> 00:01:30.967
has indeed signed up for the service and it's

00:01:30.967 --> 00:01:31.687
authenticated.

00:01:32.537 --> 00:01:35.017
now username and password is like something that's

00:01:35.017 --> 00:01:35.897
being used less and less.

00:01:35.897 --> 00:01:38.217
And a lot of like things that are being used is,

00:01:38.377 --> 00:01:40.657
are these like sign in with Discord or sign in

00:01:40.657 --> 00:01:42.777
with Google or sign in with GitHub and whatnot.

00:01:42.987 --> 00:01:43.387
and

00:01:43.720 --> 00:01:45.040
this is what we're going to be implementing in

00:01:45.040 --> 00:01:45.800
this side of things.

00:01:45.800 --> 00:01:48.228
But basically what happens is your web app

00:01:48.228 --> 00:01:51.060
opens up like a little redirects to Google and

00:01:51.060 --> 00:01:51.740
then Google

00:01:52.140 --> 00:01:54.820
handles like determining if this user is indeed

00:01:54.820 --> 00:01:57.300
who they say they are and they pass some data back

00:01:57.300 --> 00:01:59.140
over to your service and then your service is

00:01:59.140 --> 00:02:01.140
responsible for taking that data from Google and

00:02:01.140 --> 00:02:01.340
saying,

00:02:01.340 --> 00:02:01.820
okay,

00:02:01.820 --> 00:02:03.860
this is the user Google said that they're

00:02:03.860 --> 00:02:05.940
authenticated so you can go ahead and create that

00:02:05.940 --> 00:02:06.380
user,

00:02:06.740 --> 00:02:09.300
and you can add some records into the database and

00:02:09.300 --> 00:02:10.340
then you can create a session.

00:02:10.510 --> 00:02:12.270
And like essentially a session is something that

00:02:12.430 --> 00:02:15.070
your server passes back to the web app to say,

00:02:15.150 --> 00:02:15.590
okay,

00:02:15.590 --> 00:02:18.110
every single time the user makes a request to me,

00:02:18.350 --> 00:02:19.310
give me this data.

00:02:19.390 --> 00:02:21.070
And then I'm going to use that data,

00:02:21.230 --> 00:02:22.190
that session information

00:02:22.750 --> 00:02:24.790
to ensure the user is who they say they are,

00:02:24.790 --> 00:02:25.630
every single request.

00:02:25.630 --> 00:02:26.870
And there's two ways of doing this.

00:02:26.870 --> 00:02:29.390
There's like session cookies and there's jwt.

00:02:29.550 --> 00:02:31.990
Session cookies just basically means like the

00:02:31.990 --> 00:02:33.710
server generates some ID

00:02:34.350 --> 00:02:36.390
and sticks it into a database and then it has a

00:02:36.390 --> 00:02:37.630
value associated with it.

00:02:37.950 --> 00:02:40.350
And every single time a request is made,

00:02:40.680 --> 00:02:42.096
the server goes to a database,

00:02:42.096 --> 00:02:43.518
looks up if that session exists.

00:02:43.518 --> 00:02:44.518
If the session exists,

00:02:44.598 --> 00:02:44.998
great.

00:02:45.078 --> 00:02:46.598
Passes the data into here,

00:02:46.598 --> 00:02:47.198
says the user,

00:02:47.198 --> 00:02:47.918
is authenticated.

00:02:47.918 --> 00:02:50.198
Then like the logic on the server continues.

00:02:50.338 --> 00:02:51.698
JWT is a little bit different.

00:02:51.698 --> 00:02:52.938
When the user signs in,

00:02:52.938 --> 00:02:56.018
JWT token is created which basically packs in some

00:02:56.018 --> 00:02:59.218
information in this encrypted token that says like

00:02:59.878 --> 00:03:01.478
like probably a user id,

00:03:01.558 --> 00:03:04.318
some very like non personal information about the

00:03:04.318 --> 00:03:06.438
user and then it has like an expiry when that

00:03:06.438 --> 00:03:08.638
token expires and then it sends it back to the

00:03:08.638 --> 00:03:11.218
client and then the client passes that toke over

00:03:11.218 --> 00:03:12.258
every single request.

00:03:12.338 --> 00:03:13.058
And because,

00:03:13.488 --> 00:03:14.498
because it's not session based,

00:03:14.498 --> 00:03:15.618
it's JWT based,

00:03:15.778 --> 00:03:18.258
the server will probably have some like key in

00:03:18.258 --> 00:03:20.978
memory and when it gets a token it'll use the key

00:03:21.138 --> 00:03:23.858
to reconcile the token and the key to make,

00:03:23.858 --> 00:03:26.578
to basically validate that that token is correct.

00:03:26.578 --> 00:03:28.578
Now these are really really big topics.

00:03:28.578 --> 00:03:30.298
I don't want to go like too deep or get too

00:03:30.298 --> 00:03:31.138
distracted with them,

00:03:31.298 --> 00:03:32.578
but just know like a

00:03:32.938 --> 00:03:36.738
a JWT or JSON web token flow basically means once

00:03:36.738 --> 00:03:38.298
the user gets that token,

00:03:38.458 --> 00:03:40.938
the server can validate that the user is who they

00:03:41.958 --> 00:03:43.798
having to go to the database every single time.

00:03:43.798 --> 00:03:45.718
And then a session cookie is a little bit like,

00:03:45.718 --> 00:03:48.278
I think it's kind of a more simple like concept

00:03:48.278 --> 00:03:50.038
where server says hey,

00:03:50.038 --> 00:03:50.758
here's a session,

00:03:50.758 --> 00:03:52.078
sticks that session in the database,

00:03:52.078 --> 00:03:53.158
gives it back to the web app.

00:03:53.478 --> 00:03:54.798
Then web app comes over here,

00:03:54.798 --> 00:03:55.358
says oh,

00:03:55.358 --> 00:03:56.318
let me take a look at the session,

00:03:56.318 --> 00:03:57.318
goes to the database,

00:03:57.398 --> 00:03:58.438
gets the session,

00:03:58.438 --> 00:03:59.398
everything's okay,

00:03:59.558 --> 00:04:01.878
passes the data through to continue handling it.

00:04:01.878 --> 00:04:03.638
Now you notice that I wrote out

00:04:03.708 --> 00:04:04.418
auth middleware.

00:04:04.486 --> 00:04:06.246
So when a user signs up

00:04:06.296 --> 00:04:07.867
or when a user is like logged in

00:04:08.062 --> 00:04:08.302
you,

00:04:08.542 --> 00:04:09.662
it's nice to have

00:04:10.062 --> 00:04:11.418
kind of like generic

00:04:11.496 --> 00:04:14.056
code that is essentially like saying hey,

00:04:14.156 --> 00:04:16.796
every single request if it is going to access data

00:04:16.796 --> 00:04:17.636
that is protected,

00:04:17.636 --> 00:04:19.356
that only logged in users should see.

00:04:19.516 --> 00:04:22.476
I just want to route that request to a middleware

00:04:22.716 --> 00:04:23.116
and

00:04:23.536 --> 00:04:24.956
have the middleware do the authentication,

00:04:24.956 --> 00:04:25.876
make sure everything's okay,

00:04:25.876 --> 00:04:27.036
and then if it is okay,

00:04:27.036 --> 00:04:28.076
pass that information,

00:04:28.636 --> 00:04:31.596
pass the request off to like a route or some type

00:04:31.596 --> 00:04:33.276
of handler that's managing that request.

00:04:33.276 --> 00:04:34.916
And then you can write this code once and you

00:04:34.916 --> 00:04:36.876
could use it for tons and tons of different

00:04:36.876 --> 00:04:37.196
routes.

00:04:37.196 --> 00:04:38.656
That's kind of of like what a middle word is going

00:04:38.656 --> 00:04:38.850
to be.

00:04:38.850 --> 00:04:40.774
Now if we take a step back and we think about

00:04:40.774 --> 00:04:41.014
like,

00:04:41.014 --> 00:04:43.574
how does a user actually sign in or sign up

00:04:43.574 --> 00:04:44.054
basically,

00:04:44.054 --> 00:04:45.334
how do they like log in

00:04:47.094 --> 00:04:47.734
essentially?

00:04:47.734 --> 00:04:48.494
Like what's,

00:04:48.494 --> 00:04:49.214
what you,

00:04:49.214 --> 00:04:50.773
if you were to roll this from scratch,

00:04:50.773 --> 00:04:52.854
you would need to have some type of like route

00:04:53.094 --> 00:04:54.374
that is going to like

00:04:54.965 --> 00:04:55.925
validate

00:04:56.565 --> 00:04:58.125
email and password,

00:04:58.125 --> 00:04:58.485
right?

00:04:58.885 --> 00:05:01.205
And then let's say you roll out Auth,

00:05:01.285 --> 00:05:02.565
like you bring in Google,

00:05:03.075 --> 00:05:04.915
you're going to have to like build out some type

00:05:04.915 --> 00:05:05.475
of route

00:05:05.955 --> 00:05:06.355
that

00:05:06.835 --> 00:05:09.635
gets a request from Google after a user signs in

00:05:11.075 --> 00:05:13.475
and then specifically manages authentication with

00:05:13.475 --> 00:05:14.275
the Google APIs.

00:05:14.275 --> 00:05:15.715
And then if you bring in GitHub,

00:05:15.715 --> 00:05:16.755
you have to do the same.

00:05:17.235 --> 00:05:19.955
And this is the aspect of authentication that I

00:05:19.955 --> 00:05:21.035
feel like is really,

00:05:21.035 --> 00:05:24.475
really messy because each provider is going to do

00:05:24.475 --> 00:05:26.195
things in a slightly different way and you're

00:05:26.195 --> 00:05:27.995
basically just writing a whole bunch of code,

00:05:27.995 --> 00:05:29.955
managing a whole bunch of like secrets and tokens

00:05:29.955 --> 00:05:31.435
and whatnot with each provider.

00:05:31.435 --> 00:05:31.795
And

00:05:32.585 --> 00:05:34.565
it can get to the point where it's like,

00:05:34.565 --> 00:05:34.885
oh man,

00:05:34.885 --> 00:05:36.925
this is such a pain to like to manage.

00:05:36.925 --> 00:05:38.565
And then once the user signed in,

00:05:38.565 --> 00:05:39.605
you basically have to like

00:05:39.925 --> 00:05:43.445
create a specific user ID that's specific for your

00:05:43.445 --> 00:05:45.405
system and then save that information into a

00:05:45.405 --> 00:05:45.925
database.

00:05:45.925 --> 00:05:46.805
Now the

00:05:47.015 --> 00:05:48.395
framework that we're going to be using for

00:05:48.395 --> 00:05:50.434
managing Auth is called Better Auth.

00:05:50.434 --> 00:05:52.875
And the reason why I like Better Auth is it's not

00:05:52.875 --> 00:05:53.595
a managed service.

00:05:53.595 --> 00:05:55.195
It's a service that you kind of like bring into

00:05:55.195 --> 00:05:57.355
your application and you implement it the way that

00:05:57.355 --> 00:05:58.755
you want to roll out your auth.

00:05:58.915 --> 00:05:59.315
So

00:05:59.565 --> 00:06:01.365
you can choose which providers you want to use

00:06:01.845 --> 00:06:03.565
and you just basically pass in.

00:06:03.565 --> 00:06:05.605
You basically give it like one Auth

00:06:05.925 --> 00:06:08.565
endpoint and that auth endpoint is going to

00:06:08.565 --> 00:06:11.045
dynamically be able to handle every single

00:06:11.045 --> 00:06:12.205
provider that you bring on.

00:06:12.205 --> 00:06:14.325
You're not ever going to actually have to like

00:06:14.885 --> 00:06:17.125
roll out a specific Google one and a specific

00:06:17.125 --> 00:06:17.805
GitHub one.

00:06:17.805 --> 00:06:19.525
Like it's going to take care of all of the server

00:06:19.525 --> 00:06:20.485
side stuff for you,

00:06:20.485 --> 00:06:21.205
which is really,

00:06:21.205 --> 00:06:21.765
really great.

00:06:22.366 --> 00:06:24.166
Now the other thing that it brings to the table

00:06:24.166 --> 00:06:26.206
like we mentioned before is it also has a whole

00:06:26.206 --> 00:06:27.486
bunch of like client side

00:06:27.786 --> 00:06:28.316
hooks

00:06:28.716 --> 00:06:31.116
that you can use with like React and Svelte and

00:06:31.116 --> 00:06:33.036
Nuxt and different frameworks that you're using.

00:06:33.036 --> 00:06:33.436
So

00:06:33.956 --> 00:06:36.196
you can essentially like import the Better auth

00:06:36.196 --> 00:06:38.356
client hook and you can check on the client side

00:06:38.356 --> 00:06:40.836
like is a user authenticated and then that client

00:06:40.836 --> 00:06:43.236
hook and those client libraries can also like

00:06:43.556 --> 00:06:46.436
basically know you pass in the URL to your server

00:06:46.436 --> 00:06:48.516
and then it handles like all the communication

00:06:48.516 --> 00:06:49.556
with the authentication

00:06:49.676 --> 00:06:52.056
so it abstracts a lot of the boilerplate that you

00:06:52.056 --> 00:06:53.096
need to write on the front end

00:06:53.496 --> 00:06:55.576
and the backend to just get things working.

00:06:55.762 --> 00:06:58.882
Now the reason why I like better off the most is

00:06:58.882 --> 00:06:59.202
because

00:07:00.002 --> 00:07:00.082
I'm

00:07:00.082 --> 00:07:01.722
I mean it does abstract a lot of things away from

00:07:01.722 --> 00:07:03.322
you that's just you don't enjoy doing.

00:07:03.402 --> 00:07:05.322
But the things that like really really matter.

00:07:05.402 --> 00:07:07.082
Like for example payments,

00:07:07.652 --> 00:07:09.412
if you have a specific way that you're doing

00:07:09.412 --> 00:07:11.412
payments and you have specific logic about

00:07:12.102 --> 00:07:15.462
what users are able to like if you have specific

00:07:16.272 --> 00:07:17.352
logic where it's like okay,

00:07:17.352 --> 00:07:18.992
well a user isn't the buyer,

00:07:19.152 --> 00:07:20.752
an organization is the buyer.

00:07:20.832 --> 00:07:21.952
So an organization

00:07:22.752 --> 00:07:24.912
purchases something and then there's users under

00:07:24.912 --> 00:07:25.672
an organization.

00:07:25.672 --> 00:07:27.472
Like if you want to build out that type of logic,

00:07:27.632 --> 00:07:30.472
better Auth has a bunch of plugins and then also a

00:07:30.472 --> 00:07:32.512
plugin framework where you can kind of like roll

00:07:32.512 --> 00:07:34.752
out your own generic way of handling your own

00:07:34.912 --> 00:07:37.590
authenticated permission based business logic.

00:07:37.609 --> 00:07:39.329
So if we head over to the better auth

00:07:39.329 --> 00:07:40.089
documentation

00:07:40.719 --> 00:07:42.719
you can notice down here in plugins there's a

00:07:42.719 --> 00:07:44.319
whole bunch of different things that they have.

00:07:44.399 --> 00:07:44.618
So

00:07:44.905 --> 00:07:47.230
a few different things that I do find useful

00:07:47.400 --> 00:07:49.140
is their organization plugin,

00:07:49.290 --> 00:07:51.450
which basically gives you the ability to manage

00:07:51.610 --> 00:07:52.010
like

00:07:52.510 --> 00:07:54.730
users under a specific organization and then there

00:07:54.730 --> 00:07:56.770
can be like owners of the organization that can

00:07:56.850 --> 00:07:58.210
say hey I want to add this person.

00:07:58.210 --> 00:08:00.330
You can manage the way of like sending out emails

00:08:00.330 --> 00:08:02.650
that has a sign up link and whatnot for,

00:08:02.650 --> 00:08:03.570
for those users.

00:08:03.570 --> 00:08:03.890
So

00:08:04.260 --> 00:08:07.020
MCP which like MCP is kind of a new concept for

00:08:07.020 --> 00:08:07.660
building on top

00:08:08.040 --> 00:08:08.920
large language models.

00:08:08.920 --> 00:08:10.760
But they have like specific ways that

00:08:11.220 --> 00:08:11.580
like hey,

00:08:11.580 --> 00:08:12.980
this is like a great way of implementing

00:08:12.980 --> 00:08:14.380
authentication with MCP Server.

00:08:14.380 --> 00:08:15.740
So they have plugins for that which is pretty

00:08:15.740 --> 00:08:16.000
cool.

00:08:16.000 --> 00:08:16.610
you can just,

00:08:16.610 --> 00:08:18.050
if you want to do like traditional,

00:08:18.050 --> 00:08:20.450
here's an API key and I'm going to like issue API

00:08:20.450 --> 00:08:21.090
keys to

00:08:21.690 --> 00:08:24.050
you know like users of the application and I want

00:08:24.050 --> 00:08:25.770
them to be able to see certain resources they have

00:08:25.770 --> 00:08:26.490
a framework for,

00:08:26.650 --> 00:08:27.832
they have a plugin for that.

00:08:27.832 --> 00:08:29.779
They have stuff for like two factor phone number

00:08:29.779 --> 00:08:30.579
verification

00:08:31.059 --> 00:08:31.699
and then

00:08:32.279 --> 00:08:33.679
on the third party side of things,

00:08:33.679 --> 00:08:33.919
one,

00:08:33.919 --> 00:08:35.519
that one thing that I think is pretty cool is like

00:08:35.519 --> 00:08:35.959
Stripe.

00:08:35.959 --> 00:08:37.239
Now if you have like a super

00:08:37.559 --> 00:08:38.839
basic product where

00:08:39.239 --> 00:08:42.079
you are doing subscription based billing and there

00:08:42.079 --> 00:08:44.159
can be different like subscription tiers and one

00:08:44.159 --> 00:08:45.479
user can buy a subscription,

00:08:45.479 --> 00:08:46.959
this plugin works really really well.

00:08:46.959 --> 00:08:49.039
Now if you're doing really sophisticated things on

00:08:49.039 --> 00:08:51.639
top of stripe like meter based billing or

00:08:52.199 --> 00:08:52.209
account,

00:08:52.419 --> 00:08:53.179
level like

00:08:53.549 --> 00:08:54.959
payment management and whatnot,

00:08:54.959 --> 00:08:56.879
or E commerce where like you're managing lots of

00:08:56.879 --> 00:08:57.359
different products,

00:08:57.599 --> 00:08:59.359
you'd probably want to like roll your own

00:08:59.359 --> 00:08:59.759
solution.

00:08:59.759 --> 00:09:01.839
But you could put your solution under a plugin,

00:09:02.229 --> 00:09:02.869
inside of,

00:09:03.269 --> 00:09:04.389
inside of Better Auth,

00:09:04.469 --> 00:09:06.469
like to kind of fit your specific use case.

00:09:06.469 --> 00:09:08.469
But they do have a lot of things right out of the

00:09:08.469 --> 00:09:08.669
box,

00:09:08.669 --> 00:09:09.392
which is really cool.

00:09:09.449 --> 00:09:12.169
Now I think one of the primary differences between

00:09:12.169 --> 00:09:14.609
Better Auth and a lot of the other providers that

00:09:14.609 --> 00:09:17.009
you've probably heard about if you've been like on

00:09:17.009 --> 00:09:20.289
YouTube watching stuff from like clerk and work OS

00:09:20.289 --> 00:09:22.329
is these are kind of like managed auth solutions,

00:09:22.809 --> 00:09:25.649
which means instead of having like all of your

00:09:25.649 --> 00:09:27.729
user data and your account data and your session

00:09:27.729 --> 00:09:29.449
data sitting in your database

00:09:29.709 --> 00:09:31.619
and that information lives on their servers,

00:09:31.619 --> 00:09:34.739
like on Clerk servers or work OS's servers and you

00:09:34.739 --> 00:09:36.179
know that it can be a clean solution.

00:09:36.179 --> 00:09:38.339
I do think integrations are a little bit easier.

00:09:38.359 --> 00:09:40.239
but whenever you want to do stuff that's like

00:09:40.239 --> 00:09:40.399
really,

00:09:40.399 --> 00:09:40.959
really custom,

00:09:40.959 --> 00:09:42.719
I do think that you're having to like,

00:09:43.039 --> 00:09:43.559
you know,

00:09:43.559 --> 00:09:43.919
like

00:09:44.559 --> 00:09:46.159
create abstractions that

00:09:46.479 --> 00:09:46.970
are like

00:09:46.970 --> 00:09:49.030
further away from your data model and your

00:09:49.030 --> 00:09:49.790
business logic.

00:09:49.790 --> 00:09:51.150
So for a lot of different

00:09:51.880 --> 00:09:52.520
projects,

00:09:52.520 --> 00:09:54.600
I think the vast majority of web apps that you and

00:09:54.600 --> 00:09:55.560
I are going to be building,

00:09:55.720 --> 00:09:57.680
Better Auth I do think is a great solution.

00:09:57.680 --> 00:09:59.440
It's going to be a little bit harder to implement

00:09:59.440 --> 00:10:00.200
than cler,

00:10:00.500 --> 00:10:02.260
but it's going to give you the flexibility to

00:10:02.260 --> 00:10:02.740
build out really,

00:10:02.740 --> 00:10:02.980
really,

00:10:02.980 --> 00:10:03.780
really cool things.

00:10:03.832 --> 00:10:05.746
And the fact that you're integrating it,

00:10:05.746 --> 00:10:07.626
it lives on your database like it's free.

00:10:07.626 --> 00:10:08.546
You know there is no,

00:10:08.546 --> 00:10:09.426
you don't have to like

00:10:09.746 --> 00:10:10.706
have some like,

00:10:11.026 --> 00:10:11.346
oh,

00:10:11.346 --> 00:10:12.626
I get 10,000 users for free,

00:10:12.626 --> 00:10:15.266
then I have to pay some price or like if I want to

00:10:15.266 --> 00:10:17.666
have my own domain associated with my login

00:10:17.666 --> 00:10:17.946
process,

00:10:17.946 --> 00:10:19.386
I have to like pay a fee for that.

00:10:19.386 --> 00:10:19.746
Or

00:10:20.176 --> 00:10:20.596
Clerk.

00:10:20.596 --> 00:10:22.556
If you want to like DO organizations.

00:10:22.636 --> 00:10:23.956
After 100 organizations,

00:10:23.956 --> 00:10:26.116
every organization that is created and has one

00:10:26.116 --> 00:10:27.276
user is $1.

00:10:27.276 --> 00:10:29.516
So like that doesn't really scale pricing wise in

00:10:29.516 --> 00:10:29.916
my op.

00:10:30.118 --> 00:10:32.078
And then just like the ability to have your own

00:10:32.078 --> 00:10:34.758
like really nice looking components that,

00:10:34.838 --> 00:10:36.638
for authentication that blend in with your

00:10:36.638 --> 00:10:37.278
application.

00:10:37.278 --> 00:10:39.678
It's like entirely up to you to implement the

00:10:39.678 --> 00:10:41.118
styling of those components.

00:10:41.118 --> 00:10:42.198
What I've noticed with Clerk,

00:10:42.198 --> 00:10:44.118
a lot of the components that you use right out of

00:10:44.118 --> 00:10:44.558
the box,

00:10:44.558 --> 00:10:46.838
they just don't look great on a website that like

00:10:46.838 --> 00:10:48.918
isn't just like white or just black.

00:10:48.998 --> 00:10:49.638
Like they just,

00:10:49.638 --> 00:10:51.158
if you have like an interesting theme,

00:10:51.478 --> 00:10:52.758
those components don't look good.

00:10:52.838 --> 00:10:54.878
And if you want like the branding of Clerk

00:10:54.878 --> 00:10:55.278
removed,

00:10:55.278 --> 00:10:57.158
you have to like be a premium user.

00:10:57.158 --> 00:10:59.278
So like stuff like that just kind of like turns me

00:10:59.278 --> 00:10:59.478
off.

00:10:59.478 --> 00:11:00.828
If I'm rolling all of my

00:11:01.138 --> 00:11:02.538
solutions from scratch and I'm,

00:11:02.538 --> 00:11:02.858
you know,

00:11:02.858 --> 00:11:03.738
I'm building this stuff out,

00:11:03.738 --> 00:11:05.818
it's like I don't really want to pay for Auth

00:11:05.818 --> 00:11:07.498
unless there's like a true need for it.

00:11:07.498 --> 00:11:10.338
Like if I'm building for enterprises and you know,

00:11:10.338 --> 00:11:10.538
like,

00:11:10.538 --> 00:11:13.658
I want work OS to take a lot of that complexity

00:11:13.658 --> 00:11:14.240
away from me.

00:11:14.240 --> 00:11:16.694
Now the most important thing to understand about

00:11:16.804 --> 00:11:18.954
to understand about Better Auth is

00:11:19.514 --> 00:11:20.994
every single thing that you add.

00:11:20.994 --> 00:11:23.434
Whenever you add like a database,

00:11:23.514 --> 00:11:25.194
whenever you add a plugin,

00:11:25.194 --> 00:11:26.234
whenever you add

00:11:26.324 --> 00:11:27.354
some type of provider,

00:11:27.844 --> 00:11:29.204
essentially what happens is

00:11:29.684 --> 00:11:31.364
under the hood of Better Auth,

00:11:31.444 --> 00:11:33.644
they've created a whole bunch of like SQL

00:11:33.644 --> 00:11:34.724
generators which

00:11:35.044 --> 00:11:37.844
will generate SQL statements that you can,

00:11:37.844 --> 00:11:39.044
or SQL like table,

00:11:39.044 --> 00:11:41.244
create statements that you can run against your

00:11:41.244 --> 00:11:41.804
database.

00:11:41.804 --> 00:11:45.004
So like when you first start with Better Auth,

00:11:45.004 --> 00:11:47.564
you're going to have like a basic user table,

00:11:47.564 --> 00:11:48.244
session table,

00:11:48.244 --> 00:11:48.964
account table,

00:11:49.354 --> 00:11:51.914
and that's going to have like a specific schema.

00:11:51.914 --> 00:11:53.354
Now let's say you bring in a plugin,

00:11:53.354 --> 00:11:54.314
like a stripe plugin,

00:11:54.904 --> 00:11:56.104
you can generate the,

00:11:56.264 --> 00:11:58.824
the necessary tables for that stripe plugin and it

00:11:58.824 --> 00:12:01.824
will also modify your user table with like a

00:12:01.824 --> 00:12:03.384
stripe ID as well.

00:12:03.384 --> 00:12:03.704
So,

00:12:03.704 --> 00:12:04.824
or stripe customer id.

00:12:04.824 --> 00:12:05.384
So like

00:12:06.114 --> 00:12:08.994
they've really thought through how to model data

00:12:09.074 --> 00:12:11.514
for authentication and all of these products.

00:12:11.514 --> 00:12:13.394
And that's something that I really like about this

00:12:13.394 --> 00:12:13.874
is because

00:12:14.514 --> 00:12:16.674
so many times when I'm building out a application,

00:12:16.674 --> 00:12:18.594
I'll kind of like build out this data model for

00:12:18.594 --> 00:12:19.754
managing users and stuff.

00:12:19.754 --> 00:12:20.674
And then over time

00:12:21.454 --> 00:12:22.934
things start to change and I'm like,

00:12:22.934 --> 00:12:23.134
oh,

00:12:23.134 --> 00:12:24.054
I wish I did it differently.

00:12:24.054 --> 00:12:25.614
But because it's your data model,

00:12:25.614 --> 00:12:26.174
it's really,

00:12:26.174 --> 00:12:28.134
really hard to like make substantial changes to

00:12:28.134 --> 00:12:28.414
it.

00:12:28.654 --> 00:12:29.054
But

00:12:29.994 --> 00:12:31.954
Better Auth has done such a good job at like

00:12:31.954 --> 00:12:34.434
saying these are like really really concrete ways

00:12:34.434 --> 00:12:35.514
of handling specific

00:12:35.914 --> 00:12:38.314
authentication use cases that the data models that

00:12:38.314 --> 00:12:40.714
they generate out of the box work really well and

00:12:40.714 --> 00:12:41.434
are actually really,

00:12:41.434 --> 00:12:42.234
really flexible.

00:12:42.394 --> 00:12:44.194
So the very first thing that we're going to do is

00:12:44.194 --> 00:12:46.634
we're going to focus on configuring better auth at

00:12:46.634 --> 00:12:47.594
the base of our project

00:12:47.994 --> 00:12:50.554
so we can create the necessary tables to,

00:12:50.834 --> 00:12:51.554
to add to,

00:12:52.164 --> 00:12:53.844
our D1 database.

00:12:54.244 --> 00:12:56.524
And that's going to basically power the rest of

00:12:56.524 --> 00:12:57.564
our authentication flow.

00:12:57.564 --> 00:12:59.004
Once we have that information in the,

00:12:59.004 --> 00:12:59.820
in our tables,



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.087 --> 00:00:02.487
So to understand how Better Auth is going to fit

00:00:02.487 --> 00:00:04.087
into our current data workflow,

00:00:04.167 --> 00:00:06.807
let's quickly go over how we're currently using

00:00:06.807 --> 00:00:07.327
Drizzle.

00:00:07.327 --> 00:00:07.548
Right now,

00:00:07.548 --> 00:00:09.828
currently we are creating our tables manually

00:00:09.908 --> 00:00:12.788
inside of the Cloudflare D1 studio.

00:00:13.108 --> 00:00:14.628
Once those tables are created,

00:00:14.628 --> 00:00:16.868
we're running a Drizzle poll command which is

00:00:16.868 --> 00:00:19.988
basically saying configuring Drizzle on our inside

00:00:19.988 --> 00:00:21.548
of our IDE in our code base and,

00:00:21.698 --> 00:00:22.578
and then we're

00:00:22.898 --> 00:00:25.058
providing the authentication to our database and

00:00:25.058 --> 00:00:26.898
then we're running poll and that's taking those

00:00:26.898 --> 00:00:29.418
table definitions and it's creating actual

00:00:29.418 --> 00:00:31.778
JavaScript drizzle schemas out of them.

00:00:32.018 --> 00:00:33.138
Once we have those schemas,

00:00:33.138 --> 00:00:34.898
we're able to use those in our code base right

00:00:34.898 --> 00:00:35.198
now,

00:00:35.198 --> 00:00:36.617
by basically creating queries,

00:00:36.617 --> 00:00:38.778
interfacing with the database and then using these

00:00:38.778 --> 00:00:41.298
schemas to give us type safe interaction with our

00:00:41.298 --> 00:00:41.578
data.

00:00:42.138 --> 00:00:42.538
Now

00:00:42.938 --> 00:00:43.338
what

00:00:43.738 --> 00:00:44.378
we currently,

00:00:44.698 --> 00:00:46.378
or basically what we're going to

00:00:46.698 --> 00:00:49.298
move to with this new model is this Drizzle

00:00:49.298 --> 00:00:50.538
workflow is going to stay the same,

00:00:50.888 --> 00:00:52.888
but we're going to introduce Better Auth and

00:00:52.968 --> 00:00:53.688
Better Auth.

00:00:54.008 --> 00:00:56.648
The Drizzle adapter for Better Auth is.

00:00:57.048 --> 00:00:57.728
It's okay,

00:00:57.728 --> 00:01:00.168
there is some like quirks with it that I do think

00:01:00.168 --> 00:01:02.128
we're going to kind of like go through just so you

00:01:02.128 --> 00:01:02.568
can understand.

00:01:02.648 --> 00:01:04.208
And I do think once you kind of understand this

00:01:04.208 --> 00:01:06.528
pattern and some of the edge cases you might run

00:01:06.528 --> 00:01:06.808
into,

00:01:06.888 --> 00:01:08.568
you'll be able to roll your own Auth,

00:01:08.748 --> 00:01:11.148
using Drizzle and Better Auth in the future with

00:01:11.148 --> 00:01:12.588
really any database provider.

00:01:13.148 --> 00:01:16.518
So we'll start by configuring Better Authentic to

00:01:16.518 --> 00:01:17.638
essentially say,

00:01:17.638 --> 00:01:17.918
hey,

00:01:17.918 --> 00:01:19.718
we're going to have certain plugins,

00:01:19.718 --> 00:01:21.118
we're going to need our,

00:01:21.118 --> 00:01:21.638
you know,

00:01:21.638 --> 00:01:25.038
normal authentication tables and maybe we want

00:01:25.038 --> 00:01:27.358
like other plugins like organizations or Stripe.

00:01:27.358 --> 00:01:28.478
We're not going to do that right now.

00:01:28.478 --> 00:01:28.808
But

00:01:28.828 --> 00:01:29.188
you'll,

00:01:29.188 --> 00:01:31.108
you'll understand how as we kind of go through

00:01:31.108 --> 00:01:31.388
this,

00:01:31.787 --> 00:01:33.028
once that's configured,

00:01:33.028 --> 00:01:34.108
we're going to point

00:01:34.258 --> 00:01:36.728
a command that Better Auth gives us through the

00:01:36.728 --> 00:01:39.968
CLI to basically look at this configuration and

00:01:39.968 --> 00:01:40.768
then it's going to

00:01:41.338 --> 00:01:42.298
generate schemas.

00:01:42.298 --> 00:01:43.858
Now there's two things that we could do here.

00:01:43.858 --> 00:01:47.298
We could technically just like generate raw SQL

00:01:47.298 --> 00:01:48.458
statements or

00:01:49.098 --> 00:01:50.758
because we're already using Drizzle,

00:01:50.758 --> 00:01:53.598
we can pass in a Drizzle adapter and then Better

00:01:53.598 --> 00:01:55.973
Auth will create actual Drizzle schemas.

00:01:56.018 --> 00:01:58.338
Now once those Drizzle schemas are created,

00:01:58.498 --> 00:02:01.538
we'll wire it into our existing Drizzle

00:02:01.538 --> 00:02:02.258
Configuration

00:02:02.658 --> 00:02:04.978
and then we'll be able to generate the SQL from

00:02:04.978 --> 00:02:06.178
those Drizzle schemas.

00:02:06.818 --> 00:02:07.778
We can run those

00:02:07.838 --> 00:02:09.458
we can create those tables manually once we get

00:02:09.458 --> 00:02:10.718
those schemas like those table

00:02:10.918 --> 00:02:12.078
definitions created

00:02:12.478 --> 00:02:14.918
and then we'll be able to basically just use our

00:02:14.918 --> 00:02:16.078
schemas for our auth

00:02:16.138 --> 00:02:18.558
the same way we use other tables in our database.

00:02:18.638 --> 00:02:20.918
So I know that this is very abstract.

00:02:20.918 --> 00:02:22.878
It's going to become much more concrete in just a

00:02:22.878 --> 00:02:23.045
minute.

00:02:23.148 --> 00:02:25.068
So what I've done here is I have

00:02:25.388 --> 00:02:26.988
headed over to our

00:02:27.388 --> 00:02:30.748
Data Ops package and I actually opened this in its

00:02:30.748 --> 00:02:31.068
own

00:02:31.518 --> 00:02:33.838
IDE window just because in this section we're

00:02:33.838 --> 00:02:35.988
only going to be touching the DataOps package.

00:02:37.278 --> 00:02:37.918
Now I currently

00:02:38.238 --> 00:02:40.998
have some boilerplate authentication stuff built

00:02:40.998 --> 00:02:42.078
out that we're going to modify.

00:02:42.318 --> 00:02:44.918
So what you'll likely be seeing is something like

00:02:44.918 --> 00:02:45.118
this.

00:02:45.118 --> 00:02:47.878
We have an auth gen folder and there's some

00:02:47.878 --> 00:02:48.638
boilerplate

00:02:48.738 --> 00:02:49.338
better auth

00:02:49.838 --> 00:02:52.118
configuration and this is basically just coming

00:02:52.118 --> 00:02:54.238
from the better auth documentation.

00:02:55.524 --> 00:02:56.834
If you click on Getting Started

00:02:57.394 --> 00:03:00.234
Basic usage you'll see there's some like basic

00:03:00.234 --> 00:03:02.514
usage on how you can create a better auth

00:03:02.514 --> 00:03:02.984
configuration.

00:03:03.294 --> 00:03:06.174
And this type of method is used to one generate

00:03:06.194 --> 00:03:09.494
our tables through the cli but it's also used to

00:03:09.494 --> 00:03:11.294
integrate into our application code

00:03:11.544 --> 00:03:12.664
during runtime.

00:03:12.664 --> 00:03:13.064
So

00:03:13.504 --> 00:03:15.264
what we're going to do is we can just look at a

00:03:15.264 --> 00:03:15.984
few different things here.

00:03:15.984 --> 00:03:18.064
What we care about is we care about Google so we

00:03:18.064 --> 00:03:19.104
can head over to the

00:03:19.604 --> 00:03:21.484
provider and then you're going to notice when you

00:03:21.484 --> 00:03:23.684
configure better auth you basically need to pass

00:03:23.684 --> 00:03:24.554
in a provider.

00:03:24.974 --> 00:03:27.054
so it takes Google and it takes like a client ID

00:03:27.054 --> 00:03:27.494
and secret.

00:03:27.494 --> 00:03:29.134
We're going to do this in a later video.

00:03:30.254 --> 00:03:32.334
and then the other thing that we care about is

00:03:32.334 --> 00:03:33.294
actual databases.

00:03:33.614 --> 00:03:34.014
So

00:03:35.534 --> 00:03:37.814
if we head down to this databases section you're

00:03:37.814 --> 00:03:39.094
going to see that there's some basic

00:03:39.094 --> 00:03:40.814
configurations and this is just like

00:03:40.884 --> 00:03:42.954
this is basically just having like some of these

00:03:42.954 --> 00:03:45.194
really popular libraries for interacting with

00:03:45.194 --> 00:03:45.794
databases.

00:03:46.434 --> 00:03:48.834
So you have connection pool with MySQL,

00:03:49.084 --> 00:03:49.694
Postgres,

00:03:49.694 --> 00:03:50.654
you have this Postgres,

00:03:50.654 --> 00:03:51.694
this PG driver.

00:03:51.854 --> 00:03:54.454
And under the hood inside of this better auth it's

00:03:54.454 --> 00:03:56.014
using a library called Kingsley

00:03:56.384 --> 00:03:56.624
and

00:03:57.294 --> 00:03:59.444
it's like a very very very powerful kind of query

00:03:59.444 --> 00:04:02.484
builder kind of ORM similar to Drizzle just like I

00:04:02.484 --> 00:04:04.364
would say a little bit like more vetted.

00:04:04.364 --> 00:04:06.644
It's older and it's used by a lot of like

00:04:06.644 --> 00:04:08.164
enterprise level code bases.

00:04:09.114 --> 00:04:11.313
now what you're going to notice is if you look at

00:04:11.313 --> 00:04:11.794
SQLite,

00:04:11.794 --> 00:04:13.834
you're basically just passing in this like SQLite

00:04:13.914 --> 00:04:16.554
database that's just creating a database inside of

00:04:16.554 --> 00:04:17.074
your code base.

00:04:17.074 --> 00:04:18.474
And this is obviously not what we're doing.

00:04:18.554 --> 00:04:19.914
We're going to be using D1.

00:04:20.154 --> 00:04:20.714
Luckily,

00:04:20.874 --> 00:04:21.674
if you

00:04:21.994 --> 00:04:23.074
don't have like,

00:04:23.074 --> 00:04:25.274
if you're not using these out of the box libraries

00:04:25.274 --> 00:04:26.354
to interface with your data,

00:04:26.354 --> 00:04:26.714
especially

00:04:27.174 --> 00:04:27.894
server of this world,

00:04:28.054 --> 00:04:29.734
you're typically going to be using Drizzle.

00:04:29.734 --> 00:04:32.614
You'll be using a database that basically has a

00:04:32.614 --> 00:04:35.454
proxy in front of it that proxies your request via

00:04:35.454 --> 00:04:36.134
HTTP.

00:04:36.614 --> 00:04:37.014
And

00:04:37.334 --> 00:04:39.934
for that type of setup they have this adapter and

00:04:39.934 --> 00:04:42.214
this is basically a Drizzle adapter where instead

00:04:42.214 --> 00:04:44.294
of passing in like a SQLite database,

00:04:44.374 --> 00:04:46.054
you pass in the Drizzle adapter,

00:04:46.214 --> 00:04:48.614
you give it the database name and then you give it

00:04:48.614 --> 00:04:50.214
like what type of provider it is.

00:04:51.014 --> 00:04:52.854
So we're basically going to be following this

00:04:52.854 --> 00:04:55.334
setup for our current implementation because we're

00:04:55.334 --> 00:04:56.253
already using Drizzle.

00:04:56.558 --> 00:04:58.758
So heading back over to our code base,

00:04:58.758 --> 00:05:00.558
what we're first going to do is we're going to

00:05:00.558 --> 00:05:03.078
want to go into our source and we can create a new

00:05:03.078 --> 00:05:03.505
file.

00:05:03.505 --> 00:05:05.100
This new file can just be called

00:05:05.420 --> 00:05:05.820
auth

00:05:06.300 --> 00:05:06.940
ts.

00:05:09.906 --> 00:05:11.747
Let's go ahead and import a few things that we

00:05:11.747 --> 00:05:12.227
care about.

00:05:12.307 --> 00:05:13.947
So what I'm going to do is I'm going to,

00:05:13.947 --> 00:05:15.947
in a similar way to what we're doing with our

00:05:15.947 --> 00:05:18.507
database where we're kind of having this DB

00:05:18.507 --> 00:05:20.607
instance that's going to be instantiated

00:05:20.627 --> 00:05:21.607
during runtime.

00:05:21.687 --> 00:05:23.447
We're going to do something similar with auth.

00:05:23.527 --> 00:05:24.967
So we're going to create this auth,

00:05:25.147 --> 00:05:25.707
variable

00:05:26.107 --> 00:05:28.227
that is going to have the return type of Better

00:05:28.227 --> 00:05:28.587
Auth.

00:05:28.747 --> 00:05:29.307
Now this,

00:05:29.387 --> 00:05:31.467
this setup is going to basically help us kind of

00:05:31.567 --> 00:05:32.127
do two things.

00:05:32.127 --> 00:05:33.447
We're going to be able to integrate with our

00:05:33.447 --> 00:05:34.287
application but also

00:05:34.767 --> 00:05:37.247
manage our configuration with the cli.

00:05:37.407 --> 00:05:39.887
So I'm going to go ahead and pull in this

00:05:40.667 --> 00:05:41.027
called

00:05:41.667 --> 00:05:42.787
Create Better Auth.

00:05:43.027 --> 00:05:45.307
This is something that we're going to define and

00:05:45.307 --> 00:05:47.427
essentially what we're going to do is we are going

00:05:47.427 --> 00:05:48.947
to pass in a database

00:05:49.277 --> 00:05:51.197
and this database can be any type of database.

00:05:51.197 --> 00:05:52.637
Ours is going to be a

00:05:52.957 --> 00:05:55.237
Drizzle adapter with the Drizzle database passed

00:05:55.237 --> 00:05:55.757
into it.

00:05:56.077 --> 00:05:58.237
And then we're optionally going to have some

00:05:58.737 --> 00:05:59.377
configuration.

00:05:59.377 --> 00:06:01.657
And then obviously as you bring in more providers,

00:06:01.657 --> 00:06:03.217
you can kind of extend this logic.

00:06:03.777 --> 00:06:04.177
Now,

00:06:04.407 --> 00:06:06.607
we're going to configure this to basically say

00:06:06.607 --> 00:06:07.887
we're not going to do email password,

00:06:07.887 --> 00:06:09.743
we're going to allow our provider to

00:06:09.743 --> 00:06:10.486
essentially

00:06:10.686 --> 00:06:13.006
just totally manage authentication for us.

00:06:13.246 --> 00:06:15.966
And then what we're going to do is we're going to

00:06:15.966 --> 00:06:18.246
be passing in our Google tokens into the Google

00:06:18.246 --> 00:06:18.646
provider.

00:06:18.646 --> 00:06:18.926
And

00:06:19.226 --> 00:06:21.066
the reason why this is optional and why these

00:06:21.066 --> 00:06:23.306
default to an empty string is because when we are

00:06:23.386 --> 00:06:24.506
generating our schemas,

00:06:24.506 --> 00:06:26.026
we're not going to be passing in like Google

00:06:26.026 --> 00:06:26.786
credentials and stuff.

00:06:26.786 --> 00:06:27.986
There's really no need for it.

00:06:27.998 --> 00:06:30.603
but when we actually do this during like the

00:06:30.603 --> 00:06:31.563
running of the application,

00:06:31.563 --> 00:06:32.963
we're going to want to be able to feed this

00:06:32.963 --> 00:06:33.660
information in.

00:06:33.660 --> 00:06:35.071
Next thing that we're going to do is we're going

00:06:35.071 --> 00:06:36.351
to create a method called

00:06:36.991 --> 00:06:37.791
get off.

00:06:37.819 --> 00:06:39.843
And what get auth is going to do is it's going to

00:06:39.843 --> 00:06:40.803
take in the

00:06:41.563 --> 00:06:43.163
Google credentials and these are going to be

00:06:43.163 --> 00:06:44.763
required because this is actually going to be used

00:06:44.763 --> 00:06:45.662
inside of our code base.

00:06:45.662 --> 00:06:47.092
And then we will be

00:06:47.492 --> 00:06:49.172
using this create better Auth

00:06:49.942 --> 00:06:50.982
function that we have.

00:06:51.462 --> 00:06:53.782
And we're going to pass in a drizzle adapter

00:06:54.502 --> 00:06:56.622
as the database and we're going to be passing in

00:06:56.622 --> 00:06:57.662
our get database,

00:06:57.662 --> 00:07:00.262
which is our logic for actually extracting our D1

00:07:00.262 --> 00:07:00.702
database.

00:07:00.702 --> 00:07:03.022
Now I know there's a few layers of abstraction

00:07:03.022 --> 00:07:03.222
here,

00:07:03.222 --> 00:07:05.582
but it will start to make sense as you keep

00:07:05.582 --> 00:07:06.902
building why this is nice.

00:07:06.902 --> 00:07:09.022
Just because everything's kind of self contained

00:07:09.022 --> 00:07:11.372
in one area and if you want to make any types of,

00:07:11.522 --> 00:07:13.202
of like major configuration change,

00:07:13.362 --> 00:07:15.002
you really only have to do it in one place.

00:07:15.002 --> 00:07:16.642
You're not like going throughout your entire app

00:07:16.642 --> 00:07:18.442
trying to find every single time you've defined

00:07:18.442 --> 00:07:21.082
something and then also like reconfiguring it.

00:07:21.142 --> 00:07:21.542
All right,

00:07:21.542 --> 00:07:23.702
so we're passing in Google as well and then we're

00:07:23.702 --> 00:07:24.662
returning better Auth.

00:07:25.536 --> 00:07:27.936
So now the goal is to essentially create,

00:07:27.936 --> 00:07:29.296
to take this better Auth

00:07:29.696 --> 00:07:31.376
and to come over to

00:07:31.936 --> 00:07:34.252
our Auth gen folder into Auth TS

00:07:34.262 --> 00:07:36.822
and then what we can do is we can replace this.

00:07:37.222 --> 00:07:37.622
So

00:07:37.832 --> 00:07:38.992
we're actually going to,

00:07:38.992 --> 00:07:40.712
I think we're going to have some issues importing

00:07:40.712 --> 00:07:41.032
this.

00:07:41.512 --> 00:07:44.272
The main reason is because our TS config is

00:07:44.272 --> 00:07:44.712
specific,

00:07:44.712 --> 00:07:46.792
is configured in a specific way for this build.

00:07:47.512 --> 00:07:49.512
So what we're going to do is we're also going to

00:07:49.512 --> 00:07:49.832
include

00:07:51.352 --> 00:07:52.472
Auth gen in here.

00:07:53.272 --> 00:07:55.592
And then one thing that we'll have to do if we

00:07:55.592 --> 00:07:57.552
include Auth gen in here is we'll also have to

00:07:57.552 --> 00:07:59.112
like reconfigure our exports.

00:07:59.112 --> 00:08:00.237
But we'll do that in just a minute.

00:08:00.491 --> 00:08:03.891
now when we head over to our Auth TS inside of

00:08:03.891 --> 00:08:04.491
auth gen,

00:08:04.571 --> 00:08:06.091
we should be able to import this.

00:08:06.344 --> 00:08:06.415
I'll

00:08:06.415 --> 00:08:07.414
delete these as we can,

00:08:07.414 --> 00:08:08.196
kind of clean them up.

00:08:08.196 --> 00:08:10.533
And then the next thing that we're going to do is

00:08:10.533 --> 00:08:13.160
we're basically going to take a drizzle adapter,

00:08:13.179 --> 00:08:14.459
pass it inside of here,

00:08:15.659 --> 00:08:16.939
make sure we import this

00:08:17.212 --> 00:08:18.463
and then we're going to provide two things.

00:08:18.463 --> 00:08:19.263
We're going to provide

00:08:19.894 --> 00:08:20.654
an empty database,

00:08:20.654 --> 00:08:21.734
so basically an object,

00:08:22.374 --> 00:08:24.694
and then we're going to pass in a

00:08:25.654 --> 00:08:28.374
provider which is going to be SQLite.

00:08:29.078 --> 00:08:29.664
All right,

00:08:29.744 --> 00:08:31.264
so now that this is set up,

00:08:31.344 --> 00:08:34.464
we can kind of start like actually working on the

00:08:34.754 --> 00:08:36.444
schema generation aspect of it.

00:08:37.084 --> 00:08:39.324
So what we're going to do is we're going to come

00:08:39.324 --> 00:08:41.696
over to our package JSON file

00:08:41.696 --> 00:08:43.338
and we have this better auth

00:08:43.788 --> 00:08:45.158
we have this better authentic

00:08:45.788 --> 00:08:46.668
path or

00:08:47.308 --> 00:08:50.028
generator essentially it's using the better auth

00:08:50.028 --> 00:08:52.548
cli and it's running generate and it's basically

00:08:52.548 --> 00:08:55.788
saying our config file is located in auth gen auth

00:08:55.788 --> 00:08:56.188
ts,

00:08:56.188 --> 00:08:57.548
which is this file that we just

00:08:59.408 --> 00:09:02.048
now we're going to provide one other thing which

00:09:02.048 --> 00:09:03.488
is going to be an output.

00:09:03.488 --> 00:09:05.728
Basically the output is going to be a schema

00:09:06.368 --> 00:09:08.528
and what we can do is we can come over here

00:09:09.728 --> 00:09:11.568
and we can basically say we're going to go into

00:09:11.568 --> 00:09:13.688
source drizzle out auth schema.

00:09:13.688 --> 00:09:15.248
So what that's going to do is it's going to find

00:09:15.248 --> 00:09:16.398
our drizzle out folder

00:09:16.948 --> 00:09:19.188
and it's going to generate an output schema

00:09:19.188 --> 00:09:21.205
alongside our current drizzle schema.

00:09:21.246 --> 00:09:23.406
So we should be able to actually run this right

00:09:23.406 --> 00:09:23.726
now.

00:09:23.726 --> 00:09:25.966
So I'm going to say pnpm run

00:09:26.606 --> 00:09:27.886
better auth generate.

00:09:28.846 --> 00:09:30.766
It might give a few warnings because

00:09:31.086 --> 00:09:33.526
for example it's missing the client ID and client

00:09:33.526 --> 00:09:34.246
secret for Google.

00:09:34.246 --> 00:09:35.086
That's totally fine.

00:09:35.566 --> 00:09:38.006
So we just hit yes and then what we're going to

00:09:38.006 --> 00:09:39.849
notice is our auth schema

00:09:39.937 --> 00:09:41.137
is now created.

00:09:41.137 --> 00:09:42.897
So you can see that There is the

00:09:43.217 --> 00:09:45.697
SQLite table representation and drizzle

00:09:45.907 --> 00:09:46.947
of a specific,

00:09:46.947 --> 00:09:48.707
like of these specific tables.

00:09:48.787 --> 00:09:49.187
So

00:09:49.487 --> 00:09:50.817
we have a user,

00:09:50.817 --> 00:09:52.017
we have a session,

00:09:52.337 --> 00:09:53.217
we have an account

00:09:53.617 --> 00:09:54.017
and

00:09:54.577 --> 00:09:55.456
we have

00:09:55.937 --> 00:09:56.722
verification.

00:09:56.848 --> 00:09:58.768
The next thing we're going to want to do is we're

00:09:58.768 --> 00:10:00.128
going to want to get the actual

00:10:01.378 --> 00:10:04.098
the actual SQL create statements for these tables

00:10:04.098 --> 00:10:04.818
so we can go

00:10:05.138 --> 00:10:07.938
create these tables in our D1 database.

00:10:08.418 --> 00:10:09.208
So what we're going to do,

00:10:09.358 --> 00:10:11.438
do in order to do that is we're going to come into

00:10:11.438 --> 00:10:13.678
here and I'm going to delete meta because this is

00:10:13.678 --> 00:10:14.798
A generated file.

00:10:15.358 --> 00:10:17.638
And we're not actually using this to manage our

00:10:17.638 --> 00:10:18.078
schemas.

00:10:18.078 --> 00:10:19.758
We're just kind of like getting a SQL

00:10:20.238 --> 00:10:20.638
statement.

00:10:21.038 --> 00:10:22.718
I'm going to delete the SQL file.

00:10:22.798 --> 00:10:25.878
So in this folder we have all schema relations and

00:10:25.878 --> 00:10:26.883
schema at this point.

00:10:27.010 --> 00:10:28.812
Now we can head over to Drizzle Config

00:10:28.812 --> 00:10:31.334
and inside of here we're going to add one property

00:10:31.334 --> 00:10:33.534
called schema and this is going to point to the

00:10:33.534 --> 00:10:34.534
schemas in our project.

00:10:34.694 --> 00:10:36.424
So it's pointing to the.

00:10:36.574 --> 00:10:38.254
This schema which is our

00:10:38.844 --> 00:10:41.044
actual like business logic schema and also auth

00:10:41.044 --> 00:10:41.644
schema.

00:10:41.884 --> 00:10:44.084
For now we can probably just remove this because

00:10:44.084 --> 00:10:45.644
we don't necessarily like,

00:10:45.884 --> 00:10:47.884
we're not necessarily using this feature for

00:10:48.124 --> 00:10:48.924
schema management.

00:10:49.084 --> 00:10:50.724
We're just going to be getting a,

00:10:50.724 --> 00:10:53.684
some SQL like we're trying to generate a SQL file

00:10:53.684 --> 00:10:54.684
with our create statement.

00:10:54.764 --> 00:10:55.164
So

00:10:55.484 --> 00:10:56.204
I'm going to,

00:10:56.444 --> 00:10:57.484
we're going to go like this.

00:10:57.764 --> 00:11:00.084
I should have a command in here already for us

00:11:00.084 --> 00:11:01.004
called Generate.

00:11:01.004 --> 00:11:03.724
This is running the Drizzle Kit command and it's

00:11:03.724 --> 00:11:06.684
basically going to generate SQL file like a SQL

00:11:06.684 --> 00:11:09.124
create statements for so PNPM run

00:11:09.684 --> 00:11:10.404
generate.

00:11:11.444 --> 00:11:13.124
Now we can head over here and what we're going to

00:11:13.124 --> 00:11:14.314
notice is we have these

00:11:14.314 --> 00:11:15.464
we essentially have these

00:11:16.254 --> 00:11:18.214
create statements that's been

00:11:18.344 --> 00:11:18.694
spit out.

00:11:18.694 --> 00:11:20.054
So our user table,

00:11:20.054 --> 00:11:20.813
our session,

00:11:20.813 --> 00:11:22.494
our account and our verification.

00:11:22.732 --> 00:11:25.292
So we can go ahead and copy all of these

00:11:28.857 --> 00:11:30.377
and we can head over to

00:11:31.497 --> 00:11:32.284
Cloudflare.

00:11:32.322 --> 00:11:34.442
We're going to navigate over to our storage and

00:11:34.442 --> 00:11:35.082
databases.

00:11:35.082 --> 00:11:36.322
D1 SQL database.

00:11:36.322 --> 00:11:37.442
We'll start with Stage.

00:11:38.002 --> 00:11:39.282
Let's explore data

00:11:39.682 --> 00:11:41.602
and I'm going to pass these guys in.

00:11:41.602 --> 00:11:43.482
So these are all of the create statements that we

00:11:43.482 --> 00:11:43.762
need.

00:11:43.771 --> 00:11:45.532
Going to come over here and I'm going to say

00:11:46.342 --> 00:11:47.152
run all.

00:11:47.442 --> 00:11:49.642
So that's executing six different statements.

00:11:49.642 --> 00:11:50.082
Perfect.

00:11:50.082 --> 00:11:51.307
So we've created those tables.

00:11:51.679 --> 00:11:54.439
Now let's head over to our production database and

00:11:54.439 --> 00:11:55.679
let's do the same thing for that one.

00:11:55.759 --> 00:11:57.279
So we'll go over to explore data,

00:11:57.919 --> 00:11:59.039
pass these guys in.

00:11:59.439 --> 00:12:01.119
We're just going to run all statements.

00:12:01.359 --> 00:12:02.964
It should create all six as well.

00:12:03.000 --> 00:12:05.240
Now we have six new tables for managing

00:12:05.240 --> 00:12:05.854
authentication.

00:12:05.906 --> 00:12:07.626
One of the last things we're going to have to do

00:12:07.626 --> 00:12:09.186
in terms of configuration for

00:12:09.786 --> 00:12:10.326
Drizzle

00:12:10.726 --> 00:12:11.126
is

00:12:11.446 --> 00:12:13.766
in the actual client that we're going to be using.

00:12:13.926 --> 00:12:14.966
So inside of source

00:12:15.736 --> 00:12:16.776
auth ts,

00:12:17.240 --> 00:12:19.920
where we are passing in our actual Drizzle

00:12:19.920 --> 00:12:20.440
adapter,

00:12:20.760 --> 00:12:23.320
we're also now going to have to provide references

00:12:23.400 --> 00:12:24.600
to those schemas.

00:12:25.080 --> 00:12:26.880
So we're going to have to provide a reference to

00:12:26.880 --> 00:12:27.880
the user schema

00:12:33.080 --> 00:12:34.600
and the account schema.

00:12:36.440 --> 00:12:38.360
And the last one is verification.

00:12:39.560 --> 00:12:41.160
Now I like manually,

00:12:41.160 --> 00:12:43.760
like I like manually configuring all this stuff

00:12:43.760 --> 00:12:44.680
and kind of doing it

00:12:45.020 --> 00:12:45.580
incrementally.

00:12:45.580 --> 00:12:48.460
Just because now we have context as to what

00:12:48.460 --> 00:12:48.860
tables.

00:12:48.860 --> 00:12:50.540
We have what those tables look like.

00:12:50.700 --> 00:12:52.380
And if we bring in another plugin,

00:12:52.380 --> 00:12:53.100
for example,

00:12:53.100 --> 00:12:55.180
if we were to come over to here

00:12:55.500 --> 00:12:58.860
and we were to say we want to configure a plugin

00:12:59.340 --> 00:13:01.700
and we want to make the plugin organizations.

00:13:01.700 --> 00:13:02.380
For example,

00:13:04.085 --> 00:13:05.285
when we run our

00:13:05.375 --> 00:13:05.765
our

00:13:06.965 --> 00:13:07.765
drizzle or,

00:13:07.765 --> 00:13:08.205
sorry,

00:13:08.205 --> 00:13:10.325
our better AUTH generate command,

00:13:10.685 --> 00:13:12.405
what's going to happen is we're going to get a new

00:13:12.405 --> 00:13:13.085
schema

00:13:13.865 --> 00:13:14.705
for organizations,

00:13:14.705 --> 00:13:15.985
and we can go through the same process.

00:13:16.145 --> 00:13:18.225
So whenever you make an update to the

00:13:18.225 --> 00:13:20.345
configuration at the better AUTH layer,

00:13:20.345 --> 00:13:21.705
you have to make sure you go through the process

00:13:21.705 --> 00:13:23.985
of actually like creating those schemas,

00:13:23.985 --> 00:13:25.015
making sure you get the

00:13:25.355 --> 00:13:27.115
the SQL statements for them and then make sure

00:13:27.115 --> 00:13:27.915
your table is.

00:13:27.995 --> 00:13:29.275
Those tables are created.

00:13:29.355 --> 00:13:31.115
But we're not going to worry about plugins for the

00:13:31.115 --> 00:13:31.595
time being.

00:13:33.115 --> 00:13:33.675
All right,

00:13:34.155 --> 00:13:36.475
so before we conclude,

00:13:36.635 --> 00:13:38.675
there's just a little bit of cleanup that we have

00:13:38.675 --> 00:13:40.835
to do if we head over to package,

00:13:40.835 --> 00:13:41.675
what you're going to not.

00:13:42.055 --> 00:13:43.655
I'm going to go ahead and it looks like we don't

00:13:43.655 --> 00:13:44.535
have DIST here.

00:13:44.855 --> 00:13:45.295
Okay.

00:13:45.295 --> 00:13:46.509
So if we head over to package

00:13:46.635 --> 00:13:47.035
and

00:13:47.334 --> 00:13:48.503
I think we'll just do it from here.

00:13:48.503 --> 00:13:50.383
So if we head over to

00:13:50.863 --> 00:13:52.522
our package JSON,

00:13:53.242 --> 00:13:55.482
what we're going to notice is these exports are

00:13:55.482 --> 00:13:57.842
actually not valid anymore because we modified

00:13:57.842 --> 00:13:59.802
what is included inside of our build.

00:13:59.962 --> 00:14:00.362
So

00:14:00.820 --> 00:14:01.220
the

00:14:02.120 --> 00:14:04.440
last thing that we're going to have to do here is

00:14:04.440 --> 00:14:06.280
we're going to just go ahead delete dist.

00:14:06.280 --> 00:14:07.360
We don't need it for the time being.

00:14:07.360 --> 00:14:08.960
I just want to show you what's going to happen if

00:14:08.960 --> 00:14:10.600
we say PNPM run build.

00:14:12.308 --> 00:14:13.308
Essentially the.

00:14:13.788 --> 00:14:16.108
Essentially what's happened is instead of all of

00:14:16.108 --> 00:14:18.148
our files being output just right here in the

00:14:18.148 --> 00:14:18.388
dist,

00:14:18.388 --> 00:14:20.828
we now have source and we now have AUTH gen.

00:14:21.068 --> 00:14:21.230
So

00:14:21.230 --> 00:14:22.730
you can delete DIST one more time.

00:14:23.140 --> 00:14:24.860
And what I'm going to do is I'm going to head over

00:14:24.860 --> 00:14:26.100
to the package JSON

00:14:26.580 --> 00:14:28.580
and everywhere where it says dist

00:14:28.900 --> 00:14:29.540
like this,

00:14:30.420 --> 00:14:32.604
we're just going to do a bulk update.

00:14:32.710 --> 00:14:34.330
I haven't done this in VS code in a long time.

00:14:34.330 --> 00:14:34.770
Okay.

00:14:34.930 --> 00:14:36.610
And then I'm going to also say

00:14:37.170 --> 00:14:37.730
source

00:14:39.330 --> 00:14:40.210
forward slash.

00:14:45.214 --> 00:14:45.454
Sorry.

00:14:45.454 --> 00:14:46.734
Let's just try that one more time.

00:14:47.761 --> 00:14:49.961
So just make sure we're updating the right stuff

00:14:49.961 --> 00:14:50.161
here.

00:14:50.161 --> 00:14:50.601
Yep.

00:14:50.601 --> 00:14:51.841
So we're going to update everything.

00:14:52.401 --> 00:14:52.841
All right,

00:14:52.841 --> 00:14:54.561
so now these should all be pointing at Source

00:14:54.561 --> 00:14:55.081
correctly.

00:14:55.081 --> 00:14:57.281
And then the last thing we're going to do is I

00:14:57.281 --> 00:14:58.881
actually have this point out the wrong thing.

00:14:58.881 --> 00:14:59.281
Originally,

00:14:59.281 --> 00:15:00.641
I had this in a better off

00:15:01.351 --> 00:15:01.791
folder,

00:15:01.791 --> 00:15:04.351
but it's just at the root level of Source.

00:15:04.351 --> 00:15:05.351
So we can delete that.

00:15:06.711 --> 00:15:07.991
We can delete that.

00:15:09.351 --> 00:15:11.591
And then now PNPM run build one more time.

00:15:16.023 --> 00:15:17.392
And now inside of Source,

00:15:17.392 --> 00:15:19.432
we have all the information that we need for this,

00:15:19.912 --> 00:15:22.312
and everything's exported in our client

00:15:22.312 --> 00:15:24.312
application is going to be able to pick it up.

00:15:24.392 --> 00:15:26.512
This is also something that's nice about the PNPM

00:15:26.512 --> 00:15:27.032
workspace.

00:15:27.032 --> 00:15:28.632
Notice that we change paths here,

00:15:29.042 --> 00:15:31.842
but because we're exporting it with these aliases,

00:15:32.162 --> 00:15:34.002
we don't have to change anything in the front end

00:15:34.162 --> 00:15:35.602
for all of our import statements.

00:15:35.602 --> 00:15:36.192
So that's pretty cool.

00:15:36.230 --> 00:15:37.750
So now that everything's configured,

00:15:37.830 --> 00:15:39.270
we have our tables created.

00:15:39.430 --> 00:15:41.030
Let's go wire this into,

00:15:42.230 --> 00:15:43.670
our client application.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.071 --> 00:00:00.631
Alright,

00:00:00.711 --> 00:00:02.711
so now that we have everything configured,

00:00:02.791 --> 00:00:04.871
what we're going to do is we're going to head over

00:00:04.871 --> 00:00:06.471
to our user application.

00:00:06.871 --> 00:00:09.391
I'm going to just CD into our apps user

00:00:09.391 --> 00:00:11.591
application and then I'm going to open it in its

00:00:11.591 --> 00:00:12.311
new window.

00:00:12.391 --> 00:00:12.508
So

00:00:14.573 --> 00:00:17.173
integrating better authentication is going to kind

00:00:17.173 --> 00:00:18.773
of have two different layers to it.

00:00:18.773 --> 00:00:20.533
There's going to be the backend integration.

00:00:20.533 --> 00:00:22.053
So so basically configuring

00:00:22.373 --> 00:00:24.453
our Better Auth client that we just set up,

00:00:24.543 --> 00:00:27.703
the actual like server side client to wire into

00:00:27.703 --> 00:00:29.423
some API routes and to make sure that

00:00:29.423 --> 00:00:31.023
authentication is working at that level

00:00:31.343 --> 00:00:34.343
and then we're also going to add some hooks inside

00:00:34.343 --> 00:00:35.743
of our client side code.

00:00:35.743 --> 00:00:37.383
So there's two layers to this.

00:00:37.383 --> 00:00:39.423
We're going to start by modifying the backend.

00:00:39.423 --> 00:00:42.703
So essentially we have this hono API and we're

00:00:42.703 --> 00:00:45.223
going to be wiring up our authentication at that

00:00:45.223 --> 00:00:45.983
layer as well.

00:00:46.143 --> 00:00:48.743
So better Auth has some pretty good documentation

00:00:48.743 --> 00:00:49.263
on this.

00:00:49.463 --> 00:00:51.303
it's actually insanely easy how

00:00:51.923 --> 00:00:52.803
simple it is to

00:00:53.063 --> 00:00:53.464
wire

00:00:53.464 --> 00:00:53.763
to

00:00:54.163 --> 00:00:55.383
integrate with better Auth.

00:00:55.383 --> 00:00:57.443
for a lot of these frameworks we can head over to

00:00:57.443 --> 00:00:57.883
guides

00:00:58.203 --> 00:00:59.283
or sorry not guides.

00:00:59.283 --> 00:01:00.363
It's going to be in

00:01:00.558 --> 00:01:01.167
integrations,

00:01:01.432 --> 00:01:04.574
back end is going to be hono and then what you're

00:01:04.574 --> 00:01:06.214
going to see here is really the only thing that we

00:01:06.214 --> 00:01:07.694
care about is this little section.

00:01:07.774 --> 00:01:09.374
We're going to be creating a

00:01:09.704 --> 00:01:11.794
handler that takes post and gets

00:01:12.264 --> 00:01:15.064
and everything that is at the route of API

00:01:15.464 --> 00:01:15.864
auth

00:01:16.264 --> 00:01:17.944
we're going to be handling it

00:01:18.104 --> 00:01:19.704
with the auth handler.

00:01:19.784 --> 00:01:21.424
This is essentially the object that we just

00:01:21.424 --> 00:01:21.864
created.

00:01:21.864 --> 00:01:24.024
So I'm just going to copy this little snippet of

00:01:24.024 --> 00:01:25.000
code because that's all we need

00:01:25.000 --> 00:01:27.084
and I will head over to our app ts

00:01:27.084 --> 00:01:27.954
inside of our

00:01:27.954 --> 00:01:28.814
user application

00:01:30.654 --> 00:01:31.294
and then

00:01:31.694 --> 00:01:33.814
just make sure we're using the right app instance

00:01:33.814 --> 00:01:34.094
here.

00:01:34.774 --> 00:01:37.254
And then we're going to say const auth

00:01:37.734 --> 00:01:39.550
and we are going to get off.

00:01:39.550 --> 00:01:41.536
This is going to be coming from our back end or

00:01:41.616 --> 00:01:44.736
our data ops package so we can import that as

00:01:44.736 --> 00:01:45.056
well.

00:01:46.576 --> 00:01:46.976
Auth

00:01:47.144 --> 00:01:47.977
or get

00:01:48.857 --> 00:01:49.257
auth

00:01:50.297 --> 00:01:50.697
from

00:01:56.184 --> 00:01:59.064
and the get off is going to take in two different

00:01:59.144 --> 00:01:59.464
things.

00:01:59.464 --> 00:02:01.784
It's basically going to take a client id.

00:02:02.634 --> 00:02:03.834
This is a Google client ID

00:02:04.554 --> 00:02:06.154
and it's going to take a

00:02:08.259 --> 00:02:09.059
client secret

00:02:12.579 --> 00:02:14.579
which is also going going to be coming from

00:02:14.579 --> 00:02:15.059
Google.

00:02:15.459 --> 00:02:17.298
So if you've never done this before,

00:02:17.298 --> 00:02:19.139
I do think that this section of the video

00:02:19.449 --> 00:02:20.441
is going to be pretty useful.

00:02:20.441 --> 00:02:22.930
We're going to want to go head over to a Google

00:02:22.930 --> 00:02:23.450
console.

00:02:23.450 --> 00:02:23.810
So

00:02:25.650 --> 00:02:27.890
I usually just search Google console And we're

00:02:27.890 --> 00:02:29.570
going to go to the Google Cloud console.

00:02:29.798 --> 00:02:33.078
And then inside of here what we're going to do is

00:02:33.158 --> 00:02:34.118
we're going to.

00:02:34.198 --> 00:02:35.398
If you haven't created an account,

00:02:35.398 --> 00:02:36.518
this might look a little bit different,

00:02:36.518 --> 00:02:38.478
but you'll basically just create an account with

00:02:38.478 --> 00:02:39.478
Google Cloud Console.

00:02:39.938 --> 00:02:42.038
inside of Here we have APIs and we have

00:02:42.038 --> 00:02:42.652
credentials.

00:02:42.772 --> 00:02:43.532
can go ahead and

00:02:43.852 --> 00:02:45.132
create some credentials.

00:02:45.292 --> 00:02:47.388
So let's create an OAuth client

00:02:47.405 --> 00:02:49.405
and then it's going to want us to configure a

00:02:49.405 --> 00:02:50.245
consent screen.

00:02:50.245 --> 00:02:52.125
So it's going to ask for some information about

00:02:52.205 --> 00:02:52.925
our product.

00:02:53.094 --> 00:02:54.374
So we can just call this

00:02:55.734 --> 00:02:56.854
Smart Links.

00:02:56.943 --> 00:02:58.400
I'll pass in my personal email.

00:02:58.872 --> 00:03:00.678
this is going to be externally facing

00:03:01.319 --> 00:03:02.599
some more contact information.

00:03:03.579 --> 00:03:03.899
I agree.

00:03:03.899 --> 00:03:04.517
And finish.

00:03:05.018 --> 00:03:05.458
All right,

00:03:05.458 --> 00:03:07.358
so from here we can go ahead and create an OAuth,

00:03:07.418 --> 00:03:07.898
client.

00:03:07.898 --> 00:03:09.978
The application is going to be a web application

00:03:10.538 --> 00:03:12.378
and we'll just call this Smart Links.

00:03:13.892 --> 00:03:16.163
We're going to start by adding a JavaScript

00:03:16.163 --> 00:03:16.723
origin.

00:03:16.803 --> 00:03:18.963
So right now we're developing in local host and we

00:03:18.963 --> 00:03:20.243
can go add more in the future.

00:03:20.323 --> 00:03:22.083
So we can say HTTP

00:03:28.913 --> 00:03:30.033
localhost3000.

00:03:30.209 --> 00:03:30.570
Oh,

00:03:31.230 --> 00:03:32.030
must be,

00:03:32.430 --> 00:03:33.710
must be forward slash,

00:03:33.710 --> 00:03:34.361
forward slash.

00:03:34.361 --> 00:03:36.946
We will also make sure we add some authorized

00:03:36.946 --> 00:03:37.906
redirect services.

00:03:38.066 --> 00:03:40.306
So basically it's going to be our base URL

00:03:40.306 --> 00:03:42.950
API auth callback Google.

00:03:42.950 --> 00:03:44.420
So this is the convention that

00:03:44.420 --> 00:03:46.330
better auth has and I do think they have some

00:03:46.330 --> 00:03:46.600
details.

00:03:46.670 --> 00:03:47.070
Details.

00:03:47.070 --> 00:03:48.430
If you go into authentication,

00:03:48.750 --> 00:03:49.950
you head over to Google,

00:03:50.270 --> 00:03:52.110
it's going to kind of walk you through this exact

00:03:52.110 --> 00:03:53.230
same process as well.

00:03:53.580 --> 00:03:55.115
they mentioned the different things to put

00:03:55.238 --> 00:03:57.037
Now we're going to go ahead and save and it

00:03:57.037 --> 00:03:58.958
mentions it might take five minutes for this to

00:03:58.958 --> 00:03:59.398
take effect.

00:03:59.798 --> 00:04:00.998
So we'll save this guy.

00:04:01.158 --> 00:04:02.238
And just so you know,

00:04:02.238 --> 00:04:03.478
I will be wiping this

00:04:03.548 --> 00:04:04.958
client in secret in the future.

00:04:05.118 --> 00:04:06.878
So there is no reason to

00:04:06.938 --> 00:04:07.258
you know,

00:04:07.258 --> 00:04:07.738
take these

00:04:08.618 --> 00:04:10.698
so we can go ahead and copy our client id.

00:04:10.766 --> 00:04:13.086
And essentially what we're going to want to do is

00:04:13.086 --> 00:04:13.806
server side

00:04:14.526 --> 00:04:16.726
we're going to want to make sure that we pass in

00:04:16.726 --> 00:04:17.086
our

00:04:17.486 --> 00:04:19.726
we pass in the client ID and the secret.

00:04:20.206 --> 00:04:21.326
So in order to keep these

00:04:21.726 --> 00:04:22.166
safe,

00:04:22.166 --> 00:04:24.206
what we're going to do is we are going to head

00:04:24.206 --> 00:04:25.246
over to our

00:04:25.586 --> 00:04:26.626
emv file

00:04:27.106 --> 00:04:29.186
and what we can do is we can go ahead and

00:04:29.506 --> 00:04:29.796
add

00:04:30.296 --> 00:04:31.496
Google client ID

00:04:33.452 --> 00:04:34.732
and a Google client secret.

00:04:44.989 --> 00:04:46.109
Now it used to be

00:04:46.429 --> 00:04:47.069
that you,

00:04:47.069 --> 00:04:49.269
if you wanted to access these variables during

00:04:49.269 --> 00:04:50.749
local development locally,

00:04:50.989 --> 00:04:54.579
you would actually have to put it in a.dev.vars

00:04:54.579 --> 00:04:54.979
file.

00:04:55.699 --> 00:04:56.979
Now with the most recent

00:04:57.349 --> 00:04:59.019
rollout of Wrangler we can,

00:04:59.019 --> 00:05:00.579
it actually supports EMV files,

00:05:00.579 --> 00:05:01.739
which is really good.

00:05:01.819 --> 00:05:04.299
So just make sure you can say pnpm run,

00:05:05.299 --> 00:05:06.659
just pnpm update

00:05:08.019 --> 00:05:10.179
Wrangler and then we'll just say latest

00:05:11.059 --> 00:05:12.819
just to make sure we get the latest version.

00:05:12.819 --> 00:05:13.796
So this feature will work.

00:05:13.943 --> 00:05:16.023
Now what I'm going to do is I'm going to say pnpm

00:05:16.023 --> 00:05:16.823
run CF

00:05:19.883 --> 00:05:20.443
type gen

00:05:20.840 --> 00:05:22.244
that should generate these types.

00:05:22.244 --> 00:05:24.164
So you see we have a Google client ID and a Google

00:05:24.164 --> 00:05:24.644
client secret.

00:05:25.204 --> 00:05:27.284
So if we head over to our application now,

00:05:27.444 --> 00:05:29.524
we can go like this and we can say

00:05:30.044 --> 00:05:32.364
c emv.client

00:05:32.844 --> 00:05:33.244
ID

00:05:33.822 --> 00:05:34.427
and then

00:05:34.827 --> 00:05:37.627
c emv.client secret

00:05:39.567 --> 00:05:39.847
right.

00:05:40.007 --> 00:05:42.247
So in terms of like the API side of things,

00:05:42.247 --> 00:05:44.247
this is literally all the configuration that we

00:05:44.247 --> 00:05:45.077
need for better authentication.

00:05:45.467 --> 00:05:46.747
This is going to handle like

00:05:46.807 --> 00:05:48.847
to check if the user's authenticated or not.

00:05:48.847 --> 00:05:49.447
It's going to,

00:05:49.447 --> 00:05:51.287
it's going to manage the callback with Google.

00:05:51.447 --> 00:05:53.687
If we add in GitHub or other providers,

00:05:53.687 --> 00:05:55.007
this is literally all we have to do.

00:05:55.007 --> 00:05:56.367
We just have to make sure we pass in the

00:05:56.367 --> 00:05:57.407
configurations for it.

00:05:57.407 --> 00:05:58.607
So it's really awesome.

00:05:58.607 --> 00:06:00.807
It's crazy how concise they're able to make this

00:06:00.807 --> 00:06:01.127
process.

00:06:01.339 --> 00:06:03.179
So now we can run this application,

00:06:03.179 --> 00:06:04.379
we can spin this guy up

00:06:05.099 --> 00:06:06.219
PNPM run

00:06:06.539 --> 00:06:06.921
device,

00:06:06.964 --> 00:06:08.964
but we are going to want to configure a few more

00:06:08.964 --> 00:06:09.524
things here.

00:06:09.524 --> 00:06:11.404
So what we're going to want to do inside of our

00:06:11.404 --> 00:06:14.404
Wrangler JSON file is we have some asset

00:06:14.404 --> 00:06:15.204
configurations.

00:06:15.924 --> 00:06:17.914
Now what we're going to want to make sure we

00:06:17.914 --> 00:06:19.784
do is we basically want to say

00:06:20.714 --> 00:06:21.514
all of these

00:06:22.474 --> 00:06:25.034
paths essentially are exposed via workers.

00:06:25.114 --> 00:06:26.874
Because right now what's happening is

00:06:27.704 --> 00:06:30.144
requests that are being made from the actual

00:06:30.144 --> 00:06:30.904
browser itself.

00:06:30.904 --> 00:06:32.824
It's able to directly hit trpc.

00:06:32.904 --> 00:06:35.344
But if you were to try to load the TRPC routes or

00:06:35.344 --> 00:06:37.384
the socket route inside of a,

00:06:37.874 --> 00:06:38.834
inside of your browser,

00:06:39.234 --> 00:06:40.194
this wouldn't work.

00:06:40.354 --> 00:06:44.074
And the authentication redirect URLs basically go

00:06:44.074 --> 00:06:46.554
from Google to the browser and that's how those

00:06:46.554 --> 00:06:47.714
authentication routes happen.

00:06:47.794 --> 00:06:48.194
So

00:06:48.434 --> 00:06:49.434
this is just something that,

00:06:49.434 --> 00:06:51.314
this is a feature that cloudflare rolled out.

00:06:51.314 --> 00:06:53.794
So instead of like trying to find these in a

00:06:53.794 --> 00:06:54.634
static asset,

00:06:54.634 --> 00:06:56.474
we kind of talked about this at the very beginning

00:06:56.474 --> 00:06:56.994
of the course.

00:06:57.314 --> 00:06:59.314
We're going to go ahead and say run worker first

00:06:59.394 --> 00:07:01.394
and we're going to pass in these paths.

00:07:01.474 --> 00:07:04.434
So anything that is API auth

00:07:05.074 --> 00:07:05.474
star

00:07:05.902 --> 00:07:06.702
is going to

00:07:08.402 --> 00:07:10.162
we're going to want to make sure we proxy it

00:07:10.162 --> 00:07:11.202
anything that is

00:07:11.842 --> 00:07:12.962
TRPC

00:07:13.362 --> 00:07:14.402
forward slash star,

00:07:14.882 --> 00:07:16.562
we're going to want to make sure the worker runs

00:07:16.562 --> 00:07:16.882
first

00:07:17.522 --> 00:07:19.762
and then also this client socket,

00:07:19.762 --> 00:07:21.482
we're going to want to make sure that the worker

00:07:21.482 --> 00:07:22.162
runs first.

00:07:23.737 --> 00:07:24.390
Alrighty.

00:07:24.950 --> 00:07:25.830
So from here

00:07:26.234 --> 00:07:27.254
we can open up this

00:07:27.724 --> 00:07:29.804
page and you're going to notice if you click on

00:07:29.804 --> 00:07:30.444
start for free,

00:07:30.444 --> 00:07:32.684
you get this Google pop up and nothing happens.

00:07:32.684 --> 00:07:33.884
And that's just because I've

00:07:34.184 --> 00:07:37.384
created a like some dummy logic on top of this.

00:07:37.544 --> 00:07:37.944
Now

00:07:38.424 --> 00:07:39.904
inside of our source

00:07:40.304 --> 00:07:43.744
we're going to have a section under components and

00:07:43.744 --> 00:07:44.064
auth

00:07:44.624 --> 00:07:45.024
and

00:07:45.584 --> 00:07:48.224
inside of here we've created a better auth client.

00:07:48.224 --> 00:07:50.304
This is coming from better auth react.

00:07:50.304 --> 00:07:52.464
So this is giving us like react hooks,

00:07:53.044 --> 00:07:54.194
and we have a better off client.

00:07:54.194 --> 00:07:55.954
Now there are things that you can pass in here to

00:07:55.954 --> 00:07:56.874
configure like

00:07:57.294 --> 00:07:58.974
like a base URL for example.

00:07:58.974 --> 00:08:00.734
So if you have a server that

00:08:01.224 --> 00:08:03.824
is living somewhere else other than your UI and

00:08:03.824 --> 00:08:05.064
it's like it's of a different host,

00:08:05.064 --> 00:08:06.704
you can pass in a base URL.

00:08:06.704 --> 00:08:10.344
But because our auth is living on the same origin

00:08:10.344 --> 00:08:11.624
as our server,

00:08:11.704 --> 00:08:12.904
we're not going to worry about that.

00:08:12.904 --> 00:08:14.904
We just have to literally just you know,

00:08:14.904 --> 00:08:15.374
have this

00:08:15.374 --> 00:08:18.324
auth client and then inside of the

00:08:18.614 --> 00:08:19.564
login pop up.

00:08:19.564 --> 00:08:21.524
I have this dummy logic.

00:08:21.524 --> 00:08:24.044
It's just this dummy auth client and

00:08:24.444 --> 00:08:25.724
go ahead and delete that.

00:08:26.125 --> 00:08:27.325
And then wherever it's used

00:08:27.645 --> 00:08:28.445
we can just

00:08:29.005 --> 00:08:30.245
make sure it's imported.

00:08:30.245 --> 00:08:32.685
So it's going to import the auth client from the

00:08:32.685 --> 00:08:33.165
top here.

00:08:33.725 --> 00:08:35.190
Same with the user icon

00:08:35.190 --> 00:08:36.326
we can do the same thing,

00:08:36.326 --> 00:08:37.726
delete this auth client,

00:08:37.726 --> 00:08:38.966
this mock auth client

00:08:39.766 --> 00:08:42.006
and we'll just make sure we have this imported.

00:08:42.886 --> 00:08:44.726
And essentially what this is doing is it's

00:08:44.726 --> 00:08:45.606
basically saying

00:08:45.746 --> 00:08:47.481
I guess we can start with this login pop up.

00:08:47.771 --> 00:08:50.051
essentially what happens is this auth client gives

00:08:50.051 --> 00:08:51.651
us some different like hooks that we can latch

00:08:51.651 --> 00:08:51.931
into.

00:08:52.011 --> 00:08:52.411
So

00:08:52.691 --> 00:08:55.071
we have a sign in with Google button right here

00:08:55.391 --> 00:08:57.871
and when that gets clicked it's going to trigger

00:08:57.951 --> 00:08:58.351
this

00:08:59.091 --> 00:09:01.971
this pop up right here and the sign in with Google

00:09:02.291 --> 00:09:04.371
all we have to literally do is say auth client

00:09:04.771 --> 00:09:06.051
sign in social,

00:09:06.371 --> 00:09:09.011
we pass in the provider that we want Google and

00:09:09.011 --> 00:09:10.051
then the callback URL.

00:09:10.051 --> 00:09:12.611
So basically it's going to navigate to the app.

00:09:13.011 --> 00:09:13.411
So

00:09:13.891 --> 00:09:15.051
basically how the

00:09:15.871 --> 00:09:17.391
the sign in with Google code is.

00:09:17.391 --> 00:09:17.991
It's like very,

00:09:17.991 --> 00:09:19.551
very limited the amount of stuff that you have to

00:09:19.551 --> 00:09:20.431
write on the client side.

00:09:20.931 --> 00:09:23.191
and then a user icon is kind of similar we

00:09:23.271 --> 00:09:24.071
essentially

00:09:24.391 --> 00:09:24.791
have

00:09:26.051 --> 00:09:27.771
where we're pulling in some of the users

00:09:27.771 --> 00:09:28.051
information.

00:09:28.467 --> 00:09:31.576
So you can see here we have client Auth and client

00:09:31.576 --> 00:09:33.056
Auth has a use session.

00:09:33.056 --> 00:09:35.136
So this is a react hook that you can latch onto

00:09:35.136 --> 00:09:37.056
and that will give us like some information.

00:09:37.456 --> 00:09:39.336
So it's going to go to the session and collect

00:09:39.336 --> 00:09:39.776
some data.

00:09:40.466 --> 00:09:42.426
it'll let us know if like it's currently loading

00:09:42.426 --> 00:09:42.826
or not.

00:09:42.826 --> 00:09:44.546
And then you can get the

00:09:44.636 --> 00:09:45.806
data which we're calling user.

00:09:45.806 --> 00:09:47.486
And this has information about the user,

00:09:47.486 --> 00:09:49.646
like the email when they were created,

00:09:49.646 --> 00:09:52.436
an image if their profile has one and then some

00:09:52.666 --> 00:09:53.626
information about the session.

00:09:53.626 --> 00:09:55.186
So then we use that and I'll show you exactly

00:09:55.186 --> 00:09:55.866
where we use that.

00:09:55.866 --> 00:09:58.666
But what we can do here is we can click on

00:10:00.226 --> 00:10:01.866
we can click on Continue with Google.

00:10:01.866 --> 00:10:03.226
I just want to open this network tab.

00:10:03.226 --> 00:10:05.626
You're going to notice a request is going to fire

00:10:05.626 --> 00:10:07.426
off to our API.

00:10:07.771 --> 00:10:08.658
I'm going to do that one more time.

00:10:08.658 --> 00:10:09.578
I didn't have it up.

00:10:09.578 --> 00:10:09.834
So

00:10:09.834 --> 00:10:10.632
we click on this,

00:10:10.792 --> 00:10:12.579
a request fires off to our API.

00:10:12.579 --> 00:10:14.402
This goes to API authentication,

00:10:14.528 --> 00:10:15.248
our API.

00:10:15.248 --> 00:10:18.208
So our server redirects to

00:10:18.648 --> 00:10:19.528
Google's Auth

00:10:20.008 --> 00:10:22.208
and there is a callback URL in here that comes

00:10:22.208 --> 00:10:22.968
back to our app.

00:10:23.368 --> 00:10:25.048
We can just come into here and say I'm going to

00:10:25.048 --> 00:10:26.216
sign in with Matthew Sessions.

00:10:26.216 --> 00:10:26.524
Continue.

00:10:26.924 --> 00:10:29.924
This will redirect back to our app and then our

00:10:29.924 --> 00:10:31.164
app is basically going to say okay,

00:10:31.164 --> 00:10:32.884
go to forward slash app because that's where our

00:10:32.884 --> 00:10:33.724
dashboard is.

00:10:35.028 --> 00:10:35.508
Alrighty.

00:10:35.508 --> 00:10:38.268
So now we are going back to our app and things are

00:10:38.268 --> 00:10:38.628
loaded.

00:10:39.028 --> 00:10:39.508
All right,

00:10:39.508 --> 00:10:40.748
so our dashboard loaded.

00:10:40.748 --> 00:10:43.428
And what you're going to notice now we also have

00:10:43.428 --> 00:10:43.988
our little

00:10:44.388 --> 00:10:45.468
user client down here.

00:10:45.468 --> 00:10:45.748
It's,

00:10:45.748 --> 00:10:47.428
it's kind of blocked by this tanstack router

00:10:47.428 --> 00:10:47.588
thing,

00:10:47.588 --> 00:10:49.468
but it shows your name and your email and you can

00:10:49.468 --> 00:10:51.028
click on it and you can manage your logout.

00:10:51.028 --> 00:10:51.508
So it's very,

00:10:51.508 --> 00:10:51.988
very simple.

00:10:51.988 --> 00:10:54.148
But you can see like these components are really

00:10:54.148 --> 00:10:54.628
nice looking.

00:10:54.628 --> 00:10:55.388
They kind of

00:10:55.708 --> 00:10:57.788
work cleanly with your existing UI

00:10:58.188 --> 00:11:00.068
and you can build whatever you want on top of it

00:11:00.068 --> 00:11:01.628
if you want to be able to manage payments and

00:11:01.788 --> 00:11:02.268
whatnot.

00:11:02.268 --> 00:11:04.148
If you want a dedicated page for managing the

00:11:04.148 --> 00:11:04.428
account,

00:11:04.668 --> 00:11:05.778
it's entirely up to you.

00:11:05.928 --> 00:11:06.728
You want to implement it.

00:11:06.728 --> 00:11:09.135
Now one thing I want to do here is when the user

00:11:09.135 --> 00:11:11.175
clicks sign out I want to make sure we kind of

00:11:11.175 --> 00:11:13.175
navigate them back to the home page.

00:11:13.415 --> 00:11:13.815
So

00:11:14.165 --> 00:11:17.435
if we come to our user icon there's going to be a

00:11:17.435 --> 00:11:18.155
log out,

00:11:19.290 --> 00:11:22.290
a handle logout method and essentially what we can

00:11:22.290 --> 00:11:26.410
do is we can say const nav and we can import a use

00:11:26.890 --> 00:11:29.940
navigation or use navigate from our tan stack

00:11:30.170 --> 00:11:30.468
router

00:11:30.468 --> 00:11:31.022
and then

00:11:31.422 --> 00:11:34.622
when the auth client.sign out is successful,

00:11:34.622 --> 00:11:36.862
instead of just like reloading the page which is

00:11:36.862 --> 00:11:38.462
just something we had hard coded in here,

00:11:38.702 --> 00:11:41.454
we can go nav2

00:11:41.454 --> 00:11:43.703
nav2 and we'll just go home.

00:11:44.870 --> 00:11:47.030
Now from here I'm going to go ahead and click on

00:11:47.030 --> 00:11:47.350
this guy

00:11:47.350 --> 00:11:50.015
sign out and when it signs out it comes over here.

00:11:50.095 --> 00:11:50.655
Now what,

00:11:50.835 --> 00:11:53.395
what we're also going to notice is the forward

00:11:53.395 --> 00:11:53.955
slash

00:11:54.515 --> 00:11:54.915
app

00:11:55.180 --> 00:11:57.140
is not protected because we're currently logged

00:11:57.140 --> 00:11:57.340
out.

00:11:57.340 --> 00:11:57.660
Right.

00:11:57.960 --> 00:12:00.300
we shouldn't be able to access this page when

00:12:00.300 --> 00:12:01.060
we're logged out.

00:12:01.140 --> 00:12:01.540
So

00:12:01.860 --> 00:12:03.940
another thing that we can do is we can actually

00:12:03.940 --> 00:12:04.580
modify

00:12:04.939 --> 00:12:08.940
the Tanstack router itself to check the session on

00:12:08.940 --> 00:12:11.580
the backend if the user is authenticated or not.

00:12:12.300 --> 00:12:14.860
So under source let's head over to

00:12:16.530 --> 00:12:16.850
routes

00:12:17.730 --> 00:12:20.610
and inside of app we actually have this root level

00:12:20.690 --> 00:12:21.810
auth folder.

00:12:21.970 --> 00:12:23.810
This root level auth folder is called

00:12:24.130 --> 00:12:26.610
before every single like render or load.

00:12:26.930 --> 00:12:29.850
For anything that shows as app or any of these

00:12:29.850 --> 00:12:31.090
like parent or

00:12:31.490 --> 00:12:34.850
children pages like app dot links evaluations,

00:12:35.100 --> 00:12:36.130
these are all going to

00:12:36.450 --> 00:12:37.730
basically be

00:12:38.820 --> 00:12:42.650
be handled by this authentic.ts this root file

00:12:42.810 --> 00:12:44.890
before it comes into all of these different

00:12:44.890 --> 00:12:45.370
routes.

00:12:45.433 --> 00:12:46.873
So in order to handle this

00:12:47.273 --> 00:12:48.473
inside of our route

00:12:49.113 --> 00:12:50.473
we can add a

00:12:50.793 --> 00:12:54.153
before load function which basically is going to

00:12:54.153 --> 00:12:55.833
trigger this code before it loads

00:12:56.153 --> 00:12:57.913
and we can basically say const

00:12:58.633 --> 00:12:59.193
session

00:12:59.913 --> 00:13:01.193
equals await.

00:13:02.696 --> 00:13:02.716
We'll

00:13:02.966 --> 00:13:03.526
say off

00:13:04.506 --> 00:13:07.506
client.get session.

00:13:07.506 --> 00:13:09.626
So this is going to reach out to our backend to

00:13:09.626 --> 00:13:10.746
collect that session

00:13:11.146 --> 00:13:12.186
and then we can go

00:13:12.606 --> 00:13:12.926
if

00:13:13.406 --> 00:13:15.246
there is no actual session.

00:13:15.246 --> 00:13:15.466
So

00:13:15.466 --> 00:13:16.194
I think we should.

00:13:16.354 --> 00:13:16.794
Yeah,

00:13:16.794 --> 00:13:18.034
so we can basically say

00:13:18.544 --> 00:13:19.664
we'll call the session data

00:13:19.670 --> 00:13:20.810
Now we can just call a session.

00:13:20.970 --> 00:13:23.370
So I'm basically going to say if there is no

00:13:24.090 --> 00:13:27.940
session.data.

00:13:27.940 --> 00:13:28.500
session

00:13:29.620 --> 00:13:31.220
then we can throw

00:13:31.540 --> 00:13:31.940
a

00:13:33.220 --> 00:13:33.860
redirect

00:13:34.900 --> 00:13:36.260
from Tanstack router

00:13:36.660 --> 00:13:38.660
and we'll just basically go to

00:13:39.220 --> 00:13:40.020
back to home.

00:13:40.100 --> 00:13:42.340
So this is just going to force us back to home if

00:13:42.420 --> 00:13:43.940
the user is not authenticated.

00:13:43.940 --> 00:13:44.740
So currently

00:13:45.140 --> 00:13:46.580
I am not authenticated.

00:13:46.580 --> 00:13:48.980
So if we actually load this page notice it takes

00:13:48.980 --> 00:13:51.940
us back to app and if we try to go there again

00:13:53.050 --> 00:13:54.170
it's not going to let us do that.

00:13:54.170 --> 00:13:56.090
That's kind of the expected behavior here.

00:13:56.330 --> 00:13:57.970
So we'll go ahead and go through the sign in

00:13:57.970 --> 00:13:58.250
process.

00:13:58.452 --> 00:13:59.012
Alright,

00:13:59.012 --> 00:14:00.506
so now it's taken us back to app

00:14:00.584 --> 00:14:02.264
and if we go back home

00:14:02.662 --> 00:14:04.182
we just go back to the home page.

00:14:04.902 --> 00:14:07.302
We also have Our little icon that renders up here,

00:14:07.312 --> 00:14:08.722
you can go through the front end code and just

00:14:08.722 --> 00:14:10.362
kind of play around with it to see how this is.

00:14:10.492 --> 00:14:11.302
but yeah,

00:14:11.302 --> 00:14:11.822
so we have

00:14:12.122 --> 00:14:13.402
like a little icon here

00:14:13.492 --> 00:14:15.142
that we can click on and we can log out.

00:14:15.142 --> 00:14:17.422
So from here when we do start for free,

00:14:17.422 --> 00:14:19.262
if we're already logged in it's just going to take

00:14:19.262 --> 00:14:19.814
us to the app

00:14:19.834 --> 00:14:20.234
and

00:14:20.714 --> 00:14:22.234
if we sign out

00:14:22.794 --> 00:14:24.754
this button is basically going to have this pop up

00:14:24.754 --> 00:14:25.034
again.

00:14:25.034 --> 00:14:25.434
So

00:14:25.584 --> 00:14:26.594
go through the front end code,

00:14:26.594 --> 00:14:28.434
just pay attention to the hooks because all of

00:14:28.434 --> 00:14:30.554
these components are using the Better Auth hooks

00:14:30.554 --> 00:14:31.874
to basically build out this logic.

00:14:31.874 --> 00:14:32.194
But

00:14:32.524 --> 00:14:34.474
I hope that this is kind of like a really good

00:14:34.474 --> 00:14:35.634
overview of how to integrate.

00:14:35.634 --> 00:14:37.354
So at this point you know we've built out our

00:14:37.354 --> 00:14:39.274
entire integration with Better Auth.

00:14:39.274 --> 00:14:40.834
We have created our tables,

00:14:41.304 --> 00:14:42.804
we integrated the

00:14:43.264 --> 00:14:45.784
the backend client with our backend application.

00:14:45.784 --> 00:14:48.424
We created some client credentials on Google and

00:14:48.424 --> 00:14:49.344
then we've also

00:14:49.694 --> 00:14:52.174
wired in like the client hooks into our user like

00:14:52.334 --> 00:14:54.094
application on the UI side of things.

00:14:54.174 --> 00:14:56.094
So everything's kind of working cohesively.

00:14:56.174 --> 00:14:57.814
Last thing we're going to do is let's get this

00:14:57.814 --> 00:14:59.534
thing wired up with our actual domain.

00:15:00.014 --> 00:15:02.574
So we have this site smartlink.com

00:15:02.974 --> 00:15:05.414
and what we're going to want to do is we're going

00:15:05.414 --> 00:15:07.054
to want to head over to our,

00:15:08.551 --> 00:15:10.391
head over to our Google Auth again

00:15:10.550 --> 00:15:10.950
and

00:15:11.830 --> 00:15:14.870
we will modify this so you can come in here.

00:15:14.870 --> 00:15:17.110
We can also add this callback so basically

00:15:17.430 --> 00:15:19.310
everything at Smart Link and you can do this for

00:15:19.310 --> 00:15:21.550
your lower environments for your stage URL as

00:15:21.550 --> 00:15:21.830
well.

00:15:21.910 --> 00:15:24.190
You can also use your cloudflare generated domain

00:15:24.190 --> 00:15:25.190
if you wanted to here.

00:15:25.320 --> 00:15:27.610
so then I'm just going to say grab this,

00:15:27.690 --> 00:15:28.970
I'm going to copy the

00:15:29.510 --> 00:15:30.110
this section.

00:15:30.110 --> 00:15:30.470
So

00:15:30.760 --> 00:15:33.390
smartlink.com API auth callback Google.

00:15:33.390 --> 00:15:33.870
Okay,

00:15:33.950 --> 00:15:35.070
I'm going to save that

00:15:35.095 --> 00:15:37.804
now what we're going to do is I'm going to kill

00:15:37.804 --> 00:15:39.764
this and we're going to say pnpm,

00:15:39.764 --> 00:15:40.124
run,

00:15:42.924 --> 00:15:43.644
production,

00:15:43.724 --> 00:15:44.284
deploy.

00:15:44.931 --> 00:15:46.758
And while this is loading I'm going to head over

00:15:46.758 --> 00:15:49.078
to our cloudflare dashboard and I'm going to go to

00:15:49.078 --> 00:15:51.318
that specific worker so we can head over to our

00:15:51.318 --> 00:15:51.598
workers

00:15:51.778 --> 00:15:52.662
user application

00:15:52.662 --> 00:15:53.284
settings

00:15:53.764 --> 00:15:55.204
and then we're going to add

00:15:55.844 --> 00:15:56.124
our

00:15:56.584 --> 00:15:58.624
Google environment variables here as well.

00:15:58.624 --> 00:16:00.894
So notice that we set up our emv,

00:16:00.894 --> 00:16:02.806
we have our EMV file right here.

00:16:03.686 --> 00:16:06.406
We're going to put these inside of our

00:16:06.806 --> 00:16:07.926
variables and secrets.

00:16:07.926 --> 00:16:09.686
Now this differs from the

00:16:10.266 --> 00:16:12.306
the variables and secrets during the build

00:16:12.306 --> 00:16:12.666
process.

00:16:12.986 --> 00:16:14.586
These are runtime secrets.

00:16:14.666 --> 00:16:16.866
So these will have access to when the actual

00:16:16.866 --> 00:16:18.506
worker is invoked so we can add.

00:16:18.806 --> 00:16:19.126
Guys,

00:16:19.366 --> 00:16:20.726
we're going to make sure that's a secret.

00:16:20.966 --> 00:16:22.006
Make sure that's a secret.

00:16:22.059 --> 00:16:23.775
And then we're going to deploy that one more time.

00:16:24.003 --> 00:16:25.463
Reload smartlinks.com

00:16:25.463 --> 00:16:25.899
all right,

00:16:25.899 --> 00:16:27.669
let's see if Auth is working as expected.

00:16:28.149 --> 00:16:28.709
Boom.

00:16:28.949 --> 00:16:31.060
Sign in should take us back to here.

00:16:31.060 --> 00:16:31.433
Cool.

00:16:31.433 --> 00:16:32.153
This is working.

00:16:32.873 --> 00:16:33.993
We want to do.

00:16:34.313 --> 00:16:34.673
Actually,

00:16:34.673 --> 00:16:35.113
let's.

00:16:35.583 --> 00:16:35.783
Yeah.

00:16:35.783 --> 00:16:36.494
So let's log out

00:16:36.494 --> 00:16:38.147
and let's try to go to our app

00:16:38.947 --> 00:16:40.787
and we are not able to see anything.

00:16:40.867 --> 00:16:41.347
Cool.

00:16:41.667 --> 00:16:43.467
So Auth is fully built out at this point.

00:16:43.467 --> 00:16:45.307
We've been able to validate everything locally.

00:16:45.307 --> 00:16:46.787
We've also also been able to,

00:16:47.537 --> 00:16:49.657
roll out our Auth for the actual production

00:16:49.657 --> 00:16:51.377
version of our application with the domain that

00:16:51.377 --> 00:16:51.617
we,

00:16:51.617 --> 00:16:52.257
that we own.

00:16:52.337 --> 00:16:52.737
So.

00:16:52.977 --> 00:16:53.377
Yeah,

00:16:53.377 --> 00:16:54.377
so in this next section,

00:16:54.377 --> 00:16:56.057
we're going to also figure out how to,

00:16:56.057 --> 00:16:56.257
like,

00:16:56.257 --> 00:16:58.064
actually work the payment side of things as well.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.034 --> 00:00:01.514
So the last thing that we need to do before

00:00:01.514 --> 00:00:04.554
getting into the stripe integration is we need to

00:00:04.554 --> 00:00:06.434
essentially protect different routes that we've

00:00:06.434 --> 00:00:07.554
defined in our application.

00:00:07.634 --> 00:00:10.594
So right now the user isn't able to hit forward

00:00:10.594 --> 00:00:12.834
slash app if they're not logged in.

00:00:13.514 --> 00:00:14.794
but that being said,

00:00:14.794 --> 00:00:17.434
we do have all of these TRPC methods

00:00:17.834 --> 00:00:20.394
that are getting called like from the client and

00:00:20.394 --> 00:00:22.714
then we also have a websocket connection

00:00:23.334 --> 00:00:24.494
that is currently unprotected.

00:00:24.494 --> 00:00:27.494
So essentially anybody could extract those URLs,

00:00:27.844 --> 00:00:29.774
if they know the user's ID somehow they could

00:00:29.774 --> 00:00:31.894
probably go like an extract information about the

00:00:31.894 --> 00:00:32.854
user or about

00:00:33.104 --> 00:00:33.824
like the different,

00:00:33.917 --> 00:00:35.791
or access different resources that we have on our

00:00:35.791 --> 00:00:36.191
server.

00:00:36.191 --> 00:00:38.391
So we're going to want to ensure that

00:00:38.791 --> 00:00:41.751
all of our actual like API endpoints,

00:00:41.751 --> 00:00:42.831
TRPC routes,

00:00:42.831 --> 00:00:43.151
any,

00:00:43.151 --> 00:00:44.391
any server site

00:00:44.951 --> 00:00:46.831
logic that should be protected.

00:00:46.831 --> 00:00:48.231
We're basically going to stick that

00:00:48.241 --> 00:00:48.771
we're going to

00:00:49.261 --> 00:00:51.101
do some authentication logic at that layer.

00:00:51.101 --> 00:00:51.501
So

00:00:51.801 --> 00:00:53.401
what we're going to be using because

00:00:53.881 --> 00:00:55.881
right now if you look at our worker,

00:00:56.551 --> 00:00:58.591
we essentially have this fetch handler and that's

00:00:58.591 --> 00:01:00.951
like offloading the routing to Hono.

00:01:01.111 --> 00:01:02.351
And Hono makes it really,

00:01:02.351 --> 00:01:04.791
really easy to build out some like generic logic

00:01:04.791 --> 00:01:07.631
to do different types of like authentication or

00:01:07.631 --> 00:01:07.951
like

00:01:07.951 --> 00:01:10.391
restrictions based upon information that's coming

00:01:10.391 --> 00:01:10.911
from Auth.

00:01:10.911 --> 00:01:12.871
So I'll kind of explain what that means but just

00:01:12.871 --> 00:01:14.461
to kind of like look at what we have here.

00:01:14.461 --> 00:01:16.261
We have three different routes.

00:01:16.261 --> 00:01:17.421
We have one that is,

00:01:17.501 --> 00:01:19.701
that handles essentially all of our API auth

00:01:19.701 --> 00:01:20.141
stuff.

00:01:20.141 --> 00:01:22.061
we have a client socket and then we have all of

00:01:22.061 --> 00:01:24.181
our TRPC routes that are basically being

00:01:24.181 --> 00:01:25.531
forwarded through into here.

00:01:25.611 --> 00:01:26.011
Now

00:01:26.571 --> 00:01:28.051
what we're going to do is we're going to be

00:01:28.051 --> 00:01:31.051
creating a Hono middleware that essentially sits

00:01:31.291 --> 00:01:33.531
in between the receiving of the request

00:01:34.011 --> 00:01:36.051
and then the actual route itself.

00:01:36.051 --> 00:01:37.611
So when we receive a request,

00:01:37.897 --> 00:01:39.657
currently we don't have this middleware.

00:01:39.657 --> 00:01:41.337
So we get a request and then that,

00:01:41.337 --> 00:01:43.577
that data comes through and it basically goes into

00:01:43.577 --> 00:01:46.417
our fetch handler and then Hono routes it to the

00:01:46.417 --> 00:01:47.257
correct route.

00:01:47.337 --> 00:01:47.737
Now

00:01:48.027 --> 00:01:49.557
what happens with middleware is before

00:01:49.957 --> 00:01:51.957
that request makes it to the route,

00:01:52.197 --> 00:01:55.237
we can define our own custom logic to process that

00:01:55.237 --> 00:01:57.757
request to determine if it should make it to a

00:01:57.757 --> 00:01:59.797
route or if we should like return a 401,

00:01:59.797 --> 00:02:02.117
say this user is not authenticated or throw some

00:02:02.117 --> 00:02:02.957
type of error.

00:02:02.957 --> 00:02:03.317
So

00:02:03.797 --> 00:02:05.517
has like really good documentation on how to

00:02:05.517 --> 00:02:06.317
define middlewares.

00:02:06.317 --> 00:02:07.717
They have a lot of built in middleware that you

00:02:07.717 --> 00:02:08.117
can use.

00:02:08.657 --> 00:02:10.497
They also have the section about Building out

00:02:10.737 --> 00:02:11.709
custom middleware.

00:02:11.709 --> 00:02:14.213
And you can see how you can use custom middleware.

00:02:14.293 --> 00:02:16.693
And then you can also see how you can

00:02:17.193 --> 00:02:19.233
create your own like middleware using this.

00:02:19.233 --> 00:02:20.593
Create middleware factory.

00:02:21.952 --> 00:02:23.672
So this is ultimately what we're going to be

00:02:23.672 --> 00:02:24.152
building out.

00:02:24.152 --> 00:02:26.152
But our use case is going to be different from

00:02:26.152 --> 00:02:28.352
this logger one where we're going to be grabbing

00:02:28.352 --> 00:02:30.392
some information about the user to determine if

00:02:30.392 --> 00:02:31.232
they should like continue

00:02:32.112 --> 00:02:33.092
to be routed.

00:02:33.672 --> 00:02:36.632
so what we're going to do is we are going to,

00:02:36.632 --> 00:02:38.552
at the top level we can go ahead and we can

00:02:38.552 --> 00:02:38.872
import,

00:02:38.952 --> 00:02:39.352
create

00:02:40.312 --> 00:02:40.712
the

00:02:40.892 --> 00:02:42.132
middleware method

00:02:42.452 --> 00:02:45.572
and then I'm going to define a middleware

00:02:46.612 --> 00:02:47.812
and we can call this

00:02:48.152 --> 00:02:49.232
Auth middleware.

00:02:50.062 --> 00:02:52.262
Now essentially what we need to do is we need to

00:02:52.262 --> 00:02:53.102
say await

00:02:53.502 --> 00:02:55.862
next and that's going to pipe the request through.

00:02:55.862 --> 00:02:57.502
And then for now I'm just going to console

00:02:58.352 --> 00:02:58.592
log

00:02:59.712 --> 00:03:00.112
hit

00:03:02.272 --> 00:03:03.632
middleware.

00:03:04.042 --> 00:03:06.962
Now we can essentially define this middleware to

00:03:06.962 --> 00:03:07.242
be

00:03:08.482 --> 00:03:09.282
utilized

00:03:09.602 --> 00:03:12.082
at every single route by attaching it to this app.

00:03:12.162 --> 00:03:14.802
But for our use case we only want to protect TRPC

00:03:15.042 --> 00:03:17.922
and client socket because the API Auth is

00:03:17.922 --> 00:03:19.642
basically handling a whole bunch of stuff for us

00:03:19.642 --> 00:03:20.602
and it's very feasible.

00:03:20.602 --> 00:03:21.762
When the user's not logged in,

00:03:21.762 --> 00:03:24.002
they're going to log in and that data is going to

00:03:24.002 --> 00:03:24.922
flow through here as well.

00:03:24.922 --> 00:03:27.732
So we're going to allow Auth to stay out as it is.

00:03:27.732 --> 00:03:30.142
we're just going to basically try to protect TRPC

00:03:31.452 --> 00:03:33.852
and then we're going to protect the client socket.

00:03:35.052 --> 00:03:36.172
Now I'm going to save this

00:03:36.492 --> 00:03:38.892
and I'm going to go ahead and PNPM our CD into

00:03:38.892 --> 00:03:39.772
user application

00:03:42.572 --> 00:03:44.250
and then PNPM run dev.

00:03:44.250 --> 00:03:44.686
Now this,

00:03:44.686 --> 00:03:45.766
when this spins up

00:03:46.409 --> 00:03:48.706
we'll go ahead and head over to our dashboard

00:03:48.782 --> 00:03:51.582
and we should see middleware hit logs,

00:03:51.592 --> 00:03:53.822
a few different times as this page loads out.

00:03:53.822 --> 00:03:55.622
So basically every single time our

00:03:56.102 --> 00:03:58.902
client application is making requests to TRPC or

00:03:58.902 --> 00:03:59.862
this client socket.

00:04:00.182 --> 00:04:02.202
because we've defined middleware as

00:04:02.802 --> 00:04:04.882
a dependency for these routes

00:04:05.522 --> 00:04:07.642
this request is going to be processed or this

00:04:07.642 --> 00:04:09.482
logic is going to be processed before it makes it

00:04:09.482 --> 00:04:10.482
to this endpoint.

00:04:10.482 --> 00:04:11.442
So you're going to see we

00:04:11.882 --> 00:04:13.642
it hit middleware three different times.

00:04:14.275 --> 00:04:15.755
Now the next thing we're going to have to do

00:04:15.755 --> 00:04:18.435
inside of here is we're going to have to get our

00:04:18.515 --> 00:04:20.435
server side Auth client and

00:04:20.755 --> 00:04:22.835
essentially check if there's a session on it.

00:04:22.835 --> 00:04:25.595
Now we have the logic to get the Auth client here,

00:04:25.595 --> 00:04:27.555
but as this course progresses,

00:04:27.555 --> 00:04:29.755
the information that we pass into here is going to

00:04:29.755 --> 00:04:30.595
Kind of expand.

00:04:30.755 --> 00:04:30.935
So,

00:04:30.935 --> 00:04:30.985
I'm.

00:04:30.985 --> 00:04:32.945
What I'm going to do is I'm going to basically

00:04:33.265 --> 00:04:33.985
have a

00:04:34.305 --> 00:04:36.505
helper method and this probably could live in

00:04:36.505 --> 00:04:38.785
another file in the future if we wanted to.

00:04:39.645 --> 00:04:41.885
but basically what this is going to do is this is

00:04:41.885 --> 00:04:44.205
going to have a method called get auth instance

00:04:44.205 --> 00:04:46.245
and then we are just going to pass in the

00:04:46.245 --> 00:04:47.325
information for the auth

00:04:48.045 --> 00:04:49.038
instance into here.

00:04:49.038 --> 00:04:50.113
And then we can

00:04:50.513 --> 00:04:51.713
go ahead and

00:04:52.715 --> 00:04:54.686
call this get auth instance down here,

00:04:55.566 --> 00:04:56.686
pass an emv.

00:04:59.204 --> 00:05:02.124
And then we could also say at this level we're

00:05:02.124 --> 00:05:03.284
going to say const

00:05:04.164 --> 00:05:04.564
auth

00:05:05.044 --> 00:05:05.604
equals

00:05:06.299 --> 00:05:07.512
get auth instance

00:05:08.300 --> 00:05:11.100
and we will also be passing in C emv.

00:05:12.220 --> 00:05:12.540
Okay,

00:05:12.540 --> 00:05:14.860
so from here we have access to our auth instance.

00:05:14.860 --> 00:05:17.260
So we're just going to go ahead and check if a

00:05:17.260 --> 00:05:18.300
session exists.

00:05:20.060 --> 00:05:24.220
So let's say const session equals await auth API

00:05:24.300 --> 00:05:26.180
getsession and then we basically pass in the

00:05:26.180 --> 00:05:27.260
headers and internally,

00:05:27.419 --> 00:05:28.860
the better auth

00:05:29.120 --> 00:05:31.440
server side logic is going to be taking a look at

00:05:31.440 --> 00:05:33.640
these headers and it's going to pull out the

00:05:33.640 --> 00:05:34.400
session id,

00:05:34.540 --> 00:05:36.420
and it's going to reconcile that against some data

00:05:36.420 --> 00:05:37.444
inside of our database.

00:05:37.932 --> 00:05:39.492
Now I'm going to go ahead and say if we don't have

00:05:39.492 --> 00:05:40.014
a session,

00:05:40.014 --> 00:05:42.859
or let's say if we don't have a session dot user,

00:05:43.020 --> 00:05:45.300
we're going to go ahead and throw a 401

00:05:45.300 --> 00:05:46.320
unauthorized here.

00:05:46.320 --> 00:05:48.678
Then I'm going to go ahead and pull out the user

00:05:48.678 --> 00:05:50.238
ID into its own variable.

00:05:50.478 --> 00:05:51.758
And then we're going to say C

00:05:52.078 --> 00:05:52.478
set

00:05:52.958 --> 00:05:53.914
user ID here.

00:05:54.019 --> 00:05:56.387
And what this set is doing is it's basically

00:05:56.387 --> 00:05:58.987
allowing us to attach information to the context

00:05:59.147 --> 00:06:01.567
so it can be accessed inside of these other routes

00:06:01.567 --> 00:06:02.327
very easily.

00:06:02.407 --> 00:06:02.687
Now,

00:06:02.687 --> 00:06:04.066
in order to make this type safe,

00:06:04.066 --> 00:06:06.822
we can go ahead and we can say variables,

00:06:08.616 --> 00:06:10.396
and then we're going to define user

00:06:12.876 --> 00:06:13.836
as a string.

00:06:14.652 --> 00:06:16.979
And then if we head over to the trpc,

00:06:16.979 --> 00:06:19.499
we could basically say const user ID

00:06:20.379 --> 00:06:22.299
equals c dot get

00:06:23.429 --> 00:06:24.709
and this should be type safe.

00:06:24.709 --> 00:06:26.549
So it should autocomplete with user id.

00:06:27.109 --> 00:06:28.709
And then we're going to basically be doing the

00:06:28.709 --> 00:06:29.429
same thing for

00:06:29.749 --> 00:06:30.149
the

00:06:30.369 --> 00:06:31.029
Click socket.

00:06:31.029 --> 00:06:31.829
Now click socket.

00:06:31.829 --> 00:06:32.869
This integration is going to be very,

00:06:32.869 --> 00:06:35.269
very easy because you can see we are setting these

00:06:35.269 --> 00:06:35.749
headers,

00:06:35.809 --> 00:06:36.669
with the account id,

00:06:36.669 --> 00:06:38.668
and that account ID is basically internally what

00:06:38.668 --> 00:06:39.829
we're saying is the user id.

00:06:40.239 --> 00:06:42.319
the reason why we're distinguishing between like

00:06:42.319 --> 00:06:42.559
account,

00:06:42.559 --> 00:06:44.679
we're calling the account ID a user ID is imagine

00:06:44.679 --> 00:06:45.359
if you have

00:06:45.679 --> 00:06:47.759
some type of application where instead of like

00:06:47.999 --> 00:06:50.159
partitioning the data at a user level,

00:06:50.319 --> 00:06:52.359
you basically make it an account level or an

00:06:52.359 --> 00:06:54.699
organization level and you can say everybod under

00:06:54.699 --> 00:06:56.379
this organization can see this data.

00:06:56.459 --> 00:06:58.859
So instead of filtering internally by

00:06:59.259 --> 00:06:59.659
the

00:07:00.199 --> 00:07:00.999
the user id,

00:07:00.999 --> 00:07:02.199
you'd pass in a different id.

00:07:02.199 --> 00:07:03.079
But for our use case,

00:07:03.159 --> 00:07:06.119
the application is isolated to a specific user.

00:07:06.359 --> 00:07:07.919
So we're just going to go ahead and we're going to

00:07:07.919 --> 00:07:09.319
throw this data into here.

00:07:10.299 --> 00:07:13.739
And then if we drill into this create context,

00:07:13.845 --> 00:07:15.676
you're going to notice we have this hard coded

00:07:15.676 --> 00:07:16.756
user ID as well.

00:07:16.836 --> 00:07:18.356
So we're just going to go ahead and say

00:07:19.036 --> 00:07:19.916
user ID

00:07:20.270 --> 00:07:22.539
and then we'll also make sure we have it as a type

00:07:25.698 --> 00:07:27.738
and then we're going to be passing it into here.

00:07:29.178 --> 00:07:29.288
Now,

00:07:29.288 --> 00:07:30.898
the last thing we need to do is we need to take

00:07:30.898 --> 00:07:33.018
our user ID and we need to make sure we pass it

00:07:33.018 --> 00:07:34.298
into this create context.

00:07:34.298 --> 00:07:34.898
Helper.

00:07:37.186 --> 00:07:38.346
So I just deleted the,

00:07:38.346 --> 00:07:40.746
I just did some cleanup work and deleted the log

00:07:40.746 --> 00:07:42.546
statements under AUTH middleware.

00:07:42.625 --> 00:07:45.106
And this is a good opportunity to deploy the

00:07:45.106 --> 00:07:45.466
changes.

00:07:45.466 --> 00:07:47.466
Whether you want to do this through the CLI or you

00:07:47.466 --> 00:07:49.626
want to push these changes to the master branch

00:07:49.626 --> 00:07:50.706
and have Our automated

00:07:51.386 --> 00:07:53.466
CI CD pipeline or our GitHub action,

00:07:54.066 --> 00:07:55.066
deploy that change for you.

00:07:55.066 --> 00:07:55.906
I'm just going to say

00:07:57.186 --> 00:07:58.146
PNPM

00:07:59.873 --> 00:08:00.273
run

00:08:01.553 --> 00:08:02.993
stagedeploy

00:08:05.456 --> 00:08:07.592
and what we should note here is after we do the

00:08:07.592 --> 00:08:10.112
stage deploy or I'll also do a production deploy.

00:08:10.112 --> 00:08:11.460
This is a production version of the app.

00:08:11.460 --> 00:08:13.916
We have these links that are created and it's

00:08:13.916 --> 00:08:16.116
still using the hard coded user ID on the back

00:08:16.116 --> 00:08:16.436
end.

00:08:16.866 --> 00:08:18.786
So if we go ahead and deploy this to production,

00:08:19.156 --> 00:08:21.146
those links should also go away and we'll have to

00:08:21.146 --> 00:08:23.146
kind of create some new links for our test data

00:08:23.146 --> 00:08:23.336
here.

00:08:23.336 --> 00:08:24.398
So let's go ahead and do that.

00:08:24.398 --> 00:08:25.718
I'm going to also say,

00:08:26.038 --> 00:08:28.518
so that deployed to stage PNPM run,

00:08:29.708 --> 00:08:30.378
production

00:08:30.938 --> 00:08:31.525
deploy

00:08:31.525 --> 00:08:33.456
and then now when we head over to our production

00:08:33.456 --> 00:08:33.776
version,

00:08:33.776 --> 00:08:35.096
we no longer have

00:08:35.166 --> 00:08:35.836
those links.

00:08:35.836 --> 00:08:38.396
So essentially our authentication is fully built

00:08:38.396 --> 00:08:40.876
out and now we're going to move into the stripe

00:08:40.876 --> 00:08:41.956
payment side of things.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.311 --> 00:00:02.871
So now let's integrate payments into our SaaS

00:00:02.871 --> 00:00:03.191
product.

00:00:03.271 --> 00:00:05.631
Now payments is kind of a topic that I went back

00:00:05.631 --> 00:00:06.391
and forth with,

00:00:07.131 --> 00:00:09.651
deciding if I actually wanted to put into this

00:00:09.651 --> 00:00:12.290
course just because it is such a broad topic and

00:00:12.290 --> 00:00:14.251
honestly it can become so complex

00:00:14.531 --> 00:00:17.731
as your use cases mature and become more niche.

00:00:17.811 --> 00:00:18.211
So

00:00:18.691 --> 00:00:21.051
just note that this is going to be a pretty simple

00:00:21.051 --> 00:00:22.651
implementation of Stripe.

00:00:22.651 --> 00:00:24.291
Essentially what we're going to be doing is we're

00:00:24.291 --> 00:00:26.131
going to be using the better off plugin

00:00:26.421 --> 00:00:28.181
to roll out Stripe subscriptions.

00:00:28.181 --> 00:00:31.741
Now this is kind of a valid way of like actually

00:00:31.741 --> 00:00:33.541
taking payments for the vast majority of these

00:00:33.541 --> 00:00:34.341
like SaaS products,

00:00:34.671 --> 00:00:35.711
even larger products.

00:00:35.711 --> 00:00:37.871
This is a pretty like standard implementation.

00:00:37.871 --> 00:00:40.351
But the second you're getting into like usage

00:00:40.351 --> 00:00:41.151
based billing,

00:00:41.341 --> 00:00:43.251
or you have like multiple different products and

00:00:43.571 --> 00:00:46.451
you need a lot more control over the entire like

00:00:46.451 --> 00:00:47.171
payment system,

00:00:47.491 --> 00:00:50.211
I feel like rolling your own solution is kind of

00:00:50.211 --> 00:00:51.811
the direction you have to go and we just don't

00:00:51.811 --> 00:00:53.531
have that type of time to go over that in the

00:00:53.531 --> 00:00:53.731
course.

00:00:53.731 --> 00:00:56.451
Now I do kind of want to like build out a course

00:00:56.871 --> 00:00:57.751
dedicated to just

00:00:58.151 --> 00:01:01.191
advanced payment implementations inside of a SaaS

00:01:01.351 --> 00:01:01.751
service.

00:01:01.831 --> 00:01:03.391
Now that's a pretty niche topic.

00:01:03.391 --> 00:01:05.111
So do let me know if that's something that you'd

00:01:05.111 --> 00:01:05.911
be interested in.

00:01:05.911 --> 00:01:07.951
So for this section of the course we're going to

00:01:07.951 --> 00:01:08.711
keep it pretty simple.

00:01:08.711 --> 00:01:09.271
But even

00:01:09.591 --> 00:01:10.551
even though it's simple,

00:01:10.551 --> 00:01:11.991
there's still a lot of things that you kind of

00:01:11.991 --> 00:01:13.031
have to like keep in your head.

00:01:13.031 --> 00:01:15.231
I do think this information will kind of create a

00:01:15.231 --> 00:01:17.271
foundation if you haven't implemented payments

00:01:17.271 --> 00:01:19.991
before to know enough to start building upon.

00:01:19.991 --> 00:01:20.991
So it will be useful.

00:01:20.991 --> 00:01:21.991
But this section is

00:01:22.041 --> 00:01:23.251
optional like this.

00:01:23.401 --> 00:01:24.921
The rest of the course you'll be able to do

00:01:24.921 --> 00:01:25.881
everything that you're

00:01:26.251 --> 00:01:26.531
like,

00:01:26.531 --> 00:01:27.771
you'll be able to like follow along with the

00:01:27.771 --> 00:01:29.451
course if you skip payments altogether.

00:01:29.451 --> 00:01:30.971
So it is okay if you want to skip it.

00:01:31.271 --> 00:01:33.331
but essentially what we're going to be doing is if

00:01:33.331 --> 00:01:34.411
you come over to better off,

00:01:34.411 --> 00:01:36.491
there's this section called third party plugins

00:01:36.491 --> 00:01:38.211
and essentially we have Stripe.

00:01:38.211 --> 00:01:38.460
Now

00:01:38.460 --> 00:01:41.717
this plugin notes that like the benefits of this

00:01:41.717 --> 00:01:42.797
plugin is one,

00:01:42.797 --> 00:01:46.437
it helps us create a Stripe customer when a user

00:01:46.437 --> 00:01:46.877
signs up.

00:01:46.877 --> 00:01:48.637
And the reason why that's like really nice is

00:01:48.637 --> 00:01:48.957
because

00:01:49.497 --> 00:01:52.977
Stripe has their own like customer API where it

00:01:52.977 --> 00:01:55.397
doesn't like map one to one to an email or a phone

00:01:55.397 --> 00:01:55.597
number.

00:01:55.597 --> 00:01:57.997
Like the same email can have dozens and dozens of

00:01:57.997 --> 00:01:58.837
Stripe customers.

00:01:58.837 --> 00:02:01.797
So kind of like keeping this is your user and this

00:02:01.797 --> 00:02:04.237
is their assigned customer ID is a tedious thing

00:02:04.237 --> 00:02:04.597
to do.

00:02:04.607 --> 00:02:06.877
and this plugin takes care of that for us.

00:02:06.877 --> 00:02:09.437
And we can basically say when a user

00:02:09.757 --> 00:02:11.877
signs up for the very first time we can pass in

00:02:11.877 --> 00:02:14.917
this flag to say create customer on signup as

00:02:14.917 --> 00:02:15.357
true.

00:02:15.357 --> 00:02:17.757
So the second a user like gives us their email and

00:02:17.757 --> 00:02:18.797
they sign up for the account,

00:02:18.797 --> 00:02:20.677
it'll go ahead and create a Stripe customer for

00:02:20.677 --> 00:02:20.887
that

00:02:20.887 --> 00:02:22.257
user even if they haven't paid.

00:02:22.257 --> 00:02:24.137
They'll just be a record in stripes database of

00:02:24.137 --> 00:02:25.877
like some somebody that potentially is going to be

00:02:25.877 --> 00:02:26.647
checking out soon.

00:02:26.647 --> 00:02:29.417
and then the second thing that is really nice

00:02:29.417 --> 00:02:30.337
about it is it has

00:02:30.557 --> 00:02:34.157
a backend implementation of managing subscriptions

00:02:34.477 --> 00:02:37.077
and then also it has front end hooks to interface

00:02:37.077 --> 00:02:37.877
with those subscriptions.

00:02:37.877 --> 00:02:38.957
So we'll get deeper into that.

00:02:39.087 --> 00:02:41.447
and then like the really like the last thing that

00:02:41.447 --> 00:02:43.567
I feel like is like super useful is

00:02:43.917 --> 00:02:44.317
they

00:02:44.637 --> 00:02:47.317
manage most of the web hook logic for us which is

00:02:47.317 --> 00:02:47.997
a huge win.

00:02:48.057 --> 00:02:49.777
because implementing like the web hook stuff can

00:02:49.777 --> 00:02:50.457
also be tedious.

00:02:50.457 --> 00:02:52.137
You need to know which webhooks to listen to.

00:02:52.137 --> 00:02:53.727
You need to know what that data looks like from

00:02:53.877 --> 00:02:55.237
Stripe and they need to figure out like okay,

00:02:55.237 --> 00:02:56.397
I get this event from Stripe,

00:02:56.397 --> 00:02:57.077
what do I do?

00:02:57.277 --> 00:02:59.757
business logic wise against my database.

00:02:59.757 --> 00:03:01.217
so they kind of take care of a lot of this like

00:03:01.217 --> 00:03:03.017
generic stuff for us which is really cool.

00:03:03.097 --> 00:03:03.497
So

00:03:03.817 --> 00:03:05.617
just some basic implementation here.

00:03:05.617 --> 00:03:06.777
Essentially you have

00:03:07.627 --> 00:03:08.906
this is the server side

00:03:09.087 --> 00:03:09.787
configuration.

00:03:09.867 --> 00:03:13.427
So we're going to be passing in this Stripe object

00:03:13.427 --> 00:03:14.107
and then

00:03:14.327 --> 00:03:17.327
generating a new like generating some additional

00:03:17.327 --> 00:03:18.367
schemas for it.

00:03:19.047 --> 00:03:21.847
then on the client side essentially we're going to

00:03:21.847 --> 00:03:23.787
be passing in this plugin on the client side as

00:03:23.787 --> 00:03:23.947
well.

00:03:23.947 --> 00:03:26.307
So inside of our React app and then we're going to

00:03:26.307 --> 00:03:27.747
say like subscriptions are true.

00:03:27.747 --> 00:03:29.307
And what that's going to do is it's going to give

00:03:29.307 --> 00:03:30.387
us these different hooks.

00:03:30.667 --> 00:03:31.796
see if they have an example of it

00:03:31.796 --> 00:03:32.852
on the client side.

00:03:32.898 --> 00:03:33.195
Yeah,

00:03:33.195 --> 00:03:34.795
they'll basically give us these hooks where we can

00:03:34.795 --> 00:03:35.315
call like

00:03:35.735 --> 00:03:37.095
upgrade or subscribe.

00:03:37.095 --> 00:03:38.655
And essentially what that's going to do is it's

00:03:38.655 --> 00:03:40.415
going to go through the process of like having the

00:03:40.415 --> 00:03:41.855
user onboard onto our product,

00:03:41.855 --> 00:03:43.575
put their credit card on file and actually charge

00:03:43.575 --> 00:03:43.895
them.

00:03:43.895 --> 00:03:44.295
So

00:03:44.515 --> 00:03:46.015
there's kind of a lot to go through here but we're

00:03:46.015 --> 00:03:47.535
just going to kind of take it piece by piece.

00:03:47.535 --> 00:03:49.255
So first thing that we're going to want to do is

00:03:49.255 --> 00:03:51.375
we're going to want to head over to our

00:03:52.375 --> 00:03:54.895
Data Ops package and this section is going to be

00:03:54.895 --> 00:03:57.255
exclusively inside of our Data Ops package.

00:03:57.255 --> 00:03:59.175
So I'm going to go ahead and say

00:03:59.815 --> 00:04:00.695
CD into

00:04:01.015 --> 00:04:01.655
packages

00:04:02.775 --> 00:04:03.735
Data Ops.

00:04:03.895 --> 00:04:05.495
And I'm just going to open this

00:04:07.015 --> 00:04:08.375
in a new,

00:04:08.605 --> 00:04:09.405
tab here.

00:04:09.485 --> 00:04:09.885
So

00:04:10.244 --> 00:04:11.964
now the first thing that we're going to do is

00:04:11.964 --> 00:04:13.964
we're going to come to source and then come to our

00:04:13.964 --> 00:04:14.324
auth

00:04:14.644 --> 00:04:17.324
file and we're going to be adding our Stripe

00:04:17.324 --> 00:04:17.804
plugin,

00:04:17.804 --> 00:04:20.304
which we can kind of look at example of it here.

00:04:22.268 --> 00:04:25.388
So you can see that they want us to install Stripe

00:04:25.388 --> 00:04:27.948
and they also want us to install the Better Auth

00:04:27.948 --> 00:04:28.908
Stripe plugin.

00:04:28.908 --> 00:04:32.148
Now what I did find is the versions really matter

00:04:32.148 --> 00:04:33.388
when working with plugins,

00:04:33.388 --> 00:04:35.388
so you need to make sure that you keep the same

00:04:35.388 --> 00:04:36.588
version of the,

00:04:36.618 --> 00:04:37.128
of the

00:04:37.448 --> 00:04:38.168
Stripe,

00:04:38.478 --> 00:04:40.378
like plugin for like the Better auth,

00:04:40.778 --> 00:04:43.018
the same version as like your actual Better auth.

00:04:43.652 --> 00:04:44.412
your better auth,

00:04:44.412 --> 00:04:45.492
like dependency.

00:04:45.492 --> 00:04:46.892
So I'll just show you what that means.

00:04:46.892 --> 00:04:48.052
It's probably a little bit confusing.

00:04:48.052 --> 00:04:49.892
So if we head over to our package JSON,

00:04:50.052 --> 00:04:51.572
what you're going to see here is we have better

00:04:51.572 --> 00:04:52.692
auth as a dependency

00:04:53.012 --> 00:04:53.412
and

00:04:53.971 --> 00:04:54.612
we could also,

00:04:54.612 --> 00:04:54.972
you know,

00:04:54.972 --> 00:04:55.812
run this command,

00:04:55.952 --> 00:04:57.312
to add pmpm,

00:04:57.312 --> 00:04:58.272
add Stripe.

00:04:58.272 --> 00:04:59.272
Better auth Stripe.

00:04:59.272 --> 00:05:01.272
Now I'm just going to go ahead and hard code these

00:05:01.272 --> 00:05:02.112
in just because,

00:05:02.352 --> 00:05:04.172
I did find that this is a little bit tedious.

00:05:04.172 --> 00:05:06.412
So we can go ahead and delete Better auth here

00:05:06.902 --> 00:05:08.262
and then I'm just going to,

00:05:08.672 --> 00:05:09.342
paste these in.

00:05:09.342 --> 00:05:11.382
So basically we have better auth and then now

00:05:11.382 --> 00:05:12.062
we're going to be using

00:05:12.542 --> 00:05:14.434
version 1.3.4.

00:05:14.476 --> 00:05:15.676
And additionally

00:05:15.996 --> 00:05:18.716
we now have this Better Auth plugin for Stripe,

00:05:18.716 --> 00:05:19.876
and that's going to be the same version.

00:05:19.876 --> 00:05:21.556
And notice I don't have this little character here

00:05:21.556 --> 00:05:23.036
because we're pinning these versions.

00:05:23.036 --> 00:05:24.076
We don't want these to change.

00:05:24.166 --> 00:05:25.214
Now while we're at it,

00:05:25.214 --> 00:05:27.374
I'm just going to go ahead and add Stripe here

00:05:27.374 --> 00:05:27.654
too.

00:05:27.894 --> 00:05:28.294
So,

00:05:29.334 --> 00:05:31.814
what we can do is we can say PMPMI and we should

00:05:31.814 --> 00:05:32.934
install these new versions.

00:05:33.428 --> 00:05:33.868
All right?

00:05:33.868 --> 00:05:36.348
So now what we can do is we can go ahead and

00:05:36.348 --> 00:05:37.588
import two different things.

00:05:37.588 --> 00:05:38.948
We'll import the Stripe plugin,

00:05:38.948 --> 00:05:40.028
I'll delete organizations,

00:05:40.028 --> 00:05:41.348
because we don't care about it anymore.

00:05:42.128 --> 00:05:43.728
the Stripe plugin from Better Auth.

00:05:43.728 --> 00:05:44.928
And then we're also going to,

00:05:45.508 --> 00:05:48.508
import the Stripe client from Stripes SDK.

00:05:48.508 --> 00:05:50.548
So we install both of these dependencies just now.

00:05:51.132 --> 00:05:52.732
After that we're going to go ahead and

00:05:53.452 --> 00:05:55.692
create a Stripe client here.

00:05:55.692 --> 00:05:57.852
And essentially what this is going to do is this

00:05:57.852 --> 00:05:58.572
is going to

00:05:59.172 --> 00:06:00.832
give us the ability to

00:06:02.461 --> 00:06:04.861
actually like build out the plugin system.

00:06:05.021 --> 00:06:05.421
So

00:06:05.441 --> 00:06:08.281
we're going to eventually have to pass in a key at

00:06:08.281 --> 00:06:08.801
this level,

00:06:09.381 --> 00:06:10.181
a Stripe API key,

00:06:10.181 --> 00:06:11.661
but we'll get to that in just a second.

00:06:11.713 --> 00:06:14.233
Now to use this Stripe plugin we're actually going

00:06:14.233 --> 00:06:15.853
to have to pass a few different like

00:06:15.853 --> 00:06:17.913
environment variables and secrets and whatnot

00:06:18.223 --> 00:06:18.703
into it.

00:06:18.703 --> 00:06:20.663
So in order to make this a little bit more

00:06:20.663 --> 00:06:23.343
extensible for like generating schemas but also

00:06:23.343 --> 00:06:24.623
integrating into our application,

00:06:24.863 --> 00:06:26.783
I'm going to go ahead and define this type which

00:06:26.783 --> 00:06:27.663
takes in a,

00:06:28.183 --> 00:06:30.393
Stripe web host secret and then also takes in

00:06:30.433 --> 00:06:32.083
plans array and you'll see what that means

00:06:32.253 --> 00:06:33.133
in just a minute.

00:06:34.253 --> 00:06:36.973
So from there what we're going to do is we're

00:06:36.973 --> 00:06:39.053
going to take this helper function and then I'm

00:06:39.053 --> 00:06:41.453
just going to say we're also going to be passing

00:06:41.453 --> 00:06:42.173
in an optional

00:06:42.493 --> 00:06:44.013
stripe configuration here.

00:06:45.473 --> 00:06:45.713
And

00:06:46.433 --> 00:06:48.673
what we can say is we pass in that stripe

00:06:48.673 --> 00:06:49.393
configuration

00:06:49.853 --> 00:06:50.416
and then

00:06:50.736 --> 00:06:52.816
under our actual better auth

00:06:52.866 --> 00:06:53.896
configuration here,

00:06:54.136 --> 00:06:55.976
we're going to go ahead and say plugins

00:06:57.416 --> 00:06:59.616
and that's going to take an array of plugins and

00:06:59.616 --> 00:07:01.376
we're going to be using the Stripe plugin,

00:07:01.376 --> 00:07:02.856
which is imported right here.

00:07:02.878 --> 00:07:04.481
And the stripe plugin is going to take some

00:07:04.481 --> 00:07:04.801
information.

00:07:05.121 --> 00:07:07.001
So first thing that we're going to do is we're

00:07:07.001 --> 00:07:08.161
going to provide it the

00:07:08.651 --> 00:07:10.491
Stripe client which we defined,

00:07:10.667 --> 00:07:11.307
right here.

00:07:11.330 --> 00:07:14.036
We are also going to be passing in the

00:07:14.826 --> 00:07:18.746
a Stripe webhook secret which can be pulled from a

00:07:18.746 --> 00:07:19.706
process emv,

00:07:19.706 --> 00:07:21.786
which will probably be adding it into a emv file

00:07:21.786 --> 00:07:22.426
in just a second.

00:07:22.746 --> 00:07:25.706
And then also it could take it from the top level

00:07:25.706 --> 00:07:26.266
property.

00:07:26.346 --> 00:07:28.506
So during runtime we could pass that in as well.

00:07:28.956 --> 00:07:31.046
I'm going to go ahead and have this configuration

00:07:31.786 --> 00:07:32.026
for

00:07:32.506 --> 00:07:33.946
Create Customer at signup.

00:07:33.946 --> 00:07:35.626
So essentially what this configuration is going to

00:07:35.626 --> 00:07:38.106
do is it's going to create the customer in stripe

00:07:38.106 --> 00:07:40.826
whenever a user signs up for the first time.

00:07:40.826 --> 00:07:43.066
And then also this is going to be what powers the

00:07:43.396 --> 00:07:44.406
new schema,

00:07:44.586 --> 00:07:46.705
for our users table and you'll see that in just a

00:07:46.705 --> 00:07:46.986
second.

00:07:47.706 --> 00:07:48.106
And

00:07:48.826 --> 00:07:51.866
also I'm going to pass in the subscriptions,

00:07:52.196 --> 00:07:53.526
the subscription property here,

00:07:53.766 --> 00:07:55.966
which basically says subscriptions are going to be

00:07:55.966 --> 00:07:57.926
enabled and it's going to be taking

00:07:58.216 --> 00:07:59.786
an array of plans and we'll get into that just a

00:07:59.786 --> 00:07:59.986
bit.

00:07:59.986 --> 00:08:00.746
So for now though,

00:08:00.746 --> 00:08:01.776
just for the purpose of this,

00:08:01.846 --> 00:08:02.806
I want to comment this out

00:08:03.758 --> 00:08:04.256
and then

00:08:04.576 --> 00:08:07.136
I suspect what we're also going to want to do here

00:08:07.136 --> 00:08:08.976
is at this get off level

00:08:09.456 --> 00:08:11.936
we will also be passing in a

00:08:12.696 --> 00:08:14.175
also be passing in stripe.

00:08:14.175 --> 00:08:15.816
So I'm going to knock this down one level

00:08:15.884 --> 00:08:16.483
comma

00:08:16.483 --> 00:08:18.602
and then this is also going to take a stripe

00:08:18.602 --> 00:08:21.722
config and we're going to be passing it into our

00:08:22.652 --> 00:08:23.978
create better auth client here.

00:08:24.270 --> 00:08:26.150
Now the next thing that we're going to do is we

00:08:26.150 --> 00:08:29.630
are going to head over to dashboard.swepe.com if

00:08:29.630 --> 00:08:30.670
you don't have a stripe account,

00:08:30.670 --> 00:08:31.670
you can go ahead and create one.

00:08:31.670 --> 00:08:32.030
It's very,

00:08:32.030 --> 00:08:32.670
very easy.

00:08:32.990 --> 00:08:35.950
Then on this left side you are going to see kind

00:08:35.950 --> 00:08:37.750
of like a drop down and you'll see a section that

00:08:37.750 --> 00:08:38.670
says sandbox.

00:08:39.000 --> 00:08:41.480
you can go ahead to sandbox and then there will be

00:08:41.480 --> 00:08:43.480
the option to like create a sandbox.

00:08:43.480 --> 00:08:44.800
So we're going to go ahead and just go through

00:08:44.800 --> 00:08:46.300
this process of creat a new sandbox.

00:08:46.300 --> 00:08:47.060
I'm going to say

00:08:47.860 --> 00:08:48.420
smart

00:08:48.900 --> 00:08:49.380
link

00:08:50.717 --> 00:08:51.117
and

00:08:51.377 --> 00:08:51.637
you could,

00:08:51.637 --> 00:08:53.997
if you have an existing account you could copy a

00:08:53.997 --> 00:08:56.197
bunch of like products and configurations over.

00:08:56.197 --> 00:08:57.957
But we're just going to start from scratch and

00:08:57.957 --> 00:08:58.972
basically say create account.

00:08:58.972 --> 00:08:59.492
All right,

00:08:59.492 --> 00:09:02.892
now from here what we can do is we can come over

00:09:02.892 --> 00:09:04.852
and we're going to grab our secret key

00:09:05.252 --> 00:09:06.212
and copy that.

00:09:06.292 --> 00:09:08.292
Now I have this

00:09:08.982 --> 00:09:11.262
this little helper function here or this like

00:09:11.262 --> 00:09:14.342
Stripe client which is being passed into our

00:09:14.342 --> 00:09:15.142
better auth

00:09:15.532 --> 00:09:16.322
configuration.

00:09:16.882 --> 00:09:19.522
And this is actually going to need a valid

00:09:19.792 --> 00:09:21.802
test key in order to generate the schemas.

00:09:21.802 --> 00:09:22.922
I honestly don't know why they do this.

00:09:22.922 --> 00:09:25.522
I feel like we shouldn't have to pass this in for

00:09:25.522 --> 00:09:26.562
schema generation.

00:09:26.642 --> 00:09:29.122
But they do want a valid key unfortunately.

00:09:29.202 --> 00:09:29.602
So

00:09:29.692 --> 00:09:32.242
we could add this into our process env.

00:09:32.242 --> 00:09:32.962
We'll just say

00:09:34.412 --> 00:09:34.892
stripe

00:09:35.692 --> 00:09:36.092
key

00:09:37.998 --> 00:09:39.444
and then we can say

00:09:43.314 --> 00:09:44.004
stripe key.

00:09:44.556 --> 00:09:46.632
And because this is only going to be used once,

00:09:46.632 --> 00:09:48.632
I'll just go ahead and force that type here.

00:09:48.872 --> 00:09:49.272
So.

00:09:49.512 --> 00:09:50.072
Okay,

00:09:50.712 --> 00:09:52.872
now this is where we're going to really want to

00:09:52.872 --> 00:09:53.512
pay close attention.

00:09:53.672 --> 00:09:54.632
So currently

00:09:55.372 --> 00:09:57.078
we have our auth schema

00:09:57.078 --> 00:09:59.541
and we have a users table.

00:09:59.541 --> 00:10:01.661
Now users table doesn't have any information about

00:10:01.661 --> 00:10:03.461
Stripe with this plugin.

00:10:03.461 --> 00:10:05.261
Essentially what's going to happen is we're going

00:10:05.261 --> 00:10:07.941
to be able to generate a new schema for

00:10:08.171 --> 00:10:11.241
users that actually has a Stripe customer id.

00:10:11.401 --> 00:10:12.521
So if you remember,

00:10:12.521 --> 00:10:13.961
we have our better auth

00:10:14.211 --> 00:10:16.891
command which is basically saying go ahead and

00:10:16.891 --> 00:10:18.371
look at our better auth

00:10:18.601 --> 00:10:19.501
auth gen file

00:10:20.211 --> 00:10:20.451
and

00:10:20.931 --> 00:10:23.531
put the output into this auth schema.

00:10:23.531 --> 00:10:25.411
So we can say pmpm run

00:10:27.628 --> 00:10:28.602
better auth generate

00:10:28.602 --> 00:10:30.592
it's basically going to tell us that,

00:10:30.792 --> 00:10:33.152
this is going to make some changes to this file

00:10:33.152 --> 00:10:34.072
which already exists.

00:10:34.072 --> 00:10:35.232
Do you want to overwrite them?

00:10:35.232 --> 00:10:36.472
We're going to go ahead and say yes.

00:10:36.678 --> 00:10:37.638
Now that that command,

00:10:37.738 --> 00:10:38.818
ran successfully,

00:10:39.218 --> 00:10:41.298
we can head over to our

00:10:41.778 --> 00:10:42.838
auth schema

00:10:42.838 --> 00:10:44.972
and what we're going to notice is this user table

00:10:45.372 --> 00:10:46.812
now has a stripe id.

00:10:47.292 --> 00:10:49.412
So essentially there's been a schema modification

00:10:49.412 --> 00:10:50.332
and this is where like,

00:10:50.332 --> 00:10:52.212
working with Drizzle just kind of gives us an

00:10:52.212 --> 00:10:53.092
extra step of.

00:10:53.092 --> 00:10:54.172
Now we have a,

00:10:54.232 --> 00:10:56.052
we have like a change in our table.

00:10:56.212 --> 00:10:57.812
So we're going to have to go ahead and create this

00:10:57.812 --> 00:10:58.252
column.

00:10:58.252 --> 00:10:59.002
Now we could just

00:10:59.392 --> 00:11:02.232
run a command inside of our D1 studio to create

00:11:02.232 --> 00:11:02.752
that column.

00:11:02.752 --> 00:11:05.112
But what we could also do is we have these helpful

00:11:05.112 --> 00:11:07.792
little commands inside of here where we can say

00:11:09.072 --> 00:11:09.412
pnpm

00:11:10.032 --> 00:11:10.432
run

00:11:10.752 --> 00:11:11.312
generate.

00:11:11.312 --> 00:11:13.992
And that's going to look at our auth schema and it

00:11:13.992 --> 00:11:15.312
should detect if there's a change.

00:11:15.392 --> 00:11:17.912
So notice we just got in our Drizzle out,

00:11:17.912 --> 00:11:20.552
we just got a new SQL file and that just basically

00:11:20.552 --> 00:11:22.512
spit out this command for us here.

00:11:23.152 --> 00:11:25.512
So we could head over to our Drizzle studio and

00:11:25.512 --> 00:11:27.072
this is our stage database.

00:11:27.462 --> 00:11:29.222
I'm going to paste this guy in there and run it.

00:11:29.542 --> 00:11:30.902
So now we've created that,

00:11:30.992 --> 00:11:32.105
we've created the user table

00:11:32.555 --> 00:11:33.195
and then,

00:11:33.465 --> 00:11:34.678
so we have alter user

00:11:34.678 --> 00:11:36.950
and then I'm also going to go do the same thing

00:11:36.950 --> 00:11:37.310
for

00:11:37.790 --> 00:11:38.190
our

00:11:38.510 --> 00:11:40.186
production database really quickly.

00:11:40.780 --> 00:11:41.299
All right,

00:11:41.379 --> 00:11:43.619
so now I just kind of want to like,

00:11:43.619 --> 00:11:45.609
stop for just a second and kind of recap.

00:11:45.699 --> 00:11:47.139
we have this configuration

00:11:47.599 --> 00:11:48.719
inside of our source

00:11:48.725 --> 00:11:49.411
called Auth

00:11:49.891 --> 00:11:51.371
and we added a plugin,

00:11:51.371 --> 00:11:53.251
and in this plugin we added some configurations

00:11:53.251 --> 00:11:54.051
that are required.

00:11:54.051 --> 00:11:56.371
And then we ran our generate command for better

00:11:56.371 --> 00:11:56.691
auth

00:11:57.011 --> 00:11:59.451
that gave us an update to our schema and then we

00:11:59.451 --> 00:12:01.091
used our schema to generate an update,

00:12:01.171 --> 00:12:04.331
like an actual like query to update the schema

00:12:04.331 --> 00:12:05.451
inside of our database.

00:12:05.451 --> 00:12:05.811
Now,

00:12:06.091 --> 00:12:07.531
the really important thing to understand about

00:12:07.531 --> 00:12:09.811
Better off are these plugins kind of dictate that

00:12:09.811 --> 00:12:12.251
schema and how the tables relate to each other.

00:12:12.251 --> 00:12:12.611
So,

00:12:12.921 --> 00:12:14.481
what you're going to notice is when we come over

00:12:14.481 --> 00:12:15.961
here and we say subscription,

00:12:17.431 --> 00:12:19.401
we're basically going to say subscription enabled

00:12:19.401 --> 00:12:19.961
to true.

00:12:20.441 --> 00:12:23.081
If we go ahead and we run our

00:12:23.431 --> 00:12:24.721
better auth generate command,

00:12:24.824 --> 00:12:26.303
it's going to go through this process again and

00:12:26.303 --> 00:12:27.624
it's probably going to prompt us if we want to

00:12:27.624 --> 00:12:28.304
override it.

00:12:28.544 --> 00:12:30.624
Then if we head back over to our

00:12:31.072 --> 00:12:32.836
auth ts in the drizzle output,

00:12:32.836 --> 00:12:34.705
what you're going to notice is we now have this

00:12:34.705 --> 00:12:35.635
subscription table.

00:12:36.505 --> 00:12:37.465
So if we run

00:12:37.895 --> 00:12:40.255
the PNPM run generate which is going to trigger

00:12:40.255 --> 00:12:41.655
the drizzle generation,

00:12:41.815 --> 00:12:44.335
we're going to get this new SQL file which

00:12:44.335 --> 00:12:45.495
basically says Create

00:12:46.475 --> 00:12:46.875
table.

00:12:46.955 --> 00:12:47.355
Now

00:12:47.835 --> 00:12:50.475
one thing that I do want to note after creating

00:12:50.475 --> 00:12:51.394
this to these tables,

00:12:51.394 --> 00:12:52.835
so we'll go ahead and create this table in

00:12:52.835 --> 00:12:53.355
production

00:12:54.315 --> 00:12:56.715
and I'm going to go ahead and create it in our

00:12:56.935 --> 00:12:57.690
stage database.

00:12:58.205 --> 00:13:00.005
Now a really important thing to note is like if

00:13:00.005 --> 00:13:02.765
you're not keeping these files in your project or

00:13:02.765 --> 00:13:04.175
they're outdated or whatnot,

00:13:04.305 --> 00:13:06.865
you could just go ahead and like delete meta

00:13:07.185 --> 00:13:07.585
here

00:13:07.590 --> 00:13:10.570
and then you could delete these files as well.

00:13:13.577 --> 00:13:15.737
Then when you run this generate command

00:13:16.057 --> 00:13:18.217
it's going to give you a SQL statement

00:13:18.947 --> 00:13:19.187
with

00:13:19.337 --> 00:13:20.847
the create statement with the Create

00:13:21.457 --> 00:13:23.457
statements for all of these tables.

00:13:23.457 --> 00:13:26.217
Now where this could be tedious is essentially for

00:13:26.217 --> 00:13:26.697
like user.

00:13:26.697 --> 00:13:28.577
For example you got the alter

00:13:29.097 --> 00:13:31.657
the alter command to basically like create this

00:13:31.657 --> 00:13:32.217
column.

00:13:32.377 --> 00:13:34.857
But if you don't keep this meta

00:13:34.947 --> 00:13:36.857
file up to date or you delete it or whatnot,

00:13:37.097 --> 00:13:39.337
essentially this is what this is keeping track of

00:13:39.337 --> 00:13:41.937
like table creations or changes and whatnot.

00:13:41.937 --> 00:13:43.417
So and then it generates those

00:13:43.527 --> 00:13:44.567
SQL commands for us.

00:13:44.567 --> 00:13:45.687
So if you don't have it,

00:13:45.687 --> 00:13:47.687
just note you probably already have this table

00:13:47.687 --> 00:13:48.167
created.

00:13:48.167 --> 00:13:49.987
You're going to have to just manually run the

00:13:49.987 --> 00:13:50.387
alter

00:13:50.637 --> 00:13:53.627
table command to create this column and then head

00:13:53.627 --> 00:13:54.347
over to

00:13:55.067 --> 00:13:55.839
subscription

00:13:55.839 --> 00:13:57.938
and do a similar thing here where you just create

00:13:57.938 --> 00:13:58.978
that subscription table.

00:13:58.978 --> 00:14:00.058
So by this point

00:14:00.228 --> 00:14:02.838
you should have subscription and the user table

00:14:02.838 --> 00:14:05.878
altered in both the production database and the

00:14:05.878 --> 00:14:06.918
stage database.

00:14:06.998 --> 00:14:07.398
Now

00:14:09.158 --> 00:14:11.558
the last thing that I'm going to want to do is I'm

00:14:11.558 --> 00:14:13.878
going to want to say pnpm run build

00:14:14.242 --> 00:14:16.922
and that is going to push these changes over for

00:14:16.922 --> 00:14:17.282
us

00:14:17.682 --> 00:14:20.442
or push these changes into this disk folder and

00:14:20.442 --> 00:14:23.512
then this is now going to be usable from by our

00:14:23.792 --> 00:14:26.112
like our actual like user application.

00:14:26.272 --> 00:14:26.672
So

00:14:27.041 --> 00:14:28.882
I hope you're able to follow up at this point

00:14:28.882 --> 00:14:31.282
essentially we're just kind of like configuring

00:14:31.772 --> 00:14:33.022
We're configuring our

00:14:33.268 --> 00:14:36.002
better auth server side client to take in some

00:14:36.002 --> 00:14:36.962
information about

00:14:37.902 --> 00:14:40.222
like Stripe webhook Secrets,

00:14:40.222 --> 00:14:41.916
Stripe API Secrets and whatnot.

00:14:42.172 --> 00:14:43.532
So we are actually able to

00:14:43.852 --> 00:14:44.652
generate the

00:14:44.832 --> 00:14:47.632
schema changes needed to power Stripe billing

00:14:47.952 --> 00:14:49.192
in our user application.

00:14:49.192 --> 00:14:51.552
Now one thing that I am noticing here is

00:14:52.112 --> 00:14:54.032
we may want to actually move

00:14:54.382 --> 00:14:55.512
we may want to move

00:14:55.832 --> 00:14:58.312
the stripe as an optional

00:14:59.269 --> 00:15:02.109
essentially as an optional property just so we can

00:15:02.109 --> 00:15:04.989
pass in the instantiated version during runtime.

00:15:04.989 --> 00:15:06.589
And I'll show you what that means in just a second

00:15:06.589 --> 00:15:06.949
here.

00:15:06.949 --> 00:15:09.109
So we're just going to make sure we have Stripe

00:15:09.109 --> 00:15:10.789
client being passed in

00:15:11.593 --> 00:15:12.551
if needed.

00:15:12.551 --> 00:15:14.871
So basically Stripe client is going to be

00:15:15.332 --> 00:15:16.938
config.speed

00:15:16.938 --> 00:15:18.429
config.

00:15:18.589 --> 00:15:20.029
Stripe client

00:15:20.834 --> 00:15:22.354
or Stripe Client if it

00:15:22.354 --> 00:15:23.574
if it isn't passed in.

00:15:23.574 --> 00:15:26.174
So then at this level whenever we actually use

00:15:26.174 --> 00:15:26.814
better auth,

00:15:27.134 --> 00:15:28.534
we can pass in that Stripe client.

00:15:28.534 --> 00:15:31.053
So we can actually pass it the production API key

00:15:31.053 --> 00:15:34.254
because this API key is just hard coded into our

00:15:34.254 --> 00:15:34.694
code,

00:15:34.694 --> 00:15:35.374
into our

00:15:35.374 --> 00:15:36.164
actual like

00:15:37.024 --> 00:15:37.384
build.

00:15:37.425 --> 00:15:37.692
All right,

00:15:37.692 --> 00:15:39.292
so in this next video we're going to

00:15:39.802 --> 00:15:41.842
actually before that make sure you build one last

00:15:41.842 --> 00:15:42.122
time.

00:15:42.122 --> 00:15:44.122
I don't want to leave you behind there.

00:15:44.122 --> 00:15:44.522
So

00:15:45.002 --> 00:15:46.442
pmpm run build

00:15:49.242 --> 00:15:51.562
and then we're going to be moving into the user

00:15:51.562 --> 00:15:51.962
application.

00:15:51.962 --> 00:15:53.962
We're actually going to be fully integrating the

00:15:54.542 --> 00:15:57.402
payments into our UI and our server side stuff.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.311 --> 00:00:02.871
So now let's integrate payments into our SaaS

00:00:02.871 --> 00:00:03.191
product.

00:00:03.271 --> 00:00:05.631
Now payments is kind of a topic that I went back

00:00:05.631 --> 00:00:06.391
and forth with,

00:00:07.131 --> 00:00:09.651
deciding if I actually wanted to put into this

00:00:09.651 --> 00:00:12.290
course just because it is such a broad topic and

00:00:12.290 --> 00:00:14.251
honestly it can become so complex

00:00:14.531 --> 00:00:17.731
as your use cases mature and become more niche.

00:00:17.811 --> 00:00:18.211
So

00:00:18.691 --> 00:00:21.051
just note that this is going to be a pretty simple

00:00:21.051 --> 00:00:22.651
implementation of Stripe.

00:00:22.651 --> 00:00:24.291
Essentially what we're going to be doing is we're

00:00:24.291 --> 00:00:26.131
going to be using the better off plugin

00:00:26.421 --> 00:00:28.181
to roll out Stripe subscriptions.

00:00:28.181 --> 00:00:31.741
Now this is kind of a valid way of like actually

00:00:31.741 --> 00:00:33.541
taking payments for the vast majority of these

00:00:33.541 --> 00:00:34.341
like SaaS products,

00:00:34.671 --> 00:00:35.711
even larger products.

00:00:35.711 --> 00:00:37.871
This is a pretty like standard implementation.

00:00:37.871 --> 00:00:40.351
But the second you're getting into like usage

00:00:40.351 --> 00:00:41.151
based billing,

00:00:41.341 --> 00:00:43.251
or you have like multiple different products and

00:00:43.571 --> 00:00:46.451
you need a lot more control over the entire like

00:00:46.451 --> 00:00:47.171
payment system,

00:00:47.491 --> 00:00:50.211
I feel like rolling your own solution is kind of

00:00:50.211 --> 00:00:51.811
the direction you have to go and we just don't

00:00:51.811 --> 00:00:53.531
have that type of time to go over that in the

00:00:53.531 --> 00:00:53.731
course.

00:00:53.731 --> 00:00:56.451
Now I do kind of want to like build out a course

00:00:56.871 --> 00:00:57.751
dedicated to just

00:00:58.151 --> 00:01:01.191
advanced payment implementations inside of a SaaS

00:01:01.351 --> 00:01:01.751
service.

00:01:01.831 --> 00:01:03.391
Now that's a pretty niche topic.

00:01:03.391 --> 00:01:05.111
So do let me know if that's something that you'd

00:01:05.111 --> 00:01:05.911
be interested in.

00:01:05.911 --> 00:01:07.951
So for this section of the course we're going to

00:01:07.951 --> 00:01:08.711
keep it pretty simple.

00:01:08.711 --> 00:01:09.271
But even

00:01:09.591 --> 00:01:10.551
even though it's simple,

00:01:10.551 --> 00:01:11.991
there's still a lot of things that you kind of

00:01:11.991 --> 00:01:13.031
have to like keep in your head.

00:01:13.031 --> 00:01:15.231
I do think this information will kind of create a

00:01:15.231 --> 00:01:17.271
foundation if you haven't implemented payments

00:01:17.271 --> 00:01:19.991
before to know enough to start building upon.

00:01:19.991 --> 00:01:20.991
So it will be useful.

00:01:20.991 --> 00:01:21.991
But this section is

00:01:22.041 --> 00:01:23.251
optional like this.

00:01:23.401 --> 00:01:24.921
The rest of the course you'll be able to do

00:01:24.921 --> 00:01:25.881
everything that you're

00:01:26.251 --> 00:01:26.531
like,

00:01:26.531 --> 00:01:27.771
you'll be able to like follow along with the

00:01:27.771 --> 00:01:29.451
course if you skip payments altogether.

00:01:29.451 --> 00:01:30.971
So it is okay if you want to skip it.

00:01:31.271 --> 00:01:33.331
but essentially what we're going to be doing is if

00:01:33.331 --> 00:01:34.411
you come over to better off,

00:01:34.411 --> 00:01:36.491
there's this section called third party plugins

00:01:36.491 --> 00:01:38.211
and essentially we have Stripe.

00:01:38.211 --> 00:01:38.460
Now

00:01:38.460 --> 00:01:41.717
this plugin notes that like the benefits of this

00:01:41.717 --> 00:01:42.797
plugin is one,

00:01:42.797 --> 00:01:46.437
it helps us create a Stripe customer when a user

00:01:46.437 --> 00:01:46.877
signs up.

00:01:46.877 --> 00:01:48.637
And the reason why that's like really nice is

00:01:48.637 --> 00:01:48.957
because

00:01:49.497 --> 00:01:52.977
Stripe has their own like customer API where it

00:01:52.977 --> 00:01:55.397
doesn't like map one to one to an email or a phone

00:01:55.397 --> 00:01:55.597
number.

00:01:55.597 --> 00:01:57.997
Like the same email can have dozens and dozens of

00:01:57.997 --> 00:01:58.837
Stripe customers.

00:01:58.837 --> 00:02:01.797
So kind of like keeping this is your user and this

00:02:01.797 --> 00:02:04.237
is their assigned customer ID is a tedious thing

00:02:04.237 --> 00:02:04.597
to do.

00:02:04.607 --> 00:02:06.877
and this plugin takes care of that for us.

00:02:06.877 --> 00:02:09.437
And we can basically say when a user

00:02:09.757 --> 00:02:11.877
signs up for the very first time we can pass in

00:02:11.877 --> 00:02:14.917
this flag to say create customer on signup as

00:02:14.917 --> 00:02:15.357
true.

00:02:15.357 --> 00:02:17.757
So the second a user like gives us their email and

00:02:17.757 --> 00:02:18.797
they sign up for the account,

00:02:18.797 --> 00:02:20.677
it'll go ahead and create a Stripe customer for

00:02:20.677 --> 00:02:20.887
that

00:02:20.887 --> 00:02:22.257
user even if they haven't paid.

00:02:22.257 --> 00:02:24.137
They'll just be a record in stripes database of

00:02:24.137 --> 00:02:25.877
like some somebody that potentially is going to be

00:02:25.877 --> 00:02:26.647
checking out soon.

00:02:26.647 --> 00:02:29.417
and then the second thing that is really nice

00:02:29.417 --> 00:02:30.337
about it is it has

00:02:30.557 --> 00:02:34.157
a backend implementation of managing subscriptions

00:02:34.477 --> 00:02:37.077
and then also it has front end hooks to interface

00:02:37.077 --> 00:02:37.877
with those subscriptions.

00:02:37.877 --> 00:02:38.957
So we'll get deeper into that.

00:02:39.087 --> 00:02:41.447
and then like the really like the last thing that

00:02:41.447 --> 00:02:43.567
I feel like is like super useful is

00:02:43.917 --> 00:02:44.317
they

00:02:44.637 --> 00:02:47.317
manage most of the web hook logic for us which is

00:02:47.317 --> 00:02:47.997
a huge win.

00:02:48.057 --> 00:02:49.777
because implementing like the web hook stuff can

00:02:49.777 --> 00:02:50.457
also be tedious.

00:02:50.457 --> 00:02:52.137
You need to know which webhooks to listen to.

00:02:52.137 --> 00:02:53.727
You need to know what that data looks like from

00:02:53.877 --> 00:02:55.237
Stripe and they need to figure out like okay,

00:02:55.237 --> 00:02:56.397
I get this event from Stripe,

00:02:56.397 --> 00:02:57.077
what do I do?

00:02:57.277 --> 00:02:59.757
business logic wise against my database.

00:02:59.757 --> 00:03:01.217
so they kind of take care of a lot of this like

00:03:01.217 --> 00:03:03.017
generic stuff for us which is really cool.

00:03:03.097 --> 00:03:03.497
So

00:03:03.817 --> 00:03:05.617
just some basic implementation here.

00:03:05.617 --> 00:03:06.777
Essentially you have

00:03:07.627 --> 00:03:08.906
this is the server side

00:03:09.087 --> 00:03:09.787
configuration.

00:03:09.867 --> 00:03:13.427
So we're going to be passing in this Stripe object

00:03:13.427 --> 00:03:14.107
and then

00:03:14.327 --> 00:03:17.327
generating a new like generating some additional

00:03:17.327 --> 00:03:18.367
schemas for it.

00:03:19.047 --> 00:03:21.847
then on the client side essentially we're going to

00:03:21.847 --> 00:03:23.787
be passing in this plugin on the client side as

00:03:23.787 --> 00:03:23.947
well.

00:03:23.947 --> 00:03:26.307
So inside of our React app and then we're going to

00:03:26.307 --> 00:03:27.747
say like subscriptions are true.

00:03:27.747 --> 00:03:29.307
And what that's going to do is it's going to give

00:03:29.307 --> 00:03:30.387
us these different hooks.

00:03:30.667 --> 00:03:31.796
see if they have an example of it

00:03:31.796 --> 00:03:32.852
on the client side.

00:03:32.898 --> 00:03:33.195
Yeah,

00:03:33.195 --> 00:03:34.795
they'll basically give us these hooks where we can

00:03:34.795 --> 00:03:35.315
call like

00:03:35.735 --> 00:03:37.095
upgrade or subscribe.

00:03:37.095 --> 00:03:38.655
And essentially what that's going to do is it's

00:03:38.655 --> 00:03:40.415
going to go through the process of like having the

00:03:40.415 --> 00:03:41.855
user onboard onto our product,

00:03:41.855 --> 00:03:43.575
put their credit card on file and actually charge

00:03:43.575 --> 00:03:43.895
them.

00:03:43.895 --> 00:03:44.295
So

00:03:44.515 --> 00:03:46.015
there's kind of a lot to go through here but we're

00:03:46.015 --> 00:03:47.535
just going to kind of take it piece by piece.

00:03:47.535 --> 00:03:49.255
So first thing that we're going to want to do is

00:03:49.255 --> 00:03:51.375
we're going to want to head over to our

00:03:52.375 --> 00:03:54.895
Data Ops package and this section is going to be

00:03:54.895 --> 00:03:57.255
exclusively inside of our Data Ops package.

00:03:57.255 --> 00:03:59.175
So I'm going to go ahead and say

00:03:59.815 --> 00:04:00.695
CD into

00:04:01.015 --> 00:04:01.655
packages

00:04:02.775 --> 00:04:03.735
Data Ops.

00:04:03.895 --> 00:04:05.495
And I'm just going to open this

00:04:07.015 --> 00:04:08.375
in a new,

00:04:08.605 --> 00:04:09.405
tab here.

00:04:09.485 --> 00:04:09.885
So

00:04:10.244 --> 00:04:11.964
now the first thing that we're going to do is

00:04:11.964 --> 00:04:13.964
we're going to come to source and then come to our

00:04:13.964 --> 00:04:14.324
auth

00:04:14.644 --> 00:04:17.324
file and we're going to be adding our Stripe

00:04:17.324 --> 00:04:17.804
plugin,

00:04:17.804 --> 00:04:20.304
which we can kind of look at example of it here.

00:04:22.268 --> 00:04:25.388
So you can see that they want us to install Stripe

00:04:25.388 --> 00:04:27.948
and they also want us to install the Better Auth

00:04:27.948 --> 00:04:28.908
Stripe plugin.

00:04:28.908 --> 00:04:32.148
Now what I did find is the versions really matter

00:04:32.148 --> 00:04:33.388
when working with plugins,

00:04:33.388 --> 00:04:35.388
so you need to make sure that you keep the same

00:04:35.388 --> 00:04:36.588
version of the,

00:04:36.618 --> 00:04:37.128
of the

00:04:37.448 --> 00:04:38.168
Stripe,

00:04:38.478 --> 00:04:40.378
like plugin for like the Better auth,

00:04:40.778 --> 00:04:43.018
the same version as like your actual Better auth.

00:04:43.652 --> 00:04:44.412
your better auth,

00:04:44.412 --> 00:04:45.492
like dependency.

00:04:45.492 --> 00:04:46.892
So I'll just show you what that means.

00:04:46.892 --> 00:04:48.052
It's probably a little bit confusing.

00:04:48.052 --> 00:04:49.892
So if we head over to our package JSON,

00:04:50.052 --> 00:04:51.572
what you're going to see here is we have better

00:04:51.572 --> 00:04:52.692
auth as a dependency

00:04:53.012 --> 00:04:53.412
and

00:04:53.971 --> 00:04:54.612
we could also,

00:04:54.612 --> 00:04:54.972
you know,

00:04:54.972 --> 00:04:55.812
run this command,

00:04:55.952 --> 00:04:57.312
to add pmpm,

00:04:57.312 --> 00:04:58.272
add Stripe.

00:04:58.272 --> 00:04:59.272
Better auth Stripe.

00:04:59.272 --> 00:05:01.272
Now I'm just going to go ahead and hard code these

00:05:01.272 --> 00:05:02.112
in just because,

00:05:02.352 --> 00:05:04.172
I did find that this is a little bit tedious.

00:05:04.172 --> 00:05:06.412
So we can go ahead and delete Better auth here

00:05:06.902 --> 00:05:08.262
and then I'm just going to,

00:05:08.672 --> 00:05:09.342
paste these in.

00:05:09.342 --> 00:05:11.382
So basically we have better auth and then now

00:05:11.382 --> 00:05:12.062
we're going to be using

00:05:12.542 --> 00:05:14.434
version 1.3.4.

00:05:14.476 --> 00:05:15.676
And additionally

00:05:15.996 --> 00:05:18.716
we now have this Better Auth plugin for Stripe,

00:05:18.716 --> 00:05:19.876
and that's going to be the same version.

00:05:19.876 --> 00:05:21.556
And notice I don't have this little character here

00:05:21.556 --> 00:05:23.036
because we're pinning these versions.

00:05:23.036 --> 00:05:24.076
We don't want these to change.

00:05:24.166 --> 00:05:25.214
Now while we're at it,

00:05:25.214 --> 00:05:27.374
I'm just going to go ahead and add Stripe here

00:05:27.374 --> 00:05:27.654
too.

00:05:27.894 --> 00:05:28.294
So,

00:05:29.334 --> 00:05:31.814
what we can do is we can say PMPMI and we should

00:05:31.814 --> 00:05:32.934
install these new versions.

00:05:33.428 --> 00:05:33.868
All right?

00:05:33.868 --> 00:05:36.348
So now what we can do is we can go ahead and

00:05:36.348 --> 00:05:37.588
import two different things.

00:05:37.588 --> 00:05:38.948
We'll import the Stripe plugin,

00:05:38.948 --> 00:05:40.028
I'll delete organizations,

00:05:40.028 --> 00:05:41.348
because we don't care about it anymore.

00:05:42.128 --> 00:05:43.728
the Stripe plugin from Better Auth.

00:05:43.728 --> 00:05:44.928
And then we're also going to,

00:05:45.508 --> 00:05:48.508
import the Stripe client from Stripes SDK.

00:05:48.508 --> 00:05:50.548
So we install both of these dependencies just now.

00:05:51.132 --> 00:05:52.732
After that we're going to go ahead and

00:05:53.452 --> 00:05:55.692
create a Stripe client here.

00:05:55.692 --> 00:05:57.852
And essentially what this is going to do is this

00:05:57.852 --> 00:05:58.572
is going to

00:05:59.172 --> 00:06:00.832
give us the ability to

00:06:02.461 --> 00:06:04.861
actually like build out the plugin system.

00:06:05.021 --> 00:06:05.421
So

00:06:05.441 --> 00:06:08.281
we're going to eventually have to pass in a key at

00:06:08.281 --> 00:06:08.801
this level,

00:06:09.381 --> 00:06:10.181
a Stripe API key,

00:06:10.181 --> 00:06:11.661
but we'll get to that in just a second.

00:06:11.713 --> 00:06:14.233
Now to use this Stripe plugin we're actually going

00:06:14.233 --> 00:06:15.853
to have to pass a few different like

00:06:15.853 --> 00:06:17.913
environment variables and secrets and whatnot

00:06:18.223 --> 00:06:18.703
into it.

00:06:18.703 --> 00:06:20.663
So in order to make this a little bit more

00:06:20.663 --> 00:06:23.343
extensible for like generating schemas but also

00:06:23.343 --> 00:06:24.623
integrating into our application,

00:06:24.863 --> 00:06:26.783
I'm going to go ahead and define this type which

00:06:26.783 --> 00:06:27.663
takes in a,

00:06:28.183 --> 00:06:30.393
Stripe web host secret and then also takes in

00:06:30.433 --> 00:06:32.083
plans array and you'll see what that means

00:06:32.253 --> 00:06:33.133
in just a minute.

00:06:34.253 --> 00:06:36.973
So from there what we're going to do is we're

00:06:36.973 --> 00:06:39.053
going to take this helper function and then I'm

00:06:39.053 --> 00:06:41.453
just going to say we're also going to be passing

00:06:41.453 --> 00:06:42.173
in an optional

00:06:42.493 --> 00:06:44.013
stripe configuration here.

00:06:45.473 --> 00:06:45.713
And

00:06:46.433 --> 00:06:48.673
what we can say is we pass in that stripe

00:06:48.673 --> 00:06:49.393
configuration

00:06:49.853 --> 00:06:50.416
and then

00:06:50.736 --> 00:06:52.816
under our actual better auth

00:06:52.866 --> 00:06:53.896
configuration here,

00:06:54.136 --> 00:06:55.976
we're going to go ahead and say plugins

00:06:57.416 --> 00:06:59.616
and that's going to take an array of plugins and

00:06:59.616 --> 00:07:01.376
we're going to be using the Stripe plugin,

00:07:01.376 --> 00:07:02.856
which is imported right here.

00:07:02.878 --> 00:07:04.481
And the stripe plugin is going to take some

00:07:04.481 --> 00:07:04.801
information.

00:07:05.121 --> 00:07:07.001
So first thing that we're going to do is we're

00:07:07.001 --> 00:07:08.161
going to provide it the

00:07:08.651 --> 00:07:10.491
Stripe client which we defined,

00:07:10.667 --> 00:07:11.307
right here.

00:07:11.330 --> 00:07:14.036
We are also going to be passing in the

00:07:14.826 --> 00:07:18.746
a Stripe webhook secret which can be pulled from a

00:07:18.746 --> 00:07:19.706
process emv,

00:07:19.706 --> 00:07:21.786
which will probably be adding it into a emv file

00:07:21.786 --> 00:07:22.426
in just a second.

00:07:22.746 --> 00:07:25.706
And then also it could take it from the top level

00:07:25.706 --> 00:07:26.266
property.

00:07:26.346 --> 00:07:28.506
So during runtime we could pass that in as well.

00:07:28.956 --> 00:07:31.046
I'm going to go ahead and have this configuration

00:07:31.786 --> 00:07:32.026
for

00:07:32.506 --> 00:07:33.946
Create Customer at signup.

00:07:33.946 --> 00:07:35.626
So essentially what this configuration is going to

00:07:35.626 --> 00:07:38.106
do is it's going to create the customer in stripe

00:07:38.106 --> 00:07:40.826
whenever a user signs up for the first time.

00:07:40.826 --> 00:07:43.066
And then also this is going to be what powers the

00:07:43.396 --> 00:07:44.406
new schema,

00:07:44.586 --> 00:07:46.705
for our users table and you'll see that in just a

00:07:46.705 --> 00:07:46.986
second.

00:07:47.706 --> 00:07:48.106
And

00:07:48.826 --> 00:07:51.866
also I'm going to pass in the subscriptions,

00:07:52.196 --> 00:07:53.526
the subscription property here,

00:07:53.766 --> 00:07:55.966
which basically says subscriptions are going to be

00:07:55.966 --> 00:07:57.926
enabled and it's going to be taking

00:07:58.216 --> 00:07:59.786
an array of plans and we'll get into that just a

00:07:59.786 --> 00:07:59.986
bit.

00:07:59.986 --> 00:08:00.746
So for now though,

00:08:00.746 --> 00:08:01.776
just for the purpose of this,

00:08:01.846 --> 00:08:02.806
I want to comment this out

00:08:03.758 --> 00:08:04.256
and then

00:08:04.576 --> 00:08:07.136
I suspect what we're also going to want to do here

00:08:07.136 --> 00:08:08.976
is at this get off level

00:08:09.456 --> 00:08:11.936
we will also be passing in a

00:08:12.696 --> 00:08:14.175
also be passing in stripe.

00:08:14.175 --> 00:08:15.816
So I'm going to knock this down one level

00:08:15.884 --> 00:08:16.483
comma

00:08:16.483 --> 00:08:18.602
and then this is also going to take a stripe

00:08:18.602 --> 00:08:21.722
config and we're going to be passing it into our

00:08:22.652 --> 00:08:23.978
create better auth client here.

00:08:24.270 --> 00:08:26.150
Now the next thing that we're going to do is we

00:08:26.150 --> 00:08:29.630
are going to head over to dashboard.swepe.com if

00:08:29.630 --> 00:08:30.670
you don't have a stripe account,

00:08:30.670 --> 00:08:31.670
you can go ahead and create one.

00:08:31.670 --> 00:08:32.030
It's very,

00:08:32.030 --> 00:08:32.670
very easy.

00:08:32.990 --> 00:08:35.950
Then on this left side you are going to see kind

00:08:35.950 --> 00:08:37.750
of like a drop down and you'll see a section that

00:08:37.750 --> 00:08:38.670
says sandbox.

00:08:39.000 --> 00:08:41.480
you can go ahead to sandbox and then there will be

00:08:41.480 --> 00:08:43.480
the option to like create a sandbox.

00:08:43.480 --> 00:08:44.800
So we're going to go ahead and just go through

00:08:44.800 --> 00:08:46.300
this process of creat a new sandbox.

00:08:46.300 --> 00:08:47.060
I'm going to say

00:08:47.860 --> 00:08:48.420
smart

00:08:48.900 --> 00:08:49.380
link

00:08:50.717 --> 00:08:51.117
and

00:08:51.377 --> 00:08:51.637
you could,

00:08:51.637 --> 00:08:53.997
if you have an existing account you could copy a

00:08:53.997 --> 00:08:56.197
bunch of like products and configurations over.

00:08:56.197 --> 00:08:57.957
But we're just going to start from scratch and

00:08:57.957 --> 00:08:58.972
basically say create account.

00:08:58.972 --> 00:08:59.492
All right,

00:08:59.492 --> 00:09:02.892
now from here what we can do is we can come over

00:09:02.892 --> 00:09:04.852
and we're going to grab our secret key

00:09:05.252 --> 00:09:06.212
and copy that.

00:09:06.292 --> 00:09:08.292
Now I have this

00:09:08.982 --> 00:09:11.262
this little helper function here or this like

00:09:11.262 --> 00:09:14.342
Stripe client which is being passed into our

00:09:14.342 --> 00:09:15.142
better auth

00:09:15.532 --> 00:09:16.322
configuration.

00:09:16.882 --> 00:09:19.522
And this is actually going to need a valid

00:09:19.792 --> 00:09:21.802
test key in order to generate the schemas.

00:09:21.802 --> 00:09:22.922
I honestly don't know why they do this.

00:09:22.922 --> 00:09:25.522
I feel like we shouldn't have to pass this in for

00:09:25.522 --> 00:09:26.562
schema generation.

00:09:26.642 --> 00:09:29.122
But they do want a valid key unfortunately.

00:09:29.202 --> 00:09:29.602
So

00:09:29.692 --> 00:09:32.242
we could add this into our process env.

00:09:32.242 --> 00:09:32.962
We'll just say

00:09:34.412 --> 00:09:34.892
stripe

00:09:35.692 --> 00:09:36.092
key

00:09:37.998 --> 00:09:39.444
and then we can say

00:09:43.314 --> 00:09:44.004
stripe key.

00:09:44.556 --> 00:09:46.632
And because this is only going to be used once,

00:09:46.632 --> 00:09:48.632
I'll just go ahead and force that type here.

00:09:48.872 --> 00:09:49.272
So.

00:09:49.512 --> 00:09:50.072
Okay,

00:09:50.712 --> 00:09:52.872
now this is where we're going to really want to

00:09:52.872 --> 00:09:53.512
pay close attention.

00:09:53.672 --> 00:09:54.632
So currently

00:09:55.372 --> 00:09:57.078
we have our auth schema

00:09:57.078 --> 00:09:59.541
and we have a users table.

00:09:59.541 --> 00:10:01.661
Now users table doesn't have any information about

00:10:01.661 --> 00:10:03.461
Stripe with this plugin.

00:10:03.461 --> 00:10:05.261
Essentially what's going to happen is we're going

00:10:05.261 --> 00:10:07.941
to be able to generate a new schema for

00:10:08.171 --> 00:10:11.241
users that actually has a Stripe customer id.

00:10:11.401 --> 00:10:12.521
So if you remember,

00:10:12.521 --> 00:10:13.961
we have our better auth

00:10:14.211 --> 00:10:16.891
command which is basically saying go ahead and

00:10:16.891 --> 00:10:18.371
look at our better auth

00:10:18.601 --> 00:10:19.501
auth gen file

00:10:20.211 --> 00:10:20.451
and

00:10:20.931 --> 00:10:23.531
put the output into this auth schema.

00:10:23.531 --> 00:10:25.411
So we can say pmpm run

00:10:27.628 --> 00:10:28.602
better auth generate

00:10:28.602 --> 00:10:30.592
it's basically going to tell us that,

00:10:30.792 --> 00:10:33.152
this is going to make some changes to this file

00:10:33.152 --> 00:10:34.072
which already exists.

00:10:34.072 --> 00:10:35.232
Do you want to overwrite them?

00:10:35.232 --> 00:10:36.472
We're going to go ahead and say yes.

00:10:36.678 --> 00:10:37.638
Now that that command,

00:10:37.738 --> 00:10:38.818
ran successfully,

00:10:39.218 --> 00:10:41.298
we can head over to our

00:10:41.778 --> 00:10:42.838
auth schema

00:10:42.838 --> 00:10:44.972
and what we're going to notice is this user table

00:10:45.372 --> 00:10:46.812
now has a stripe id.

00:10:47.292 --> 00:10:49.412
So essentially there's been a schema modification

00:10:49.412 --> 00:10:50.332
and this is where like,

00:10:50.332 --> 00:10:52.212
working with Drizzle just kind of gives us an

00:10:52.212 --> 00:10:53.092
extra step of.

00:10:53.092 --> 00:10:54.172
Now we have a,

00:10:54.232 --> 00:10:56.052
we have like a change in our table.

00:10:56.212 --> 00:10:57.812
So we're going to have to go ahead and create this

00:10:57.812 --> 00:10:58.252
column.

00:10:58.252 --> 00:10:59.002
Now we could just

00:10:59.392 --> 00:11:02.232
run a command inside of our D1 studio to create

00:11:02.232 --> 00:11:02.752
that column.

00:11:02.752 --> 00:11:05.112
But what we could also do is we have these helpful

00:11:05.112 --> 00:11:07.792
little commands inside of here where we can say

00:11:09.072 --> 00:11:09.412
pnpm

00:11:10.032 --> 00:11:10.432
run

00:11:10.752 --> 00:11:11.312
generate.

00:11:11.312 --> 00:11:13.992
And that's going to look at our auth schema and it

00:11:13.992 --> 00:11:15.312
should detect if there's a change.

00:11:15.392 --> 00:11:17.912
So notice we just got in our Drizzle out,

00:11:17.912 --> 00:11:20.552
we just got a new SQL file and that just basically

00:11:20.552 --> 00:11:22.512
spit out this command for us here.

00:11:23.152 --> 00:11:25.512
So we could head over to our Drizzle studio and

00:11:25.512 --> 00:11:27.072
this is our stage database.

00:11:27.462 --> 00:11:29.222
I'm going to paste this guy in there and run it.

00:11:29.542 --> 00:11:30.902
So now we've created that,

00:11:30.992 --> 00:11:32.105
we've created the user table

00:11:32.555 --> 00:11:33.195
and then,

00:11:33.465 --> 00:11:34.678
so we have alter user

00:11:34.678 --> 00:11:36.950
and then I'm also going to go do the same thing

00:11:36.950 --> 00:11:37.310
for

00:11:37.790 --> 00:11:38.190
our

00:11:38.510 --> 00:11:40.186
production database really quickly.

00:11:40.780 --> 00:11:41.299
All right,

00:11:41.379 --> 00:11:43.619
so now I just kind of want to like,

00:11:43.619 --> 00:11:45.609
stop for just a second and kind of recap.

00:11:45.699 --> 00:11:47.139
we have this configuration

00:11:47.599 --> 00:11:48.719
inside of our source

00:11:48.725 --> 00:11:49.411
called Auth

00:11:49.891 --> 00:11:51.371
and we added a plugin,

00:11:51.371 --> 00:11:53.251
and in this plugin we added some configurations

00:11:53.251 --> 00:11:54.051
that are required.

00:11:54.051 --> 00:11:56.371
And then we ran our generate command for better

00:11:56.371 --> 00:11:56.691
auth

00:11:57.011 --> 00:11:59.451
that gave us an update to our schema and then we

00:11:59.451 --> 00:12:01.091
used our schema to generate an update,

00:12:01.171 --> 00:12:04.331
like an actual like query to update the schema

00:12:04.331 --> 00:12:05.451
inside of our database.

00:12:05.451 --> 00:12:05.811
Now,

00:12:06.091 --> 00:12:07.531
the really important thing to understand about

00:12:07.531 --> 00:12:09.811
Better off are these plugins kind of dictate that

00:12:09.811 --> 00:12:12.251
schema and how the tables relate to each other.

00:12:12.251 --> 00:12:12.611
So,

00:12:12.921 --> 00:12:14.481
what you're going to notice is when we come over

00:12:14.481 --> 00:12:15.961
here and we say subscription,

00:12:17.431 --> 00:12:19.401
we're basically going to say subscription enabled

00:12:19.401 --> 00:12:19.961
to true.

00:12:20.441 --> 00:12:23.081
If we go ahead and we run our

00:12:23.431 --> 00:12:24.721
better auth generate command,

00:12:24.824 --> 00:12:26.303
it's going to go through this process again and

00:12:26.303 --> 00:12:27.624
it's probably going to prompt us if we want to

00:12:27.624 --> 00:12:28.304
override it.

00:12:28.544 --> 00:12:30.624
Then if we head back over to our

00:12:31.072 --> 00:12:32.836
auth ts in the drizzle output,

00:12:32.836 --> 00:12:34.705
what you're going to notice is we now have this

00:12:34.705 --> 00:12:35.635
subscription table.

00:12:36.505 --> 00:12:37.465
So if we run

00:12:37.895 --> 00:12:40.255
the PNPM run generate which is going to trigger

00:12:40.255 --> 00:12:41.655
the drizzle generation,

00:12:41.815 --> 00:12:44.335
we're going to get this new SQL file which

00:12:44.335 --> 00:12:45.495
basically says Create

00:12:46.475 --> 00:12:46.875
table.

00:12:46.955 --> 00:12:47.355
Now

00:12:47.835 --> 00:12:50.475
one thing that I do want to note after creating

00:12:50.475 --> 00:12:51.394
this to these tables,

00:12:51.394 --> 00:12:52.835
so we'll go ahead and create this table in

00:12:52.835 --> 00:12:53.355
production

00:12:54.315 --> 00:12:56.715
and I'm going to go ahead and create it in our

00:12:56.935 --> 00:12:57.690
stage database.

00:12:58.205 --> 00:13:00.005
Now a really important thing to note is like if

00:13:00.005 --> 00:13:02.765
you're not keeping these files in your project or

00:13:02.765 --> 00:13:04.175
they're outdated or whatnot,

00:13:04.305 --> 00:13:06.865
you could just go ahead and like delete meta

00:13:07.185 --> 00:13:07.585
here

00:13:07.590 --> 00:13:10.570
and then you could delete these files as well.

00:13:13.577 --> 00:13:15.737
Then when you run this generate command

00:13:16.057 --> 00:13:18.217
it's going to give you a SQL statement

00:13:18.947 --> 00:13:19.187
with

00:13:19.337 --> 00:13:20.847
the create statement with the Create

00:13:21.457 --> 00:13:23.457
statements for all of these tables.

00:13:23.457 --> 00:13:26.217
Now where this could be tedious is essentially for

00:13:26.217 --> 00:13:26.697
like user.

00:13:26.697 --> 00:13:28.577
For example you got the alter

00:13:29.097 --> 00:13:31.657
the alter command to basically like create this

00:13:31.657 --> 00:13:32.217
column.

00:13:32.377 --> 00:13:34.857
But if you don't keep this meta

00:13:34.947 --> 00:13:36.857
file up to date or you delete it or whatnot,

00:13:37.097 --> 00:13:39.337
essentially this is what this is keeping track of

00:13:39.337 --> 00:13:41.937
like table creations or changes and whatnot.

00:13:41.937 --> 00:13:43.417
So and then it generates those

00:13:43.527 --> 00:13:44.567
SQL commands for us.

00:13:44.567 --> 00:13:45.687
So if you don't have it,

00:13:45.687 --> 00:13:47.687
just note you probably already have this table

00:13:47.687 --> 00:13:48.167
created.

00:13:48.167 --> 00:13:49.987
You're going to have to just manually run the

00:13:49.987 --> 00:13:50.387
alter

00:13:50.637 --> 00:13:53.627
table command to create this column and then head

00:13:53.627 --> 00:13:54.347
over to

00:13:55.067 --> 00:13:55.839
subscription

00:13:55.839 --> 00:13:57.938
and do a similar thing here where you just create

00:13:57.938 --> 00:13:58.978
that subscription table.

00:13:58.978 --> 00:14:00.058
So by this point

00:14:00.228 --> 00:14:02.838
you should have subscription and the user table

00:14:02.838 --> 00:14:05.878
altered in both the production database and the

00:14:05.878 --> 00:14:06.918
stage database.

00:14:06.998 --> 00:14:07.398
Now

00:14:09.158 --> 00:14:11.558
the last thing that I'm going to want to do is I'm

00:14:11.558 --> 00:14:13.878
going to want to say pnpm run build

00:14:14.242 --> 00:14:16.922
and that is going to push these changes over for

00:14:16.922 --> 00:14:17.282
us

00:14:17.682 --> 00:14:20.442
or push these changes into this disk folder and

00:14:20.442 --> 00:14:23.512
then this is now going to be usable from by our

00:14:23.792 --> 00:14:26.112
like our actual like user application.

00:14:26.272 --> 00:14:26.672
So

00:14:27.041 --> 00:14:28.882
I hope you're able to follow up at this point

00:14:28.882 --> 00:14:31.282
essentially we're just kind of like configuring

00:14:31.772 --> 00:14:33.022
We're configuring our

00:14:33.268 --> 00:14:36.002
better auth server side client to take in some

00:14:36.002 --> 00:14:36.962
information about

00:14:37.902 --> 00:14:40.222
like Stripe webhook Secrets,

00:14:40.222 --> 00:14:41.916
Stripe API Secrets and whatnot.

00:14:42.172 --> 00:14:43.532
So we are actually able to

00:14:43.852 --> 00:14:44.652
generate the

00:14:44.832 --> 00:14:47.632
schema changes needed to power Stripe billing

00:14:47.952 --> 00:14:49.192
in our user application.

00:14:49.192 --> 00:14:51.552
Now one thing that I am noticing here is

00:14:52.112 --> 00:14:54.032
we may want to actually move

00:14:54.382 --> 00:14:55.512
we may want to move

00:14:55.832 --> 00:14:58.312
the stripe as an optional

00:14:59.269 --> 00:15:02.109
essentially as an optional property just so we can

00:15:02.109 --> 00:15:04.989
pass in the instantiated version during runtime.

00:15:04.989 --> 00:15:06.589
And I'll show you what that means in just a second

00:15:06.589 --> 00:15:06.949
here.

00:15:06.949 --> 00:15:09.109
So we're just going to make sure we have Stripe

00:15:09.109 --> 00:15:10.789
client being passed in

00:15:11.593 --> 00:15:12.551
if needed.

00:15:12.551 --> 00:15:14.871
So basically Stripe client is going to be

00:15:15.332 --> 00:15:16.938
config.speed

00:15:16.938 --> 00:15:18.429
config.

00:15:18.589 --> 00:15:20.029
Stripe client

00:15:20.834 --> 00:15:22.354
or Stripe Client if it

00:15:22.354 --> 00:15:23.574
if it isn't passed in.

00:15:23.574 --> 00:15:26.174
So then at this level whenever we actually use

00:15:26.174 --> 00:15:26.814
better auth,

00:15:27.134 --> 00:15:28.534
we can pass in that Stripe client.

00:15:28.534 --> 00:15:31.053
So we can actually pass it the production API key

00:15:31.053 --> 00:15:34.254
because this API key is just hard coded into our

00:15:34.254 --> 00:15:34.694
code,

00:15:34.694 --> 00:15:35.374
into our

00:15:35.374 --> 00:15:36.164
actual like

00:15:37.024 --> 00:15:37.384
build.

00:15:37.425 --> 00:15:37.692
All right,

00:15:37.692 --> 00:15:39.292
so in this next video we're going to

00:15:39.802 --> 00:15:41.842
actually before that make sure you build one last

00:15:41.842 --> 00:15:42.122
time.

00:15:42.122 --> 00:15:44.122
I don't want to leave you behind there.

00:15:44.122 --> 00:15:44.522
So

00:15:45.002 --> 00:15:46.442
pmpm run build

00:15:49.242 --> 00:15:51.562
and then we're going to be moving into the user

00:15:51.562 --> 00:15:51.962
application.

00:15:51.962 --> 00:15:53.962
We're actually going to be fully integrating the

00:15:54.542 --> 00:15:57.402
payments into our UI and our server side stuff.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.055 --> 00:00:00.455
All right,

00:00:00.455 --> 00:00:02.815
so now let's get to the fun part of the payments,

00:00:02.815 --> 00:00:05.655
which is actually creating the UI for it.

00:00:05.655 --> 00:00:08.455
So essentially what I want to happen is I want a

00:00:08.455 --> 00:00:10.135
page called Upgrade right here,

00:00:10.135 --> 00:00:11.495
which is currently not found.

00:00:12.125 --> 00:00:14.245
and I want that to have kind of like all of the

00:00:14.245 --> 00:00:15.805
pricing tiers and whatnot.

00:00:15.805 --> 00:00:16.205
So

00:00:16.525 --> 00:00:19.205
what we can do to begin with is if you have your

00:00:19.205 --> 00:00:20.445
application running,

00:00:20.445 --> 00:00:21.565
just head over to

00:00:22.315 --> 00:00:22.635
Routes

00:00:22.955 --> 00:00:23.355
app

00:00:23.675 --> 00:00:25.595
Auth and then we will just say

00:00:27.115 --> 00:00:28.635
upgrade tsx.

00:00:28.877 --> 00:00:31.069
That should spit out a dummy page for you here.

00:00:31.229 --> 00:00:34.509
So now you have this like dummy data that is

00:00:34.509 --> 00:00:35.109
currently here.

00:00:35.109 --> 00:00:37.709
So what we're going to do is we're going to coast

00:00:37.709 --> 00:00:39.709
through this because there's kind of a lot of code

00:00:39.709 --> 00:00:41.349
and I don't think it's really worth going into

00:00:41.349 --> 00:00:42.669
like every line of it.

00:00:42.669 --> 00:00:44.479
I'll just kind of COVID the really important

00:00:44.479 --> 00:00:44.959
stuff.

00:00:45.359 --> 00:00:46.879
So inside of components

00:00:47.469 --> 00:00:49.309
we're going to go ahead and say

00:00:50.829 --> 00:00:51.469
payment.

00:00:51.666 --> 00:00:53.866
So now that we have our payments folder,

00:00:53.866 --> 00:00:54.986
let's head over to Auth

00:00:55.386 --> 00:00:55.916
client

00:00:55.916 --> 00:00:56.505
T's.

00:00:56.666 --> 00:01:00.106
And then let's just pass in some plugins here so

00:01:00.186 --> 00:01:02.586
we can specify some additional configuration.

00:01:02.666 --> 00:01:04.906
So we can say plugins and then we're going to add

00:01:04.906 --> 00:01:06.986
the Stripe client as a plugin.

00:01:07.390 --> 00:01:10.350
We should be able to just import this directly

00:01:10.350 --> 00:01:12.270
from the better auth stripe.

00:01:12.830 --> 00:01:14.790
And essentially what that's going to do is that is

00:01:14.790 --> 00:01:16.670
going to take in subscriptions.

00:01:16.750 --> 00:01:17.190
True.

00:01:17.190 --> 00:01:19.870
Which is going to allow us to have to access the

00:01:19.870 --> 00:01:21.870
subscription API and I'll show you exactly what

00:01:21.870 --> 00:01:22.630
that's going to look like.

00:01:22.630 --> 00:01:24.750
So now let's head back over to our

00:01:25.150 --> 00:01:25.710
payments

00:01:25.970 --> 00:01:28.210
folder and we are going to be creating

00:01:29.090 --> 00:01:30.770
four different files into here.

00:01:31.030 --> 00:01:33.110
and those four files there will be three actual

00:01:33.110 --> 00:01:33.630
components.

00:01:33.630 --> 00:01:36.390
So the first one that we're going to create is a

00:01:37.064 --> 00:01:37.074
cancel

00:01:37.484 --> 00:01:38.724
subscription dialog,

00:01:38.724 --> 00:01:40.884
which basically is going to be a pop up if a user

00:01:40.884 --> 00:01:41.564
has a subscription.

00:01:41.564 --> 00:01:41.764
Well,

00:01:41.764 --> 00:01:42.324
they'll be more.

00:01:42.324 --> 00:01:44.444
Well they'll be able to actually cancel.

00:01:44.604 --> 00:01:46.924
So I'm just going to drop that code in really

00:01:46.924 --> 00:01:47.125
quick.

00:01:47.680 --> 00:01:50.600
So I'm just going to drop in the JS or the TSX for

00:01:50.600 --> 00:01:52.480
that and we're going to go over it in just a

00:01:52.480 --> 00:01:52.676
minute.

00:01:52.703 --> 00:01:54.703
The next file that we're going to create is called

00:01:54.703 --> 00:01:56.463
Subscription Status sidebar,

00:01:57.191 --> 00:01:57.911
tsx

00:01:59.111 --> 00:02:01.340
and this is going to be a little component that

00:02:01.340 --> 00:02:03.941
sits right here that kind of shows the user their

00:02:03.941 --> 00:02:04.381
subscription.

00:02:04.381 --> 00:02:05.141
If they don't have one,

00:02:05.141 --> 00:02:07.221
it will kind of prompt them to be able to upgrade.

00:02:07.221 --> 00:02:08.621
So we'll put in that code into here

00:02:08.864 --> 00:02:11.188
and then the last one is going to be the actual

00:02:11.188 --> 00:02:12.908
like upgrade page and,

00:02:12.979 --> 00:02:15.139
and these components are honestly a little bit

00:02:15.139 --> 00:02:15.899
dirty in my opinion.

00:02:15.899 --> 00:02:17.779
I would probably break this stuff up a little bit

00:02:17.779 --> 00:02:18.099
more.

00:02:18.359 --> 00:02:19.639
it's kind of a big file,

00:02:19.639 --> 00:02:20.039
but

00:02:20.439 --> 00:02:20.879
you know,

00:02:20.879 --> 00:02:22.439
like that's kind of beyond the point of this

00:02:22.439 --> 00:02:22.759
course.

00:02:23.799 --> 00:02:25.959
We just kind of want to like make sure all of this

00:02:25.959 --> 00:02:28.359
is working and get really familiar with the APIs

00:02:28.359 --> 00:02:29.799
and then you could come in,

00:02:30.039 --> 00:02:31.399
make this a little bit more modular.

00:02:31.399 --> 00:02:32.319
But to be totally frank,

00:02:32.319 --> 00:02:33.224
it's not that bad.

00:02:33.224 --> 00:02:35.086
And the last file that we're going to create is

00:02:35.086 --> 00:02:37.286
going to be index ts

00:02:40.096 --> 00:02:42.536
and that's just going to take the upgrade page and

00:02:42.536 --> 00:02:43.776
it's going to export it.

00:02:43.776 --> 00:02:44.176
Now,

00:02:44.466 --> 00:02:47.076
we can head over to the new page that was created,

00:02:47.076 --> 00:02:47.676
upgrade

00:02:48.236 --> 00:02:51.036
and delete this section and we're just going to

00:02:51.196 --> 00:02:52.876
import our upgrade page

00:02:54.578 --> 00:02:56.281
and then when this loads.

00:02:56.599 --> 00:02:59.959
So now you can see that we have these plans here.

00:03:00.199 --> 00:03:02.679
Now I know we just kind of copied and pasted stuff

00:03:02.679 --> 00:03:02.879
in.

00:03:02.879 --> 00:03:05.199
So like let's actually go through the API and

00:03:05.199 --> 00:03:06.119
what's happening here.

00:03:06.119 --> 00:03:06.308
So

00:03:06.312 --> 00:03:08.072
I'm going to go ahead and open a

00:03:08.392 --> 00:03:09.291
network tab

00:03:09.291 --> 00:03:11.612
and then let's start with our upgrade page.

00:03:11.692 --> 00:03:14.852
So what you're going to notice is we have these

00:03:14.852 --> 00:03:15.212
products

00:03:15.852 --> 00:03:17.772
and these products have these names

00:03:18.142 --> 00:03:20.702
and these names correspond to the names that we

00:03:20.702 --> 00:03:21.662
have in our

00:03:21.982 --> 00:03:24.262
backend application that we've configured into

00:03:24.262 --> 00:03:24.548
here.

00:03:25.532 --> 00:03:27.172
and then we've just kind of like added some

00:03:27.172 --> 00:03:29.492
additional features and like we have like pricing

00:03:29.492 --> 00:03:31.572
and whatnot and this is just hard coded in and

00:03:31.572 --> 00:03:33.612
then we have some markup down below

00:03:34.012 --> 00:03:36.052
where we just iterate through those plans and then

00:03:36.052 --> 00:03:38.012
we render these cards and that's what we're seeing

00:03:38.012 --> 00:03:38.253
here.

00:03:38.643 --> 00:03:40.923
now these prices are hard coded in the code base.

00:03:40.923 --> 00:03:42.443
If you were going to roll out your own SaaS

00:03:42.443 --> 00:03:42.643
product,

00:03:42.643 --> 00:03:43.643
you probably wouldn't do that.

00:03:43.643 --> 00:03:45.643
You'd probably have like a table and you'd have an

00:03:45.643 --> 00:03:46.643
API that

00:03:47.053 --> 00:03:47.253
provide,

00:03:47.323 --> 00:03:48.123
provides this,

00:03:48.203 --> 00:03:50.203
this configuration dynamically for you.

00:03:50.273 --> 00:03:52.103
but for this we just are going to hard code it

00:03:52.103 --> 00:03:53.423
because there's really no need to like

00:03:53.743 --> 00:03:56.023
go through so many extra steps when we really just

00:03:56.023 --> 00:03:57.663
want to understand the better Auth API.

00:03:57.663 --> 00:03:58.063
So

00:03:58.563 --> 00:04:00.803
from here what you're going to see is

00:04:01.122 --> 00:04:03.762
we are importing this Auth client

00:04:04.082 --> 00:04:06.562
and we have the plugin for the stripe client.

00:04:06.642 --> 00:04:07.042
So

00:04:08.372 --> 00:04:09.332
inside of this

00:04:09.732 --> 00:04:10.692
we have these git

00:04:11.102 --> 00:04:12.662
basically these buttons like Get Something,

00:04:12.662 --> 00:04:13.622
Get Get Basic,

00:04:13.622 --> 00:04:14.062
Get Pro,

00:04:14.062 --> 00:04:14.942
Get Enterprise.

00:04:15.964 --> 00:04:18.560
So you can see that we have right here Get Plan

00:04:18.640 --> 00:04:19.040
name

00:04:19.600 --> 00:04:20.000
and

00:04:20.728 --> 00:04:23.608
that is basically implementing this button and on

00:04:23.608 --> 00:04:25.368
click we're passing in the plan

00:04:26.088 --> 00:04:27.928
which is just kind of like the price,

00:04:28.328 --> 00:04:29.768
description features and whatnot.

00:04:29.768 --> 00:04:30.088
Right.

00:04:30.088 --> 00:04:31.608
And we are.

00:04:31.872 --> 00:04:34.352
And the handle upgrade is going to trigger

00:04:34.622 --> 00:04:37.552
this method which is taking our auth client and

00:04:37.552 --> 00:04:39.512
it's going to subscription and then it's calling

00:04:39.512 --> 00:04:40.072
upgrade.

00:04:40.072 --> 00:04:41.552
So if we don't have a subscription,

00:04:41.552 --> 00:04:44.552
this upgrade is going to essentially like

00:04:44.872 --> 00:04:47.492
redirect the user to a checkout page.

00:04:48.412 --> 00:04:50.092
and I'll show you kind of what that means,

00:04:50.252 --> 00:04:51.452
what that looks like in just a second.

00:04:51.452 --> 00:04:53.452
But you do provide a few additional things.

00:04:53.562 --> 00:04:56.032
we are getting this active subscription,

00:04:56.082 --> 00:04:56.942
subscription id.

00:04:57.432 --> 00:04:59.742
this is going to be undefined if the user doesn't

00:04:59.742 --> 00:05:01.202
have a subscription subscription and then we pass

00:05:01.202 --> 00:05:02.522
in some of these like

00:05:02.582 --> 00:05:05.762
redirect like on cancel on success on return.

00:05:05.762 --> 00:05:07.562
If you have different pages you want them to go to

00:05:07.562 --> 00:05:08.842
for these different types of events,

00:05:08.842 --> 00:05:09.122
we,

00:05:09.122 --> 00:05:10.002
you can go ahead and

00:05:10.352 --> 00:05:11.152
update that.

00:05:11.152 --> 00:05:13.072
But essentially we're just going to be redirecting

00:05:13.072 --> 00:05:14.352
them to upgrade page.

00:05:14.352 --> 00:05:15.472
So this page for now,

00:05:16.442 --> 00:05:19.722
now when this component loads for the very first

00:05:19.722 --> 00:05:19.990
time,

00:05:19.990 --> 00:05:23.001
essentially what we do is we call this load

00:05:23.001 --> 00:05:24.121
subscription method.

00:05:24.731 --> 00:05:24.971
And

00:05:25.291 --> 00:05:27.331
what that is going to do is that's going to go to

00:05:27.331 --> 00:05:29.971
our auth client subscription and then list and

00:05:29.971 --> 00:05:32.771
that's going to basically say show me the list of

00:05:32.771 --> 00:05:35.451
active subscriptions for this given user.

00:05:35.851 --> 00:05:37.851
And from there we just set that data

00:05:37.981 --> 00:05:40.351
into the set subscription state and that is going

00:05:40.351 --> 00:05:43.051
to be essentially what is our active subscription.

00:05:43.115 --> 00:05:45.715
So let's go ahead and look at some of the logic

00:05:45.715 --> 00:05:46.005
here.

00:05:46.025 --> 00:05:49.785
I'm actually going to log out console log

00:05:50.845 --> 00:05:53.325
data so you can see what the response looks like.

00:05:53.645 --> 00:05:56.325
But when this page loads for the first time you

00:05:56.325 --> 00:05:57.085
should see

00:05:57.468 --> 00:06:00.218
it does actually look like we have a little error

00:06:00.218 --> 00:06:00.378
here.

00:06:00.378 --> 00:06:02.458
So we're getting 500 requests when

00:06:02.858 --> 00:06:05.178
essentially we're trying to list out these

00:06:05.178 --> 00:06:05.818
subscriptions.

00:06:06.058 --> 00:06:09.258
And if you look at our logs the issue is kind of

00:06:09.258 --> 00:06:09.978
an oversight.

00:06:10.008 --> 00:06:12.518
from the last section essentially it's saying I

00:06:12.518 --> 00:06:14.718
can't find drizzle saying I can't find the

00:06:15.178 --> 00:06:16.138
subscriptions table.

00:06:16.138 --> 00:06:19.018
And the reason for that is because inside of our

00:06:19.018 --> 00:06:19.978
data ops,

00:06:20.638 --> 00:06:21.748
auth ts

00:06:22.308 --> 00:06:25.028
we're going to want to make sure we pass in the

00:06:25.028 --> 00:06:27.348
subscriptions table so we can basically say

00:06:27.908 --> 00:06:28.788
subscription.

00:06:29.160 --> 00:06:30.360
Make sure it's imported.

00:06:31.320 --> 00:06:32.520
Build it one more time.

00:06:33.020 --> 00:06:33.980
After we build

00:06:34.300 --> 00:06:36.700
essentially when we rerun this I suspect that

00:06:36.700 --> 00:06:37.940
we're not going to see that error.

00:06:37.940 --> 00:06:38.171
So

00:06:38.171 --> 00:06:38.391
alright.

00:06:38.391 --> 00:06:41.311
So you can see that this list API call is working.

00:06:41.391 --> 00:06:43.151
I'm not sure what this is right here.

00:06:43.251 --> 00:06:45.971
this is just some Google Image which is getting

00:06:45.971 --> 00:06:46.611
rate limited.

00:06:46.611 --> 00:06:47.371
Don't worry about that.

00:06:47.641 --> 00:06:49.921
we can look at our console and we don't have any

00:06:49.921 --> 00:06:50.281
data,

00:06:51.000 --> 00:06:52.921
so we don't have any subscriptions that are being

00:06:52.921 --> 00:06:56.001
called when the AUTH client is basically checking

00:06:56.001 --> 00:06:58.001
to see which subscriptions are available for the

00:06:58.001 --> 00:06:58.256
user.

00:06:58.386 --> 00:07:00.746
So now what we can do is we can actually go

00:07:00.746 --> 00:07:02.146
through this process of

00:07:02.386 --> 00:07:04.306
purchasing like products for,

00:07:04.386 --> 00:07:05.506
because this is test data,

00:07:05.506 --> 00:07:07.826
we can like see how this is going to work.

00:07:07.906 --> 00:07:09.146
But before we do that,

00:07:09.146 --> 00:07:10.706
if you take a look at the better,

00:07:10.866 --> 00:07:11.266
better,

00:07:11.596 --> 00:07:12.636
Auth docs,

00:07:13.242 --> 00:07:16.282
they have this command which is basically coming

00:07:16.282 --> 00:07:17.722
from the Stripe cli.

00:07:18.492 --> 00:07:21.772
essentially what it does is Stripe has the ability

00:07:21.772 --> 00:07:24.012
to give you web hooks whenever an event happens.

00:07:24.012 --> 00:07:25.932
So whenever a user buys something or cancels or

00:07:26.381 --> 00:07:27.421
wants a refund or whatever,

00:07:27.581 --> 00:07:28.701
a refund is issued,

00:07:28.701 --> 00:07:30.741
Stripe will send that data to a service that you

00:07:30.741 --> 00:07:31.341
configure.

00:07:31.581 --> 00:07:31.981
Now,

00:07:32.222 --> 00:07:33.901
essentially you have to like deploy a service,

00:07:33.981 --> 00:07:36.181
have an available URL in order to capture that and

00:07:36.181 --> 00:07:37.181
it makes testing very,

00:07:37.181 --> 00:07:37.461
very,

00:07:37.461 --> 00:07:38.301
very tedious.

00:07:38.461 --> 00:07:40.301
So they also have this

00:07:40.442 --> 00:07:42.161
the Stripe CLI which basically

00:07:42.641 --> 00:07:44.161
forwards requests,

00:07:44.501 --> 00:07:46.301
listens for requests and it forwards it to

00:07:46.701 --> 00:07:49.501
a specific like local host that you define here.

00:07:49.581 --> 00:07:51.421
So you can go ahead and copy this,

00:07:52.082 --> 00:07:55.362
come to a new terminal or just kind of like open a

00:07:55.362 --> 00:07:56.242
second terminal here.

00:07:56.302 --> 00:07:57.462
if you don't know how to do that,

00:07:57.462 --> 00:07:58.902
I'll just show you really quick.

00:07:59.362 --> 00:07:59.962
if you're using

00:08:00.602 --> 00:08:01.122
cursor,

00:08:01.122 --> 00:08:02.682
you can just hit this button right there.

00:08:03.282 --> 00:08:04.478
you can run Stripe listen

00:08:04.478 --> 00:08:06.897
and you're going to notice that this gives you a,

00:08:07.697 --> 00:08:07.817
A

00:08:07.877 --> 00:08:09.317
web hook signing secret.

00:08:09.637 --> 00:08:13.237
So we are going to go to our EMV file

00:08:13.557 --> 00:08:14.997
and then I'm going to say

00:08:15.317 --> 00:08:17.057
Stripe webhook key

00:08:22.772 --> 00:08:23.412
and then

00:08:24.632 --> 00:08:27.432
I'll kill the app and then pnpm run cf

00:08:27.752 --> 00:08:28.552
type gen

00:08:28.690 --> 00:08:29.969
and then start up the app again.

00:08:30.689 --> 00:08:32.489
Now in our Hono app,

00:08:32.489 --> 00:08:33.969
so in our app ts

00:08:34.369 --> 00:08:37.329
essentially here we can say EMV Stripe

00:08:38.029 --> 00:08:38.829
webhook key.

00:08:39.629 --> 00:08:41.669
And this is actually going to send real webhook

00:08:41.669 --> 00:08:43.629
events and we're going to be able to process them

00:08:43.629 --> 00:08:44.989
inside of our

00:08:45.159 --> 00:08:45.769
application.

00:08:45.769 --> 00:08:47.769
Now what's really cool about this is better AUTH

00:08:47.929 --> 00:08:50.889
takes care of like taking this Stripe webhook key,

00:08:51.369 --> 00:08:54.089
ensuring that the data that is being received by

00:08:54.089 --> 00:08:55.609
the web hook is indeed from Stripe.

00:08:55.609 --> 00:08:57.289
So it kind of like verifies that request,

00:08:57.639 --> 00:08:59.609
it gets the data and then it kind of like handles

00:08:59.609 --> 00:09:01.729
that data so it can update things on our back end.

00:09:01.729 --> 00:09:05.009
So we currently have a subscription table

00:09:06.219 --> 00:09:07.619
and there's going to be no data in the

00:09:07.619 --> 00:09:08.539
subscription table.

00:09:09.466 --> 00:09:12.746
Now what we can do is we can head over to,

00:09:12.996 --> 00:09:15.272
can head over to this dashboard and we're going to

00:09:15.272 --> 00:09:16.392
go through the process of,

00:09:17.272 --> 00:09:18.552
of actually like

00:09:18.952 --> 00:09:20.072
getting a subscription.

00:09:20.072 --> 00:09:20.832
But before we do that,

00:09:20.832 --> 00:09:22.072
I just want to make sure like,

00:09:22.072 --> 00:09:23.872
we have everything set up on the UI side.

00:09:23.872 --> 00:09:25.392
So there is one component,

00:09:25.392 --> 00:09:27.712
like I want a little card here that shows if the

00:09:27.712 --> 00:09:28.952
user subscribed or not.

00:09:30.222 --> 00:09:32.382
so if we head over to the

00:09:32.782 --> 00:09:33.262
Nav

00:09:34.142 --> 00:09:34.782
user,

00:09:35.022 --> 00:09:37.262
essentially it is under the common,

00:09:37.542 --> 00:09:39.822
it's under the common folder and it's basically

00:09:39.822 --> 00:09:40.382
this like,

00:09:40.382 --> 00:09:41.622
nav section right here.

00:09:42.022 --> 00:09:44.982
And we head over to the sidebar item,

00:09:45.382 --> 00:09:47.382
I think we can just paste it in right here.

00:09:49.050 --> 00:09:50.330
Stripe subscription bar.

00:09:52.396 --> 00:09:54.076
And we should see this pop up here.

00:09:54.076 --> 00:09:55.756
So if we were at this dashboard,

00:09:56.036 --> 00:09:58.076
we could just click this guy and come to this

00:09:58.076 --> 00:09:58.436
page.

00:09:58.436 --> 00:09:58.830
Now

00:09:58.883 --> 00:10:01.043
you can ignore these websocket failures for now

00:10:01.043 --> 00:10:03.363
just because we're developing locally and it's not

00:10:03.443 --> 00:10:05.523
currently configured to be able to reach out to

00:10:05.863 --> 00:10:06.263
Stage.

00:10:06.503 --> 00:10:06.903
But

00:10:07.543 --> 00:10:09.383
let's head over to our network tab

00:10:09.703 --> 00:10:12.143
and then let's see what happens when we go through

00:10:12.143 --> 00:10:13.023
the process of

00:10:13.023 --> 00:10:14.303
getting a subscription.

00:10:14.303 --> 00:10:15.438
So if we say get basic,

00:10:15.978 --> 00:10:17.378
you're going to notice this comes over to the

00:10:17.378 --> 00:10:18.338
Stripe payment page.

00:10:18.338 --> 00:10:19.378
Now there's a lot of ways to do it.

00:10:19.378 --> 00:10:21.378
This is definitely the easiest and most common way

00:10:21.378 --> 00:10:22.738
I'm seeing people like take payments.

00:10:22.738 --> 00:10:24.658
You can embed this in your website,

00:10:24.658 --> 00:10:26.898
but you could also just kind of like link out to

00:10:26.898 --> 00:10:27.298
Stripe.

00:10:27.298 --> 00:10:30.538
Now this page is entirely configurable inside the

00:10:30.538 --> 00:10:31.498
Stripe dashboard.

00:10:31.498 --> 00:10:32.938
Just you can kind of note that,

00:10:33.228 --> 00:10:34.448
and if you're going to,

00:10:34.848 --> 00:10:37.488
if you're going to like do a test card payment,

00:10:37.808 --> 00:10:39.668
you can use the stripes,

00:10:40.658 --> 00:10:41.978
Stripe's fake card,

00:10:41.978 --> 00:10:44.258
which is 424-242-4242.

00:10:44.681 --> 00:10:48.481
And then you can put in a date in the future and a

00:10:48.481 --> 00:10:49.721
random cvc.

00:10:50.271 --> 00:10:51.781
you can fill out whatever name you want and

00:10:51.781 --> 00:10:52.301
whatnot.

00:10:52.461 --> 00:10:54.181
And then what you're going to notice is we're

00:10:54.181 --> 00:10:55.087
going to go subscribe.

00:10:55.589 --> 00:10:58.989
That should redirect us back to our app Forward

00:10:58.989 --> 00:10:59.749
slash upgrade.

00:10:59.749 --> 00:11:01.109
So back to this payment page

00:11:01.599 --> 00:11:03.519
and you're going to notice we now have this

00:11:03.719 --> 00:11:05.529
we now have this Basic,

00:11:05.529 --> 00:11:07.529
essentially we have this basic that is

00:11:08.089 --> 00:11:09.609
highlighted as the current plan.

00:11:09.929 --> 00:11:12.769
And on this side over here we have Basic selected

00:11:12.769 --> 00:11:13.857
as our subscription.

00:11:14.440 --> 00:11:17.600
And if you look at the console you should see that

00:11:17.600 --> 00:11:18.120
we also

00:11:18.440 --> 00:11:20.040
were console logging out these.

00:11:20.120 --> 00:11:22.480
So it's going to show us the actual plan that we

00:11:22.480 --> 00:11:24.440
have subscribed to and some

00:11:24.950 --> 00:11:27.310
information like the price ID and the subscription

00:11:27.310 --> 00:11:28.990
ID and whatnot and the customer id.

00:11:28.990 --> 00:11:30.704
So it's passing that back to the UI.

00:11:30.704 --> 00:11:32.253
Now it's really nice about Stripe and the way

00:11:32.253 --> 00:11:35.093
better has this configured is you can essentially

00:11:35.093 --> 00:11:38.573
say okay if I am on this current plan and I want

00:11:38.573 --> 00:11:41.053
to upgrade to the Most popular plan,

00:11:41.053 --> 00:11:42.293
$25 a month,

00:11:42.533 --> 00:11:44.213
you can walk through this logic as.

00:11:44.545 --> 00:11:46.945
And what you're probably going to notice is you

00:11:46.945 --> 00:11:50.225
get this little pop up error and if we come into

00:11:50.225 --> 00:11:53.345
the request you'll be able to see more about why

00:11:53.345 --> 00:11:54.385
we're getting this error.

00:11:54.385 --> 00:11:54.785
So

00:11:54.995 --> 00:11:55.955
inside of upgrade

00:11:55.955 --> 00:11:57.853
if you come to the response you're going to,

00:11:57.853 --> 00:11:59.653
you're going to notice it says no configuration

00:11:59.653 --> 00:12:02.413
provided and the test default mode configuration

00:12:02.413 --> 00:12:03.293
has not been created.

00:12:03.533 --> 00:12:04.333
Please provide

00:12:05.223 --> 00:12:07.583
or create your default customer blah blah blah.

00:12:07.583 --> 00:12:08.503
And then it basically says

00:12:09.313 --> 00:12:11.673
you can do this in the dash link in the Stripe

00:12:11.673 --> 00:12:12.273
dashboard

00:12:13.053 --> 00:12:14.253
billing portal.

00:12:14.253 --> 00:12:17.093
So all this is going to want us to do is literally

00:12:17.093 --> 00:12:17.453
just

00:12:18.485 --> 00:12:20.125
basically inside of the customer portal.

00:12:20.125 --> 00:12:21.685
It's just going to want us to,

00:12:21.824 --> 00:12:23.758
it should just want us to actually just save these

00:12:23.758 --> 00:12:24.638
changes here.

00:12:24.878 --> 00:12:26.318
Now we can come back over.

00:12:26.798 --> 00:12:28.238
I suspect this should work.

00:12:28.238 --> 00:12:29.598
After saving those changes

00:12:29.826 --> 00:12:32.706
looks like your subscriptions cannot be updated

00:12:32.706 --> 00:12:35.186
because the subscription feature in the portal is,

00:12:35.186 --> 00:12:36.296
is disable.

00:12:36.846 --> 00:12:37.086
So

00:12:37.326 --> 00:12:39.326
we could come into here and it looks like there's

00:12:39.326 --> 00:12:41.246
going to be a section under subscriptions.

00:12:41.566 --> 00:12:43.326
Essentially what you're going to do is you're

00:12:43.326 --> 00:12:45.966
going to enable the user to be able to switch

00:12:45.966 --> 00:12:46.573
plans.

00:12:46.573 --> 00:12:47.630
go ahead and hit save

00:12:47.699 --> 00:12:48.099
and

00:12:48.392 --> 00:12:50.682
you have to select which products these apply to.

00:12:50.682 --> 00:12:52.762
So we're just going to select all three of these

00:12:52.762 --> 00:12:53.082
products

00:12:54.029 --> 00:12:54.616
save changes

00:12:54.616 --> 00:12:57.087
and now we can go ahead and hit this and it should

00:12:57.087 --> 00:13:00.047
redirect us to a change subscription page.

00:13:00.047 --> 00:13:01.897
So basically here it's going to show the

00:13:02.157 --> 00:13:03.597
subscription that we're going to.

00:13:03.757 --> 00:13:06.197
And if you were to actually fill out a description

00:13:06.197 --> 00:13:06.717
for this product,

00:13:06.717 --> 00:13:08.397
there would be more information that shows here.

00:13:08.397 --> 00:13:10.837
But basically it's going to prorate this for us.

00:13:10.837 --> 00:13:12.157
So we've already paid $9,

00:13:12.557 --> 00:13:13.677
so it's going to prorate.

00:13:13.677 --> 00:13:14.797
Amount due today is 16.

00:13:15.357 --> 00:13:17.026
We're going to go ahead and confirm that.

00:13:17.487 --> 00:13:19.567
And then this should redirect us again back to

00:13:19.567 --> 00:13:19.887
the,

00:13:20.527 --> 00:13:21.327
this page.

00:13:21.647 --> 00:13:23.527
And what you're going to notice is we should be

00:13:23.527 --> 00:13:25.087
also receiving these web hooks,

00:13:25.668 --> 00:13:26.439
throughout this process.

00:13:26.599 --> 00:13:26.893
So

00:13:27.063 --> 00:13:29.177
now what I'm actually noticing is,

00:13:30.087 --> 00:13:32.567
it didn't switch payments for me or didn't switch

00:13:32.567 --> 00:13:33.327
the plans for me.

00:13:33.327 --> 00:13:34.327
And the reason why

00:13:34.647 --> 00:13:35.447
is currently

00:13:36.337 --> 00:13:38.737
the stripe webhooks are not sending to this or

00:13:38.737 --> 00:13:40.337
they're not currently sending to

00:13:40.487 --> 00:13:41.617
this application because

00:13:42.097 --> 00:13:43.457
I was using a different

00:13:43.777 --> 00:13:45.697
stripe Dashboard or a different,

00:13:45.777 --> 00:13:46.377
stripe account.

00:13:46.857 --> 00:13:48.777
So if you have multiple stripe accounts,

00:13:48.777 --> 00:13:49.657
you can just run

00:13:49.977 --> 00:13:50.617
stripe

00:13:51.097 --> 00:13:51.817
logout

00:13:52.445 --> 00:13:53.085
and then,

00:13:53.365 --> 00:13:54.785
when you run the CLI again.

00:13:54.785 --> 00:13:56.425
So if you're running it for the first time as

00:13:56.425 --> 00:13:56.665
well,

00:13:56.665 --> 00:13:58.305
what you're probably going to notice is

00:13:58.625 --> 00:14:00.385
it's going to want you to open this,

00:14:01.045 --> 00:14:02.005
this web page

00:14:02.325 --> 00:14:04.085
and this is just going to authenticate,

00:14:04.185 --> 00:14:06.105
your stripe account as well and store the

00:14:06.105 --> 00:14:07.145
necessary tokens.

00:14:07.145 --> 00:14:09.785
And it's probably going to also like send you an

00:14:09.785 --> 00:14:10.343
sms.

00:14:11.264 --> 00:14:11.784
All right,

00:14:11.784 --> 00:14:13.104
so once that is done,

00:14:14.044 --> 00:14:15.164
it should generate.

00:14:15.564 --> 00:14:16.084
It'll.

00:14:16.084 --> 00:14:17.804
I'm going to go ahead and run this again.

00:14:18.016 --> 00:14:20.176
So it's actually going to give me a different key.

00:14:20.656 --> 00:14:21.936
So if I head over to

00:14:22.336 --> 00:14:22.976
emv,

00:14:23.555 --> 00:14:25.395
it's going to give me.

00:14:25.715 --> 00:14:27.835
I'm going to replace my key because this is

00:14:27.835 --> 00:14:28.435
actually the

00:14:28.755 --> 00:14:29.555
incorrect key.

00:14:30.355 --> 00:14:30.875
All right,

00:14:30.875 --> 00:14:32.355
so now we should be cooking.

00:14:32.835 --> 00:14:32.905
We

00:14:32.975 --> 00:14:35.535
can come into here and we are going to go through

00:14:35.535 --> 00:14:37.575
the process of trying to upgrade our

00:14:37.895 --> 00:14:38.295
plan

00:14:39.095 --> 00:14:40.535
and we should see web,

00:14:40.685 --> 00:14:42.745
we should see webhook events flow through into

00:14:42.745 --> 00:14:42.960
here.

00:14:43.263 --> 00:14:44.463
So let's go ahead and

00:14:44.783 --> 00:14:46.833
go through that upgrade process one more time.

00:14:47.343 --> 00:14:47.663
Oh,

00:14:48.143 --> 00:14:48.623
all right.

00:14:48.623 --> 00:14:51.143
So now the issue is because I didn't have webhook

00:14:51.143 --> 00:14:52.383
set up properly,

00:14:52.543 --> 00:14:54.303
my data is now out of sync.

00:14:54.303 --> 00:14:56.063
So what I'm gonna end up doing,

00:14:56.303 --> 00:14:58.503
and this is just a good thing to kind of flesh out

00:14:58.503 --> 00:14:59.943
while you're testing because doing this in

00:14:59.943 --> 00:15:01.983
production would be pretty tedious.

00:15:02.143 --> 00:15:02.943
This is also why

00:15:03.263 --> 00:15:04.783
payments can be kind of difficult.

00:15:05.423 --> 00:15:05.433
I'm

00:15:05.603 --> 00:15:08.283
just gonna go ahead and delete from subscriptions,

00:15:08.283 --> 00:15:09.763
so I'm gonna clear out this data.

00:15:12.122 --> 00:15:13.962
So we shouldn't have any subscriptions in here.

00:15:14.442 --> 00:15:15.962
Head back over to this page.

00:15:17.312 --> 00:15:19.672
and we should notice that this is also going to

00:15:19.672 --> 00:15:20.432
show up as

00:15:21.172 --> 00:15:21.772
basic.

00:15:21.772 --> 00:15:22.932
So I'm going to go through this process,

00:15:22.932 --> 00:15:24.132
I'm going to buy basic,

00:15:25.065 --> 00:15:26.264
go through the upgrade process.

00:15:26.962 --> 00:15:28.783
And what you're going to notice here is we're

00:15:28.783 --> 00:15:30.395
getting all these webhook events.

00:15:30.974 --> 00:15:33.294
I do notice that we have an error in our

00:15:33.294 --> 00:15:35.734
application thrown by better auth that it can't

00:15:35.734 --> 00:15:37.534
read the property of id.

00:15:38.014 --> 00:15:39.804
So we'll keep on lookout for that.

00:15:39.804 --> 00:15:41.354
this is actually a bit curious to me.

00:15:41.694 --> 00:15:44.094
but let's go ahead and finish this process.

00:15:44.254 --> 00:15:46.014
Try to upgrade this page

00:15:46.414 --> 00:15:46.934
or this,

00:15:46.934 --> 00:15:47.534
this product.

00:15:47.801 --> 00:15:48.061
right,

00:15:48.061 --> 00:15:50.561
so now you can see that this shows that we

00:15:50.945 --> 00:15:54.145
it actually shows that we don't have a

00:15:54.145 --> 00:15:55.425
subscription plan here.

00:15:55.425 --> 00:15:57.324
What I'm actually going to do here is I'm going to

00:15:57.324 --> 00:15:58.125
start clean,

00:15:58.125 --> 00:15:59.965
I'm going to sign out and I'm going to log in with

00:15:59.965 --> 00:16:00.645
a different email,

00:16:00.785 --> 00:16:02.525
just because I think I might have messed up the

00:16:03.135 --> 00:16:05.095
users table and that mapping.

00:16:05.095 --> 00:16:06.815
So I'm going to log in with this email.

00:16:07.409 --> 00:16:09.009
Let's go ahead and upgrade to Pro.

00:16:09.261 --> 00:16:10.102
Let's get basic.

00:16:10.317 --> 00:16:11.837
I'm going to go ahead and do

00:16:12.557 --> 00:16:13.357
Cash app

00:16:14.157 --> 00:16:16.197
because you can kind of test all these different

00:16:16.197 --> 00:16:16.797
kinds.

00:16:16.797 --> 00:16:17.013
So

00:16:17.013 --> 00:16:19.350
think it's going to want me to simulate a scan

00:16:19.509 --> 00:16:20.429
authorized test payment.

00:16:21.283 --> 00:16:21.803
Alright,

00:16:21.803 --> 00:16:23.763
so now we're on the current plan.

00:16:24.022 --> 00:16:26.359
We got this web hook and we successfully processed

00:16:26.359 --> 00:16:26.519
it.

00:16:26.519 --> 00:16:27.959
Let's go ahead and change to Pro

00:16:28.689 --> 00:16:29.329
Upgrade.

00:16:29.329 --> 00:16:30.889
We're going to pay $16.

00:16:30.889 --> 00:16:32.849
So it's going to prorate this for us

00:16:33.461 --> 00:16:33.701
now.

00:16:33.781 --> 00:16:34.341
Look at that.

00:16:34.341 --> 00:16:34.661
Boom.

00:16:34.661 --> 00:16:35.021
Okay,

00:16:35.021 --> 00:16:36.021
so that worked as expected.

00:16:36.101 --> 00:16:36.981
So we got the

00:16:37.361 --> 00:16:39.921
hook for that as well to basically say that it was

00:16:39.921 --> 00:16:40.961
upgrade updated

00:16:41.281 --> 00:16:43.681
and then it was able to reflect the current plan.

00:16:43.841 --> 00:16:46.361
So if we come over to subscriptions you're going

00:16:46.361 --> 00:16:48.401
to notice we're going to have this user

00:16:48.841 --> 00:16:49.921
now part of the Pro plan.

00:16:49.921 --> 00:16:52.961
Let's upgrade one more time and go to Enterprise.

00:16:54.014 --> 00:16:55.774
It's also prorating it again.

00:16:57.175 --> 00:16:57.462
cool.

00:16:57.462 --> 00:16:59.022
I'm just gonna head back here.

00:16:59.182 --> 00:16:59.542
All right,

00:16:59.542 --> 00:16:59.862
there we go.

00:16:59.862 --> 00:17:01.062
So now this is our current plan.

00:17:01.062 --> 00:17:02.262
Those webhooks were processed.

00:17:02.262 --> 00:17:03.851
So it looks like I actually screwed up the

00:17:03.851 --> 00:17:06.342
mapping because I did some configurations wrong,

00:17:06.342 --> 00:17:08.862
which is really why you want to flush out payments

00:17:09.022 --> 00:17:11.102
well before you release this to users because

00:17:11.422 --> 00:17:12.622
there's so much to it.

00:17:12.952 --> 00:17:13.432
but yeah,

00:17:13.432 --> 00:17:15.152
if you're going to just have like a basic

00:17:15.152 --> 00:17:16.472
subscription tier kind of a thing,

00:17:16.472 --> 00:17:18.672
I think better off makes it easier than rolling it

00:17:18.672 --> 00:17:19.072
on your own.

00:17:19.072 --> 00:17:20.732
But there's still a lot of things to consider

00:17:20.732 --> 00:17:21.092
here.

00:17:21.332 --> 00:17:21.892
All right,

00:17:22.292 --> 00:17:24.732
so now what we're going to notice is inside of

00:17:24.732 --> 00:17:25.332
payments

00:17:25.435 --> 00:17:26.227
we have this

00:17:26.487 --> 00:17:28.927
cancel subscription dialog which basically is

00:17:28.927 --> 00:17:30.967
saying if the current plan is selected,

00:17:31.987 --> 00:17:33.666
you can click on current plan.

00:17:33.666 --> 00:17:36.947
You get this dialog which pops up this component

00:17:36.947 --> 00:17:38.267
for canceling the subscription.

00:17:38.267 --> 00:17:39.587
And essentially we have this

00:17:40.067 --> 00:17:41.987
handler that's going to be implemented when you

00:17:41.987 --> 00:17:42.707
click this button.

00:17:43.277 --> 00:17:43.517
And

00:17:44.047 --> 00:17:45.167
it's just calling

00:17:46.077 --> 00:17:47.877
auth client subscription cancel.

00:17:47.877 --> 00:17:48.159
And then

00:17:48.159 --> 00:17:49.553
better off is going to take care of actually

00:17:49.553 --> 00:17:51.553
canceling the subscription inside of

00:17:51.813 --> 00:17:53.743
Stripe and then also updating that in the

00:17:53.743 --> 00:17:54.223
database.

00:17:54.223 --> 00:17:54.583
So,

00:17:54.823 --> 00:17:57.723
take a look here we have cancel period ends,

00:17:57.723 --> 00:17:59.723
which is going to be zero for false.

00:18:00.273 --> 00:18:01.953
we're going to have our.

00:18:02.433 --> 00:18:03.953
Let's go to our customers,

00:18:04.029 --> 00:18:06.007
we'll go to this user and you're going to notice

00:18:06.007 --> 00:18:08.087
that we're currently on the enterprise product.

00:18:08.087 --> 00:18:09.887
That's our current subscription at the moment.

00:18:11.597 --> 00:18:12.868
now I'm going to go ahead and cancel it.

00:18:12.868 --> 00:18:14.828
It's going to take me to a Stripe page.

00:18:15.468 --> 00:18:15.868
And

00:18:16.278 --> 00:18:17.848
inside of the Stripe page you're going to go ahead

00:18:17.848 --> 00:18:19.568
and do that cancellation and whatnot.

00:18:19.808 --> 00:18:21.728
And it's probably going to ask you why.

00:18:21.808 --> 00:18:22.608
Too expensive.

00:18:22.911 --> 00:18:23.471
Okay,

00:18:23.471 --> 00:18:23.696
cool.

00:18:23.981 --> 00:18:24.381
So

00:18:24.781 --> 00:18:25.181
now

00:18:25.428 --> 00:18:26.588
we can reload this page.

00:18:27.348 --> 00:18:29.748
I think this goes to the actual Stripe account

00:18:29.748 --> 00:18:30.278
button.

00:18:30.694 --> 00:18:31.174
all right,

00:18:31.174 --> 00:18:33.494
so now you see that we have this canceling period

00:18:33.494 --> 00:18:33.894
at

00:18:34.304 --> 00:18:36.214
it shows that this is going to be canceled.

00:18:36.534 --> 00:18:37.174
And then

00:18:37.574 --> 00:18:38.374
additionally,

00:18:39.100 --> 00:18:41.390
in this database we can go ahead and look and

00:18:41.490 --> 00:18:43.970
better off said this subscription is going to

00:18:43.970 --> 00:18:44.330
cancel.

00:18:44.330 --> 00:18:46.650
Now we also have the ability to say we want to

00:18:46.650 --> 00:18:49.090
reinstate the subscription so we can go to manage

00:18:49.090 --> 00:18:49.610
subscription.

00:18:49.610 --> 00:18:50.930
And then you're going to see that we have this

00:18:50.930 --> 00:18:51.410
restore,

00:18:52.010 --> 00:18:52.826
subscription button.

00:18:53.665 --> 00:18:55.985
So essentially there's another helper function.

00:18:56.105 --> 00:18:57.805
if the state is canceled,

00:18:58.045 --> 00:19:00.405
where the user can restore by saying auth client

00:19:00.405 --> 00:19:01.485
subscription restore.

00:19:01.645 --> 00:19:03.565
And that's going to take you through a very.

00:19:03.565 --> 00:19:04.885
Essentially that's not going to take you through

00:19:04.885 --> 00:19:05.725
the process of

00:19:06.685 --> 00:19:08.285
going to an actual Stripe page.

00:19:08.365 --> 00:19:09.965
It should just ping the

00:19:10.225 --> 00:19:12.305
API and then programmatically they're just going

00:19:12.305 --> 00:19:13.105
to restore that.

00:19:13.345 --> 00:19:14.785
So now we're restored.

00:19:14.785 --> 00:19:16.665
And you should see that we're getting these web

00:19:16.665 --> 00:19:18.015
hosts hook events as well,

00:19:18.335 --> 00:19:19.565
pretty instantaneously.

00:19:19.575 --> 00:19:19.975
so yeah,

00:19:19.975 --> 00:19:21.095
so now that's the current plan.

00:19:21.095 --> 00:19:22.455
So in a nutshell,

00:19:22.455 --> 00:19:23.255
that is

00:19:24.465 --> 00:19:26.065
integrating Stripe with better auth.

00:19:26.065 --> 00:19:26.985
Now there's like,

00:19:26.985 --> 00:19:27.545
as you could tell,

00:19:27.545 --> 00:19:28.705
there's a lot to it and

00:19:29.105 --> 00:19:29.505
you know,

00:19:29.505 --> 00:19:31.224
there's a lot of different areas that you could,

00:19:31.224 --> 00:19:31.505
like,

00:19:31.505 --> 00:19:32.065
mess up on.

00:19:32.065 --> 00:19:32.585
So you have to,

00:19:32.585 --> 00:19:32.825
like,

00:19:32.825 --> 00:19:33.145
really,

00:19:33.145 --> 00:19:34.945
really test out your subscription,

00:19:35.015 --> 00:19:35.725
process and,

00:19:35.725 --> 00:19:36.085
like,

00:19:36.085 --> 00:19:38.565
system and then also really ensure that you know

00:19:38.565 --> 00:19:39.205
what's happening.

00:19:39.205 --> 00:19:39.565
Because,

00:19:39.885 --> 00:19:40.285
you know,

00:19:40.285 --> 00:19:41.565
if you get billing wrong,

00:19:41.565 --> 00:19:42.165
it could really,

00:19:42.165 --> 00:19:42.525
like,

00:19:42.785 --> 00:19:43.065
you know,

00:19:43.065 --> 00:19:44.905
it could really be not good for customers,

00:19:44.905 --> 00:19:46.305
especially if you're overcharging,

00:19:46.335 --> 00:19:48.335
or you have a user that has,

00:19:48.335 --> 00:19:48.495
like,

00:19:48.495 --> 00:19:49.857
more than one subscription and whatnot.

00:19:49.857 --> 00:19:50.472
Now there are,

00:19:50.472 --> 00:19:50.712
like,

00:19:50.712 --> 00:19:52.392
configurations in the Stripe dashboard that you

00:19:52.392 --> 00:19:52.792
can say like,

00:19:52.792 --> 00:19:52.992
oh,

00:19:52.992 --> 00:19:54.632
I only want one customer to ever have one

00:19:54.632 --> 00:19:56.192
subscription at a given point in time.

00:19:56.192 --> 00:19:56.472
So,

00:19:56.472 --> 00:19:56.632
like,

00:19:56.632 --> 00:19:57.792
there are some things you can do.

00:19:57.792 --> 00:19:59.192
But I would say just like,

00:19:59.192 --> 00:20:00.392
dive really deep into the docs.

00:20:00.392 --> 00:20:02.312
If you're going to roll out payments to users and

00:20:02.312 --> 00:20:03.152
you can use better auth,

00:20:03.152 --> 00:20:04.942
you can go ahead and do it this way.

00:20:04.942 --> 00:20:05.932
it should work just fine.

00:20:05.932 --> 00:20:07.612
But the second you go past,

00:20:07.612 --> 00:20:07.892
like,

00:20:07.892 --> 00:20:09.932
really basic subscription tiers is when you have

00:20:09.932 --> 00:20:10.372
to actually,

00:20:10.372 --> 00:20:10.652
like,

00:20:10.652 --> 00:20:10.972
start

00:20:11.282 --> 00:20:11.442
getting

00:20:11.752 --> 00:20:13.974
diving very deep into the Stripe API.

00:20:14.017 --> 00:20:14.417
Now,

00:20:14.417 --> 00:20:16.737
before we wrap up the,

00:20:17.207 --> 00:20:18.967
before we wrap up the

00:20:20.347 --> 00:20:20.867
section of this,

00:20:20.867 --> 00:20:22.907
we're gonna have one additional video where we're

00:20:22.907 --> 00:20:24.387
going to deploy this and just make sure

00:20:24.387 --> 00:20:25.307
everything's configured.

00:20:25.307 --> 00:20:25.627
Now,

00:20:25.627 --> 00:20:27.467
I'm not going to be deploying this to production

00:20:27.467 --> 00:20:29.627
because I don't want to actually go create a real

00:20:29.627 --> 00:20:31.067
stripe account for this fake product.

00:20:31.507 --> 00:20:33.187
we're just going to be doing this in stage,

00:20:33.187 --> 00:20:35.307
so we'll be able to see how to actually configure

00:20:35.307 --> 00:20:36.151
the web hooks.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.039 --> 00:00:00.359
All right,

00:00:00.359 --> 00:00:02.199
so the main caveat when deploying

00:00:02.349 --> 00:00:04.499
these changes with the payments is we need to make

00:00:04.499 --> 00:00:05.579
sure that all of our

00:00:06.159 --> 00:00:09.279
secrets and all of our variables like price IDs

00:00:09.279 --> 00:00:12.239
and whatnot also are uploaded to Cloudflare.

00:00:12.319 --> 00:00:15.079
So what we're also what I want to notice here is

00:00:15.079 --> 00:00:16.399
inside of dot EMV,

00:00:16.399 --> 00:00:18.719
we took these price IDs and we

00:00:18.869 --> 00:00:20.479
are basically just putting them here now.

00:00:20.479 --> 00:00:21.679
They actually technically,

00:00:21.679 --> 00:00:22.879
because these aren't secrets,

00:00:23.099 --> 00:00:25.179
they don't need to live in this EMV file.

00:00:25.179 --> 00:00:27.902
We could head over to our Wrangler JSON C

00:00:27.908 --> 00:00:29.908
and we could come over to,

00:00:30.498 --> 00:00:31.726
to the stage environment

00:00:32.046 --> 00:00:34.366
and then at the top level let's just go ahead and

00:00:34.366 --> 00:00:35.486
say vars.

00:00:35.566 --> 00:00:38.046
Now these vars are basically like

00:00:38.106 --> 00:00:40.506
server side environment variables that we can

00:00:40.506 --> 00:00:41.666
inject into our code.

00:00:41.666 --> 00:00:42.026
So

00:00:42.366 --> 00:00:44.566
just going to go ahead and paste these in and then

00:00:44.566 --> 00:00:47.782
just make sure they conform to our JSON schema

00:00:49.118 --> 00:00:51.278
now similarly to what's in environment.

00:00:51.598 --> 00:00:53.198
So basically like let's say

00:00:53.598 --> 00:00:53.998
we

00:00:54.398 --> 00:00:55.398
don't have these in here.

00:00:55.398 --> 00:00:56.958
So I'm just going to copy and delete these for a

00:00:56.958 --> 00:00:57.198
second.

00:00:57.358 --> 00:00:59.758
If we say pnpm run CF

00:01:00.158 --> 00:01:01.038
type gen,

00:01:02.318 --> 00:01:04.398
we're going to notice that these

00:01:04.788 --> 00:01:07.548
that these stripe product or price IDs are no

00:01:07.548 --> 00:01:08.228
longer in there.

00:01:08.308 --> 00:01:10.588
And if we head over to our Hono app we're now

00:01:10.588 --> 00:01:11.708
getting type errors here.

00:01:11.708 --> 00:01:13.748
But what we can do is we can go to,

00:01:14.198 --> 00:01:14.438
are

00:01:14.878 --> 00:01:17.178
under stage environment we can add these

00:01:17.318 --> 00:01:19.998
vars and then run CF type gen once more.

00:01:20.078 --> 00:01:22.638
And you're going to notice that you now have these

00:01:23.158 --> 00:01:26.438
stripe product IDs as actual like hard coded

00:01:26.438 --> 00:01:26.918
strings

00:01:27.158 --> 00:01:28.298
for these variables.

00:01:28.298 --> 00:01:28.578
So

00:01:29.148 --> 00:01:31.068
if we head back over to App ts

00:01:31.468 --> 00:01:33.028
we're no longer getting those type errors.

00:01:33.028 --> 00:01:34.988
So we can deploy this application

00:01:35.378 --> 00:01:36.018
and these,

00:01:36.578 --> 00:01:36.978
these

00:01:37.378 --> 00:01:39.458
runtime variables will basically be

00:01:40.138 --> 00:01:40.938
uploaded to

00:01:41.198 --> 00:01:43.338
they'll be uploaded to Cloudflare server,

00:01:43.338 --> 00:01:45.418
Cloudflare storage and then they'll be used during

00:01:45.418 --> 00:01:47.298
the runtime so you don't actually have to manually

00:01:47.298 --> 00:01:47.818
add them.

00:01:47.818 --> 00:01:48.138
Which,

00:01:48.138 --> 00:01:48.818
which is great.

00:01:49.388 --> 00:01:50.748
you only want to do this

00:01:51.068 --> 00:01:53.308
pattern of adding these variables in this

00:01:53.308 --> 00:01:55.308
configuration if they're not secrets and they're

00:01:55.308 --> 00:01:56.428
not like sensitive information.

00:01:56.668 --> 00:01:58.588
So if we say PNPM run

00:01:59.148 --> 00:02:00.668
stage deploy,

00:02:00.858 --> 00:02:01.098
this

00:02:01.318 --> 00:02:03.138
deployment should go through successfully and

00:02:03.138 --> 00:02:05.178
we'll just go ahead and open up our

00:02:05.258 --> 00:02:08.498
stage.smartlink.com or whatever URL you have for

00:02:08.498 --> 00:02:08.587
it.

00:02:08.587 --> 00:02:10.713
And before going through this login process,

00:02:10.793 --> 00:02:13.113
what I want to do is I actually just want to

00:02:13.213 --> 00:02:15.223
make sure we have Our webhooks set up properly

00:02:15.223 --> 00:02:16.663
inside of the Stripe dashboard.

00:02:16.663 --> 00:02:19.663
So in the Stripe dashboard you can head over to,

00:02:20.533 --> 00:02:22.373
you can head over to developers

00:02:23.013 --> 00:02:24.518
and you can go to webhooks

00:02:24.703 --> 00:02:26.914
and you can see that you currently have this Web

00:02:26.914 --> 00:02:28.194
Hook listening right now

00:02:28.514 --> 00:02:30.194
we'll just kind of copy that path,

00:02:30.644 --> 00:02:31.854
as like a local listener.

00:02:31.854 --> 00:02:34.494
But we're going to want to create an actual

00:02:34.494 --> 00:02:35.054
endpoint,

00:02:35.264 --> 00:02:37.584
for our application that is deployed.

00:02:37.584 --> 00:02:40.704
So we can go ahead and we can say HTTPs

00:02:42.224 --> 00:02:42.704
and then

00:02:43.024 --> 00:02:45.504
stage.smart

00:02:45.824 --> 00:02:46.304
link.

00:02:47.624 --> 00:02:49.144
I'm going to make sure I actually have the right

00:02:49.464 --> 00:02:51.544
URL here because I would not.

00:02:51.624 --> 00:02:52.184
Okay,

00:02:52.264 --> 00:02:52.490
so

00:02:52.490 --> 00:02:54.711
stage smart stage.smartlink.com

00:02:54.779 --> 00:02:58.099
and that's going to go to API Auth Stripe Web

00:02:58.099 --> 00:02:58.339
Hook.

00:02:58.339 --> 00:03:00.499
So this is going to be taken care of by the better

00:03:00.499 --> 00:03:01.819
auth handler for us.

00:03:02.459 --> 00:03:05.099
Now what we can do is it's going to say listen to

00:03:05.339 --> 00:03:06.379
events on your account,

00:03:06.779 --> 00:03:08.739
events on connected accounts.

00:03:08.739 --> 00:03:10.539
So you're going to want to listen to the events on

00:03:10.539 --> 00:03:10.939
your account

00:03:11.519 --> 00:03:13.079
and then you can select the events that you want

00:03:13.079 --> 00:03:13.559
to listen to.

00:03:13.559 --> 00:03:14.079
Now better,

00:03:14.319 --> 00:03:14.639
better.

00:03:14.639 --> 00:03:15.759
Auths docs

00:03:16.239 --> 00:03:18.959
should have the events that we care about.

00:03:19.032 --> 00:03:19.780
It is in this,

00:03:19.780 --> 00:03:21.460
setup Stripe webhook section.

00:03:21.700 --> 00:03:22.420
So they care.

00:03:22.420 --> 00:03:24.380
They say at a minimum we're going to want to

00:03:24.380 --> 00:03:24.980
listen to,

00:03:25.990 --> 00:03:27.190
session complete.

00:03:27.750 --> 00:03:28.470
So we can

00:03:28.790 --> 00:03:31.350
come over to here and we can basically say,

00:03:32.020 --> 00:03:34.340
session complete or checkout session complete.

00:03:35.290 --> 00:03:36.330
subscription updated

00:03:37.224 --> 00:03:37.864
and then

00:03:38.264 --> 00:03:39.455
subscription deleted.

00:03:40.268 --> 00:03:42.428
So at a minimum this is what we want to listen to.

00:03:42.508 --> 00:03:44.388
Now there's a lot of different events that you

00:03:44.388 --> 00:03:46.548
have access to and you can always update these

00:03:46.548 --> 00:03:47.228
later as well.

00:03:47.308 --> 00:03:49.228
So we'll go ahead and add endpoint.

00:03:49.278 --> 00:03:49.640
Cool.

00:03:49.640 --> 00:03:50.800
So this is now enabled,

00:03:51.400 --> 00:03:53.720
and then it's going to give us this webhook

00:03:54.000 --> 00:03:54.400
id.

00:03:54.640 --> 00:03:58.520
So from here we can go over to our cloudflare

00:03:58.520 --> 00:03:59.120
dashboard.

00:03:59.120 --> 00:04:00.630
I'm going to open this in a new tab

00:04:00.779 --> 00:04:02.819
and head over to the application that we just

00:04:02.819 --> 00:04:03.739
deployed in Workers.

00:04:04.059 --> 00:04:05.899
So our user application here,

00:04:06.319 --> 00:04:06.939
for Stage,

00:04:07.259 --> 00:04:09.299
I'm going to go to Settings and then we're going

00:04:09.299 --> 00:04:10.699
to be adding some

00:04:11.679 --> 00:04:14.559
additional secrets here so we can go add.

00:04:14.682 --> 00:04:16.462
And this is going to be a secret and

00:04:17.102 --> 00:04:18.622
we'll put in the value and

00:04:18.942 --> 00:04:20.902
make sure we have the right key for it.

00:04:20.902 --> 00:04:22.622
So in emv we have our

00:04:22.942 --> 00:04:24.622
stripe webhook key

00:04:25.872 --> 00:04:28.192
and then also I'm going to put in our

00:04:28.752 --> 00:04:31.512
stripe secret key at the same time so we can say

00:04:31.512 --> 00:04:32.432
that's also a secret.

00:04:32.912 --> 00:04:33.872
Paste in the key,

00:04:34.512 --> 00:04:35.392
grab the value

00:04:35.712 --> 00:04:36.112
here.

00:04:36.752 --> 00:04:37.232
Boom.

00:04:37.312 --> 00:04:37.952
Okay,

00:04:38.592 --> 00:04:39.952
then we should redeploy this

00:04:41.176 --> 00:04:41.816
all right,

00:04:41.976 --> 00:04:42.816
so from here,

00:04:42.816 --> 00:04:44.616
what I'm going to do is I'm going to say look at.

00:04:44.616 --> 00:04:45.656
Let's look at user.

00:04:45.996 --> 00:04:48.396
so we should have two users in this,

00:04:48.616 --> 00:04:48.936
table.

00:04:48.936 --> 00:04:49.536
Right now,

00:04:50.336 --> 00:04:53.416
what I want to do for testing purposes is I'm just

00:04:53.416 --> 00:04:55.616
going to go ahead and log in with another email.

00:04:55.654 --> 00:04:55.785
Oh,

00:04:55.785 --> 00:04:57.305
it looks like we're getting a failure.

00:04:57.385 --> 00:04:58.105
What's that?

00:04:58.760 --> 00:05:00.640
So I actually think what's happening here is,

00:05:00.640 --> 00:05:03.640
I just kind of noticed it before is in these

00:05:03.960 --> 00:05:03.980
variables,

00:05:04.420 --> 00:05:05.220
and secrets,

00:05:05.220 --> 00:05:07.420
our Google information is not in there.

00:05:07.420 --> 00:05:07.620
So,

00:05:07.620 --> 00:05:07.900
like,

00:05:08.620 --> 00:05:11.420
I'm going to go ahead and add our Google secret

00:05:12.140 --> 00:05:13.340
as a secret here

00:05:13.698 --> 00:05:15.099
and copy this guy.

00:05:15.688 --> 00:05:17.098
And while that's going,

00:05:17.178 --> 00:05:19.178
I'm going to grab our client ID

00:05:19.191 --> 00:05:21.748
and I'm going to actually save this inside because

00:05:21.748 --> 00:05:23.908
the client ID is not really sensitive.

00:05:24.138 --> 00:05:24.608
you don't.

00:05:24.848 --> 00:05:26.448
It's meant to live on the client.

00:05:26.448 --> 00:05:26.848
So

00:05:27.358 --> 00:05:29.198
I'm going to go ahead and put that into here

00:05:31.498 --> 00:05:33.162
and PNPM run

00:05:33.802 --> 00:05:35.082
stage deploy.

00:05:35.256 --> 00:05:35.795
All right.

00:05:35.795 --> 00:05:38.475
It asked if I wanted to continue because it looks

00:05:38.475 --> 00:05:39.875
like I have changed some,

00:05:40.015 --> 00:05:41.295
variables in the Cloudflare dashboard.

00:05:41.295 --> 00:05:41.655
I just said,

00:05:41.655 --> 00:05:42.015
yes,

00:05:42.095 --> 00:05:43.135
everything deployed.

00:05:43.455 --> 00:05:45.535
These are our variables here.

00:05:45.935 --> 00:05:47.815
So now you can see in our dashboard,

00:05:47.815 --> 00:05:49.175
we have all stripe.

00:05:49.175 --> 00:05:50.715
Stripe keys that are secret.

00:05:50.875 --> 00:05:51.755
We have our products,

00:05:51.755 --> 00:05:53.195
and we also have our Google information.

00:05:53.275 --> 00:05:54.315
Some of these are secrets,

00:05:54.315 --> 00:05:55.595
and some of these are just plain text,

00:05:55.595 --> 00:05:56.095
variables,

00:05:56.095 --> 00:05:57.615
depending on the sensitivity of those.

00:05:57.615 --> 00:05:58.335
Those values.

00:05:58.335 --> 00:05:58.695
So

00:05:59.015 --> 00:06:01.775
let's go ahead and try this guy one more time.

00:06:01.775 --> 00:06:03.095
I suspect this should work.

00:06:03.575 --> 00:06:03.975
Cool.

00:06:03.975 --> 00:06:04.495
Okay,

00:06:04.495 --> 00:06:06.295
now this is kind of another issue that we're going

00:06:06.295 --> 00:06:06.935
to be running into.

00:06:07.005 --> 00:06:07.935
in our Google console,

00:06:07.935 --> 00:06:09.495
I have not whitelisted this.

00:06:09.655 --> 00:06:10.615
This domain.

00:06:13.728 --> 00:06:14.168
All right,

00:06:14.168 --> 00:06:16.928
so I'm heading over to our credentials and

00:06:17.888 --> 00:06:18.852
smart links,

00:06:18.852 --> 00:06:19.428
and then

00:06:19.908 --> 00:06:22.108
I'm just gonna make sure we're whitelisting this

00:06:22.108 --> 00:06:22.868
guy as well.

00:06:23.108 --> 00:06:25.748
And I'm gonna make sure we have this as a valid

00:06:26.308 --> 00:06:28.228
redirect as well here.

00:06:28.628 --> 00:06:29.368
So I'll.

00:06:29.438 --> 00:06:30.038
I'll save that.

00:06:30.038 --> 00:06:31.438
It may take five minutes.

00:06:31.468 --> 00:06:32.928
so if it doesn't work this next time,

00:06:32.928 --> 00:06:34.728
I'll just pause and then wait five minutes.

00:06:34.728 --> 00:06:36.568
So just reload this guy.

00:06:36.728 --> 00:06:37.368
Let's see.

00:06:37.608 --> 00:06:38.168
Boom.

00:06:38.248 --> 00:06:38.608
Oh,

00:06:38.608 --> 00:06:38.968
yeah,

00:06:39.128 --> 00:06:40.088
it was pretty immediate,

00:06:40.088 --> 00:06:40.408
actually.

00:06:40.648 --> 00:06:41.088
All right,

00:06:41.088 --> 00:06:43.048
so I'm going to use this email that I haven't used

00:06:43.048 --> 00:06:43.368
before.

00:06:43.829 --> 00:06:44.229
and

00:06:44.869 --> 00:06:46.069
let's go ahead and continue.

00:06:46.538 --> 00:06:46.905
Cool.

00:06:46.985 --> 00:06:47.198
So

00:06:47.198 --> 00:06:47.938
we're logged in.

00:06:47.938 --> 00:06:49.538
Let's head over to our database.

00:06:49.858 --> 00:06:50.578
Our users.

00:06:50.578 --> 00:06:52.578
We can see we now have this new user.

00:06:52.578 --> 00:06:54.818
And let's see if it created our stripe.

00:06:54.998 --> 00:06:55.198
Yep,

00:06:55.198 --> 00:06:56.118
it created our stripe.

00:06:56.118 --> 00:06:56.558
Customer,

00:06:56.558 --> 00:06:57.358
which is awesome.

00:06:57.358 --> 00:06:59.558
So our Stripe API is at least working.

00:07:00.358 --> 00:07:00.718
Now.

00:07:00.718 --> 00:07:02.598
Let's go ahead and do the payment,

00:07:02.678 --> 00:07:04.278
see if the payment's going to work as.

00:07:04.278 --> 00:07:04.918
As expected.

00:07:05.238 --> 00:07:06.444
So let's start with Basic

00:07:06.448 --> 00:07:07.968
and I'm just going to do

00:07:08.288 --> 00:07:09.248
Cash app again.

00:07:11.626 --> 00:07:12.026
Awesome.

00:07:12.026 --> 00:07:12.906
Now that that went through,

00:07:12.906 --> 00:07:14.746
it shows that this is on our current plan,

00:07:15.306 --> 00:07:16.106
which is great.

00:07:16.626 --> 00:07:19.146
we should see this new subscription in our

00:07:19.146 --> 00:07:20.866
subscription table as well.

00:07:20.888 --> 00:07:21.398
Yep.

00:07:21.888 --> 00:07:22.958
on the basic plan.

00:07:23.838 --> 00:07:25.598
Now let's upgrade to,

00:07:26.538 --> 00:07:27.178
upgrade to Pro.

00:07:27.212 --> 00:07:28.184
Go ahead and upgrade.

00:07:28.443 --> 00:07:28.607
Now,

00:07:28.607 --> 00:07:30.567
it didn't change in here,

00:07:30.567 --> 00:07:32.767
which makes me think the web hooks might not be

00:07:32.767 --> 00:07:33.047
working.

00:07:33.207 --> 00:07:34.087
So inside of,

00:07:34.587 --> 00:07:35.227
Stripe,

00:07:35.227 --> 00:07:37.227
let's go ahead and reload this.

00:07:37.631 --> 00:07:37.911
Cool.

00:07:37.911 --> 00:07:38.311
All right,

00:07:38.311 --> 00:07:40.831
so what we're going to see here is,

00:07:42.111 --> 00:07:43.711
essentially what's happening is

00:07:43.975 --> 00:07:46.446
it failed to connect to remote host.

00:07:46.766 --> 00:07:47.486
So the,

00:07:48.606 --> 00:07:50.534
the web hooks are indeed failing here.

00:07:50.534 --> 00:07:52.004
Now I'm just going to make sure one,

00:07:52.004 --> 00:07:54.604
I have the right web hook inside of my secret.

00:07:54.684 --> 00:07:55.964
So if I head over to the service

00:07:56.824 --> 00:07:57.784
and I go to settings,

00:07:58.494 --> 00:08:00.044
and I go to my web hook,

00:08:00.044 --> 00:08:02.284
I can just say I'm going to recycle this.

00:08:02.614 --> 00:08:03.664
I'm going to rotate this

00:08:03.823 --> 00:08:04.543
key here,

00:08:04.943 --> 00:08:05.583
deploy,

00:08:05.803 --> 00:08:08.235
and then you can actually resend these events.

00:08:08.235 --> 00:08:10.755
So I'm going to go ahead and resend this one

00:08:10.975 --> 00:08:13.295
I'll resend the last one is probably what's the

00:08:13.295 --> 00:08:13.992
best thing to do.

00:08:14.052 --> 00:08:14.292
All right,

00:08:14.292 --> 00:08:15.572
that one still failed.

00:08:15.912 --> 00:08:18.472
and the reason it failed is I did not put in the

00:08:18.472 --> 00:08:19.231
right URL.

00:08:19.231 --> 00:08:20.352
I had a typo in here,

00:08:20.352 --> 00:08:22.312
which is a really silly thing to do.

00:08:22.962 --> 00:08:24.962
let's go ahead and update details.

00:08:25.682 --> 00:08:27.722
So let's make sure we're going to be sending this

00:08:27.722 --> 00:08:28.442
to the right thing,

00:08:28.442 --> 00:08:29.762
which is such a silly thing.

00:08:29.842 --> 00:08:30.242
So,

00:08:31.284 --> 00:08:34.161
stage SmartLink API update endpoint,

00:08:34.161 --> 00:08:36.547
and let's go ahead and retry this sending

00:08:36.627 --> 00:08:37.347
mechanism.

00:08:37.536 --> 00:08:38.871
Looks like it fell once again

00:08:39.166 --> 00:08:39.563
and

00:08:40.003 --> 00:08:41.123
I typed it wrong again.

00:08:41.363 --> 00:08:41.763
So

00:08:42.263 --> 00:08:44.023
I think I've been recording way too long at this

00:08:44.023 --> 00:08:44.343
point.

00:08:44.343 --> 00:08:45.143
So dot com,

00:08:45.143 --> 00:08:45.863
obviously,

00:08:45.863 --> 00:08:47.543
so update that endpoint

00:08:48.023 --> 00:08:50.693
and let's try to reason that one more time.

00:08:51.481 --> 00:08:51.961
Okay,

00:08:52.121 --> 00:08:54.121
now this is way more promising.

00:08:54.201 --> 00:08:56.881
So now we're actually getting a legit error

00:08:56.881 --> 00:08:58.841
message in here which is kind of coming from

00:08:58.841 --> 00:09:00.201
Better Auth saying what

00:09:00.601 --> 00:09:03.601
is happening or kind of coming from the Stripe SDK

00:09:03.601 --> 00:09:04.321
inside of Better Auth.

00:09:04.321 --> 00:09:06.441
Now this is another stupid thing on my part,

00:09:06.441 --> 00:09:08.561
so I'm so sorry if you're following along like to

00:09:08.561 --> 00:09:09.001
the T.

00:09:09.081 --> 00:09:11.801
I kind of misled led you astray once again.

00:09:11.801 --> 00:09:14.001
So this is not the webhook Key,

00:09:14.001 --> 00:09:15.041
which is so silly of me.

00:09:15.041 --> 00:09:15.401
It's just,

00:09:15.401 --> 00:09:16.121
it's just the id.

00:09:16.301 --> 00:09:17.421
if we head back to

00:09:18.281 --> 00:09:18.521
the

00:09:18.761 --> 00:09:19.561
web hooks,

00:09:19.721 --> 00:09:22.601
we should be able to create a webhook key inside

00:09:22.601 --> 00:09:22.929
of here.

00:09:23.016 --> 00:09:24.376
Now what I ended up doing,

00:09:24.836 --> 00:09:25.206
is

00:09:25.526 --> 00:09:27.846
there was this button called Switch to workbench

00:09:27.926 --> 00:09:29.766
inside of the webhook thing.

00:09:29.766 --> 00:09:32.366
And then once you actually switch to workbench you

00:09:32.366 --> 00:09:34.006
have a more in depth

00:09:34.416 --> 00:09:36.416
configuration panel that pops up here.

00:09:36.816 --> 00:09:38.653
So inside of webhooks

00:09:38.707 --> 00:09:40.867
you can actually click on a,

00:09:41.020 --> 00:09:43.110
you can actually click on a given web hook here

00:09:43.590 --> 00:09:46.430
and then you're taken to the signing signature and

00:09:46.430 --> 00:09:47.990
this is ultimately what you want.

00:09:48.230 --> 00:09:50.550
So you can go ahead and copy that guy,

00:09:50.654 --> 00:09:52.084
head back over to

00:09:52.404 --> 00:09:55.124
your worker and then let's rotate that webhook key

00:09:55.124 --> 00:09:56.084
one last time.

00:09:58.576 --> 00:09:58.816
Sorry,

00:09:58.816 --> 00:10:00.176
this section is a little bit rough,

00:10:00.176 --> 00:10:03.096
but I think that this is good to kind of see how

00:10:03.096 --> 00:10:05.016
you also can troubleshoot it because if it went

00:10:05.016 --> 00:10:06.576
100% smooth the first time,

00:10:07.056 --> 00:10:09.216
you're not going to have any context to issues

00:10:09.216 --> 00:10:10.135
that you might encounter.

00:10:10.135 --> 00:10:10.496
So

00:10:11.456 --> 00:10:13.216
now from here let's just go ahead and take a look

00:10:13.216 --> 00:10:14.016
at our events.

00:10:14.176 --> 00:10:16.736
So inside of the workbench it's a little bit more

00:10:16.736 --> 00:10:17.346
detailed

00:10:17.346 --> 00:10:18.636
of information that you have here.

00:10:18.876 --> 00:10:20.636
So we can then again see,

00:10:20.966 --> 00:10:22.276
we can filter by status.

00:10:22.276 --> 00:10:23.938
So let's just go ahead and say failed.

00:10:24.590 --> 00:10:24.830
and

00:10:24.990 --> 00:10:25.864
we can go.

00:10:26.333 --> 00:10:28.716
Actually I wonder if they replayed those events.

00:10:28.716 --> 00:10:29.116
So,

00:10:29.606 --> 00:10:31.434
looks like they replayed those events.

00:10:31.954 --> 00:10:34.594
I'll just go to subscription updated really quick

00:10:34.674 --> 00:10:35.074
for

00:10:35.364 --> 00:10:36.074
this user

00:10:36.394 --> 00:10:37.994
and I'm just going to resend it.

00:10:37.994 --> 00:10:39.594
So we'll resend this one.

00:10:39.624 --> 00:10:41.427
They do looks like they do auto retry though

00:10:41.538 --> 00:10:43.488
and it looks like that just went through.

00:10:44.098 --> 00:10:44.508
so yeah,

00:10:44.508 --> 00:10:47.308
it looks like these web hooks are now working as

00:10:47.308 --> 00:10:47.628
expected.

00:10:48.058 --> 00:10:50.352
I just want to try to see if I can't replay

00:10:50.352 --> 00:10:51.192
another one of these.

00:10:52.357 --> 00:10:52.704
yeah,

00:10:52.704 --> 00:10:54.424
so it looks like these also went through.

00:10:54.958 --> 00:10:55.598
I mean I could,

00:10:55.758 --> 00:10:57.958
I could retry it just for the sake of retrying it,

00:10:57.958 --> 00:10:59.278
but these should also be going through.

00:10:59.278 --> 00:10:59.558
Yeah,

00:10:59.558 --> 00:11:00.958
that also went through successful.

00:11:00.958 --> 00:11:02.598
So our web hooks are now working.

00:11:02.598 --> 00:11:05.558
And then I do suspect if we come over to our logs,

00:11:05.558 --> 00:11:08.398
we should see the previous error logs in here.

00:11:08.398 --> 00:11:10.478
So let's just filter by the last 15 minutes.

00:11:11.578 --> 00:11:12.018
you know,

00:11:12.018 --> 00:11:13.578
we should be able to see like hey,

00:11:13.578 --> 00:11:15.098
there was some issues into here.

00:11:15.278 --> 00:11:16.958
no IP address found for rate limiting.

00:11:16.958 --> 00:11:17.198
Okay,

00:11:17.198 --> 00:11:19.238
here's our specific better auth secret.

00:11:19.711 --> 00:11:20.231
oh yeah,

00:11:20.231 --> 00:11:20.831
this is another,

00:11:20.911 --> 00:11:22.911
another site thing that we'll get into but

00:11:23.650 --> 00:11:24.826
last 15 minutes

00:11:25.146 --> 00:11:26.746
now we should see some of these.

00:11:26.986 --> 00:11:29.266
It looks like the logs are lagging just a little

00:11:29.266 --> 00:11:29.426
bit.

00:11:29.426 --> 00:11:30.426
But you should see that

00:11:30.826 --> 00:11:31.226
these

00:11:31.436 --> 00:11:33.796
web hooks are going to be actually processed

00:11:35.456 --> 00:11:37.936
so let's just go ahead and try to

00:11:38.838 --> 00:11:39.318
So yeah,

00:11:39.318 --> 00:11:39.838
look at it.

00:11:39.838 --> 00:11:41.318
Switched over to the current plan because that was

00:11:41.318 --> 00:11:42.038
the original issue.

00:11:42.038 --> 00:11:43.518
So now that we're on the current plan,

00:11:43.518 --> 00:11:46.078
let's just make sure our cancellation thing works

00:11:46.078 --> 00:11:46.518
as expected.

00:11:46.758 --> 00:11:49.078
So we'll be directed to the cancellation.

00:11:49.946 --> 00:11:50.358
Cool.

00:11:50.358 --> 00:11:51.758
Now when we reload this page,

00:11:51.758 --> 00:11:52.778
it's going to be showing that

00:11:52.778 --> 00:11:53.898
it's a cancellation period.

00:11:53.898 --> 00:11:56.844
So web hooks are entirely flushed out here.

00:11:57.704 --> 00:11:58.064
All right,

00:11:58.064 --> 00:11:58.734
so now that

00:11:58.734 --> 00:12:00.659
our subscriptions are fully working and everything

00:12:00.659 --> 00:12:01.459
is looking good,

00:12:01.459 --> 00:12:02.619
if you wanted to,

00:12:02.619 --> 00:12:04.659
you could go and create these products in like an

00:12:04.659 --> 00:12:06.899
actual real Stripe account that takes actual

00:12:06.899 --> 00:12:08.579
payments and you could go through the process of

00:12:08.579 --> 00:12:09.529
integrating and whatnot.

00:12:09.529 --> 00:12:09.738
yeah,

00:12:09.738 --> 00:12:10.539
totally up to you.

00:12:10.929 --> 00:12:11.339
it's,

00:12:11.339 --> 00:12:11.699
you know,

00:12:11.699 --> 00:12:13.499
the exact same process that we did for Stage.

00:12:13.499 --> 00:12:15.899
It's literally mirrored as an into production.

00:12:15.899 --> 00:12:17.229
So I'll leave that one to you,

00:12:17.229 --> 00:12:18.219
if you want to go that route.

00:12:18.219 --> 00:12:20.059
But I do want to address this issue.

00:12:20.139 --> 00:12:20.539
So

00:12:20.839 --> 00:12:21.959
this is something that like,

00:12:21.959 --> 00:12:22.839
is actually really important.

00:12:22.919 --> 00:12:26.039
And it's essentially saying that the Better Auth

00:12:26.039 --> 00:12:26.839
secret in your environment,

00:12:27.349 --> 00:12:28.499
variables is not

00:12:28.699 --> 00:12:29.099
set.

00:12:29.099 --> 00:12:30.379
So it's using a default one,

00:12:30.379 --> 00:12:32.419
which basically means it is not going to be

00:12:32.419 --> 00:12:32.859
secure.

00:12:32.859 --> 00:12:33.259
So

00:12:33.529 --> 00:12:36.219
what happens with Better Auth is they take in a

00:12:36.219 --> 00:12:36.779
sequence,

00:12:37.019 --> 00:12:39.419
some type of code provided by you and that's kind

00:12:39.419 --> 00:12:40.434
of like a source of truth.

00:12:40.434 --> 00:12:42.554
So when Better Auth actually starts creating JSON

00:12:42.554 --> 00:12:43.194
web tokens,

00:12:43.194 --> 00:12:44.594
if you configure it to do so,

00:12:44.594 --> 00:12:46.594
it's going to be using that as the actual like

00:12:46.594 --> 00:12:46.874
key.

00:12:47.504 --> 00:12:48.944
And if it's just using the default key,

00:12:48.944 --> 00:12:50.064
it's actually no longer

00:12:50.264 --> 00:12:52.104
secure because it's using a default key.

00:12:52.184 --> 00:12:54.104
So in order to fix this issue,

00:12:54.184 --> 00:12:56.944
what we can do is we can head over to our Data Ops

00:12:56.944 --> 00:12:59.104
package and at the top level we're just going to

00:12:59.104 --> 00:12:59.384
say

00:13:00.044 --> 00:13:00.304
secret.

00:13:03.424 --> 00:13:04.784
And that's going to be a string.

00:13:05.082 --> 00:13:05.688
I'm sorry,

00:13:05.688 --> 00:13:08.248
it should not live at the level of stripe.

00:13:08.248 --> 00:13:10.158
basically what we're going to do is we can come

00:13:10.158 --> 00:13:10.878
into our

00:13:11.078 --> 00:13:13.317
top level here and we're just going to say this is

00:13:13.317 --> 00:13:14.157
going to take a

00:13:14.717 --> 00:13:15.117
secret

00:13:15.437 --> 00:13:16.797
and it's going to be a string.

00:13:17.197 --> 00:13:19.437
And then that should be passed into this,

00:13:19.638 --> 00:13:20.897
better off as well.

00:13:21.057 --> 00:13:21.457
So

00:13:21.937 --> 00:13:23.457
we'll be passing that into here

00:13:24.417 --> 00:13:25.377
and then make sure.

00:13:25.377 --> 00:13:27.137
We add it at this level as well.

00:13:27.377 --> 00:13:27.777
So

00:13:28.137 --> 00:13:30.377
I'm actually going to put it after database

00:13:31.017 --> 00:13:31.577
string

00:13:33.185 --> 00:13:33.425
and

00:13:34.028 --> 00:13:34.686
put it here.

00:13:37.672 --> 00:13:39.952
And then the last thing we need to do is inside of

00:13:39.952 --> 00:13:42.672
our better auth config after database we're just

00:13:42.672 --> 00:13:43.272
going to say

00:13:43.591 --> 00:13:43.992
secret

00:13:44.632 --> 00:13:45.752
is going to be secret

00:13:47.064 --> 00:13:47.696
and then

00:13:48.156 --> 00:13:50.156
we might have to update this as well.

00:13:50.316 --> 00:13:50.716
So

00:13:51.176 --> 00:13:55.256
for now we are just going to be passing in a comma

00:13:55.256 --> 00:13:57.536
an empty string because this is our generate,

00:13:57.536 --> 00:13:57.856
remember,

00:13:57.856 --> 00:13:58.976
this is our generate script.

00:13:58.976 --> 00:14:01.016
So we don't really care what's being passed into

00:14:01.016 --> 00:14:01.336
here.

00:14:01.496 --> 00:14:03.006
But we'll build this one more time.

00:14:03.006 --> 00:14:03.652
Now we head,

00:14:03.652 --> 00:14:06.572
once it's done being built we'll head over to our

00:14:06.812 --> 00:14:07.452
EMV

00:14:08.332 --> 00:14:10.172
and we're going to call this our

00:14:10.572 --> 00:14:10.972
app

00:14:11.772 --> 00:14:12.172
secret.

00:14:13.372 --> 00:14:14.572
And our app secret

00:14:14.850 --> 00:14:16.808
you can actually generate a random one.

00:14:16.808 --> 00:14:17.648
So like let's say

00:14:18.728 --> 00:14:19.288
generate

00:14:19.878 --> 00:14:20.758
uuid.

00:14:21.305 --> 00:14:23.116
So essentially you're going to want like a very

00:14:23.116 --> 00:14:26.236
long secure random type of code or hash or

00:14:26.236 --> 00:14:26.516
something.

00:14:26.516 --> 00:14:28.316
And this is now going to be called your app

00:14:28.316 --> 00:14:28.676
secret.

00:14:28.756 --> 00:14:31.716
And we can go into here and say PNPM run CF

00:14:32.356 --> 00:14:33.076
type gen.

00:14:33.104 --> 00:14:34.444
and then inside of app

00:14:34.924 --> 00:14:36.844
we'll go ahead and pass the

00:14:37.164 --> 00:14:37.564
this

00:14:38.604 --> 00:14:41.317
or emv.app secret into here

00:14:41.657 --> 00:14:43.958
and this is actually going to be passed in at the

00:14:43.958 --> 00:14:44.781
end on the side

00:14:46.069 --> 00:14:47.929
right now we can deploy PNPM run

00:14:48.409 --> 00:14:49.049
stage

00:14:49.849 --> 00:14:50.489
deploy.

00:14:50.512 --> 00:14:51.618
And while that's going

00:14:52.178 --> 00:14:52.578
I,

00:14:52.738 --> 00:14:53.218
we're just,

00:14:53.218 --> 00:14:54.578
we can just take this app key,

00:14:55.288 --> 00:14:56.408
head on over to

00:14:56.808 --> 00:14:57.208
here

00:14:57.399 --> 00:14:58.759
and once we add

00:14:59.159 --> 00:15:00.359
this as a

00:15:01.499 --> 00:15:02.779
and on this side of things

00:15:03.186 --> 00:15:05.118
we're no longer going to be getting that issue in

00:15:05.118 --> 00:15:05.838
our logs.

00:15:06.208 --> 00:15:06.648
yeah,

00:15:06.648 --> 00:15:08.648
so this is just kind of like the last part of the

00:15:08.648 --> 00:15:09.248
better auth

00:15:09.648 --> 00:15:10.048
section,

00:15:10.048 --> 00:15:10.840
I would say so.

00:15:11.688 --> 00:15:12.168
All right,

00:15:12.328 --> 00:15:15.448
so at this point we have authentication fully

00:15:15.448 --> 00:15:15.968
baked.

00:15:15.968 --> 00:15:18.928
We have stripe subscription subscriptions fully

00:15:18.928 --> 00:15:19.328
baked.

00:15:19.328 --> 00:15:19.928
We've also

00:15:20.328 --> 00:15:21.448
built out an entire

00:15:21.848 --> 00:15:24.648
system and service on top of Cloudflare utilizing

00:15:24.648 --> 00:15:26.167
their core compute primitive.

00:15:26.248 --> 00:15:27.768
So at this point we should have a very,

00:15:27.768 --> 00:15:29.688
very in depth understanding on how to ship to

00:15:29.688 --> 00:15:30.168
Cloudflare.

00:15:30.168 --> 00:15:31.318
I really hope so at this point.

00:15:31.328 --> 00:15:33.768
now the last little bit of the course is just

00:15:33.768 --> 00:15:35.128
going to be tidying up some things.

00:15:35.128 --> 00:15:37.168
So there's some specific things inside of here

00:15:37.168 --> 00:15:38.848
where it's like the dashboard,

00:15:39.168 --> 00:15:40.928
some of this data is still just dummy.

00:15:41.248 --> 00:15:43.088
so what we're going to want to do is actually like

00:15:43.248 --> 00:15:44.688
wire in these real queries,

00:15:44.688 --> 00:15:46.728
make sure all of these functionalities are working

00:15:46.728 --> 00:15:47.328
as expected.

00:15:47.408 --> 00:15:49.168
So a little bit more TRPC stuff

00:15:49.568 --> 00:15:49.968
and

00:15:50.398 --> 00:15:52.008
after that we're going to get into some stretch

00:15:52.008 --> 00:15:52.328
goals.

00:15:52.328 --> 00:15:53.528
So I'm just going to kind of like,

00:15:54.088 --> 00:15:56.048
I'm going to point out a few different things that

00:15:56.048 --> 00:15:56.208
like,

00:15:56.208 --> 00:15:58.488
would actually make this a really hardened,

00:15:58.488 --> 00:15:59.688
production ready application.

00:15:59.688 --> 00:16:00.138
So like,

00:16:00.468 --> 00:16:00.948
you know,

00:16:00.948 --> 00:16:03.508
like actually being able to enforce the billing

00:16:03.508 --> 00:16:05.348
stuff in your application.

00:16:05.348 --> 00:16:05.708
So like,

00:16:05.708 --> 00:16:06.388
you could say like,

00:16:06.388 --> 00:16:06.708
oh,

00:16:06.708 --> 00:16:09.948
you can only run 15 evaluations if you're on the

00:16:09.948 --> 00:16:10.908
free tier or whatnot.

00:16:10.908 --> 00:16:11.108
Right.

00:16:11.108 --> 00:16:11.308
So,

00:16:11.308 --> 00:16:11.508
like,

00:16:11.508 --> 00:16:13.408
I'm going kind of point out some different stretch

00:16:13.408 --> 00:16:14.088
goals and you,

00:16:14.088 --> 00:16:15.808
on your own could go through and actually start

00:16:15.808 --> 00:16:17.928
really getting your hands dirty and implement some

00:16:17.928 --> 00:16:19.848
of these stretch goals to kind of further solidify

00:16:19.848 --> 00:16:21.568
your understanding of how to build on top of

00:16:21.568 --> 00:16:22.768
Cloudflare and how to,

00:16:23.008 --> 00:16:23.448
you know,

00:16:23.448 --> 00:16:23.648
like,

00:16:23.648 --> 00:16:25.345
actually build out an entire SaaS production.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.103 --> 00:00:00.463
All right,

00:00:00.463 --> 00:00:02.383
so the last thing we're going to need to do inside

00:00:02.383 --> 00:00:05.703
of this UI is actually feed in real data for these

00:00:05.703 --> 00:00:06.743
analytic metrics.

00:00:06.743 --> 00:00:07.013
Now

00:00:07.013 --> 00:00:08.403
you're going to notice all of these things are

00:00:08.403 --> 00:00:09.643
mostly hard coded still.

00:00:10.283 --> 00:00:10.683
And

00:00:11.233 --> 00:00:12.883
it's going to be pretty simple to actually like

00:00:12.883 --> 00:00:14.403
wire in these analytic queries.

00:00:14.403 --> 00:00:16.843
So if you head over to User application,

00:00:16.843 --> 00:00:18.963
go to worker under trpc,

00:00:18.963 --> 00:00:20.043
we can find the

00:00:20.473 --> 00:00:21.233
links route.

00:00:21.543 --> 00:00:23.223
And what you're going to notice is we have a few

00:00:23.223 --> 00:00:25.543
of these endpoints like active links.

00:00:25.743 --> 00:00:27.303
these are links that have been

00:00:27.863 --> 00:00:29.083
clicked on very recently.

00:00:30.153 --> 00:00:33.873
we have total click in the last hour which is just

00:00:33.873 --> 00:00:35.513
going to be this metric over here

00:00:35.833 --> 00:00:37.113
and then a few other

00:00:37.923 --> 00:00:39.443
analytic metrics that we have.

00:00:39.603 --> 00:00:41.323
Essentially what we're going to want to do is

00:00:41.323 --> 00:00:42.643
build out the queries for it.

00:00:42.643 --> 00:00:43.043
So

00:00:43.663 --> 00:00:45.903
what we can do is we can CD into our

00:00:46.903 --> 00:00:48.103
Data Ops package

00:00:51.707 --> 00:00:53.867
and then I'm going to go ahead and

00:00:54.507 --> 00:00:54.907
find

00:00:55.387 --> 00:00:56.507
the file called

00:00:58.357 --> 00:00:59.877
queries links.

00:00:59.877 --> 00:01:02.677
So inside of Data Ops we have source queries

00:01:02.757 --> 00:01:03.364
links.

00:01:03.417 --> 00:01:05.377
And what we're going to want to do is we're going

00:01:05.377 --> 00:01:07.617
to want to kind of go down this list one by one

00:01:07.617 --> 00:01:08.497
and then add them.

00:01:08.497 --> 00:01:10.777
So Active Links is the first query.

00:01:11.213 --> 00:01:14.013
So we can add this specific query and we'll call

00:01:14.013 --> 00:01:14.333
this

00:01:14.973 --> 00:01:17.293
we'll call this Active Links in the last hour.

00:01:17.533 --> 00:01:20.333
And basically what this query is going to do

00:01:24.246 --> 00:01:26.006
it's going to select from our links,

00:01:26.006 --> 00:01:26.806
click table

00:01:27.286 --> 00:01:29.286
filtering by the last hour

00:01:30.006 --> 00:01:32.486
and also of course filtering on the account ID or

00:01:32.486 --> 00:01:33.126
the user id

00:01:33.446 --> 00:01:35.766
and then it's going to aggregate by the link ID

00:01:35.766 --> 00:01:36.806
and the link name

00:01:37.126 --> 00:01:39.846
and it will be showing the click count,

00:01:40.686 --> 00:01:42.686
and it will also be showing the

00:01:43.006 --> 00:01:44.286
max clicked time.

00:01:44.286 --> 00:01:46.126
So the last time it was clicked,

00:01:47.046 --> 00:01:49.485
we can go ahead and say pmpm run

00:01:49.885 --> 00:01:50.285
build

00:01:50.925 --> 00:01:52.045
should build out this

00:01:52.066 --> 00:01:52.856
query for us

00:01:52.856 --> 00:01:54.201
and then we can

00:01:56.041 --> 00:01:58.361
make sure we save before we build obviously.

00:01:59.244 --> 00:02:01.418
And it looks like I actually haven't imported the

00:02:01.418 --> 00:02:02.559
SQL statement from

00:02:02.559 --> 00:02:03.478
Drizzle orm.

00:02:03.478 --> 00:02:04.438
So we'll go ahead and do that

00:02:05.318 --> 00:02:06.518
and build one more time.

00:02:07.402 --> 00:02:07.562
Cool.

00:02:07.562 --> 00:02:08.282
That Bill went through.

00:02:08.282 --> 00:02:10.762
So let's head over to Links and then remove this

00:02:10.762 --> 00:02:11.482
dummy data,

00:02:12.994 --> 00:02:14.998
import this from our Data ops

00:02:15.245 --> 00:02:17.045
and then we're going to want to make sure we pass

00:02:17.045 --> 00:02:18.045
in the user ID

00:02:18.365 --> 00:02:20.525
as the prop so we can say context

00:02:20.624 --> 00:02:22.177
and we will pass in

00:02:22.577 --> 00:02:24.413
ctx.user

00:02:24.821 --> 00:02:27.377
info.user ID here.

00:02:27.919 --> 00:02:29.639
Now we head down here and we're going to say there

00:02:29.639 --> 00:02:31.119
is no active link clicks.

00:02:32.319 --> 00:02:34.239
So if we head over to our Links.

00:02:34.239 --> 00:02:34.639
And

00:02:35.179 --> 00:02:36.619
notice this is still undefined.

00:02:36.619 --> 00:02:39.419
We'll be adding out a URL as an environment

00:02:39.419 --> 00:02:40.459
variable very soon.

00:02:40.539 --> 00:02:40.939
But

00:02:41.259 --> 00:02:42.459
we could just say

00:02:42.905 --> 00:02:43.663
let's do

00:02:44.263 --> 00:02:45.143
let's open this up.

00:02:45.863 --> 00:02:46.743
Let's just say

00:02:47.383 --> 00:02:47.783
go

00:02:48.263 --> 00:02:48.823
stage,

00:02:49.303 --> 00:02:50.183
put that in.

00:02:50.410 --> 00:02:51.850
Just make sure that I copied the

00:02:52.170 --> 00:02:53.210
right URL.

00:02:53.210 --> 00:02:54.250
We'll say go

00:02:55.770 --> 00:02:56.330
stage,

00:02:56.650 --> 00:02:57.450
put that in.

00:02:57.530 --> 00:02:58.650
This should redirect.

00:02:58.650 --> 00:02:59.050
Cool.

00:02:59.050 --> 00:03:00.010
That redirected.

00:03:00.730 --> 00:03:01.130
And

00:03:01.690 --> 00:03:02.090
now

00:03:02.569 --> 00:03:04.090
when we head over to

00:03:04.890 --> 00:03:06.690
Dashboard let's see if we get some.

00:03:06.690 --> 00:03:06.930
Yeah,

00:03:06.930 --> 00:03:07.330
there we go.

00:03:07.330 --> 00:03:07.690
So

00:03:08.030 --> 00:03:10.030
this is now showing up whenever we actually get a

00:03:10.030 --> 00:03:10.470
link click.

00:03:10.470 --> 00:03:12.670
It'll show how many link clicks we got in the last

00:03:12.940 --> 00:03:14.890
hour and then also it's going to show the last

00:03:14.890 --> 00:03:16.690
time that it was clicked so seven seconds ago,

00:03:16.690 --> 00:03:16.870
which,

00:03:16.940 --> 00:03:17.438
which is pretty cool.

00:03:17.572 --> 00:03:19.332
So now let's head through the

00:03:19.942 --> 00:03:21.222
these queries pretty quickly.

00:03:21.222 --> 00:03:23.302
So we're going to say total link clicks in the

00:03:23.302 --> 00:03:24.102
last hour.

00:03:25.482 --> 00:03:27.242
what we're going to do is we're going to.

00:03:28.122 --> 00:03:29.561
I'll copy this guy in.

00:03:33.402 --> 00:03:35.802
So head over to our queries and let's say

00:03:36.202 --> 00:03:37.482
this is going to be

00:03:38.672 --> 00:03:39.912
total link looks in the last hours.

00:03:39.912 --> 00:03:40.992
What we'll call the method.

00:03:41.072 --> 00:03:44.312
Basically it's going to also go back one hour and

00:03:44.312 --> 00:03:46.752
then it's just going to filter by that hour and

00:03:46.752 --> 00:03:48.952
the account ID and it's just going to count all

00:03:48.952 --> 00:03:49.312
together.

00:03:50.032 --> 00:03:50.672
Save that.

00:03:51.392 --> 00:03:51.422
Let's

00:03:51.652 --> 00:03:52.532
do another one.

00:03:52.612 --> 00:03:55.732
For this like last 24 hours it's going to be a

00:03:55.732 --> 00:03:56.932
very similar query.

00:03:59.674 --> 00:04:01.434
I do think we could actually lump

00:04:01.498 --> 00:04:03.368
this together so these can kind of come through

00:04:03.368 --> 00:04:04.008
one query.

00:04:04.328 --> 00:04:04.728
So

00:04:05.048 --> 00:04:07.648
what we can do is we can basically say let's

00:04:07.648 --> 00:04:11.448
create a function called get last 24 and 48 hour

00:04:11.448 --> 00:04:13.248
clicks and we're going to set two different

00:04:13.248 --> 00:04:14.008
filters here.

00:04:14.578 --> 00:04:15.938
and then what we're going to do is we're going to

00:04:15.938 --> 00:04:16.818
do a case statement

00:04:17.105 --> 00:04:20.065
that looks at the click time and then just does an

00:04:20.065 --> 00:04:21.025
in place filter

00:04:21.725 --> 00:04:24.965
of the last 48 hours and then also the last 24

00:04:24.965 --> 00:04:25.325
hours.

00:04:25.405 --> 00:04:28.045
So essentially we're just going to have one filter

00:04:28.045 --> 00:04:30.405
in here at the base level that's going to scan the

00:04:30.405 --> 00:04:31.765
last 48 hours worth of data.

00:04:31.765 --> 00:04:33.805
And then obviously if like your data was huge and

00:04:33.805 --> 00:04:35.645
like you had like an enterprise account that had

00:04:35.885 --> 00:04:37.044
millions and millions of records,

00:04:37.044 --> 00:04:38.525
you probably move to like a different

00:04:38.845 --> 00:04:40.575
link clicks type of analytics,

00:04:40.955 --> 00:04:42.555
platform to kind of store that data.

00:04:42.555 --> 00:04:44.435
But for the purpose of this I think it's way

00:04:44.435 --> 00:04:45.225
beyond the scope.

00:04:45.485 --> 00:04:45.845
yeah,

00:04:45.845 --> 00:04:47.285
so we're going to scan the last two days worth of

00:04:47.285 --> 00:04:49.885
data and we'll just do these in place filters

00:04:49.885 --> 00:04:50.205
here,

00:04:50.668 --> 00:04:51.548
go ahead and save that.

00:04:52.108 --> 00:04:54.988
And we also have this metric for getting the last

00:04:55.148 --> 00:04:56.328
30 days worth of

00:04:56.918 --> 00:04:57.758
link clicks.

00:04:57.758 --> 00:05:01.478
So again we'll just have another one called

00:05:01.878 --> 00:05:03.562
get last 30 days clicks

00:05:03.562 --> 00:05:05.584
and that's just going to set a filter for 30 days,

00:05:05.984 --> 00:05:06.864
do another count.

00:05:06.944 --> 00:05:09.184
And a lot of these queries are kind of like,

00:05:09.984 --> 00:05:11.864
they're kind of like redundant.

00:05:11.864 --> 00:05:14.064
Like this is very similar to the last 24 hours.

00:05:14.064 --> 00:05:16.784
So realistically if we wanted to we could probably

00:05:16.944 --> 00:05:19.104
have this as like a generic method and then we

00:05:19.104 --> 00:05:19.414
could pass,

00:05:19.484 --> 00:05:21.564
pass in a date filter at the top level.

00:05:21.564 --> 00:05:23.164
But we're not going to worry about that now.

00:05:23.164 --> 00:05:25.084
Just know like if you wanted to clean things up,

00:05:25.314 --> 00:05:26.534
you could make these a lot,

00:05:26.884 --> 00:05:28.524
you know like a lot more generic

00:05:28.524 --> 00:05:29.304
and reusable.

00:05:29.944 --> 00:05:32.104
Now we'll do another one for

00:05:32.464 --> 00:05:34.344
The last thing I think we have is

00:05:34.664 --> 00:05:35.064
this,

00:05:35.304 --> 00:05:35.644
this

00:05:35.714 --> 00:05:37.554
metric right here which is

00:05:37.874 --> 00:05:40.194
top countries and essentially what we're going to

00:05:40.194 --> 00:05:42.274
say is it's going to group by country

00:05:42.834 --> 00:05:45.034
and it's going to show the number of link clicks

00:05:45.034 --> 00:05:48.114
and the percentage of the total link clicks that

00:05:48.114 --> 00:05:49.474
are attributed to a given country.

00:05:50.222 --> 00:05:52.650
So we can go ahead and create a method called get

00:05:53.130 --> 00:05:53.930
30 days

00:05:54.250 --> 00:05:54.650
link,

00:05:54.650 --> 00:05:55.450
click by country

00:05:57.267 --> 00:05:57.407
and

00:05:57.407 --> 00:05:59.167
All it's going to do is filter by the last 30

00:05:59.167 --> 00:05:59.487
days,

00:05:59.567 --> 00:06:02.407
group by country and then do account and make sure

00:06:02.407 --> 00:06:04.727
we're filtering by account ID and then also the 30

00:06:04.727 --> 00:06:05.087
days.

00:06:05.087 --> 00:06:06.287
So I'm going to go ahead and

00:06:07.647 --> 00:06:10.367
we can go ahead and build PNPM run

00:06:10.927 --> 00:06:11.327
build

00:06:11.714 --> 00:06:13.179
should build out those queries for us.

00:06:13.179 --> 00:06:15.322
Now we can head over to our router

00:06:15.737 --> 00:06:17.857
and I'm just going to go ahead and copy this stuff

00:06:17.857 --> 00:06:18.137
in.

00:06:18.297 --> 00:06:18.697
So

00:06:20.048 --> 00:06:22.328
total link clicks in the last hour is going to use

00:06:22.328 --> 00:06:22.928
this method,

00:06:23.008 --> 00:06:24.368
import it from data ops.

00:06:24.608 --> 00:06:27.408
Last 24 hour link clicks which this is honestly a

00:06:27.408 --> 00:06:27.808
bad name.

00:06:27.808 --> 00:06:29.928
I think I wrote this and then I added another

00:06:29.928 --> 00:06:30.608
metric later.

00:06:30.608 --> 00:06:32.128
So you could change that if you want.

00:06:33.508 --> 00:06:34.628
we'll import this query

00:06:35.028 --> 00:06:36.548
last 30 day clicks

00:06:38.788 --> 00:06:40.468
and then clicks by country.

00:06:43.108 --> 00:06:43.588
Cool.

00:06:43.748 --> 00:06:44.468
Save that.

00:06:44.788 --> 00:06:47.068
Now we should look at our dashboard and we should

00:06:47.068 --> 00:06:47.428
see.

00:06:47.508 --> 00:06:48.068
Yep,

00:06:48.068 --> 00:06:50.628
these queries are actually coming from trpc,

00:06:50.628 --> 00:06:53.388
so United States of America to link clicks.

00:06:53.388 --> 00:06:54.708
Link clicks in the last hour.

00:06:55.518 --> 00:06:57.358
and then we have link clicks in the last 30 days.

00:06:57.820 --> 00:06:59.900
Now let's head over to our

00:07:00.930 --> 00:07:03.330
links and you notice this shows as undefined.

00:07:03.330 --> 00:07:05.250
We can go ahead and we can fix that.

00:07:05.490 --> 00:07:05.766
So

00:07:05.766 --> 00:07:08.794
heading over to the UI in the user application,

00:07:08.794 --> 00:07:11.575
I'm just going to do a bulk search for some text

00:07:11.575 --> 00:07:13.295
that we see in the

00:07:13.615 --> 00:07:14.255
actual,

00:07:14.925 --> 00:07:15.565
ui.

00:07:15.725 --> 00:07:17.325
And that's going to bring us to here.

00:07:18.127 --> 00:07:21.327
Now we can see we have this column helper with the

00:07:21.327 --> 00:07:22.287
header of link.

00:07:22.367 --> 00:07:23.567
So it's this one right here.

00:07:23.807 --> 00:07:26.287
And we are pulling in a environment

00:07:26.767 --> 00:07:28.767
variable called vite backend host.

00:07:29.327 --> 00:07:33.287
Now let's just go ahead and in our EMV file for

00:07:33.287 --> 00:07:34.127
user application,

00:07:34.127 --> 00:07:35.247
let's go ahead and add that.

00:07:35.247 --> 00:07:37.327
So I'm just going to say this is,

00:07:37.567 --> 00:07:39.557
vite back and host is going to be

00:07:40.277 --> 00:07:42.757
go-stage.

00:07:43.587 --> 00:07:44.067
Smart

00:07:45.106 --> 00:07:47.274
smartlink.com is the base.

00:07:47.487 --> 00:07:48.847
So now we have that in here

00:07:49.327 --> 00:07:49.967
copy

00:07:50.447 --> 00:07:52.087
and we should be able to redirect.

00:07:52.087 --> 00:07:53.327
So that's working perfect.

00:07:53.327 --> 00:07:57.327
And then just make sure we also add this variable.

00:07:57.839 --> 00:08:00.639
we also add this variable inside of our

00:08:01.016 --> 00:08:02.936
worker config for the build.

00:08:03.016 --> 00:08:04.376
So for our automated build,

00:08:04.936 --> 00:08:06.736
we're going to want to make sure we have this as

00:08:06.736 --> 00:08:06.936
well.

00:08:06.936 --> 00:08:07.416
So we'll,

00:08:07.416 --> 00:08:09.816
we should do it for both the stage and the

00:08:09.816 --> 00:08:11.096
production version of this app.

00:08:11.096 --> 00:08:12.296
So go over to settings.

00:08:12.696 --> 00:08:15.656
These are our build time variables right here.

00:08:16.056 --> 00:08:18.536
And we can just go ahead and add this one.

00:08:18.616 --> 00:08:19.016
So

00:08:19.336 --> 00:08:19.976
we want

00:08:20.081 --> 00:08:21.452
this base one.

00:08:24.970 --> 00:08:27.930
I'll also update the production version here.

00:08:28.890 --> 00:08:31.570
And this is just going to be go smartlink.com as

00:08:31.570 --> 00:08:32.169
the base.

00:08:32.170 --> 00:08:32.650
Cool.

00:08:32.970 --> 00:08:33.530
All right,

00:08:33.610 --> 00:08:36.410
so now we have a fully functioning ui,

00:08:36.410 --> 00:08:39.010
has all the features built out and actual live

00:08:39.010 --> 00:08:40.810
data that are coming from link clicks.

00:08:40.810 --> 00:08:41.210
So

00:08:41.956 --> 00:08:43.396
that's going to wrap things up for

00:08:43.796 --> 00:08:44.076
like,

00:08:44.076 --> 00:08:46.796
the core focus of the course and the UI and

00:08:46.796 --> 00:08:47.276
whatnot.

00:08:47.596 --> 00:08:49.956
I'm going to move a little bit into some stretch

00:08:49.956 --> 00:08:51.436
goals and then maybe a little bit of like,

00:08:51.436 --> 00:08:53.356
theory around how to test this application,

00:08:53.436 --> 00:08:55.036
writing unit tests and whatnot.

00:08:55.276 --> 00:08:56.596
But I really hope you've enjoyed,

00:08:56.596 --> 00:08:57.596
what we've done so far,

00:08:57.596 --> 00:08:58.996
because I do think we've built something that's

00:08:58.996 --> 00:08:59.516
pretty cool.

00:08:59.516 --> 00:09:01.316
And at this point I really hope you've learned a

00:09:01.316 --> 00:09:01.996
ton about,

00:09:02.361 --> 00:09:04.681
about not only how to ship on Cloudflare and use

00:09:04.681 --> 00:09:06.121
like the compute primitives,

00:09:06.121 --> 00:09:07.361
but also you know,

00:09:07.361 --> 00:09:07.961
how to like,

00:09:08.041 --> 00:09:10.041
build out an entire product end to end.

00:09:10.581 --> 00:09:11.181
As you've noticed,

00:09:11.181 --> 00:09:11.581
like this,

00:09:11.581 --> 00:09:13.901
the service is really modular and we're able to

00:09:13.901 --> 00:09:15.861
extend really easily by this design.

00:09:15.941 --> 00:09:17.501
So I hope you've learned something and I hope that

00:09:17.501 --> 00:09:18.741
this course was useful for you.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.050 --> 00:00:00.370
All right,

00:00:00.370 --> 00:00:01.410
so let's talk about testing.

00:00:01.410 --> 00:00:03.330
I know a lot of developers are like people that

00:00:03.330 --> 00:00:04.210
are kind of new to the space.

00:00:04.290 --> 00:00:05.730
They don't love testing.

00:00:05.800 --> 00:00:06.190
and

00:00:06.510 --> 00:00:07.110
honestly,

00:00:07.110 --> 00:00:08.670
sometimes I don't like testing either.

00:00:08.670 --> 00:00:11.030
But it can be really important depending on the

00:00:11.030 --> 00:00:12.270
type of code that you're writing.

00:00:12.270 --> 00:00:12.670
Now,

00:00:12.670 --> 00:00:13.790
testing is very broad.

00:00:14.110 --> 00:00:15.030
We have like,

00:00:15.030 --> 00:00:15.430
you know,

00:00:15.430 --> 00:00:17.630
UI based tests where you're going to write these

00:00:17.630 --> 00:00:19.790
automated scripts that render virtual browsers,

00:00:19.790 --> 00:00:20.670
render ui,

00:00:20.670 --> 00:00:21.470
click on buttons,

00:00:21.470 --> 00:00:22.270
make sure things happen.

00:00:22.720 --> 00:00:24.360
I'm less fond of those tests.

00:00:24.360 --> 00:00:25.680
I know they can be very useful,

00:00:25.680 --> 00:00:27.040
especially for larger projects.

00:00:27.040 --> 00:00:27.360
But,

00:00:27.660 --> 00:00:29.380
what I'm kind of more interested in is actually

00:00:29.380 --> 00:00:31.940
testing the backend code and writing very specific

00:00:31.940 --> 00:00:32.700
unit tests.

00:00:32.700 --> 00:00:32.860
Now,

00:00:32.860 --> 00:00:33.860
there's kind of like two

00:00:34.260 --> 00:00:36.420
ways I like to think about writing tests.

00:00:36.420 --> 00:00:38.180
So if we look at our code,

00:00:38.500 --> 00:00:40.900
we have inside this index ts,

00:00:40.900 --> 00:00:41.620
this is the data,

00:00:41.700 --> 00:00:42.580
the data service,

00:00:42.640 --> 00:00:42.920
project,

00:00:42.920 --> 00:00:43.520
by the way.

00:00:43.960 --> 00:00:46.040
we essentially have this worker entry point that

00:00:46.040 --> 00:00:46.360
like,

00:00:46.360 --> 00:00:47.480
has a fetch handler,

00:00:47.480 --> 00:00:47.960
has a

00:00:48.230 --> 00:00:48.470
Q,

00:00:48.840 --> 00:00:50.173
and then it could have like a cron.

00:00:50.412 --> 00:00:52.852
Now I personally don't like testing at this level.

00:00:52.852 --> 00:00:53.092
Like,

00:00:53.092 --> 00:00:54.972
I don't like to write tests where you have this

00:00:54.972 --> 00:00:56.892
fetch handler and then you pass in data to the

00:00:56.892 --> 00:00:58.582
fetch handler and you expect something happens.

00:00:58.682 --> 00:00:59.202
because like,

00:00:59.202 --> 00:01:02.362
I kind of know with pretty much with certainty

00:01:02.362 --> 00:01:02.881
that like,

00:01:02.881 --> 00:01:04.282
this logic is fine.

00:01:04.392 --> 00:01:06.672
it's typically the business logic that lives

00:01:06.672 --> 00:01:08.992
inside of each route that I want to test.

00:01:09.072 --> 00:01:10.112
So to kind of like,

00:01:10.652 --> 00:01:12.892
describe this in a little more concrete terms.

00:01:13.562 --> 00:01:14.522
If you look at,

00:01:15.162 --> 00:01:16.582
Cloudflare's documentation on testing,

00:01:16.582 --> 00:01:17.382
they have this like,

00:01:17.382 --> 00:01:18.022
document for,

00:01:18.022 --> 00:01:18.182
like,

00:01:18.182 --> 00:01:19.342
how to test durable objects,

00:01:19.342 --> 00:01:19.902
for example.

00:01:19.902 --> 00:01:20.302
And

00:01:20.632 --> 00:01:22.642
you're kind of like spinning up a virtual worker

00:01:22.642 --> 00:01:23.762
inside your testing environment.

00:01:24.162 --> 00:01:25.322
And then you're kind of like saying,

00:01:25.322 --> 00:01:26.802
I'm going to go to my worker and I'm going to call

00:01:26.802 --> 00:01:27.241
Fetch.

00:01:27.241 --> 00:01:28.322
And then when I call Fetch,

00:01:28.322 --> 00:01:28.882
I expect

00:01:29.282 --> 00:01:30.242
some type of like,

00:01:30.242 --> 00:01:31.122
text to be returned.

00:01:31.122 --> 00:01:32.362
Now these can be useful,

00:01:32.362 --> 00:01:33.922
but I don't really love them.

00:01:34.102 --> 00:01:36.982
I like to kind of think about in two ways.

00:01:36.982 --> 00:01:37.302
So,

00:01:37.552 --> 00:01:38.442
inside of a queue,

00:01:38.792 --> 00:01:39.992
because if you're using TypeScript,

00:01:39.992 --> 00:01:41.152
you're kind of able to say like,

00:01:41.152 --> 00:01:41.352
okay,

00:01:41.352 --> 00:01:43.352
I'm going to iterate through a batch of messages.

00:01:43.432 --> 00:01:45.272
I don't really care about testing this.

00:01:45.332 --> 00:01:47.352
I don't need to pass in a batch of messages here.

00:01:47.772 --> 00:01:48.372
then we have

00:01:48.692 --> 00:01:51.692
a safe parse for the body and we basically are

00:01:51.692 --> 00:01:52.092
going to check,

00:01:52.092 --> 00:01:52.252
like,

00:01:52.252 --> 00:01:53.452
if we parsed it,

00:01:53.452 --> 00:01:55.252
then we're going to start processing it.

00:01:55.252 --> 00:01:57.932
Now this is kind of where I would want to test my

00:01:57.932 --> 00:01:58.932
code is at this level.

00:01:58.932 --> 00:02:01.052
So like we write some business logic in this

00:02:01.052 --> 00:02:01.492
handler.

00:02:01.492 --> 00:02:02.932
This is kind of where I would start my task.

00:02:02.932 --> 00:02:05.092
Like I would go from the top level of the handler.

00:02:05.092 --> 00:02:05.892
And if you have like

00:02:06.352 --> 00:02:07.632
logic inside of a handler,

00:02:07.632 --> 00:02:09.472
you can also test those in isolation too.

00:02:09.472 --> 00:02:10.432
Now this is

00:02:10.832 --> 00:02:11.312
a very,

00:02:11.312 --> 00:02:12.312
very simple handler.

00:02:12.312 --> 00:02:13.792
There's really no logic happening.

00:02:13.792 --> 00:02:14.832
It's just kind of like

00:02:15.232 --> 00:02:16.912
sending data to a database,

00:02:16.912 --> 00:02:17.272
you know,

00:02:17.272 --> 00:02:20.352
and then this one is like calling a workflow.

00:02:20.432 --> 00:02:22.352
So there's really not a ton to test.

00:02:22.352 --> 00:02:24.112
But I did write a test out just

00:02:24.432 --> 00:02:26.112
to kind of like show what that would look like.

00:02:26.112 --> 00:02:27.472
So you can kind of think about it as like,

00:02:27.472 --> 00:02:28.432
if you want to test this,

00:02:28.862 --> 00:02:30.982
you're going to want to make sure like you're not

00:02:30.982 --> 00:02:32.582
actually going to write anything to the database.

00:02:32.582 --> 00:02:33.742
You're going to kind of mock

00:02:34.462 --> 00:02:35.942
that interaction with the database.

00:02:35.942 --> 00:02:36.182
So like,

00:02:36.182 --> 00:02:37.422
if the database returns data,

00:02:37.422 --> 00:02:38.462
you can mock a,

00:02:38.462 --> 00:02:39.342
like return data.

00:02:40.442 --> 00:02:41.722
so inside of tests

00:02:42.202 --> 00:02:43.962
we can go to our queue handler and then we have

00:02:43.962 --> 00:02:44.922
this link clicks test.

00:02:45.002 --> 00:02:48.042
TS now essentially what we've done here is we are

00:02:48.122 --> 00:02:49.921
going into our data ops,

00:02:49.921 --> 00:02:50.442
queries,

00:02:50.442 --> 00:02:52.482
links and then we're just finding this method link

00:02:52.482 --> 00:02:52.842
click,

00:02:52.842 --> 00:02:55.202
which we're utilizing here and we're mocking it

00:02:55.202 --> 00:02:55.482
out.

00:02:55.482 --> 00:02:56.962
So essentially nothing happens.

00:02:56.962 --> 00:02:58.942
it's just writing data and nothing's happening.

00:02:59.052 --> 00:03:02.012
and then similar into our helper routes we have

00:03:02.012 --> 00:03:04.572
this schedule workflow which is also just going to

00:03:04.572 --> 00:03:06.492
be like kind of mocking that out.

00:03:06.492 --> 00:03:07.052
then we

00:03:07.642 --> 00:03:11.322
have a specific test here where we set up a mock

00:03:11.322 --> 00:03:11.642
event

00:03:12.122 --> 00:03:14.362
and this is going to be some data that like dummy

00:03:14.362 --> 00:03:15.922
data that we can pass into our tests.

00:03:15.922 --> 00:03:19.482
And then before each test runs we're going to say

00:03:19.641 --> 00:03:22.122
we're going to clear out like all like the mocked

00:03:22.122 --> 00:03:22.442
data.

00:03:22.502 --> 00:03:24.302
it's going to kind of reset all those mocks.

00:03:24.302 --> 00:03:24.702
Now,

00:03:25.102 --> 00:03:27.122
from here what we can do is this is it.

00:03:27.122 --> 00:03:28.402
If you haven't ever tested before,

00:03:28.562 --> 00:03:29.682
this is a test,

00:03:29.892 --> 00:03:30.412
semantic.

00:03:30.412 --> 00:03:32.372
So inside of describe you can say it,

00:03:32.772 --> 00:03:33.972
give it a test name.

00:03:34.132 --> 00:03:36.372
And then we're going to pass in our mock

00:03:36.372 --> 00:03:37.732
environment in our mock event.

00:03:37.892 --> 00:03:39.812
And then what we expect is

00:03:40.212 --> 00:03:43.092
that add link click was called with

00:03:43.342 --> 00:03:44.731
with the event data.

00:03:44.972 --> 00:03:46.172
So internally

00:03:46.572 --> 00:03:47.852
this code is

00:03:47.888 --> 00:03:48.539
getting some,

00:03:48.539 --> 00:03:50.739
is getting this link click event and it's passing

00:03:50.739 --> 00:03:51.139
in data.

00:03:51.139 --> 00:03:52.699
So like this test is very stupid.

00:03:52.699 --> 00:03:54.219
Like there isn't really a lot happening.

00:03:54.219 --> 00:03:56.219
It's just kind of to showcase that like if there

00:03:56.219 --> 00:03:57.139
was more logic here,

00:03:57.139 --> 00:03:59.489
like we were parsing out values and manipul

00:03:59.959 --> 00:04:02.039
the Data and then like formatting it in a specific

00:04:02.039 --> 00:04:02.239
way.

00:04:02.239 --> 00:04:04.279
You could kind of do these like tests where you

00:04:04.279 --> 00:04:06.559
have some input and you expect some output or you

00:04:06.559 --> 00:04:07.479
expect the input

00:04:07.879 --> 00:04:10.879
of a internal method inside of like some function

00:04:10.879 --> 00:04:12.919
that you have is going to be called with data.

00:04:12.999 --> 00:04:15.199
So imagine if this was a more complex scenario,

00:04:15.199 --> 00:04:16.599
this would be a more useful test.

00:04:16.639 --> 00:04:16.859
and then,

00:04:16.859 --> 00:04:17.139
you know,

00:04:17.139 --> 00:04:19.379
we have a few other things here where we have our

00:04:19.379 --> 00:04:21.219
workflow and then we're just going to basically

00:04:21.299 --> 00:04:21.699
say

00:04:22.278 --> 00:04:23.140
our workflow.

00:04:23.146 --> 00:04:25.306
This is basically asserting some order.

00:04:25.306 --> 00:04:28.266
So like we're basically saying like imagine we

00:04:28.266 --> 00:04:31.706
have logic where we need to insert the data into

00:04:31.706 --> 00:04:34.346
the database before some other section of logic

00:04:34.346 --> 00:04:34.786
happens.

00:04:34.786 --> 00:04:36.746
Because this is maybe dependent upon data being in

00:04:36.746 --> 00:04:37.186
the database.

00:04:37.186 --> 00:04:37.786
For example,

00:04:38.196 --> 00:04:38.446
this,

00:04:38.446 --> 00:04:39.966
this type of test is going to be

00:04:40.366 --> 00:04:42.726
basically saying I'm going to mock out the link

00:04:42.726 --> 00:04:43.046
click.

00:04:43.046 --> 00:04:44.286
And then also our

00:04:44.756 --> 00:04:45.556
also our

00:04:45.876 --> 00:04:46.516
workflow.

00:04:46.516 --> 00:04:49.196
And then we're going to process that link click.

00:04:49.196 --> 00:04:50.996
And then we're going to say the link click

00:04:51.286 --> 00:04:51.686
mock.

00:04:51.766 --> 00:04:54.366
So that insert into the database should have been

00:04:54.366 --> 00:04:55.686
called before the workflow.

00:04:55.686 --> 00:04:56.766
So like this another example.

00:04:56.766 --> 00:04:57.686
Now these aren't just,

00:04:57.686 --> 00:04:58.686
these aren't super useful.

00:04:58.686 --> 00:05:00.486
I just think it's really good to kind of see

00:05:00.806 --> 00:05:02.206
how you could set things up and structure it.

00:05:02.206 --> 00:05:04.846
And then if you were to expand this code to like

00:05:04.926 --> 00:05:06.766
handle more like complex use cases,

00:05:07.006 --> 00:05:09.086
you could use this as a framework to enhance these

00:05:09.086 --> 00:05:10.366
tests for those use cases.

00:05:11.036 --> 00:05:12.716
and this is just another simple like

00:05:13.096 --> 00:05:14.886
one where we're basically throwing a database

00:05:14.886 --> 00:05:15.326
error.

00:05:15.566 --> 00:05:15.966
So

00:05:16.416 --> 00:05:18.816
when we are saving some data into the database

00:05:18.896 --> 00:05:19.696
right here,

00:05:20.176 --> 00:05:20.776
add link,

00:05:20.776 --> 00:05:21.008
click,

00:05:21.082 --> 00:05:23.202
it's basically saying that's going to throw an

00:05:23.202 --> 00:05:23.602
error.

00:05:23.602 --> 00:05:23.962
So

00:05:24.122 --> 00:05:26.322
this is saying we're expecting handling click to

00:05:26.322 --> 00:05:28.042
throw this database error.

00:05:28.042 --> 00:05:29.882
And if that database error is thrown,

00:05:30.282 --> 00:05:30.682
then

00:05:31.082 --> 00:05:34.042
this section of code should not have been run.

00:05:34.122 --> 00:05:34.522
Now,

00:05:34.854 --> 00:05:35.621
now like,

00:05:35.701 --> 00:05:38.181
I guess one way to think about it is like if this

00:05:38.181 --> 00:05:39.421
doesn't depend on add link,

00:05:39.421 --> 00:05:39.741
click,

00:05:39.741 --> 00:05:41.661
maybe you throw these in like some try catch

00:05:41.661 --> 00:05:42.141
handler.

00:05:42.141 --> 00:05:43.261
So even if this fails,

00:05:43.261 --> 00:05:44.781
you can still go ahead and run that workflow.

00:05:44.781 --> 00:05:45.531
Like it depends on

00:05:45.841 --> 00:05:46.761
your business logic.

00:05:46.761 --> 00:05:48.081
But if that's the case,

00:05:48.561 --> 00:05:50.761
instead of saying we expect this not to be called,

00:05:50.761 --> 00:05:52.401
if this first method throws an error,

00:05:52.401 --> 00:05:53.801
we could say even if this throws an error,

00:05:53.801 --> 00:05:55.121
we still expect this to be called.

00:05:55.281 --> 00:05:55.681
So

00:05:55.721 --> 00:05:57.221
these are just kind of like some different ways to

00:05:57.221 --> 00:05:58.821
handle these unit tests.

00:05:59.271 --> 00:05:59.671
so

00:05:59.991 --> 00:06:02.351
this is like the one way I like to think about it.

00:06:02.351 --> 00:06:04.231
These are most of the tests that I write are stuff

00:06:04.231 --> 00:06:06.111
like this where you're kind of just like testing

00:06:06.111 --> 00:06:06.391
the,

00:06:06.551 --> 00:06:08.311
giving some input to a function and then

00:06:09.501 --> 00:06:10.981
asserting what the behavior is.

00:06:10.981 --> 00:06:12.838
After that the data is passed into a function.

00:06:13.116 --> 00:06:15.796
Now the slightly more complicated tests are going

00:06:15.796 --> 00:06:17.236
to be if you have like,

00:06:17.236 --> 00:06:18.876
let's say you're building on top of durable

00:06:18.876 --> 00:06:21.956
objects and this durable object actually has a lot

00:06:21.956 --> 00:06:23.996
of business logic embedded inside the class.

00:06:24.076 --> 00:06:26.316
Now I don't love writing code this way.

00:06:26.316 --> 00:06:28.276
I kind of like to break things outside of the

00:06:28.276 --> 00:06:30.436
durable object and just use the durable object for

00:06:30.436 --> 00:06:31.796
like alarm scheduling and whatnot.

00:06:31.796 --> 00:06:33.356
But sometimes if you're really,

00:06:33.356 --> 00:06:35.516
really using the features of the durable object,

00:06:35.836 --> 00:06:38.156
your logic is going to be pretty like embedded

00:06:38.156 --> 00:06:38.956
inside of this class,

00:06:39.376 --> 00:06:41.136
similar to what we have here inside of the link

00:06:41.136 --> 00:06:41.936
click tracker.

00:06:41.936 --> 00:06:42.256
Now

00:06:43.136 --> 00:06:45.496
what you're going to notice is like whenever we

00:06:45.496 --> 00:06:46.696
call add link click,

00:06:46.696 --> 00:06:47.616
we would expect

00:06:48.016 --> 00:06:48.416
that,

00:06:48.496 --> 00:06:50.376
we'd expect that some data is saved into a

00:06:50.376 --> 00:06:52.696
database and then we would also say expect that if

00:06:52.696 --> 00:06:53.696
there is no alarm,

00:06:53.856 --> 00:06:54.256
that

00:06:55.676 --> 00:06:56.276
is being called.

00:06:56.276 --> 00:06:58.556
And then there's like some other like very

00:06:58.556 --> 00:06:59.156
specific

00:06:59.476 --> 00:07:01.516
bits of logic in here that we can go over in just

00:07:01.516 --> 00:07:01.836
a second.

00:07:01.836 --> 00:07:03.956
But essentially when you're writing these types of

00:07:03.956 --> 00:07:04.436
tests,

00:07:04.727 --> 00:07:05.207
what we're,

00:07:05.207 --> 00:07:06.647
what I like to do is

00:07:07.127 --> 00:07:09.447
I like to basically take all of the

00:07:09.627 --> 00:07:10.327
dependencies.

00:07:10.327 --> 00:07:12.967
So like all of the like helper methods that

00:07:12.967 --> 00:07:15.367
require actual IO connection to the database,

00:07:15.367 --> 00:07:16.967
connection to API calls,

00:07:16.967 --> 00:07:19.167
and I like to mock those out so we can like

00:07:19.167 --> 00:07:20.007
manually add

00:07:20.127 --> 00:07:22.133
return values whether it throws an error or not.

00:07:22.134 --> 00:07:22.811
Now in terms of,

00:07:22.811 --> 00:07:23.811
in terms of actually

00:07:24.211 --> 00:07:25.971
testing out the durable object,

00:07:26.451 --> 00:07:28.971
essentially what we're going to want to do is you

00:07:28.971 --> 00:07:29.131
know,

00:07:29.131 --> 00:07:30.891
you're going to have to actually mock out the

00:07:30.891 --> 00:07:32.371
durable object itself.

00:07:32.531 --> 00:07:34.731
So the durable object has a bunch of like internal

00:07:34.731 --> 00:07:36.211
APIs that require the

00:07:36.611 --> 00:07:36.641
Cloudflare

00:07:37.111 --> 00:07:37.671
runtime

00:07:39.371 --> 00:07:42.051
like it depends on the Cloudflare runtime and they

00:07:42.051 --> 00:07:44.251
do have some like information about testing and

00:07:44.251 --> 00:07:45.051
how to like use

00:07:45.991 --> 00:07:47.871
different like libraries that they can provide for

00:07:47.871 --> 00:07:48.591
helping with testing.

00:07:48.591 --> 00:07:50.911
But I've always found it a lot easier to just kind

00:07:50.911 --> 00:07:52.991
of like mock out the logic that you care about

00:07:52.991 --> 00:07:54.671
because I mostly am trying to test the business

00:07:54.671 --> 00:07:57.231
logic and not like the actual functionality,

00:07:57.231 --> 00:07:59.271
lower level functionality of the durable object.

00:08:00.791 --> 00:08:03.111
Now if you actually need to go that deep into your

00:08:03.111 --> 00:08:03.831
test you,

00:08:03.831 --> 00:08:05.631
there's a lot of documentation out there on how to

00:08:05.631 --> 00:08:05.871
do it,

00:08:05.871 --> 00:08:07.791
but I just don't think it's like crazy easy.

00:08:07.791 --> 00:08:10.151
And I kind of prefer to just say hey,

00:08:10.231 --> 00:08:13.151
this is my durable object class and I'm going to

00:08:13.151 --> 00:08:14.271
test out the functionality.

00:08:14.271 --> 00:08:16.431
So I'm going to mock out the things that like are

00:08:16.431 --> 00:08:16.951
utilized.

00:08:16.951 --> 00:08:19.891
So you can see inside of the durable object class,

00:08:20.411 --> 00:08:21.771
we have like a SQL,

00:08:21.851 --> 00:08:25.051
we have like a SQL instance and that has like

00:08:25.051 --> 00:08:27.011
execute and you're able to run queries.

00:08:27.011 --> 00:08:28.491
You also have a storage API.

00:08:28.591 --> 00:08:30.851
there's kind of like this state management that is

00:08:30.851 --> 00:08:32.171
part of the durable object.

00:08:32.171 --> 00:08:34.091
And then also we have web sockets

00:08:34.411 --> 00:08:35.771
which are part of the

00:08:35.871 --> 00:08:36.421
API.

00:08:36.421 --> 00:08:38.701
So inside of this test you're going to notice that

00:08:39.001 --> 00:08:41.101
we're going to be mocking a lot of this stuff out.

00:08:41.101 --> 00:08:43.661
So like we are mocking out the SQL Storage API.

00:08:43.661 --> 00:08:44.061
So

00:08:44.301 --> 00:08:46.281
the execute database size cursor statement,

00:08:46.281 --> 00:08:48.061
all these things we're just kind of like mocking

00:08:48.061 --> 00:08:49.101
out what those would look like.

00:08:49.431 --> 00:08:49.831
similar.

00:08:49.831 --> 00:08:51.271
We're doing the same thing with the

00:08:51.651 --> 00:08:52.451
websocket

00:08:54.851 --> 00:08:57.291
and then also the state object where the storage

00:08:57.291 --> 00:09:00.211
is taking our like mock of the SQL storage and

00:09:00.211 --> 00:09:02.291
we're mocking out get input and whatnot.

00:09:02.691 --> 00:09:04.931
then essentially what that's what the tests are

00:09:04.931 --> 00:09:07.731
going to look like is we're kind of able to say

00:09:10.761 --> 00:09:13.281
we're kind of able to test logic like add link

00:09:13.281 --> 00:09:13.961
click here.

00:09:15.631 --> 00:09:18.031
So basically when add link click is called

00:09:18.681 --> 00:09:20.121
when add link click is called.

00:09:20.201 --> 00:09:21.721
In this test we're basically saying

00:09:22.041 --> 00:09:23.961
there already is an alarm scheduled.

00:09:23.961 --> 00:09:26.321
So when we add a link click and we add some data

00:09:26.321 --> 00:09:27.401
about that link click,

00:09:27.691 --> 00:09:28.211
we expect

00:09:28.691 --> 00:09:31.811
the SQL query to be called with this information.

00:09:32.131 --> 00:09:34.011
So you can see that's kind of what's happening

00:09:34.011 --> 00:09:34.371
here?

00:09:38.831 --> 00:09:40.551
so that test would be pretty straightforward.

00:09:40.551 --> 00:09:42.431
So if like we ever have a schema change,

00:09:42.431 --> 00:09:43.151
we'd also like,

00:09:43.151 --> 00:09:45.111
want to make sure we're updating the tests for

00:09:45.111 --> 00:09:45.391
that.

00:09:45.691 --> 00:09:47.851
And then we can have like another type of test

00:09:47.851 --> 00:09:48.781
where it should set

00:09:48.781 --> 00:09:50.891
an alarm if alarm doesn't exist.

00:09:50.971 --> 00:09:52.171
So if you look here,

00:09:52.171 --> 00:09:53.771
essentially we have a,

00:09:53.851 --> 00:09:56.691
we have this logic where we insert some data and

00:09:56.691 --> 00:09:57.051
then

00:09:57.371 --> 00:09:58.371
we get an alarm.

00:09:58.371 --> 00:09:58.971
And if there

00:09:59.291 --> 00:10:00.491
is no alarm,

00:10:00.491 --> 00:10:02.171
then we set an alarm here.

00:10:02.251 --> 00:10:03.251
So that's,

00:10:03.251 --> 00:10:04.971
we're kind of fabricating the same logic here.

00:10:04.971 --> 00:10:07.611
We're adding a link click and then we're expecting

00:10:07.611 --> 00:10:09.851
that get alarm should have been called.

00:10:10.571 --> 00:10:11.531
And the

00:10:12.321 --> 00:10:14.241
and the set alarm also should have been called

00:10:14.241 --> 00:10:15.761
because we're saying that the

00:10:16.201 --> 00:10:17.021
get alarm,

00:10:17.661 --> 00:10:19.181
the mocked value,

00:10:19.261 --> 00:10:22.381
so the value that's returned is going to be null.

00:10:22.621 --> 00:10:25.661
So essentially we expect if it is null that it

00:10:25.661 --> 00:10:27.101
should be called with this number.

00:10:27.341 --> 00:10:27.741
Now

00:10:31.741 --> 00:10:33.901
the inverse of that would basically be saying when

00:10:33.901 --> 00:10:35.021
get alarm is called,

00:10:35.101 --> 00:10:37.101
we're going to say there is an assigned value to

00:10:37.101 --> 00:10:37.341
it.

00:10:37.971 --> 00:10:39.331
So inside of this logic,

00:10:39.331 --> 00:10:40.051
if a

00:10:40.861 --> 00:10:41.941
link click happens,

00:10:41.941 --> 00:10:43.701
we do expect that if this,

00:10:43.701 --> 00:10:45.101
if there's some data returned here,

00:10:45.101 --> 00:10:47.701
we don't call this set alarm logic.

00:10:47.701 --> 00:10:48.781
And that's kind of what's happening here.

00:10:48.781 --> 00:10:50.381
We expect the get alarm to be called,

00:10:50.701 --> 00:10:51.101
but

00:10:51.651 --> 00:10:53.861
the set alarm state should not have been called.

00:10:54.021 --> 00:10:56.101
So that's kind of like in a nutshell,

00:10:56.101 --> 00:10:56.741
how to test

00:10:57.071 --> 00:10:58.681
like the logic inside of a durable object.

00:10:58.681 --> 00:10:59.281
As you notice,

00:10:59.281 --> 00:11:01.561
like we are mocking out a lot of like we're

00:11:01.561 --> 00:11:02.281
mocking out this.

00:11:02.281 --> 00:11:04.761
We're mocking out the get alarm and the store and

00:11:04.761 --> 00:11:05.801
the set alarm and whatnot.

00:11:07.571 --> 00:11:09.651
And then we're just kind of like in those tests

00:11:09.651 --> 00:11:11.411
we're saying if set alarm,

00:11:11.571 --> 00:11:12.971
if get alarm already has a value,

00:11:12.971 --> 00:11:14.611
set alarm should not be called kind of a thing.

00:11:14.611 --> 00:11:15.971
And that's how we're testing out some internal

00:11:15.971 --> 00:11:16.611
logic here.

00:11:18.451 --> 00:11:19.171
Now the

00:11:20.011 --> 00:11:22.331
this class actually has quite a bit of logic in

00:11:22.331 --> 00:11:22.531
it.

00:11:22.531 --> 00:11:24.651
So one of the things that we have is we have this

00:11:24.651 --> 00:11:25.211
alarm

00:11:25.531 --> 00:11:28.051
and this alarm is essentially like whenever we get

00:11:28.051 --> 00:11:28.571
link clicks,

00:11:28.571 --> 00:11:30.451
it's setting a buffer for a few seconds and then

00:11:30.451 --> 00:11:30.731
it

00:11:30.761 --> 00:11:31.031
or like,

00:11:31.031 --> 00:11:32.351
I think it's like two seconds and then it's

00:11:32.351 --> 00:11:34.231
sending that data down to WebSocket clients.

00:11:34.231 --> 00:11:35.471
So during that process,

00:11:35.631 --> 00:11:37.451
every two seconds we're going to go ahead and

00:11:37.451 --> 00:11:39.651
we're going to get like the most those link clicks

00:11:39.651 --> 00:11:41.051
that are kind of in the buffer.

00:11:41.531 --> 00:11:41.931
And

00:11:42.531 --> 00:11:44.171
we're going to go to every Single socket.

00:11:44.171 --> 00:11:46.091
And we're going to send some data back to those

00:11:46.091 --> 00:11:47.491
actual clients that are connected

00:11:47.891 --> 00:11:49.331
and then we're flushing the time.

00:11:49.331 --> 00:11:51.371
So we're basically saying we just process this

00:11:51.371 --> 00:11:52.571
little batch of link clicks.

00:11:52.571 --> 00:11:54.731
So now like we're moving that offset off to the

00:11:54.731 --> 00:11:55.891
top of the table.

00:11:56.051 --> 00:11:56.451
So,

00:11:56.641 --> 00:11:58.991
the buffer kind of like resets and then we're

00:11:58.991 --> 00:11:59.911
deleting some data.

00:11:59.991 --> 00:12:02.431
So a test for that would kind of look as follows.

00:12:02.431 --> 00:12:04.311
This one's like a little bit more involved where

00:12:04.731 --> 00:12:07.371
we are mocking the data that is in the table here.

00:12:09.111 --> 00:12:10.911
And then we're basically saying the get link

00:12:10.911 --> 00:12:13.031
clicks call is going to return this

00:12:13.231 --> 00:12:13.871
mock data.

00:12:14.431 --> 00:12:15.791
We're kind of mocking out

00:12:16.251 --> 00:12:16.651
different,

00:12:17.101 --> 00:12:17.661
sockets.

00:12:17.661 --> 00:12:20.061
So different like users that are connected to our

00:12:20.351 --> 00:12:20.751
client.

00:12:20.751 --> 00:12:21.911
So essentially we're saying there's,

00:12:21.911 --> 00:12:23.671
there's going to be two clients that are connected

00:12:23.671 --> 00:12:24.831
to our durable object.

00:12:28.571 --> 00:12:30.131
and then we're going to go ahead and say we're

00:12:30.131 --> 00:12:31.691
going to trigger this alarm.

00:12:31.691 --> 00:12:33.171
And then when we trigger that alarm,

00:12:33.171 --> 00:12:34.571
some different things should have happened.

00:12:34.571 --> 00:12:34.851
Like

00:12:35.261 --> 00:12:37.501
the get link click should have been called.

00:12:38.101 --> 00:12:40.121
we should have called the send method.

00:12:40.121 --> 00:12:42.601
So we should have basically tried to send some

00:12:42.601 --> 00:12:44.161
data of those link clicks,

00:12:44.521 --> 00:12:44.921
to

00:12:45.721 --> 00:12:46.121
the

00:12:46.421 --> 00:12:47.961
client one and client two.

00:12:47.961 --> 00:12:49.560
They both should have received that information

00:12:50.201 --> 00:12:51.561
and then we should have

00:12:51.881 --> 00:12:53.081
flushed the data.

00:12:53.651 --> 00:12:55.621
and these are like the new offsets that should

00:12:55.621 --> 00:12:56.661
have been called with the flush.

00:12:56.661 --> 00:12:58.901
So we're kind of tracking this like internal logic

00:12:58.901 --> 00:13:01.341
of which data is passed into these,

00:13:01.501 --> 00:13:02.751
into the flush method.

00:13:03.781 --> 00:13:05.661
and then obviously the link click should have been

00:13:05.661 --> 00:13:08.021
called or the delete clicks before this period of

00:13:08.021 --> 00:13:08.781
time should have been called.

00:13:08.781 --> 00:13:10.301
So this is kind of like testing,

00:13:10.301 --> 00:13:10.581
like

00:13:11.461 --> 00:13:13.581
given some type of output from a function,

00:13:13.581 --> 00:13:14.901
when that alarm is triggered,

00:13:14.901 --> 00:13:16.261
all of that cascading logic,

00:13:16.261 --> 00:13:16.821
what is happening?

00:13:16.821 --> 00:13:18.261
So I think this is actually a pretty good test.

00:13:18.261 --> 00:13:19.221
It's very involved.

00:13:19.221 --> 00:13:21.901
But it's also really important because if like

00:13:21.901 --> 00:13:23.741
somebody that you're working with comes in and

00:13:23.741 --> 00:13:26.341
they like change some core logic on this behavior,

00:13:26.501 --> 00:13:27.461
that test will fail.

00:13:27.621 --> 00:13:29.101
And then when that test fails,

00:13:29.101 --> 00:13:29.581
they'll be like,

00:13:29.581 --> 00:13:29.941
oh,

00:13:30.021 --> 00:13:31.021
why did that test fail?

00:13:31.021 --> 00:13:32.341
And they'll go through and they'll look at the

00:13:32.341 --> 00:13:33.701
logic of what should have happened and they'll be

00:13:33.701 --> 00:13:33.821
like,

00:13:33.821 --> 00:13:34.181
oh,

00:13:34.491 --> 00:13:35.651
I actually like change something.

00:13:35.651 --> 00:13:38.251
And then the delete logic is actually not working

00:13:38.251 --> 00:13:40.171
as expected or maybe we're not actually sending

00:13:40.171 --> 00:13:41.531
the right data to like the user.

00:13:41.531 --> 00:13:41.851
So,

00:13:42.091 --> 00:13:43.451
these are like the kind of tests where they're

00:13:43.451 --> 00:13:43.931
really involved,

00:13:43.931 --> 00:13:44.571
but they're also very,

00:13:44.571 --> 00:13:45.371
very useful.

00:13:46.331 --> 00:13:48.051
So that is testing in a nutshell.

00:13:48.051 --> 00:13:49.291
I know this is a very short,

00:13:49.451 --> 00:13:51.071
video for such a broad topic,

00:13:51.071 --> 00:13:51.391
but,

00:13:51.911 --> 00:13:52.311
this,

00:13:52.391 --> 00:13:52.991
all of these,

00:13:52.991 --> 00:13:53.271
like,

00:13:53.271 --> 00:13:55.271
tests in this complete repo is going to be

00:13:55.271 --> 00:13:55.591
available,

00:13:56.261 --> 00:13:56.981
for you guys.

00:13:56.981 --> 00:13:59.701
So you can basically go take a look at all of this

00:13:59.701 --> 00:14:00.021
code,

00:14:00.021 --> 00:14:00.581
and then,

00:14:00.901 --> 00:14:01.621
you can pull it down,

00:14:01.621 --> 00:14:02.861
copy it into your code base,

00:14:02.861 --> 00:14:03.381
and then you can,

00:14:03.381 --> 00:14:03.701
like,

00:14:03.701 --> 00:14:04.821
extend these test cases.

00:14:05.121 --> 00:14:05.681
You really want to,

00:14:05.681 --> 00:14:05.801
like,

00:14:05.801 --> 00:14:06.181
practice,

00:14:06.181 --> 00:14:06.641
testing,

00:14:06.641 --> 00:14:07.441
or if you want to,

00:14:07.441 --> 00:14:07.601
like,

00:14:07.601 --> 00:14:09.241
make changes or kind of make these even better,

00:14:09.241 --> 00:14:10.041
that's totally fine.

00:14:10.041 --> 00:14:10.801
I would just say,

00:14:11.291 --> 00:14:11.811
think about,

00:14:11.811 --> 00:14:12.051
like,

00:14:12.051 --> 00:14:13.131
when you write your code,

00:14:13.211 --> 00:14:15.091
write how you can write your code to make it

00:14:15.091 --> 00:14:15.691
really testable.

00:14:15.691 --> 00:14:16.251
Make it test,

00:14:16.251 --> 00:14:16.571
like,

00:14:16.571 --> 00:14:18.011
be able to test really easily.

00:14:18.011 --> 00:14:20.171
Make sure you don't have tons and tons of,

00:14:20.171 --> 00:14:20.291
like,

00:14:20.291 --> 00:14:22.171
embedded functions inside of embedded functions

00:14:22.171 --> 00:14:23.851
that are doing a whole bunch of stuff where it's

00:14:23.851 --> 00:14:23.931
like,

00:14:23.931 --> 00:14:24.091
oh,

00:14:24.091 --> 00:14:25.051
how do I even test this?

00:14:25.531 --> 00:14:25.631
I,

00:14:25.671 --> 00:14:27.431
do think testing durable objects is hard.

00:14:27.431 --> 00:14:28.071
As you can see,

00:14:28.071 --> 00:14:28.391
this is,

00:14:28.391 --> 00:14:28.591
like,

00:14:28.591 --> 00:14:30.271
a pretty convoluted test case.

00:14:31.681 --> 00:14:32.841
So what you could do is you could see,

00:14:32.841 --> 00:14:33.041
like,

00:14:33.041 --> 00:14:35.121
is there any way that I can refactor our durable

00:14:35.121 --> 00:14:36.721
object to make it a little bit more testable?

00:14:36.721 --> 00:14:37.241
That's kind of like,

00:14:37.241 --> 00:14:39.001
one mindset that you could go into to try to,

00:14:39.001 --> 00:14:39.281
like,

00:14:39.281 --> 00:14:40.481
refine this a little bit.

00:14:41.201 --> 00:14:43.001
But I would definitely use this as a starting

00:14:43.001 --> 00:14:43.281
point.

00:14:43.281 --> 00:14:44.481
So as you build,

00:14:44.761 --> 00:14:46.921
more complicated things on top of Cloudflare,

00:14:47.241 --> 00:14:47.921
you can also,

00:14:47.921 --> 00:14:48.201
like,

00:14:48.201 --> 00:14:49.441
kind of use this as a framework for,

00:14:49.441 --> 00:14:49.641
oh,

00:14:49.641 --> 00:14:51.321
here's my mental model for how I'm going to test

00:14:51.321 --> 00:14:51.641
things.



---

WEBVTT
X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000

00:00:00.082 --> 00:00:00.562
All right,

00:00:00.562 --> 00:00:02.482
so let's talk about some stretch goals.

00:00:02.482 --> 00:00:02.722
Like,

00:00:02.722 --> 00:00:04.842
as I've been building out this project and making

00:00:04.842 --> 00:00:05.482
these videos,

00:00:05.482 --> 00:00:06.362
I've kind of realized,

00:00:06.362 --> 00:00:06.642
like,

00:00:06.642 --> 00:00:08.722
there's a lot of directions that we can go,

00:00:09.362 --> 00:00:09.882
for like,

00:00:09.882 --> 00:00:11.442
features to add and different things that would be

00:00:11.442 --> 00:00:12.002
cool to build,

00:00:12.002 --> 00:00:13.202
but it's just really like,

00:00:13.202 --> 00:00:14.362
just too much for a course.

00:00:14.362 --> 00:00:14.882
And I know,

00:00:14.882 --> 00:00:15.202
like,

00:00:15.522 --> 00:00:18.242
probably 95% of people actually aren't able to

00:00:18.242 --> 00:00:19.402
make it to the very end,

00:00:19.402 --> 00:00:20.322
which is this video.

00:00:20.562 --> 00:00:22.162
So if you've made it this far,

00:00:22.162 --> 00:00:23.602
I think it means that you've gone really,

00:00:23.602 --> 00:00:24.642
really deep in this topic.

00:00:24.642 --> 00:00:24.882
And,

00:00:25.032 --> 00:00:26.552
and if you're interested in like,

00:00:26.552 --> 00:00:27.672
learning more and really like,

00:00:27.672 --> 00:00:29.032
testing your skills to,

00:00:29.642 --> 00:00:30.272
you know,

00:00:30.272 --> 00:00:31.632
be able to do things on your own and not just

00:00:31.632 --> 00:00:31.832
like,

00:00:31.832 --> 00:00:33.192
follow a guide from a video.

00:00:33.642 --> 00:00:35.512
I do have some different stretch goals that I do

00:00:35.512 --> 00:00:37.192
think would be really cool for you to think about

00:00:37.192 --> 00:00:38.312
and then figure out how to build.

00:00:38.312 --> 00:00:39.952
And if you do any of these stretch goals and

00:00:39.952 --> 00:00:41.432
you're impressed with your solution,

00:00:41.572 --> 00:00:43.632
I'd love if you reach out and like,

00:00:43.632 --> 00:00:44.592
kind of share what you did.

00:00:44.592 --> 00:00:45.392
Because I do,

00:00:45.392 --> 00:00:45.672
like,

00:00:45.672 --> 00:00:46.152
I am.

00:00:46.152 --> 00:00:46.992
I want to see like,

00:00:46.992 --> 00:00:49.432
what types of inspiration and  directions people

00:00:49.432 --> 00:00:50.072
take this project

00:00:50.482 --> 00:00:53.042
to kind of like bring it to a full productionized

00:00:53.042 --> 00:00:53.682
completeness.

00:00:53.682 --> 00:00:54.082
So,

00:00:54.642 --> 00:00:55.482
that being said,

00:00:55.482 --> 00:00:57.562
a few different stretch goals that I wanted to

00:00:57.562 --> 00:00:58.362
talk about is like,

00:00:58.362 --> 00:00:59.282
we are right now,

00:00:59.282 --> 00:01:01.402
we have this ability to take payments and we have

00:01:01.402 --> 00:01:02.042
different plans,

00:01:02.042 --> 00:01:03.602
but these plans really don't do anything.

00:01:03.602 --> 00:01:04.162
They're just like,

00:01:04.162 --> 00:01:06.482
here to have credit card on file.

00:01:06.562 --> 00:01:06.962
Now.

00:01:07.152 --> 00:01:09.322
these are just kind of like filler features and

00:01:09.322 --> 00:01:09.722
whatnot.

00:01:09.722 --> 00:01:09.962
So like,

00:01:09.962 --> 00:01:11.602
you could kind of think about what types of

00:01:11.602 --> 00:01:12.962
features would each plan have.

00:01:13.132 --> 00:01:15.362
and then how do I actually wire that into,

00:01:16.112 --> 00:01:16.692
the,

00:01:16.692 --> 00:01:18.572
the actual data service on the back end.

00:01:18.652 --> 00:01:19.012
So,

00:01:19.692 --> 00:01:20.772
one thing that I would.

00:01:20.772 --> 00:01:21.052
One,

00:01:21.052 --> 00:01:22.686
one feature I think would be cool is like,

00:01:22.686 --> 00:01:23.728
adding email to this.

00:01:23.728 --> 00:01:24.288
So like,

00:01:24.448 --> 00:01:27.288
whenever these evaluations go through and a link

00:01:27.288 --> 00:01:29.008
is determined not to be healthy,

00:01:29.008 --> 00:01:31.408
go ahead and like wire up an email provider.

00:01:31.408 --> 00:01:31.528
Like,

00:01:31.528 --> 00:01:32.608
you could use resend.

00:01:34.132 --> 00:01:34.172
This,

00:01:34.172 --> 00:01:36.972
is kind of like a platform to send out emails

00:01:36.972 --> 00:01:37.652
programmatically.

00:01:37.812 --> 00:01:38.212
So,

00:01:38.412 --> 00:01:41.772
you could basically say like every two days or

00:01:41.772 --> 00:01:43.452
whenever we have like a link.

00:01:43.452 --> 00:01:44.392
That's not healthy.

00:01:44.392 --> 00:01:46.712
let's go ahead and give that user an alert so

00:01:46.712 --> 00:01:46.872
like,

00:01:46.872 --> 00:01:48.032
they could go out and switch,

00:01:48.752 --> 00:01:49.952
to swap out that,

00:01:51.552 --> 00:01:51.912
that,

00:01:51.912 --> 00:01:53.472
that link with that for a healthy one.

00:01:53.792 --> 00:01:56.432
you could add like a feature where let's say you

00:01:56.432 --> 00:01:57.112
have a bunch of like,

00:01:57.112 --> 00:01:58.112
links from Amazon,

00:01:58.192 --> 00:02:01.232
you Could plug into Amazon's affiliate API and if

00:02:01.232 --> 00:02:03.952
like a product goes  like

00:02:04.272 --> 00:02:07.152
if a product is basically not available anymore or

00:02:07.392 --> 00:02:09.432
if another product is selling better,

00:02:09.432 --> 00:02:10.032
that's similar.

00:02:10.032 --> 00:02:11.872
Like you could probably plug into their API and

00:02:11.872 --> 00:02:12.512
you could build really,

00:02:12.512 --> 00:02:14.112
really cool features around like hey,

00:02:14.452 --> 00:02:16.602
you are marketing this product.

00:02:16.842 --> 00:02:18.562
You could actually become an affiliate for this

00:02:18.562 --> 00:02:19.402
product which is the same.

00:02:19.402 --> 00:02:20.162
It's a little bit cheaper,

00:02:20.162 --> 00:02:21.242
the shipping times faster.

00:02:21.242 --> 00:02:23.522
Like here's some like suggestions on how you can

00:02:23.522 --> 00:02:24.162
like optimize,

00:02:24.162 --> 00:02:25.882
make more money which would also be very,

00:02:25.882 --> 00:02:26.442
very cool.

00:02:26.838 --> 00:02:29.888
now another thing that I was thinking is like

00:02:29.888 --> 00:02:30.848
custom short links.

00:02:30.848 --> 00:02:34.168
So we kind of have just these like random short

00:02:34.248 --> 00:02:34.648
like

00:02:35.928 --> 00:02:36.224
like

00:02:36.288 --> 00:02:38.018
hashes of just some type of value.

00:02:38.418 --> 00:02:38.818
And

00:02:39.218 --> 00:02:40.818
these really just they don't look good

00:02:41.218 --> 00:02:42.178
when you're,

00:02:42.178 --> 00:02:43.298
when they're like being used.

00:02:43.298 --> 00:02:44.578
So like I would say go ahead.

00:02:45.118 --> 00:02:46.558
The ability for users to

00:02:47.038 --> 00:02:49.958
create their own  link name so like they could

00:02:49.958 --> 00:02:50.798
just call it their product.

00:02:50.798 --> 00:02:53.358
Now that comes with caveats because at scale if

00:02:53.358 --> 00:02:55.398
you're going to be doing this you need to find a

00:02:55.398 --> 00:02:58.038
way to basically when a user types it in quickly

00:02:58.038 --> 00:03:00.358
check if that link has been taken and if it hasn't

00:03:00.358 --> 00:03:00.718
been taken,

00:03:01.998 --> 00:03:04.158
like kind of like reserve it for a period of time

00:03:04.158 --> 00:03:05.958
and then when they save just make sure that that's

00:03:05.958 --> 00:03:07.098
indexed as

00:03:07.598 --> 00:03:08.118
you know,

00:03:08.118 --> 00:03:08.718
already taken.

00:03:08.878 --> 00:03:11.558
So building out like the unique links is another

00:03:11.558 --> 00:03:12.558
really cool one I think.

00:03:13.618 --> 00:03:14.588
custom domains.

00:03:14.588 --> 00:03:18.708
So like instead of stage.smartlink.com like you

00:03:18.708 --> 00:03:21.348
could say like oh we're going to make this a wild

00:03:21.348 --> 00:03:21.788
card.

00:03:21.788 --> 00:03:23.748
And then as a premium feature people could put

00:03:23.748 --> 00:03:24.668
their business here.

00:03:24.748 --> 00:03:27.788
Or better yet you could like point the backend

00:03:27.788 --> 00:03:30.348
service  as like a generic service and have a C

00:03:30.348 --> 00:03:30.588
name.

00:03:30.588 --> 00:03:32.908
A user can point their cname at like

00:03:33.348 --> 00:03:37.148
a random/smartlink.com and that's like their

00:03:37.228 --> 00:03:38.868
reserved backend service.

00:03:38.868 --> 00:03:39.388
And then

00:03:39.878 --> 00:03:41.238
you know they could point a C name at it.

00:03:41.238 --> 00:03:41.358
That,

00:03:41.358 --> 00:03:42.918
that would be another really cool thing to do.

00:03:42.928 --> 00:03:45.598
that kind of like goes down the rabbit hole of

00:03:45.598 --> 00:03:47.718
like multi tenant applications and whatnot.

00:03:48.142 --> 00:03:49.252
now there's a lot around

00:03:49.652 --> 00:03:51.132
smarter evaluation logic.

00:03:51.132 --> 00:03:53.172
But before that I actually thought of another one

00:03:53.172 --> 00:03:54.372
that could be kind of cool.

00:03:54.382 --> 00:03:57.389
so like you're probably noticing in here,

00:04:02.086 --> 00:04:03.886
you're probably noticing in here we don't have the

00:04:03.886 --> 00:04:06.446
ability to delete a link and it's kind of

00:04:06.446 --> 00:04:07.446
intentional because

00:04:07.846 --> 00:04:09.766
there's a lot of like caveats about deleting a

00:04:09.766 --> 00:04:10.046
link.

00:04:10.046 --> 00:04:12.326
Like what if you delete a link and

00:04:12.936 --> 00:04:14.246
it's a random like

00:04:14.886 --> 00:04:17.356
hash or maybe it's a user provided like

00:04:17.606 --> 00:04:18.086
link

00:04:18.486 --> 00:04:18.886
and

00:04:19.206 --> 00:04:21.046
there's like those short links still sitting out

00:04:21.046 --> 00:04:22.446
there on the Internet and people are clicking on

00:04:22.446 --> 00:04:22.606
them.

00:04:22.606 --> 00:04:24.406
And now let's just go into an offend page.

00:04:24.806 --> 00:04:26.726
that's another thing where it's like well what do

00:04:26.726 --> 00:04:27.166
we do?

00:04:27.166 --> 00:04:27.606
You know,

00:04:27.606 --> 00:04:28.246
like what,

00:04:29.046 --> 00:04:30.046
like how do you handle that?

00:04:30.046 --> 00:04:31.686
So having business logic around like

00:04:32.056 --> 00:04:34.776
maybe building out a feature where like all of

00:04:34.776 --> 00:04:35.096
the,

00:04:36.136 --> 00:04:37.656
all like if you delete a link,

00:04:37.816 --> 00:04:40.216
maybe having like a link category to like a

00:04:40.216 --> 00:04:41.936
category of products and then you could have like

00:04:41.936 --> 00:04:44.256
a generic landing page that a user can configure

00:04:44.256 --> 00:04:46.256
where they have like links to like similar

00:04:46.256 --> 00:04:47.775
products or products in that category.

00:04:47.775 --> 00:04:48.776
So if it's not found,

00:04:48.936 --> 00:04:51.776
it goes to that user's not found page which is

00:04:51.776 --> 00:04:52.856
very specific to them.

00:04:52.856 --> 00:04:55.176
Because right now our not found page is just like,

00:04:56.076 --> 00:04:56.876
like if we just

00:04:57.236 --> 00:04:59.036
basically do the incorrect link here are not found

00:04:59.036 --> 00:05:00.356
pages just like destination not found.

00:05:00.356 --> 00:05:00.636
Right.

00:05:00.636 --> 00:05:02.356
But maybe that not found page could be very

00:05:02.356 --> 00:05:05.076
specific to  like a user if,

00:05:05.476 --> 00:05:07.076
if like they delete

00:05:07.476 --> 00:05:08.116
a link.

00:05:08.116 --> 00:05:10.036
So instead of just removing it entirely from the

00:05:10.036 --> 00:05:10.476
database,

00:05:10.476 --> 00:05:12.036
maybe there's a lot of like smart things you can

00:05:12.036 --> 00:05:12.676
build around that.

00:05:12.676 --> 00:05:14.506
So that's like one direction to go.

00:05:14.506 --> 00:05:17.196
for these like additional  for additional

00:05:17.196 --> 00:05:18.516
features for a stretch goal.

00:05:19.956 --> 00:05:22.476
now there's a ton around smarter evaluation logic.

00:05:22.476 --> 00:05:24.196
So if we look at our data service

00:05:25.246 --> 00:05:27.726
and we look at our  destination track tracker,

00:05:27.726 --> 00:05:29.726
like we're really just you know,

00:05:29.726 --> 00:05:31.606
having a few hard coded statuses in here,

00:05:31.606 --> 00:05:31.886
available,

00:05:32.046 --> 00:05:32.766
unavailable,

00:05:32.766 --> 00:05:35.006
unknown status and whatnot right now.

00:05:35.726 --> 00:05:36.486
that's kind of like,

00:05:36.486 --> 00:05:37.686
it makes sense for E commerce.

00:05:37.686 --> 00:05:40.166
But there's like blog posts that like maybe are

00:05:40.166 --> 00:05:40.686
outdated.

00:05:41.726 --> 00:05:43.006
there's stuff around like

00:05:43.326 --> 00:05:44.886
looking at the status of the request,

00:05:44.886 --> 00:05:47.726
if it's a 404 or 401 or whatever before like

00:05:47.726 --> 00:05:49.006
running the AI check,

00:05:49.486 --> 00:05:50.846
there's a lot that we can do here.

00:05:50.846 --> 00:05:53.206
So like I would say like maybe you want to niche

00:05:53.206 --> 00:05:55.446
this product down for a very specific industry.

00:05:55.446 --> 00:05:56.436
Maybe it's just E Commerc

00:05:56.906 --> 00:05:58.026
or maybe you know,

00:05:58.026 --> 00:05:59.986
it's like affiliate tracking or something.

00:05:59.986 --> 00:06:02.746
And I'm having a smarter evaluation engine where

00:06:02.746 --> 00:06:05.786
like you really test what you can do with AI and

00:06:05.786 --> 00:06:08.066
have different agents that like can perform tasks

00:06:08.066 --> 00:06:10.586
to  kind of expand upon this.

00:06:10.586 --> 00:06:12.066
And I do think in the future I'm going to be

00:06:12.066 --> 00:06:14.106
making videos to kind of like enhance this,

00:06:14.106 --> 00:06:14.966
this concept,

00:06:15.546 --> 00:06:16.906
with agents and whatnot.

00:06:16.906 --> 00:06:17.306
So

00:06:17.566 --> 00:06:19.586
I think this is a really interesting area to

00:06:19.586 --> 00:06:19.986
think about.

00:06:19.986 --> 00:06:21.706
And then the Other one would be smarter

00:06:21.706 --> 00:06:22.226
scheduling.

00:06:22.226 --> 00:06:23.706
Because right now we're just kind of like,

00:06:23.706 --> 00:06:24.026
looking,

00:06:24.626 --> 00:06:27.416
we get a link click and then in a few days we

00:06:27.416 --> 00:06:29.016
kind of like buffer all those link clicks and we

00:06:29.016 --> 00:06:30.056
do the evaluation once.

00:06:30.056 --> 00:06:32.976
But maybe you have smarter logic where if a link

00:06:33.216 --> 00:06:33.616
is,

00:06:33.616 --> 00:06:34.496
hasn't been clicked,

00:06:34.496 --> 00:06:35.936
so maybe you keep track of like,

00:06:36.096 --> 00:06:36.576
you know,

00:06:36.576 --> 00:06:37.896
all of the link clicks and like,

00:06:37.896 --> 00:06:39.856
let's say a link hasn't been clicked in

00:06:40.256 --> 00:06:43.256
14 days or five months or whatever it may be,

00:06:43.256 --> 00:06:44.496
and then it was clicked.

00:06:44.656 --> 00:06:44.976
Well,

00:06:44.976 --> 00:06:46.896
what if you go run that evaluation right away,

00:06:47.166 --> 00:06:48.176
to see if it's healthy?

00:06:48.176 --> 00:06:50.176
Or maybe if you get like a burst of,

00:06:51.506 --> 00:06:52.226
a burst of like,

00:06:52.226 --> 00:06:54.386
link clicks for a given link that haven't been

00:06:54.386 --> 00:06:55.106
clicked in a while.

00:06:55.106 --> 00:06:57.786
So maybe like somebody posted a YouTube video a

00:06:57.786 --> 00:06:59.546
year ago on a product and they had that link in

00:06:59.546 --> 00:06:59.786
there,

00:06:59.786 --> 00:07:00.586
and then all of a sudden,

00:07:00.586 --> 00:07:02.026
for some reason the algorithm is pushing that

00:07:02.026 --> 00:07:04.186
video and then hundreds of people are watching the

00:07:04.186 --> 00:07:04.386
video.

00:07:04.386 --> 00:07:05.986
You're getting dozens of link clicks or hundreds

00:07:05.986 --> 00:07:07.506
of link clicks or thousands of link clicks.

00:07:07.506 --> 00:07:07.626
Like,

00:07:07.626 --> 00:07:09.826
maybe you could detect spikes in these link clicks

00:07:09.826 --> 00:07:10.546
on the back end,

00:07:10.866 --> 00:07:13.026
as like a separate type of workflow or separate

00:07:13.026 --> 00:07:13.626
type of like,

00:07:13.626 --> 00:07:14.866
durable object maybe.

00:07:15.026 --> 00:07:15.586
And then,

00:07:15.986 --> 00:07:17.226
if it kind of triggers like,

00:07:17.226 --> 00:07:17.426
hey,

00:07:17.426 --> 00:07:18.186
this is an anomaly,

00:07:18.186 --> 00:07:19.186
we're getting a lot of traffic here,

00:07:19.186 --> 00:07:21.106
maybe we go ahead and run that evaluation just to

00:07:21.106 --> 00:07:21.386
make sure,

00:07:21.386 --> 00:07:21.626
hey,

00:07:21.626 --> 00:07:21.906
like,

00:07:22.206 --> 00:07:23.016
this is healthy.

00:07:23.016 --> 00:07:24.136
And then maybe along with that,

00:07:24.136 --> 00:07:26.256
if you're getting like a spike in these events,

00:07:26.256 --> 00:07:26.776
maybe like,

00:07:26.776 --> 00:07:27.576
you give them alert,

00:07:27.576 --> 00:07:27.736
like,

00:07:27.736 --> 00:07:28.096
hey,

00:07:28.096 --> 00:07:28.496
this,

00:07:28.576 --> 00:07:28.946
this,

00:07:29.279 --> 00:07:31.759
this link is receiving like an abnormally large

00:07:31.759 --> 00:07:32.559
number of clicks.

00:07:32.559 --> 00:07:33.519
Something must be going on.

00:07:33.519 --> 00:07:33.839
Like,

00:07:33.839 --> 00:07:35.639
you can go ahead and take a look and make sure you

00:07:35.639 --> 00:07:37.239
want to see if you want to update those links or

00:07:37.239 --> 00:07:37.638
whatnot.

00:07:37.638 --> 00:07:39.119
So there's a lot that you could do around

00:07:39.119 --> 00:07:39.639
scheduling.

00:07:39.639 --> 00:07:39.799
So,

00:07:39.799 --> 00:07:39.959
like,

00:07:39.959 --> 00:07:40.279
I would say,

00:07:40.279 --> 00:07:40.479
like,

00:07:40.479 --> 00:07:41.039
think really hard.

00:07:41.039 --> 00:07:41.239
Like,

00:07:41.239 --> 00:07:42.999
what features would you want to see in this and

00:07:42.999 --> 00:07:44.479
see if you can go ahead and build them out.

00:07:44.559 --> 00:07:45.759
It's really up to you and like,

00:07:45.759 --> 00:07:46.639
what you can imagine,

00:07:46.779 --> 00:07:47.919
this product to be.

00:07:47.999 --> 00:07:49.999
And the other thing would be like the evaluation

00:07:49.999 --> 00:07:50.559
ui.

00:07:50.559 --> 00:07:51.039
So like,

00:07:51.039 --> 00:07:51.839
I would say

00:07:52.199 --> 00:07:52.879
you could create another,

00:07:52.879 --> 00:07:53.159
like,

00:07:53.159 --> 00:07:53.959
totally separate service,

00:07:54.039 --> 00:07:55.239
whatever framework you want,

00:07:55.479 --> 00:07:57.839
as practice of like rolling something totally

00:07:57.839 --> 00:07:58.359
from scratch,

00:07:58.359 --> 00:08:01.159
whether it be next JS or nuxt or spelled or,

00:08:01.239 --> 00:08:01.599
you know,

00:08:01.599 --> 00:08:03.279
just basic react or tanstack start,

00:08:03.279 --> 00:08:03.639
right?

00:08:03.959 --> 00:08:04.359
And,

00:08:04.519 --> 00:08:07.439
you could just kind of have like a admin type of

00:08:07.439 --> 00:08:10.279
UI where maybe you see all your users and whatnot,

00:08:10.279 --> 00:08:12.519
and you kind of see holistically different like

00:08:12.519 --> 00:08:14.839
accounts that are like getting a lot of traffic.

00:08:15.319 --> 00:08:16.879
and then one thing that you could do is you could

00:08:16.879 --> 00:08:18.679
have an entire section dedicated to

00:08:19.559 --> 00:08:20.839
like workflow evaluation.

00:08:20.999 --> 00:08:22.919
So you could holistically see all of the links

00:08:22.919 --> 00:08:23.799
that are being clicked

00:08:24.099 --> 00:08:25.339
and you could see the output.

00:08:25.339 --> 00:08:27.219
So like here if we go to our two

00:08:27.629 --> 00:08:28.104
bucket

00:08:28.423 --> 00:08:29.103
essentially,

00:08:29.103 --> 00:08:29.463
like,

00:08:29.853 --> 00:08:31.063
we're saving some data.

00:08:31.063 --> 00:08:33.263
Like we're saving like the body text and the HTML,

00:08:33.263 --> 00:08:35.023
but we also have these screenshots and like,

00:08:35.023 --> 00:08:36.743
these screenshots are going to show like

00:08:37.153 --> 00:08:38.543
the actual like rendered page,

00:08:38.543 --> 00:08:38.823
right?

00:08:38.823 --> 00:08:39.262
So like,

00:08:39.262 --> 00:08:40.023
maybe you could build

00:08:40.393 --> 00:08:43.223
some more workflows at an admin level to like

00:08:43.223 --> 00:08:44.543
evaluate our,

00:08:44.543 --> 00:08:44.823
our,

00:08:44.823 --> 00:08:45.303
predict

00:08:46.103 --> 00:08:48.343
our AI predictions actually doing well.

00:08:48.343 --> 00:08:49.943
And maybe you can create some type of scoring

00:08:49.943 --> 00:08:52.223
system on the back end so there's like a whole,

00:08:52.223 --> 00:08:53.863
the whole direction you can go with like

00:08:54.243 --> 00:08:55.603
admin types of operations.

00:08:55.603 --> 00:08:57.803
So I do think that this is like a pretty cool

00:08:57.803 --> 00:08:59.483
product and it's honestly something that

00:08:59.483 --> 00:09:01.523
realistically probably could be a real product.

00:09:02.083 --> 00:09:02.803
So yeah,

00:09:02.803 --> 00:09:03.523
if you're interested,

00:09:03.523 --> 00:09:04.723
I would say go ahead and like,

00:09:04.723 --> 00:09:05.563
try to extend this,

00:09:05.563 --> 00:09:07.683
this project like as far as you can go.

00:09:07.983 --> 00:09:09.683
get the reps in by doing things yourself,

00:09:09.683 --> 00:09:11.123
not just following this tutorial.

00:09:11.203 --> 00:09:12.043
Use this like,

00:09:12.043 --> 00:09:13.803
project as a framework that you add on to.

00:09:13.803 --> 00:09:14.883
Because I do think that's the best way of

00:09:14.883 --> 00:09:15.123
learning.

00:09:15.123 --> 00:09:15.323
Like,

00:09:15.323 --> 00:09:17.243
instead of spending all this time starting from

00:09:17.243 --> 00:09:17.683
scratch,

00:09:17.923 --> 00:09:19.443
getting to the point where you have something

00:09:19.443 --> 00:09:20.803
that's like working and a system,

00:09:21.123 --> 00:09:22.923
take this existing system that we've built

00:09:22.923 --> 00:09:24.803
together and extend it and try to like,

00:09:24.803 --> 00:09:26.823
figure out all these different features that you

00:09:26.823 --> 00:09:28.583
want and add those features.

00:09:28.583 --> 00:09:30.183
And as you add those features from scratch,

00:09:30.183 --> 00:09:31.103
you'll start learning like,

00:09:31.103 --> 00:09:31.383
oh,

00:09:31.383 --> 00:09:32.143
how would we do it?

00:09:32.143 --> 00:09:32.663
Or like,

00:09:32.663 --> 00:09:33.783
is this the best way of doing it?

00:09:33.783 --> 00:09:34.063
Or,

00:09:34.063 --> 00:09:34.383
you know,

00:09:34.383 --> 00:09:36.103
it'd be cool if I tried to use like durable

00:09:36.103 --> 00:09:37.263
objects for this type of use case,

00:09:37.263 --> 00:09:37.503
right?

00:09:37.503 --> 00:09:38.623
And you'll learn really,

00:09:38.623 --> 00:09:40.143
really quickly by doing it that way.

00:09:40.183 --> 00:09:41.543
and then just like reach out.

00:09:41.543 --> 00:09:42.423
If you build anything.

00:09:42.423 --> 00:09:42.663
Cool,

00:09:42.663 --> 00:09:43.143
let me know.

00:09:43.143 --> 00:09:45.263
I'd love to talk about it or like look into it or

00:09:45.263 --> 00:09:46.863
if you have like any like core questions,

00:09:46.863 --> 00:09:48.743
feel free to reach out because I think that this

00:09:48.743 --> 00:09:50.863
is like a really cool project to build upon.

00:09:51.183 --> 00:09:52.743
that's going to wrap it up for the course.

00:09:52.743 --> 00:09:53.183
I really,

00:09:53.183 --> 00:09:54.783
really hope you guys enjoyed,

00:09:55.703 --> 00:09:57.703
enjoyed this and you got a lot out of it.

00:09:57.783 --> 00:09:59.783
I worked really hard on putting this together and

00:09:59.783 --> 00:10:01.343
it was kind of hard to think of an idea where I

00:10:01.343 --> 00:10:03.623
could like touch on all of like the really core

00:10:03.623 --> 00:10:04.823
primitives within Cloudflare,

00:10:05.063 --> 00:10:06.383
be able to teach like,

00:10:06.383 --> 00:10:08.263
all of the semantics and the different like,

00:10:08.263 --> 00:10:10.263
ways of using and building upon Cloudflare,

00:10:10.263 --> 00:10:10.983
but also like,

00:10:11.382 --> 00:10:11.783
use,

00:10:12.323 --> 00:10:14.463
build like a real world use case.

00:10:14.463 --> 00:10:15.583
And I think this kind of like,

00:10:15.583 --> 00:10:16.783
checked all those boxes.

00:10:16.783 --> 00:10:17.103
So,

00:10:17.103 --> 00:10:17.423
yeah,

00:10:17.423 --> 00:10:18.423
I'd love your feedback.

00:10:18.483 --> 00:10:19.663
whether it's good or bad,

00:10:19.663 --> 00:10:20.543
and if there's any like,

00:10:20.543 --> 00:10:21.263
issues or whatnot,

00:10:21.263 --> 00:10:22.423
I'm definitely down to like,

00:10:22.423 --> 00:10:22.743
change,

00:10:22.923 --> 00:10:23.803
change videos,

00:10:23.803 --> 00:10:25.043
add content and whatnot.

00:10:25.043 --> 00:10:26.403
So have a good one.



---

