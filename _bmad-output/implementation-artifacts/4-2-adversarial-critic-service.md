# Story 4.2: Adversarial Critic Service

**Status:** done
**Story Points:** 8
**Sprint:** 3
**Epic:** 4 - Spoke Generation & Quality Assurance

## Story

As a **user**,
I want **an AI Critic to evaluate every spoke before I see it**,
So that **only quality content reaches my review queue**.

## Acceptance Criteria

### AC1: Automatic Critic Evaluation After Generation
**Given** a spoke is generated by the Creator Agent (Story 4.1)
**When** the spoke is saved to the database
**Then** the Critic Agent automatically evaluates it
**And** all three quality gates (G2, G4, G5) are applied
**And** scores/results are stored in `spoke_evaluations` table

### AC2: G2 Hook Strength Scoring
**Given** a spoke is being evaluated
**When** the Critic applies G2 (Hook Strength) gate
**Then** a score 0-100 is calculated based on:
- Pattern Interrupt (0-40 points): Does it stop the scroll?
- Benefit Signal (0-30 points): Is the value clear?
- Curiosity Gap (0-30 points): Does it create tension?
**And** the breakdown is stored in `g2_breakdown` JSON field
**And** spokes with G2 < 80 are flagged for improvement

### AC3: G4 Voice Alignment Gate
**Given** a spoke is being evaluated
**When** the Critic applies G4 (Voice Alignment) gate
**Then** the following checks are performed:
- Banned words detection (from `banned_words` table)
- Voice marker presence (from `voice_markers` table)
- Cosine similarity against Brand DNA embeddings (threshold: 0.75)
**And** result is Pass/Fail
**And** violations are stored with specific details

### AC4: G5 Platform Compliance Gate
**Given** a spoke is being evaluated
**When** the Critic applies G5 (Platform Compliance) gate
**Then** the following checks are performed:
- Character limit validation per platform
- Format validation (hashtags, mentions, structure)
- Platform-specific rules (Twitter thread continuity, carousel slide count)
**And** result is Pass/Fail
**And** violations include specific character counts/rule violations

### AC5: Spoke Status Update Based on Gates
**Given** a spoke has been evaluated
**When** all gates have results
**Then** status is updated based on results:
- All gates pass (G2 ≥ 80, G4 = Pass, G5 = Pass) → `ready_for_review`
- Any gate fails → `pending_healing` (Story 4.3 handles)
**And** the spoke appears in appropriate dashboard bucket

### AC6: "Why" Hover for Gate Scores (UX Pattern 2)
**Given** I am viewing a spoke in the Hub detail page or Review Queue
**When** I hover over a quality gate badge (G2/G4/G5)
**Then** I see a tooltip within 300ms showing:
- For G2: Score breakdown (Pattern Interrupt, Benefit, Curiosity Gap)
- For G4: Violation details (banned word, similarity score)
- For G5: Compliance failure details (character count, format issue)

### AC7: Feedback Log Storage
**Given** a spoke fails one or more gates
**When** the evaluation completes
**Then** detailed feedback is written to `feedback_log` table:
- `spoke_id`, `gate_type`, `score`, `violations`, `suggestions`
**And** this feedback is available for Self-Healing Loop (Story 4.3)

## Tasks / Subtasks

- [x] **Task 1: Database Schema** (AC: #1, #7)
  - [x] Create migration `0011_spoke_evaluations.sql` with evaluation tables
  - [x] Create `spoke_evaluations` table (id, spoke_id, g2_score, g2_breakdown, g4_result, g4_violations, g5_result, g5_violations, evaluated_at)
  - [x] Create `feedback_log` table (id, spoke_id, client_id, gate_type, score, violations_json, suggestions, created_at)
  - [x] Add indexes for client_id filtering (Rule 1)
  - [x] Apply migrations to local, stage, production D1

- [x] **Task 2: Critic Agent Core** (AC: #1)
  - [x] Create `packages/agent-system/src/critic/` directory structure
  - [x] Implement `CriticAgent` class with `evaluate(spoke)` method
  - [x] Create evaluation pipeline that runs all gates sequentially
  - [x] Implement feedback generation for failed gates
  - [x] Add Workers AI integration for LLM-based evaluation

- [x] **Task 3: G2 Hook Strength Gate** (AC: #2)
  - [x] Create `g2-hook-strength.ts` in `packages/agent-system/src/critic/gates/`
  - [x] Implement Pattern Interrupt scoring (0-40 points)
  - [x] Implement Benefit Signal scoring (0-30 points)
  - [x] Implement Curiosity Gap scoring (0-30 points)
  - [x] Create prompt template for LLM scoring
  - [x] Return structured breakdown JSON

- [x] **Task 4: G4 Voice Alignment Gate** (AC: #3)
  - [x] Create `g4-voice-alignment.ts` in gates directory
  - [x] Implement banned word detection (query `banned_words` table)
  - [x] Implement voice marker check (query `voice_markers` table)
  - [x] Implement cosine similarity with Vectorize (threshold: 0.75)
  - [x] Return Pass/Fail with violation details

- [x] **Task 5: G5 Platform Compliance Gate** (AC: #4)
  - [x] Create `g5-platform-compliance.ts` in gates directory
  - [x] Implement character limit validation per platform type
  - [x] Implement format validation (hashtag patterns, mention rules)
  - [x] Implement platform-specific structure checks
  - [x] Return Pass/Fail with specific violations

- [x] **Task 6: tRPC Router Integration** (AC: #1, #5, #7)
  - [x] Create `spokes.evaluate` procedure to trigger evaluation
  - [x] Create `spokes.getEvaluation` query to fetch scores
  - [x] Update `spokes.generate` to trigger evaluation after creation
  - [x] Implement status transitions based on gate results
  - [x] Ensure client_id filtering on all queries (Rule 1)

- [x] **Task 7: Frontend - Gate Badges** (AC: #5, #6)
  - [x] Create `GateBadge.tsx` component with score/status display
  - [x] Implement color coding (green ≥80, yellow 60-80, red <60)
  - [x] Add hover tooltip with Radix UI Tooltip primitive
  - [x] Show breakdown details in tooltip content
  - [x] Apply Midnight Command styling

- [x] **Task 8: Frontend - Evaluation Display** (AC: #6)
  - [x] Update Hub detail page to show gate badges on spokes
  - [x] Create `SpokeCard.tsx` component with evaluation summary
  - [x] Implement "Why" hover with 300ms delay
  - [x] Show appropriate status indicators (pending, ready, failed)

- [ ] **Task 9: E2E Tests** (AC: All)
  - [ ] Test automatic evaluation after spoke generation
  - [ ] Test G2 scoring with various hook qualities
  - [ ] Test G4 pass/fail scenarios (banned words, similarity)
  - [ ] Test G5 platform compliance validation
  - [ ] Test status transitions based on gate results
  - [ ] Test "Why" hover tooltip display

## Dev Notes

### Dependencies

**Prerequisites (Story 4.1 Complete):**
- Spoke generation working
- `spokes` table exists with content
- Client isolation established
- Creator Agent implemented

**Brand DNA Dependencies (Epic 2 Complete):**
- `banned_words` table populated
- `voice_markers` table populated
- Brand DNA embeddings in Vectorize

### Database Schema

```sql
-- Migration: 0011_spoke_evaluations.sql

-- Store evaluation results for each spoke
CREATE TABLE spoke_evaluations (
  id TEXT PRIMARY KEY,
  spoke_id TEXT NOT NULL UNIQUE,
  client_id TEXT NOT NULL,

  -- G2: Hook Strength (0-100)
  g2_score INTEGER,
  g2_breakdown TEXT,  -- JSON: {pattern_interrupt, benefit, curiosity_gap}

  -- G4: Voice Alignment (Pass/Fail)
  g4_result TEXT CHECK (g4_result IN ('pass', 'fail')),
  g4_violations TEXT,  -- JSON array of violations
  g4_similarity_score REAL,  -- Cosine similarity value

  -- G5: Platform Compliance (Pass/Fail)
  g5_result TEXT CHECK (g5_result IN ('pass', 'fail')),
  g5_violations TEXT,  -- JSON array of violations

  -- Overall
  overall_pass INTEGER DEFAULT 0,  -- 1 if all gates pass
  evaluated_at INTEGER DEFAULT (unixepoch()),

  FOREIGN KEY (spoke_id) REFERENCES spokes(id) ON DELETE CASCADE
);

CREATE INDEX idx_spoke_evaluations_spoke ON spoke_evaluations(spoke_id);
CREATE INDEX idx_spoke_evaluations_client ON spoke_evaluations(client_id);
CREATE INDEX idx_spoke_evaluations_pass ON spoke_evaluations(overall_pass);

-- Store detailed feedback for Self-Healing Loop (Story 4.3)
CREATE TABLE feedback_log (
  id TEXT PRIMARY KEY,
  spoke_id TEXT NOT NULL,
  client_id TEXT NOT NULL,
  gate_type TEXT NOT NULL,  -- 'g2', 'g4', 'g5'
  score INTEGER,  -- For G2
  result TEXT,  -- 'pass'/'fail' for G4/G5
  violations_json TEXT,  -- Detailed violations
  suggestions TEXT,  -- AI-generated improvement suggestions
  healing_attempt INTEGER DEFAULT 0,
  created_at INTEGER DEFAULT (unixepoch()),

  FOREIGN KEY (spoke_id) REFERENCES spokes(id) ON DELETE CASCADE
);

CREATE INDEX idx_feedback_log_spoke ON feedback_log(spoke_id);
CREATE INDEX idx_feedback_log_client ON feedback_log(client_id);
CREATE INDEX idx_feedback_log_gate ON feedback_log(gate_type);
```

### Quality Gate Specifications

**G2: Hook Strength (0-100)**
```typescript
interface G2Result {
  score: number;  // 0-100
  breakdown: {
    patternInterrupt: number;  // 0-40
    benefitSignal: number;     // 0-30
    curiosityGap: number;      // 0-30
  };
  notes: string;  // Critic's explanation
}

// Threshold: ≥ 80 to pass
const G2_THRESHOLD = 80;
```

**G4: Voice Alignment (Pass/Fail)**
```typescript
interface G4Result {
  result: 'pass' | 'fail';
  bannedWordsFound: string[];
  voiceMarkersPresent: string[];
  voiceMarkersMissing: string[];
  cosineSimilarity: number;  // 0-1
  violations: string[];
}

// Thresholds
const G4_SIMILARITY_THRESHOLD = 0.75;
const G4_MIN_VOICE_MARKERS = 0;  // Markers are optional but boost score
```

**G5: Platform Compliance (Pass/Fail)**
```typescript
interface G5Result {
  result: 'pass' | 'fail';
  platform: string;
  violations: {
    type: 'char_limit' | 'format' | 'structure';
    message: string;
    actual?: number;
    expected?: number;
  }[];
}

const PLATFORM_RULES = {
  twitter: { maxChars: 280, hashtagLimit: 3 },
  linkedin: { maxChars: 3000, paragraphBreaks: true },
  tiktok: { maxWords: 150, scriptFormat: true },
  instagram: { maxChars: 2200, emojiAllowed: true },
  newsletter: { maxWords: 500, sectionsRequired: false },
  thread: { minPosts: 5, maxPosts: 7, hookRequired: true },
  carousel: { minSlides: 5, maxSlides: 8, slideMaxChars: 200 },
};
```

### Critic Agent Architecture

```typescript
// packages/agent-system/src/critic/CriticAgent.ts

export class CriticAgent {
  constructor(
    private ai: Ai,  // Workers AI
    private vectorize: VectorizeIndex,  // For cosine similarity
    private db: D1Database  // For banned_words, voice_markers
  ) {}

  async evaluate(spoke: Spoke, clientId: string): Promise<EvaluationResult> {
    // Run all gates
    const [g2, g4, g5] = await Promise.all([
      this.evaluateG2(spoke),
      this.evaluateG4(spoke, clientId),
      this.evaluateG5(spoke),
    ]);

    // Determine overall pass
    const overallPass = g2.score >= G2_THRESHOLD
      && g4.result === 'pass'
      && g5.result === 'pass';

    // Generate feedback for failures
    const feedback = await this.generateFeedback(spoke, { g2, g4, g5 });

    return {
      spokeId: spoke.id,
      g2,
      g4,
      g5,
      overallPass,
      feedback,
    };
  }

  private async evaluateG2(spoke: Spoke): Promise<G2Result> {
    // Use Workers AI to score hook strength
    const prompt = this.buildG2Prompt(spoke);
    const response = await this.ai.run('@cf/meta/llama-3.1-8b-instruct', {
      messages: [{ role: 'user', content: prompt }],
    });
    return this.parseG2Response(response);
  }

  private async evaluateG4(spoke: Spoke, clientId: string): Promise<G4Result> {
    // Check banned words
    const bannedWords = await this.getBannedWords(clientId);
    const bannedWordsFound = this.findBannedWords(spoke.content, bannedWords);

    // Check voice markers
    const voiceMarkers = await this.getVoiceMarkers(clientId);
    const markersAnalysis = this.analyzeVoiceMarkers(spoke.content, voiceMarkers);

    // Cosine similarity with Brand DNA
    const similarity = await this.computeSimilarity(spoke.content, clientId);

    const violations: string[] = [];
    if (bannedWordsFound.length > 0) {
      violations.push(`Banned words detected: ${bannedWordsFound.join(', ')}`);
    }
    if (similarity < G4_SIMILARITY_THRESHOLD) {
      violations.push(`Voice similarity ${similarity.toFixed(2)} below threshold ${G4_SIMILARITY_THRESHOLD}`);
    }

    return {
      result: violations.length === 0 ? 'pass' : 'fail',
      bannedWordsFound,
      voiceMarkersPresent: markersAnalysis.present,
      voiceMarkersMissing: markersAnalysis.missing,
      cosineSimilarity: similarity,
      violations,
    };
  }

  private async evaluateG5(spoke: Spoke): Promise<G5Result> {
    const rules = PLATFORM_RULES[spoke.platform];
    const violations: G5Violation[] = [];

    // Character/word limit check
    if (rules.maxChars && spoke.content.length > rules.maxChars) {
      violations.push({
        type: 'char_limit',
        message: `Exceeds ${rules.maxChars} character limit`,
        actual: spoke.content.length,
        expected: rules.maxChars,
      });
    }

    // Platform-specific format checks
    // ... additional validation logic

    return {
      result: violations.length === 0 ? 'pass' : 'fail',
      platform: spoke.platform,
      violations,
    };
  }
}
```

### G2 Prompt Template

```typescript
const G2_PROMPT = `You are a Content Quality Critic evaluating hook strength.

Rate this ${platform} content on three dimensions:

CONTENT:
"""
${content}
"""

Score each dimension (use ONLY integers):
1. PATTERN INTERRUPT (0-40): Does this stop the scroll? Is it unexpected?
2. BENEFIT SIGNAL (0-30): Is the value proposition clear?
3. CURIOSITY GAP (0-30): Does it create tension that demands resolution?

Respond in JSON format ONLY:
{
  "patternInterrupt": <0-40>,
  "benefitSignal": <0-30>,
  "curiosityGap": <0-30>,
  "notes": "<brief explanation of scoring>"
}`;
```

### UI/UX Specifications

**Gate Badge Component:**
```typescript
interface GateBadgeProps {
  gate: 'G2' | 'G4' | 'G5';
  score?: number;  // G2 only
  result?: 'pass' | 'fail';  // G4, G5
  breakdown?: Record<string, unknown>;
}

// Color coding
const badgeColors = {
  G2: {
    high: 'bg-[#00D26A]/20 text-[#00D26A]',    // ≥80
    medium: 'bg-[#FFAD1F]/20 text-[#FFAD1F]',  // 60-80
    low: 'bg-[#F4212E]/20 text-[#F4212E]',     // <60
  },
  G4: {
    pass: 'bg-[#00D26A]/20 text-[#00D26A]',
    fail: 'bg-[#F4212E]/20 text-[#F4212E]',
  },
  G5: {
    pass: 'bg-[#00D26A]/20 text-[#00D26A]',
    fail: 'bg-[#F4212E]/20 text-[#F4212E]',
  },
};
```

**Tooltip Content:**
```typescript
// G2 Tooltip
<div className="p-3 max-w-[280px]">
  <div className="text-[#E7E9EA] font-medium mb-2">Hook Strength: {score}/100</div>
  <div className="space-y-1 text-sm text-[#71767B]">
    <div>Pattern Interrupt: {breakdown.patternInterrupt}/40</div>
    <div>Benefit Signal: {breakdown.benefitSignal}/30</div>
    <div>Curiosity Gap: {breakdown.curiosityGap}/30</div>
  </div>
  <div className="mt-2 text-xs text-[#71767B]">{notes}</div>
</div>

// G4 Tooltip
<div className="p-3 max-w-[280px]">
  <div className="text-[#E7E9EA] font-medium mb-2">Voice Alignment: {result}</div>
  {violations.map(v => (
    <div className="text-sm text-[#F4212E]">{v}</div>
  ))}
  <div className="mt-2 text-xs text-[#71767B]">
    Similarity: {(cosineSimilarity * 100).toFixed(0)}%
  </div>
</div>
```

### Architecture Patterns

**Client Isolation (Rule 1):**
```typescript
// All queries MUST include client_id
const evaluation = await db
  .selectFrom('spoke_evaluations')
  .where('client_id', '=', ctx.clientId)
  .where('spoke_id', '=', spokeId)
  .selectAll()
  .first();
```

**Adversarial Logic (Rule 4):**
```typescript
// This story implements the CRITIC side of Creator vs. Critic
// Creator (Story 4.1) → Critic (Story 4.2) → Self-Healing (Story 4.3)

async function evaluateSpoke(spoke: Spoke): Promise<EvaluationResult> {
  const critic = new CriticAgent(env.AI, env.VECTORIZE, env.DB);
  const result = await critic.evaluate(spoke, spoke.clientId);

  // Update spoke status based on evaluation
  const newStatus = result.overallPass ? 'ready_for_review' : 'pending_healing';
  await updateSpokeStatus(spoke.id, newStatus);

  // Store feedback for Self-Healing Loop (Story 4.3)
  if (!result.overallPass) {
    await storeFeedback(spoke.id, result.feedback);
  }

  return result;
}
```

### References

**Technical:**
- [Source: _bmad-output/architecture.md#Adversarial-Agent] - Quality gate specifications
- [Source: _bmad-output/architecture.md#Quality-Gates] - G2/G4/G5 thresholds
- [Source: project-context.md#Rule-1] - Client isolation
- [Source: project-context.md#Rule-4] - Adversarial logic

**UX:**
- [Source: _bmad-output/ux-design-specification.md] - "Why" Hover (Pattern 2)
- [Source: _bmad-output/epics.md#Story-4.2] - Original story definition

**Dependencies:**
- [Story 4.1](./4-1-deterministic-spoke-fracturing.md) - Spoke generation (prerequisite)
- [Story 2.3](./2-3-brand-dna-analysis-and-scoring.md) - Brand DNA for G4
- [Story 2.5](./2-5-voice-marker-and-banned-word-management.md) - Voice markers for G4

**Next Stories:**
- Story 4.3: The Self-Healing Loop
- Story 4.4: Creative Conflict Escalation

## Estimation Notes

**Story Points: 8** (Large - complex AI integration)

**Breakdown:**
- Database schema + migration: 0.5 days
- Critic Agent core: 1 day
- G2 Hook Strength gate: 1.5 days
- G4 Voice Alignment gate: 1.5 days
- G5 Platform Compliance gate: 1 day
- tRPC integration: 0.5 days
- Frontend gate badges: 1 day
- E2E tests: 0.5 days
- **Total: ~7.5 days**

**Risk Factors:**
- Workers AI response consistency for G2 scoring
- Vectorize query latency for G4 cosine similarity
- Edge cases in platform-specific G5 rules
- Complex tooltip state management

## Out of Scope (Story 4.3+)

- Self-Healing regeneration loop - Story 4.3
- Creative Conflict escalation UI - Story 4.4
- G6 Visual Metaphor gate - Post-MVP
- G7 Engagement Prediction - Post-MVP
- G-Compliance (regulated industries) - Post-MVP
